#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Documentation validation pre-commit hook

echo "üîç Running documentation validation..."

# Get list of staged markdown files
STAGED_MD_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.md$' || true)

if [ -z "$STAGED_MD_FILES" ]; then
  echo "‚úÖ No markdown files to validate"
  exit 0
fi

# Create temporary directory for staged files
TEMP_DIR=$(mktemp -d)
trap "rm -rf $TEMP_DIR" EXIT

# Copy staged files to temp directory preserving structure
for file in $STAGED_MD_FILES; do
  mkdir -p "$TEMP_DIR/$(dirname "$file")"
  git show ":$file" > "$TEMP_DIR/$file"
done

# Run validations on temp directory
EXIT_CODE=0

echo "Validating front matter..."
if ! bash docs/scripts/validate-frontmatter.sh "$TEMP_DIR" 2>&1; then
  EXIT_CODE=1
fi

echo "Validating links..."
if ! bash docs/scripts/validate-links.sh "$TEMP_DIR" 2>&1; then
  EXIT_CODE=1
fi

if [ $EXIT_CODE -ne 0 ]; then
  echo ""
  echo "‚ùå Documentation validation failed!"
  echo "Please fix the issues above before committing."
  echo "You can skip this hook with: git commit --no-verify"
  exit 1
fi

echo "‚úÖ Documentation validation passed"
exit 0
