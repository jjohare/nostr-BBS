import{w as Yo,d as Ss}from"./DkN-uFVr.js";import{W as Rs}from"./B7P-bQO9.js";import{c as Ye,d as oi,l as vn,e as Zo,g as os,h as Go,N as Jo}from"./Dj2A1cQj.js";import{n as We,g as Qo,a as Xo,f as ea,b as Yn,c as as,m as ta}from"./C3bkP_Kp.js";const na=39e3,ra=39002,ia=9021,Ts={channels:[],loading:!1,error:null,currentChannel:null},{subscribe:sa,set:Ps,update:Ut}=Yo(Ts);async function oa(t,e,i){Ut(r=>({...r,loading:!0,error:null}));try{const r={kinds:[na]},o=await t.fetchEvents(r),c=Array.from(o),h={kinds:[ra]},d=await t.fetchEvents(h),y=Array.from(d),S={kinds:[ia],authors:[e]},I=await t.fetchEvents(S),C=Array.from(I),T=[];for(const O of c){const K=aa(O,y,C,e,i);K&&T.push(K)}return Ut(O=>({...O,channels:T,loading:!1,error:null})),T}catch(r){const o=r instanceof Error?r.message:"Failed to fetch channels";throw Ut(c=>({...c,loading:!1,error:o})),r}}function aa(t,e,i,r,o){const c=t.tags.find(ie=>ie[0]==="d")?.[1];if(!c)return null;const h=t.tags.filter(ie=>ie[0]==="cohort").map(ie=>ie[1]);if(!h.some(ie=>o.includes(ie))&&h.length>0)return null;let y={};try{y=JSON.parse(t.content)}catch{y={}}const I=e.find(ie=>ie.tags.find(me=>me[0]==="d")?.[1]===c)?.tags.filter(ie=>ie[0]==="p").map(ie=>ie[1])||[],C=I.length,T=I.includes(r),O=i.some(ie=>ie.tags.find(me=>me[0]==="h")?.[1]===c),Y=t.tags.find(ie=>ie[0]==="visibility")?.[1]||"listed",ne=t.tags.some(ie=>ie[0]==="encrypted");return!T&&Y==="unlisted"?null:{id:c,name:y.name||"Unnamed Channel",description:y.about||"",picture:y.picture,cohorts:h,visibility:Y,isEncrypted:ne,memberCount:C,createdAt:t.created_at||0,isMember:T,hasRequestPending:O}}function ua(t){Ut(e=>({...e,currentChannel:t}))}function ca(){return Rs(lr).currentChannel}Ss(lr,t=>t.channels.filter(e=>e.isMember));Ss(lr,t=>t.channels.filter(e=>!e.isMember&&e.visibility!=="unlisted"));function la(t){return Rs(lr).channels.filter(i=>i.cohorts.includes(t))}function ha(){Ps(Ts)}function fa(t,e){Ut(i=>({...i,channels:i.channels.map(r=>r.id===t?{...r,...e}:r)}))}function da(t){Ut(e=>({...e,channels:e.channels.filter(i=>i.id!==t),currentChannel:e.currentChannel?.id===t?null:e.currentChannel}))}const lr={subscribe:sa,set:Ps,update:Ut,fetchChannels:oa,setCurrentChannel:ua,getCurrentChannel:ca,getChannelsByCohort:la,clearChannels:ha,updateChannel:fa,removeChannel:da},Yt=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */function hr(t){return t instanceof Uint8Array||ArrayBuffer.isView(t)&&t.constructor.name==="Uint8Array"}function ai(t){if(!Number.isSafeInteger(t)||t<0)throw new Error("positive integer expected, got "+t)}function Mt(t,...e){if(!hr(t))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(t.length))throw new Error("Uint8Array expected of length "+e+", got length="+t.length)}function As(t){if(typeof t!="function"||typeof t.create!="function")throw new Error("Hash should be wrapped by utils.createHasher");ai(t.outputLen),ai(t.blockLen)}function er(t,e=!0){if(t.destroyed)throw new Error("Hash instance has been destroyed");if(e&&t.finished)throw new Error("Hash#digest() has already been called")}function pa(t,e){Mt(t);const i=e.outputLen;if(t.length<i)throw new Error("digestInto() expects output buffer of length at least "+i)}function tr(...t){for(let e=0;e<t.length;e++)t[e].fill(0)}function Zr(t){return new DataView(t.buffer,t.byteOffset,t.byteLength)}function Xe(t,e){return t<<32-e|t>>>e}const Is=typeof Uint8Array.from([]).toHex=="function"&&typeof Uint8Array.fromHex=="function",ya=Array.from({length:256},(t,e)=>e.toString(16).padStart(2,"0"));function bt(t){if(Mt(t),Is)return t.toHex();let e="";for(let i=0;i<t.length;i++)e+=ya[t[i]];return e}const st={_0:48,_9:57,A:65,F:70,a:97,f:102};function us(t){if(t>=st._0&&t<=st._9)return t-st._0;if(t>=st.A&&t<=st.F)return t-(st.A-10);if(t>=st.a&&t<=st.f)return t-(st.a-10)}function bn(t){if(typeof t!="string")throw new Error("hex string expected, got "+typeof t);if(Is)return Uint8Array.fromHex(t);const e=t.length,i=e/2;if(e%2)throw new Error("hex string expected, got unpadded hex of length "+e);const r=new Uint8Array(i);for(let o=0,c=0;o<i;o++,c+=2){const h=us(t.charCodeAt(c)),d=us(t.charCodeAt(c+1));if(h===void 0||d===void 0){const y=t[c]+t[c+1];throw new Error('hex string expected, got non-hex character "'+y+'" at index '+c)}r[o]=h*16+d}return r}function Os(t){if(typeof t!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(t))}function gi(t){return typeof t=="string"&&(t=Os(t)),Mt(t),t}function et(...t){let e=0;for(let r=0;r<t.length;r++){const o=t[r];Mt(o),e+=o.length}const i=new Uint8Array(e);for(let r=0,o=0;r<t.length;r++){const c=t[r];i.set(c,o),o+=c.length}return i}class Ns{}function ga(t){const e=r=>t().update(gi(r)).digest(),i=t();return e.outputLen=i.outputLen,e.blockLen=i.blockLen,e.create=()=>t(),e}function fr(t=32){if(Yt&&typeof Yt.getRandomValues=="function")return Yt.getRandomValues(new Uint8Array(t));if(Yt&&typeof Yt.randomBytes=="function")return Uint8Array.from(Yt.randomBytes(t));throw new Error("crypto.getRandomValues must be defined")}function ma(t,e,i,r){if(typeof t.setBigUint64=="function")return t.setBigUint64(e,i,r);const o=BigInt(32),c=BigInt(4294967295),h=Number(i>>o&c),d=Number(i&c),y=r?4:0,S=r?0:4;t.setUint32(e+y,h,r),t.setUint32(e+S,d,r)}function ba(t,e,i){return t&e^~t&i}function va(t,e,i){return t&e^t&i^e&i}class wa extends Ns{constructor(e,i,r,o){super(),this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.blockLen=e,this.outputLen=i,this.padOffset=r,this.isLE=o,this.buffer=new Uint8Array(e),this.view=Zr(this.buffer)}update(e){er(this),e=gi(e),Mt(e);const{view:i,buffer:r,blockLen:o}=this,c=e.length;for(let h=0;h<c;){const d=Math.min(o-this.pos,c-h);if(d===o){const y=Zr(e);for(;o<=c-h;h+=o)this.process(y,h);continue}r.set(e.subarray(h,h+d),this.pos),this.pos+=d,h+=d,this.pos===o&&(this.process(i,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){er(this),pa(e,this),this.finished=!0;const{buffer:i,view:r,blockLen:o,isLE:c}=this;let{pos:h}=this;i[h++]=128,tr(this.buffer.subarray(h)),this.padOffset>o-h&&(this.process(r,0),h=0);for(let C=h;C<o;C++)i[C]=0;ma(r,o-8,BigInt(this.length*8),c),this.process(r,0);const d=Zr(e),y=this.outputLen;if(y%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const S=y/4,I=this.get();if(S>I.length)throw new Error("_sha2: outputLen bigger than state");for(let C=0;C<S;C++)d.setUint32(4*C,I[C],c)}digest(){const{buffer:e,outputLen:i}=this;this.digestInto(e);const r=e.slice(0,i);return this.destroy(),r}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());const{blockLen:i,buffer:r,length:o,finished:c,destroyed:h,pos:d}=this;return e.destroyed=h,e.finished=c,e.length=o,e.pos=d,o%i&&e.buffer.set(r),e}clone(){return this._cloneInto()}}const gt=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),ka=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),mt=new Uint32Array(64);class Ea extends wa{constructor(e=32){super(64,e,8,!1),this.A=gt[0]|0,this.B=gt[1]|0,this.C=gt[2]|0,this.D=gt[3]|0,this.E=gt[4]|0,this.F=gt[5]|0,this.G=gt[6]|0,this.H=gt[7]|0}get(){const{A:e,B:i,C:r,D:o,E:c,F:h,G:d,H:y}=this;return[e,i,r,o,c,h,d,y]}set(e,i,r,o,c,h,d,y){this.A=e|0,this.B=i|0,this.C=r|0,this.D=o|0,this.E=c|0,this.F=h|0,this.G=d|0,this.H=y|0}process(e,i){for(let C=0;C<16;C++,i+=4)mt[C]=e.getUint32(i,!1);for(let C=16;C<64;C++){const T=mt[C-15],O=mt[C-2],K=Xe(T,7)^Xe(T,18)^T>>>3,Y=Xe(O,17)^Xe(O,19)^O>>>10;mt[C]=Y+mt[C-7]+K+mt[C-16]|0}let{A:r,B:o,C:c,D:h,E:d,F:y,G:S,H:I}=this;for(let C=0;C<64;C++){const T=Xe(d,6)^Xe(d,11)^Xe(d,25),O=I+T+ba(d,y,S)+ka[C]+mt[C]|0,Y=(Xe(r,2)^Xe(r,13)^Xe(r,22))+va(r,o,c)|0;I=S,S=y,y=d,d=h+O|0,h=c,c=o,o=r,r=O+Y|0}r=r+this.A|0,o=o+this.B|0,c=c+this.C|0,h=h+this.D|0,d=d+this.E|0,y=y+this.F|0,S=S+this.G|0,I=I+this.H|0,this.set(r,o,c,h,d,y,S,I)}roundClean(){tr(mt)}destroy(){this.set(0,0,0,0,0,0,0,0),tr(this.buffer)}}const nr=ga(()=>new Ea);class Cs extends Ns{constructor(e,i){super(),this.finished=!1,this.destroyed=!1,As(e);const r=gi(i);if(this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const o=this.blockLen,c=new Uint8Array(o);c.set(r.length>o?e.create().update(r).digest():r);for(let h=0;h<c.length;h++)c[h]^=54;this.iHash.update(c),this.oHash=e.create();for(let h=0;h<c.length;h++)c[h]^=106;this.oHash.update(c),tr(c)}update(e){return er(this),this.iHash.update(e),this}digestInto(e){er(this),Mt(e,this.outputLen),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){const e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||(e=Object.create(Object.getPrototypeOf(this),{}));const{oHash:i,iHash:r,finished:o,destroyed:c,blockLen:h,outputLen:d}=this;return e=e,e.finished=o,e.destroyed=c,e.blockLen=h,e.outputLen=d,e.oHash=i._cloneInto(e.oHash),e.iHash=r._cloneInto(e.iHash),e}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}}const Bs=(t,e,i)=>new Cs(t,e).update(i).digest();Bs.create=(t,e)=>new Cs(t,e);/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const mi=BigInt(0),ui=BigInt(1);function rr(t,e=""){if(typeof t!="boolean"){const i=e&&`"${e}"`;throw new Error(i+"expected boolean, got type="+typeof t)}return t}function Ct(t,e,i=""){const r=hr(t),o=t?.length,c=e!==void 0;if(!r||c&&o!==e){const h=i&&`"${i}" `,d=c?` of length ${e}`:"",y=r?`length=${o}`:`type=${typeof t}`;throw new Error(h+"expected Uint8Array"+d+", got "+y)}return t}function Zn(t){const e=t.toString(16);return e.length&1?"0"+e:e}function Ds(t){if(typeof t!="string")throw new Error("hex string expected, got "+typeof t);return t===""?mi:BigInt("0x"+t)}function Xt(t){return Ds(bt(t))}function Ks(t){return Mt(t),Ds(bt(Uint8Array.from(t).reverse()))}function dr(t,e){return bn(t.toString(16).padStart(e*2,"0"))}function Us(t,e){return dr(t,e).reverse()}function Te(t,e,i){let r;if(typeof e=="string")try{r=bn(e)}catch(c){throw new Error(t+" must be hex string or Uint8Array, cause: "+c)}else if(hr(e))r=Uint8Array.from(e);else throw new Error(t+" must be hex string or Uint8Array");const o=r.length;if(typeof i=="number"&&o!==i)throw new Error(t+" of length "+i+" expected, got "+o);return r}const Gr=t=>typeof t=="bigint"&&mi<=t;function ci(t,e,i){return Gr(t)&&Gr(e)&&Gr(i)&&e<=t&&t<i}function _a(t,e,i,r){if(!ci(e,i,r))throw new Error("expected valid "+t+": "+i+" <= n < "+r+", got "+e)}function qs(t){let e;for(e=0;t>mi;t>>=ui,e+=1);return e}const wn=t=>(ui<<BigInt(t))-ui;function xa(t,e,i){if(typeof t!="number"||t<2)throw new Error("hashLen must be a number");if(typeof e!="number"||e<2)throw new Error("qByteLen must be a number");if(typeof i!="function")throw new Error("hmacFn must be a function");const r=O=>new Uint8Array(O),o=O=>Uint8Array.of(O);let c=r(t),h=r(t),d=0;const y=()=>{c.fill(1),h.fill(0),d=0},S=(...O)=>i(h,c,...O),I=(O=r(0))=>{h=S(o(0),O),c=S(),O.length!==0&&(h=S(o(1),O),c=S())},C=()=>{if(d++>=1e3)throw new Error("drbg: tried 1000 values");let O=0;const K=[];for(;O<e;){c=S();const Y=c.slice();K.push(Y),O+=c.length}return et(...K)};return(O,K)=>{y(),I(O);let Y;for(;!(Y=K(C()));)I();return y(),Y}}function bi(t,e,i={}){if(!t||typeof t!="object")throw new Error("expected valid options object");function r(o,c,h){const d=t[o];if(h&&d===void 0)return;const y=typeof d;if(y!==c||d===null)throw new Error(`param "${o}" is invalid: expected ${c}, got ${y}`)}Object.entries(e).forEach(([o,c])=>r(o,c,!1)),Object.entries(i).forEach(([o,c])=>r(o,c,!0))}function cs(t){const e=new WeakMap;return(i,...r)=>{const o=e.get(i);if(o!==void 0)return o;const c=t(i,...r);return e.set(i,c),c}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const qe=BigInt(0),Ke=BigInt(1),Bt=BigInt(2),Ms=BigInt(3),js=BigInt(4),Fs=BigInt(5),Sa=BigInt(7),$s=BigInt(8),Ra=BigInt(9),zs=BigInt(16);function Ve(t,e){const i=t%e;return i>=qe?i:e+i}function Le(t,e,i){let r=t;for(;e-- >qe;)r*=r,r%=i;return r}function ls(t,e){if(t===qe)throw new Error("invert: expected non-zero number");if(e<=qe)throw new Error("invert: expected positive modulus, got "+e);let i=Ve(t,e),r=e,o=qe,c=Ke;for(;i!==qe;){const d=r/i,y=r%i,S=o-c*d;r=i,i=y,o=c,c=S}if(r!==Ke)throw new Error("invert: does not exist");return Ve(o,e)}function vi(t,e,i){if(!t.eql(t.sqr(e),i))throw new Error("Cannot find square root")}function Ls(t,e){const i=(t.ORDER+Ke)/js,r=t.pow(e,i);return vi(t,r,e),r}function Ta(t,e){const i=(t.ORDER-Fs)/$s,r=t.mul(e,Bt),o=t.pow(r,i),c=t.mul(e,o),h=t.mul(t.mul(c,Bt),o),d=t.mul(c,t.sub(h,t.ONE));return vi(t,d,e),d}function Pa(t){const e=kn(t),i=Vs(t),r=i(e,e.neg(e.ONE)),o=i(e,r),c=i(e,e.neg(r)),h=(t+Sa)/zs;return(d,y)=>{let S=d.pow(y,h),I=d.mul(S,r);const C=d.mul(S,o),T=d.mul(S,c),O=d.eql(d.sqr(I),y),K=d.eql(d.sqr(C),y);S=d.cmov(S,I,O),I=d.cmov(T,C,K);const Y=d.eql(d.sqr(I),y),ne=d.cmov(S,I,Y);return vi(d,ne,y),ne}}function Vs(t){if(t<Ms)throw new Error("sqrt is not defined for small field");let e=t-Ke,i=0;for(;e%Bt===qe;)e/=Bt,i++;let r=Bt;const o=kn(t);for(;hs(o,r)===1;)if(r++>1e3)throw new Error("Cannot find square root: probably non-prime P");if(i===1)return Ls;let c=o.pow(r,e);const h=(e+Ke)/Bt;return function(y,S){if(y.is0(S))return S;if(hs(y,S)!==1)throw new Error("Cannot find square root");let I=i,C=y.mul(y.ONE,c),T=y.pow(S,e),O=y.pow(S,h);for(;!y.eql(T,y.ONE);){if(y.is0(T))return y.ZERO;let K=1,Y=y.sqr(T);for(;!y.eql(Y,y.ONE);)if(K++,Y=y.sqr(Y),K===I)throw new Error("Cannot find square root");const ne=Ke<<BigInt(I-K-1),ie=y.pow(C,ne);I=K,C=y.sqr(ie),T=y.mul(T,C),O=y.mul(O,ie)}return O}}function Aa(t){return t%js===Ms?Ls:t%$s===Fs?Ta:t%zs===Ra?Pa(t):Vs(t)}const Ia=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function Oa(t){const e={ORDER:"bigint",MASK:"bigint",BYTES:"number",BITS:"number"},i=Ia.reduce((r,o)=>(r[o]="function",r),e);return bi(t,i),t}function Na(t,e,i){if(i<qe)throw new Error("invalid exponent, negatives unsupported");if(i===qe)return t.ONE;if(i===Ke)return e;let r=t.ONE,o=e;for(;i>qe;)i&Ke&&(r=t.mul(r,o)),o=t.sqr(o),i>>=Ke;return r}function Hs(t,e,i=!1){const r=new Array(e.length).fill(i?t.ZERO:void 0),o=e.reduce((h,d,y)=>t.is0(d)?h:(r[y]=h,t.mul(h,d)),t.ONE),c=t.inv(o);return e.reduceRight((h,d,y)=>t.is0(d)?h:(r[y]=t.mul(h,r[y]),t.mul(h,d)),c),r}function hs(t,e){const i=(t.ORDER-Ke)/Bt,r=t.pow(e,i),o=t.eql(r,t.ONE),c=t.eql(r,t.ZERO),h=t.eql(r,t.neg(t.ONE));if(!o&&!c&&!h)throw new Error("invalid Legendre symbol result");return o?1:c?0:-1}function Ws(t,e){e!==void 0&&ai(e);const i=e!==void 0?e:t.toString(2).length,r=Math.ceil(i/8);return{nBitLength:i,nByteLength:r}}function kn(t,e,i=!1,r={}){if(t<=qe)throw new Error("invalid field: expected ORDER > 0, got "+t);let o,c,h=!1,d;if(typeof e=="object"&&e!=null){if(r.sqrt||i)throw new Error("cannot specify opts in two arguments");const T=e;T.BITS&&(o=T.BITS),T.sqrt&&(c=T.sqrt),typeof T.isLE=="boolean"&&(i=T.isLE),typeof T.modFromBytes=="boolean"&&(h=T.modFromBytes),d=T.allowedLengths}else typeof e=="number"&&(o=e),r.sqrt&&(c=r.sqrt);const{nBitLength:y,nByteLength:S}=Ws(t,o);if(S>2048)throw new Error("invalid field: expected ORDER of <= 2048 bytes");let I;const C=Object.freeze({ORDER:t,isLE:i,BITS:y,BYTES:S,MASK:wn(y),ZERO:qe,ONE:Ke,allowedLengths:d,create:T=>Ve(T,t),isValid:T=>{if(typeof T!="bigint")throw new Error("invalid field element: expected bigint, got "+typeof T);return qe<=T&&T<t},is0:T=>T===qe,isValidNot0:T=>!C.is0(T)&&C.isValid(T),isOdd:T=>(T&Ke)===Ke,neg:T=>Ve(-T,t),eql:(T,O)=>T===O,sqr:T=>Ve(T*T,t),add:(T,O)=>Ve(T+O,t),sub:(T,O)=>Ve(T-O,t),mul:(T,O)=>Ve(T*O,t),pow:(T,O)=>Na(C,T,O),div:(T,O)=>Ve(T*ls(O,t),t),sqrN:T=>T*T,addN:(T,O)=>T+O,subN:(T,O)=>T-O,mulN:(T,O)=>T*O,inv:T=>ls(T,t),sqrt:c||(T=>(I||(I=Aa(t)),I(C,T))),toBytes:T=>i?Us(T,S):dr(T,S),fromBytes:(T,O=!0)=>{if(d){if(!d.includes(T.length)||T.length>S)throw new Error("Field.fromBytes: expected "+d+" bytes, got "+T.length);const Y=new Uint8Array(S);Y.set(T,i?0:Y.length-T.length),T=Y}if(T.length!==S)throw new Error("Field.fromBytes: expected "+S+" bytes, got "+T.length);let K=i?Ks(T):Xt(T);if(h&&(K=Ve(K,t)),!O&&!C.isValid(K))throw new Error("invalid field element: outside of range 0..ORDER");return K},invertBatch:T=>Hs(C,T),cmov:(T,O,K)=>K?O:T});return Object.freeze(C)}function Ys(t){if(typeof t!="bigint")throw new Error("field order must be bigint");const e=t.toString(2).length;return Math.ceil(e/8)}function Zs(t){const e=Ys(t);return e+Math.ceil(e/2)}function Gs(t,e,i=!1){const r=t.length,o=Ys(e),c=Zs(e);if(r<16||r<c||r>1024)throw new Error("expected "+c+"-1024 bytes of input, got "+r);const h=i?Ks(t):Xt(t),d=Ve(h,e-Ke)+Ke;return i?Us(d,o):dr(d,o)}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const Gt=BigInt(0),Dt=BigInt(1);function ir(t,e){const i=e.negate();return t?i:e}function Jr(t,e){const i=Hs(t.Fp,e.map(r=>r.Z));return e.map((r,o)=>t.fromAffine(r.toAffine(i[o])))}function Js(t,e){if(!Number.isSafeInteger(t)||t<=0||t>e)throw new Error("invalid window size, expected [1.."+e+"], got W="+t)}function Qr(t,e){Js(t,e);const i=Math.ceil(e/t)+1,r=2**(t-1),o=2**t,c=wn(t),h=BigInt(t);return{windows:i,windowSize:r,mask:c,maxNumber:o,shiftBy:h}}function fs(t,e,i){const{windowSize:r,mask:o,maxNumber:c,shiftBy:h}=i;let d=Number(t&o),y=t>>h;d>r&&(d-=c,y+=Dt);const S=e*r,I=S+Math.abs(d)-1,C=d===0,T=d<0,O=e%2!==0;return{nextN:y,offset:I,isZero:C,isNeg:T,isNegF:O,offsetF:S}}function Ca(t,e){if(!Array.isArray(t))throw new Error("array expected");t.forEach((i,r)=>{if(!(i instanceof e))throw new Error("invalid point at index "+r)})}function Ba(t,e){if(!Array.isArray(t))throw new Error("array of scalars expected");t.forEach((i,r)=>{if(!e.isValid(i))throw new Error("invalid scalar at index "+r)})}const Xr=new WeakMap,Qs=new WeakMap;function ei(t){return Qs.get(t)||1}function ds(t){if(t!==Gt)throw new Error("invalid wNAF")}class Da{constructor(e,i){this.BASE=e.BASE,this.ZERO=e.ZERO,this.Fn=e.Fn,this.bits=i}_unsafeLadder(e,i,r=this.ZERO){let o=e;for(;i>Gt;)i&Dt&&(r=r.add(o)),o=o.double(),i>>=Dt;return r}precomputeWindow(e,i){const{windows:r,windowSize:o}=Qr(i,this.bits),c=[];let h=e,d=h;for(let y=0;y<r;y++){d=h,c.push(d);for(let S=1;S<o;S++)d=d.add(h),c.push(d);h=d.double()}return c}wNAF(e,i,r){if(!this.Fn.isValid(r))throw new Error("invalid scalar");let o=this.ZERO,c=this.BASE;const h=Qr(e,this.bits);for(let d=0;d<h.windows;d++){const{nextN:y,offset:S,isZero:I,isNeg:C,isNegF:T,offsetF:O}=fs(r,d,h);r=y,I?c=c.add(ir(T,i[O])):o=o.add(ir(C,i[S]))}return ds(r),{p:o,f:c}}wNAFUnsafe(e,i,r,o=this.ZERO){const c=Qr(e,this.bits);for(let h=0;h<c.windows&&r!==Gt;h++){const{nextN:d,offset:y,isZero:S,isNeg:I}=fs(r,h,c);if(r=d,!S){const C=i[y];o=o.add(I?C.negate():C)}}return ds(r),o}getPrecomputes(e,i,r){let o=Xr.get(i);return o||(o=this.precomputeWindow(i,e),e!==1&&(typeof r=="function"&&(o=r(o)),Xr.set(i,o))),o}cached(e,i,r){const o=ei(e);return this.wNAF(o,this.getPrecomputes(o,e,r),i)}unsafe(e,i,r,o){const c=ei(e);return c===1?this._unsafeLadder(e,i,o):this.wNAFUnsafe(c,this.getPrecomputes(c,e,r),i,o)}createCache(e,i){Js(i,this.bits),Qs.set(e,i),Xr.delete(e)}hasCache(e){return ei(e)!==1}}function Ka(t,e,i,r){let o=e,c=t.ZERO,h=t.ZERO;for(;i>Gt||r>Gt;)i&Dt&&(c=c.add(o)),r&Dt&&(h=h.add(o)),o=o.double(),i>>=Dt,r>>=Dt;return{p1:c,p2:h}}function Ua(t,e,i,r){Ca(i,t),Ba(r,e);const o=i.length,c=r.length;if(o!==c)throw new Error("arrays of points and scalars must have equal length");const h=t.ZERO,d=qs(BigInt(o));let y=1;d>12?y=d-3:d>4?y=d-2:d>0&&(y=2);const S=wn(y),I=new Array(Number(S)+1).fill(h),C=Math.floor((e.BITS-1)/y)*y;let T=h;for(let O=C;O>=0;O-=y){I.fill(h);for(let Y=0;Y<c;Y++){const ne=r[Y],ie=Number(ne>>BigInt(O)&S);I[ie]=I[ie].add(i[Y])}let K=h;for(let Y=I.length-1,ne=h;Y>0;Y--)ne=ne.add(I[Y]),K=K.add(ne);if(T=T.add(K),O!==0)for(let Y=0;Y<y;Y++)T=T.double()}return T}function ps(t,e,i){if(e){if(e.ORDER!==t)throw new Error("Field.ORDER must match order: Fp == p, Fn == n");return Oa(e),e}else return kn(t,{isLE:i})}function qa(t,e,i={},r){if(r===void 0&&(r=t==="edwards"),!e||typeof e!="object")throw new Error(`expected valid ${t} CURVE object`);for(const y of["p","n","h"]){const S=e[y];if(!(typeof S=="bigint"&&S>Gt))throw new Error(`CURVE.${y} must be positive bigint`)}const o=ps(e.p,i.Fp,r),c=ps(e.n,i.Fn,r),d=["Gx","Gy","a","b"];for(const y of d)if(!o.isValid(e[y]))throw new Error(`CURVE.${y} must be valid field element of CURVE.Fp`);return e=Object.freeze(Object.assign({},e)),{CURVE:e,Fp:o,Fn:c}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const ys=(t,e)=>(t+(t>=0?e:-e)/Xs)/e;function Ma(t,e,i){const[[r,o],[c,h]]=e,d=ys(h*t,i),y=ys(-o*t,i);let S=t-d*r-y*c,I=-d*o-y*h;const C=S<at,T=I<at;C&&(S=-S),T&&(I=-I);const O=wn(Math.ceil(qs(i)/2))+Zt;if(S<at||S>=O||I<at||I>=O)throw new Error("splitScalar (endomorphism): failed, k="+t);return{k1neg:C,k1:S,k2neg:T,k2:I}}function li(t){if(!["compact","recovered","der"].includes(t))throw new Error('Signature format must be "compact", "recovered", or "der"');return t}function ti(t,e){const i={};for(let r of Object.keys(e))i[r]=t[r]===void 0?e[r]:t[r];return rr(i.lowS,"lowS"),rr(i.prehash,"prehash"),i.format!==void 0&&li(i.format),i}class ja extends Error{constructor(e=""){super(e)}}const ot={Err:ja,_tlv:{encode:(t,e)=>{const{Err:i}=ot;if(t<0||t>256)throw new i("tlv.encode: wrong tag");if(e.length&1)throw new i("tlv.encode: unpadded data");const r=e.length/2,o=Zn(r);if(o.length/2&128)throw new i("tlv.encode: long form length too big");const c=r>127?Zn(o.length/2|128):"";return Zn(t)+c+o+e},decode(t,e){const{Err:i}=ot;let r=0;if(t<0||t>256)throw new i("tlv.encode: wrong tag");if(e.length<2||e[r++]!==t)throw new i("tlv.decode: wrong tlv");const o=e[r++],c=!!(o&128);let h=0;if(!c)h=o;else{const y=o&127;if(!y)throw new i("tlv.decode(long): indefinite length not supported");if(y>4)throw new i("tlv.decode(long): byte length is too big");const S=e.subarray(r,r+y);if(S.length!==y)throw new i("tlv.decode: length bytes not complete");if(S[0]===0)throw new i("tlv.decode(long): zero leftmost byte");for(const I of S)h=h<<8|I;if(r+=y,h<128)throw new i("tlv.decode(long): not minimal encoding")}const d=e.subarray(r,r+h);if(d.length!==h)throw new i("tlv.decode: wrong value length");return{v:d,l:e.subarray(r+h)}}},_int:{encode(t){const{Err:e}=ot;if(t<at)throw new e("integer: negative integers are not allowed");let i=Zn(t);if(Number.parseInt(i[0],16)&8&&(i="00"+i),i.length&1)throw new e("unexpected DER parsing assertion: unpadded hex");return i},decode(t){const{Err:e}=ot;if(t[0]&128)throw new e("invalid signature integer: negative");if(t[0]===0&&!(t[1]&128))throw new e("invalid signature integer: unnecessary leading zero");return Xt(t)}},toSig(t){const{Err:e,_int:i,_tlv:r}=ot,o=Te("signature",t),{v:c,l:h}=r.decode(48,o);if(h.length)throw new e("invalid signature: left bytes after parsing");const{v:d,l:y}=r.decode(2,c),{v:S,l:I}=r.decode(2,y);if(I.length)throw new e("invalid signature: left bytes after parsing");return{r:i.decode(d),s:i.decode(S)}},hexFromSig(t){const{_tlv:e,_int:i}=ot,r=e.encode(2,i.encode(t.r)),o=e.encode(2,i.encode(t.s)),c=r+o;return e.encode(48,c)}},at=BigInt(0),Zt=BigInt(1),Xs=BigInt(2),Gn=BigInt(3),Fa=BigInt(4);function Kt(t,e){const{BYTES:i}=t;let r;if(typeof e=="bigint")r=e;else{let o=Te("private key",e);try{r=t.fromBytes(o)}catch{throw new Error(`invalid private key: expected ui8a of size ${i}, got ${typeof e}`)}}if(!t.isValidNot0(r))throw new Error("invalid private key: out of range [1..N-1]");return r}function $a(t,e={}){const i=qa("weierstrass",t,e),{Fp:r,Fn:o}=i;let c=i.CURVE;const{h,n:d}=c;bi(e,{},{allowInfinityPoint:"boolean",clearCofactor:"function",isTorsionFree:"function",fromBytes:"function",toBytes:"function",endo:"object",wrapPrivateKey:"boolean"});const{endo:y}=e;if(y&&(!r.is0(c.a)||typeof y.beta!="bigint"||!Array.isArray(y.basises)))throw new Error('invalid endo: expected "beta": bigint and "basises": array');const S=to(r,o);function I(){if(!r.isOdd)throw new Error("compression is not supported: Field does not have .isOdd()")}function C(he,U,q){const{x:D,y:W}=U.toAffine(),Q=r.toBytes(D);if(rr(q,"isCompressed"),q){I();const ee=!r.isOdd(W);return et(eo(ee),Q)}else return et(Uint8Array.of(4),Q,r.toBytes(W))}function T(he){Ct(he,void 0,"Point");const{publicKey:U,publicKeyUncompressed:q}=S,D=he.length,W=he[0],Q=he.subarray(1);if(D===U&&(W===2||W===3)){const ee=r.fromBytes(Q);if(!r.isValid(ee))throw new Error("bad point: is not on curve, wrong x");const X=Y(ee);let G;try{G=r.sqrt(X)}catch(be){const ge=be instanceof Error?": "+be.message:"";throw new Error("bad point: is not on curve, sqrt error"+ge)}I();const te=r.isOdd(G);return(W&1)===1!==te&&(G=r.neg(G)),{x:ee,y:G}}else if(D===q&&W===4){const ee=r.BYTES,X=r.fromBytes(Q.subarray(0,ee)),G=r.fromBytes(Q.subarray(ee,ee*2));if(!ne(X,G))throw new Error("bad point: is not on curve");return{x:X,y:G}}else throw new Error(`bad point: got length ${D}, expected compressed=${U} or uncompressed=${q}`)}const O=e.toBytes||C,K=e.fromBytes||T;function Y(he){const U=r.sqr(he),q=r.mul(U,he);return r.add(r.add(q,r.mul(he,c.a)),c.b)}function ne(he,U){const q=r.sqr(U),D=Y(he);return r.eql(q,D)}if(!ne(c.Gx,c.Gy))throw new Error("bad curve params: generator point");const ie=r.mul(r.pow(c.a,Gn),Fa),$e=r.mul(r.sqr(c.b),BigInt(27));if(r.is0(r.add(ie,$e)))throw new Error("bad curve params: a or b");function me(he,U,q=!1){if(!r.isValid(U)||q&&r.is0(U))throw new Error(`bad point coordinate ${he}`);return U}function Me(he){if(!(he instanceof le))throw new Error("ProjectivePoint expected")}function He(he){if(!y||!y.basises)throw new Error("no endo");return Ma(he,y.basises,o.ORDER)}const Ie=cs((he,U)=>{const{X:q,Y:D,Z:W}=he;if(r.eql(W,r.ONE))return{x:q,y:D};const Q=he.is0();U==null&&(U=Q?r.ONE:r.inv(W));const ee=r.mul(q,U),X=r.mul(D,U),G=r.mul(W,U);if(Q)return{x:r.ZERO,y:r.ZERO};if(!r.eql(G,r.ONE))throw new Error("invZ was invalid");return{x:ee,y:X}}),Se=cs(he=>{if(he.is0()){if(e.allowInfinityPoint&&!r.is0(he.Y))return;throw new Error("bad point: ZERO")}const{x:U,y:q}=he.toAffine();if(!r.isValid(U)||!r.isValid(q))throw new Error("bad point: x or y not field elements");if(!ne(U,q))throw new Error("bad point: equation left != right");if(!he.isTorsionFree())throw new Error("bad point: not in prime-order subgroup");return!0});function tt(he,U,q,D,W){return q=new le(r.mul(q.X,he),q.Y,q.Z),U=ir(D,U),q=ir(W,q),U.add(q)}class le{constructor(U,q,D){this.X=me("x",U),this.Y=me("y",q,!0),this.Z=me("z",D),Object.freeze(this)}static CURVE(){return c}static fromAffine(U){const{x:q,y:D}=U||{};if(!U||!r.isValid(q)||!r.isValid(D))throw new Error("invalid affine point");if(U instanceof le)throw new Error("projective point not allowed");return r.is0(q)&&r.is0(D)?le.ZERO:new le(q,D,r.ONE)}static fromBytes(U){const q=le.fromAffine(K(Ct(U,void 0,"point")));return q.assertValidity(),q}static fromHex(U){return le.fromBytes(Te("pointHex",U))}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(U=8,q=!0){return Ze.createCache(this,U),q||this.multiply(Gn),this}assertValidity(){Se(this)}hasEvenY(){const{y:U}=this.toAffine();if(!r.isOdd)throw new Error("Field doesn't support isOdd");return!r.isOdd(U)}equals(U){Me(U);const{X:q,Y:D,Z:W}=this,{X:Q,Y:ee,Z:X}=U,G=r.eql(r.mul(q,X),r.mul(Q,W)),te=r.eql(r.mul(D,X),r.mul(ee,W));return G&&te}negate(){return new le(this.X,r.neg(this.Y),this.Z)}double(){const{a:U,b:q}=c,D=r.mul(q,Gn),{X:W,Y:Q,Z:ee}=this;let X=r.ZERO,G=r.ZERO,te=r.ZERO,oe=r.mul(W,W),be=r.mul(Q,Q),ge=r.mul(ee,ee),ce=r.mul(W,Q);return ce=r.add(ce,ce),te=r.mul(W,ee),te=r.add(te,te),X=r.mul(U,te),G=r.mul(D,ge),G=r.add(X,G),X=r.sub(be,G),G=r.add(be,G),G=r.mul(X,G),X=r.mul(ce,X),te=r.mul(D,te),ge=r.mul(U,ge),ce=r.sub(oe,ge),ce=r.mul(U,ce),ce=r.add(ce,te),te=r.add(oe,oe),oe=r.add(te,oe),oe=r.add(oe,ge),oe=r.mul(oe,ce),G=r.add(G,oe),ge=r.mul(Q,ee),ge=r.add(ge,ge),oe=r.mul(ge,ce),X=r.sub(X,oe),te=r.mul(ge,be),te=r.add(te,te),te=r.add(te,te),new le(X,G,te)}add(U){Me(U);const{X:q,Y:D,Z:W}=this,{X:Q,Y:ee,Z:X}=U;let G=r.ZERO,te=r.ZERO,oe=r.ZERO;const be=c.a,ge=r.mul(c.b,Gn);let ce=r.mul(q,Q),ye=r.mul(D,ee),ke=r.mul(W,X),Oe=r.add(q,D),V=r.add(Q,ee);Oe=r.mul(Oe,V),V=r.add(ce,ye),Oe=r.sub(Oe,V),V=r.add(q,W);let Re=r.add(Q,X);return V=r.mul(V,Re),Re=r.add(ce,ke),V=r.sub(V,Re),Re=r.add(D,W),G=r.add(ee,X),Re=r.mul(Re,G),G=r.add(ye,ke),Re=r.sub(Re,G),oe=r.mul(be,V),G=r.mul(ge,ke),oe=r.add(G,oe),G=r.sub(ye,oe),oe=r.add(ye,oe),te=r.mul(G,oe),ye=r.add(ce,ce),ye=r.add(ye,ce),ke=r.mul(be,ke),V=r.mul(ge,V),ye=r.add(ye,ke),ke=r.sub(ce,ke),ke=r.mul(be,ke),V=r.add(V,ke),ce=r.mul(ye,V),te=r.add(te,ce),ce=r.mul(Re,V),G=r.mul(Oe,G),G=r.sub(G,ce),ce=r.mul(Oe,ye),oe=r.mul(Re,oe),oe=r.add(oe,ce),new le(G,te,oe)}subtract(U){return this.add(U.negate())}is0(){return this.equals(le.ZERO)}multiply(U){const{endo:q}=e;if(!o.isValidNot0(U))throw new Error("invalid scalar: out of range");let D,W;const Q=ee=>Ze.cached(this,ee,X=>Jr(le,X));if(q){const{k1neg:ee,k1:X,k2neg:G,k2:te}=He(U),{p:oe,f:be}=Q(X),{p:ge,f:ce}=Q(te);W=be.add(ce),D=tt(q.beta,oe,ge,ee,G)}else{const{p:ee,f:X}=Q(U);D=ee,W=X}return Jr(le,[D,W])[0]}multiplyUnsafe(U){const{endo:q}=e,D=this;if(!o.isValid(U))throw new Error("invalid scalar: out of range");if(U===at||D.is0())return le.ZERO;if(U===Zt)return D;if(Ze.hasCache(this))return this.multiply(U);if(q){const{k1neg:W,k1:Q,k2neg:ee,k2:X}=He(U),{p1:G,p2:te}=Ka(le,D,Q,X);return tt(q.beta,G,te,W,ee)}else return Ze.unsafe(D,U)}multiplyAndAddUnsafe(U,q,D){const W=this.multiplyUnsafe(q).add(U.multiplyUnsafe(D));return W.is0()?void 0:W}toAffine(U){return Ie(this,U)}isTorsionFree(){const{isTorsionFree:U}=e;return h===Zt?!0:U?U(le,this):Ze.unsafe(this,d).is0()}clearCofactor(){const{clearCofactor:U}=e;return h===Zt?this:U?U(le,this):this.multiplyUnsafe(h)}isSmallOrder(){return this.multiplyUnsafe(h).is0()}toBytes(U=!0){return rr(U,"isCompressed"),this.assertValidity(),O(le,this,U)}toHex(U=!0){return bt(this.toBytes(U))}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}get px(){return this.X}get py(){return this.X}get pz(){return this.Z}toRawBytes(U=!0){return this.toBytes(U)}_setWindowSize(U){this.precompute(U)}static normalizeZ(U){return Jr(le,U)}static msm(U,q){return Ua(le,o,U,q)}static fromPrivateKey(U){return le.BASE.multiply(Kt(o,U))}}le.BASE=new le(c.Gx,c.Gy,r.ONE),le.ZERO=new le(r.ZERO,r.ONE,r.ZERO),le.Fp=r,le.Fn=o;const vt=o.BITS,Ze=new Da(le,e.endo?Math.ceil(vt/2):vt);return le.BASE.precompute(8),le}function eo(t){return Uint8Array.of(t?2:3)}function to(t,e){return{secretKey:e.BYTES,publicKey:1+t.BYTES,publicKeyUncompressed:1+2*t.BYTES,publicKeyHasPrefix:!0,signature:2*e.BYTES}}function za(t,e={}){const{Fn:i}=t,r=e.randomBytes||fr,o=Object.assign(to(t.Fp,i),{seed:Zs(i.ORDER)});function c(O){try{return!!Kt(i,O)}catch{return!1}}function h(O,K){const{publicKey:Y,publicKeyUncompressed:ne}=o;try{const ie=O.length;return K===!0&&ie!==Y||K===!1&&ie!==ne?!1:!!t.fromBytes(O)}catch{return!1}}function d(O=r(o.seed)){return Gs(Ct(O,o.seed,"seed"),i.ORDER)}function y(O,K=!0){return t.BASE.multiply(Kt(i,O)).toBytes(K)}function S(O){const K=d(O);return{secretKey:K,publicKey:y(K)}}function I(O){if(typeof O=="bigint")return!1;if(O instanceof t)return!0;const{secretKey:K,publicKey:Y,publicKeyUncompressed:ne}=o;if(i.allowedLengths||K===Y)return;const ie=Te("key",O).length;return ie===Y||ie===ne}function C(O,K,Y=!0){if(I(O)===!0)throw new Error("first arg must be private key");if(I(K)===!1)throw new Error("second arg must be public key");const ne=Kt(i,O);return t.fromHex(K).multiply(ne).toBytes(Y)}return Object.freeze({getPublicKey:y,getSharedSecret:C,keygen:S,Point:t,utils:{isValidSecretKey:c,isValidPublicKey:h,randomSecretKey:d,isValidPrivateKey:c,randomPrivateKey:d,normPrivateKeyToScalar:O=>Kt(i,O),precompute(O=8,K=t.BASE){return K.precompute(O,!1)}},lengths:o})}function La(t,e,i={}){As(e),bi(i,{},{hmac:"function",lowS:"boolean",randomBytes:"function",bits2int:"function",bits2int_modN:"function"});const r=i.randomBytes||fr,o=i.hmac||((q,...D)=>Bs(e,q,et(...D))),{Fp:c,Fn:h}=t,{ORDER:d,BITS:y}=h,{keygen:S,getPublicKey:I,getSharedSecret:C,utils:T,lengths:O}=za(t,i),K={prehash:!1,lowS:typeof i.lowS=="boolean"?i.lowS:!1,format:void 0,extraEntropy:!1},Y="compact";function ne(q){const D=d>>Zt;return q>D}function ie(q,D){if(!h.isValidNot0(D))throw new Error(`invalid signature ${q}: out of range 1..Point.Fn.ORDER`);return D}function $e(q,D){li(D);const W=O.signature,Q=D==="compact"?W:D==="recovered"?W+1:void 0;return Ct(q,Q,`${D} signature`)}class me{constructor(D,W,Q){this.r=ie("r",D),this.s=ie("s",W),Q!=null&&(this.recovery=Q),Object.freeze(this)}static fromBytes(D,W=Y){$e(D,W);let Q;if(W==="der"){const{r:te,s:oe}=ot.toSig(Ct(D));return new me(te,oe)}W==="recovered"&&(Q=D[0],W="compact",D=D.subarray(1));const ee=h.BYTES,X=D.subarray(0,ee),G=D.subarray(ee,ee*2);return new me(h.fromBytes(X),h.fromBytes(G),Q)}static fromHex(D,W){return this.fromBytes(bn(D),W)}addRecoveryBit(D){return new me(this.r,this.s,D)}recoverPublicKey(D){const W=c.ORDER,{r:Q,s:ee,recovery:X}=this;if(X==null||![0,1,2,3].includes(X))throw new Error("recovery id invalid");if(d*Xs<W&&X>1)throw new Error("recovery id is ambiguous for h>1 curve");const te=X===2||X===3?Q+d:Q;if(!c.isValid(te))throw new Error("recovery id 2 or 3 invalid");const oe=c.toBytes(te),be=t.fromBytes(et(eo((X&1)===0),oe)),ge=h.inv(te),ce=He(Te("msgHash",D)),ye=h.create(-ce*ge),ke=h.create(ee*ge),Oe=t.BASE.multiplyUnsafe(ye).add(be.multiplyUnsafe(ke));if(Oe.is0())throw new Error("point at infinify");return Oe.assertValidity(),Oe}hasHighS(){return ne(this.s)}toBytes(D=Y){if(li(D),D==="der")return bn(ot.hexFromSig(this));const W=h.toBytes(this.r),Q=h.toBytes(this.s);if(D==="recovered"){if(this.recovery==null)throw new Error("recovery bit must be present");return et(Uint8Array.of(this.recovery),W,Q)}return et(W,Q)}toHex(D){return bt(this.toBytes(D))}assertValidity(){}static fromCompact(D){return me.fromBytes(Te("sig",D),"compact")}static fromDER(D){return me.fromBytes(Te("sig",D),"der")}normalizeS(){return this.hasHighS()?new me(this.r,h.neg(this.s),this.recovery):this}toDERRawBytes(){return this.toBytes("der")}toDERHex(){return bt(this.toBytes("der"))}toCompactRawBytes(){return this.toBytes("compact")}toCompactHex(){return bt(this.toBytes("compact"))}}const Me=i.bits2int||function(D){if(D.length>8192)throw new Error("input is too large");const W=Xt(D),Q=D.length*8-y;return Q>0?W>>BigInt(Q):W},He=i.bits2int_modN||function(D){return h.create(Me(D))},Ie=wn(y);function Se(q){return _a("num < 2^"+y,q,at,Ie),h.toBytes(q)}function tt(q,D){return Ct(q,void 0,"message"),D?Ct(e(q),void 0,"prehashed message"):q}function le(q,D,W){if(["recovered","canonical"].some(ye=>ye in W))throw new Error("sign() legacy options not supported");const{lowS:Q,prehash:ee,extraEntropy:X}=ti(W,K);q=tt(q,ee);const G=He(q),te=Kt(h,D),oe=[Se(te),Se(G)];if(X!=null&&X!==!1){const ye=X===!0?r(O.secretKey):X;oe.push(Te("extraEntropy",ye))}const be=et(...oe),ge=G;function ce(ye){const ke=Me(ye);if(!h.isValidNot0(ke))return;const Oe=h.inv(ke),V=t.BASE.multiply(ke).toAffine(),Re=h.create(V.x);if(Re===at)return;const nt=h.create(Oe*h.create(ge+Re*te));if(nt===at)return;let pe=(V.x===Re?0:2)|Number(V.y&Zt),ut=nt;return Q&&ne(nt)&&(ut=h.neg(nt),pe^=1),new me(Re,ut,pe)}return{seed:be,k2sig:ce}}function vt(q,D,W={}){q=Te("message",q);const{seed:Q,k2sig:ee}=le(q,D,W);return xa(e.outputLen,h.BYTES,o)(Q,ee)}function Ze(q){let D;const W=typeof q=="string"||hr(q),Q=!W&&q!==null&&typeof q=="object"&&typeof q.r=="bigint"&&typeof q.s=="bigint";if(!W&&!Q)throw new Error("invalid signature, expected Uint8Array, hex string or Signature instance");if(Q)D=new me(q.r,q.s);else if(W){try{D=me.fromBytes(Te("sig",q),"der")}catch(ee){if(!(ee instanceof ot.Err))throw ee}if(!D)try{D=me.fromBytes(Te("sig",q),"compact")}catch{return!1}}return D||!1}function he(q,D,W,Q={}){const{lowS:ee,prehash:X,format:G}=ti(Q,K);if(W=Te("publicKey",W),D=tt(Te("message",D),X),"strict"in Q)throw new Error("options.strict was renamed to lowS");const te=G===void 0?Ze(q):me.fromBytes(Te("sig",q),G);if(te===!1)return!1;try{const oe=t.fromBytes(W);if(ee&&te.hasHighS())return!1;const{r:be,s:ge}=te,ce=He(D),ye=h.inv(ge),ke=h.create(ce*ye),Oe=h.create(be*ye),V=t.BASE.multiplyUnsafe(ke).add(oe.multiplyUnsafe(Oe));return V.is0()?!1:h.create(V.x)===be}catch{return!1}}function U(q,D,W={}){const{prehash:Q}=ti(W,K);return D=tt(D,Q),me.fromBytes(q,"recovered").recoverPublicKey(D).toBytes()}return Object.freeze({keygen:S,getPublicKey:I,getSharedSecret:C,utils:T,lengths:O,Point:t,sign:vt,verify:he,recoverPublicKey:U,Signature:me,hash:e})}function Va(t){const e={a:t.a,b:t.b,p:t.Fp.ORDER,n:t.n,h:t.h,Gx:t.Gx,Gy:t.Gy},i=t.Fp;let r=t.allowedPrivateKeyLengths?Array.from(new Set(t.allowedPrivateKeyLengths.map(h=>Math.ceil(h/2)))):void 0;const o=kn(e.n,{BITS:t.nBitLength,allowedLengths:r,modFromBytes:t.wrapPrivateKey}),c={Fp:i,Fn:o,allowInfinityPoint:t.allowInfinityPoint,endo:t.endo,isTorsionFree:t.isTorsionFree,clearCofactor:t.clearCofactor,fromBytes:t.fromBytes,toBytes:t.toBytes};return{CURVE:e,curveOpts:c}}function Ha(t){const{CURVE:e,curveOpts:i}=Va(t),r={hmac:t.hmac,randomBytes:t.randomBytes,lowS:t.lowS,bits2int:t.bits2int,bits2int_modN:t.bits2int_modN};return{CURVE:e,curveOpts:i,hash:t.hash,ecdsaOpts:r}}function Wa(t,e){const i=e.Point;return Object.assign({},e,{ProjectivePoint:i,CURVE:Object.assign({},t,Ws(i.Fn.ORDER,i.Fn.BITS))})}function Ya(t){const{CURVE:e,curveOpts:i,hash:r,ecdsaOpts:o}=Ha(t),c=$a(e,i),h=La(c,r,o);return Wa(t,h)}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */function Za(t,e){const i=r=>Ya({...t,hash:r});return{...i(e),create:i}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const Jt={p:BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),n:BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),h:BigInt(1),a:BigInt(0),b:BigInt(7),Gx:BigInt("0x79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798"),Gy:BigInt("0x483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b8")},Ga={beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),basises:[[BigInt("0x3086d221a7d46bcde86c90e49284eb15"),-BigInt("0xe4437ed6010e88286f547fa90abfe4c3")],[BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),BigInt("0x3086d221a7d46bcde86c90e49284eb15")]]},Ja=BigInt(0),gs=BigInt(1),hi=BigInt(2);function Qa(t){const e=Jt.p,i=BigInt(3),r=BigInt(6),o=BigInt(11),c=BigInt(22),h=BigInt(23),d=BigInt(44),y=BigInt(88),S=t*t*t%e,I=S*S*t%e,C=Le(I,i,e)*I%e,T=Le(C,i,e)*I%e,O=Le(T,hi,e)*S%e,K=Le(O,o,e)*O%e,Y=Le(K,c,e)*K%e,ne=Le(Y,d,e)*Y%e,ie=Le(ne,y,e)*ne%e,$e=Le(ie,d,e)*Y%e,me=Le($e,i,e)*I%e,Me=Le(me,h,e)*K%e,He=Le(Me,r,e)*S%e,Ie=Le(He,hi,e);if(!sr.eql(sr.sqr(Ie),t))throw new Error("Cannot find square root");return Ie}const sr=kn(Jt.p,{sqrt:Qa}),no=Za({...Jt,Fp:sr,lowS:!0,endo:Ga},nr),ms={};function or(t,...e){let i=ms[t];if(i===void 0){const r=nr(Os(t));i=et(r,r),ms[t]=i}return nr(et(i,...e))}const wi=t=>t.toBytes(!0).slice(1),en=no.Point,ki=t=>t%hi===Ja;function fi(t){const{Fn:e,BASE:i}=en,r=Kt(e,t),o=i.multiply(r);return{scalar:ki(o.y)?r:e.neg(r),bytes:wi(o)}}function ro(t){const e=sr;if(!e.isValidNot0(t))throw new Error("invalid x: Fail if x â‰¥ p");const i=e.create(t*t),r=e.create(i*t+BigInt(7));let o=e.sqrt(r);ki(o)||(o=e.neg(o));const c=en.fromAffine({x:t,y:o});return c.assertValidity(),c}const mn=Xt;function io(...t){return en.Fn.create(mn(or("BIP0340/challenge",...t)))}function bs(t){return fi(t).bytes}function Xa(t,e,i=fr(32)){const{Fn:r}=en,o=Te("message",t),{bytes:c,scalar:h}=fi(e),d=Te("auxRand",i,32),y=r.toBytes(h^mn(or("BIP0340/aux",d))),S=or("BIP0340/nonce",y,c,o),{bytes:I,scalar:C}=fi(S),T=io(I,c,o),O=new Uint8Array(64);if(O.set(I,0),O.set(r.toBytes(r.create(C+T*h)),32),!so(O,o,c))throw new Error("sign: Invalid signature produced");return O}function so(t,e,i){const{Fn:r,BASE:o}=en,c=Te("signature",t,64),h=Te("message",e),d=Te("publicKey",i,32);try{const y=ro(mn(d)),S=mn(c.subarray(0,32));if(!ci(S,gs,Jt.p))return!1;const I=mn(c.subarray(32,64));if(!ci(I,gs,Jt.n))return!1;const C=io(r.toBytes(S),wi(y),h),T=o.multiplyUnsafe(I).add(y.multiplyUnsafe(r.neg(C))),{x:O,y:K}=T.toAffine();return!(T.is0()||!ki(K)||O!==S)}catch{return!1}}const eu=(()=>{const i=(o=fr(48))=>Gs(o,Jt.n);no.utils.randomSecretKey;function r(o){const c=i(o);return{secretKey:c,publicKey:bs(c)}}return{keygen:r,getPublicKey:bs,sign:Xa,verify:so,Point:en,utils:{randomSecretKey:i,randomPrivateKey:i,taggedHash:or,lift_x:ro,pointToBytes:wi,numberToBytesBE:dr,bytesToNumberBE:Xt,mod:Ve},lengths:{secretKey:32,publicKey:32,publicKeyHasPrefix:!1,signature:32*2,seed:48}}})(),oo=nr;var tu=Object.defineProperty,nu=Object.getOwnPropertyDescriptor,ru=Object.getOwnPropertyNames,iu=Object.prototype.hasOwnProperty,su=(t,e,i,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of ru(e))!iu.call(t,o)&&o!==i&&tu(t,o,{get:()=>e[o],enumerable:!(r=nu(e,o))||r.enumerable});return t},ou=(t,e,i)=>(su(t,e,"default"),i);function Ei(t,e,i="write"){if(!t.outboxTracker)return;const r=t.outboxTracker.data.get(e);if(r)return i==="write"?r.writeRelays:r.readRelays}async function au(t,e,i="write"){if(t.outboxTracker)return t.outboxTracker.data.has(e)||await t.outboxTracker.trackUsers([e]),Ei(t,e,i)}function uu(t,e){const i=new Map;return e.forEach(o=>{const c=Ei(t,o);c&&c.forEach(h=>{const d=i.get(h)||0;i.set(h,d+1)})}),Array.from(i.entries()).sort((o,c)=>c[1]-o[1]).map(o=>o[0])}function cu(t,e,i="read"){const r=new Map,o=new Set;return e.forEach(c=>{const h=Ei(t,c,i);h&&h.size>0?(h.forEach(d=>{(r.get(d)||new Set).add(c)}),r.set(c,h)):o.add(c)}),{pubkeysToRelays:r,authorsMissingRelays:o}}function lu(t,e,i,{count:r,preferredRelays:o}={}){r??=2,o??=new Set;const c=t.pool,h=c.connectedRelays();h.forEach(T=>{o?.add(T.url)});const d=new Map,{pubkeysToRelays:y,authorsMissingRelays:S}=cu(t,e,i),I=uu(t,e),C=(T,O)=>{const K=d.get(O)||[];K.push(T),d.set(O,K)};for(const[T,O]of y.entries()){let K=r;const Y=new Set;for(const ne of h)O.has(ne.url)&&(C(T,ne.url),Y.add(ne.url),K--);for(const ne of O)Y.has(ne)||d.has(ne)&&(C(T,ne),Y.add(ne),K--);if(!(K<=0))for(const ne of I){if(K<=0)break;Y.has(ne)||O.has(ne)&&(C(T,ne),Y.add(ne),K--)}}for(const T of S)c.permanentAndConnectedRelays().forEach(O=>{const K=d.get(O.url)||[];K.push(T),d.set(O.url,K)});return d}function Qt(t){let e=gu(t,{stripAuthentication:!1,stripWWW:!1,stripHash:!0});return e.endsWith("/")||(e+="/"),e}var hu="text/plain",fu="us-ascii",ni=(t,e)=>e.some(i=>i instanceof RegExp?i.test(t):i===t),du=new Set(["https:","http:","file:"]),pu=t=>{try{const{protocol:e}=new URL(t);return e.endsWith(":")&&!e.includes(".")&&!du.has(e)}catch{return!1}},yu=(t,{stripHash:e})=>{const i=/^data:(?<type>[^,]*?),(?<data>[^#]*?)(?:#(?<hash>.*))?$/.exec(t);if(!i)throw new Error(`Invalid URL: ${t}`);const r=i.groups?.type??"",o=i.groups?.data??"";let c=i.groups?.hash??"";const h=r.split(";");c=e?"":c;let d=!1;h[h.length-1]==="base64"&&(h.pop(),d=!0);const y=h.shift()?.toLowerCase()??"",I=[...h.map(C=>{let[T,O=""]=C.split("=").map(K=>K.trim());return T==="charset"&&(O=O.toLowerCase(),O===fu)?"":`${T}${O?`=${O}`:""}`}).filter(Boolean)];return d&&I.push("base64"),(I.length>0||y&&y!==hu)&&I.unshift(y),`data:${I.join(";")},${d?o.trim():o}${c?`#${c}`:""}`};function gu(t,e={}){if(e={defaultProtocol:"http",normalizeProtocol:!0,forceHttp:!1,forceHttps:!1,stripAuthentication:!0,stripHash:!1,stripTextFragment:!0,stripWWW:!0,removeQueryParameters:[/^utm_\w+/i],removeTrailingSlash:!0,removeSingleSlash:!0,removeDirectoryIndex:!1,removeExplicitPort:!1,sortQueryParameters:!0,...e},typeof e.defaultProtocol=="string"&&!e.defaultProtocol.endsWith(":")&&(e.defaultProtocol=`${e.defaultProtocol}:`),t=t.trim(),/^data:/i.test(t))return yu(t,e);if(pu(t))return t;const i=t.startsWith("//");!i&&/^\.*\//.test(t)||(t=t.replace(/^(?!(?:\w+:)?\/\/)|^\/\//,e.defaultProtocol));const o=new URL(t);if(o.hostname=o.hostname.toLowerCase(),e.forceHttp&&e.forceHttps)throw new Error("The `forceHttp` and `forceHttps` options cannot be used together");if(e.forceHttp&&o.protocol==="https:"&&(o.protocol="http:"),e.forceHttps&&o.protocol==="http:"&&(o.protocol="https:"),e.stripAuthentication&&(o.username="",o.password=""),e.stripHash?o.hash="":e.stripTextFragment&&(o.hash=o.hash.replace(/#?:~:text.*?$/i,"")),o.pathname){const h=/\b[a-z][a-z\d+\-.]{1,50}:\/\//g;let d=0,y="";for(;;){const I=h.exec(o.pathname);if(!I)break;const C=I[0],T=I.index,O=o.pathname.slice(d,T);y+=O.replace(/\/{2,}/g,"/"),y+=C,d=T+C.length}const S=o.pathname.slice(d,o.pathname.length);y+=S.replace(/\/{2,}/g,"/"),o.pathname=y}if(o.pathname)try{o.pathname=decodeURI(o.pathname)}catch{}if(e.removeDirectoryIndex===!0&&(e.removeDirectoryIndex=[/^index\.[a-z]+$/]),Array.isArray(e.removeDirectoryIndex)&&e.removeDirectoryIndex.length>0){let h=o.pathname.split("/");const d=h[h.length-1];ni(d,e.removeDirectoryIndex)&&(h=h.slice(0,-1),o.pathname=`${h.slice(1).join("/")}/`)}if(o.hostname&&(o.hostname=o.hostname.replace(/\.$/,""),e.stripWWW&&/^www\.(?!www\.)[a-z\-\d]{1,63}\.[a-z.\-\d]{2,63}$/.test(o.hostname)&&(o.hostname=o.hostname.replace(/^www\./,""))),Array.isArray(e.removeQueryParameters))for(const h of[...o.searchParams.keys()])ni(h,e.removeQueryParameters)&&o.searchParams.delete(h);if(!Array.isArray(e.keepQueryParameters)&&e.removeQueryParameters===!0&&(o.search=""),Array.isArray(e.keepQueryParameters)&&e.keepQueryParameters.length>0)for(const h of[...o.searchParams.keys()])ni(h,e.keepQueryParameters)||o.searchParams.delete(h);if(e.sortQueryParameters){o.searchParams.sort();try{o.search=decodeURIComponent(o.search)}catch{}}e.removeTrailingSlash&&(o.pathname=o.pathname.replace(/\/$/,"")),e.removeExplicitPort&&o.port&&(o.port="");const c=t;return t=o.toString(),!e.removeSingleSlash&&o.pathname==="/"&&!c.endsWith("/")&&o.hash===""&&(t=t.replace(/\/$/,"")),(e.removeTrailingSlash||o.pathname==="/")&&o.hash===""&&e.removeSingleSlash&&(t=t.replace(/\/$/,"")),i&&!e.normalizeProtocol&&(t=t.replace(/^http:\/\//,"//")),e.stripProtocol&&(t=t.replace(/^(?:https?:)?\/\//,"")),t}var mu=class{constructor(t=3e4,e){this.onSilenceDetected=e,this.timeout=t}lastActivity=Date.now();timer;timeout;isRunning=!1;recordActivity(){this.lastActivity=Date.now(),this.isRunning&&this.resetTimer()}start(){this.isRunning||(this.isRunning=!0,this.lastActivity=Date.now(),this.resetTimer())}stop(){this.isRunning=!1,this.timer&&(clearTimeout(this.timer),this.timer=void 0)}resetTimer(){this.timer&&clearTimeout(this.timer),this.timer=setTimeout(()=>{const t=Date.now()-this.lastActivity;if(t>=this.timeout)this.onSilenceDetected();else{const e=this.timeout-t;this.timer=setTimeout(()=>{this.onSilenceDetected()},e)}},this.timeout)}};async function vs(t){const e=`probe-${Math.random().toString(36).substring(7)}`;return new Promise(i=>{let r=!1;const o=setTimeout(()=>{r||(r=!0,t.send(["CLOSE",e]),i(!1))},5e3),c=()=>{r||(r=!0,clearTimeout(o),t.send(["CLOSE",e]),i(!0))};t.once("message",c),t.send(["REQ",e,{kinds:[99999],limit:0}])})}var bu=5,vu=1e3,wu=class{ndkRelay;ws;_status;timeoutMs;connectedAt;_connectionStats={attempts:0,success:0,durations:[]};debug;netDebug;connectTimeout;reconnectTimeout;ndk;openSubs=new Map;openCountRequests=new Map;openEventPublishes=new Map;serial=0;baseEoseTimeout=4400;keepalive;wsStateMonitor;sleepDetector;lastSleepCheck=Date.now();lastMessageSent=Date.now();wasIdle=!1;constructor(t,e){this.ndkRelay=t,this._status=1;const i=Math.floor(Math.random()*1e3);this.debug=this.ndkRelay.debug.extend(`connectivity${i}`),this.ndk=e,this.setupMonitoring()}setupMonitoring(){this.keepalive=new mu(3e4,async()=>{this.debug("Relay silence detected, probing connection"),await vs({send:e=>this.send(JSON.stringify(e)),once:(e,i)=>{const r=o=>{try{const c=JSON.parse(o.data);(c[0]==="EOSE"||c[0]==="EVENT"||c[0]==="NOTICE")&&(i(),this.ws?.removeEventListener("message",r))}catch{}};this.ws?.addEventListener("message",r)}})||(this.debug("Probe failed, connection is stale"),this.handleStaleConnection())}),this.wsStateMonitor=setInterval(()=>{this._status===5&&(!this.ws||this.ws.readyState!==WebSocket.OPEN)&&(this.debug("WebSocket died silently, reconnecting"),this.handleStaleConnection())},5e3),this.sleepDetector=setInterval(()=>{const t=Date.now(),e=t-this.lastSleepCheck;e>15e3&&(this.debug(`Detected possible sleep/wake (${e}ms gap)`),this.handlePossibleWake()),this.lastSleepCheck=t},1e4)}handleStaleConnection(){this._status=1,this.wasIdle=!0,this.onDisconnect()}handlePossibleWake(){this.debug("System wake detected, checking all connections"),this.wasIdle=!0,this._status>=5&&(!this.ws||this.ws.readyState!==WebSocket.OPEN?this.handleStaleConnection():vs({send:t=>this.send(JSON.stringify(t)),once:(t,e)=>{const i=r=>{try{const o=JSON.parse(r.data);(o[0]==="EOSE"||o[0]==="EVENT"||o[0]==="NOTICE")&&(e(),this.ws?.removeEventListener("message",i))}catch{}};this.ws?.addEventListener("message",i)}}).then(t=>{t||this.handleStaleConnection()}))}resetReconnectionState(){this.wasIdle=!0,this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=void 0)}async connect(t,e=!0){if(this.ws&&this.ws.readyState!==WebSocket.OPEN&&this.ws.readyState!==WebSocket.CONNECTING){this.debug("Cleaning up stale WebSocket connection");try{this.ws.close()}catch{}this.ws=void 0,this._status=1}if(this._status!==2&&this._status!==1||this.reconnectTimeout){this.debug("Relay requested to be connected but was in state %s or it had a reconnect timeout",this._status);return}this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=void 0),this.connectTimeout&&(clearTimeout(this.connectTimeout),this.connectTimeout=void 0),t??=this.timeoutMs,!this.timeoutMs&&t&&(this.timeoutMs=t),this.timeoutMs&&(this.connectTimeout=setTimeout(()=>this.onConnectionError(e),this.timeoutMs));try{this.updateConnectionStats.attempt(),this._status===1?this._status=4:this._status=2,this.ws=new WebSocket(this.ndkRelay.url),this.ws.onopen=this.onConnect.bind(this),this.ws.onclose=this.onDisconnect.bind(this),this.ws.onmessage=this.onMessage.bind(this),this.ws.onerror=this.onError.bind(this)}catch(i){throw this.debug(`Failed to connect to ${this.ndkRelay.url}`,i),this._status=1,e?this.handleReconnection():this.ndkRelay.emit("delayed-connect",2*24*60*60*1e3),i}}disconnect(){this._status=0,this.keepalive?.stop(),this.wsStateMonitor&&(clearInterval(this.wsStateMonitor),this.wsStateMonitor=void 0),this.sleepDetector&&(clearInterval(this.sleepDetector),this.sleepDetector=void 0);try{this.ws?.close()}catch(t){this.debug("Failed to disconnect",t),this._status=1}}onConnectionError(t){this.debug(`Error connecting to ${this.ndkRelay.url}`,this.timeoutMs),t&&!this.reconnectTimeout&&this.handleReconnection()}onConnect(){this.netDebug?.("connected",this.ndkRelay),this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=void 0),this.connectTimeout&&(clearTimeout(this.connectTimeout),this.connectTimeout=void 0),this.updateConnectionStats.connected(),this._status=5,this.keepalive?.start(),this.wasIdle=!1,this.ndkRelay.emit("connect"),this.ndkRelay.emit("ready")}onDisconnect(){this.netDebug?.("disconnected",this.ndkRelay),this.updateConnectionStats.disconnected(),this.keepalive?.stop(),this._status===5&&this.handleReconnection(),this._status=1,this.ndkRelay.emit("disconnect")}onMessage(t){this.netDebug?.(t.data,this.ndkRelay,"recv"),this.keepalive?.recordActivity();try{const e=JSON.parse(t.data),[i,r,...o]=e;switch(i){case"EVENT":{const c=this.openSubs.get(r),h=e[2];if(!c){this.debug(`Received event for unknown subscription ${r}`);return}c.onevent(h);return}case"COUNT":{const c=e[2],h=this.openCountRequests.get(r);h&&(h.resolve(c.count),this.openCountRequests.delete(r));return}case"EOSE":{const c=this.openSubs.get(r);if(!c)return;c.oneose(r);return}case"OK":{const c=e[2],h=e[3],d=this.openEventPublishes.get(r),y=d?.pop();if(!d||!y){this.debug("Received OK for unknown event publish",r);return}c?y.resolve(h):y.reject(new Error(h)),d.length===0?this.openEventPublishes.delete(r):this.openEventPublishes.set(r,d);return}case"CLOSED":{const c=this.openSubs.get(r);if(!c)return;c.onclosed(e[2]);return}case"NOTICE":this.onNotice(e[1]);return;case"AUTH":{this.onAuthRequested(e[1]);return}}}catch(e){this.debug(`Error parsing message from ${this.ndkRelay.url}: ${e.message}`,e?.stack);return}}async onAuthRequested(t){const e=this.ndkRelay.authPolicy??this.ndk?.relayAuthDefaultPolicy;if(this.debug("Relay requested authentication",{havePolicy:!!e}),this._status===7){this.debug("Already authenticating, ignoring");return}if(this._status=6,e){if(this._status>=5){this._status=7;let i;try{i=await e(this.ndkRelay,t)}catch(r){this.debug("Authentication policy threw an error",r),i=!1}if(this.debug("Authentication policy returned",!!i),i instanceof Ue||i===!0){i instanceof Ue&&await this.auth(i);const r=async()=>{if(this._status>=5&&this._status<8){const o=new Ue(this.ndk);o.kind=22242,o.tags=[["relay",this.ndkRelay.url],["challenge",t]],await o.sign(),this.auth(o).then(()=>{this._status=8,this.ndkRelay.emit("authed"),this.debug("Authentication successful")}).catch(c=>{this._status=6,this.ndkRelay.emit("auth:failed",c),this.debug("Authentication failed",c)})}else this.debug("Authentication failed, it changed status, status is %d",this._status)};i===!0&&(this.ndk?.signer?r().catch(o=>{console.error("Error authenticating",o)}):(this.debug("No signer available for authentication localhost"),this.ndk?.once("signer:ready",r))),this._status=5,this.ndkRelay.emit("authed")}}}else this.ndkRelay.emit("auth",t)}onError(t){this.debug(`WebSocket error on ${this.ndkRelay.url}:`,t)}get status(){return this._status}isAvailable(){return this._status===5}isFlapping(){const t=this._connectionStats.durations;if(t.length%3!==0)return!1;const i=t.reduce((h,d)=>h+d,0)/t.length,r=t.map(h=>(h-i)**2).reduce((h,d)=>h+d,0)/t.length;return Math.sqrt(r)<vu}async onNotice(t){this.ndkRelay.emit("notice",t)}handleReconnection(t=0){if(this.reconnectTimeout)return;if(this.isFlapping()){this.ndkRelay.emit("flapping",this._connectionStats),this._status=3;return}let e;if(this.wasIdle){const i=[0,1e3,2e3,5e3,1e4,3e4];e=i[Math.min(t,i.length-1)],this.debug(`Using aggressive reconnect after idle, attempt ${t}, delay ${e}ms`)}else this.connectedAt?e=Math.max(0,6e4-(Date.now()-this.connectedAt)):(e=Math.min(1e3*Math.pow(2,t),3e4),this.debug(`Using standard backoff, attempt ${t}, delay ${e}ms`));this.reconnectTimeout=setTimeout(()=>{this.reconnectTimeout=void 0,this._status=2,this.connect().catch(i=>{t<bu?this.handleReconnection(t+1):(this.debug("Max reconnect attempts reached"),this.wasIdle=!1)})},e),this.ndkRelay.emit("delayed-connect",e),this.debug("Reconnecting in",e),this._connectionStats.nextReconnectAt=Date.now()+e}async send(t){Date.now()-this.lastMessageSent>12e4&&(this.wasIdle=!0),this._status>=5&&this.ws?.readyState===WebSocket.OPEN?(this.ws?.send(t),this.netDebug?.(t,this.ndkRelay,"send"),this.lastMessageSent=Date.now()):(this.debug(`Not connected to ${this.ndkRelay.url} (%d), not sending message ${t}`,this._status),this._status>=5&&this.ws?.readyState!==WebSocket.OPEN&&(this.debug(`Stale connection detected, WebSocket state: ${this.ws?.readyState}`),this.handleStaleConnection()))}async auth(t){const e=new Promise((i,r)=>{const o=this.openEventPublishes.get(t.id)??[];o.push({resolve:i,reject:r}),this.openEventPublishes.set(t.id,o)});return this.send(`["AUTH",${JSON.stringify(t.rawEvent())}]`),e}async publish(t){const e=new Promise((i,r)=>{const o=this.openEventPublishes.get(t.id)??[];o.length>0&&console.warn(`Duplicate event publishing detected, you are publishing event ${t.id} twice`),o.push({resolve:i,reject:r}),this.openEventPublishes.set(t.id,o)});return this.send(`["EVENT",${JSON.stringify(t)}]`),e}async count(t,e){this.serial++;const i=e?.id||`count:${this.serial}`,r=new Promise((o,c)=>{this.openCountRequests.set(i,{resolve:o,reject:c})});return this.send(`["COUNT","${i}",${JSON.stringify(t).substring(1)}`),r}close(t,e){this.send(`["CLOSE","${t}"]`);const i=this.openSubs.get(t);this.openSubs.delete(t),i&&i.onclose(e)}req(t){`${this.send(`["REQ","${t.subId}",${JSON.stringify(t.executeFilters).substring(1)}`)}`,this.openSubs.set(t.subId,t)}updateConnectionStats={connected:()=>{this._connectionStats.success++,this._connectionStats.connectedAt=Date.now()},disconnected:()=>{this._connectionStats.connectedAt&&(this._connectionStats.durations.push(Date.now()-this._connectionStats.connectedAt),this._connectionStats.durations.length>100&&this._connectionStats.durations.shift()),this._connectionStats.connectedAt=void 0},attempt:()=>{this._connectionStats.attempts++,this._connectionStats.connectedAt=Date.now()}};get connectionStats(){return this._connectionStats}get url(){return this.ndkRelay.url}get connected(){return this._status>=5&&this.ws?.readyState===WebSocket.OPEN}},ku=class{ndkRelay;debug;constructor(t){this.ndkRelay=t,this.debug=t.debug.extend("publisher")}async publish(t,e=2500){let i;const r=()=>new Promise((I,C)=>{try{this.publishEvent(t).then(T=>{this.ndkRelay.emit("published",t),t.emit("relay:published",this.ndkRelay),I(!0)}).catch(C)}catch(T){C(T)}}),o=new Promise((I,C)=>{i=setTimeout(()=>{i=void 0,C(new Error(`Timeout: ${e}ms`))},e)}),c=()=>{r().then(I=>h(I)).catch(I=>d(I))};let h,d;const y=I=>{throw this.ndkRelay.debug("Publish failed",I,t.id),this.ndkRelay.emit("publish:failed",t,I),t.emit("relay:publish:failed",this.ndkRelay,I),I},S=()=>{i&&clearTimeout(i),this.ndkRelay.removeListener("connect",c)};return this.ndkRelay.status>=5?Promise.race([r(),o]).catch(y).finally(S):(this.ndkRelay.status<=1?(console.warn("Relay is disconnected, trying to connect to publish an event",this.ndkRelay.url),this.ndkRelay.connect()):console.warn("Relay not connected, waiting for connection to publish an event",this.ndkRelay.url),Promise.race([new Promise((I,C)=>{h=I,d=C,this.ndkRelay.on("connect",c)}),o]).catch(y).finally(S))}async publishEvent(t){return this.ndkRelay.connectivity.publish(t.rawEvent())}};function Eu(t,e){const i=[];for(const o of t){const c=Object.entries(o||{}).map(([h,d])=>["since","until"].includes(h)?`${h}:${d}`:h).sort().join("-");i.push(c)}let r=e?"+":"";return r+=i.join("|"),r}function _u(t){const e=[],i={};return t.filter(r=>!!r.limit).forEach(r=>e.push(r)),t=t.filter(r=>!r.limit),t.length===0?e:(t.forEach(r=>{Object.entries(r).forEach(([o,c])=>{Array.isArray(c)?i[o]===void 0?i[o]=[...c]:i[o]=Array.from(new Set([...i[o],...c])):i[o]=c})}),[...e,i])}var xu=class{fingerprint;items=new Map;topSubManager;debug;status=0;onClose;relay;eosed=!1;executionTimer;fireTime;delayType;executeFilters;id=Math.random().toString(36).substring(7);constructor(t,e,i){this.relay=t,this.topSubManager=i,this.debug=t.debug.extend(`sub[${this.id}]`),this.fingerprint=e||Math.random().toString(36).substring(7)}_subId;get subId(){return this._subId?this._subId:(this._subId=this.fingerprint.slice(0,15),this._subId)}subIdParts=new Set;addSubIdPart(t){this.subIdParts.add(t)}addItem(t,e){if(this.debug("Adding item",{filters:e,internalId:t.internalId,status:this.status,fingerprint:this.fingerprint,id:this.subId,items:this.items,itemsSize:this.items.size}),!this.items.has(t.internalId))switch(t.on("close",this.removeItem.bind(this,t)),this.items.set(t.internalId,{subscription:t,filters:e}),this.status!==3&&t.subId&&(!this._subId||this._subId.length<48)&&(this.status===0||this.status===1)&&this.addSubIdPart(t.subId),this.status){case 0:this.evaluateExecutionPlan(t);break;case 3:break;case 1:this.evaluateExecutionPlan(t);break;case 4:throw this.debug("Subscription is closed, cannot add new items %o (%o)",t,e),new Error("Cannot add new items to a closed subscription")}}removeItem(t){if(this.items.delete(t.internalId),this.items.size===0){if(!this.eosed)return;this.close(),this.cleanup()}}close(){if(this.status===4)return;const t=this.status;if(this.status=4,t===3)try{this.relay.close(this.subId)}catch(e){this.debug("Error closing subscription",e,this)}else this.debug("Subscription wanted to close but it wasn't running, this is probably ok",{subId:this.subId,prevStatus:t,sub:this});this.cleanup()}cleanup(){this.executionTimer&&clearTimeout(this.executionTimer),this.relay.off("ready",this.executeOnRelayReady),this.relay.off("authed",this.reExecuteAfterAuth),this.onClose&&this.onClose(this)}evaluateExecutionPlan(t){if(!t.isGroupable()){this.status=1,this.execute();return}if(t.filters.find(r=>!!r.limit)&&(this.executeFilters=this.compileFilters(),this.executeFilters.length>=10)){this.status=1,this.execute();return}const e=t.groupableDelay,i=t.groupableDelayType;if(!e)throw new Error("Cannot group a subscription without a delay");if(this.status===0)this.schedule(e,i);else{const r=this.delayType,o=this.fireTime-Date.now();if(r==="at-least"&&i==="at-least")o<e&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(e,i));else if(r==="at-least"&&i==="at-most")o>e&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(e,i));else if(r==="at-most"&&i==="at-most")o>e&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(e,i));else if(r==="at-most"&&i==="at-least")o>e&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(e,i));else throw new Error(`Unknown delay type combination ${r} ${i}`)}}schedule(t,e){this.status=1;const i=Date.now();this.fireTime=i+t,this.delayType=e;const r=setTimeout(this.execute.bind(this),t);e==="at-least"&&(this.executionTimer=r)}executeOnRelayReady=()=>{if(this.status===2){if(this.items.size===0){this.debug("No items to execute; this relay was probably too slow to respond and the caller gave up",{status:this.status,fingerprint:this.fingerprint,items:this.items,itemsSize:this.items.size,id:this.id,subId:this.subId}),this.cleanup();return}this.debug("Executing on relay ready",{status:this.status,fingerprint:this.fingerprint,items:this.items,itemsSize:this.items.size}),this.status=1,this.execute()}};finalizeSubId(){this.subIdParts.size>0?this._subId=Array.from(this.subIdParts).join("-"):this._subId=this.fingerprint.slice(0,15),this._subId+=`-${Math.random().toString(36).substring(2,7)}`}reExecuteAfterAuth=(()=>{const t=this.subId;this.debug("Re-executing after auth",this.items.size),this.eosed?this.relay.close(this.subId):this.debug("We are abandoning an opened subscription, once it EOSE's, the handler will close it",{oldSubId:t}),this._subId=void 0,this.status=1,this.execute(),this.debug("Re-executed after auth %s ðŸ‘‰ %s",t,this.subId)}).bind(this);execute(){if(this.status===1){if(!this.relay.connected){this.status=2,this.debug("Waiting for relay to be ready",{status:this.status,id:this.subId,fingerprint:this.fingerprint,items:this.items,itemsSize:this.items.size}),this.relay.once("ready",this.executeOnRelayReady);return}this.relay.status<8&&this.relay.once("authed",this.reExecuteAfterAuth),this.status=3,this.finalizeSubId(),this.executeFilters=this.compileFilters(),this.relay.req(this)}}onstart(){}onevent(t){this.topSubManager.dispatchEvent(t,this.relay)}oneose(t){if(this.eosed=!0,t!==this.subId){this.debug("Received EOSE for an abandoned subscription",t,this.subId),this.relay.close(t);return}this.items.size===0&&this.close();for(const{subscription:e}of this.items.values())e.eoseReceived(this.relay),e.closeOnEose&&(this.debug("Removing item because of EOSE",{filters:e.filters,internalId:e.internalId,status:this.status,fingerprint:this.fingerprint,items:this.items,itemsSize:this.items.size}),this.removeItem(e))}onclose(t){this.status=4}onclosed(t){if(t)for(const{subscription:e}of this.items.values())e.closedReceived(this.relay,t)}compileFilters(){const t=[],e=Array.from(this.items.values()).map(r=>r.filters);if(!e[0])return this.debug("ðŸ‘€ No filters to merge",this.items),console.error("BUG: No filters to merge!",this.items),[];const i=e[0].length;for(let r=0;r<i;r++){const o=e.map(c=>c[r]);t.push(..._u(o))}return t}},Su=class{relay;subscriptions;generalSubManager;constructor(t,e){this.relay=t,this.subscriptions=new Map,this.generalSubManager=e}addSubscription(t,e){let i;if(!t.isGroupable())i=this.createSubscription(t,e);else{const r=Eu(e,t.closeOnEose);r&&(i=(this.subscriptions.get(r)||[]).find(c=>c.status<3)),i??=this.createSubscription(t,e,r)}i.addItem(t,e)}createSubscription(t,e,i){const r=new xu(this.relay,i||null,this.generalSubManager);r.onClose=this.onRelaySubscriptionClose.bind(this);const o=this.subscriptions.get(r.fingerprint)??[];return this.subscriptions.set(r.fingerprint,[...o,r]),r}onRelaySubscriptionClose(t){let e=this.subscriptions.get(t.fingerprint)??[];e?e.length===1?this.subscriptions.delete(t.fingerprint):(e=e.filter(i=>i.id!==t.id),this.subscriptions.set(t.fingerprint,e)):console.warn("Unexpectedly did not find a subscription with fingerprint",t.fingerprint)}},ar=class ao extends vn.EventEmitter{url;scores;connectivity;subs;publisher;authPolicy;lowestValidationRatio;targetValidationRatio;validationRatioFn;validatedEventCount=0;nonValidatedEventCount=0;trusted=!1;complaining=!1;debug;static defaultValidationRatioUpdateFn=(e,i,r)=>{if(e.lowestValidationRatio===void 0||e.targetValidationRatio===void 0)return 1;let o=e.validationRatio;if(e.validationRatio>e.targetValidationRatio){const c=i/100;o=Math.max(e.lowestValidationRatio,e.validationRatio-c)}return o<e.validationRatio?o:e.validationRatio};constructor(e,i,r){super(),this.url=Qt(e),this.scores=new Map,this.debug=Ye(`ndk:relay:${e}`),this.connectivity=new wu(this,r),this.connectivity.netDebug=r?.netDebug,this.req=this.connectivity.req.bind(this.connectivity),this.close=this.connectivity.close.bind(this.connectivity),this.subs=new Su(this,r.subManager),this.publisher=new ku(this),this.authPolicy=i,this.targetValidationRatio=r?.initialValidationRatio,this.lowestValidationRatio=r?.lowestValidationRatio,this.validationRatioFn=(r?.validationRatioFn??ao.defaultValidationRatioUpdateFn).bind(this),this.updateValidationRatio(),r||console.trace("relay created without ndk")}updateValidationRatio(){if(this.validationRatioFn&&this.validatedEventCount>0){const e=this.validationRatioFn(this,this.validatedEventCount,this.nonValidatedEventCount);this.targetValidationRatio=e}setTimeout(()=>{this.updateValidationRatio()},3e4)}get status(){return this.connectivity.status}get connectionStats(){return this.connectivity.connectionStats}async connect(e,i=!0){return this.connectivity.connect(e,i)}disconnect(){this.status!==1&&this.connectivity.disconnect()}subscribe(e,i){this.subs.addSubscription(e,i)}async publish(e,i=2500){return this.publisher.publish(e,i)}referenceTags(){return[["r",this.url]]}addValidatedEvent(){this.validatedEventCount++}addNonValidatedEvent(){this.nonValidatedEventCount++}get validationRatio(){return this.nonValidatedEventCount===0?1:this.validatedEventCount/(this.validatedEventCount+this.nonValidatedEventCount)}shouldValidateEvent(){return this.trusted?!1:this.targetValidationRatio===void 0||this.targetValidationRatio>=1?!0:Math.random()<this.targetValidationRatio}get connected(){return this.connectivity.connected}req;close},Ru=class extends Error{errors;publishedToRelays;intendedRelaySet;constructor(t,e,i,r){super(t),this.errors=e,this.publishedToRelays=i,this.intendedRelaySet=r}get relayErrors(){const t=[];for(const[e,i]of this.errors)t.push(`${e.url}: ${i}`);return t.join(`
`)}},_i=class uo{relays;debug;ndk;pool;constructor(e,i,r){this.relays=e,this.ndk=i,this.pool=r??i.pool,this.debug=i.debug.extend("relayset")}addRelay(e){this.relays.add(e)}get relayUrls(){return Array.from(this.relays).map(e=>e.url)}static fromRelayUrls(e,i,r=!0,o){if(o=o??i.pool,!o)throw new Error("No pool provided");const c=new Set;for(const h of e){const d=o.relays.get(Qt(h));if(d)d.status<5&&r&&d.connect(),c.add(d);else{const y=new ar(Qt(h),i?.relayAuthDefaultPolicy,i);o.useTemporaryRelay(y,void 0,`requested from fromRelayUrls ${e}`),c.add(y)}}return new uo(new Set(c),i,o)}async publish(e,i,r=1){const o=new Set,c=new Map,h=e.isEphemeral();e.publishStatus="pending";const d=y=>{o.add(y)};e.on("relay:published",d);try{const y=Array.from(this.relays).map(S=>new Promise(I=>{const C=i?setTimeout(()=>{o.has(S)||(c.set(S,new Error(`Publish timeout after ${i}ms`)),I(!1))},i):null;S.publish(e,i).then(T=>{C&&clearTimeout(C),T?(o.add(S),I(!0)):I(!1)}).catch(T=>{C&&clearTimeout(C),h||c.set(S,T),I(!1)})}));if(await Promise.all(y),o.size<r){if(!h){const S=new Ru("Not enough relays received the event ("+o.size+" published, "+r+" required)",c,o,this);throw e.publishStatus="error",e.publishError=S,this.ndk?.emit("event:publish-failed",e,S,this.relayUrls),S}}else e.publishStatus="success",e.emit("published",{relaySet:this,publishedToRelays:o});return o}finally{e.off("relay:published",d)}}get size(){return this.relays.size}},Jn=Ye("ndk:outbox:calculate");async function Tu(t,e,i){const r=new Set,o=await au(t,e.pubkey);o&&o.forEach(d=>{const y=t.pool?.getRelay(d);y&&r.add(y)});let c=e.tags.filter(d=>["a","e"].includes(d[0])).map(d=>d[2]).filter(d=>d?.startsWith("wss://")).filter(d=>{try{return new URL(d),!0}catch{return!1}}).map(d=>Qt(d));c=Array.from(new Set(c)).slice(0,5),c.forEach(d=>{const y=t.pool?.getRelay(d,!0,!0);y&&(Jn("Adding relay hint %s",d),r.add(y))});const h=e.getMatchingTags("p").map(d=>d[1]);return h.length<5?Array.from(lu(t,h,"read",{preferredRelays:new Set(o)}).keys()).forEach(y=>{const S=t.pool?.getRelay(y,!1,!0);S&&(Jn("Adding p-tagged relay %s",y),r.add(S))}):Jn("Too many p-tags to consider %d",h.length),t.pool?.permanentAndConnectedRelays().forEach(d=>r.add(d)),i&&r.size<i&&t.explicitRelayUrls?.filter(y=>!Array.from(r).some(S=>S.url===y)).slice(0,i-r.size)?.forEach(y=>{const S=t.pool?.getRelay(y,!1,!0);S&&(Jn("Adding explicit relay %s",y),r.add(S))}),new _i(r,t)}function co(t,e){const i=new Map,r=h=>h.join(","),o=(h,d)=>h.every((y,S)=>y===d[S]),c=h=>{for(const[d,y]of i)if(o(y,h)||o(h,y)){h.length>=y.length&&i.set(d,h);return}i.set(r(h),h)};return t.concat(e).forEach(c),Array.from(i.values())}var Pu=/(?<=\s|^)(#[^\s!@#$%^&*()=+./,[{\]};:'"?><]+)/g;function Au(t){const e=t.match(Pu),i=new Set,r=new Set;if(e)for(const o of e)i.has(o.slice(1))||(r.add(o.slice(1)),i.add(o.slice(1)));return Array.from(r)}async function Iu(t,e=[],i,r){if(i?.skipContentTagging)return{content:t,tags:e};const o=/(@|nostr:)(npub|nprofile|note|nevent|naddr)[a-zA-Z0-9]+/g,c=[],h=d=>{e.find(y=>["q",d[0]].includes(y[0])&&y[1]===d[1])||e.push(d)};if(t=t.replace(o,d=>{try{const y=d.split(/(@|nostr:)/)[2],{type:S,data:I}=We.decode(y);let C;if(i?.filters){const T=!i.filters.includeTypes||i.filters.includeTypes.includes(S),O=i.filters.excludeTypes?.includes(S);if(!T||O)return d}switch(S){case"npub":i?.pTags!==!1&&(C=["p",I]);break;case"nprofile":i?.pTags!==!1&&(C=["p",I.pubkey]);break;case"note":c.push(new Promise(async T=>{const O=await ri(y);h(["q",I,O]),T()}));break;case"nevent":c.push(new Promise(async T=>{const{id:O,author:K}=I;let{relays:Y}=I;(!Y||Y.length===0)&&(Y=[await ri(y)]),h(["q",O,Y[0]]),K&&i?.pTags!==!1&&i?.pTagOnQTags!==!1&&h(["p",K]),T()}));break;case"naddr":c.push(new Promise(async T=>{const O=[I.kind,I.pubkey,I.identifier].join(":");let K=I.relays??[];K.length===0&&(K=[await ri(y)]),h(["q",O,K[0]]),i?.pTags!==!1&&i?.pTagOnQTags!==!1&&i?.pTagOnATags!==!1&&h(["p",I.pubkey]),T()}));break;default:return d}return C&&h(C),`nostr:${y}`}catch{return d}}),await Promise.all(c),!i?.filters?.excludeTypes?.includes("hashtag")){const d=Au(t).map(y=>["t",y]);e=co(e,d)}if(i?.pTags!==!1&&i?.copyPTagsFromTarget&&r){const d=r.getMatchingTags("p");for(const y of d)e.find(S=>S[0]==="p"&&S[1]===y[1])||e.push(y)}return{content:t,tags:e}}async function ri(t){return""}async function Ou(t,e,i="nip44"){let r;if(!this.ndk)throw new Error("No NDK instance found!");let o=e;if(o||(this.ndk.assertSigner(),o=this.ndk.signer),!o)throw new Error("no NDK signer");const c=t||(()=>{const h=this.getMatchingTags("p");if(h.length!==1)throw new Error("No recipient could be determined and no explicit recipient was provided");return this.ndk.getUser({pubkey:h[0][1]})})();if(i==="nip44"&&await ur(o,"nip44")&&(r=await o.encrypt(c,this.content,"nip44")),(!r||i==="nip04")&&await ur(o,"nip04")&&(r=await o.encrypt(c,this.content,"nip04")),!r)throw new Error("Failed to encrypt event.");this.content=r}async function Nu(t,e,i){if(this.ndk?.cacheAdapter?.getDecryptedEvent){let d=null;if(typeof this.ndk.cacheAdapter.getDecryptedEvent=="function"&&(d=this.ndk.cacheAdapter.getDecryptedEvent(this.id)),d){this.content=d.content;return}}let r;if(!this.ndk)throw new Error("No NDK instance found!");let o=e;if(o||(this.ndk.assertSigner(),o=this.ndk.signer),!o)throw new Error("no NDK signer");const c=t||this.author;if(!c)throw new Error("No sender provided and no author available");const h=i||(this.content.match(/\\?iv=/)?"nip04":"nip44");if((h==="nip04"||this.kind===4)&&await ur(o,"nip04")&&this.content.search("\\?iv=")&&(r=await o.decrypt(c,this.content,"nip04")),!r&&h==="nip44"&&await ur(o,"nip44")&&(r=await o.decrypt(c,this.content,"nip44")),!r)throw new Error("Failed to decrypt event.");this.content=r,this.ndk?.cacheAdapter?.addDecryptedEvent&&this.ndk.cacheAdapter.addDecryptedEvent(this)}async function ur(t,e){return t.encryptionEnabled?e?!!await t.encryptionEnabled(e):!0:!1}function Cu(t){for(const e of t.tags)if(e[0]==="e"&&(e[3]??"").length>0)return!0;return!1}function Bu(t,e){e??=t.tagType();const i=t.tags.find(qu);if(!i){if(Cu(t))return;const r=t.getMatchingTags(e);if(r.length<3)return r[0]}return i}var Du=new Set(["A","E","I"]),Ku=new Set(["a","e","i"]);function Uu(t,e){if(t.kind===1111){let o;for(const c of t.tags)if(Du.has(c[0]))o=c;else if(Ku.has(c[0])){o=c;break}return o}e??=t.tagType();let i=!1,r;for(const o of t.tags)if(o[0]===e){if((o[3]??"").length>0&&(i=!0),i&&o[3]==="reply")return o;i&&o[3]==="root"&&(r=o),i||(r=o)}return r}function qu(t){return t[0]==="E"||t[3]==="root"}async function Mu(t,e){if(!this.ndk)throw new Error("NDK instance not found");const i=this.getMatchingTags(t,e);if(i.length===0)return;const[r,o,c]=i[0];let h=c!==""?this.ndk.pool.getRelay(c):void 0;return await this.ndk.fetchEvent(o,{},h)}async function ju(t){if(!this.ndk)throw new Error("NDK instance not found");const e=Bu(this);if(e)return this.ndk.fetchEventFromTag(e,this,t)}async function Fu(t){if(!this.ndk)throw new Error("NDK instance not found");const e=Uu(this);if(e)return this.ndk.fetchEventFromTag(e,this,t)}function $u(){if(this.kind===void 0)throw new Error("Kind not set");return[0,3].includes(this.kind)||this.kind>=1e4&&this.kind<2e4||this.kind>=3e4&&this.kind<4e4}function zu(){if(this.kind===void 0)throw new Error("Kind not set");return this.kind>=2e4&&this.kind<3e4}function Lu(){if(this.kind===void 0)throw new Error("Kind not set");return this.kind>=3e4&&this.kind<4e4}var Vu=2;function Hu(t=Vu){let e=[];return this.onRelays.length>0?e=this.onRelays.map(i=>i.url):this.relay&&(e=[this.relay.url]),e.length>t&&(e=e.slice(0,t)),this.isParamReplaceable()?We.naddrEncode({kind:this.kind,pubkey:this.pubkey,identifier:this.replaceableDTag(),relays:e}):e.length>0?We.neventEncode({id:this.tagId(),relays:e,author:this.pubkey}):We.noteEncode(this.tagId())}async function Wu(t=!0,e){if(!e&&t){if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner(),e=this.ndk.signer}const i=new Ue(this.ndk,{kind:Yu(this)});return this.isProtected||(i.content=JSON.stringify(this.rawEvent())),i.tag(this),this.kind!==1&&i.tags.push(["k",`${this.kind}`]),e&&await i.sign(e),t&&await i.publish(),i}function Yu(t){return t.kind===1?6:16}function Zu(t=!1,e=!1){const i=[0,this.pubkey,this.created_at,this.kind,this.tags,this.content];return t&&i.push(this.sig),e&&i.push(this.id),JSON.stringify(i)}function lo(t){const e=JSON.parse(t),i={pubkey:e[1],created_at:e[2],kind:e[3],tags:e[4],content:e[5]};if(e.length>=7){const r=e[6],o=e[7];r&&r.length===128?(i.sig=r,o&&o.length===64&&(i.id=o)):r&&r.length===64&&(i.id=r,o&&o.length===128&&(i.sig=o))}return i}var ii={};async function Gu(t,e,i){const r=t.ndk,o=Date.now();let c;return r.signatureVerificationFunction?(console.log("[NDK-CORE] Using custom signature verification function async"),c=await r.signatureVerificationFunction(t),console.log("Custom signature verification result",t.id,{result:c})):(console.log("Using worker-based signature verification async"),c=await new Promise(h=>{t.serialize();let d=!1;ii[t.id]||(ii[t.id]={event:t,resolves:[],relay:i},d=!0),ii[t.id].resolves.push(h)})),r.signatureVerificationTimeMs+=Date.now()-o,c}var Ju=/^[a-f0-9]{64}$/;function Qu(){if(typeof this.kind!="number"||typeof this.content!="string"||typeof this.created_at!="number"||typeof this.pubkey!="string"||!this.pubkey.match(Ju)||!Array.isArray(this.tags))return!1;for(let t=0;t<this.tags.length;t++){const e=this.tags[t];if(!Array.isArray(e))return!1;for(let i=0;i<e.length;i++)if(typeof e[i]=="object")return!1}return!0}var yn=new oi.LRUCache({maxSize:1e3,entryExpirationTimeInMS:6e4});function Xu(t){if(typeof this.signatureVerified=="boolean")return this.signatureVerified;const e=yn.get(this.id);if(e!==null)return this.signatureVerified=!!e,this.signatureVerified;try{if(this.ndk?.asyncSigVerification)Gu(this,t,this.relay).then(i=>{t&&(this.signatureVerified=i,i&&yn.set(this.id,this.sig)),i||(this.relay?this.ndk?.reportInvalidSignature(this,this.relay):this.ndk?.reportInvalidSignature(this),yn.set(this.id,!1))}).catch(i=>{console.error("signature verification error",this.id,i)});else{const i=oo(new TextEncoder().encode(this.serialize())),r=eu.verify(this.sig,i,this.pubkey);return r?yn.set(this.id,this.sig):yn.set(this.id,!1),this.signatureVerified=r,r}}catch{return this.signatureVerified=!1,!1}}function ec(){return tc(this.serialize())}function tc(t){const e=oo(new TextEncoder().encode(t));return bt(e)}var ws=new Set([0,4,1059,13,3,9734,5]),Ue=class Nt extends vn.EventEmitter{ndk;created_at;content="";tags=[];kind;id="";sig;pubkey="";signatureVerified;_author=void 0;relay;get onRelays(){let e=[];return this.ndk?e=this.ndk.subManager.seenEvents.get(this.id)||[]:this.relay&&e.push(this.relay),e}publishStatus="success";publishError;constructor(e,i){super(),this.ndk=e,this.created_at=i?.created_at,this.content=i?.content||"",this.tags=i?.tags||[],this.id=i?.id||"",this.sig=i?.sig,this.pubkey=i?.pubkey||"",this.kind=i?.kind,i instanceof Nt&&(this.relay&&(this.relay=i.relay,this.ndk?.subManager.seenEvent(i.id,this.relay)),this.publishStatus=i.publishStatus,this.publishError=i.publishError)}static deserialize(e,i){return new Nt(e,lo(i))}rawEvent(){return{created_at:this.created_at,content:this.content,tags:this.tags,kind:this.kind,pubkey:this.pubkey,id:this.id,sig:this.sig}}set author(e){this.pubkey=e.pubkey,this._author=e,this._author.ndk??=this.ndk}get author(){if(this._author)return this._author;if(!this.ndk)throw new Error("No NDK instance found");const e=this.ndk.getUser({pubkey:this.pubkey});return this._author=e,e}tagExternal(e,i,r){const o=["i"],c=["k"];switch(i){case"url":{const h=new URL(e);h.hash="",o.push(h.toString()),c.push(`${h.protocol}//${h.host}`);break}case"hashtag":o.push(`#${e.toLowerCase()}`),c.push("#");break;case"geohash":o.push(`geo:${e.toLowerCase()}`),c.push("geo");break;case"isbn":o.push(`isbn:${e.replace(/-/g,"")}`),c.push("isbn");break;case"podcast:guid":o.push(`podcast:guid:${e}`),c.push("podcast:guid");break;case"podcast:item:guid":o.push(`podcast:item:guid:${e}`),c.push("podcast:item:guid");break;case"podcast:publisher:guid":o.push(`podcast:publisher:guid:${e}`),c.push("podcast:publisher:guid");break;case"isan":o.push(`isan:${e.split("-").slice(0,4).join("-")}`),c.push("isan");break;case"doi":o.push(`doi:${e.toLowerCase()}`),c.push("doi");break;default:throw new Error(`Unsupported NIP-73 entity type: ${i}`)}r&&o.push(r),this.tags.push(o),this.tags.push(c)}tag(e,i,r,o,c){let h=[];if(e.fetchProfile!==void 0){if(o??="p",o==="p"&&c?.pTags===!1)return;const y=[o,e.pubkey];i&&y.push("",i),h.push(y)}else if(e instanceof Nt){const y=e;if(r??=y?.pubkey===this.pubkey,h=y.referenceTags(i,r,o,c),c?.pTags!==!1)for(const S of y.getMatchingTags("p"))S[1]!==this.pubkey&&(this.tags.find(I=>I[0]==="p"&&I[1]===S[1])||this.tags.push(["p",S[1]]))}else if(Array.isArray(e))h=[e];else throw new Error("Invalid argument",e);this.tags=co(this.tags,h)}async toNostrEvent(e,i){if(!e&&this.pubkey===""){const c=await this.ndk?.signer?.user();this.pubkey=c?.pubkey||""}this.created_at||(this.created_at=Math.floor(Date.now()/1e3));const{content:r,tags:o}=await this.generateTags(i);this.content=r||"",this.tags=o;try{this.id=this.getEventHash()}catch{}return this.rawEvent()}serialize=Zu.bind(this);getEventHash=ec.bind(this);validate=Qu.bind(this);verifySignature=Xu.bind(this);isReplaceable=$u.bind(this);isEphemeral=zu.bind(this);isDvm=()=>this.kind&&this.kind>=5e3&&this.kind<=7e3;isParamReplaceable=Lu.bind(this);encode=Hu.bind(this);encrypt=Ou.bind(this);decrypt=Nu.bind(this);getMatchingTags(e,i){const r=this.tags.filter(o=>o[0]===e);return i===void 0?r:r.filter(o=>o[3]===i)}hasTag(e,i){return this.tags.some(r=>r[0]===e&&(!i||r[3]===i))}tagValue(e,i){const r=this.getMatchingTags(e,i);if(r.length!==0)return r[0][1]}get alt(){return this.tagValue("alt")}set alt(e){this.removeTag("alt"),e&&this.tags.push(["alt",e])}get dTag(){return this.tagValue("d")}set dTag(e){this.removeTag("d"),e&&this.tags.push(["d",e])}removeTag(e,i){const r=Array.isArray(e)?e:[e];this.tags=this.tags.filter(o=>{const c=r.includes(o[0]),h=i?o[3]===i:!0;return!(c&&h)})}replaceTag(e){this.removeTag(e[0]),this.tags.push(e)}async sign(e,i){e?this.author=await e.user():(this.ndk?.assertSigner(),e=this.ndk?.signer);const r=await this.toNostrEvent(void 0,i);return this.sig=await e.sign(r),this.sig}async publishReplaceable(e,i,r){return this.id="",this.created_at=Math.floor(Date.now()/1e3),this.sig="",this.publish(e,i,r)}async publish(e,i,r,o){if(r||(r=1),this.sig||await this.sign(void 0,o),!this.ndk)throw new Error("NDKEvent must be associated with an NDK instance to publish");if((!e||e.size===0)&&(e=this.ndk.devWriteRelaySet||await Tu(this.ndk,this,r)),this.kind===5&&this.ndk.cacheAdapter?.deleteEventIds){const d=this.getMatchingTags("e").map(y=>y[1]);this.ndk.cacheAdapter.deleteEventIds(d)}const c=this.rawEvent();if(this.ndk.cacheAdapter?.addUnpublishedEvent&&rc(this))try{this.ndk.cacheAdapter.addUnpublishedEvent(this,e.relayUrls)}catch(d){console.error("Error adding unpublished event to cache",d)}this.kind===5&&this.ndk.cacheAdapter?.deleteEventIds&&this.ndk.cacheAdapter.deleteEventIds(this.getMatchingTags("e").map(d=>d[1])),this.ndk.subManager.dispatchEvent(c,void 0,!0);const h=await e.publish(this,i,r);return h.forEach(d=>this.ndk?.subManager.seenEvent(this.id,d)),h}async generateTags(e){let i=[];const r=await Iu(this.content,this.tags,e,this),o=r.content;if(i=r.tags,this.kind&&this.isParamReplaceable()&&!this.getMatchingTags("d")[0]){const h=this.tagValue("title");let y=[...Array(h?6:16)].map(()=>Math.random().toString(36)[2]).join("");h&&h.length>0&&(y=`${h.replace(/[^a-z0-9]+/gi,"-").replace(/^-|-$/g,"")}-${y}`),i.push(["d",y])}if(this.shouldAddClientTag){const c=["client",this.ndk?.clientName??""];this.ndk?.clientNip89&&c.push(this.ndk?.clientNip89),i.push(c)}else this.shouldStripClientTag&&(i=i.filter(c=>c[0]!=="client"));return{content:o||"",tags:i}}get shouldAddClientTag(){return!(!this.ndk?.clientName&&!this.ndk?.clientNip89||ws.has(this.kind)||this.isEphemeral()||this.isReplaceable()&&!this.isParamReplaceable()||this.isDvm()||this.hasTag("client"))}get shouldStripClientTag(){return ws.has(this.kind)}muted(){const e=this.ndk?.mutedIds.get(this.pubkey);if(e&&e==="p")return"author";const i=this.tagReference(),r=this.ndk?.mutedIds.get(i[1]);return r&&r===i[0]?"event":null}replaceableDTag(){if(this.kind&&this.kind>=3e4&&this.kind<=4e4){const e=this.getMatchingTags("d")[0];return e?e[1]:""}throw new Error("Event is not a parameterized replaceable event")}deduplicationKey(){return this.kind===0||this.kind===3||this.kind&&this.kind>=1e4&&this.kind<2e4?`${this.kind}:${this.pubkey}`:this.tagId()}tagId(){return this.isParamReplaceable()?this.tagAddress():this.id}tagAddress(){if(this.isParamReplaceable()){const e=this.dTag??"";return`${this.kind}:${this.pubkey}:${e}`}if(this.isReplaceable())return`${this.kind}:${this.pubkey}:`;throw new Error("Event is not a replaceable event")}tagType(){return this.isParamReplaceable()?"a":"e"}tagReference(e){let i;return this.isParamReplaceable()?i=["a",this.tagAddress()]:i=["e",this.tagId()],this.relay?i.push(this.relay.url):i.push(""),i.push(e??""),this.isParamReplaceable()||i.push(this.pubkey),i}referenceTags(e,i,r,o){let c=[];return this.isParamReplaceable()?c=[[r??"a",this.tagAddress()],[r??"e",this.id]]:c=[[r??"e",this.id]],c=c.map(h=>(h[0]==="e"||e?h.push(this.relay?.url??""):this.relay?.url&&h.push(this.relay?.url),h)),c.forEach(h=>{h[0]==="e"?(h.push(e??""),h.push(this.pubkey)):e&&h.push(e)}),c=[...c,...this.getMatchingTags("h")],!i&&o?.pTags!==!1&&c.push(...this.author.referenceTags()),c}filter(){return this.isParamReplaceable()?{"#a":[this.tagId()]}:{"#e":[this.tagId()]}}nip22Filter(){return this.isParamReplaceable()?{"#A":[this.tagId()]}:{"#E":[this.tagId()]}}async delete(e,i=!0){if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner();const r=new Nt(this.ndk,{kind:5,content:e||""});return r.tag(this,void 0,!0),r.tags.push(["k",this.kind?.toString()]),i&&(this.emit("deleted"),await r.publish()),r}set isProtected(e){this.removeTag("-"),e&&this.tags.push(["-"])}get isProtected(){return this.hasTag("-")}fetchTaggedEvent=Mu.bind(this);fetchRootEvent=ju.bind(this);fetchReplyEvent=Fu.bind(this);repost=Wu.bind(this);async react(e,i=!0){if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner();const r=new Nt(this.ndk,{kind:7,content:e});return r.tag(this),this.kind!==1&&r.tags.push(["k",`${this.kind}`]),i&&await r.publish(),r}get isValid(){return this.validate()}get inspect(){return JSON.stringify(this.rawEvent(),null,4)}dump(){console.debug(JSON.stringify(this.rawEvent(),null,4)),console.debug("Event on relays:",this.onRelays.map(e=>e.url).join(", "))}reply(e,i){const r=new Nt(this.ndk);if(this.kind===1&&!e)r.kind=1,this.hasTag("e")?r.tags=[...r.tags,...this.getMatchingTags("e"),...this.getMatchingTags("p"),...this.getMatchingTags("a"),...this.referenceTags("reply",!1,void 0,i)]:r.tag(this,"root",!1,void 0,i);else{r.kind=1111;const o=["A","E","I","P"],c=this.tags.filter(h=>o.includes(h[0]));if(c.length>0){const h=this.tagValue("K");r.tags.push(...c),h&&r.tags.push(["K",h]);let d;if(this.isParamReplaceable()){d=["a",this.tagAddress()];const y=this.relay?.url??"";y&&d.push(y)}else{d=["e",this.tagId()];const y=this.relay?.url??"";d.push(y),d.push(this.pubkey)}r.tags.push(d)}else{let h,d;const y=this.relay?.url??"";this.isParamReplaceable()?(h=["a",this.tagAddress(),y],d=["A",this.tagAddress(),y]):(h=["e",this.tagId(),y,this.pubkey],d=["E",this.tagId(),y,this.pubkey]),r.tags.push(h),r.tags.push(d),r.tags.push(["K",this.kind?.toString()]),i?.pTags!==!1&&i?.pTagOnATags!==!1&&r.tags.push(["P",this.pubkey])}r.tags.push(["k",this.kind?.toString()]),i?.pTags!==!1&&(r.tags.push(...this.getMatchingTags("p")),r.tags.push(["p",this.pubkey]))}return r}},nc=new Set([24133,13194,23194,23195]);function rc(t){return!nc.has(t.kind)}var ic=class extends vn.EventEmitter{_relays=new Map;status="idle";autoConnectRelays=new Set;poolBlacklistRelayUrls=new Set;debug;temporaryRelayTimers=new Map;flappingRelays=new Set;backoffTimes=new Map;ndk;disconnectionTimes=new Map;systemEventDetector;get blacklistRelayUrls(){const t=new Set(this.ndk.blacklistRelayUrls);return this.poolBlacklistRelayUrls.forEach(e=>t.add(e)),t}constructor(t,e,i,{debug:r,name:o}={}){super(),this.debug=r??i.debug.extend("pool"),o&&(this._name=o),this.ndk=i,this.relayUrls=t,this.poolBlacklistRelayUrls=new Set(e),this.ndk.pools.push(this)}get relays(){return this._relays}set relayUrls(t){this._relays.clear();for(const e of t){const i=new ar(e,void 0,this.ndk);i.connectivity.netDebug=this.ndk.netDebug,this.addRelay(i)}}_name="unnamed";get name(){return this._name}set name(t){this._name=t,this.debug=this.debug.extend(t)}useTemporaryRelay(t,e=3e4,i){const r=this.relays.has(t.url);r||(this.addRelay(t),this.debug("Adding temporary relay %s for filters %o",t.url,i));const o=this.temporaryRelayTimers.get(t.url);if(o&&clearTimeout(o),!r||o){const c=setTimeout(()=>{this.ndk.explicitRelayUrls?.includes(t.url)||this.removeRelay(t.url)},e);this.temporaryRelayTimers.set(t.url,c)}}addRelay(t,e=!0){const i=this.relays.has(t.url),r=this.blacklistRelayUrls?.has(t.url),o=t.url.includes("/npub1");let c=!0;const h=t.url;if(i)return;if(r){this.debug(`Refusing to add relay ${h}: blacklisted`);return}if(o){this.debug(`Refusing to add relay ${h}: is a filter relay`);return}if(this.ndk.cacheAdapter?.getRelayStatus){const K=this.ndk.cacheAdapter.getRelayStatus(h);if(K?.dontConnectBefore){if(K.dontConnectBefore>Date.now()){const Y=K.dontConnectBefore-Date.now();this.debug(`Refusing to add relay ${h}: delayed connect for ${Y}ms`),setTimeout(()=>{this.addRelay(t,e)},Y);return}c=!1}}const d=K=>this.emit("notice",t,K),y=()=>this.handleRelayConnect(h),S=()=>this.handleRelayReady(t),I=()=>{this.recordDisconnection(t),this.emit("relay:disconnect",t)},C=()=>this.handleFlapping(t),T=K=>this.emit("relay:auth",t,K),O=()=>this.emit("relay:authed",t);t.off("notice",d),t.off("connect",y),t.off("ready",S),t.off("disconnect",I),t.off("flapping",C),t.off("auth",T),t.off("authed",O),t.on("notice",d),t.on("connect",y),t.on("ready",S),t.on("disconnect",I),t.on("flapping",C),t.on("auth",T),t.on("authed",O),t.on("delayed-connect",K=>{this.ndk.cacheAdapter?.updateRelayStatus&&this.ndk.cacheAdapter.updateRelayStatus(t.url,{dontConnectBefore:Date.now()+K})}),this._relays.set(h,t),e&&this.autoConnectRelays.add(h),e&&this.status==="active"&&(this.emit("relay:connecting",t),t.connect(void 0,c).catch(K=>{this.debug(`Failed to connect to relay ${h}`,K)}))}removeRelay(t){const e=this.relays.get(t);if(e)return e.disconnect(),this.relays.delete(t),this.autoConnectRelays.delete(t),this.emit("relay:disconnect",e),!0;const i=this.temporaryRelayTimers.get(t);return i&&(clearTimeout(i),this.temporaryRelayTimers.delete(t)),!1}isRelayConnected(t){const e=Qt(t),i=this.relays.get(e);return i?i.status===5:!1}getRelay(t,e=!0,i=!1,r){let o=this.relays.get(Qt(t));return o||(o=new ar(t,void 0,this.ndk),o.connectivity.netDebug=this.ndk.netDebug,i?this.useTemporaryRelay(o,3e4,r):this.addRelay(o,e)),o}handleRelayConnect(t){const e=this.relays.get(t);if(!e){console.error("NDK BUG: relay not found in pool",{relayUrl:t});return}this.emit("relay:connect",e),this.stats().connected===this.relays.size&&this.emit("connect")}handleRelayReady(t){this.emit("relay:ready",t)}async connect(t){this.status="active",this.debug(`Connecting to ${this.relays.size} relays${t?`, timeout ${t}ms`:""}...`);const e=Array.from(this.autoConnectRelays.keys()).map(c=>this.relays.get(c)).filter(c=>!!c);for(const c of e)c.status!==5&&c.status!==4&&(this.emit("relay:connecting",c),c.connect().catch(h=>{this.debug(`Failed to connect to relay ${c.url}: ${h??"No reason specified"}`)}));const i=()=>e.every(c=>c.status===5),r=new Promise(c=>{if(i()){c();return}const h=[];for(const d of e){const y=()=>{if(i()){for(let S=0;S<e.length;S++)e[S].off("connect",h[S]);c()}};h.push(y),d.on("connect",y)}}),o=typeof t=="number"?new Promise(c=>setTimeout(c,t)):new Promise(()=>{});await Promise.race([r,o])}checkOnFlappingRelays(){const t=this.flappingRelays.size,e=this.relays.size;if(t/e>=.8)for(const i of this.flappingRelays)this.backoffTimes.set(i,0)}recordDisconnection(t){const e=Date.now();this.disconnectionTimes.set(t.url,e);for(const[i,r]of this.disconnectionTimes.entries())e-r>1e4&&this.disconnectionTimes.delete(i);this.checkForSystemWideDisconnection()}checkForSystemWideDisconnection(){const t=Date.now(),e=[];for(const i of this.disconnectionTimes.values())t-i<5e3&&e.push(i);e.length>this.relays.size/2&&this.relays.size>1&&(this.debug(`System-wide disconnection detected: ${e.length}/${this.relays.size} relays disconnected`),this.handleSystemWideReconnection())}handleSystemWideReconnection(){this.debug("Initiating system-wide reconnection with reset backoff"),this.systemEventDetector&&clearTimeout(this.systemEventDetector),this.systemEventDetector=setTimeout(()=>{this.systemEventDetector=void 0},1e4);for(const t of this.relays.values())t.connectivity&&(t.connectivity.resetReconnectionState(),t.status!==5&&t.status!==4&&t.connect().catch(e=>{this.debug(`Failed to reconnect relay ${t.url} after system event: ${e}`)}));this.disconnectionTimes.clear()}handleFlapping(t){this.debug(`Relay ${t.url} is flapping`);let e=this.backoffTimes.get(t.url)||5e3;e=e*2,this.backoffTimes.set(t.url,e),this.debug(`Backoff time for ${t.url} is ${e}ms`),setTimeout(()=>{this.debug(`Attempting to reconnect to ${t.url}`),this.emit("relay:connecting",t),t.connect(),this.checkOnFlappingRelays()},e),t.disconnect(),this.emit("flapping",t)}size(){return this.relays.size}stats(){const t={total:0,connected:0,disconnected:0,connecting:0};for(const e of this.relays.values())t.total++,e.status===5?t.connected++:e.status===1?t.disconnected++:e.status===4&&t.connecting++;return t}connectedRelays(){return Array.from(this.relays.values()).filter(t=>t.status>=5)}permanentAndConnectedRelays(){return Array.from(this.relays.values()).filter(t=>t.status>=5&&!this.temporaryRelayTimers.has(t.url))}urls(){return Array.from(this.relays.keys())}},sc=class ho extends Ue{static kind=10019;static kinds=[10019];_p2pk;constructor(e,i){super(e,i),this.kind??=10019}static from(e){return new ho(e.ndk,e)}set relays(e){this.tags=this.tags.filter(i=>i[0]!=="relay");for(const i of e)this.tags.push(["relay",i])}get relays(){const e=[];for(const i of this.tags)i[0]==="relay"&&e.push(i[1]);return e}set mints(e){this.tags=this.tags.filter(i=>i[0]!=="mint");for(const i of e)this.tags.push(["mint",i])}get mints(){const e=[];for(const i of this.tags)i[0]==="mint"&&e.push(i[1]);return Array.from(new Set(e))}get p2pk(){return this._p2pk?this._p2pk:(this._p2pk=this.tagValue("pubkey")??this.pubkey,this._p2pk)}set p2pk(e){this._p2pk=e,this.removeTag("pubkey"),e&&this.tags.push(["pubkey",e])}get relaySet(){return _i.fromRelayUrls(this.relays,this.ndk)}};(class di extends Ue{debug;_proofs=[];static kind=9321;static kinds=[di.kind];constructor(e,i){super(e,i),this.kind??=9321,this.debug=e?.debug.extend("nutzap")??Ye("ndk:nutzap"),this.alt||(this.alt="This is a nutzap");try{const r=this.getMatchingTags("proof");r.length?this._proofs=r.map(o=>JSON.parse(o[1])):this._proofs=JSON.parse(this.content)}catch{return}}static from(e){const i=new di(e.ndk,e);if(!(!i._proofs||!i._proofs.length))return i}set comment(e){this.content=e??""}get comment(){const e=this.tagValue("comment");return e||this.content}set proofs(e){this._proofs=e,this.tags=this.tags.filter(i=>i[0]!=="proof");for(const i of e)this.tags.push(["proof",JSON.stringify(i)])}get proofs(){return this._proofs}get rawP2pk(){const e=this.proofs[0];try{const i=JSON.parse(e.secret);let r;if(typeof i=="string"?(r=JSON.parse(i),this.debug("stringified payload",e.secret)):typeof i=="object"&&(r=i),Array.isArray(r)&&r[0]==="P2PK"&&r.length>1&&typeof r[1]=="object"&&r[1]!==null||typeof r=="object"&&r!==null&&typeof r[1]?.data=="string")return r[1].data}catch(i){this.debug("error parsing p2pk pubkey",i,this.proofs[0])}}get p2pk(){const e=this.rawP2pk;if(e)return e.startsWith("02")?e.slice(2):e}get mint(){return this.tagValue("u")}set mint(e){this.replaceTag(["u",e])}get unit(){let e=this.tagValue("unit")??"sat";return e?.startsWith("msat")&&(e="sat"),e}set unit(e){if(this.removeTag("unit"),e?.startsWith("msat"))throw new Error("msat is not allowed, use sat denomination instead");e&&this.tag(["unit",e])}get amount(){return this.proofs.reduce((i,r)=>i+r.amount,0)}sender=this.author;set target(e){this.tags=this.tags.filter(i=>i[0]!=="p"),e instanceof Ue&&this.tags.push(e.tagReference())}set recipientPubkey(e){this.removeTag("p"),this.tag(["p",e])}get recipientPubkey(){return this.tagValue("p")}get recipient(){const e=this.recipientPubkey;return this.ndk?this.ndk.getUser({pubkey:e}):new qt({pubkey:e})}async toNostrEvent(){this.unit==="msat"&&(this.unit="sat"),this.removeTag("amount"),this.tags.push(["amount",this.amount.toString()]);const e=await super.toNostrEvent();return e.content=this.comment,e}get isValid(){let e=0,i=0,r=0;for(const o of this.tags)o[0]==="e"&&e++,o[0]==="p"&&i++,o[0]==="u"&&r++;return i===1&&r===1&&e<=1&&this.proofs.length>0}});var fo=new Map;function xi(t,e){fo.set(t,e)}var Qn=class pi{_user;_privateKey;_pubkey;constructor(e,i){if(typeof e=="string")if(e.startsWith("nsec1")){const{type:r,data:o}=We.decode(e);if(r==="nsec")this._privateKey=o;else throw new Error("Invalid private key provided.")}else if(e.length===64)this._privateKey=bn(e);else throw new Error("Invalid private key provided.");else this._privateKey=e;this._pubkey=Qo(this._privateKey),i&&(this._user=i.getUser({pubkey:this._pubkey})),this._user??=new qt({pubkey:this._pubkey})}get privateKey(){if(!this._privateKey)throw new Error("Not ready");return bt(this._privateKey)}get pubkey(){if(!this._pubkey)throw new Error("Not ready");return this._pubkey}get nsec(){if(!this._privateKey)throw new Error("Not ready");return We.nsecEncode(this._privateKey)}get npub(){if(!this._pubkey)throw new Error("Not ready");return We.npubEncode(this._pubkey)}static generate(){const e=Xo();return new pi(e)}async blockUntilReady(){return this._user}async user(){return this._user}get userSync(){return this._user}async sign(e){if(!this._privateKey)throw Error("Attempted to sign without a private key");return ea(e,this._privateKey).sig}async encryptionEnabled(e){const i=[];return(!e||e==="nip04")&&i.push("nip04"),(!e||e==="nip44")&&i.push("nip44"),i}async encrypt(e,i,r){if(!this._privateKey||!this.privateKey)throw Error("Attempted to encrypt without a private key");const o=e.pubkey;if(r==="nip44"){const c=Yn.v2.utils.getConversationKey(this._privateKey,o);return await Yn.v2.encrypt(i,c)}return await as.encrypt(this._privateKey,o,i)}async decrypt(e,i,r){if(!this._privateKey||!this.privateKey)throw Error("Attempted to decrypt without a private key");const o=e.pubkey;if(r==="nip44"){const c=Yn.v2.utils.getConversationKey(this._privateKey,o);return await Yn.v2.decrypt(i,c)}return await as.decrypt(this._privateKey,o,i)}toPayload(){if(!this._privateKey)throw new Error("Private key not available");const e={type:"private-key",payload:this.privateKey};return JSON.stringify(e)}static async fromPayload(e,i){const r=JSON.parse(e);if(r.type!=="private-key")throw new Error(`Invalid payload type: expected 'private-key', got ${r.type}`);if(!r.payload||typeof r.payload!="string")throw new Error("Invalid payload content for private-key signer");return new pi(r.payload,i)}};xi("private-key",Qn);async function oc(t,e,i=3){if(!this.ndk)throw new Error("NDK not set");const r=await this.ndk.fetchEvent({kinds:[i],authors:[this.pubkey]},t||{groupable:!1});if(r){const o=new Set;return r.tags.forEach(c=>{c[0]==="p"&&o.add(c[1])}),e&&this.ndk?.outboxTracker?.trackUsers(Array.from(o)),[...o].reduce((c,h)=>{const d=new qt({pubkey:h});return d.ndk=this.ndk,c.add(d),c},new Set)}return new Set}var ac=/^(?:([\w.+-]+)@)?([\w.-]+)$/;async function ks(t,e,i=fetch,r={}){return await t.queuesNip05.add({id:e,func:async()=>{if(t.cacheAdapter?.loadNip05){const y=await t.cacheAdapter.loadNip05(e);if(y!=="missing"){if(y){const S=new qt({pubkey:y.pubkey,relayUrls:y.relays,nip46Urls:y.nip46});return S.ndk=t,S}if(r.cache!=="no-cache")return null}}const o=e.match(ac);if(!o)return null;const[c,h="_",d]=o;try{const y=await i(`https://${d}/.well-known/nostr.json?name=${h}`,r),{names:S,relays:I,nip46:C}=uc(await y.json()),T=S[h.toLowerCase()];let O=null;return T&&(O={pubkey:T,relays:I?.[T],nip46:C?.[T]}),t?.cacheAdapter?.saveNip05&&t.cacheAdapter.saveNip05(e,O),O}catch(y){return t?.cacheAdapter?.saveNip05&&t?.cacheAdapter.saveNip05(e,null),console.error("Failed to fetch NIP05 for",e,y),null}}})}function uc(t){const e={names:{}};for(const[i,r]of Object.entries(t.names))typeof i=="string"&&typeof r=="string"&&(e.names[i.toLowerCase()]=r);if(t.relays){e.relays={};for(const[i,r]of Object.entries(t.relays))typeof i=="string"&&Array.isArray(r)&&(e.relays[i]=r.filter(o=>typeof o=="string"))}if(t.nip46){e.nip46={};for(const[i,r]of Object.entries(t.nip46))typeof i=="string"&&Array.isArray(r)&&(e.nip46[i]=r.filter(o=>typeof o=="string"))}return e}function po(t){const e={};let i;try{i=JSON.parse(t.content)}catch(r){throw new Error(`Failed to parse profile event: ${r}`)}e.profileEvent=JSON.stringify(t.rawEvent());for(const r of Object.keys(i))switch(r){case"name":e.name=i.name;break;case"display_name":e.displayName=i.display_name;break;case"image":case"picture":e.picture=i.picture||i.image,e.image=e.picture;break;case"banner":e.banner=i.banner;break;case"bio":e.bio=i.bio;break;case"nip05":e.nip05=i.nip05;break;case"lud06":e.lud06=i.lud06;break;case"lud16":e.lud16=i.lud16;break;case"about":e.about=i.about;break;case"website":e.website=i.website;break;default:e[r]=i[r];break}return e.created_at=t.created_at,e}function cc(t){const e={};for(const[i,r]of Object.entries(t))switch(i){case"username":case"name":e.name=r;break;case"displayName":e.display_name=r;break;case"image":case"picture":e.picture=r;break;case"bio":case"about":e.about=r;break;default:e[i]=r;break}return JSON.stringify(e)}var qt=class yo{ndk;profile;profileEvent;_npub;_pubkey;relayUrls=[];nip46Urls=[];constructor(e){if(e.npub&&(this._npub=e.npub),e.hexpubkey&&(this._pubkey=e.hexpubkey),e.pubkey&&(this._pubkey=e.pubkey),e.relayUrls&&(this.relayUrls=e.relayUrls),e.nip46Urls&&(this.nip46Urls=e.nip46Urls),e.nprofile)try{const i=We.decode(e.nprofile);i.type==="nprofile"&&(this._pubkey=i.data.pubkey,i.data.relays&&i.data.relays.length>0&&this.relayUrls.push(...i.data.relays))}catch(i){console.error("Failed to decode nprofile",i)}}get npub(){if(!this._npub){if(!this._pubkey)throw new Error("pubkey not set");this._npub=We.npubEncode(this.pubkey)}return this._npub}get nprofile(){const e=this.profileEvent?.onRelays?.map(i=>i.url);return We.nprofileEncode({pubkey:this.pubkey,relays:e})}set npub(e){this._npub=e}get pubkey(){if(!this._pubkey){if(!this._npub)throw new Error("npub not set");this._pubkey=We.decode(this.npub).data}return this._pubkey}set pubkey(e){this._pubkey=e}filter(){return{"#p":[this.pubkey]}}async getZapInfo(e){if(!this.ndk)throw new Error("No NDK instance found");const i=async h=>{if(!e)return h;let d;const y=new Promise((S,I)=>{d=setTimeout(()=>I(new Error("Timeout")),e)});try{const S=await Promise.race([h,y]);return d&&clearTimeout(d),S}catch(S){if(S instanceof Error&&S.message==="Timeout")try{return await h}catch{return}return}},[r,o]=await Promise.all([i(this.fetchProfile()),i(this.ndk.fetchEvent({kinds:[10019],authors:[this.pubkey]}))]),c=new Map;if(o){const h=sc.from(o);h.mints.length>0&&c.set("nip61",{mints:h.mints,relays:h.relays,p2pk:h.p2pk})}if(r){const{lud06:h,lud16:d}=r;c.set("nip57",{lud06:h,lud16:d})}return c}static async fromNip05(e,i,r=!1){if(!i)throw new Error("No NDK instance found");const o={};r&&(o.cache="no-cache");const c=await ks(i,e,i?.httpFetch,o);if(c){const h=new yo({pubkey:c.pubkey,relayUrls:c.relays,nip46Urls:c.nip46});return h.ndk=i,h}}async fetchProfile(e,i=!1){if(!this.ndk)throw new Error("NDK not set");let r=null;if(this.ndk.cacheAdapter&&(this.ndk.cacheAdapter.fetchProfile||this.ndk.cacheAdapter.fetchProfileSync)&&e?.cacheUsage!=="ONLY_RELAY"){let o=null;if(this.ndk.cacheAdapter.fetchProfileSync?o=this.ndk.cacheAdapter.fetchProfileSync(this.pubkey):this.ndk.cacheAdapter.fetchProfile&&(o=await this.ndk.cacheAdapter.fetchProfile(this.pubkey)),o)return this.profile=o,o}return e??={},e.cacheUsage??="ONLY_RELAY",e.closeOnEose??=!0,e.groupable??=!0,e.groupableDelay??=250,r||(r=await this.ndk.fetchEvent({kinds:[0],authors:[this.pubkey]},e)),r?(this.profile=po(r),i&&this.profile&&this.ndk.cacheAdapter&&this.ndk.cacheAdapter.saveProfile&&this.ndk.cacheAdapter.saveProfile(this.pubkey,this.profile),this.profile):null}follows=oc.bind(this);async followSet(e,i,r=3){const o=await this.follows(e,i,r);return new Set(Array.from(o).map(c=>c.pubkey))}tagReference(){return["p",this.pubkey]}referenceTags(e){const i=[["p",this.pubkey]];return e&&i[0].push("",e),i}async publish(){if(!this.ndk)throw new Error("No NDK instance found");if(!this.profile)throw new Error("No profile available");this.ndk.assertSigner(),await new Ue(this.ndk,{kind:0,content:cc(this.profile)}).publish()}async follow(e,i,r=3){if(!this.ndk)throw new Error("No NDK instance found");if(this.ndk.assertSigner(),i||(i=await this.follows(void 0,void 0,r)),i.has(e))return!1;i.add(e);const o=new Ue(this.ndk,{kind:r});for(const c of i)o.tag(c);return await o.publish(),!0}async unfollow(e,i,r=3){if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner(),i||(i=await this.follows(void 0,void 0,r));const o=new Set;let c=!1;for(const d of i)d.pubkey!==e.pubkey?o.add(d):c=!0;if(!c)return!1;const h=new Ue(this.ndk,{kind:r});for(const d of o)h.tag(d);return await h.publish()}async validateNip05(e){if(!this.ndk)throw new Error("No NDK instance found");const i=await ks(this.ndk,e);return i===null?null:i.pubkey===this.pubkey}};function lc(t,e){return e??=Ye("ndk:relay:auth-policies:disconnect"),async i=>{e?.(`Relay ${i.url} requested authentication, disconnecting`),t.removeRelay(i.url)}}async function Es(t,e,i,r,o,c){try{await t.sign(i),o(t)}catch(h){r?.(`Failed to publish auth event to relay ${e.url}`,h),c(t)}}function hc({ndk:t,signer:e,debug:i}={}){return i??=Ye("ndk:auth-policies:signIn"),async(r,o)=>{i?.(`Relay ${r.url} requested authentication, signing in`);const c=new Ue(t);return c.kind=22242,c.tags=[["relay",r.url],["challenge",o]],e??=t?.signer,new Promise(async(h,d)=>{e?await Es(c,r,e,i,h,d):t?.once("signer:ready",async y=>{await Es(c,r,y,i,h,d)})})}}var fc={disconnect:lc,signIn:hc},dc=class go{_userPromise;encryptionQueue=[];encryptionProcessing=!1;debug;waitTimeout;_pubkey;ndk;_user;constructor(e=1e3,i){this.debug=Ye("ndk:nip07"),this.waitTimeout=e,this.ndk=i}get pubkey(){if(!this._pubkey)throw new Error("Not ready");return this._pubkey}async blockUntilReady(){await this.waitForExtension();const e=await window.nostr?.getPublicKey();if(!e)throw new Error("User rejected access");this._pubkey=e;let i;return this.ndk?i=this.ndk.getUser({pubkey:e}):i=new qt({pubkey:e}),this._user=i,i}async user(){return this._userPromise||(this._userPromise=this.blockUntilReady()),this._userPromise}get userSync(){if(!this._user)throw new Error("User not ready");return this._user}async sign(e){await this.waitForExtension();const i=await window.nostr?.signEvent(e);if(!i)throw new Error("Failed to sign event");return i.sig}async relays(e){await this.waitForExtension();const i=await window.nostr?.getRelays?.()||{},r=[];for(const o of Object.keys(i))i[o].read&&i[o].write&&r.push(o);return r.map(o=>new ar(o,e?.relayAuthDefaultPolicy,e))}async encryptionEnabled(e){const i=[];return(!e||e==="nip04")&&window.nostr?.nip04&&i.push("nip04"),(!e||e==="nip44")&&window.nostr?.nip44&&i.push("nip44"),i}async encrypt(e,i,r="nip04"){if(!await this.encryptionEnabled(r))throw new Error(`${r}encryption is not available from your browser extension`);await this.waitForExtension();const o=e.pubkey;return this.queueEncryption(r,"encrypt",o,i)}async decrypt(e,i,r="nip04"){if(!await this.encryptionEnabled(r))throw new Error(`${r}encryption is not available from your browser extension`);await this.waitForExtension();const o=e.pubkey;return this.queueEncryption(r,"decrypt",o,i)}async queueEncryption(e,i,r,o){return new Promise((c,h)=>{this.encryptionQueue.push({scheme:e,method:i,counterpartyHexpubkey:r,value:o,resolve:c,reject:h}),this.encryptionProcessing||this.processEncryptionQueue()})}async processEncryptionQueue(e,i=0){if(!e&&this.encryptionQueue.length===0){this.encryptionProcessing=!1;return}this.encryptionProcessing=!0;const r=e||this.encryptionQueue.shift();if(!r){this.encryptionProcessing=!1;return}const{scheme:o,method:c,counterpartyHexpubkey:h,value:d,resolve:y,reject:S}=r;this.debug("Processing encryption queue item",{method:c,counterpartyHexpubkey:h,value:d});try{const I=await window.nostr?.[o]?.[c](h,d);if(!I)throw new Error("Failed to encrypt/decrypt");y(I)}catch(I){const C=I instanceof Error?I.message:String(I);if(C.includes("call already executing")&&i<5){this.debug("Retrying encryption queue item",{method:c,counterpartyHexpubkey:h,value:d,retries:i}),setTimeout(()=>{this.processEncryptionQueue(r,i+1)},50*i);return}S(I instanceof Error?I:new Error(C))}this.processEncryptionQueue()}waitForExtension(){return new Promise((e,i)=>{if(window.nostr){e();return}let r;const o=setInterval(()=>{window.nostr&&(clearTimeout(r),clearInterval(o),e())},100);r=setTimeout(()=>{clearInterval(o),i(new Error("NIP-07 extension not available"))},this.waitTimeout)})}toPayload(){return JSON.stringify({type:"nip07",payload:""})}static async fromPayload(e,i){const r=JSON.parse(e);if(r.type!=="nip07")throw new Error(`Invalid payload type: expected 'nip07', got ${r.type}`);return new go(void 0,i)}};xi("nip07",dc);var _s=class extends vn.EventEmitter{ndk;signer;relaySet;debug;encryptionType="nip04";pool;constructor(t,e,i,r){if(super(),this.ndk=t,this.signer=e,r){this.pool=new ic(r,[],t,{debug:i.extend("rpc-pool"),name:"Nostr RPC"}),this.relaySet=new _i(new Set,t,this.pool);for(const o of r){const c=this.pool.getRelay(o,!1,!1);c.authPolicy=fc.signIn({ndk:t,signer:e,debug:i}),this.relaySet.addRelay(c),c.connect()}}this.debug=i.extend("rpc")}subscribe(t){const e=this.ndk.subscribe(t,{closeOnEose:!1,groupable:!1,cacheUsage:"ONLY_RELAY",pool:this.pool,relaySet:this.relaySet},!1);return e.on("event",async i=>{try{const r=await this.parseEvent(i);r.method?this.emit("request",r):(this.emit(`response-${r.id}`,r),this.emit("response",r))}catch(r){this.debug("error parsing event",r,i.rawEvent())}}),new Promise(i=>{e.on("eose",()=>{this.debug("eosed"),i(e)}),e.start()})}async parseEvent(t){this.encryptionType==="nip44"&&t.content.includes("?iv=")?this.encryptionType="nip04":this.encryptionType==="nip04"&&!t.content.includes("?iv=")&&(this.encryptionType="nip44");const e=this.ndk.getUser({pubkey:t.pubkey});e.ndk=this.ndk;let i;try{i=await this.signer.decrypt(e,t.content,this.encryptionType)}catch{const I=this.encryptionType==="nip04"?"nip44":"nip04";i=await this.signer.decrypt(e,t.content,I),this.encryptionType=I}const r=JSON.parse(i),{id:o,method:c,params:h,result:d,error:y}=r;return c?{id:o,pubkey:t.pubkey,method:c,params:h,event:t}:{id:o,result:d,error:y,event:t}}async sendResponse(t,e,i,r=24133,o){const c={id:t,result:i};o&&(c.error=o);const h=await this.signer.user(),d=this.ndk.getUser({pubkey:e}),y=new Ue(this.ndk,{kind:r,content:JSON.stringify(c),tags:[["p",e]],pubkey:h.pubkey});y.content=await this.signer.encrypt(d,y.content,this.encryptionType),await y.sign(this.signer),await y.publish(this.relaySet)}async sendRequest(t,e,i=[],r=24133,o){const c=Math.random().toString(36).substring(7),h=await this.signer.user(),d=this.ndk.getUser({pubkey:t}),y={id:c,method:e,params:i},S=new Promise(()=>{const C=T=>{T.result==="auth_url"?(this.once(`response-${c}`,C),this.emit("authUrl",T.error)):o&&o(T)};this.once(`response-${c}`,C)}),I=new Ue(this.ndk,{kind:r,content:JSON.stringify(y),tags:[["p",t]],pubkey:h.pubkey});return I.content=await this.signer.encrypt(d,I.content,this.encryptionType),await I.sign(this.signer),await I.publish(this.relaySet),S}};async function pc(t,e){let i;try{i=JSON.parse(t)}catch(o){console.error("Failed to parse signer payload string",t,o);return}if(!i||typeof i.type!="string"){console.error("Failed to parse signer payload string",t,new Error("Missing type field"));return}const r=fo.get(i.type);if(!r)throw new Error(`Unknown signer type: ${i.type}`);try{return await r.fromPayload(t,e)}catch(o){const c=o instanceof Error?o.message:String(o);throw new Error(`Failed to deserialize signer type ${i.type}: ${c}`)}}function yc(){return Math.random().toString(36).substring(2,15)}function gc(t,e,i,r){const o={name:r?.name?encodeURIComponent(r.name):"",url:r?.url?encodeURIComponent(r.url):"",image:r?.image?encodeURIComponent(r.image):"",perms:r?.perms?encodeURIComponent(r.perms):""};let c=`nostrconnect://${t}?image=${o.image}&url=${o.url}&name=${o.name}&perms=${o.perms}&secret=${encodeURIComponent(e)}`;return i&&(c+=`&relay=${encodeURIComponent(i)}`),c}var mc=class Xn extends vn.EventEmitter{ndk;_user;bunkerPubkey;userPubkey;get pubkey(){if(!this.userPubkey)throw new Error("Not ready");return this.userPubkey}secret;localSigner;nip05;rpc;debug;relayUrls;subscription;nostrConnectUri;nostrConnectSecret;constructor(e,i,r,o,c){super(),this.ndk=e,this.debug=e.debug.extend("nip46:signer"),this.relayUrls=o,r?typeof r=="string"?this.localSigner=new Qn(r):this.localSigner=r:this.localSigner=Qn.generate(),i===!1||(i?i.startsWith("bunker://")?this.bunkerFlowInit(i):this.nip05Init(i):this.nostrconnectFlowInit(c)),this.rpc=new _s(this.ndk,this.localSigner,this.debug,this.relayUrls)}static bunker(e,i,r){return new Xn(e,i,r)}static nostrconnect(e,i,r,o){return new Xn(e,void 0,r,[i],o)}nostrconnectFlowInit(e){this.nostrConnectSecret=yc();const i=this.localSigner.pubkey;this.nostrConnectUri=gc(i,this.nostrConnectSecret,this.relayUrls?.[0],e)}bunkerFlowInit(e){const i=new URL(e),r=i.hostname||i.pathname.replace(/^\/\//,""),o=i.searchParams.get("pubkey"),c=i.searchParams.getAll("relay"),h=i.searchParams.get("secret");this.bunkerPubkey=r,this.userPubkey=o,this.relayUrls=c,this.secret=h}nip05Init(e){this.nip05=e}async startListening(){if(this.subscription)return;const e=await this.localSigner.user();if(!e)throw new Error("Local signer not ready");this.subscription=await this.rpc.subscribe({kinds:[24133],"#p":[e.pubkey]})}async user(){return this._user?this._user:this.blockUntilReady()}get userSync(){if(!this._user)throw new Error("Remote user not ready synchronously");return this._user}async blockUntilReadyNostrConnect(){return new Promise((e,i)=>{const r=o=>{o.result===this.nostrConnectSecret&&(this._user=o.event.author,this.userPubkey=o.event.pubkey,this.bunkerPubkey=o.event.pubkey,this.rpc.off("response",r),e(this._user))};this.startListening(),this.rpc.on("response",r)})}async blockUntilReady(){if(!this.bunkerPubkey&&!this.nostrConnectSecret&&!this.nip05)throw new Error("Bunker pubkey not set");if(this.nostrConnectSecret)return this.blockUntilReadyNostrConnect();if(this.nip05&&!this.userPubkey){const e=await qt.fromNip05(this.nip05,this.ndk);e&&(this._user=e,this.userPubkey=e.pubkey,this.relayUrls=e.nip46Urls,this.rpc=new _s(this.ndk,this.localSigner,this.debug,this.relayUrls))}if(!this.bunkerPubkey&&this.userPubkey)this.bunkerPubkey=this.userPubkey;else if(!this.bunkerPubkey)throw new Error("Bunker pubkey not set");return await this.startListening(),this.rpc.on("authUrl",(...e)=>{this.emit("authUrl",...e)}),new Promise((e,i)=>{const r=[this.userPubkey??""];if(this.secret&&r.push(this.secret),!this.bunkerPubkey)throw new Error("Bunker pubkey not set");this.rpc.sendRequest(this.bunkerPubkey,"connect",r,24133,o=>{o.result==="ack"?this.getPublicKey().then(c=>{this.userPubkey=c,this._user=this.ndk.getUser({pubkey:c}),e(this._user)}):i(o.error)})})}stop(){this.subscription?.stop(),this.subscription=void 0}async getPublicKey(){return this.userPubkey?this.userPubkey:new Promise((e,i)=>{if(!this.bunkerPubkey)throw new Error("Bunker pubkey not set");this.rpc.sendRequest(this.bunkerPubkey,"get_public_key",[],24133,r=>{e(r.result)})})}async encryptionEnabled(e){return e?[e]:Promise.resolve(["nip04","nip44"])}async encrypt(e,i,r="nip04"){return this.encryption(e,i,r,"encrypt")}async decrypt(e,i,r="nip04"){return this.encryption(e,i,r,"decrypt")}async encryption(e,i,r,o){return new Promise((h,d)=>{if(!this.bunkerPubkey)throw new Error("Bunker pubkey not set");this.rpc.sendRequest(this.bunkerPubkey,`${r}_${o}`,[e.pubkey,i],24133,y=>{y.error?d(y.error):h(y.result)})})}async sign(e){return new Promise((r,o)=>{if(!this.bunkerPubkey)throw new Error("Bunker pubkey not set");this.rpc.sendRequest(this.bunkerPubkey,"sign_event",[JSON.stringify(e)],24133,c=>{if(c.error)o(c.error);else{const h=JSON.parse(c.result);r(h.sig)}})})}async createAccount(e,i,r){await this.startListening();const o=[];return e&&o.push(e),i&&o.push(i),r&&o.push(r),new Promise((c,h)=>{if(!this.bunkerPubkey)throw new Error("Bunker pubkey not set");this.rpc.sendRequest(this.bunkerPubkey,"create_account",o,24133,d=>{if(d.error)h(d.error);else{const y=d.result;c(y)}})})}toPayload(){if(!this.bunkerPubkey||!this.userPubkey)throw new Error("NIP-46 signer is not fully initialized for serialization");const e={type:"nip46",payload:{bunkerPubkey:this.bunkerPubkey,userPubkey:this.userPubkey,relayUrls:this.relayUrls,secret:this.secret,localSignerPayload:this.localSigner.toPayload(),nip05:this.nip05||null}};return JSON.stringify(e)}static async fromPayload(e,i){if(!i)throw new Error("NDK instance is required to deserialize NIP-46 signer");const r=JSON.parse(e);if(r.type!=="nip46")throw new Error(`Invalid payload type: expected 'nip46', got ${r.type}`);const o=r.payload;if(!o||typeof o!="object"||!o.localSignerPayload)throw new Error("Invalid payload content for nip46 signer");const c=await pc(o.localSignerPayload,i);if(!c)throw new Error("Failed to deserialize local signer for NIP-46");if(!(c instanceof Qn))throw new Error("Local signer must be an instance of NDKPrivateKeySigner");let h;return h=new Xn(i,!1,c,o.relayUrls),h.userPubkey=o.userPubkey,h.bunkerPubkey=o.bunkerPubkey,h.relayUrls=o.relayUrls,h.secret=o.secret,o.userPubkey&&(h._user=new qt({pubkey:o.userPubkey}),h._user&&(h._user.ndk=i)),h}};xi("nip46",mc);Ye("ndk:active-user");Ye("ndk:zapper:ln");Ye("ndk:zapper");var bc={};ou(bc,Zo);var mo={exports:{}};(function(t,e){(function(i,r){t.exports=r()})(os,function(){var i=function(n,s){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(a,u){a.__proto__=u}||function(a,u){for(var l in u)Object.prototype.hasOwnProperty.call(u,l)&&(a[l]=u[l])})(n,s)},r=function(){return(r=Object.assign||function(n){for(var s,a=1,u=arguments.length;a<u;a++)for(var l in s=arguments[a])Object.prototype.hasOwnProperty.call(s,l)&&(n[l]=s[l]);return n}).apply(this,arguments)};function o(n,s,a){for(var u,l=0,f=s.length;l<f;l++)!u&&l in s||((u=u||Array.prototype.slice.call(s,0,l))[l]=s[l]);return n.concat(u||Array.prototype.slice.call(s))}var c=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:os,h=Object.keys,d=Array.isArray;function y(n,s){return typeof s!="object"||h(s).forEach(function(a){n[a]=s[a]}),n}typeof Promise>"u"||c.Promise||(c.Promise=Promise);var S=Object.getPrototypeOf,I={}.hasOwnProperty;function C(n,s){return I.call(n,s)}function T(n,s){typeof s=="function"&&(s=s(S(n))),(typeof Reflect>"u"?h:Reflect.ownKeys)(s).forEach(function(a){K(n,a,s[a])})}var O=Object.defineProperty;function K(n,s,a,u){O(n,s,y(a&&C(a,"get")&&typeof a.get=="function"?{get:a.get,set:a.set,configurable:!0}:{value:a,configurable:!0,writable:!0},u))}function Y(n){return{from:function(s){return n.prototype=Object.create(s.prototype),K(n.prototype,"constructor",n),{extend:T.bind(null,n.prototype)}}}}var ne=Object.getOwnPropertyDescriptor,ie=[].slice;function $e(n,s,a){return ie.call(n,s,a)}function me(n,s){return s(n)}function Me(n){if(!n)throw new Error("Assertion Failed")}function He(n){c.setImmediate?setImmediate(n):setTimeout(n,0)}function Ie(n,s){if(typeof s=="string"&&C(n,s))return n[s];if(!s)return n;if(typeof s!="string"){for(var a=[],u=0,l=s.length;u<l;++u){var f=Ie(n,s[u]);a.push(f)}return a}var p=s.indexOf(".");if(p!==-1){var g=n[s.substr(0,p)];return g==null?void 0:Ie(g,s.substr(p+1))}}function Se(n,s,a){if(n&&s!==void 0&&!("isFrozen"in Object&&Object.isFrozen(n)))if(typeof s!="string"&&"length"in s){Me(typeof a!="string"&&"length"in a);for(var u=0,l=s.length;u<l;++u)Se(n,s[u],a[u])}else{var f,p,g=s.indexOf(".");g!==-1?(f=s.substr(0,g),(p=s.substr(g+1))===""?a===void 0?d(n)&&!isNaN(parseInt(f))?n.splice(f,1):delete n[f]:n[f]=a:Se(g=!(g=n[f])||!C(n,f)?n[f]={}:g,p,a)):a===void 0?d(n)&&!isNaN(parseInt(s))?n.splice(s,1):delete n[s]:n[s]=a}}function tt(n){var s,a={};for(s in n)C(n,s)&&(a[s]=n[s]);return a}var le=[].concat;function vt(n){return le.apply([],n)}var kt="BigUint64Array,BigInt64Array,Array,Boolean,String,Date,RegExp,Blob,File,FileList,FileSystemFileHandle,FileSystemDirectoryHandle,ArrayBuffer,DataView,Uint8ClampedArray,ImageBitmap,ImageData,Map,Set,CryptoKey".split(",").concat(vt([8,16,32,64].map(function(n){return["Int","Uint","Float"].map(function(s){return s+n+"Array"})}))).filter(function(n){return c[n]}),Ze=new Set(kt.map(function(n){return c[n]})),he=null;function U(n){return he=new WeakMap,n=function s(a){if(!a||typeof a!="object")return a;var u=he.get(a);if(u)return u;if(d(a)){u=[],he.set(a,u);for(var l=0,f=a.length;l<f;++l)u.push(s(a[l]))}else if(Ze.has(a.constructor))u=a;else{var p,g=S(a);for(p in u=g===Object.prototype?{}:Object.create(g),he.set(a,u),a)C(a,p)&&(u[p]=s(a[p]))}return u}(n),he=null,n}var q={}.toString;function D(n){return q.call(n).slice(8,-1)}var W=typeof Symbol<"u"?Symbol.iterator:"@@iterator",Q=typeof W=="symbol"?function(n){var s;return n!=null&&(s=n[W])&&s.apply(n)}:function(){return null};function ee(n,s){return s=n.indexOf(s),0<=s&&n.splice(s,1),0<=s}var X={};function G(n){var s,a,u,l;if(arguments.length===1){if(d(n))return n.slice();if(this===X&&typeof n=="string")return[n];if(l=Q(n)){for(a=[];!(u=l.next()).done;)a.push(u.value);return a}if(n==null)return[n];if(typeof(s=n.length)!="number")return[n];for(a=new Array(s);s--;)a[s]=n[s];return a}for(s=arguments.length,a=new Array(s);s--;)a[s]=arguments[s];return a}var te=typeof Symbol<"u"?function(n){return n[Symbol.toStringTag]==="AsyncFunction"}:function(){return!1},nn=["Unknown","Constraint","Data","TransactionInactive","ReadOnly","Version","NotFound","InvalidState","InvalidAccess","Abort","Timeout","QuotaExceeded","Syntax","DataClone"],ze=["Modify","Bulk","OpenFailed","VersionChange","Schema","Upgrade","InvalidTable","MissingAPI","NoSuchDatabase","InvalidArgument","SubTransaction","Unsupported","Internal","DatabaseClosed","PrematureCommit","ForeignAwait"].concat(nn),oe={VersionChanged:"Database version changed by other database connection",DatabaseClosed:"Database has been closed",Abort:"Transaction aborted",TransactionInactive:"Transaction has already completed or failed",MissingAPI:"IndexedDB API missing. Please visit https://tinyurl.com/y2uuvskb"};function be(n,s){this.name=n,this.message=s}function ge(n,s){return n+". Errors: "+Object.keys(s).map(function(a){return s[a].toString()}).filter(function(a,u,l){return l.indexOf(a)===u}).join(`
`)}function ce(n,s,a,u){this.failures=s,this.failedKeys=u,this.successCount=a,this.message=ge(n,s)}function ye(n,s){this.name="BulkError",this.failures=Object.keys(s).map(function(a){return s[a]}),this.failuresByPos=s,this.message=ge(n,this.failures)}Y(be).from(Error).extend({toString:function(){return this.name+": "+this.message}}),Y(ce).from(be),Y(ye).from(be);var ke=ze.reduce(function(n,s){return n[s]=s+"Error",n},{}),Oe=be,V=ze.reduce(function(n,s){var a=s+"Error";function u(l,f){this.name=a,l?typeof l=="string"?(this.message="".concat(l).concat(f?`
 `+f:""),this.inner=f||null):typeof l=="object"&&(this.message="".concat(l.name," ").concat(l.message),this.inner=l):(this.message=oe[s]||a,this.inner=null)}return Y(u).from(Oe),n[s]=u,n},{});V.Syntax=SyntaxError,V.Type=TypeError,V.Range=RangeError;var Re=nn.reduce(function(n,s){return n[s+"Error"]=V[s],n},{}),nt=ze.reduce(function(n,s){return["Syntax","Type","Range"].indexOf(s)===-1&&(n[s+"Error"]=V[s]),n},{});function pe(){}function ut(n){return n}function bo(n,s){return n==null||n===ut?s:function(a){return s(n(a))}}function wt(n,s){return function(){n.apply(this,arguments),s.apply(this,arguments)}}function vo(n,s){return n===pe?s:function(){var a=n.apply(this,arguments);a!==void 0&&(arguments[0]=a);var u=this.onsuccess,l=this.onerror;this.onsuccess=null,this.onerror=null;var f=s.apply(this,arguments);return u&&(this.onsuccess=this.onsuccess?wt(u,this.onsuccess):u),l&&(this.onerror=this.onerror?wt(l,this.onerror):l),f!==void 0?f:a}}function wo(n,s){return n===pe?s:function(){n.apply(this,arguments);var a=this.onsuccess,u=this.onerror;this.onsuccess=this.onerror=null,s.apply(this,arguments),a&&(this.onsuccess=this.onsuccess?wt(a,this.onsuccess):a),u&&(this.onerror=this.onerror?wt(u,this.onerror):u)}}function ko(n,s){return n===pe?s:function(a){var u=n.apply(this,arguments);y(a,u);var l=this.onsuccess,f=this.onerror;return this.onsuccess=null,this.onerror=null,a=s.apply(this,arguments),l&&(this.onsuccess=this.onsuccess?wt(l,this.onsuccess):l),f&&(this.onerror=this.onerror?wt(f,this.onerror):f),u===void 0?a===void 0?void 0:a:y(u,a)}}function Eo(n,s){return n===pe?s:function(){return s.apply(this,arguments)!==!1&&n.apply(this,arguments)}}function pr(n,s){return n===pe?s:function(){var a=n.apply(this,arguments);if(a&&typeof a.then=="function"){for(var u=this,l=arguments.length,f=new Array(l);l--;)f[l]=arguments[l];return a.then(function(){return s.apply(u,f)})}return s.apply(this,arguments)}}nt.ModifyError=ce,nt.DexieError=be,nt.BulkError=ye;var Ge=typeof location<"u"&&/^(http|https):\/\/(localhost|127\.0\.0\.1)/.test(location.href);function Si(n){Ge=n}var tn={},Ri=100,kt=typeof Promise>"u"?[]:function(){var n=Promise.resolve();if(typeof crypto>"u"||!crypto.subtle)return[n,S(n),n];var s=crypto.subtle.digest("SHA-512",new Uint8Array([0]));return[s,S(s),n]}(),nn=kt[0],ze=kt[1],kt=kt[2],ze=ze&&ze.then,Et=nn&&nn.constructor,yr=!!kt,rn=function(n,s){sn.push([n,s]),En&&(queueMicrotask(xo),En=!1)},gr=!0,En=!0,_t=[],_n=[],mr=ut,ct={id:"global",global:!0,ref:0,unhandleds:[],onunhandled:pe,pgp:!1,env:{},finalize:pe},J=ct,sn=[],xt=0,xn=[];function H(n){if(typeof this!="object")throw new TypeError("Promises must be constructed via new");this._listeners=[],this._lib=!1;var s=this._PSD=J;if(typeof n!="function"){if(n!==tn)throw new TypeError("Not a function");return this._state=arguments[1],this._value=arguments[2],void(this._state===!1&&vr(this,this._value))}this._state=null,this._value=null,++s.ref,function a(u,l){try{l(function(f){if(u._state===null){if(f===u)throw new TypeError("A promise cannot be resolved with itself.");var p=u._lib&&jt();f&&typeof f.then=="function"?a(u,function(g,b){f instanceof H?f._then(g,b):f.then(g,b)}):(u._state=!0,u._value=f,Pi(u)),p&&Ft()}},vr.bind(null,u))}catch(f){vr(u,f)}}(this,n)}var br={get:function(){var n=J,s=Pn;function a(u,l){var f=this,p=!n.global&&(n!==J||s!==Pn),g=p&&!ht(),b=new H(function(v,_){wr(f,new Ti(Ii(u,n,p,g),Ii(l,n,p,g),v,_,n))});return this._consoleTask&&(b._consoleTask=this._consoleTask),b}return a.prototype=tn,a},set:function(n){K(this,"then",n&&n.prototype===tn?br:{get:function(){return n},set:br.set})}};function Ti(n,s,a,u,l){this.onFulfilled=typeof n=="function"?n:null,this.onRejected=typeof s=="function"?s:null,this.resolve=a,this.reject=u,this.psd=l}function vr(n,s){var a,u;_n.push(s),n._state===null&&(a=n._lib&&jt(),s=mr(s),n._state=!1,n._value=s,u=n,_t.some(function(l){return l._value===u._value})||_t.push(u),Pi(n),a&&Ft())}function Pi(n){var s=n._listeners;n._listeners=[];for(var a=0,u=s.length;a<u;++a)wr(n,s[a]);var l=n._PSD;--l.ref||l.finalize(),xt===0&&(++xt,rn(function(){--xt==0&&kr()},[]))}function wr(n,s){if(n._state!==null){var a=n._state?s.onFulfilled:s.onRejected;if(a===null)return(n._state?s.resolve:s.reject)(n._value);++s.psd.ref,++xt,rn(_o,[a,n,s])}else n._listeners.push(s)}function _o(n,s,a){try{var u,l=s._value;!s._state&&_n.length&&(_n=[]),u=Ge&&s._consoleTask?s._consoleTask.run(function(){return n(l)}):n(l),s._state||_n.indexOf(l)!==-1||function(f){for(var p=_t.length;p;)if(_t[--p]._value===f._value)return _t.splice(p,1)}(s),a.resolve(u)}catch(f){a.reject(f)}finally{--xt==0&&kr(),--a.psd.ref||a.psd.finalize()}}function xo(){St(ct,function(){jt()&&Ft()})}function jt(){var n=gr;return En=gr=!1,n}function Ft(){var n,s,a;do for(;0<sn.length;)for(n=sn,sn=[],a=n.length,s=0;s<a;++s){var u=n[s];u[0].apply(null,u[1])}while(0<sn.length);En=gr=!0}function kr(){var n=_t;_t=[],n.forEach(function(u){u._PSD.onunhandled.call(null,u._value,u)});for(var s=xn.slice(0),a=s.length;a;)s[--a]()}function Sn(n){return new H(tn,!1,n)}function we(n,s){var a=J;return function(){var u=jt(),l=J;try{return ft(a,!0),n.apply(this,arguments)}catch(f){s&&s(f)}finally{ft(l,!1),u&&Ft()}}}T(H.prototype,{then:br,_then:function(n,s){wr(this,new Ti(null,null,n,s,J))},catch:function(n){if(arguments.length===1)return this.then(null,n);var s=n,a=arguments[1];return typeof s=="function"?this.then(null,function(u){return(u instanceof s?a:Sn)(u)}):this.then(null,function(u){return(u&&u.name===s?a:Sn)(u)})},finally:function(n){return this.then(function(s){return H.resolve(n()).then(function(){return s})},function(s){return H.resolve(n()).then(function(){return Sn(s)})})},timeout:function(n,s){var a=this;return n<1/0?new H(function(u,l){var f=setTimeout(function(){return l(new V.Timeout(s))},n);a.then(u,l).finally(clearTimeout.bind(null,f))}):this}}),typeof Symbol<"u"&&Symbol.toStringTag&&K(H.prototype,Symbol.toStringTag,"Dexie.Promise"),ct.env=Ai(),T(H,{all:function(){var n=G.apply(null,arguments).map(An);return new H(function(s,a){n.length===0&&s([]);var u=n.length;n.forEach(function(l,f){return H.resolve(l).then(function(p){n[f]=p,--u||s(n)},a)})})},resolve:function(n){return n instanceof H?n:n&&typeof n.then=="function"?new H(function(s,a){n.then(s,a)}):new H(tn,!0,n)},reject:Sn,race:function(){var n=G.apply(null,arguments).map(An);return new H(function(s,a){n.map(function(u){return H.resolve(u).then(s,a)})})},PSD:{get:function(){return J},set:function(n){return J=n}},totalEchoes:{get:function(){return Pn}},newPSD:lt,usePSD:St,scheduler:{get:function(){return rn},set:function(n){rn=n}},rejectionMapper:{get:function(){return mr},set:function(n){mr=n}},follow:function(n,s){return new H(function(a,u){return lt(function(l,f){var p=J;p.unhandleds=[],p.onunhandled=f,p.finalize=wt(function(){var g,b=this;g=function(){b.unhandleds.length===0?l():f(b.unhandleds[0])},xn.push(function v(){g(),xn.splice(xn.indexOf(v),1)}),++xt,rn(function(){--xt==0&&kr()},[])},p.finalize),n()},s,a,u)})}}),Et&&(Et.allSettled&&K(H,"allSettled",function(){var n=G.apply(null,arguments).map(An);return new H(function(s){n.length===0&&s([]);var a=n.length,u=new Array(a);n.forEach(function(l,f){return H.resolve(l).then(function(p){return u[f]={status:"fulfilled",value:p}},function(p){return u[f]={status:"rejected",reason:p}}).then(function(){return--a||s(u)})})})}),Et.any&&typeof AggregateError<"u"&&K(H,"any",function(){var n=G.apply(null,arguments).map(An);return new H(function(s,a){n.length===0&&a(new AggregateError([]));var u=n.length,l=new Array(u);n.forEach(function(f,p){return H.resolve(f).then(function(g){return s(g)},function(g){l[p]=g,--u||a(new AggregateError(l))})})})}),Et.withResolvers&&(H.withResolvers=Et.withResolvers));var Pe={awaits:0,echoes:0,id:0},So=0,Rn=[],Tn=0,Pn=0,Ro=0;function lt(n,s,a,u){var l=J,f=Object.create(l);return f.parent=l,f.ref=0,f.global=!1,f.id=++Ro,ct.env,f.env=yr?{Promise:H,PromiseProp:{value:H,configurable:!0,writable:!0},all:H.all,race:H.race,allSettled:H.allSettled,any:H.any,resolve:H.resolve,reject:H.reject}:{},s&&y(f,s),++l.ref,f.finalize=function(){--this.parent.ref||this.parent.finalize()},u=St(f,n,a,u),f.ref===0&&f.finalize(),u}function $t(){return Pe.id||(Pe.id=++So),++Pe.awaits,Pe.echoes+=Ri,Pe.id}function ht(){return!!Pe.awaits&&(--Pe.awaits==0&&(Pe.id=0),Pe.echoes=Pe.awaits*Ri,!0)}function An(n){return Pe.echoes&&n&&n.constructor===Et?($t(),n.then(function(s){return ht(),s},function(s){return ht(),Ee(s)})):n}function To(){var n=Rn[Rn.length-1];Rn.pop(),ft(n,!1)}function ft(n,s){var a,u=J;(s?!Pe.echoes||Tn++&&n===J:!Tn||--Tn&&n===J)||queueMicrotask(s?function(l){++Pn,Pe.echoes&&--Pe.echoes!=0||(Pe.echoes=Pe.awaits=Pe.id=0),Rn.push(J),ft(l,!0)}.bind(null,n):To),n!==J&&(J=n,u===ct&&(ct.env=Ai()),yr&&(a=ct.env.Promise,s=n.env,(u.global||n.global)&&(Object.defineProperty(c,"Promise",s.PromiseProp),a.all=s.all,a.race=s.race,a.resolve=s.resolve,a.reject=s.reject,s.allSettled&&(a.allSettled=s.allSettled),s.any&&(a.any=s.any))))}function Ai(){var n=c.Promise;return yr?{Promise:n,PromiseProp:Object.getOwnPropertyDescriptor(c,"Promise"),all:n.all,race:n.race,allSettled:n.allSettled,any:n.any,resolve:n.resolve,reject:n.reject}:{}}function St(n,s,a,u,l){var f=J;try{return ft(n,!0),s(a,u,l)}finally{ft(f,!1)}}function Ii(n,s,a,u){return typeof n!="function"?n:function(){var l=J;a&&$t(),ft(s,!0);try{return n.apply(this,arguments)}finally{ft(l,!1),u&&queueMicrotask(ht)}}}function Er(n){Promise===Et&&Pe.echoes===0?Tn===0?n():enqueueNativeMicroTask(n):setTimeout(n,0)}(""+ze).indexOf("[native code]")===-1&&($t=ht=pe);var Ee=H.reject,Rt="ï¿¿",rt="Invalid key provided. Keys must be of type string, number, Date or Array<string | number | Date>.",Oi="String expected.",zt=[],In="__dbnames",_r="readonly",xr="readwrite";function Tt(n,s){return n?s?function(){return n.apply(this,arguments)&&s.apply(this,arguments)}:n:s}var Ni={type:3,lower:-1/0,lowerOpen:!1,upper:[[]],upperOpen:!1};function On(n){return typeof n!="string"||/\./.test(n)?function(s){return s}:function(s){return s[n]===void 0&&n in s&&delete(s=U(s))[n],s}}function Ci(){throw V.Type("Entity instances must never be new:ed. Instances are generated by the framework bypassing the constructor.")}function fe(n,s){try{var a=Bi(n),u=Bi(s);if(a!==u)return a==="Array"?1:u==="Array"?-1:a==="binary"?1:u==="binary"?-1:a==="string"?1:u==="string"?-1:a==="Date"?1:u!=="Date"?NaN:-1;switch(a){case"number":case"Date":case"string":return s<n?1:n<s?-1:0;case"binary":return function(l,f){for(var p=l.length,g=f.length,b=p<g?p:g,v=0;v<b;++v)if(l[v]!==f[v])return l[v]<f[v]?-1:1;return p===g?0:p<g?-1:1}(Di(n),Di(s));case"Array":return function(l,f){for(var p=l.length,g=f.length,b=p<g?p:g,v=0;v<b;++v){var _=fe(l[v],f[v]);if(_!==0)return _}return p===g?0:p<g?-1:1}(n,s)}}catch{}return NaN}function Bi(n){var s=typeof n;return s!="object"?s:ArrayBuffer.isView(n)?"binary":(n=D(n),n==="ArrayBuffer"?"binary":n)}function Di(n){return n instanceof Uint8Array?n:ArrayBuffer.isView(n)?new Uint8Array(n.buffer,n.byteOffset,n.byteLength):new Uint8Array(n)}function Nn(n,s,a){var u=n.schema.yProps;return u?(s&&0<a.numFailures&&(s=s.filter(function(l,f){return!a.failures[f]})),Promise.all(u.map(function(l){return l=l.updatesTable,s?n.db.table(l).where("k").anyOf(s).delete():n.db.table(l).clear()})).then(function(){return a})):a}var on=(Ki.prototype.execute=function(n){var s=this["@@propmod"];if(s.add!==void 0){var a=s.add;if(d(a))return o(o([],d(n)?n:[],!0),a).sort();if(typeof a=="number")return(Number(n)||0)+a;if(typeof a=="bigint")try{return BigInt(n)+a}catch{return BigInt(0)+a}throw new TypeError("Invalid term ".concat(a))}if(s.remove!==void 0){var u=s.remove;if(d(u))return d(n)?n.filter(function(l){return!u.includes(l)}).sort():[];if(typeof u=="number")return Number(n)-u;if(typeof u=="bigint")try{return BigInt(n)-u}catch{return BigInt(0)-u}throw new TypeError("Invalid subtrahend ".concat(u))}return a=(a=s.replacePrefix)===null||a===void 0?void 0:a[0],a&&typeof n=="string"&&n.startsWith(a)?s.replacePrefix[1]+n.substring(a.length):n},Ki);function Ki(n){this["@@propmod"]=n}function Ui(n,s){for(var a=h(s),u=a.length,l=!1,f=0;f<u;++f){var p=a[f],g=s[p],b=Ie(n,p);g instanceof on?(Se(n,p,g.execute(b)),l=!0):b!==g&&(Se(n,p,g),l=!0)}return l}var qi=(ve.prototype._trans=function(n,s,a){var u=this._tx||J.trans,l=this.name,f=Ge&&typeof console<"u"&&console.createTask&&console.createTask("Dexie: ".concat(n==="readonly"?"read":"write"," ").concat(this.name));function p(v,_,m){if(!m.schema[l])throw new V.NotFound("Table "+l+" not part of transaction");return s(m.idbtrans,m)}var g=jt();try{var b=u&&u.db._novip===this.db._novip?u===J.trans?u._promise(n,p,a):lt(function(){return u._promise(n,p,a)},{trans:u,transless:J.transless||J}):function v(_,m,R,w){if(_.idbdb&&(_._state.openComplete||J.letThrough||_._vip)){var k=_._createTransaction(m,R,_._dbSchema);try{k.create(),_._state.PR1398_maxLoop=3}catch(E){return E.name===ke.InvalidState&&_.isOpen()&&0<--_._state.PR1398_maxLoop?(console.warn("Dexie: Need to reopen db"),_.close({disableAutoOpen:!1}),_.open().then(function(){return v(_,m,R,w)})):Ee(E)}return k._promise(m,function(E,x){return lt(function(){return J.trans=k,w(E,x,k)})}).then(function(E){if(m==="readwrite")try{k.idbtrans.commit()}catch{}return m==="readonly"?E:k._completion.then(function(){return E})})}if(_._state.openComplete)return Ee(new V.DatabaseClosed(_._state.dbOpenError));if(!_._state.isBeingOpened){if(!_._state.autoOpen)return Ee(new V.DatabaseClosed);_.open().catch(pe)}return _._state.dbReadyPromise.then(function(){return v(_,m,R,w)})}(this.db,n,[this.name],p);return f&&(b._consoleTask=f,b=b.catch(function(v){return console.trace(v),Ee(v)})),b}finally{g&&Ft()}},ve.prototype.get=function(n,s){var a=this;return n&&n.constructor===Object?this.where(n).first(s):n==null?Ee(new V.Type("Invalid argument to Table.get()")):this._trans("readonly",function(u){return a.core.get({trans:u,key:n}).then(function(l){return a.hook.reading.fire(l)})}).then(s)},ve.prototype.where=function(n){if(typeof n=="string")return new this.db.WhereClause(this,n);if(d(n))return new this.db.WhereClause(this,"[".concat(n.join("+"),"]"));var s=h(n);if(s.length===1)return this.where(s[0]).equals(n[s[0]]);var a=this.schema.indexes.concat(this.schema.primKey).filter(function(g){if(g.compound&&s.every(function(v){return 0<=g.keyPath.indexOf(v)})){for(var b=0;b<s.length;++b)if(s.indexOf(g.keyPath[b])===-1)return!1;return!0}return!1}).sort(function(g,b){return g.keyPath.length-b.keyPath.length})[0];if(a&&this.db._maxKey!==Rt){var f=a.keyPath.slice(0,s.length);return this.where(f).equals(f.map(function(b){return n[b]}))}!a&&Ge&&console.warn("The query ".concat(JSON.stringify(n)," on ").concat(this.name," would benefit from a ")+"compound index [".concat(s.join("+"),"]"));var u=this.schema.idxByName;function l(g,b){return fe(g,b)===0}var p=s.reduce(function(m,b){var v=m[0],_=m[1],m=u[b],R=n[b];return[v||m,v||!m?Tt(_,m&&m.multi?function(w){return w=Ie(w,b),d(w)&&w.some(function(k){return l(R,k)})}:function(w){return l(R,Ie(w,b))}):_]},[null,null]),f=p[0],p=p[1];return f?this.where(f.name).equals(n[f.keyPath]).filter(p):a?this.filter(p):this.where(s).equals("")},ve.prototype.filter=function(n){return this.toCollection().and(n)},ve.prototype.count=function(n){return this.toCollection().count(n)},ve.prototype.offset=function(n){return this.toCollection().offset(n)},ve.prototype.limit=function(n){return this.toCollection().limit(n)},ve.prototype.each=function(n){return this.toCollection().each(n)},ve.prototype.toArray=function(n){return this.toCollection().toArray(n)},ve.prototype.toCollection=function(){return new this.db.Collection(new this.db.WhereClause(this))},ve.prototype.orderBy=function(n){return new this.db.Collection(new this.db.WhereClause(this,d(n)?"[".concat(n.join("+"),"]"):n))},ve.prototype.reverse=function(){return this.toCollection().reverse()},ve.prototype.mapToClass=function(n){var s,a=this.db,u=this.name;function l(){return s!==null&&s.apply(this,arguments)||this}(this.schema.mappedClass=n).prototype instanceof Ci&&(function(b,v){if(typeof v!="function"&&v!==null)throw new TypeError("Class extends value "+String(v)+" is not a constructor or null");function _(){this.constructor=b}i(b,v),b.prototype=v===null?Object.create(v):(_.prototype=v.prototype,new _)}(l,s=n),Object.defineProperty(l.prototype,"db",{get:function(){return a},enumerable:!1,configurable:!0}),l.prototype.table=function(){return u},n=l);for(var f=new Set,p=n.prototype;p;p=S(p))Object.getOwnPropertyNames(p).forEach(function(b){return f.add(b)});function g(b){if(!b)return b;var v,_=Object.create(n.prototype);for(v in b)if(!f.has(v))try{_[v]=b[v]}catch{}return _}return this.schema.readHook&&this.hook.reading.unsubscribe(this.schema.readHook),this.schema.readHook=g,this.hook("reading",g),n},ve.prototype.defineClass=function(){return this.mapToClass(function(n){y(this,n)})},ve.prototype.add=function(n,s){var a=this,u=this.schema.primKey,l=u.auto,f=u.keyPath,p=n;return f&&l&&(p=On(f)(n)),this._trans("readwrite",function(g){return a.core.mutate({trans:g,type:"add",keys:s!=null?[s]:null,values:[p]})}).then(function(g){return g.numFailures?H.reject(g.failures[0]):g.lastResult}).then(function(g){if(f)try{Se(n,f,g)}catch{}return g})},ve.prototype.upsert=function(n,s){var a=this,u=this.schema.primKey.keyPath;return this._trans("readwrite",function(l){return a.core.get({trans:l,key:n}).then(function(f){var p=f??{};return Ui(p,s),u&&Se(p,u,n),a.core.mutate({trans:l,type:"put",values:[p],keys:[n],upsert:!0,updates:{keys:[n],changeSpecs:[s]}}).then(function(g){return g.numFailures?H.reject(g.failures[0]):!!f})})})},ve.prototype.update=function(n,s){return typeof n!="object"||d(n)?this.where(":id").equals(n).modify(s):(n=Ie(n,this.schema.primKey.keyPath),n===void 0?Ee(new V.InvalidArgument("Given object does not contain its primary key")):this.where(":id").equals(n).modify(s))},ve.prototype.put=function(n,s){var a=this,u=this.schema.primKey,l=u.auto,f=u.keyPath,p=n;return f&&l&&(p=On(f)(n)),this._trans("readwrite",function(g){return a.core.mutate({trans:g,type:"put",values:[p],keys:s!=null?[s]:null})}).then(function(g){return g.numFailures?H.reject(g.failures[0]):g.lastResult}).then(function(g){if(f)try{Se(n,f,g)}catch{}return g})},ve.prototype.delete=function(n){var s=this;return this._trans("readwrite",function(a){return s.core.mutate({trans:a,type:"delete",keys:[n]}).then(function(u){return Nn(s,[n],u)}).then(function(u){return u.numFailures?H.reject(u.failures[0]):void 0})})},ve.prototype.clear=function(){var n=this;return this._trans("readwrite",function(s){return n.core.mutate({trans:s,type:"deleteRange",range:Ni}).then(function(a){return Nn(n,null,a)})}).then(function(s){return s.numFailures?H.reject(s.failures[0]):void 0})},ve.prototype.bulkGet=function(n){var s=this;return this._trans("readonly",function(a){return s.core.getMany({keys:n,trans:a}).then(function(u){return u.map(function(l){return s.hook.reading.fire(l)})})})},ve.prototype.bulkAdd=function(n,s,a){var u=this,l=Array.isArray(s)?s:void 0,f=(a=a||(l?void 0:s))?a.allKeys:void 0;return this._trans("readwrite",function(p){var v=u.schema.primKey,g=v.auto,v=v.keyPath;if(v&&l)throw new V.InvalidArgument("bulkAdd(): keys argument invalid on tables with inbound keys");if(l&&l.length!==n.length)throw new V.InvalidArgument("Arguments objects and keys must have the same length");var b=n.length,v=v&&g?n.map(On(v)):n;return u.core.mutate({trans:p,type:"add",keys:l,values:v,wantResults:f}).then(function(k){var m=k.numFailures,R=k.results,w=k.lastResult,k=k.failures;if(m===0)return f?R:w;throw new ye("".concat(u.name,".bulkAdd(): ").concat(m," of ").concat(b," operations failed"),k)})})},ve.prototype.bulkPut=function(n,s,a){var u=this,l=Array.isArray(s)?s:void 0,f=(a=a||(l?void 0:s))?a.allKeys:void 0;return this._trans("readwrite",function(p){var v=u.schema.primKey,g=v.auto,v=v.keyPath;if(v&&l)throw new V.InvalidArgument("bulkPut(): keys argument invalid on tables with inbound keys");if(l&&l.length!==n.length)throw new V.InvalidArgument("Arguments objects and keys must have the same length");var b=n.length,v=v&&g?n.map(On(v)):n;return u.core.mutate({trans:p,type:"put",keys:l,values:v,wantResults:f}).then(function(k){var m=k.numFailures,R=k.results,w=k.lastResult,k=k.failures;if(m===0)return f?R:w;throw new ye("".concat(u.name,".bulkPut(): ").concat(m," of ").concat(b," operations failed"),k)})})},ve.prototype.bulkUpdate=function(n){var s=this,a=this.core,u=n.map(function(p){return p.key}),l=n.map(function(p){return p.changes}),f=[];return this._trans("readwrite",function(p){return a.getMany({trans:p,keys:u,cache:"clone"}).then(function(g){var b=[],v=[];n.forEach(function(m,R){var w=m.key,k=m.changes,E=g[R];if(E){for(var x=0,P=Object.keys(k);x<P.length;x++){var A=P[x],N=k[A];if(A===s.schema.primKey.keyPath){if(fe(N,w)!==0)throw new V.Constraint("Cannot update primary key in bulkUpdate()")}else Se(E,A,N)}f.push(R),b.push(w),v.push(E)}});var _=b.length;return a.mutate({trans:p,type:"put",keys:b,values:v,updates:{keys:u,changeSpecs:l}}).then(function(m){var R=m.numFailures,w=m.failures;if(R===0)return _;for(var k=0,E=Object.keys(w);k<E.length;k++){var x,P=E[k],A=f[Number(P)];A!=null&&(x=w[P],delete w[P],w[A]=x)}throw new ye("".concat(s.name,".bulkUpdate(): ").concat(R," of ").concat(_," operations failed"),w)})})})},ve.prototype.bulkDelete=function(n){var s=this,a=n.length;return this._trans("readwrite",function(u){return s.core.mutate({trans:u,type:"delete",keys:n}).then(function(l){return Nn(s,n,l)})}).then(function(p){var l=p.numFailures,f=p.lastResult,p=p.failures;if(l===0)return f;throw new ye("".concat(s.name,".bulkDelete(): ").concat(l," of ").concat(a," operations failed"),p)})},ve);function ve(){}function an(n){function s(p,g){if(g){for(var b=arguments.length,v=new Array(b-1);--b;)v[b-1]=arguments[b];return a[p].subscribe.apply(null,v),n}if(typeof p=="string")return a[p]}var a={};s.addEventType=f;for(var u=1,l=arguments.length;u<l;++u)f(arguments[u]);return s;function f(p,g,b){if(typeof p!="object"){var v;g=g||Eo;var _={subscribers:[],fire:b=b||pe,subscribe:function(m){_.subscribers.indexOf(m)===-1&&(_.subscribers.push(m),_.fire=g(_.fire,m))},unsubscribe:function(m){_.subscribers=_.subscribers.filter(function(R){return R!==m}),_.fire=_.subscribers.reduce(g,b)}};return a[p]=s[p]=_}h(v=p).forEach(function(m){var R=v[m];if(d(R))f(m,v[m][0],v[m][1]);else{if(R!=="asap")throw new V.InvalidArgument("Invalid event config");var w=f(m,ut,function(){for(var k=arguments.length,E=new Array(k);k--;)E[k]=arguments[k];w.subscribers.forEach(function(x){He(function(){x.apply(null,E)})})})}})}}function un(n,s){return Y(s).from({prototype:n}),s}function Lt(n,s){return!(n.filter||n.algorithm||n.or)&&(s?n.justLimit:!n.replayFilter)}function Sr(n,s){n.filter=Tt(n.filter,s)}function Rr(n,s,a){var u=n.replayFilter;n.replayFilter=u?function(){return Tt(u(),s())}:s,n.justLimit=a&&!u}function Cn(n,s){if(n.isPrimKey)return s.primaryKey;var a=s.getIndexByKeyPath(n.index);if(!a)throw new V.Schema("KeyPath "+n.index+" on object store "+s.name+" is not indexed");return a}function Mi(n,s,a){var u=Cn(n,s.schema);return s.openCursor({trans:a,values:!n.keysOnly,reverse:n.dir==="prev",unique:!!n.unique,query:{index:u,range:n.range}})}function Bn(n,s,a,u){var l=n.replayFilter?Tt(n.filter,n.replayFilter()):n.filter;if(n.or){var f={},p=function(g,b,v){var _,m;l&&!l(b,v,function(R){return b.stop(R)},function(R){return b.fail(R)})||((m=""+(_=b.primaryKey))=="[object ArrayBuffer]"&&(m=""+new Uint8Array(_)),C(f,m)||(f[m]=!0,s(g,b,v)))};return Promise.all([n.or._iterate(p,a),ji(Mi(n,u,a),n.algorithm,p,!n.keysOnly&&n.valueMapper)])}return ji(Mi(n,u,a),Tt(n.algorithm,l),s,!n.keysOnly&&n.valueMapper)}function ji(n,s,a,u){var l=we(u?function(f,p,g){return a(u(f),p,g)}:a);return n.then(function(f){if(f)return f.start(function(){var p=function(){return f.continue()};s&&!s(f,function(g){return p=g},function(g){f.stop(g),p=pe},function(g){f.fail(g),p=pe})||l(f.value,f,function(g){return p=g}),p()})})}var Po=(de.prototype._read=function(n,s){var a=this._ctx;return a.error?a.table._trans(null,Ee.bind(null,a.error)):a.table._trans("readonly",n).then(s)},de.prototype._write=function(n){var s=this._ctx;return s.error?s.table._trans(null,Ee.bind(null,s.error)):s.table._trans("readwrite",n,"locked")},de.prototype._addAlgorithm=function(n){var s=this._ctx;s.algorithm=Tt(s.algorithm,n)},de.prototype._iterate=function(n,s){return Bn(this._ctx,n,s,this._ctx.table.core)},de.prototype.clone=function(n){var s=Object.create(this.constructor.prototype),a=Object.create(this._ctx);return n&&y(a,n),s._ctx=a,s},de.prototype.raw=function(){return this._ctx.valueMapper=null,this},de.prototype.each=function(n){var s=this._ctx;return this._read(function(a){return Bn(s,n,a,s.table.core)})},de.prototype.count=function(n){var s=this;return this._read(function(a){var u=s._ctx,l=u.table.core;if(Lt(u,!0))return l.count({trans:a,query:{index:Cn(u,l.schema),range:u.range}}).then(function(p){return Math.min(p,u.limit)});var f=0;return Bn(u,function(){return++f,!1},a,l).then(function(){return f})}).then(n)},de.prototype.sortBy=function(n,s){var a=n.split(".").reverse(),u=a[0],l=a.length-1;function f(b,v){return v?f(b[a[v]],v-1):b[u]}var p=this._ctx.dir==="next"?1:-1;function g(b,v){return fe(f(b,l),f(v,l))*p}return this.toArray(function(b){return b.sort(g)}).then(s)},de.prototype.toArray=function(n){var s=this;return this._read(function(a){var u=s._ctx;if(u.dir==="next"&&Lt(u,!0)&&0<u.limit){var l=u.valueMapper,f=Cn(u,u.table.core.schema);return u.table.core.query({trans:a,limit:u.limit,values:!0,query:{index:f,range:u.range}}).then(function(g){return g=g.result,l?g.map(l):g})}var p=[];return Bn(u,function(g){return p.push(g)},a,u.table.core).then(function(){return p})},n)},de.prototype.offset=function(n){var s=this._ctx;return n<=0||(s.offset+=n,Lt(s)?Rr(s,function(){var a=n;return function(u,l){return a===0||(a===1?--a:l(function(){u.advance(a),a=0}),!1)}}):Rr(s,function(){var a=n;return function(){return--a<0}})),this},de.prototype.limit=function(n){return this._ctx.limit=Math.min(this._ctx.limit,n),Rr(this._ctx,function(){var s=n;return function(a,u,l){return--s<=0&&u(l),0<=s}},!0),this},de.prototype.until=function(n,s){return Sr(this._ctx,function(a,u,l){return!n(a.value)||(u(l),s)}),this},de.prototype.first=function(n){return this.limit(1).toArray(function(s){return s[0]}).then(n)},de.prototype.last=function(n){return this.reverse().first(n)},de.prototype.filter=function(n){var s;return Sr(this._ctx,function(a){return n(a.value)}),(s=this._ctx).isMatch=Tt(s.isMatch,n),this},de.prototype.and=function(n){return this.filter(n)},de.prototype.or=function(n){return new this.db.WhereClause(this._ctx.table,n,this)},de.prototype.reverse=function(){return this._ctx.dir=this._ctx.dir==="prev"?"next":"prev",this._ondirectionchange&&this._ondirectionchange(this._ctx.dir),this},de.prototype.desc=function(){return this.reverse()},de.prototype.eachKey=function(n){var s=this._ctx;return s.keysOnly=!s.isMatch,this.each(function(a,u){n(u.key,u)})},de.prototype.eachUniqueKey=function(n){return this._ctx.unique="unique",this.eachKey(n)},de.prototype.eachPrimaryKey=function(n){var s=this._ctx;return s.keysOnly=!s.isMatch,this.each(function(a,u){n(u.primaryKey,u)})},de.prototype.keys=function(n){var s=this._ctx;s.keysOnly=!s.isMatch;var a=[];return this.each(function(u,l){a.push(l.key)}).then(function(){return a}).then(n)},de.prototype.primaryKeys=function(n){var s=this._ctx;if(s.dir==="next"&&Lt(s,!0)&&0<s.limit)return this._read(function(u){var l=Cn(s,s.table.core.schema);return s.table.core.query({trans:u,values:!1,limit:s.limit,query:{index:l,range:s.range}})}).then(function(u){return u.result}).then(n);s.keysOnly=!s.isMatch;var a=[];return this.each(function(u,l){a.push(l.primaryKey)}).then(function(){return a}).then(n)},de.prototype.uniqueKeys=function(n){return this._ctx.unique="unique",this.keys(n)},de.prototype.firstKey=function(n){return this.limit(1).keys(function(s){return s[0]}).then(n)},de.prototype.lastKey=function(n){return this.reverse().firstKey(n)},de.prototype.distinct=function(){var n=this._ctx,n=n.index&&n.table.schema.idxByName[n.index];if(!n||!n.multi)return this;var s={};return Sr(this._ctx,function(l){var u=l.primaryKey.toString(),l=C(s,u);return s[u]=!0,!l}),this},de.prototype.modify=function(n){var s=this,a=this._ctx;return this._write(function(u){var l=typeof n=="function"?n:function(E){return Ui(E,n)},f=a.table.core,v=f.schema.primaryKey,p=v.outbound,g=v.extractKey,b=200,v=s.db._options.modifyChunkSize;v&&(b=typeof v=="object"?v[f.name]||v["*"]||200:v);function _(E,A){var P=A.failures,A=A.numFailures;R+=E-A;for(var N=0,B=h(P);N<B.length;N++){var j=B[N];m.push(P[j])}}var m=[],R=0,w=[],k=n===Fi;return s.clone().primaryKeys().then(function(E){function x(A){var N=Math.min(b,E.length-A),B=E.slice(A,A+N);return(k?Promise.resolve([]):f.getMany({trans:u,keys:B,cache:"immutable"})).then(function(j){var z=[],M=[],F=p?[]:null,L=k?B:[];if(!k)for(var $=0;$<N;++$){var Z=j[$],se={value:U(Z),primKey:E[A+$]};l.call(se,se.value,se)!==!1&&(se.value==null?L.push(E[A+$]):p||fe(g(Z),g(se.value))===0?(M.push(se.value),p&&F.push(E[A+$])):(L.push(E[A+$]),z.push(se.value)))}return Promise.resolve(0<z.length&&f.mutate({trans:u,type:"add",values:z}).then(function(ae){for(var ue in ae.failures)L.splice(parseInt(ue),1);_(z.length,ae)})).then(function(){return(0<M.length||P&&typeof n=="object")&&f.mutate({trans:u,type:"put",keys:F,values:M,criteria:P,changeSpec:typeof n!="function"&&n,isAdditionalChunk:0<A}).then(function(ae){return _(M.length,ae)})}).then(function(){return(0<L.length||P&&k)&&f.mutate({trans:u,type:"delete",keys:L,criteria:P,isAdditionalChunk:0<A}).then(function(ae){return Nn(a.table,L,ae)}).then(function(ae){return _(L.length,ae)})}).then(function(){return E.length>A+N&&x(A+b)})})}var P=Lt(a)&&a.limit===1/0&&(typeof n!="function"||k)&&{index:a.index,range:a.range};return x(0).then(function(){if(0<m.length)throw new ce("Error modifying one or more objects",m,R,w);return E.length})})})},de.prototype.delete=function(){var n=this._ctx,s=n.range;return!Lt(n)||n.table.schema.yProps||!n.isPrimKey&&s.type!==3?this.modify(Fi):this._write(function(a){var u=n.table.core.schema.primaryKey,l=s;return n.table.core.count({trans:a,query:{index:u,range:l}}).then(function(f){return n.table.core.mutate({trans:a,type:"deleteRange",range:l}).then(function(b){var g=b.failures,b=b.numFailures;if(b)throw new ce("Could not delete some values",Object.keys(g).map(function(v){return g[v]}),f-b);return f-b})})})},de);function de(){}var Fi=function(n,s){return s.value=null};function Ao(n,s){return n<s?-1:n===s?0:1}function Io(n,s){return s<n?-1:n===s?0:1}function je(n,s,a){return n=n instanceof zi?new n.Collection(n):n,n._ctx.error=new(a||TypeError)(s),n}function Vt(n){return new n.Collection(n,function(){return $i("")}).limit(0)}function Dn(n,s,a,u){var l,f,p,g,b,v,_,m=a.length;if(!a.every(function(k){return typeof k=="string"}))return je(n,Oi);function R(k){l=k==="next"?function(x){return x.toUpperCase()}:function(x){return x.toLowerCase()},f=k==="next"?function(x){return x.toLowerCase()}:function(x){return x.toUpperCase()},p=k==="next"?Ao:Io;var E=a.map(function(x){return{lower:f(x),upper:l(x)}}).sort(function(x,P){return p(x.lower,P.lower)});g=E.map(function(x){return x.upper}),b=E.map(function(x){return x.lower}),_=(v=k)==="next"?"":u}R("next"),n=new n.Collection(n,function(){return dt(g[0],b[m-1]+u)}),n._ondirectionchange=function(k){R(k)};var w=0;return n._addAlgorithm(function(k,E,x){var P=k.key;if(typeof P!="string")return!1;var A=f(P);if(s(A,b,w))return!0;for(var N=null,B=w;B<m;++B){var j=function(z,M,F,L,$,Z){for(var se=Math.min(z.length,L.length),ae=-1,ue=0;ue<se;++ue){var Fe=M[ue];if(Fe!==L[ue])return $(z[ue],F[ue])<0?z.substr(0,ue)+F[ue]+F.substr(ue+1):$(z[ue],L[ue])<0?z.substr(0,ue)+L[ue]+F.substr(ue+1):0<=ae?z.substr(0,ae)+M[ae]+F.substr(ae+1):null;$(z[ue],Fe)<0&&(ae=ue)}return se<L.length&&Z==="next"?z+F.substr(z.length):se<z.length&&Z==="prev"?z.substr(0,F.length):ae<0?null:z.substr(0,ae)+L[ae]+F.substr(ae+1)}(P,A,g[B],b[B],p,v);j===null&&N===null?w=B+1:(N===null||0<p(N,j))&&(N=j)}return E(N!==null?function(){k.continue(N+_)}:x),!1}),n}function dt(n,s,a,u){return{type:2,lower:n,upper:s,lowerOpen:a,upperOpen:u}}function $i(n){return{type:1,lower:n,upper:n}}var zi=(Object.defineProperty(Ae.prototype,"Collection",{get:function(){return this._ctx.table.db.Collection},enumerable:!1,configurable:!0}),Ae.prototype.between=function(n,s,a,u){a=a!==!1,u=u===!0;try{return 0<this._cmp(n,s)||this._cmp(n,s)===0&&(a||u)&&(!a||!u)?Vt(this):new this.Collection(this,function(){return dt(n,s,!a,!u)})}catch{return je(this,rt)}},Ae.prototype.equals=function(n){return n==null?je(this,rt):new this.Collection(this,function(){return $i(n)})},Ae.prototype.above=function(n){return n==null?je(this,rt):new this.Collection(this,function(){return dt(n,void 0,!0)})},Ae.prototype.aboveOrEqual=function(n){return n==null?je(this,rt):new this.Collection(this,function(){return dt(n,void 0,!1)})},Ae.prototype.below=function(n){return n==null?je(this,rt):new this.Collection(this,function(){return dt(void 0,n,!1,!0)})},Ae.prototype.belowOrEqual=function(n){return n==null?je(this,rt):new this.Collection(this,function(){return dt(void 0,n)})},Ae.prototype.startsWith=function(n){return typeof n!="string"?je(this,Oi):this.between(n,n+Rt,!0,!0)},Ae.prototype.startsWithIgnoreCase=function(n){return n===""?this.startsWith(n):Dn(this,function(s,a){return s.indexOf(a[0])===0},[n],Rt)},Ae.prototype.equalsIgnoreCase=function(n){return Dn(this,function(s,a){return s===a[0]},[n],"")},Ae.prototype.anyOfIgnoreCase=function(){var n=G.apply(X,arguments);return n.length===0?Vt(this):Dn(this,function(s,a){return a.indexOf(s)!==-1},n,"")},Ae.prototype.startsWithAnyOfIgnoreCase=function(){var n=G.apply(X,arguments);return n.length===0?Vt(this):Dn(this,function(s,a){return a.some(function(u){return s.indexOf(u)===0})},n,Rt)},Ae.prototype.anyOf=function(){var n=this,s=G.apply(X,arguments),a=this._cmp;try{s.sort(a)}catch{return je(this,rt)}if(s.length===0)return Vt(this);var u=new this.Collection(this,function(){return dt(s[0],s[s.length-1])});u._ondirectionchange=function(f){a=f==="next"?n._ascending:n._descending,s.sort(a)};var l=0;return u._addAlgorithm(function(f,p,g){for(var b=f.key;0<a(b,s[l]);)if(++l===s.length)return p(g),!1;return a(b,s[l])===0||(p(function(){f.continue(s[l])}),!1)}),u},Ae.prototype.notEqual=function(n){return this.inAnyRange([[-1/0,n],[n,this.db._maxKey]],{includeLowers:!1,includeUppers:!1})},Ae.prototype.noneOf=function(){var n=G.apply(X,arguments);if(n.length===0)return new this.Collection(this);try{n.sort(this._ascending)}catch{return je(this,rt)}var s=n.reduce(function(a,u){return a?a.concat([[a[a.length-1][1],u]]):[[-1/0,u]]},null);return s.push([n[n.length-1],this.db._maxKey]),this.inAnyRange(s,{includeLowers:!1,includeUppers:!1})},Ae.prototype.inAnyRange=function(P,s){var a=this,u=this._cmp,l=this._ascending,f=this._descending,p=this._min,g=this._max;if(P.length===0)return Vt(this);if(!P.every(function(A){return A[0]!==void 0&&A[1]!==void 0&&l(A[0],A[1])<=0}))return je(this,"First argument to inAnyRange() must be an Array of two-value Arrays [lower,upper] where upper must not be lower than lower",V.InvalidArgument);var b=!s||s.includeLowers!==!1,v=s&&s.includeUppers===!0,_,m=l;function R(A,N){return m(A[0],N[0])}try{(_=P.reduce(function(A,N){for(var B=0,j=A.length;B<j;++B){var z=A[B];if(u(N[0],z[1])<0&&0<u(N[1],z[0])){z[0]=p(z[0],N[0]),z[1]=g(z[1],N[1]);break}}return B===j&&A.push(N),A},[])).sort(R)}catch{return je(this,rt)}var w=0,k=v?function(A){return 0<l(A,_[w][1])}:function(A){return 0<=l(A,_[w][1])},E=b?function(A){return 0<f(A,_[w][0])}:function(A){return 0<=f(A,_[w][0])},x=k,P=new this.Collection(this,function(){return dt(_[0][0],_[_.length-1][1],!b,!v)});return P._ondirectionchange=function(A){m=A==="next"?(x=k,l):(x=E,f),_.sort(R)},P._addAlgorithm(function(A,N,B){for(var j,z=A.key;x(z);)if(++w===_.length)return N(B),!1;return!k(j=z)&&!E(j)||(a._cmp(z,_[w][1])===0||a._cmp(z,_[w][0])===0||N(function(){m===l?A.continue(_[w][0]):A.continue(_[w][1])}),!1)}),P},Ae.prototype.startsWithAnyOf=function(){var n=G.apply(X,arguments);return n.every(function(s){return typeof s=="string"})?n.length===0?Vt(this):this.inAnyRange(n.map(function(s){return[s,s+Rt]})):je(this,"startsWithAnyOf() only works with strings")},Ae);function Ae(){}function Je(n){return we(function(s){return cn(s),n(s.target.error),!1})}function cn(n){n.stopPropagation&&n.stopPropagation(),n.preventDefault&&n.preventDefault()}var ln="storagemutated",Tr="x-storagemutated-1",pt=an(null,ln),Oo=(Qe.prototype._lock=function(){return Me(!J.global),++this._reculock,this._reculock!==1||J.global||(J.lockOwnerFor=this),this},Qe.prototype._unlock=function(){if(Me(!J.global),--this._reculock==0)for(J.global||(J.lockOwnerFor=null);0<this._blockedFuncs.length&&!this._locked();){var n=this._blockedFuncs.shift();try{St(n[1],n[0])}catch{}}return this},Qe.prototype._locked=function(){return this._reculock&&J.lockOwnerFor!==this},Qe.prototype.create=function(n){var s=this;if(!this.mode)return this;var a=this.db.idbdb,u=this.db._state.dbOpenError;if(Me(!this.idbtrans),!n&&!a)switch(u&&u.name){case"DatabaseClosedError":throw new V.DatabaseClosed(u);case"MissingAPIError":throw new V.MissingAPI(u.message,u);default:throw new V.OpenFailed(u)}if(!this.active)throw new V.TransactionInactive;return Me(this._completion._state===null),(n=this.idbtrans=n||(this.db.core||a).transaction(this.storeNames,this.mode,{durability:this.chromeTransactionDurability})).onerror=we(function(l){cn(l),s._reject(n.error)}),n.onabort=we(function(l){cn(l),s.active&&s._reject(new V.Abort(n.error)),s.active=!1,s.on("abort").fire(l)}),n.oncomplete=we(function(){s.active=!1,s._resolve(),"mutatedParts"in n&&pt.storagemutated.fire(n.mutatedParts)}),this},Qe.prototype._promise=function(n,s,a){var u=this;if(n==="readwrite"&&this.mode!=="readwrite")return Ee(new V.ReadOnly("Transaction is readonly"));if(!this.active)return Ee(new V.TransactionInactive);if(this._locked())return new H(function(f,p){u._blockedFuncs.push([function(){u._promise(n,s,a).then(f,p)},J])});if(a)return lt(function(){var f=new H(function(p,g){u._lock();var b=s(p,g,u);b&&b.then&&b.then(p,g)});return f.finally(function(){return u._unlock()}),f._lib=!0,f});var l=new H(function(f,p){var g=s(f,p,u);g&&g.then&&g.then(f,p)});return l._lib=!0,l},Qe.prototype._root=function(){return this.parent?this.parent._root():this},Qe.prototype.waitFor=function(n){var s,a=this._root(),u=H.resolve(n);a._waitingFor?a._waitingFor=a._waitingFor.then(function(){return u}):(a._waitingFor=u,a._waitingQueue=[],s=a.idbtrans.objectStore(a.storeNames[0]),function f(){for(++a._spinCount;a._waitingQueue.length;)a._waitingQueue.shift()();a._waitingFor&&(s.get(-1/0).onsuccess=f)}());var l=a._waitingFor;return new H(function(f,p){u.then(function(g){return a._waitingQueue.push(we(f.bind(null,g)))},function(g){return a._waitingQueue.push(we(p.bind(null,g)))}).finally(function(){a._waitingFor===l&&(a._waitingFor=null)})})},Qe.prototype.abort=function(){this.active&&(this.active=!1,this.idbtrans&&this.idbtrans.abort(),this._reject(new V.Abort))},Qe.prototype.table=function(n){var s=this._memoizedTables||(this._memoizedTables={});if(C(s,n))return s[n];var a=this.schema[n];if(!a)throw new V.NotFound("Table "+n+" not part of transaction");return a=new this.db.Table(n,a,this),a.core=this.db.core.table(n),s[n]=a},Qe);function Qe(){}function Pr(n,s,a,u,l,f,p,g){return{name:n,keyPath:s,unique:a,multi:u,auto:l,compound:f,src:(a&&!p?"&":"")+(u?"*":"")+(l?"++":"")+Li(s),type:g}}function Li(n){return typeof n=="string"?n:n?"["+[].join.call(n,"+")+"]":""}function Ar(n,s,a){return{name:n,primKey:s,indexes:a,mappedClass:null,idxByName:(u=function(l){return[l.name,l]},a.reduce(function(l,f,p){return p=u(f,p),p&&(l[p[0]]=p[1]),l},{}))};var u}var hn=function(n){try{return n.only([[]]),hn=function(){return[[]]},[[]]}catch{return hn=function(){return Rt},Rt}};function Ir(n){return n==null?function(){}:typeof n=="string"?(s=n).split(".").length===1?function(a){return a[s]}:function(a){return Ie(a,s)}:function(a){return Ie(a,n)};var s}function Vi(n){return[].slice.call(n)}var No=0;function fn(n){return n==null?":id":typeof n=="string"?n:"[".concat(n.join("+"),"]")}function Co(n,s,b){function u(x){if(x.type===3)return null;if(x.type===4)throw new Error("Cannot convert never type to IDBKeyRange");var w=x.lower,k=x.upper,E=x.lowerOpen,x=x.upperOpen;return w===void 0?k===void 0?null:s.upperBound(k,!!x):k===void 0?s.lowerBound(w,!!E):s.bound(w,k,!!E,!!x)}function l(R){var w,k=R.name;return{name:k,schema:R,mutate:function(E){var x=E.trans,P=E.type,A=E.keys,N=E.values,B=E.range;return new Promise(function(j,z){j=we(j);var M=x.objectStore(k),F=M.keyPath==null,L=P==="put"||P==="add";if(!L&&P!=="delete"&&P!=="deleteRange")throw new Error("Invalid operation type: "+P);var $,Z=(A||N||{length:1}).length;if(A&&N&&A.length!==N.length)throw new Error("Given keys array must have same length as given values array.");if(Z===0)return j({numFailures:0,failures:{},results:[],lastResult:void 0});function se(De){++Fe,cn(De)}var ae=[],ue=[],Fe=0;if(P==="deleteRange"){if(B.type===4)return j({numFailures:Fe,failures:ue,results:[],lastResult:void 0});B.type===3?ae.push($=M.clear()):ae.push($=M.delete(u(B)))}else{var F=L?F?[N,A]:[N,null]:[A,null],re=F[0],Ce=F[1];if(L)for(var Be=0;Be<Z;++Be)ae.push($=Ce&&Ce[Be]!==void 0?M[P](re[Be],Ce[Be]):M[P](re[Be])),$.onerror=se;else for(Be=0;Be<Z;++Be)ae.push($=M[P](re[Be])),$.onerror=se}function Wn(De){De=De.target.result,ae.forEach(function(It,Yr){return It.error!=null&&(ue[Yr]=It.error)}),j({numFailures:Fe,failures:ue,results:P==="delete"?A:ae.map(function(It){return It.result}),lastResult:De})}$.onerror=function(De){se(De),Wn(De)},$.onsuccess=Wn})},getMany:function(E){var x=E.trans,P=E.keys;return new Promise(function(A,N){A=we(A);for(var B,j=x.objectStore(k),z=P.length,M=new Array(z),F=0,L=0,$=function(ae){ae=ae.target,M[ae._pos]=ae.result,++L===F&&A(M)},Z=Je(N),se=0;se<z;++se)P[se]!=null&&((B=j.get(P[se]))._pos=se,B.onsuccess=$,B.onerror=Z,++F);F===0&&A(M)})},get:function(E){var x=E.trans,P=E.key;return new Promise(function(A,N){A=we(A);var B=x.objectStore(k).get(P);B.onsuccess=function(j){return A(j.target.result)},B.onerror=Je(N)})},query:(w=v,function(E){return new Promise(function(x,P){x=we(x);var A,N,B,F=E.trans,j=E.values,z=E.limit,$=E.query,M=z===1/0?void 0:z,L=$.index,$=$.range,F=F.objectStore(k),L=L.isPrimaryKey?F:F.index(L.name),$=u($);if(z===0)return x({result:[]});w?((M=j?L.getAll($,M):L.getAllKeys($,M)).onsuccess=function(Z){return x({result:Z.target.result})},M.onerror=Je(P)):(A=0,N=!j&&"openKeyCursor"in L?L.openKeyCursor($):L.openCursor($),B=[],N.onsuccess=function(Z){var se=N.result;return se?(B.push(j?se.value:se.primaryKey),++A===z?x({result:B}):void se.continue()):x({result:B})},N.onerror=Je(P))})}),openCursor:function(E){var x=E.trans,P=E.values,A=E.query,N=E.reverse,B=E.unique;return new Promise(function(j,z){j=we(j);var L=A.index,M=A.range,F=x.objectStore(k),F=L.isPrimaryKey?F:F.index(L.name),L=N?B?"prevunique":"prev":B?"nextunique":"next",$=!P&&"openKeyCursor"in F?F.openKeyCursor(u(M),L):F.openCursor(u(M),L);$.onerror=Je(z),$.onsuccess=we(function(Z){var se,ae,ue,Fe,re=$.result;re?(re.___id=++No,re.done=!1,se=re.continue.bind(re),ae=(ae=re.continuePrimaryKey)&&ae.bind(re),ue=re.advance.bind(re),Fe=function(){throw new Error("Cursor not stopped")},re.trans=x,re.stop=re.continue=re.continuePrimaryKey=re.advance=function(){throw new Error("Cursor not started")},re.fail=we(z),re.next=function(){var Ce=this,Be=1;return this.start(function(){return Be--?Ce.continue():Ce.stop()}).then(function(){return Ce})},re.start=function(Ce){function Be(){if($.result)try{Ce()}catch(De){re.fail(De)}else re.done=!0,re.start=function(){throw new Error("Cursor behind last entry")},re.stop()}var Wn=new Promise(function(De,It){De=we(De),$.onerror=Je(It),re.fail=It,re.stop=function(Yr){re.stop=re.continue=re.continuePrimaryKey=re.advance=Fe,De(Yr)}});return $.onsuccess=we(function(De){$.onsuccess=Be,Be()}),re.continue=se,re.continuePrimaryKey=ae,re.advance=ue,Be(),Wn},j(re)):j(null)},z)})},count:function(E){var x=E.query,P=E.trans,A=x.index,N=x.range;return new Promise(function(B,j){var z=P.objectStore(k),M=A.isPrimaryKey?z:z.index(A.name),z=u(N),M=z?M.count(z):M.count();M.onsuccess=we(function(F){return B(F.target.result)}),M.onerror=Je(j)})}}}var f,p,g,_=(p=b,g=Vi((f=n).objectStoreNames),{schema:{name:f.name,tables:g.map(function(R){return p.objectStore(R)}).map(function(R){var w=R.keyPath,x=R.autoIncrement,k=d(w),E={},x={name:R.name,primaryKey:{name:null,isPrimaryKey:!0,outbound:w==null,compound:k,keyPath:w,autoIncrement:x,unique:!0,extractKey:Ir(w)},indexes:Vi(R.indexNames).map(function(P){return R.index(P)}).map(function(B){var A=B.name,N=B.unique,j=B.multiEntry,B=B.keyPath,j={name:A,compound:d(B),keyPath:B,unique:N,multiEntry:j,extractKey:Ir(B)};return E[fn(B)]=j}),getIndexByKeyPath:function(P){return E[fn(P)]}};return E[":id"]=x.primaryKey,w!=null&&(E[fn(w)]=x.primaryKey),x})},hasGetAll:0<g.length&&"getAll"in p.objectStore(g[0])&&!(typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604)}),b=_.schema,v=_.hasGetAll,_=b.tables.map(l),m={};return _.forEach(function(R){return m[R.name]=R}),{stack:"dbcore",transaction:n.transaction.bind(n),table:function(R){if(!m[R])throw new Error("Table '".concat(R,"' not found"));return m[R]},MIN_KEY:-1/0,MAX_KEY:hn(s),schema:b}}function Bo(n,s,a,u){var l=a.IDBKeyRange;return a.indexedDB,{dbcore:(u=Co(s,l,u),n.dbcore.reduce(function(f,p){return p=p.create,r(r({},f),p(f))},u))}}function Kn(n,u){var a=u.db,u=Bo(n._middlewares,a,n._deps,u);n.core=u.dbcore,n.tables.forEach(function(l){var f=l.name;n.core.schema.tables.some(function(p){return p.name===f})&&(l.core=n.core.table(f),n[f]instanceof n.Table&&(n[f].core=l.core))})}function Un(n,s,a,u){a.forEach(function(l){var f=u[l];s.forEach(function(p){var g=function b(v,_){return ne(v,_)||(v=S(v))&&b(v,_)}(p,l);(!g||"value"in g&&g.value===void 0)&&(p===n.Transaction.prototype||p instanceof n.Transaction?K(p,l,{get:function(){return this.table(l)},set:function(b){O(this,l,{value:b,writable:!0,configurable:!0,enumerable:!0})}}):p[l]=new n.Table(l,f))})})}function Or(n,s){s.forEach(function(a){for(var u in a)a[u]instanceof n.Table&&delete a[u]})}function Do(n,s){return n._cfg.version-s._cfg.version}function Ko(n,s,a,u){var l=n._dbSchema;a.objectStoreNames.contains("$meta")&&!l.$meta&&(l.$meta=Ar("$meta",Wi("")[0],[]),n._storeNames.push("$meta"));var f=n._createTransaction("readwrite",n._storeNames,l);f.create(a),f._completion.catch(u);var p=f._reject.bind(f),g=J.transless||J;lt(function(){return J.trans=f,J.transless=g,s!==0?(Kn(n,a),v=s,((b=f).storeNames.includes("$meta")?b.table("$meta").get("version").then(function(_){return _??v}):H.resolve(v)).then(function(_){return R=_,w=f,k=a,E=[],_=(m=n)._versions,x=m._dbSchema=Mn(0,m.idbdb,k),(_=_.filter(function(P){return P._cfg.version>=R})).length!==0?(_.forEach(function(P){E.push(function(){var A=x,N=P._cfg.dbschema;jn(m,A,k),jn(m,N,k),x=m._dbSchema=N;var B=Nr(A,N);B.add.forEach(function(L){Cr(k,L[0],L[1].primKey,L[1].indexes)}),B.change.forEach(function(L){if(L.recreate)throw new V.Upgrade("Not yet support for changing primary key");var $=k.objectStore(L.name);L.add.forEach(function(Z){return qn($,Z)}),L.change.forEach(function(Z){$.deleteIndex(Z.name),qn($,Z)}),L.del.forEach(function(Z){return $.deleteIndex(Z)})});var j=P._cfg.contentUpgrade;if(j&&P._cfg.version>R){Kn(m,k),w._memoizedTables={};var z=tt(N);B.del.forEach(function(L){z[L]=A[L]}),Or(m,[m.Transaction.prototype]),Un(m,[m.Transaction.prototype],h(z),z),w.schema=z;var M,F=te(j);return F&&$t(),B=H.follow(function(){var L;(M=j(w))&&F&&(L=ht.bind(null,null),M.then(L,L))}),M&&typeof M.then=="function"?H.resolve(M):B.then(function(){return M})}}),E.push(function(A){var N,B,j=P._cfg.dbschema;N=j,B=A,[].slice.call(B.db.objectStoreNames).forEach(function(z){return N[z]==null&&B.db.deleteObjectStore(z)}),Or(m,[m.Transaction.prototype]),Un(m,[m.Transaction.prototype],m._storeNames,m._dbSchema),w.schema=m._dbSchema}),E.push(function(A){m.idbdb.objectStoreNames.contains("$meta")&&(Math.ceil(m.idbdb.version/10)===P._cfg.version?(m.idbdb.deleteObjectStore("$meta"),delete m._dbSchema.$meta,m._storeNames=m._storeNames.filter(function(N){return N!=="$meta"})):A.objectStore("$meta").put(P._cfg.version,"version"))})}),function P(){return E.length?H.resolve(E.shift()(w.idbtrans)).then(P):H.resolve()}().then(function(){Hi(x,k)})):H.resolve();var m,R,w,k,E,x}).catch(p)):(h(l).forEach(function(_){Cr(a,_,l[_].primKey,l[_].indexes)}),Kn(n,a),void H.follow(function(){return n.on.populate.fire(f)}).catch(p));var b,v})}function Uo(n,s){Hi(n._dbSchema,s),s.db.version%10!=0||s.objectStoreNames.contains("$meta")||s.db.createObjectStore("$meta").add(Math.ceil(s.db.version/10-1),"version");var a=Mn(0,n.idbdb,s);jn(n,n._dbSchema,s);for(var u=0,l=Nr(a,n._dbSchema).change;u<l.length;u++){var f=function(p){if(p.change.length||p.recreate)return console.warn("Unable to patch indexes of table ".concat(p.name," because it has changes on the type of index or primary key.")),{value:void 0};var g=s.objectStore(p.name);p.add.forEach(function(b){Ge&&console.debug("Dexie upgrade patch: Creating missing index ".concat(p.name,".").concat(b.src)),qn(g,b)})}(l[u]);if(typeof f=="object")return f.value}}function Nr(n,s){var a,u={del:[],add:[],change:[]};for(a in n)s[a]||u.del.push(a);for(a in s){var l=n[a],f=s[a];if(l){var p={name:a,def:f,recreate:!1,del:[],add:[],change:[]};if(""+(l.primKey.keyPath||"")!=""+(f.primKey.keyPath||"")||l.primKey.auto!==f.primKey.auto)p.recreate=!0,u.change.push(p);else{var g=l.idxByName,b=f.idxByName,v=void 0;for(v in g)b[v]||p.del.push(v);for(v in b){var _=g[v],m=b[v];_?_.src!==m.src&&p.change.push(m):p.add.push(m)}(0<p.del.length||0<p.add.length||0<p.change.length)&&u.change.push(p)}}else u.add.push([a,f])}return u}function Cr(n,s,a,u){var l=n.db.createObjectStore(s,a.keyPath?{keyPath:a.keyPath,autoIncrement:a.auto}:{autoIncrement:a.auto});return u.forEach(function(f){return qn(l,f)}),l}function Hi(n,s){h(n).forEach(function(a){s.db.objectStoreNames.contains(a)||(Ge&&console.debug("Dexie: Creating missing table",a),Cr(s,a,n[a].primKey,n[a].indexes))})}function qn(n,s){n.createIndex(s.name,s.keyPath,{unique:s.unique,multiEntry:s.multi})}function Mn(n,s,a){var u={};return $e(s.objectStoreNames,0).forEach(function(l){for(var f=a.objectStore(l),p=Pr(Li(v=f.keyPath),v||"",!0,!1,!!f.autoIncrement,v&&typeof v!="string",!0),g=[],b=0;b<f.indexNames.length;++b){var _=f.index(f.indexNames[b]),v=_.keyPath,_=Pr(_.name,v,!!_.unique,!!_.multiEntry,!1,v&&typeof v!="string",!1);g.push(_)}u[l]=Ar(l,p,g)}),u}function jn(n,s,a){for(var u=a.db.objectStoreNames,l=0;l<u.length;++l){var f=u[l],p=a.objectStore(f);n._hasGetAll="getAll"in p;for(var g=0;g<p.indexNames.length;++g){var b=p.indexNames[g],v=p.index(b).keyPath,_=typeof v=="string"?v:"["+$e(v).join("+")+"]";!s[f]||(v=s[f].idxByName[_])&&(v.name=b,delete s[f].idxByName[_],s[f].idxByName[b]=v)}}typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&c.WorkerGlobalScope&&c instanceof c.WorkerGlobalScope&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604&&(n._hasGetAll=!1)}function Wi(n){return n.split(",").map(function(s,a){var f=s.split(":"),u=(l=f[1])===null||l===void 0?void 0:l.trim(),l=(s=f[0].trim()).replace(/([&*]|\+\+)/g,""),f=/^\[/.test(l)?l.match(/^\[(.*)\]$/)[1].split("+"):l;return Pr(l,f||null,/\&/.test(s),/\*/.test(s),/\+\+/.test(s),d(f),a===0,u)})}var qo=(Ht.prototype._createTableSchema=Ar,Ht.prototype._parseIndexSyntax=Wi,Ht.prototype._parseStoresSpec=function(n,s){var a=this;h(n).forEach(function(u){if(n[u]!==null){var l=a._parseIndexSyntax(n[u]),f=l.shift();if(!f)throw new V.Schema("Invalid schema for table "+u+": "+n[u]);if(f.unique=!0,f.multi)throw new V.Schema("Primary key cannot be multiEntry*");l.forEach(function(p){if(p.auto)throw new V.Schema("Only primary key can be marked as autoIncrement (++)");if(!p.keyPath)throw new V.Schema("Index must have a name and cannot be an empty string")}),l=a._createTableSchema(u,f,l),s[u]=l}})},Ht.prototype.stores=function(a){var s=this.db;this._cfg.storesSource=this._cfg.storesSource?y(this._cfg.storesSource,a):a;var a=s._versions,u={},l={};return a.forEach(function(f){y(u,f._cfg.storesSource),l=f._cfg.dbschema={},f._parseStoresSpec(u,l)}),s._dbSchema=l,Or(s,[s._allTables,s,s.Transaction.prototype]),Un(s,[s._allTables,s,s.Transaction.prototype,this._cfg.tables],h(l),l),s._storeNames=h(l),this},Ht.prototype.upgrade=function(n){return this._cfg.contentUpgrade=pr(this._cfg.contentUpgrade||pe,n),this},Ht);function Ht(){}function Br(n,s){var a=n._dbNamesDB;return a||(a=n._dbNamesDB=new it(In,{addons:[],indexedDB:n,IDBKeyRange:s})).version(1).stores({dbnames:"name"}),a.table("dbnames")}function Dr(n){return n&&typeof n.databases=="function"}function Kr(n){return lt(function(){return J.letThrough=!0,n()})}function Ur(n){return!("from"in n)}var Ne=function(n,s){if(!this){var a=new Ne;return n&&"d"in n&&y(a,n),a}y(this,arguments.length?{d:1,from:n,to:1<arguments.length?s:n}:{d:0})};function dn(n,s,a){var u=fe(s,a);if(!isNaN(u)){if(0<u)throw RangeError();if(Ur(n))return y(n,{from:s,to:a,d:1});var l=n.l,u=n.r;if(fe(a,n.from)<0)return l?dn(l,s,a):n.l={from:s,to:a,d:1,l:null,r:null},Zi(n);if(0<fe(s,n.to))return u?dn(u,s,a):n.r={from:s,to:a,d:1,l:null,r:null},Zi(n);fe(s,n.from)<0&&(n.from=s,n.l=null,n.d=u?u.d+1:1),0<fe(a,n.to)&&(n.to=a,n.r=null,n.d=n.l?n.l.d+1:1),a=!n.r,l&&!n.l&&pn(n,l),u&&a&&pn(n,u)}}function pn(n,s){Ur(s)||function a(u,b){var f=b.from,p=b.to,g=b.l,b=b.r;dn(u,f,p),g&&a(u,g),b&&a(u,b)}(n,s)}function Yi(n,s){var a=Fn(s),u=a.next();if(u.done)return!1;for(var l=u.value,f=Fn(n),p=f.next(l.from),g=p.value;!u.done&&!p.done;){if(fe(g.from,l.to)<=0&&0<=fe(g.to,l.from))return!0;fe(l.from,g.from)<0?l=(u=a.next(g.from)).value:g=(p=f.next(l.from)).value}return!1}function Fn(n){var s=Ur(n)?null:{s:0,n};return{next:function(a){for(var u=0<arguments.length;s;)switch(s.s){case 0:if(s.s=1,u)for(;s.n.l&&fe(a,s.n.from)<0;)s={up:s,n:s.n.l,s:1};else for(;s.n.l;)s={up:s,n:s.n.l,s:1};case 1:if(s.s=2,!u||fe(a,s.n.to)<=0)return{value:s.n,done:!1};case 2:if(s.n.r){s.s=3,s={up:s,n:s.n.r,s:0};continue}case 3:s=s.up}return{done:!0}}}}function Zi(n){var s,a,u=(((s=n.r)===null||s===void 0?void 0:s.d)||0)-(((a=n.l)===null||a===void 0?void 0:a.d)||0),l=1<u?"r":u<-1?"l":"";l&&(s=l=="r"?"l":"r",a=r({},n),u=n[l],n.from=u.from,n.to=u.to,n[l]=u[l],a[l]=u[s],(n[s]=a).d=Gi(a)),n.d=Gi(n)}function Gi(a){var s=a.r,a=a.l;return(s?a?Math.max(s.d,a.d):s.d:a?a.d:0)+1}function $n(n,s){return h(s).forEach(function(a){n[a]?pn(n[a],s[a]):n[a]=function u(l){var f,p,g={};for(f in l)C(l,f)&&(p=l[f],g[f]=!p||typeof p!="object"||Ze.has(p.constructor)?p:u(p));return g}(s[a])}),n}function qr(n,s){return n.all||s.all||Object.keys(n).some(function(a){return s[a]&&Yi(s[a],n[a])})}T(Ne.prototype,((ze={add:function(n){return pn(this,n),this},addKey:function(n){return dn(this,n,n),this},addKeys:function(n){var s=this;return n.forEach(function(a){return dn(s,a,a)}),this},hasKey:function(n){var s=Fn(this).next(n).value;return s&&fe(s.from,n)<=0&&0<=fe(s.to,n)}})[W]=function(){return Fn(this)},ze));var Pt={},Mr={},jr=!1;function zn(n){$n(Mr,n),jr||(jr=!0,setTimeout(function(){jr=!1,Fr(Mr,!(Mr={}))},0))}function Fr(n,s){s===void 0&&(s=!1);var a=new Set;if(n.all)for(var u=0,l=Object.values(Pt);u<l.length;u++)Ji(p=l[u],n,a,s);else for(var f in n){var p,g=/^idb\:\/\/(.*)\/(.*)\//.exec(f);g&&(f=g[1],g=g[2],(p=Pt["idb://".concat(f,"/").concat(g)])&&Ji(p,n,a,s))}a.forEach(function(b){return b()})}function Ji(n,s,a,u){for(var l=[],f=0,p=Object.entries(n.queries.query);f<p.length;f++){for(var g=p[f],b=g[0],v=[],_=0,m=g[1];_<m.length;_++){var R=m[_];qr(s,R.obsSet)?R.subscribers.forEach(function(x){return a.add(x)}):u&&v.push(R)}u&&l.push([b,v])}if(u)for(var w=0,k=l;w<k.length;w++){var E=k[w],b=E[0],v=E[1];n.queries.query[b]=v}}function Mo(n){var s=n._state,a=n._deps.indexedDB;if(s.isBeingOpened||n.idbdb)return s.dbReadyPromise.then(function(){return s.dbOpenError?Ee(s.dbOpenError):n});s.isBeingOpened=!0,s.dbOpenError=null,s.openComplete=!1;var u=s.openCanceller,l=Math.round(10*n.verno),f=!1;function p(){if(s.openCanceller!==u)throw new V.DatabaseClosed("db.open() was cancelled")}function g(){return new H(function(R,w){if(p(),!a)throw new V.MissingAPI;var k=n.name,E=s.autoSchema||!l?a.open(k):a.open(k,l);if(!E)throw new V.MissingAPI;E.onerror=Je(w),E.onblocked=we(n._fireOnBlocked),E.onupgradeneeded=we(function(x){var P;_=E.transaction,s.autoSchema&&!n._options.allowEmptyDB?(E.onerror=cn,_.abort(),E.result.close(),(P=a.deleteDatabase(k)).onsuccess=P.onerror=we(function(){w(new V.NoSuchDatabase("Database ".concat(k," doesnt exist")))})):(_.onerror=Je(w),x=x.oldVersion>Math.pow(2,62)?0:x.oldVersion,m=x<1,n.idbdb=E.result,f&&Uo(n,_),Ko(n,x/10,_,w))},w),E.onsuccess=we(function(){_=null;var x,P,A,N,B,j=n.idbdb=E.result,z=$e(j.objectStoreNames);if(0<z.length)try{var M=j.transaction((N=z).length===1?N[0]:N,"readonly");if(s.autoSchema)P=j,A=M,(x=n).verno=P.version/10,A=x._dbSchema=Mn(0,P,A),x._storeNames=$e(P.objectStoreNames,0),Un(x,[x._allTables],h(A),A);else if(jn(n,n._dbSchema,M),((B=Nr(Mn(0,(B=n).idbdb,M),B._dbSchema)).add.length||B.change.some(function(F){return F.add.length||F.change.length}))&&!f)return console.warn("Dexie SchemaDiff: Schema was extended without increasing the number passed to db.version(). Dexie will add missing parts and increment native version number to workaround this."),j.close(),l=j.version+1,f=!0,R(g());Kn(n,M)}catch{}zt.push(n),j.onversionchange=we(function(F){s.vcFired=!0,n.on("versionchange").fire(F)}),j.onclose=we(function(){n.close({disableAutoOpen:!1})}),m&&(B=n._deps,M=k,j=B.indexedDB,B=B.IDBKeyRange,Dr(j)||M===In||Br(j,B).put({name:M}).catch(pe)),R()},w)}).catch(function(R){switch(R?.name){case"UnknownError":if(0<s.PR1398_maxLoop)return s.PR1398_maxLoop--,console.warn("Dexie: Workaround for Chrome UnknownError on open()"),g();break;case"VersionError":if(0<l)return l=0,g()}return H.reject(R)})}var b,v=s.dbReadyResolve,_=null,m=!1;return H.race([u,(typeof navigator>"u"?H.resolve():!navigator.userAgentData&&/Safari\//.test(navigator.userAgent)&&!/Chrom(e|ium)\//.test(navigator.userAgent)&&indexedDB.databases?new Promise(function(R){function w(){return indexedDB.databases().finally(R)}b=setInterval(w,100),w()}).finally(function(){return clearInterval(b)}):Promise.resolve()).then(g)]).then(function(){return p(),s.onReadyBeingFired=[],H.resolve(Kr(function(){return n.on.ready.fire(n.vip)})).then(function R(){if(0<s.onReadyBeingFired.length){var w=s.onReadyBeingFired.reduce(pr,pe);return s.onReadyBeingFired=[],H.resolve(Kr(function(){return w(n.vip)})).then(R)}})}).finally(function(){s.openCanceller===u&&(s.onReadyBeingFired=null,s.isBeingOpened=!1)}).catch(function(R){s.dbOpenError=R;try{_&&_.abort()}catch{}return u===s.openCanceller&&n._close(),Ee(R)}).finally(function(){s.openComplete=!0,v()}).then(function(){var R;return m&&(R={},n.tables.forEach(function(w){w.schema.indexes.forEach(function(k){k.name&&(R["idb://".concat(n.name,"/").concat(w.name,"/").concat(k.name)]=new Ne(-1/0,[[[]]]))}),R["idb://".concat(n.name,"/").concat(w.name,"/")]=R["idb://".concat(n.name,"/").concat(w.name,"/:dels")]=new Ne(-1/0,[[[]]])}),pt(ln).fire(R),Fr(R,!0)),n})}function $r(n){function s(f){return n.next(f)}var a=l(s),u=l(function(f){return n.throw(f)});function l(f){return function(b){var g=f(b),b=g.value;return g.done?b:b&&typeof b.then=="function"?b.then(a,u):d(b)?Promise.all(b).then(a,u):a(b)}}return l(s)()}function Ln(n,s,a){for(var u=d(n)?n.slice():[n],l=0;l<a;++l)u.push(s);return u}var jo={stack:"dbcore",name:"VirtualIndexMiddleware",level:1,create:function(n){return r(r({},n),{table:function(s){var a=n.table(s),u=a.schema,l={},f=[];function p(m,R,w){var k=fn(m),E=l[k]=l[k]||[],x=m==null?0:typeof m=="string"?1:m.length,P=0<R,P=r(r({},w),{name:P?"".concat(k,"(virtual-from:").concat(w.name,")"):w.name,lowLevelIndex:w,isVirtual:P,keyTail:R,keyLength:x,extractKey:Ir(m),unique:!P&&w.unique});return E.push(P),P.isPrimaryKey||f.push(P),1<x&&p(x===2?m[0]:m.slice(0,x-1),R+1,w),E.sort(function(A,N){return A.keyTail-N.keyTail}),P}s=p(u.primaryKey.keyPath,0,u.primaryKey),l[":id"]=[s];for(var g=0,b=u.indexes;g<b.length;g++){var v=b[g];p(v.keyPath,0,v)}function _(m){var R,w=m.query.index;return w.isVirtual?r(r({},m),{query:{index:w.lowLevelIndex,range:(R=m.query.range,w=w.keyTail,{type:R.type===1?2:R.type,lower:Ln(R.lower,R.lowerOpen?n.MAX_KEY:n.MIN_KEY,w),lowerOpen:!0,upper:Ln(R.upper,R.upperOpen?n.MIN_KEY:n.MAX_KEY,w),upperOpen:!0})}}):m}return r(r({},a),{schema:r(r({},u),{primaryKey:s,indexes:f,getIndexByKeyPath:function(m){return(m=l[fn(m)])&&m[0]}}),count:function(m){return a.count(_(m))},query:function(m){return a.query(_(m))},openCursor:function(m){var R=m.query.index,w=R.keyTail,k=R.isVirtual,E=R.keyLength;return k?a.openCursor(_(m)).then(function(P){return P&&x(P)}):a.openCursor(m);function x(P){return Object.create(P,{continue:{value:function(A){A!=null?P.continue(Ln(A,m.reverse?n.MAX_KEY:n.MIN_KEY,w)):m.unique?P.continue(P.key.slice(0,E).concat(m.reverse?n.MIN_KEY:n.MAX_KEY,w)):P.continue()}},continuePrimaryKey:{value:function(A,N){P.continuePrimaryKey(Ln(A,n.MAX_KEY,w),N)}},primaryKey:{get:function(){return P.primaryKey}},key:{get:function(){var A=P.key;return E===1?A[0]:A.slice(0,E)}},value:{get:function(){return P.value}}})}}})}})}};function zr(n,s,a,u){return a=a||{},u=u||"",h(n).forEach(function(l){var f,p,g;C(s,l)?(f=n[l],p=s[l],typeof f=="object"&&typeof p=="object"&&f&&p?(g=D(f))!==D(p)?a[u+l]=s[l]:g==="Object"?zr(f,p,a,u+l+"."):f!==p&&(a[u+l]=s[l]):f!==p&&(a[u+l]=s[l])):a[u+l]=void 0}),h(s).forEach(function(l){C(n,l)||(a[u+l]=s[l])}),a}function Lr(n,s){return s.type==="delete"?s.keys:s.keys||s.values.map(n.extractKey)}var Fo={stack:"dbcore",name:"HooksMiddleware",level:2,create:function(n){return r(r({},n),{table:function(s){var a=n.table(s),u=a.schema.primaryKey;return r(r({},a),{mutate:function(l){var f=J.trans,p=f.table(s).hook,g=p.deleting,b=p.creating,v=p.updating;switch(l.type){case"add":if(b.fire===pe)break;return f._promise("readwrite",function(){return _(l)},!0);case"put":if(b.fire===pe&&v.fire===pe)break;return f._promise("readwrite",function(){return _(l)},!0);case"delete":if(g.fire===pe)break;return f._promise("readwrite",function(){return _(l)},!0);case"deleteRange":if(g.fire===pe)break;return f._promise("readwrite",function(){return function m(R,w,k){return a.query({trans:R,values:!1,query:{index:u,range:w},limit:k}).then(function(E){var x=E.result;return _({type:"delete",keys:x,trans:R}).then(function(P){return 0<P.numFailures?Promise.reject(P.failures[0]):x.length<k?{failures:[],numFailures:0,lastResult:void 0}:m(R,r(r({},w),{lower:x[x.length-1],lowerOpen:!0}),k)})})}(l.trans,l.range,1e4)},!0)}return a.mutate(l);function _(m){var R,w,k,E=J.trans,x=m.keys||Lr(u,m);if(!x)throw new Error("Keys missing");return(m=m.type==="add"||m.type==="put"?r(r({},m),{keys:x}):r({},m)).type!=="delete"&&(m.values=o([],m.values)),m.keys&&(m.keys=o([],m.keys)),R=a,k=x,((w=m).type==="add"?Promise.resolve([]):R.getMany({trans:w.trans,keys:k,cache:"immutable"})).then(function(P){var A=x.map(function(N,B){var j,z,M,F=P[B],L={onerror:null,onsuccess:null};return m.type==="delete"?g.fire.call(L,N,F,E):m.type==="add"||F===void 0?(j=b.fire.call(L,N,m.values[B],E),N==null&&j!=null&&(m.keys[B]=N=j,u.outbound||Se(m.values[B],u.keyPath,N))):(j=zr(F,m.values[B]),(z=v.fire.call(L,j,N,F,E))&&(M=m.values[B],Object.keys(z).forEach(function($){C(M,$)?M[$]=z[$]:Se(M,$,z[$])}))),L});return a.mutate(m).then(function(N){for(var B=N.failures,j=N.results,z=N.numFailures,N=N.lastResult,M=0;M<x.length;++M){var F=(j||x)[M],L=A[M];F==null?L.onerror&&L.onerror(B[M]):L.onsuccess&&L.onsuccess(m.type==="put"&&P[M]?m.values[M]:F)}return{failures:B,results:j,numFailures:z,lastResult:N}}).catch(function(N){return A.forEach(function(B){return B.onerror&&B.onerror(N)}),Promise.reject(N)})})}}})}})}};function Qi(n,s,a){try{if(!s||s.keys.length<n.length)return null;for(var u=[],l=0,f=0;l<s.keys.length&&f<n.length;++l)fe(s.keys[l],n[f])===0&&(u.push(a?U(s.values[l]):s.values[l]),++f);return u.length===n.length?u:null}catch{return null}}var $o={stack:"dbcore",level:-1,create:function(n){return{table:function(s){var a=n.table(s);return r(r({},a),{getMany:function(u){if(!u.cache)return a.getMany(u);var l=Qi(u.keys,u.trans._cache,u.cache==="clone");return l?H.resolve(l):a.getMany(u).then(function(f){return u.trans._cache={keys:u.keys,values:u.cache==="clone"?U(f):f},f})},mutate:function(u){return u.type!=="add"&&(u.trans._cache=null),a.mutate(u)}})}}}};function Xi(n,s){return n.trans.mode==="readonly"&&!!n.subscr&&!n.trans.explicit&&n.trans.db._options.cache!=="disabled"&&!s.schema.primaryKey.outbound}function es(n,s){switch(n){case"query":return s.values&&!s.unique;case"get":case"getMany":case"count":case"openCursor":return!1}}var zo={stack:"dbcore",level:0,name:"Observability",create:function(n){var s=n.schema.name,a=new Ne(n.MIN_KEY,n.MAX_KEY);return r(r({},n),{transaction:function(u,l,f){if(J.subscr&&l!=="readonly")throw new V.ReadOnly("Readwrite transaction in liveQuery context. Querier source: ".concat(J.querier));return n.transaction(u,l,f)},table:function(u){var l=n.table(u),f=l.schema,p=f.primaryKey,m=f.indexes,g=p.extractKey,b=p.outbound,v=p.autoIncrement&&m.filter(function(w){return w.compound&&w.keyPath.includes(p.keyPath)}),_=r(r({},l),{mutate:function(w){function k($){return $="idb://".concat(s,"/").concat(u,"/").concat($),N[$]||(N[$]=new Ne)}var E,x,P,A=w.trans,N=w.mutatedParts||(w.mutatedParts={}),B=k(""),j=k(":dels"),z=w.type,L=w.type==="deleteRange"?[w.range]:w.type==="delete"?[w.keys]:w.values.length<50?[Lr(p,w).filter(function($){return $}),w.values]:[],M=L[0],F=L[1],L=w.trans._cache;return d(M)?(B.addKeys(M),(L=z==="delete"||M.length===F.length?Qi(M,L):null)||j.addKeys(M),(L||F)&&(E=k,x=L,P=F,f.indexes.forEach(function($){var Z=E($.name||"");function se(ue){return ue!=null?$.extractKey(ue):null}function ae(ue){return $.multiEntry&&d(ue)?ue.forEach(function(Fe){return Z.addKey(Fe)}):Z.addKey(ue)}(x||P).forEach(function(ue,Ce){var re=x&&se(x[Ce]),Ce=P&&se(P[Ce]);fe(re,Ce)!==0&&(re!=null&&ae(re),Ce!=null&&ae(Ce))})}))):M?(F={from:(F=M.lower)!==null&&F!==void 0?F:n.MIN_KEY,to:(F=M.upper)!==null&&F!==void 0?F:n.MAX_KEY},j.add(F),B.add(F)):(B.add(a),j.add(a),f.indexes.forEach(function($){return k($.name).add(a)})),l.mutate(w).then(function($){return!M||w.type!=="add"&&w.type!=="put"||(B.addKeys($.results),v&&v.forEach(function(Z){for(var se=w.values.map(function(re){return Z.extractKey(re)}),ae=Z.keyPath.findIndex(function(re){return re===p.keyPath}),ue=0,Fe=$.results.length;ue<Fe;++ue)se[ue][ae]=$.results[ue];k(Z.name).addKeys(se)})),A.mutatedParts=$n(A.mutatedParts||{},N),$})}}),m=function(k){var E=k.query,k=E.index,E=E.range;return[k,new Ne((k=E.lower)!==null&&k!==void 0?k:n.MIN_KEY,(E=E.upper)!==null&&E!==void 0?E:n.MAX_KEY)]},R={get:function(w){return[p,new Ne(w.key)]},getMany:function(w){return[p,new Ne().addKeys(w.keys)]},count:m,query:m,openCursor:m};return h(R).forEach(function(w){_[w]=function(k){var E=J.subscr,x=!!E,P=Xi(J,l)&&es(w,k)?k.obsSet={}:E;if(x){var A=function(F){return F="idb://".concat(s,"/").concat(u,"/").concat(F),P[F]||(P[F]=new Ne)},N=A(""),B=A(":dels"),E=R[w](k),x=E[0],E=E[1];if((w==="query"&&x.isPrimaryKey&&!k.values?B:A(x.name||"")).add(E),!x.isPrimaryKey){if(w!=="count"){var j=w==="query"&&b&&k.values&&l.query(r(r({},k),{values:!1}));return l[w].apply(this,arguments).then(function(F){if(w==="query"){if(b&&k.values)return j.then(function(se){return se=se.result,N.addKeys(se),F});var L=k.values?F.result.map(g):F.result;(k.values?N:B).addKeys(L)}else if(w==="openCursor"){var $=F,Z=k.values;return $&&Object.create($,{key:{get:function(){return B.addKey($.primaryKey),$.key}},primaryKey:{get:function(){var se=$.primaryKey;return B.addKey(se),se}},value:{get:function(){return Z&&N.addKey($.primaryKey),$.value}}})}return F})}B.add(a)}}return l[w].apply(this,arguments)}}),_}})}};function ts(n,s,a){if(a.numFailures===0)return s;if(s.type==="deleteRange")return null;var u=s.keys?s.keys.length:"values"in s&&s.values?s.values.length:1;return a.numFailures===u?null:(s=r({},s),d(s.keys)&&(s.keys=s.keys.filter(function(l,f){return!(f in a.failures)})),"values"in s&&d(s.values)&&(s.values=s.values.filter(function(l,f){return!(f in a.failures)})),s)}function Vr(n,s){return a=n,((u=s).lower===void 0||(u.lowerOpen?0<fe(a,u.lower):0<=fe(a,u.lower)))&&(n=n,(s=s).upper===void 0||(s.upperOpen?fe(n,s.upper)<0:fe(n,s.upper)<=0));var a,u}function ns(n,s,R,u,l,f){if(!R||R.length===0)return n;var p=s.query.index,g=p.multiEntry,b=s.query.range,v=u.schema.primaryKey.extractKey,_=p.extractKey,m=(p.lowLevelIndex||p).extractKey,R=R.reduce(function(w,k){var E=w,x=[];if(k.type==="add"||k.type==="put")for(var P=new Ne,A=k.values.length-1;0<=A;--A){var N,B=k.values[A],j=v(B);P.hasKey(j)||(N=_(B),(g&&d(N)?N.some(function($){return Vr($,b)}):Vr(N,b))&&(P.addKey(j),x.push(B)))}switch(k.type){case"add":var z=new Ne().addKeys(s.values?w.map(function(Z){return v(Z)}):w),E=w.concat(s.values?x.filter(function(Z){return Z=v(Z),!z.hasKey(Z)&&(z.addKey(Z),!0)}):x.map(function(Z){return v(Z)}).filter(function(Z){return!z.hasKey(Z)&&(z.addKey(Z),!0)}));break;case"put":var M=new Ne().addKeys(k.values.map(function(Z){return v(Z)}));E=w.filter(function(Z){return!M.hasKey(s.values?v(Z):Z)}).concat(s.values?x:x.map(function(Z){return v(Z)}));break;case"delete":var F=new Ne().addKeys(k.keys);E=w.filter(function(Z){return!F.hasKey(s.values?v(Z):Z)});break;case"deleteRange":var L=k.range;E=w.filter(function(Z){return!Vr(v(Z),L)})}return E},n);return R===n?n:(R.sort(function(w,k){return fe(m(w),m(k))||fe(v(w),v(k))}),s.limit&&s.limit<1/0&&(R.length>s.limit?R.length=s.limit:n.length===s.limit&&R.length<s.limit&&(l.dirty=!0)),f?Object.freeze(R):R)}function rs(n,s){return fe(n.lower,s.lower)===0&&fe(n.upper,s.upper)===0&&!!n.lowerOpen==!!s.lowerOpen&&!!n.upperOpen==!!s.upperOpen}function Lo(n,s){return function(a,u,l,f){if(a===void 0)return u!==void 0?-1:0;if(u===void 0)return 1;if((u=fe(a,u))===0){if(l&&f)return 0;if(l)return 1;if(f)return-1}return u}(n.lower,s.lower,n.lowerOpen,s.lowerOpen)<=0&&0<=function(a,u,l,f){if(a===void 0)return u!==void 0?1:0;if(u===void 0)return-1;if((u=fe(a,u))===0){if(l&&f)return 0;if(l)return-1;if(f)return 1}return u}(n.upper,s.upper,n.upperOpen,s.upperOpen)}function Vo(n,s,a,u){n.subscribers.add(a),u.addEventListener("abort",function(){var l,f;n.subscribers.delete(a),n.subscribers.size===0&&(l=n,f=s,setTimeout(function(){l.subscribers.size===0&&ee(f,l)},3e3))})}var Ho={stack:"dbcore",level:0,name:"Cache",create:function(n){var s=n.schema.name;return r(r({},n),{transaction:function(a,u,l){var f,p,g=n.transaction(a,u,l);return u==="readwrite"&&(p=(f=new AbortController).signal,l=function(b){return function(){if(f.abort(),u==="readwrite"){for(var v=new Set,_=0,m=a;_<m.length;_++){var R=m[_],w=Pt["idb://".concat(s,"/").concat(R)];if(w){var k=n.table(R),E=w.optimisticOps.filter(function(Z){return Z.trans===g});if(g._explicit&&b&&g.mutatedParts)for(var x=0,P=Object.values(w.queries.query);x<P.length;x++)for(var A=0,N=(z=P[x]).slice();A<N.length;A++)qr((M=N[A]).obsSet,g.mutatedParts)&&(ee(z,M),M.subscribers.forEach(function(Z){return v.add(Z)}));else if(0<E.length){w.optimisticOps=w.optimisticOps.filter(function(Z){return Z.trans!==g});for(var B=0,j=Object.values(w.queries.query);B<j.length;B++)for(var z,M,F,L=0,$=(z=j[B]).slice();L<$.length;L++)(M=$[L]).res!=null&&g.mutatedParts&&(b&&!M.dirty?(F=Object.isFrozen(M.res),F=ns(M.res,M.req,E,k,M,F),M.dirty?(ee(z,M),M.subscribers.forEach(function(Z){return v.add(Z)})):F!==M.res&&(M.res=F,M.promise=H.resolve({result:F}))):(M.dirty&&ee(z,M),M.subscribers.forEach(function(Z){return v.add(Z)})))}}}v.forEach(function(Z){return Z()})}}},g.addEventListener("abort",l(!1),{signal:p}),g.addEventListener("error",l(!1),{signal:p}),g.addEventListener("complete",l(!0),{signal:p})),g},table:function(a){var u=n.table(a),l=u.schema.primaryKey;return r(r({},u),{mutate:function(f){var p=J.trans;if(l.outbound||p.db._options.cache==="disabled"||p.explicit||p.idbtrans.mode!=="readwrite")return u.mutate(f);var g=Pt["idb://".concat(s,"/").concat(a)];return g?(p=u.mutate(f),f.type!=="add"&&f.type!=="put"||!(50<=f.values.length||Lr(l,f).some(function(b){return b==null}))?(g.optimisticOps.push(f),f.mutatedParts&&zn(f.mutatedParts),p.then(function(b){0<b.numFailures&&(ee(g.optimisticOps,f),(b=ts(0,f,b))&&g.optimisticOps.push(b),f.mutatedParts&&zn(f.mutatedParts))}),p.catch(function(){ee(g.optimisticOps,f),f.mutatedParts&&zn(f.mutatedParts)})):p.then(function(b){var v=ts(0,r(r({},f),{values:f.values.map(function(_,m){var R;return b.failures[m]?_:(_=(R=l.keyPath)!==null&&R!==void 0&&R.includes(".")?U(_):r({},_),Se(_,l.keyPath,b.results[m]),_)})}),b);g.optimisticOps.push(v),queueMicrotask(function(){return f.mutatedParts&&zn(f.mutatedParts)})}),p):u.mutate(f)},query:function(f){if(!Xi(J,u)||!es("query",f))return u.query(f);var p=((v=J.trans)===null||v===void 0?void 0:v.db._options.cache)==="immutable",m=J,g=m.requery,b=m.signal,v=function(k,E,x,P){var A=Pt["idb://".concat(k,"/").concat(E)];if(!A)return[];if(!(E=A.queries[x]))return[null,!1,A,null];var N=E[(P.query?P.query.index.name:null)||""];if(!N)return[null,!1,A,null];switch(x){case"query":var B=N.find(function(j){return j.req.limit===P.limit&&j.req.values===P.values&&rs(j.req.query.range,P.query.range)});return B?[B,!0,A,N]:[N.find(function(j){return("limit"in j.req?j.req.limit:1/0)>=P.limit&&(!P.values||j.req.values)&&Lo(j.req.query.range,P.query.range)}),!1,A,N];case"count":return B=N.find(function(j){return rs(j.req.query.range,P.query.range)}),[B,!!B,A,N]}}(s,a,"query",f),_=v[0],m=v[1],R=v[2],w=v[3];return _&&m?_.obsSet=f.obsSet:(m=u.query(f).then(function(k){var E=k.result;if(_&&(_.res=E),p){for(var x=0,P=E.length;x<P;++x)Object.freeze(E[x]);Object.freeze(E)}else k.result=U(E);return k}).catch(function(k){return w&&_&&ee(w,_),Promise.reject(k)}),_={obsSet:f.obsSet,promise:m,subscribers:new Set,type:"query",req:f,dirty:!1},w?w.push(_):(w=[_],(R=R||(Pt["idb://".concat(s,"/").concat(a)]={queries:{query:{},count:{}},objs:new Map,optimisticOps:[],unsignaledParts:{}})).queries.query[f.query.index.name||""]=w)),Vo(_,w,g,b),_.promise.then(function(k){return{result:ns(k.result,f,R?.optimisticOps,u,_,p)}})}})}})}};function Vn(n,s){return new Proxy(n,{get:function(a,u,l){return u==="db"?s:Reflect.get(a,u,l)}})}var it=(_e.prototype.version=function(n){if(isNaN(n)||n<.1)throw new V.Type("Given version is not a positive number");if(n=Math.round(10*n)/10,this.idbdb||this._state.isBeingOpened)throw new V.Schema("Cannot add version when database is open");this.verno=Math.max(this.verno,n);var s=this._versions,a=s.filter(function(u){return u._cfg.version===n})[0];return a||(a=new this.Version(n),s.push(a),s.sort(Do),a.stores({}),this._state.autoSchema=!1,a)},_e.prototype._whenReady=function(n){var s=this;return this.idbdb&&(this._state.openComplete||J.letThrough||this._vip)?n():new H(function(a,u){if(s._state.openComplete)return u(new V.DatabaseClosed(s._state.dbOpenError));if(!s._state.isBeingOpened){if(!s._state.autoOpen)return void u(new V.DatabaseClosed);s.open().catch(pe)}s._state.dbReadyPromise.then(a,u)}).then(n)},_e.prototype.use=function(n){var s=n.stack,a=n.create,u=n.level,l=n.name;return l&&this.unuse({stack:s,name:l}),n=this._middlewares[s]||(this._middlewares[s]=[]),n.push({stack:s,create:a,level:u??10,name:l}),n.sort(function(f,p){return f.level-p.level}),this},_e.prototype.unuse=function(n){var s=n.stack,a=n.name,u=n.create;return s&&this._middlewares[s]&&(this._middlewares[s]=this._middlewares[s].filter(function(l){return u?l.create!==u:!!a&&l.name!==a})),this},_e.prototype.open=function(){var n=this;return St(ct,function(){return Mo(n)})},_e.prototype._close=function(){this.on.close.fire(new CustomEvent("close"));var n=this._state,s=zt.indexOf(this);if(0<=s&&zt.splice(s,1),this.idbdb){try{this.idbdb.close()}catch{}this.idbdb=null}n.isBeingOpened||(n.dbReadyPromise=new H(function(a){n.dbReadyResolve=a}),n.openCanceller=new H(function(a,u){n.cancelOpen=u}))},_e.prototype.close=function(a){var s=(a===void 0?{disableAutoOpen:!0}:a).disableAutoOpen,a=this._state;s?(a.isBeingOpened&&a.cancelOpen(new V.DatabaseClosed),this._close(),a.autoOpen=!1,a.dbOpenError=new V.DatabaseClosed):(this._close(),a.autoOpen=this._options.autoOpen||a.isBeingOpened,a.openComplete=!1,a.dbOpenError=null)},_e.prototype.delete=function(n){var s=this;n===void 0&&(n={disableAutoOpen:!0});var a=0<arguments.length&&typeof arguments[0]!="object",u=this._state;return new H(function(l,f){function p(){s.close(n);var g=s._deps.indexedDB.deleteDatabase(s.name);g.onsuccess=we(function(){var b,v,_;b=s._deps,v=s.name,_=b.indexedDB,b=b.IDBKeyRange,Dr(_)||v===In||Br(_,b).delete(v).catch(pe),l()}),g.onerror=Je(f),g.onblocked=s._fireOnBlocked}if(a)throw new V.InvalidArgument("Invalid closeOptions argument to db.delete()");u.isBeingOpened?u.dbReadyPromise.then(p):p()})},_e.prototype.backendDB=function(){return this.idbdb},_e.prototype.isOpen=function(){return this.idbdb!==null},_e.prototype.hasBeenClosed=function(){var n=this._state.dbOpenError;return n&&n.name==="DatabaseClosed"},_e.prototype.hasFailed=function(){return this._state.dbOpenError!==null},_e.prototype.dynamicallyOpened=function(){return this._state.autoSchema},Object.defineProperty(_e.prototype,"tables",{get:function(){var n=this;return h(this._allTables).map(function(s){return n._allTables[s]})},enumerable:!1,configurable:!0}),_e.prototype.transaction=function(){var n=function(s,a,u){var l=arguments.length;if(l<2)throw new V.InvalidArgument("Too few arguments");for(var f=new Array(l-1);--l;)f[l-1]=arguments[l];return u=f.pop(),[s,vt(f),u]}.apply(this,arguments);return this._transaction.apply(this,n)},_e.prototype._transaction=function(n,s,a){var u=this,l=J.trans;l&&l.db===this&&n.indexOf("!")===-1||(l=null);var f,p,g=n.indexOf("?")!==-1;n=n.replace("!","").replace("?","");try{if(p=s.map(function(v){if(v=v instanceof u.Table?v.name:v,typeof v!="string")throw new TypeError("Invalid table argument to Dexie.transaction(). Only Table or String are allowed");return v}),n=="r"||n===_r)f=_r;else{if(n!="rw"&&n!=xr)throw new V.InvalidArgument("Invalid transaction mode: "+n);f=xr}if(l){if(l.mode===_r&&f===xr){if(!g)throw new V.SubTransaction("Cannot enter a sub-transaction with READWRITE mode when parent transaction is READONLY");l=null}l&&p.forEach(function(v){if(l&&l.storeNames.indexOf(v)===-1){if(!g)throw new V.SubTransaction("Table "+v+" not included in parent transaction.");l=null}}),g&&l&&!l.active&&(l=null)}}catch(v){return l?l._promise(null,function(_,m){m(v)}):Ee(v)}var b=function v(_,m,R,w,k){return H.resolve().then(function(){var E=J.transless||J,x=_._createTransaction(m,R,_._dbSchema,w);if(x.explicit=!0,E={trans:x,transless:E},w)x.idbtrans=w.idbtrans;else try{x.create(),x.idbtrans._explicit=!0,_._state.PR1398_maxLoop=3}catch(N){return N.name===ke.InvalidState&&_.isOpen()&&0<--_._state.PR1398_maxLoop?(console.warn("Dexie: Need to reopen db"),_.close({disableAutoOpen:!1}),_.open().then(function(){return v(_,m,R,null,k)})):Ee(N)}var P,A=te(k);return A&&$t(),E=H.follow(function(){var N;(P=k.call(x,x))&&(A?(N=ht.bind(null,null),P.then(N,N)):typeof P.next=="function"&&typeof P.throw=="function"&&(P=$r(P)))},E),(P&&typeof P.then=="function"?H.resolve(P).then(function(N){return x.active?N:Ee(new V.PrematureCommit("Transaction committed too early. See http://bit.ly/2kdckMn"))}):E.then(function(){return P})).then(function(N){return w&&x._resolve(),x._completion.then(function(){return N})}).catch(function(N){return x._reject(N),Ee(N)})})}.bind(null,this,f,p,l,a);return l?l._promise(f,b,"lock"):J.trans?St(J.transless,function(){return u._whenReady(b)}):this._whenReady(b)},_e.prototype.table=function(n){if(!C(this._allTables,n))throw new V.InvalidTable("Table ".concat(n," does not exist"));return this._allTables[n]},_e);function _e(n,s){var a=this;this._middlewares={},this.verno=0;var u=_e.dependencies;this._options=s=r({addons:_e.addons,autoOpen:!0,indexedDB:u.indexedDB,IDBKeyRange:u.IDBKeyRange,cache:"cloned"},s),this._deps={indexedDB:s.indexedDB,IDBKeyRange:s.IDBKeyRange},u=s.addons,this._dbSchema={},this._versions=[],this._storeNames=[],this._allTables={},this.idbdb=null,this._novip=this;var l,f,p,g,b,v={dbOpenError:null,isBeingOpened:!1,onReadyBeingFired:null,openComplete:!1,dbReadyResolve:pe,dbReadyPromise:null,cancelOpen:pe,openCanceller:null,autoSchema:!0,PR1398_maxLoop:3,autoOpen:s.autoOpen};v.dbReadyPromise=new H(function(m){v.dbReadyResolve=m}),v.openCanceller=new H(function(m,R){v.cancelOpen=R}),this._state=v,this.name=n,this.on=an(this,"populate","blocked","versionchange","close",{ready:[pr,pe]}),this.once=function(m,R){var w=function(){for(var k=[],E=0;E<arguments.length;E++)k[E]=arguments[E];a.on(m).unsubscribe(w),R.apply(a,k)};return a.on(m,w)},this.on.ready.subscribe=me(this.on.ready.subscribe,function(m){return function(R,w){_e.vip(function(){var k,E=a._state;E.openComplete?(E.dbOpenError||H.resolve().then(R),w&&m(R)):E.onReadyBeingFired?(E.onReadyBeingFired.push(R),w&&m(R)):(m(R),k=a,w||m(function x(){k.on.ready.unsubscribe(R),k.on.ready.unsubscribe(x)}))})}}),this.Collection=(l=this,un(Po.prototype,function(P,x){this.db=l;var w=Ni,k=null;if(x)try{w=x()}catch(A){k=A}var E=P._ctx,x=E.table,P=x.hook.reading.fire;this._ctx={table:x,index:E.index,isPrimKey:!E.index||x.schema.primKey.keyPath&&E.index===x.schema.primKey.name,range:w,keysOnly:!1,dir:"next",unique:"",algorithm:null,filter:null,replayFilter:null,justLimit:!0,isMatch:null,offset:0,limit:1/0,error:k,or:E.or,valueMapper:P!==ut?P:null}})),this.Table=(f=this,un(qi.prototype,function(m,R,w){this.db=f,this._tx=w,this.name=m,this.schema=R,this.hook=f._allTables[m]?f._allTables[m].hook:an(null,{creating:[vo,pe],reading:[bo,ut],updating:[ko,pe],deleting:[wo,pe]})})),this.Transaction=(p=this,un(Oo.prototype,function(m,R,w,k,E){var x=this;m!=="readonly"&&R.forEach(function(P){P=(P=w[P])===null||P===void 0?void 0:P.yProps,P&&(R=R.concat(P.map(function(A){return A.updatesTable})))}),this.db=p,this.mode=m,this.storeNames=R,this.schema=w,this.chromeTransactionDurability=k,this.idbtrans=null,this.on=an(this,"complete","error","abort"),this.parent=E||null,this.active=!0,this._reculock=0,this._blockedFuncs=[],this._resolve=null,this._reject=null,this._waitingFor=null,this._waitingQueue=null,this._spinCount=0,this._completion=new H(function(P,A){x._resolve=P,x._reject=A}),this._completion.then(function(){x.active=!1,x.on.complete.fire()},function(P){var A=x.active;return x.active=!1,x.on.error.fire(P),x.parent?x.parent._reject(P):A&&x.idbtrans&&x.idbtrans.abort(),Ee(P)})})),this.Version=(g=this,un(qo.prototype,function(m){this.db=g,this._cfg={version:m,storesSource:null,dbschema:{},tables:{},contentUpgrade:null}})),this.WhereClause=(b=this,un(zi.prototype,function(m,R,w){if(this.db=b,this._ctx={table:m,index:R===":id"?null:R,or:w},this._cmp=this._ascending=fe,this._descending=function(k,E){return fe(E,k)},this._max=function(k,E){return 0<fe(k,E)?k:E},this._min=function(k,E){return fe(k,E)<0?k:E},this._IDBKeyRange=b._deps.IDBKeyRange,!this._IDBKeyRange)throw new V.MissingAPI})),this.on("versionchange",function(m){0<m.newVersion?console.warn("Another connection wants to upgrade database '".concat(a.name,"'. Closing db now to resume the upgrade.")):console.warn("Another connection wants to delete database '".concat(a.name,"'. Closing db now to resume the delete request.")),a.close({disableAutoOpen:!1})}),this.on("blocked",function(m){!m.newVersion||m.newVersion<m.oldVersion?console.warn("Dexie.delete('".concat(a.name,"') was blocked")):console.warn("Upgrade '".concat(a.name,"' blocked by other connection holding version ").concat(m.oldVersion/10))}),this._maxKey=hn(s.IDBKeyRange),this._createTransaction=function(m,R,w,k){return new a.Transaction(m,R,w,a._options.chromeTransactionDurability,k)},this._fireOnBlocked=function(m){a.on("blocked").fire(m),zt.filter(function(R){return R.name===a.name&&R!==a&&!R._state.vcFired}).map(function(R){return R.on("versionchange").fire(m)})},this.use($o),this.use(Ho),this.use(zo),this.use(jo),this.use(Fo);var _=new Proxy(this,{get:function(m,R,w){if(R==="_vip")return!0;if(R==="table")return function(E){return Vn(a.table(E),_)};var k=Reflect.get(m,R,w);return k instanceof qi?Vn(k,_):R==="tables"?k.map(function(E){return Vn(E,_)}):R==="_createTransaction"?function(){return Vn(k.apply(this,arguments),_)}:k}});this.vip=_,u.forEach(function(m){return m(a)})}var Hn,ze=typeof Symbol<"u"&&"observable"in Symbol?Symbol.observable:"@@observable",Wo=(Hr.prototype.subscribe=function(n,s,a){return this._subscribe(n&&typeof n!="function"?n:{next:n,error:s,complete:a})},Hr.prototype[ze]=function(){return this},Hr);function Hr(n){this._subscribe=n}try{Hn={indexedDB:c.indexedDB||c.mozIndexedDB||c.webkitIndexedDB||c.msIndexedDB,IDBKeyRange:c.IDBKeyRange||c.webkitIDBKeyRange}}catch{Hn={indexedDB:null,IDBKeyRange:null}}function is(n){var s,a=!1,u=new Wo(function(l){var f=te(n),p,g=!1,b={},v={},_={get closed(){return g},unsubscribe:function(){g||(g=!0,p&&p.abort(),m&&pt.storagemutated.unsubscribe(w))}};l.start&&l.start(_);var m=!1,R=function(){return Er(k)},w=function(E){$n(b,E),qr(v,b)&&R()},k=function(){var E,x,P;!g&&Hn.indexedDB&&(b={},E={},p&&p.abort(),p=new AbortController,P=function(A){var N=jt();try{f&&$t();var B=lt(n,A);return B=f?B.finally(ht):B}finally{N&&Ft()}}(x={subscr:E,signal:p.signal,requery:R,querier:n,trans:null}),Promise.resolve(P).then(function(A){a=!0,s=A,g||x.signal.aborted||(b={},function(N){for(var B in N)if(C(N,B))return;return 1}(v=E)||m||(pt(ln,w),m=!0),Er(function(){return!g&&l.next&&l.next(A)}))},function(A){a=!1,["DatabaseClosedError","AbortError"].includes(A?.name)||g||Er(function(){g||l.error&&l.error(A)})}))};return setTimeout(R,0),_});return u.hasValue=function(){return a},u.getValue=function(){return s},u}var At=it;function Wr(n){var s=yt;try{yt=!0,pt.storagemutated.fire(n),Fr(n,!0)}finally{yt=s}}T(At,r(r({},nt),{delete:function(n){return new At(n,{addons:[]}).delete()},exists:function(n){return new At(n,{addons:[]}).open().then(function(s){return s.close(),!0}).catch("NoSuchDatabaseError",function(){return!1})},getDatabaseNames:function(n){try{return s=At.dependencies,a=s.indexedDB,s=s.IDBKeyRange,(Dr(a)?Promise.resolve(a.databases()).then(function(u){return u.map(function(l){return l.name}).filter(function(l){return l!==In})}):Br(a,s).toCollection().primaryKeys()).then(n)}catch{return Ee(new V.MissingAPI)}var s,a},defineClass:function(){return function(n){y(this,n)}},ignoreTransaction:function(n){return J.trans?St(J.transless,n):n()},vip:Kr,async:function(n){return function(){try{var s=$r(n.apply(this,arguments));return s&&typeof s.then=="function"?s:H.resolve(s)}catch(a){return Ee(a)}}},spawn:function(n,s,a){try{var u=$r(n.apply(a,s||[]));return u&&typeof u.then=="function"?u:H.resolve(u)}catch(l){return Ee(l)}},currentTransaction:{get:function(){return J.trans||null}},waitFor:function(n,s){return s=H.resolve(typeof n=="function"?At.ignoreTransaction(n):n).timeout(s||6e4),J.trans?J.trans.waitFor(s):s},Promise:H,debug:{get:function(){return Ge},set:function(n){Si(n)}},derive:Y,extend:y,props:T,override:me,Events:an,on:pt,liveQuery:is,extendObservabilitySet:$n,getByKeyPath:Ie,setByKeyPath:Se,delByKeyPath:function(n,s){typeof s=="string"?Se(n,s,void 0):"length"in s&&[].map.call(s,function(a){Se(n,a,void 0)})},shallowClone:tt,deepClone:U,getObjectDiff:zr,cmp:fe,asap:He,minKey:-1/0,addons:[],connections:zt,errnames:ke,dependencies:Hn,cache:Pt,semVer:"4.2.1",version:"4.2.1".split(".").map(function(n){return parseInt(n)}).reduce(function(n,s,a){return n+s/Math.pow(10,2*a)})})),At.maxKey=hn(At.dependencies.IDBKeyRange),typeof dispatchEvent<"u"&&typeof addEventListener<"u"&&(pt(ln,function(n){yt||(n=new CustomEvent(Tr,{detail:n}),yt=!0,dispatchEvent(n),yt=!1)}),addEventListener(Tr,function(n){n=n.detail,yt||Wr(n)}));var Wt,yt=!1,ss=function(){};return typeof BroadcastChannel<"u"&&((ss=function(){(Wt=new BroadcastChannel(Tr)).onmessage=function(n){return n.data&&Wr(n.data)}})(),typeof Wt.unref=="function"&&Wt.unref(),pt(ln,function(n){yt||Wt.postMessage(n)})),typeof addEventListener<"u"&&(addEventListener("pagehide",function(n){if(!it.disableBfCache&&n.persisted){Ge&&console.debug("Dexie: handling persisted pagehide"),Wt?.close();for(var s=0,a=zt;s<a.length;s++)a[s].close({disableAutoOpen:!1})}}),addEventListener("pageshow",function(n){!it.disableBfCache&&n.persisted&&(Ge&&console.debug("Dexie: handling persisted pageshow"),ss(),Wr({all:new Ne(-1/0,[[]])}))})),H.rejectionMapper=function(n,s){return!n||n instanceof be||n instanceof TypeError||n instanceof SyntaxError||!n.name||!Re[n.name]?n:(s=new Re[n.name](s||n.message,n),"stack"in n&&K(s,"stack",{get:function(){return this.inner.stack}}),s)},Si(Ge),r(it,Object.freeze({__proto__:null,Dexie:it,liveQuery:is,Entity:Ci,cmp:fe,PropModification:on,replacePrefix:function(n,s){return new on({replacePrefix:[n,s]})},add:function(n){return new on({add:n})},remove:function(n){return new on({remove:n})},default:it,RangeSet:Ne,mergeRanges:pn,rangesOverlap:Yi}),{default:it}),it})})(mo);var vc=mo.exports;const yi=Go(vc),xs=Symbol.for("Dexie"),cr=globalThis[xs]||(globalThis[xs]=yi);if(yi.semVer!==cr.semVer)throw new Error(`Two different versions of Dexie loaded in the same app: ${yi.semVer} and ${cr.semVer}`);const{liveQuery:Jc,mergeRanges:Qc,rangesOverlap:Xc,RangeSet:el,cmp:tl,Entity:nl,PropModification:rl,replacePrefix:il,add:sl,remove:ol,DexieYProvider:al}=cr;async function wc(t,e){const i=await e.limit(t.maxSize).toArray();for(const r of i)t.add(r.tagValue,r.eventId,!1)}var kc=(t,e)=>async(i,r)=>{const o=[];for(const c of i){const h=r.get(c);if(h)for(const d of h)o.push({tagValue:c,eventId:d})}o.length>0&&(e(`Saving ${o.length} events cache entries to database`),await t.bulkPut(o)),i.clear()};async function Ec(t,e){const i=await e.limit(t.maxSize).toArray();for(const r of i)t.set(r.id,r,!1)}var _c=(t,e)=>async(i,r)=>{const o=[];for(const c of i){const h=r.get(c);h&&o.push(h)}o.length>0&&(e(`Saving ${o.length} events cache entries to database`),await t.bulkPut(o)),i.clear()};async function xc(t,e){const i=await e.limit(t.maxSize).toArray();for(const r of i)t.set(r.nip05,r,!1)}var Sc=(t,e)=>async(i,r)=>{const o=[];for(const c of i){const h=r.get(c);h&&o.push({nip05:c,...h})}o.length&&(e(`Saving ${o.length} NIP-05 cache entries to database`),await t.bulkPut(o)),i.clear()},Rc=class extends cr{profiles;events;eventTags;nip05;lnurl;relayStatus;unpublishedEvents;constructor(t){super(t),this.version(15).stores({profiles:"&pubkey",events:"&id, kind",eventTags:"&tagValue",nip05:"&nip05",lnurl:"&pubkey",relayStatus:"&url",unpublishedEvents:"&id"})}},xe;function Tc(t){xe=new Rc(t)}var Pc=Ye("ndk:dexie-adapter:profiles");async function Ac(t,e){const i=await e.limit(t.maxSize).toArray();for(const r of i){const o=r;t.set(r.pubkey,o,!1)}Pc("Loaded %d profiles from database",t.size())}var Ic=(t,e)=>async(i,r)=>{const o=[];for(const c of i){const h=r.get(c);h&&o.push(h)}o.length&&(e(`Saving ${o.length} users to database`),await t.bulkPut(o)),i.clear()};async function Oc(t,e){const i=await e.limit(t.maxSize).toArray();for(const r of i)t.set(r.url,{url:r.url,updatedAt:r.updatedAt,lastConnectedAt:r.lastConnectedAt,dontConnectBefore:r.dontConnectBefore},!1)}var Nc=(t,e)=>async(i,r)=>{const o=[];for(const c of i){const h=r.get(c);h&&o.push({url:c,updatedAt:h.updatedAt,lastConnectedAt:h.lastConnectedAt,dontConnectBefore:h.dontConnectBefore})}o.length>0&&(e(`Saving ${o.length} relay status cache entries to database`),await t.bulkPut(o)),i.clear()},Cc=3;async function Bc(t,e){await e.each(i=>{t.set(i.event.id,i,!1)})}function Dc(t,e){return async(i,r)=>{const o=[];for(const c of i){const h=r.get(c);h&&o.push(h)}o.length>0&&(e(`Saving ${o.length} unpublished events cache entries to database`),await t.bulkPut(o)),i.clear()}}async function Kc(t,e){await t.delete(e)}async function Uc(t){const e=[];return await t.each(i=>{e.push({event:new Ue(void 0,i.event),relays:Object.keys(i.relays),lastTryAt:i.lastTryAt})}),e}function qc(t,e){const i={};e.forEach(o=>i[o]=!1),this.unpublishedEvents.set(t.id,{id:t.id,event:t.rawEvent(),relays:i});const r=o=>{const c=o.url,h=this.unpublishedEvents.get(t.id);if(!h){t.off("publushed",r);return}h.relays[c]=!0,this.unpublishedEvents.set(t.id,h);const d=Object.values(h.relays).filter(S=>S).length,y=Object.values(h.relays).length-d;(d>=Cc||y===0)&&(this.unpublishedEvents.delete(t.id),t.off("published",r))};t.on("published",r)}async function Mc(t,e){const i=await e.limit(t.maxSize).toArray();for(const r of i)t.set(r.pubkey,{document:r.document,fetchedAt:r.fetchedAt},!1)}var jc=(t,e)=>async(i,r)=>{const o=[];for(const c of i){const h=r.get(c);h&&o.push({pubkey:c,...h})}o.length&&(e(`Saving ${o.length} zapper cache entries to database`),await t.bulkPut(o)),i.clear()},Ot=class{cache;dirtyKeys=new Set;options;debug;indexes;isSet=!1;maxSize=0;constructor(t){this.debug=t.debug,this.options=t,this.maxSize=t.maxSize,t.maxSize>0&&(this.cache=new oi.LRUCache({maxSize:t.maxSize}),setInterval(()=>this.dump().catch(console.error),1e3*10)),this.indexes=new Map}getSet(t){return this.cache?.get(t)}getAllWithFilter(t){const e=new Map;return this.cache?.forEach((i,r)=>{t(r,i)&&e.set(r,i)}),e}get(t){return this.cache?.get(t)}async getWithFallback(t,e){let i=this.get(t);return i||(i=await e.get(t),i&&this.set(t,i)),i}async getManyWithFallback(t,e){const i=[],r=[];for(const o of t){const c=this.get(o);c?i.push(c):r.push(o)}if(i.length>0&&this.debug(`Cache hit for keys ${i.length} and miss for ${r.length} keys`),r.length>0){const o=Date.now(),c=await e.bulkGet(r),h=Date.now();let d=0;for(const y of c)y&&(this.set(y.id,y),i.push(y),d++);this.debug(`Time spent querying database: ${h-o}ms for ${r.length} keys, which added ${d} entries to the cache`)}return i}add(t,e,i=!0){const r=this.get(t)??new Set;r.add(e),this.cache?.set(t,r),i&&this.dirtyKeys.add(t)}set(t,e,i=!0){this.cache?.set(t,e),i&&this.dirtyKeys.add(t);for(const[r,o]of this.indexes.entries()){const c=e[r];if(c){const h=o.get(c)||new Set;h.add(t),o.set(c,h)}}}size(){return this.cache?.size||0}delete(t){this.cache?.delete(t),this.dirtyKeys.add(t)}async dump(){this.dirtyKeys.size>0&&this.cache&&(await this.options.dump(this.dirtyKeys,this.cache),this.dirtyKeys.clear())}addIndex(t){this.indexes.set(t,new oi.LRUCache({maxSize:this.options.maxSize}))}getFromIndex(t,e){const i=new Set,r=this.indexes.get(t);if(r){const o=r.get(e);if(o)for(const c of o.values()){const h=this.get(c);h&&i.add(h)}}return i}},Fc=10,$c=class{debug;locking=!1;ready=!1;profiles;zappers;nip05s;events;eventTags;relayInfo;unpublishedEvents;warmedUp=!1;warmUpPromise;devMode=!1;saveSig;_onReady;constructor(t={}){Tc(t.dbName||"ndk"),this.debug=t.debug||Ye("ndk:dexie-adapter"),this.saveSig=t.saveSig||!1,this.profiles=new Ot({maxSize:t.profileCacheSize||1e5,dump:Ic(xe.profiles,this.debug),debug:this.debug}),this.zappers=new Ot({maxSize:t.zapperCacheSize||200,dump:jc(xe.lnurl,this.debug),debug:this.debug}),this.nip05s=new Ot({maxSize:t.nip05CacheSize||1e3,dump:Sc(xe.nip05,this.debug),debug:this.debug}),this.events=new Ot({maxSize:t.eventCacheSize||5e4,dump:_c(xe.events,this.debug),debug:this.debug}),this.events.addIndex("pubkey"),this.events.addIndex("kind"),this.eventTags=new Ot({maxSize:t.eventTagsCacheSize||1e5,dump:kc(xe.eventTags,this.debug),debug:this.debug}),this.relayInfo=new Ot({maxSize:500,debug:this.debug,dump:Nc(xe.relayStatus,this.debug)}),this.unpublishedEvents=new Ot({maxSize:5e3,debug:this.debug,dump:Dc(xe.unpublishedEvents,this.debug)});const e=(r,o)=>{const c=Date.now();return o().then(()=>{const h=Date.now();this.debug(r,"took",h-c,"ms")})},i=Date.now();this.warmUpPromise=Promise.allSettled([e("profilesWarmUp",()=>Ac(this.profiles,xe.profiles)),e("zapperWarmUp",()=>Mc(this.zappers,xe.lnurl)),e("nip05WarmUp",()=>xc(this.nip05s,xe.nip05)),e("relayInfoWarmUp",()=>Oc(this.relayInfo,xe.relayStatus)),e("unpublishedEventsWarmUp",()=>Bc(this.unpublishedEvents,xe.unpublishedEvents)),e("eventsWarmUp",()=>Ec(this.events,xe.events)),e("eventTagsWarmUp",()=>wc(this.eventTags,xe.eventTags))]),this.warmUpPromise.then(()=>{const r=Date.now();this.warmedUp=!0,this.ready=!0,this.locking=!0,this.debug("Warm up completed, time",r-i,"ms"),this._onReady&&this._onReady()})}onReady(t){this._onReady=t}async query(t){if(!this.warmedUp){const r=Date.now();await this.warmUpPromise,this.debug("froze query for",Date.now()-r,"ms",t.filters)}const e=Date.now();t.filters.map(r=>this.processFilter(r,t));const i=Date.now()-e;return i>100&&this.debug("query took",i,"ms",t.filter),[]}async fetchProfile(t){return this.profiles?await this.profiles.getWithFallback(t,xe.profiles):null}fetchProfileSync(t){return this.profiles?this.profiles.get(t):null}async getProfiles(t){if(this.profiles)return this.profiles.getAllWithFilter(t)}saveProfile(t,e){const i=this.profiles.get(t);if(i?.created_at&&e.created_at&&i.created_at>=e.created_at)return;const r=Math.floor(Date.now()/1e3);this.profiles.set(t,{pubkey:t,...e,cachedAt:r}),this.debug("Saved profile for pubkey",t,e)}async loadNip05(t,e=3600){const i=this.nip05s?.get(t);if(i){if(i.profile===null)return i.fetchedAt+e*1e3<Date.now()?"missing":null;try{return JSON.parse(i.profile)}catch{return"missing"}}const r=await xe.nip05.get({nip05:t});if(!r)return"missing";const o=Date.now();if(r.profile===null)return r.fetchedAt+e*1e3<o?"missing":null;try{return JSON.parse(r.profile)}catch{return"missing"}}async saveNip05(t,e){try{const i=e?JSON.stringify(e):null;this.nip05s.set(t,{profile:i,fetchedAt:Date.now()})}catch(i){console.error("Failed to save NIP-05 profile for nip05:",t,i)}}async loadUsersLNURLDoc(t,e=86400,i=3600){const r=this.zappers?.get(t);if(r){if(r.document===null)return r.fetchedAt+i*1e3<Date.now()?"missing":null;try{return JSON.parse(r.document)}catch{return"missing"}}const o=await xe.lnurl.get({pubkey:t});if(!o)return"missing";const c=Date.now();if(o.fetchedAt+e*1e3<c)return"missing";if(o.document===null)return o.fetchedAt+i*1e3<c?"missing":null;try{return JSON.parse(o.document)}catch{return"missing"}}async saveUsersLNURLDoc(t,e){try{const i=e?JSON.stringify(e):null;this.zappers?.set(t,{document:i,fetchedAt:Date.now()})}catch(i){console.error("Failed to save LNURL document for pubkey:",t,i)}}processFilter(t,e){const i={...t};i.limit=void 0;const r=new Set(Object.keys(i||{}));r.delete("since"),r.delete("limit"),r.delete("until");try{if(this.byNip33Query(r,t,e)||this.byAuthors(t,e)||this.byIdsQuery(t,e)||this.byTags(t,e)||this.byKinds(r,t,e))return}catch(o){console.error(o)}}async deleteEventIds(t){t.forEach(e=>this.events.delete(e)),await xe.events.where({id:t}).delete()}addUnpublishedEvent=qc.bind(this);getUnpublishedEvents=()=>Uc(xe.unpublishedEvents);discardUnpublishedEvent=t=>Kc(xe.unpublishedEvents,t);async setEvent(t,e,i){if(t.kind===0){if(!this.profiles)return;try{const o=po(t);this.saveProfile(t.pubkey,o)}catch{this.debug(`Failed to save profile for pubkey: ${t.pubkey}`)}}let r=!0;if(t.isParamReplaceable()){const o=this.events.get(t.tagId());o&&t.created_at&&o.createdAt>t.created_at&&(r=!1)}if(r){const o={id:t.tagId(),pubkey:t.pubkey,kind:t.kind,createdAt:t.created_at??Date.now(),relay:i?.url,event:t.serialize(this.saveSig,!0)};this.saveSig&&t.sig&&(o.sig=t.sig),this.events.set(t.tagId(),o);const c=Lc(t);for(const h of c)this.eventTags.add(h[0]+h[1],t.tagId())}}updateRelayStatus(t,e){const i={url:t,updatedAt:Date.now(),...e};this.relayInfo.set(t,i)}getRelayStatus(t){const e=this.relayInfo.get(t);if(e)return{lastConnectedAt:e.lastConnectedAt,dontConnectBefore:e.dontConnectBefore}}byAuthors(t,e){if(!t.authors)return!1;let i=0;for(const r of t.authors){let o=Array.from(this.events.getFromIndex("pubkey",r));t.kinds&&(o=o.filter(c=>t.kinds?.includes(c.kind))),zc(e,o,t),i+=o.length}return!0}byIdsQuery(t,e){if(t.ids){for(const i of t.ids){const r=this.events.get(i);r&&gn(e,r,r.relay,t)}return!0}return!1}byNip33Query(t,e,i){const r=["#d","authors","kinds"];if(t.size===r.length&&r.every(c=>t.has(c))&&e.kinds&&e.authors){for(const c of e.kinds)if(c>=3e4&&c<4e4)for(const d of e.authors)for(const y of e["#d"]){const S=`${c}:${d}:${y}`,I=this.events.get(S);I&&gn(i,I,I.relay,e)}return!0}return!1}byTags(t,e){const i=Object.entries(t).filter(([r])=>r.startsWith("#")&&r.length===2).map(([r,o])=>[r[1],o]);if(i.length===0)return!1;for(const[r,o]of i)for(const c of o){const h=r+c,d=this.eventTags.getSet(h);d&&d.forEach(y=>{const S=this.events.get(y);S&&(!t.kinds||t.kinds.includes(S.kind))&&gn(e,S,S.relay,t)})}return!0}byKinds(t,e,i){if(!e.kinds||t.size!==1||!t.has("kinds"))return!1;const r=e.limit||500;let o=0;const c=new Set,h=[...e.kinds].sort((d,y)=>(this.events.indexes.get("kind")?.get(d)?.size||0)-(this.events.indexes.get("kind")?.get(y)?.size||0));for(const d of h){const y=this.events.getFromIndex("kind",d);for(const S of y)if(!c.has(S.id)&&(c.add(S.id),gn(i,S,S.relay,e),o++,o>=r))break;if(o>=r)break}return!0}};function zc(t,e,i){i?.limit&&e.length>i.limit&&(e=e.sort((r,o)=>o.createdAt-r.createdAt).slice(0,i.limit));for(const r of e)gn(t,r,r.relay,i)}function gn(t,e,i,r){try{const o=lo(e.event);if(r&&!ta(r,o))return;const c=new Ue(void 0,o),h=i?t.pool.getRelay(i,!1):void 0;c.relay=h,t.eventReceived(c,h,!0)}catch(o){console.error("failed to deserialize event",o)}}function Lc(t){const e=[];if(t.kind===3)return[];for(const i of t.tags)if(i[0].length===1&&(e.push(i),e.length>=Fc))return[];return e}const Vc=["wss://relay.damus.io","wss://relay.nostr.band","wss://nos.lol"];let si=null;function Hc(){if(!si){const t=new $c({dbName:"fairfield-nostr-cache"});si=new Jo({explicitRelayUrls:Vc,cacheAdapter:t})}return si}const ul=Hc();export{lr as c,ul as n};
//# sourceMappingURL=BN_xWD1A.js.map
