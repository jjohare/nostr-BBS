import{w as writable}from"./DZvjUGcz.js";import{W as get_store_value}from"./KqBazuOQ.js";import{c as createView$2,a as assert,b as checkOpts,t as toBytes$2,h as hmac$2,u as u32,s as sha256$4,r as randomBytes$2,x as xchacha20poly1305,d as concatBytes$2,e as bech32$1,f as bytesToHex$2,i as hexToBytes$2,n as nip19_exports$2,m as matchFilters,g as getPublicKey,j as generateSecretKey,k as finalizeEvent,l as nip44_exports,o as nip04_exports,p as matchFilter}from"./BBVPoPpa.js";const KIND_GROUP_METADATA=39e3,KIND_GROUP_MEMBERS=39002,KIND_JOIN_REQUEST=9021,initialState={channels:[],loading:!1,error:null,currentChannel:null},{subscribe,set,update}=writable(initialState);async function fetchChannels(n,e,t){update(r=>({...r,loading:!0,error:null}));try{const r={kinds:[KIND_GROUP_METADATA]},s=await n.fetchEvents(r),i=Array.from(s),a={kinds:[KIND_GROUP_MEMBERS]},u=await n.fetchEvents(a),l=Array.from(u),p={kinds:[KIND_JOIN_REQUEST],authors:[e]},g=await n.fetchEvents(p),v=Array.from(g),m=[];for(const w of i){const T=buildChannelFromEvents(w,l,v,e,t);T&&m.push(T)}return update(w=>({...w,channels:m,loading:!1,error:null})),m}catch(r){const s=r instanceof Error?r.message:"Failed to fetch channels";throw update(i=>({...i,loading:!1,error:s})),r}}function buildChannelFromEvents(n,e,t,r,s){const i=n.tags.find(X=>X[0]==="d")?.[1];if(!i)return null;const a=n.tags.filter(X=>X[0]==="cohort").map(X=>X[1]);if(!a.some(X=>s.includes(X))&&a.length>0)return null;let l={};try{l=JSON.parse(n.content)}catch{l={}}const g=e.find(X=>X.tags.find(ne=>ne[0]==="d")?.[1]===i)?.tags.filter(X=>X[0]==="p").map(X=>X[1])||[],v=g.length,m=g.includes(r),w=t.some(X=>X.tags.find(ne=>ne[0]==="h")?.[1]===i),P=n.tags.find(X=>X[0]==="visibility")?.[1]||"listed",W=n.tags.some(X=>X[0]==="encrypted");return!m&&P==="unlisted"?null:{id:i,name:l.name||"Unnamed Channel",description:l.about||"",picture:l.picture,cohorts:a,visibility:P,isEncrypted:W,memberCount:v,createdAt:n.created_at||0,isMember:m,hasRequestPending:w}}function setCurrentChannel(n){update(e=>({...e,currentChannel:n}))}function getCurrentChannel(){return get_store_value(channelStore).currentChannel}function getChannelsByCohort(n){return get_store_value(channelStore).channels.filter(t=>t.cohorts.includes(n))}function clearChannels(){set(initialState)}function updateChannel(n,e){update(t=>({...t,channels:t.channels.map(r=>r.id===n?{...r,...e}:r)}))}function removeChannel(n){update(e=>({...e,channels:e.channels.filter(t=>t.id!==n),currentChannel:e.currentChannel?.id===n?null:e.currentChannel}))}const channelStore={subscribe,set,update,fetchChannels,setCurrentChannel,getCurrentChannel,getChannelsByCohort,clearChannels,updateChannel,removeChannel};var commonjsGlobal=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function getDefaultExportFromCjs(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var lib$1={},types={};Object.defineProperty(types,"__esModule",{value:!0});var ee={},taskCollection$1={},taskCollection={},utils$1={};Object.defineProperty(utils$1,"__esModule",{value:!0});utils$1._fast_remove_single=void 0;function _fast_remove_single(n,e){e!==-1&&(e===0?n.shift():e===n.length-1?n.length=n.length-1:n.splice(e,1))}utils$1._fast_remove_single=_fast_remove_single;var bakeCollection={};(function(exports$1){Object.defineProperty(exports$1,"__esModule",{value:!0}),exports$1.bakeCollectionVariadic=exports$1.bakeCollectionAwait=exports$1.bakeCollection=exports$1.BAKED_EMPTY_FUNC=void 0,exports$1.BAKED_EMPTY_FUNC=function(){};var FORLOOP_FALLBACK=1500;function generateArgsDefCode(n){var e="";if(n===0)return e;for(var t=0;t<n-1;++t)e+="arg"+String(t)+", ";return e+="arg"+String(n-1),e}function generateBodyPartsCode(n,e){for(var t="",r="",s=0;s<e;++s)t+="var f".concat(s," = collection[").concat(s,`];
`),r+="f".concat(s,"(").concat(n,`)
`);return{funcDefCode:t,funcCallCode:r}}function generateBodyPartsVariadicCode(n){for(var e="",t="",r=0;r<n;++r)e+="var f".concat(r," = collection[").concat(r,`];
`),t+="f".concat(r,`.apply(undefined, arguments)
`);return{funcDefCode:e,funcCallCode:t}}function bakeCollection(collection,fixedArgsNum){if(collection.length===0)return exports$1.BAKED_EMPTY_FUNC;if(collection.length===1)return collection[0];var funcFactoryCode;if(collection.length<FORLOOP_FALLBACK){var argsDefCode=generateArgsDefCode(fixedArgsNum),_a=generateBodyPartsCode(argsDefCode,collection.length),funcDefCode=_a.funcDefCode,funcCallCode=_a.funcCallCode;funcFactoryCode=`(function(collection) {
            `.concat(funcDefCode,`
            collection = undefined;
            return (function(`).concat(argsDefCode,`) {
                `).concat(funcCallCode,`
            });
        })`)}else{var argsDefCode=generateArgsDefCode(fixedArgsNum);collection.length%10===0?funcFactoryCode=`(function(collection) {
                return (function(`.concat(argsDefCode,`) {
                    for (var i = 0; i < collection.length; i += 10) {
                        collection[i](`).concat(argsDefCode,`);
                        collection[i+1](`).concat(argsDefCode,`);
                        collection[i+2](`).concat(argsDefCode,`);
                        collection[i+3](`).concat(argsDefCode,`);
                        collection[i+4](`).concat(argsDefCode,`);
                        collection[i+5](`).concat(argsDefCode,`);
                        collection[i+6](`).concat(argsDefCode,`);
                        collection[i+7](`).concat(argsDefCode,`);
                        collection[i+8](`).concat(argsDefCode,`);
                        collection[i+9](`).concat(argsDefCode,`);
                    }
                });
            })`):collection.length%4===0?funcFactoryCode=`(function(collection) {
                return (function(`.concat(argsDefCode,`) {
                    for (var i = 0; i < collection.length; i += 4) {
                        collection[i](`).concat(argsDefCode,`);
                        collection[i+1](`).concat(argsDefCode,`);
                        collection[i+2](`).concat(argsDefCode,`);
                        collection[i+3](`).concat(argsDefCode,`);
                    }
                });
            })`):collection.length%3===0?funcFactoryCode=`(function(collection) {
                return (function(`.concat(argsDefCode,`) {
                    for (var i = 0; i < collection.length; i += 3) {
                        collection[i](`).concat(argsDefCode,`);
                        collection[i+1](`).concat(argsDefCode,`);
                        collection[i+2](`).concat(argsDefCode,`);
                    }
                });
            })`):funcFactoryCode=`(function(collection) {
                return (function(`.concat(argsDefCode,`) {
                    for (var i = 0; i < collection.length; ++i) {
                        collection[i](`).concat(argsDefCode,`);
                    }
                });
            })`)}{var funcFactory=eval(funcFactoryCode);return funcFactory(collection)}}exports$1.bakeCollection=bakeCollection;function bakeCollectionAwait(collection,fixedArgsNum){if(collection.length===0)return exports$1.BAKED_EMPTY_FUNC;if(collection.length===1)return collection[0];var funcFactoryCode;if(collection.length<FORLOOP_FALLBACK){var argsDefCode=generateArgsDefCode(fixedArgsNum),_a=generateBodyPartsCode(argsDefCode,collection.length),funcDefCode=_a.funcDefCode,funcCallCode=_a.funcCallCode;funcFactoryCode=`(function(collection) {
            `.concat(funcDefCode,`
            collection = undefined;
            return (function(`).concat(argsDefCode,`) {
                return Promise.all([ `).concat(funcCallCode,` ]);
            });
        })`)}else{var argsDefCode=generateArgsDefCode(fixedArgsNum);funcFactoryCode=`(function(collection) {
            return (function(`.concat(argsDefCode,`) {
                var promises = Array(collection.length);
                for (var i = 0; i < collection.length; ++i) {
                    promises[i] = collection[i](`).concat(argsDefCode,`);
                }
                return Promise.all(promises);
            });
        })`)}{var funcFactory=eval(funcFactoryCode);return funcFactory(collection)}}exports$1.bakeCollectionAwait=bakeCollectionAwait;function bakeCollectionVariadic(collection){if(collection.length===0)return exports$1.BAKED_EMPTY_FUNC;if(collection.length===1)return collection[0];var funcFactoryCode;if(collection.length<FORLOOP_FALLBACK){var _a=generateBodyPartsVariadicCode(collection.length),funcDefCode=_a.funcDefCode,funcCallCode=_a.funcCallCode;funcFactoryCode=`(function(collection) {
            `.concat(funcDefCode,`
            collection = undefined;
            return (function() {
                `).concat(funcCallCode,`
            });
        })`)}else funcFactoryCode=`(function(collection) {
            return (function() {
                for (var i = 0; i < collection.length; ++i) {
                    collection[i].apply(undefined, arguments);
                }
            });
        })`;{var funcFactory=eval(funcFactoryCode);return funcFactory(collection)}}exports$1.bakeCollectionVariadic=bakeCollectionVariadic})(bakeCollection);var __spreadArray$1=commonjsGlobal&&commonjsGlobal.__spreadArray||function(n,e,t){if(t||arguments.length===2)for(var r=0,s=e.length,i;r<s;r++)(i||!(r in e))&&(i||(i=Array.prototype.slice.call(e,0,r)),i[r]=e[r]);return n.concat(i||Array.prototype.slice.call(e))};Object.defineProperty(taskCollection,"__esModule",{value:!0});taskCollection.TaskCollection=void 0;var utils_1$1=utils$1,bake_collection_1=bakeCollection;function push_norebuild(n,e){var t=this.length;if(t>1)if(e){var r;(r=this._tasks).push.apply(r,arguments),this.length+=arguments.length}else this._tasks.push(n),this.length++;else if(e){if(t===1){var s=Array(1+arguments.length);s.push(s),s.push.apply(s,arguments),this._tasks=s}else{var s=Array(arguments.length);s.push.apply(s,arguments),this._tasks=s}this.length+=arguments.length}else t===1?this._tasks=[this._tasks,n]:this._tasks=n,this.length++}function push_rebuild(n,e){var t=this.length;if(t>1)if(e){var r;(r=this._tasks).push.apply(r,arguments),this.length+=arguments.length}else this._tasks.push(n),this.length++;else if(e){if(t===1){var s=Array(1+arguments.length);s.push(s),s.push.apply(s,arguments),this._tasks=s}else{var s=Array(arguments.length);s.push.apply(s,arguments),this._tasks=s}this.length+=arguments.length}else t===1?this._tasks=[this._tasks,n]:this._tasks=n,this.length++;this.firstEmitBuildStrategy?this.call=rebuild_on_first_call:this.rebuild()}function removeLast_norebuild(n){this.length!==0&&(this.length===1?this._tasks===n&&(this.length=0):((0,utils_1$1._fast_remove_single)(this._tasks,this._tasks.lastIndexOf(n)),this._tasks.length===1?(this._tasks=this._tasks[0],this.length=1):this.length=this._tasks.length))}function removeLast_rebuild(n){if(this.length!==0){if(this.length===1)if(this._tasks===n&&(this.length=0),this.firstEmitBuildStrategy){this.call=bake_collection_1.BAKED_EMPTY_FUNC;return}else{this.rebuild();return}else(0,utils_1$1._fast_remove_single)(this._tasks,this._tasks.lastIndexOf(n)),this._tasks.length===1?(this._tasks=this._tasks[0],this.length=1):this.length=this._tasks.length;this.firstEmitBuildStrategy?this.call=rebuild_on_first_call:this.rebuild()}}function insert_norebuild(n){for(var e,t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];this.length===0?(this._tasks=t,this.length=1):this.length===1?(t.unshift(this._tasks),this._tasks=t,this.length=this._tasks.length):((e=this._tasks).splice.apply(e,__spreadArray$1([n,0],t,!1)),this.length=this._tasks.length)}function insert_rebuild(n){for(var e,t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];this.length===0?(this._tasks=t,this.length=1):this.length===1?(t.unshift(this._tasks),this._tasks=t,this.length=this._tasks.length):((e=this._tasks).splice.apply(e,__spreadArray$1([n,0],t,!1)),this.length=this._tasks.length),this.firstEmitBuildStrategy?this.call=rebuild_on_first_call:this.rebuild()}function rebuild_noawait(){this.length===0?this.call=bake_collection_1.BAKED_EMPTY_FUNC:this.length===1?this.call=this._tasks:this.call=(0,bake_collection_1.bakeCollection)(this._tasks,this.argsNum)}function rebuild_await(){this.length===0?this.call=bake_collection_1.BAKED_EMPTY_FUNC:this.length===1?this.call=this._tasks:this.call=(0,bake_collection_1.bakeCollectionAwait)(this._tasks,this.argsNum)}function rebuild_on_first_call(){this.rebuild(),this.call.apply(void 0,arguments)}var TaskCollection=function(){function n(e,t,r,s){t===void 0&&(t=!0),r===void 0&&(r=null),s===void 0&&(s=!1),this.awaitTasks=s,this.call=bake_collection_1.BAKED_EMPTY_FUNC,this.argsNum=e,this.firstEmitBuildStrategy=!0,s?this.rebuild=rebuild_await.bind(this):this.rebuild=rebuild_noawait.bind(this),this.setAutoRebuild(t),r?typeof r=="function"?(this._tasks=r,this.length=1):(this._tasks=r,this.length=r.length):(this._tasks=null,this.length=0),t&&this.rebuild()}return n}();taskCollection.TaskCollection=TaskCollection;function fastClear(){this._tasks=null,this.length=0,this.call=bake_collection_1.BAKED_EMPTY_FUNC}function clear(){this._tasks=null,this.length=0,this.call=bake_collection_1.BAKED_EMPTY_FUNC}function growArgsNum(n){this.argsNum<n&&(this.argsNum=n,this.firstEmitBuildStrategy?this.call=rebuild_on_first_call:this.rebuild())}function setAutoRebuild(n){n?(this.push=push_rebuild.bind(this),this.insert=insert_rebuild.bind(this),this.removeLast=removeLast_rebuild.bind(this)):(this.push=push_norebuild.bind(this),this.insert=insert_norebuild.bind(this),this.removeLast=removeLast_norebuild.bind(this))}function tasksAsArray(){return this.length===0?[]:this.length===1?[this._tasks]:this._tasks}function setTasks(n){n.length===0?(this.length=0,this.call=bake_collection_1.BAKED_EMPTY_FUNC):n.length===1?(this.length=1,this.call=n[0],this._tasks=n[0]):(this.length=n.length,this._tasks=n,this.firstEmitBuildStrategy?this.call=rebuild_on_first_call:this.rebuild())}TaskCollection.prototype.fastClear=fastClear;TaskCollection.prototype.clear=clear;TaskCollection.prototype.growArgsNum=growArgsNum;TaskCollection.prototype.setAutoRebuild=setAutoRebuild;TaskCollection.prototype.tasksAsArray=tasksAsArray;TaskCollection.prototype.setTasks=setTasks;(function(n){var e=commonjsGlobal&&commonjsGlobal.__createBinding||(Object.create?function(r,s,i,a){a===void 0&&(a=i);var u=Object.getOwnPropertyDescriptor(s,i);(!u||("get"in u?!s.__esModule:u.writable||u.configurable))&&(u={enumerable:!0,get:function(){return s[i]}}),Object.defineProperty(r,a,u)}:function(r,s,i,a){a===void 0&&(a=i),r[a]=s[i]}),t=commonjsGlobal&&commonjsGlobal.__exportStar||function(r,s){for(var i in r)i!=="default"&&!Object.prototype.hasOwnProperty.call(s,i)&&e(s,r,i)};Object.defineProperty(n,"__esModule",{value:!0}),t(taskCollection,n)})(taskCollection$1);var utils={};Object.defineProperty(utils,"__esModule",{value:!0});utils.nullObj=void 0;function nullObj(){var n={};return n.__proto__=null,n}utils.nullObj=nullObj;var __spreadArray=commonjsGlobal&&commonjsGlobal.__spreadArray||function(n,e,t){if(t||arguments.length===2)for(var r=0,s=e.length,i;r<s;r++)(i||!(r in e))&&(i||(i=Array.prototype.slice.call(e,0,r)),i[r]=e[r]);return n.concat(i||Array.prototype.slice.call(e))};Object.defineProperty(ee,"__esModule",{value:!0});ee.EventEmitter=void 0;var task_collection_1=taskCollection$1,utils_1=utils$1,utils_2=utils;function emit(n,e,t,r,s,i){var a=this.events[n];if(a){if(a.length===0)return!1;if(a.argsNum<6)a.call(e,t,r,s,i);else{for(var u=new Array(a.argsNum),l=0,p=u.length;l<p;++l)u[l]=arguments[l+1];a.call.apply(void 0,u)}return!0}return!1}function emitHasOnce(n,e,t,r,s,i){var a=this.events[n],u;if(a!==void 0){if(a.length===0)return!1;if(a.argsNum<6)a.call(e,t,r,s,i);else{u=new Array(a.argsNum);for(var l=0,p=u.length;l<p;++l)u[l]=arguments[l+1];a.call.apply(void 0,u)}}var g=this.onceEvents[n];if(g){if(typeof g=="function")if(this.onceEvents[n]=void 0,arguments.length<6)g(e,t,r,s,i);else{if(u===void 0){u=new Array(arguments.length-1);for(var l=0,p=u.length;l<p;++l)u[l]=arguments[l+1]}g.apply(void 0,u)}else{var v=g;if(this.onceEvents[n]=void 0,arguments.length<6)for(var l=0;l<v.length;++l)v[l](e,t,r,s,i);else{if(u===void 0){u=new Array(arguments.length-1);for(var l=0,p=u.length;l<p;++l)u[l]=arguments[l+1]}for(var l=0;l<v.length;++l)v[l].apply(void 0,u)}}return!0}return a!==void 0}var EventEmitter=function(){function n(){this.events=(0,utils_2.nullObj)(),this.onceEvents=(0,utils_2.nullObj)(),this._symbolKeys=new Set,this.maxListeners=1/0}return Object.defineProperty(n.prototype,"_eventsCount",{get:function(){return this.eventNames().length},enumerable:!1,configurable:!0}),n}();ee.EventEmitter=EventEmitter;function once(n,e){switch(this.emit===emit&&(this.emit=emitHasOnce),typeof this.onceEvents[n]){case"undefined":this.onceEvents[n]=e,typeof n=="symbol"&&this._symbolKeys.add(n);break;case"function":this.onceEvents[n]=[this.onceEvents[n],e];break;case"object":this.onceEvents[n].push(e)}return this}function addListener(n,e,t){if(t===void 0&&(t=e.length),typeof e!="function")throw new TypeError("The listener must be a function");var r=this.events[n];return r?(r.push(e),r.growArgsNum(t),this.maxListeners!==1/0&&this.maxListeners<=r.length&&console.warn('Maximum event listeners for "'.concat(String(n),'" event!'))):(this.events[n]=new task_collection_1.TaskCollection(t,!0,e,!1),typeof n=="symbol"&&this._symbolKeys.add(n)),this}function removeListener(n,e){var t=this.events[n];t&&t.removeLast(e);var r=this.onceEvents[n];return r&&(typeof r=="function"?this.onceEvents[n]=void 0:typeof r=="object"&&(r.length===1&&r[0]===e?this.onceEvents[n]=void 0:(0,utils_1._fast_remove_single)(r,r.lastIndexOf(e)))),this}function addListenerBound(n,e,t,r){t===void 0&&(t=this),r===void 0&&(r=e.length),this.boundFuncs||(this.boundFuncs=new Map);var s=e.bind(t);return this.boundFuncs.set(e,s),this.addListener(n,s,r)}function removeListenerBound(n,e){var t,r,s=(t=this.boundFuncs)===null||t===void 0?void 0:t.get(e);return(r=this.boundFuncs)===null||r===void 0||r.delete(e),this.removeListener(n,s)}function hasListeners(n){return this.events[n]&&!!this.events[n].length}function prependListener(n,e,t){if(t===void 0&&(t=e.length),typeof e!="function")throw new TypeError("The listener must be a function");var r=this.events[n];return!r||!(r instanceof task_collection_1.TaskCollection)?(r=this.events[n]=new task_collection_1.TaskCollection(t,!0,e,!1),typeof n=="symbol"&&this._symbolKeys.add(n)):(r.insert(0,e),r.growArgsNum(t),this.maxListeners!==1/0&&this.maxListeners<=r.length&&console.warn('Maximum event listeners for "'.concat(String(n),'" event!'))),this}function prependOnceListener(n,e){this.emit===emit&&(this.emit=emitHasOnce);var t=this.onceEvents[n];return t?typeof t!="object"?(this.onceEvents[n]=[e,t],typeof n=="symbol"&&this._symbolKeys.add(n)):(t.unshift(e),this.maxListeners!==1/0&&this.maxListeners<=t.length&&console.warn('Maximum event listeners for "'.concat(String(n),'" once event!'))):(this.onceEvents[n]=[e],typeof n=="symbol"&&this._symbolKeys.add(n)),this}function removeAllListeners(n){return n===void 0?(this.events=(0,utils_2.nullObj)(),this.onceEvents=(0,utils_2.nullObj)(),this._symbolKeys=new Set):(this.events[n]=void 0,this.onceEvents[n]=void 0,typeof n=="symbol"&&this._symbolKeys.delete(n)),this}function setMaxListeners(n){return this.maxListeners=n,this}function getMaxListeners(){return this.maxListeners}function listeners(n){return this.emit===emit?this.events[n]?this.events[n].tasksAsArray().slice():[]:this.events[n]&&this.onceEvents[n]?__spreadArray(__spreadArray([],this.events[n].tasksAsArray(),!0),typeof this.onceEvents[n]=="function"?[this.onceEvents[n]]:this.onceEvents[n],!0):this.events[n]?this.events[n].tasksAsArray():this.onceEvents[n]?typeof this.onceEvents[n]=="function"?[this.onceEvents[n]]:this.onceEvents[n]:[]}function eventNames(){var n=this;if(this.emit===emit){var e=Object.keys(this.events);return __spreadArray(__spreadArray([],e,!0),Array.from(this._symbolKeys),!0).filter(function(r){return r in n.events&&n.events[r]&&n.events[r].length})}else{var e=Object.keys(this.events).filter(function(s){return n.events[s]&&n.events[s].length}),t=Object.keys(this.onceEvents).filter(function(s){return n.onceEvents[s]&&n.onceEvents[s].length});return __spreadArray(__spreadArray(__spreadArray([],e,!0),t,!0),Array.from(this._symbolKeys).filter(function(s){return s in n.events&&n.events[s]&&n.events[s].length||s in n.onceEvents&&n.onceEvents[s]&&n.onceEvents[s].length}),!0)}}function listenerCount(n){return this.emit===emit?this.events[n]&&this.events[n].length||0:(this.events[n]&&this.events[n].length||0)+(this.onceEvents[n]&&this.onceEvents[n].length||0)}EventEmitter.prototype.emit=emit;EventEmitter.prototype.on=addListener;EventEmitter.prototype.once=once;EventEmitter.prototype.addListener=addListener;EventEmitter.prototype.removeListener=removeListener;EventEmitter.prototype.addListenerBound=addListenerBound;EventEmitter.prototype.removeListenerBound=removeListenerBound;EventEmitter.prototype.hasListeners=hasListeners;EventEmitter.prototype.prependListener=prependListener;EventEmitter.prototype.prependOnceListener=prependOnceListener;EventEmitter.prototype.off=removeListener;EventEmitter.prototype.removeAllListeners=removeAllListeners;EventEmitter.prototype.setMaxListeners=setMaxListeners;EventEmitter.prototype.getMaxListeners=getMaxListeners;EventEmitter.prototype.listeners=listeners;EventEmitter.prototype.eventNames=eventNames;EventEmitter.prototype.listenerCount=listenerCount;(function(n){var e=commonjsGlobal&&commonjsGlobal.__createBinding||(Object.create?function(r,s,i,a){a===void 0&&(a=i);var u=Object.getOwnPropertyDescriptor(s,i);(!u||("get"in u?!s.__esModule:u.writable||u.configurable))&&(u={enumerable:!0,get:function(){return s[i]}}),Object.defineProperty(r,a,u)}:function(r,s,i,a){a===void 0&&(a=i),r[a]=s[i]}),t=commonjsGlobal&&commonjsGlobal.__exportStar||function(r,s){for(var i in r)i!=="default"&&!Object.prototype.hasOwnProperty.call(s,i)&&e(s,r,i)};Object.defineProperty(n,"__esModule",{value:!0}),t(types,n),t(ee,n)})(lib$1);var browser={exports:{}},ms,hasRequiredMs;function requireMs(){if(hasRequiredMs)return ms;hasRequiredMs=1;var n=1e3,e=n*60,t=e*60,r=t*24,s=r*7,i=r*365.25;ms=function(g,v){v=v||{};var m=typeof g;if(m==="string"&&g.length>0)return a(g);if(m==="number"&&isFinite(g))return v.long?l(g):u(g);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(g))};function a(g){if(g=String(g),!(g.length>100)){var v=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(g);if(v){var m=parseFloat(v[1]),w=(v[2]||"ms").toLowerCase();switch(w){case"years":case"year":case"yrs":case"yr":case"y":return m*i;case"weeks":case"week":case"w":return m*s;case"days":case"day":case"d":return m*r;case"hours":case"hour":case"hrs":case"hr":case"h":return m*t;case"minutes":case"minute":case"mins":case"min":case"m":return m*e;case"seconds":case"second":case"secs":case"sec":case"s":return m*n;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return m;default:return}}}}function u(g){var v=Math.abs(g);return v>=r?Math.round(g/r)+"d":v>=t?Math.round(g/t)+"h":v>=e?Math.round(g/e)+"m":v>=n?Math.round(g/n)+"s":g+"ms"}function l(g){var v=Math.abs(g);return v>=r?p(g,v,r,"day"):v>=t?p(g,v,t,"hour"):v>=e?p(g,v,e,"minute"):v>=n?p(g,v,n,"second"):g+" ms"}function p(g,v,m,w){var T=v>=m*1.5;return Math.round(g/m)+" "+w+(T?"s":"")}return ms}function setup(n){t.debug=t,t.default=t,t.coerce=l,t.disable=a,t.enable=s,t.enabled=u,t.humanize=requireMs(),t.destroy=p,Object.keys(n).forEach(g=>{t[g]=n[g]}),t.names=[],t.skips=[],t.formatters={};function e(g){let v=0;for(let m=0;m<g.length;m++)v=(v<<5)-v+g.charCodeAt(m),v|=0;return t.colors[Math.abs(v)%t.colors.length]}t.selectColor=e;function t(g){let v,m=null,w,T;function P(...W){if(!P.enabled)return;const X=P,ke=Number(new Date),ne=ke-(v||ke);X.diff=ne,X.prev=v,X.curr=ke,v=ke,W[0]=t.coerce(W[0]),typeof W[0]!="string"&&W.unshift("%O");let ye=0;W[0]=W[0].replace(/%([a-zA-Z%])/g,(Ee,ve)=>{if(Ee==="%%")return"%";ye++;const Ne=t.formatters[ve];if(typeof Ne=="function"){const ie=W[ye];Ee=Ne.call(X,ie),W.splice(ye,1),ye--}return Ee}),t.formatArgs.call(X,W),(X.log||t.log).apply(X,W)}return P.namespace=g,P.useColors=t.useColors(),P.color=t.selectColor(g),P.extend=r,P.destroy=t.destroy,Object.defineProperty(P,"enabled",{enumerable:!0,configurable:!1,get:()=>m!==null?m:(w!==t.namespaces&&(w=t.namespaces,T=t.enabled(g)),T),set:W=>{m=W}}),typeof t.init=="function"&&t.init(P),P}function r(g,v){const m=t(this.namespace+(typeof v>"u"?":":v)+g);return m.log=this.log,m}function s(g){t.save(g),t.namespaces=g,t.names=[],t.skips=[];const v=(typeof g=="string"?g:"").trim().replace(/\s+/g,",").split(",").filter(Boolean);for(const m of v)m[0]==="-"?t.skips.push(m.slice(1)):t.names.push(m)}function i(g,v){let m=0,w=0,T=-1,P=0;for(;m<g.length;)if(w<v.length&&(v[w]===g[m]||v[w]==="*"))v[w]==="*"?(T=w,P=m,w++):(m++,w++);else if(T!==-1)w=T+1,P++,m=P;else return!1;for(;w<v.length&&v[w]==="*";)w++;return w===v.length}function a(){const g=[...t.names,...t.skips.map(v=>"-"+v)].join(",");return t.enable(""),g}function u(g){for(const v of t.skips)if(i(g,v))return!1;for(const v of t.names)if(i(g,v))return!0;return!1}function l(g){return g instanceof Error?g.stack||g.message:g}function p(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return t.enable(t.load()),t}var common=setup;(function(n,e){var t={};e.formatArgs=s,e.save=i,e.load=a,e.useColors=r,e.storage=u(),e.destroy=(()=>{let p=!1;return()=>{p||(p=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),e.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function r(){if(typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs))return!0;if(typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;let p;return typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&(p=navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/))&&parseInt(p[1],10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function s(p){if(p[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+p[0]+(this.useColors?"%c ":" ")+"+"+n.exports.humanize(this.diff),!this.useColors)return;const g="color: "+this.color;p.splice(1,0,g,"color: inherit");let v=0,m=0;p[0].replace(/%[a-zA-Z%]/g,w=>{w!=="%%"&&(v++,w==="%c"&&(m=v))}),p.splice(m,0,g)}e.log=console.debug||console.log||(()=>{});function i(p){try{p?e.storage.setItem("debug",p):e.storage.removeItem("debug")}catch{}}function a(){let p;try{p=e.storage.getItem("debug")||e.storage.getItem("DEBUG")}catch{}return!p&&typeof process<"u"&&"env"in process&&(p=t.DEBUG),p}function u(){try{return localStorage}catch{}}n.exports=common(e);const{formatters:l}=n.exports;l.j=function(p){try{return JSON.stringify(p)}catch(g){return"[UnexpectedJSONParseError]: "+g.message}}})(browser,browser.exports);var browserExports=browser.exports;const createDebug2=getDefaultExportFromCjs(browserExports),crypto$2=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */function isBytes$1(n){return n instanceof Uint8Array||ArrayBuffer.isView(n)&&n.constructor.name==="Uint8Array"}function anumber$1(n){if(!Number.isSafeInteger(n)||n<0)throw new Error("positive integer expected, got "+n)}function abytes$1(n,...e){if(!isBytes$1(n))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(n.length))throw new Error("Uint8Array expected of length "+e+", got length="+n.length)}function ahash$1(n){if(typeof n!="function"||typeof n.create!="function")throw new Error("Hash should be wrapped by utils.createHasher");anumber$1(n.outputLen),anumber$1(n.blockLen)}function aexists$1(n,e=!0){if(n.destroyed)throw new Error("Hash instance has been destroyed");if(e&&n.finished)throw new Error("Hash#digest() has already been called")}function aoutput$1(n,e){abytes$1(n);const t=e.outputLen;if(n.length<t)throw new Error("digestInto() expects output buffer of length at least "+t)}function clean$1(...n){for(let e=0;e<n.length;e++)n[e].fill(0)}function createView$1(n){return new DataView(n.buffer,n.byteOffset,n.byteLength)}function rotr$1(n,e){return n<<32-e|n>>>e}const hasHexBuiltin$1=typeof Uint8Array.from([]).toHex=="function"&&typeof Uint8Array.fromHex=="function",hexes$1=Array.from({length:256},(n,e)=>e.toString(16).padStart(2,"0"));function bytesToHex$1(n){if(abytes$1(n),hasHexBuiltin$1)return n.toHex();let e="";for(let t=0;t<n.length;t++)e+=hexes$1[n[t]];return e}const asciis$1={_0:48,_9:57,A:65,F:70,a:97,f:102};function asciiToBase16$1(n){if(n>=asciis$1._0&&n<=asciis$1._9)return n-asciis$1._0;if(n>=asciis$1.A&&n<=asciis$1.F)return n-(asciis$1.A-10);if(n>=asciis$1.a&&n<=asciis$1.f)return n-(asciis$1.a-10)}function hexToBytes$1(n){if(typeof n!="string")throw new Error("hex string expected, got "+typeof n);if(hasHexBuiltin$1)return Uint8Array.fromHex(n);const e=n.length,t=e/2;if(e%2)throw new Error("hex string expected, got unpadded hex of length "+e);const r=new Uint8Array(t);for(let s=0,i=0;s<t;s++,i+=2){const a=asciiToBase16$1(n.charCodeAt(i)),u=asciiToBase16$1(n.charCodeAt(i+1));if(a===void 0||u===void 0){const l=n[i]+n[i+1];throw new Error('hex string expected, got non-hex character "'+l+'" at index '+i)}r[s]=a*16+u}return r}function utf8ToBytes$1(n){if(typeof n!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(n))}function toBytes$1(n){return typeof n=="string"&&(n=utf8ToBytes$1(n)),abytes$1(n),n}function concatBytes$1(...n){let e=0;for(let r=0;r<n.length;r++){const s=n[r];abytes$1(s),e+=s.length}const t=new Uint8Array(e);for(let r=0,s=0;r<n.length;r++){const i=n[r];t.set(i,s),s+=i.length}return t}let Hash$1=class{};function createHasher$1(n){const e=r=>n().update(toBytes$1(r)).digest(),t=n();return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=()=>n(),e}function randomBytes$1(n=32){if(crypto$2&&typeof crypto$2.getRandomValues=="function")return crypto$2.getRandomValues(new Uint8Array(n));if(crypto$2&&typeof crypto$2.randomBytes=="function")return Uint8Array.from(crypto$2.randomBytes(n));throw new Error("crypto.getRandomValues must be defined")}function setBigUint64$1(n,e,t,r){if(typeof n.setBigUint64=="function")return n.setBigUint64(e,t,r);const s=BigInt(32),i=BigInt(4294967295),a=Number(t>>s&i),u=Number(t&i),l=r?4:0,p=r?0:4;n.setUint32(e+l,a,r),n.setUint32(e+p,u,r)}function Chi$1(n,e,t){return n&e^~n&t}function Maj$1(n,e,t){return n&e^n&t^e&t}let HashMD$1=class extends Hash$1{constructor(e,t,r,s){super(),this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.blockLen=e,this.outputLen=t,this.padOffset=r,this.isLE=s,this.buffer=new Uint8Array(e),this.view=createView$1(this.buffer)}update(e){aexists$1(this),e=toBytes$1(e),abytes$1(e);const{view:t,buffer:r,blockLen:s}=this,i=e.length;for(let a=0;a<i;){const u=Math.min(s-this.pos,i-a);if(u===s){const l=createView$1(e);for(;s<=i-a;a+=s)this.process(l,a);continue}r.set(e.subarray(a,a+u),this.pos),this.pos+=u,a+=u,this.pos===s&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){aexists$1(this),aoutput$1(e,this),this.finished=!0;const{buffer:t,view:r,blockLen:s,isLE:i}=this;let{pos:a}=this;t[a++]=128,clean$1(this.buffer.subarray(a)),this.padOffset>s-a&&(this.process(r,0),a=0);for(let v=a;v<s;v++)t[v]=0;setBigUint64$1(r,s-8,BigInt(this.length*8),i),this.process(r,0);const u=createView$1(e),l=this.outputLen;if(l%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const p=l/4,g=this.get();if(p>g.length)throw new Error("_sha2: outputLen bigger than state");for(let v=0;v<p;v++)u.setUint32(4*v,g[v],i)}digest(){const{buffer:e,outputLen:t}=this;this.digestInto(e);const r=e.slice(0,t);return this.destroy(),r}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());const{blockLen:t,buffer:r,length:s,finished:i,destroyed:a,pos:u}=this;return e.destroyed=a,e.finished=i,e.length=s,e.pos=u,s%t&&e.buffer.set(r),e}clone(){return this._cloneInto()}};const SHA256_IV$1=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),SHA256_K$1=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),SHA256_W$1=new Uint32Array(64);let SHA256$1=class extends HashMD$1{constructor(e=32){super(64,e,8,!1),this.A=SHA256_IV$1[0]|0,this.B=SHA256_IV$1[1]|0,this.C=SHA256_IV$1[2]|0,this.D=SHA256_IV$1[3]|0,this.E=SHA256_IV$1[4]|0,this.F=SHA256_IV$1[5]|0,this.G=SHA256_IV$1[6]|0,this.H=SHA256_IV$1[7]|0}get(){const{A:e,B:t,C:r,D:s,E:i,F:a,G:u,H:l}=this;return[e,t,r,s,i,a,u,l]}set(e,t,r,s,i,a,u,l){this.A=e|0,this.B=t|0,this.C=r|0,this.D=s|0,this.E=i|0,this.F=a|0,this.G=u|0,this.H=l|0}process(e,t){for(let v=0;v<16;v++,t+=4)SHA256_W$1[v]=e.getUint32(t,!1);for(let v=16;v<64;v++){const m=SHA256_W$1[v-15],w=SHA256_W$1[v-2],T=rotr$1(m,7)^rotr$1(m,18)^m>>>3,P=rotr$1(w,17)^rotr$1(w,19)^w>>>10;SHA256_W$1[v]=P+SHA256_W$1[v-7]+T+SHA256_W$1[v-16]|0}let{A:r,B:s,C:i,D:a,E:u,F:l,G:p,H:g}=this;for(let v=0;v<64;v++){const m=rotr$1(u,6)^rotr$1(u,11)^rotr$1(u,25),w=g+m+Chi$1(u,l,p)+SHA256_K$1[v]+SHA256_W$1[v]|0,P=(rotr$1(r,2)^rotr$1(r,13)^rotr$1(r,22))+Maj$1(r,s,i)|0;g=p,p=l,l=u,u=a+w|0,a=i,i=s,s=r,r=w+P|0}r=r+this.A|0,s=s+this.B|0,i=i+this.C|0,a=a+this.D|0,u=u+this.E|0,l=l+this.F|0,p=p+this.G|0,g=g+this.H|0,this.set(r,s,i,a,u,l,p,g)}roundClean(){clean$1(SHA256_W$1)}destroy(){this.set(0,0,0,0,0,0,0,0),clean$1(this.buffer)}};const sha256$3=createHasher$1(()=>new SHA256$1);let HMAC$1=class extends Hash$1{constructor(e,t){super(),this.finished=!1,this.destroyed=!1,ahash$1(e);const r=toBytes$1(t);if(this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const s=this.blockLen,i=new Uint8Array(s);i.set(r.length>s?e.create().update(r).digest():r);for(let a=0;a<i.length;a++)i[a]^=54;this.iHash.update(i),this.oHash=e.create();for(let a=0;a<i.length;a++)i[a]^=106;this.oHash.update(i),clean$1(i)}update(e){return aexists$1(this),this.iHash.update(e),this}digestInto(e){aexists$1(this),abytes$1(e,this.outputLen),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){const e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||(e=Object.create(Object.getPrototypeOf(this),{}));const{oHash:t,iHash:r,finished:s,destroyed:i,blockLen:a,outputLen:u}=this;return e=e,e.finished=s,e.destroyed=i,e.blockLen=a,e.outputLen=u,e.oHash=t._cloneInto(e.oHash),e.iHash=r._cloneInto(e.iHash),e}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}};const hmac$1=(n,e,t)=>new HMAC$1(n,e).update(t).digest();hmac$1.create=(n,e)=>new HMAC$1(n,e);/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const _0n$9=BigInt(0),_1n$9=BigInt(1);function _abool2$1(n,e=""){if(typeof n!="boolean"){const t=e&&`"${e}"`;throw new Error(t+"expected boolean, got type="+typeof n)}return n}function _abytes2$1(n,e,t=""){const r=isBytes$1(n),s=n?.length,i=e!==void 0;if(!r||i&&s!==e){const a=t&&`"${t}" `,u=i?` of length ${e}`:"",l=r?`length=${s}`:`type=${typeof n}`;throw new Error(a+"expected Uint8Array"+u+", got "+l)}return n}function numberToHexUnpadded$1(n){const e=n.toString(16);return e.length&1?"0"+e:e}function hexToNumber$1(n){if(typeof n!="string")throw new Error("hex string expected, got "+typeof n);return n===""?_0n$9:BigInt("0x"+n)}function bytesToNumberBE$1(n){return hexToNumber$1(bytesToHex$1(n))}function bytesToNumberLE$1(n){return abytes$1(n),hexToNumber$1(bytesToHex$1(Uint8Array.from(n).reverse()))}function numberToBytesBE$1(n,e){return hexToBytes$1(n.toString(16).padStart(e*2,"0"))}function numberToBytesLE$1(n,e){return numberToBytesBE$1(n,e).reverse()}function ensureBytes$1(n,e,t){let r;if(typeof e=="string")try{r=hexToBytes$1(e)}catch(i){throw new Error(n+" must be hex string or Uint8Array, cause: "+i)}else if(isBytes$1(e))r=Uint8Array.from(e);else throw new Error(n+" must be hex string or Uint8Array");const s=r.length;if(typeof t=="number"&&s!==t)throw new Error(n+" of length "+t+" expected, got "+s);return r}const isPosBig$1=n=>typeof n=="bigint"&&_0n$9<=n;function inRange$1(n,e,t){return isPosBig$1(n)&&isPosBig$1(e)&&isPosBig$1(t)&&e<=n&&n<t}function aInRange$1(n,e,t,r){if(!inRange$1(e,t,r))throw new Error("expected valid "+n+": "+t+" <= n < "+r+", got "+e)}function bitLen$1(n){let e;for(e=0;n>_0n$9;n>>=_1n$9,e+=1);return e}const bitMask$1=n=>(_1n$9<<BigInt(n))-_1n$9;function createHmacDrbg$1(n,e,t){if(typeof n!="number"||n<2)throw new Error("hashLen must be a number");if(typeof e!="number"||e<2)throw new Error("qByteLen must be a number");if(typeof t!="function")throw new Error("hmacFn must be a function");const r=w=>new Uint8Array(w),s=w=>Uint8Array.of(w);let i=r(n),a=r(n),u=0;const l=()=>{i.fill(1),a.fill(0),u=0},p=(...w)=>t(a,i,...w),g=(w=r(0))=>{a=p(s(0),w),i=p(),w.length!==0&&(a=p(s(1),w),i=p())},v=()=>{if(u++>=1e3)throw new Error("drbg: tried 1000 values");let w=0;const T=[];for(;w<e;){i=p();const P=i.slice();T.push(P),w+=i.length}return concatBytes$1(...T)};return(w,T)=>{l(),g(w);let P;for(;!(P=T(v()));)g();return l(),P}}function _validateObject$1(n,e,t={}){if(!n||typeof n!="object")throw new Error("expected valid options object");function r(s,i,a){const u=n[s];if(a&&u===void 0)return;const l=typeof u;if(l!==i||u===null)throw new Error(`param "${s}" is invalid: expected ${i}, got ${l}`)}Object.entries(e).forEach(([s,i])=>r(s,i,!1)),Object.entries(t).forEach(([s,i])=>r(s,i,!0))}function memoized$1(n){const e=new WeakMap;return(t,...r)=>{const s=e.get(t);if(s!==void 0)return s;const i=n(t,...r);return e.set(t,i),i}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const _0n$8=BigInt(0),_1n$8=BigInt(1),_2n$5=BigInt(2),_3n$3=BigInt(3),_4n$3=BigInt(4),_5n$1=BigInt(5),_7n$1=BigInt(7),_8n$1=BigInt(8),_9n$1=BigInt(9),_16n$1=BigInt(16);function mod$1(n,e){const t=n%e;return t>=_0n$8?t:e+t}function pow2$1(n,e,t){let r=n;for(;e-- >_0n$8;)r*=r,r%=t;return r}function invert$1(n,e){if(n===_0n$8)throw new Error("invert: expected non-zero number");if(e<=_0n$8)throw new Error("invert: expected positive modulus, got "+e);let t=mod$1(n,e),r=e,s=_0n$8,i=_1n$8;for(;t!==_0n$8;){const u=r/t,l=r%t,p=s-i*u;r=t,t=l,s=i,i=p}if(r!==_1n$8)throw new Error("invert: does not exist");return mod$1(s,e)}function assertIsSquare$1(n,e,t){if(!n.eql(n.sqr(e),t))throw new Error("Cannot find square root")}function sqrt3mod4$1(n,e){const t=(n.ORDER+_1n$8)/_4n$3,r=n.pow(e,t);return assertIsSquare$1(n,r,e),r}function sqrt5mod8$1(n,e){const t=(n.ORDER-_5n$1)/_8n$1,r=n.mul(e,_2n$5),s=n.pow(r,t),i=n.mul(e,s),a=n.mul(n.mul(i,_2n$5),s),u=n.mul(i,n.sub(a,n.ONE));return assertIsSquare$1(n,u,e),u}function sqrt9mod16$1(n){const e=Field$1(n),t=tonelliShanks$1(n),r=t(e,e.neg(e.ONE)),s=t(e,r),i=t(e,e.neg(r)),a=(n+_7n$1)/_16n$1;return(u,l)=>{let p=u.pow(l,a),g=u.mul(p,r);const v=u.mul(p,s),m=u.mul(p,i),w=u.eql(u.sqr(g),l),T=u.eql(u.sqr(v),l);p=u.cmov(p,g,w),g=u.cmov(m,v,T);const P=u.eql(u.sqr(g),l),W=u.cmov(p,g,P);return assertIsSquare$1(u,W,l),W}}function tonelliShanks$1(n){if(n<_3n$3)throw new Error("sqrt is not defined for small field");let e=n-_1n$8,t=0;for(;e%_2n$5===_0n$8;)e/=_2n$5,t++;let r=_2n$5;const s=Field$1(n);for(;FpLegendre$1(s,r)===1;)if(r++>1e3)throw new Error("Cannot find square root: probably non-prime P");if(t===1)return sqrt3mod4$1;let i=s.pow(r,e);const a=(e+_1n$8)/_2n$5;return function(l,p){if(l.is0(p))return p;if(FpLegendre$1(l,p)!==1)throw new Error("Cannot find square root");let g=t,v=l.mul(l.ONE,i),m=l.pow(p,e),w=l.pow(p,a);for(;!l.eql(m,l.ONE);){if(l.is0(m))return l.ZERO;let T=1,P=l.sqr(m);for(;!l.eql(P,l.ONE);)if(T++,P=l.sqr(P),T===g)throw new Error("Cannot find square root");const W=_1n$8<<BigInt(g-T-1),X=l.pow(v,W);g=T,v=l.sqr(X),m=l.mul(m,v),w=l.mul(w,X)}return w}}function FpSqrt$1(n){return n%_4n$3===_3n$3?sqrt3mod4$1:n%_8n$1===_5n$1?sqrt5mod8$1:n%_16n$1===_9n$1?sqrt9mod16$1(n):tonelliShanks$1(n)}const FIELD_FIELDS$1=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function validateField$1(n){const e={ORDER:"bigint",MASK:"bigint",BYTES:"number",BITS:"number"},t=FIELD_FIELDS$1.reduce((r,s)=>(r[s]="function",r),e);return _validateObject$1(n,t),n}function FpPow$1(n,e,t){if(t<_0n$8)throw new Error("invalid exponent, negatives unsupported");if(t===_0n$8)return n.ONE;if(t===_1n$8)return e;let r=n.ONE,s=e;for(;t>_0n$8;)t&_1n$8&&(r=n.mul(r,s)),s=n.sqr(s),t>>=_1n$8;return r}function FpInvertBatch$1(n,e,t=!1){const r=new Array(e.length).fill(t?n.ZERO:void 0),s=e.reduce((a,u,l)=>n.is0(u)?a:(r[l]=a,n.mul(a,u)),n.ONE),i=n.inv(s);return e.reduceRight((a,u,l)=>n.is0(u)?a:(r[l]=n.mul(a,r[l]),n.mul(a,u)),i),r}function FpLegendre$1(n,e){const t=(n.ORDER-_1n$8)/_2n$5,r=n.pow(e,t),s=n.eql(r,n.ONE),i=n.eql(r,n.ZERO),a=n.eql(r,n.neg(n.ONE));if(!s&&!i&&!a)throw new Error("invalid Legendre symbol result");return s?1:i?0:-1}function nLength$1(n,e){e!==void 0&&anumber$1(e);const t=e!==void 0?e:n.toString(2).length,r=Math.ceil(t/8);return{nBitLength:t,nByteLength:r}}function Field$1(n,e,t=!1,r={}){if(n<=_0n$8)throw new Error("invalid field: expected ORDER > 0, got "+n);let s,i,a=!1,u;if(typeof e=="object"&&e!=null){if(r.sqrt||t)throw new Error("cannot specify opts in two arguments");const m=e;m.BITS&&(s=m.BITS),m.sqrt&&(i=m.sqrt),typeof m.isLE=="boolean"&&(t=m.isLE),typeof m.modFromBytes=="boolean"&&(a=m.modFromBytes),u=m.allowedLengths}else typeof e=="number"&&(s=e),r.sqrt&&(i=r.sqrt);const{nBitLength:l,nByteLength:p}=nLength$1(n,s);if(p>2048)throw new Error("invalid field: expected ORDER of <= 2048 bytes");let g;const v=Object.freeze({ORDER:n,isLE:t,BITS:l,BYTES:p,MASK:bitMask$1(l),ZERO:_0n$8,ONE:_1n$8,allowedLengths:u,create:m=>mod$1(m,n),isValid:m=>{if(typeof m!="bigint")throw new Error("invalid field element: expected bigint, got "+typeof m);return _0n$8<=m&&m<n},is0:m=>m===_0n$8,isValidNot0:m=>!v.is0(m)&&v.isValid(m),isOdd:m=>(m&_1n$8)===_1n$8,neg:m=>mod$1(-m,n),eql:(m,w)=>m===w,sqr:m=>mod$1(m*m,n),add:(m,w)=>mod$1(m+w,n),sub:(m,w)=>mod$1(m-w,n),mul:(m,w)=>mod$1(m*w,n),pow:(m,w)=>FpPow$1(v,m,w),div:(m,w)=>mod$1(m*invert$1(w,n),n),sqrN:m=>m*m,addN:(m,w)=>m+w,subN:(m,w)=>m-w,mulN:(m,w)=>m*w,inv:m=>invert$1(m,n),sqrt:i||(m=>(g||(g=FpSqrt$1(n)),g(v,m))),toBytes:m=>t?numberToBytesLE$1(m,p):numberToBytesBE$1(m,p),fromBytes:(m,w=!0)=>{if(u){if(!u.includes(m.length)||m.length>p)throw new Error("Field.fromBytes: expected "+u+" bytes, got "+m.length);const P=new Uint8Array(p);P.set(m,t?0:P.length-m.length),m=P}if(m.length!==p)throw new Error("Field.fromBytes: expected "+p+" bytes, got "+m.length);let T=t?bytesToNumberLE$1(m):bytesToNumberBE$1(m);if(a&&(T=mod$1(T,n)),!w&&!v.isValid(T))throw new Error("invalid field element: outside of range 0..ORDER");return T},invertBatch:m=>FpInvertBatch$1(v,m),cmov:(m,w,T)=>T?w:m});return Object.freeze(v)}function getFieldBytesLength$1(n){if(typeof n!="bigint")throw new Error("field order must be bigint");const e=n.toString(2).length;return Math.ceil(e/8)}function getMinHashLength$1(n){const e=getFieldBytesLength$1(n);return e+Math.ceil(e/2)}function mapHashToField$1(n,e,t=!1){const r=n.length,s=getFieldBytesLength$1(e),i=getMinHashLength$1(e);if(r<16||r<i||r>1024)throw new Error("expected "+i+"-1024 bytes of input, got "+r);const a=t?bytesToNumberLE$1(n):bytesToNumberBE$1(n),u=mod$1(a,e-_1n$8)+_1n$8;return t?numberToBytesLE$1(u,s):numberToBytesBE$1(u,s)}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const _0n$7=BigInt(0),_1n$7=BigInt(1);function negateCt$1(n,e){const t=e.negate();return n?t:e}function normalizeZ$1(n,e){const t=FpInvertBatch$1(n.Fp,e.map(r=>r.Z));return e.map((r,s)=>n.fromAffine(r.toAffine(t[s])))}function validateW$1(n,e){if(!Number.isSafeInteger(n)||n<=0||n>e)throw new Error("invalid window size, expected [1.."+e+"], got W="+n)}function calcWOpts$1(n,e){validateW$1(n,e);const t=Math.ceil(e/n)+1,r=2**(n-1),s=2**n,i=bitMask$1(n),a=BigInt(n);return{windows:t,windowSize:r,mask:i,maxNumber:s,shiftBy:a}}function calcOffsets$1(n,e,t){const{windowSize:r,mask:s,maxNumber:i,shiftBy:a}=t;let u=Number(n&s),l=n>>a;u>r&&(u-=i,l+=_1n$7);const p=e*r,g=p+Math.abs(u)-1,v=u===0,m=u<0,w=e%2!==0;return{nextN:l,offset:g,isZero:v,isNeg:m,isNegF:w,offsetF:p}}function validateMSMPoints$1(n,e){if(!Array.isArray(n))throw new Error("array expected");n.forEach((t,r)=>{if(!(t instanceof e))throw new Error("invalid point at index "+r)})}function validateMSMScalars$1(n,e){if(!Array.isArray(n))throw new Error("array of scalars expected");n.forEach((t,r)=>{if(!e.isValid(t))throw new Error("invalid scalar at index "+r)})}const pointPrecomputes$1=new WeakMap,pointWindowSizes$1=new WeakMap;function getW$1(n){return pointWindowSizes$1.get(n)||1}function assert0$1(n){if(n!==_0n$7)throw new Error("invalid wNAF")}let wNAF$1=class{constructor(e,t){this.BASE=e.BASE,this.ZERO=e.ZERO,this.Fn=e.Fn,this.bits=t}_unsafeLadder(e,t,r=this.ZERO){let s=e;for(;t>_0n$7;)t&_1n$7&&(r=r.add(s)),s=s.double(),t>>=_1n$7;return r}precomputeWindow(e,t){const{windows:r,windowSize:s}=calcWOpts$1(t,this.bits),i=[];let a=e,u=a;for(let l=0;l<r;l++){u=a,i.push(u);for(let p=1;p<s;p++)u=u.add(a),i.push(u);a=u.double()}return i}wNAF(e,t,r){if(!this.Fn.isValid(r))throw new Error("invalid scalar");let s=this.ZERO,i=this.BASE;const a=calcWOpts$1(e,this.bits);for(let u=0;u<a.windows;u++){const{nextN:l,offset:p,isZero:g,isNeg:v,isNegF:m,offsetF:w}=calcOffsets$1(r,u,a);r=l,g?i=i.add(negateCt$1(m,t[w])):s=s.add(negateCt$1(v,t[p]))}return assert0$1(r),{p:s,f:i}}wNAFUnsafe(e,t,r,s=this.ZERO){const i=calcWOpts$1(e,this.bits);for(let a=0;a<i.windows&&r!==_0n$7;a++){const{nextN:u,offset:l,isZero:p,isNeg:g}=calcOffsets$1(r,a,i);if(r=u,!p){const v=t[l];s=s.add(g?v.negate():v)}}return assert0$1(r),s}getPrecomputes(e,t,r){let s=pointPrecomputes$1.get(t);return s||(s=this.precomputeWindow(t,e),e!==1&&(typeof r=="function"&&(s=r(s)),pointPrecomputes$1.set(t,s))),s}cached(e,t,r){const s=getW$1(e);return this.wNAF(s,this.getPrecomputes(s,e,r),t)}unsafe(e,t,r,s){const i=getW$1(e);return i===1?this._unsafeLadder(e,t,s):this.wNAFUnsafe(i,this.getPrecomputes(i,e,r),t,s)}createCache(e,t){validateW$1(t,this.bits),pointWindowSizes$1.set(e,t),pointPrecomputes$1.delete(e)}hasCache(e){return getW$1(e)!==1}};function mulEndoUnsafe$1(n,e,t,r){let s=e,i=n.ZERO,a=n.ZERO;for(;t>_0n$7||r>_0n$7;)t&_1n$7&&(i=i.add(s)),r&_1n$7&&(a=a.add(s)),s=s.double(),t>>=_1n$7,r>>=_1n$7;return{p1:i,p2:a}}function pippenger$1(n,e,t,r){validateMSMPoints$1(t,n),validateMSMScalars$1(r,e);const s=t.length,i=r.length;if(s!==i)throw new Error("arrays of points and scalars must have equal length");const a=n.ZERO,u=bitLen$1(BigInt(s));let l=1;u>12?l=u-3:u>4?l=u-2:u>0&&(l=2);const p=bitMask$1(l),g=new Array(Number(p)+1).fill(a),v=Math.floor((e.BITS-1)/l)*l;let m=a;for(let w=v;w>=0;w-=l){g.fill(a);for(let P=0;P<i;P++){const W=r[P],X=Number(W>>BigInt(w)&p);g[X]=g[X].add(t[P])}let T=a;for(let P=g.length-1,W=a;P>0;P--)W=W.add(g[P]),T=T.add(W);if(m=m.add(T),w!==0)for(let P=0;P<l;P++)m=m.double()}return m}function createField$1(n,e,t){if(e){if(e.ORDER!==n)throw new Error("Field.ORDER must match order: Fp == p, Fn == n");return validateField$1(e),e}else return Field$1(n,{isLE:t})}function _createCurveFields$1(n,e,t={},r){if(r===void 0&&(r=n==="edwards"),!e||typeof e!="object")throw new Error(`expected valid ${n} CURVE object`);for(const l of["p","n","h"]){const p=e[l];if(!(typeof p=="bigint"&&p>_0n$7))throw new Error(`CURVE.${l} must be positive bigint`)}const s=createField$1(e.p,t.Fp,r),i=createField$1(e.n,t.Fn,r),u=["Gx","Gy","a","b"];for(const l of u)if(!s.isValid(e[l]))throw new Error(`CURVE.${l} must be valid field element of CURVE.Fp`);return e=Object.freeze(Object.assign({},e)),{CURVE:e,Fp:s,Fn:i}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const divNearest$1=(n,e)=>(n+(n>=0?e:-e)/_2n$4)/e;function _splitEndoScalar$1(n,e,t){const[[r,s],[i,a]]=e,u=divNearest$1(a*n,t),l=divNearest$1(-s*n,t);let p=n-u*r-l*i,g=-u*s-l*a;const v=p<_0n$6,m=g<_0n$6;v&&(p=-p),m&&(g=-g);const w=bitMask$1(Math.ceil(bitLen$1(t)/2))+_1n$6;if(p<_0n$6||p>=w||g<_0n$6||g>=w)throw new Error("splitScalar (endomorphism): failed, k="+n);return{k1neg:v,k1:p,k2neg:m,k2:g}}function validateSigFormat$1(n){if(!["compact","recovered","der"].includes(n))throw new Error('Signature format must be "compact", "recovered", or "der"');return n}function validateSigOpts$1(n,e){const t={};for(let r of Object.keys(e))t[r]=n[r]===void 0?e[r]:n[r];return _abool2$1(t.lowS,"lowS"),_abool2$1(t.prehash,"prehash"),t.format!==void 0&&validateSigFormat$1(t.format),t}let DERErr$1=class extends Error{constructor(e=""){super(e)}};const DER$1={Err:DERErr$1,_tlv:{encode:(n,e)=>{const{Err:t}=DER$1;if(n<0||n>256)throw new t("tlv.encode: wrong tag");if(e.length&1)throw new t("tlv.encode: unpadded data");const r=e.length/2,s=numberToHexUnpadded$1(r);if(s.length/2&128)throw new t("tlv.encode: long form length too big");const i=r>127?numberToHexUnpadded$1(s.length/2|128):"";return numberToHexUnpadded$1(n)+i+s+e},decode(n,e){const{Err:t}=DER$1;let r=0;if(n<0||n>256)throw new t("tlv.encode: wrong tag");if(e.length<2||e[r++]!==n)throw new t("tlv.decode: wrong tlv");const s=e[r++],i=!!(s&128);let a=0;if(!i)a=s;else{const l=s&127;if(!l)throw new t("tlv.decode(long): indefinite length not supported");if(l>4)throw new t("tlv.decode(long): byte length is too big");const p=e.subarray(r,r+l);if(p.length!==l)throw new t("tlv.decode: length bytes not complete");if(p[0]===0)throw new t("tlv.decode(long): zero leftmost byte");for(const g of p)a=a<<8|g;if(r+=l,a<128)throw new t("tlv.decode(long): not minimal encoding")}const u=e.subarray(r,r+a);if(u.length!==a)throw new t("tlv.decode: wrong value length");return{v:u,l:e.subarray(r+a)}}},_int:{encode(n){const{Err:e}=DER$1;if(n<_0n$6)throw new e("integer: negative integers are not allowed");let t=numberToHexUnpadded$1(n);if(Number.parseInt(t[0],16)&8&&(t="00"+t),t.length&1)throw new e("unexpected DER parsing assertion: unpadded hex");return t},decode(n){const{Err:e}=DER$1;if(n[0]&128)throw new e("invalid signature integer: negative");if(n[0]===0&&!(n[1]&128))throw new e("invalid signature integer: unnecessary leading zero");return bytesToNumberBE$1(n)}},toSig(n){const{Err:e,_int:t,_tlv:r}=DER$1,s=ensureBytes$1("signature",n),{v:i,l:a}=r.decode(48,s);if(a.length)throw new e("invalid signature: left bytes after parsing");const{v:u,l}=r.decode(2,i),{v:p,l:g}=r.decode(2,l);if(g.length)throw new e("invalid signature: left bytes after parsing");return{r:t.decode(u),s:t.decode(p)}},hexFromSig(n){const{_tlv:e,_int:t}=DER$1,r=e.encode(2,t.encode(n.r)),s=e.encode(2,t.encode(n.s)),i=r+s;return e.encode(48,i)}},_0n$6=BigInt(0),_1n$6=BigInt(1),_2n$4=BigInt(2),_3n$2=BigInt(3),_4n$2=BigInt(4);function _normFnElement$1(n,e){const{BYTES:t}=n;let r;if(typeof e=="bigint")r=e;else{let s=ensureBytes$1("private key",e);try{r=n.fromBytes(s)}catch{throw new Error(`invalid private key: expected ui8a of size ${t}, got ${typeof e}`)}}if(!n.isValidNot0(r))throw new Error("invalid private key: out of range [1..N-1]");return r}function weierstrassN$1(n,e={}){const t=_createCurveFields$1("weierstrass",n,e),{Fp:r,Fn:s}=t;let i=t.CURVE;const{h:a,n:u}=i;_validateObject$1(e,{},{allowInfinityPoint:"boolean",clearCofactor:"function",isTorsionFree:"function",fromBytes:"function",toBytes:"function",endo:"object",wrapPrivateKey:"boolean"});const{endo:l}=e;if(l&&(!r.is0(i.a)||typeof l.beta!="bigint"||!Array.isArray(l.basises)))throw new Error('invalid endo: expected "beta": bigint and "basises": array');const p=getWLengths$1(r,s);function g(){if(!r.isOdd)throw new Error("compression is not supported: Field does not have .isOdd()")}function v(U,E,$){const{x:_,y:A}=E.toAffine(),M=r.toBytes(_);if(_abool2$1($,"isCompressed"),$){g();const G=!r.isOdd(A);return concatBytes$1(pprefix$1(G),M)}else return concatBytes$1(Uint8Array.of(4),M,r.toBytes(A))}function m(U){_abytes2$1(U,void 0,"Point");const{publicKey:E,publicKeyUncompressed:$}=p,_=U.length,A=U[0],M=U.subarray(1);if(_===E&&(A===2||A===3)){const G=r.fromBytes(M);if(!r.isValid(G))throw new Error("bad point: is not on curve, wrong x");const j=P(G);let z;try{z=r.sqrt(j)}catch(fe){const he=fe instanceof Error?": "+fe.message:"";throw new Error("bad point: is not on curve, sqrt error"+he)}g();const V=r.isOdd(z);return(A&1)===1!==V&&(z=r.neg(z)),{x:G,y:z}}else if(_===$&&A===4){const G=r.BYTES,j=r.fromBytes(M.subarray(0,G)),z=r.fromBytes(M.subarray(G,G*2));if(!W(j,z))throw new Error("bad point: is not on curve");return{x:j,y:z}}else throw new Error(`bad point: got length ${_}, expected compressed=${E} or uncompressed=${$}`)}const w=e.toBytes||v,T=e.fromBytes||m;function P(U){const E=r.sqr(U),$=r.mul(E,U);return r.add(r.add($,r.mul(U,i.a)),i.b)}function W(U,E){const $=r.sqr(E),_=P(U);return r.eql($,_)}if(!W(i.Gx,i.Gy))throw new Error("bad curve params: generator point");const X=r.mul(r.pow(i.a,_3n$2),_4n$2),ke=r.mul(r.sqr(i.b),BigInt(27));if(r.is0(r.add(X,ke)))throw new Error("bad curve params: a or b");function ne(U,E,$=!1){if(!r.isValid(E)||$&&r.is0(E))throw new Error(`bad point coordinate ${U}`);return E}function ye(U){if(!(U instanceof ie))throw new Error("ProjectivePoint expected")}function Se(U){if(!l||!l.basises)throw new Error("no endo");return _splitEndoScalar$1(U,l.basises,s.ORDER)}const Ee=memoized$1((U,E)=>{const{X:$,Y:_,Z:A}=U;if(r.eql(A,r.ONE))return{x:$,y:_};const M=U.is0();E==null&&(E=M?r.ONE:r.inv(A));const G=r.mul($,E),j=r.mul(_,E),z=r.mul(A,E);if(M)return{x:r.ZERO,y:r.ZERO};if(!r.eql(z,r.ONE))throw new Error("invZ was invalid");return{x:G,y:j}}),ve=memoized$1(U=>{if(U.is0()){if(e.allowInfinityPoint&&!r.is0(U.Y))return;throw new Error("bad point: ZERO")}const{x:E,y:$}=U.toAffine();if(!r.isValid(E)||!r.isValid($))throw new Error("bad point: x or y not field elements");if(!W(E,$))throw new Error("bad point: equation left != right");if(!U.isTorsionFree())throw new Error("bad point: not in prime-order subgroup");return!0});function Ne(U,E,$,_,A){return $=new ie(r.mul($.X,U),$.Y,$.Z),E=negateCt$1(_,E),$=negateCt$1(A,$),E.add($)}class ie{constructor(E,$,_){this.X=ne("x",E),this.Y=ne("y",$,!0),this.Z=ne("z",_),Object.freeze(this)}static CURVE(){return i}static fromAffine(E){const{x:$,y:_}=E||{};if(!E||!r.isValid($)||!r.isValid(_))throw new Error("invalid affine point");if(E instanceof ie)throw new Error("projective point not allowed");return r.is0($)&&r.is0(_)?ie.ZERO:new ie($,_,r.ONE)}static fromBytes(E){const $=ie.fromAffine(T(_abytes2$1(E,void 0,"point")));return $.assertValidity(),$}static fromHex(E){return ie.fromBytes(ensureBytes$1("pointHex",E))}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(E=8,$=!0){return H.createCache(this,E),$||this.multiply(_3n$2),this}assertValidity(){ve(this)}hasEvenY(){const{y:E}=this.toAffine();if(!r.isOdd)throw new Error("Field doesn't support isOdd");return!r.isOdd(E)}equals(E){ye(E);const{X:$,Y:_,Z:A}=this,{X:M,Y:G,Z:j}=E,z=r.eql(r.mul($,j),r.mul(M,A)),V=r.eql(r.mul(_,j),r.mul(G,A));return z&&V}negate(){return new ie(this.X,r.neg(this.Y),this.Z)}double(){const{a:E,b:$}=i,_=r.mul($,_3n$2),{X:A,Y:M,Z:G}=this;let j=r.ZERO,z=r.ZERO,V=r.ZERO,J=r.mul(A,A),fe=r.mul(M,M),he=r.mul(G,G),ue=r.mul(A,M);return ue=r.add(ue,ue),V=r.mul(A,G),V=r.add(V,V),j=r.mul(E,V),z=r.mul(_,he),z=r.add(j,z),j=r.sub(fe,z),z=r.add(fe,z),z=r.mul(j,z),j=r.mul(ue,j),V=r.mul(_,V),he=r.mul(E,he),ue=r.sub(J,he),ue=r.mul(E,ue),ue=r.add(ue,V),V=r.add(J,J),J=r.add(V,J),J=r.add(J,he),J=r.mul(J,ue),z=r.add(z,J),he=r.mul(M,G),he=r.add(he,he),J=r.mul(he,ue),j=r.sub(j,J),V=r.mul(he,fe),V=r.add(V,V),V=r.add(V,V),new ie(j,z,V)}add(E){ye(E);const{X:$,Y:_,Z:A}=this,{X:M,Y:G,Z:j}=E;let z=r.ZERO,V=r.ZERO,J=r.ZERO;const fe=i.a,he=r.mul(i.b,_3n$2);let ue=r.mul($,M),pe=r.mul(_,G),ge=r.mul(A,j),Re=r.add($,_),Z=r.add(M,G);Re=r.mul(Re,Z),Z=r.add(ue,pe),Re=r.sub(Re,Z),Z=r.add($,A);let $e=r.add(M,j);return Z=r.mul(Z,$e),$e=r.add(ue,ge),Z=r.sub(Z,$e),$e=r.add(_,A),z=r.add(G,j),$e=r.mul($e,z),z=r.add(pe,ge),$e=r.sub($e,z),J=r.mul(fe,Z),z=r.mul(he,ge),J=r.add(z,J),z=r.sub(pe,J),J=r.add(pe,J),V=r.mul(z,J),pe=r.add(ue,ue),pe=r.add(pe,ue),ge=r.mul(fe,ge),Z=r.mul(he,Z),pe=r.add(pe,ge),ge=r.sub(ue,ge),ge=r.mul(fe,ge),Z=r.add(Z,ge),ue=r.mul(pe,Z),V=r.add(V,ue),ue=r.mul($e,Z),z=r.mul(Re,z),z=r.sub(z,ue),ue=r.mul(Re,pe),J=r.mul($e,J),J=r.add(J,ue),new ie(z,V,J)}subtract(E){return this.add(E.negate())}is0(){return this.equals(ie.ZERO)}multiply(E){const{endo:$}=e;if(!s.isValidNot0(E))throw new Error("invalid scalar: out of range");let _,A;const M=G=>H.cached(this,G,j=>normalizeZ$1(ie,j));if($){const{k1neg:G,k1:j,k2neg:z,k2:V}=Se(E),{p:J,f:fe}=M(j),{p:he,f:ue}=M(V);A=fe.add(ue),_=Ne($.beta,J,he,G,z)}else{const{p:G,f:j}=M(E);_=G,A=j}return normalizeZ$1(ie,[_,A])[0]}multiplyUnsafe(E){const{endo:$}=e,_=this;if(!s.isValid(E))throw new Error("invalid scalar: out of range");if(E===_0n$6||_.is0())return ie.ZERO;if(E===_1n$6)return _;if(H.hasCache(this))return this.multiply(E);if($){const{k1neg:A,k1:M,k2neg:G,k2:j}=Se(E),{p1:z,p2:V}=mulEndoUnsafe$1(ie,_,M,j);return Ne($.beta,z,V,A,G)}else return H.unsafe(_,E)}multiplyAndAddUnsafe(E,$,_){const A=this.multiplyUnsafe($).add(E.multiplyUnsafe(_));return A.is0()?void 0:A}toAffine(E){return Ee(this,E)}isTorsionFree(){const{isTorsionFree:E}=e;return a===_1n$6?!0:E?E(ie,this):H.unsafe(this,u).is0()}clearCofactor(){const{clearCofactor:E}=e;return a===_1n$6?this:E?E(ie,this):this.multiplyUnsafe(a)}isSmallOrder(){return this.multiplyUnsafe(a).is0()}toBytes(E=!0){return _abool2$1(E,"isCompressed"),this.assertValidity(),w(ie,this,E)}toHex(E=!0){return bytesToHex$1(this.toBytes(E))}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}get px(){return this.X}get py(){return this.X}get pz(){return this.Z}toRawBytes(E=!0){return this.toBytes(E)}_setWindowSize(E){this.precompute(E)}static normalizeZ(E){return normalizeZ$1(ie,E)}static msm(E,$){return pippenger$1(ie,s,E,$)}static fromPrivateKey(E){return ie.BASE.multiply(_normFnElement$1(s,E))}}ie.BASE=new ie(i.Gx,i.Gy,r.ONE),ie.ZERO=new ie(r.ZERO,r.ONE,r.ZERO),ie.Fp=r,ie.Fn=s;const De=s.BITS,H=new wNAF$1(ie,e.endo?Math.ceil(De/2):De);return ie.BASE.precompute(8),ie}function pprefix$1(n){return Uint8Array.of(n?2:3)}function getWLengths$1(n,e){return{secretKey:e.BYTES,publicKey:1+n.BYTES,publicKeyUncompressed:1+2*n.BYTES,publicKeyHasPrefix:!0,signature:2*e.BYTES}}function ecdh$1(n,e={}){const{Fn:t}=n,r=e.randomBytes||randomBytes$1,s=Object.assign(getWLengths$1(n.Fp,t),{seed:getMinHashLength$1(t.ORDER)});function i(w){try{return!!_normFnElement$1(t,w)}catch{return!1}}function a(w,T){const{publicKey:P,publicKeyUncompressed:W}=s;try{const X=w.length;return T===!0&&X!==P||T===!1&&X!==W?!1:!!n.fromBytes(w)}catch{return!1}}function u(w=r(s.seed)){return mapHashToField$1(_abytes2$1(w,s.seed,"seed"),t.ORDER)}function l(w,T=!0){return n.BASE.multiply(_normFnElement$1(t,w)).toBytes(T)}function p(w){const T=u(w);return{secretKey:T,publicKey:l(T)}}function g(w){if(typeof w=="bigint")return!1;if(w instanceof n)return!0;const{secretKey:T,publicKey:P,publicKeyUncompressed:W}=s;if(t.allowedLengths||T===P)return;const X=ensureBytes$1("key",w).length;return X===P||X===W}function v(w,T,P=!0){if(g(w)===!0)throw new Error("first arg must be private key");if(g(T)===!1)throw new Error("second arg must be public key");const W=_normFnElement$1(t,w);return n.fromHex(T).multiply(W).toBytes(P)}return Object.freeze({getPublicKey:l,getSharedSecret:v,keygen:p,Point:n,utils:{isValidSecretKey:i,isValidPublicKey:a,randomSecretKey:u,isValidPrivateKey:i,randomPrivateKey:u,normPrivateKeyToScalar:w=>_normFnElement$1(t,w),precompute(w=8,T=n.BASE){return T.precompute(w,!1)}},lengths:s})}function ecdsa$1(n,e,t={}){ahash$1(e),_validateObject$1(t,{},{hmac:"function",lowS:"boolean",randomBytes:"function",bits2int:"function",bits2int_modN:"function"});const r=t.randomBytes||randomBytes$1,s=t.hmac||(($,..._)=>hmac$1(e,$,concatBytes$1(..._))),{Fp:i,Fn:a}=n,{ORDER:u,BITS:l}=a,{keygen:p,getPublicKey:g,getSharedSecret:v,utils:m,lengths:w}=ecdh$1(n,t),T={prehash:!1,lowS:typeof t.lowS=="boolean"?t.lowS:!1,format:void 0,extraEntropy:!1},P="compact";function W($){const _=u>>_1n$6;return $>_}function X($,_){if(!a.isValidNot0(_))throw new Error(`invalid signature ${$}: out of range 1..Point.Fn.ORDER`);return _}function ke($,_){validateSigFormat$1(_);const A=w.signature,M=_==="compact"?A:_==="recovered"?A+1:void 0;return _abytes2$1($,M,`${_} signature`)}class ne{constructor(_,A,M){this.r=X("r",_),this.s=X("s",A),M!=null&&(this.recovery=M),Object.freeze(this)}static fromBytes(_,A=P){ke(_,A);let M;if(A==="der"){const{r:V,s:J}=DER$1.toSig(_abytes2$1(_));return new ne(V,J)}A==="recovered"&&(M=_[0],A="compact",_=_.subarray(1));const G=a.BYTES,j=_.subarray(0,G),z=_.subarray(G,G*2);return new ne(a.fromBytes(j),a.fromBytes(z),M)}static fromHex(_,A){return this.fromBytes(hexToBytes$1(_),A)}addRecoveryBit(_){return new ne(this.r,this.s,_)}recoverPublicKey(_){const A=i.ORDER,{r:M,s:G,recovery:j}=this;if(j==null||![0,1,2,3].includes(j))throw new Error("recovery id invalid");if(u*_2n$4<A&&j>1)throw new Error("recovery id is ambiguous for h>1 curve");const V=j===2||j===3?M+u:M;if(!i.isValid(V))throw new Error("recovery id 2 or 3 invalid");const J=i.toBytes(V),fe=n.fromBytes(concatBytes$1(pprefix$1((j&1)===0),J)),he=a.inv(V),ue=Se(ensureBytes$1("msgHash",_)),pe=a.create(-ue*he),ge=a.create(G*he),Re=n.BASE.multiplyUnsafe(pe).add(fe.multiplyUnsafe(ge));if(Re.is0())throw new Error("point at infinify");return Re.assertValidity(),Re}hasHighS(){return W(this.s)}toBytes(_=P){if(validateSigFormat$1(_),_==="der")return hexToBytes$1(DER$1.hexFromSig(this));const A=a.toBytes(this.r),M=a.toBytes(this.s);if(_==="recovered"){if(this.recovery==null)throw new Error("recovery bit must be present");return concatBytes$1(Uint8Array.of(this.recovery),A,M)}return concatBytes$1(A,M)}toHex(_){return bytesToHex$1(this.toBytes(_))}assertValidity(){}static fromCompact(_){return ne.fromBytes(ensureBytes$1("sig",_),"compact")}static fromDER(_){return ne.fromBytes(ensureBytes$1("sig",_),"der")}normalizeS(){return this.hasHighS()?new ne(this.r,a.neg(this.s),this.recovery):this}toDERRawBytes(){return this.toBytes("der")}toDERHex(){return bytesToHex$1(this.toBytes("der"))}toCompactRawBytes(){return this.toBytes("compact")}toCompactHex(){return bytesToHex$1(this.toBytes("compact"))}}const ye=t.bits2int||function(_){if(_.length>8192)throw new Error("input is too large");const A=bytesToNumberBE$1(_),M=_.length*8-l;return M>0?A>>BigInt(M):A},Se=t.bits2int_modN||function(_){return a.create(ye(_))},Ee=bitMask$1(l);function ve($){return aInRange$1("num < 2^"+l,$,_0n$6,Ee),a.toBytes($)}function Ne($,_){return _abytes2$1($,void 0,"message"),_?_abytes2$1(e($),void 0,"prehashed message"):$}function ie($,_,A){if(["recovered","canonical"].some(pe=>pe in A))throw new Error("sign() legacy options not supported");const{lowS:M,prehash:G,extraEntropy:j}=validateSigOpts$1(A,T);$=Ne($,G);const z=Se($),V=_normFnElement$1(a,_),J=[ve(V),ve(z)];if(j!=null&&j!==!1){const pe=j===!0?r(w.secretKey):j;J.push(ensureBytes$1("extraEntropy",pe))}const fe=concatBytes$1(...J),he=z;function ue(pe){const ge=ye(pe);if(!a.isValidNot0(ge))return;const Re=a.inv(ge),Z=n.BASE.multiply(ge).toAffine(),$e=a.create(Z.x);if($e===_0n$6)return;const Ve=a.create(Re*a.create(he+$e*V));if(Ve===_0n$6)return;let xe=(Z.x===$e?0:2)|Number(Z.y&_1n$6),qe=Ve;return M&&W(Ve)&&(qe=a.neg(Ve),xe^=1),new ne($e,qe,xe)}return{seed:fe,k2sig:ue}}function De($,_,A={}){$=ensureBytes$1("message",$);const{seed:M,k2sig:G}=ie($,_,A);return createHmacDrbg$1(e.outputLen,a.BYTES,s)(M,G)}function H($){let _;const A=typeof $=="string"||isBytes$1($),M=!A&&$!==null&&typeof $=="object"&&typeof $.r=="bigint"&&typeof $.s=="bigint";if(!A&&!M)throw new Error("invalid signature, expected Uint8Array, hex string or Signature instance");if(M)_=new ne($.r,$.s);else if(A){try{_=ne.fromBytes(ensureBytes$1("sig",$),"der")}catch(G){if(!(G instanceof DER$1.Err))throw G}if(!_)try{_=ne.fromBytes(ensureBytes$1("sig",$),"compact")}catch{return!1}}return _||!1}function U($,_,A,M={}){const{lowS:G,prehash:j,format:z}=validateSigOpts$1(M,T);if(A=ensureBytes$1("publicKey",A),_=Ne(ensureBytes$1("message",_),j),"strict"in M)throw new Error("options.strict was renamed to lowS");const V=z===void 0?H($):ne.fromBytes(ensureBytes$1("sig",$),z);if(V===!1)return!1;try{const J=n.fromBytes(A);if(G&&V.hasHighS())return!1;const{r:fe,s:he}=V,ue=Se(_),pe=a.inv(he),ge=a.create(ue*pe),Re=a.create(fe*pe),Z=n.BASE.multiplyUnsafe(ge).add(J.multiplyUnsafe(Re));return Z.is0()?!1:a.create(Z.x)===fe}catch{return!1}}function E($,_,A={}){const{prehash:M}=validateSigOpts$1(A,T);return _=Ne(_,M),ne.fromBytes($,"recovered").recoverPublicKey(_).toBytes()}return Object.freeze({keygen:p,getPublicKey:g,getSharedSecret:v,utils:m,lengths:w,Point:n,sign:De,verify:U,recoverPublicKey:E,Signature:ne,hash:e})}function _weierstrass_legacy_opts_to_new$1(n){const e={a:n.a,b:n.b,p:n.Fp.ORDER,n:n.n,h:n.h,Gx:n.Gx,Gy:n.Gy},t=n.Fp;let r=n.allowedPrivateKeyLengths?Array.from(new Set(n.allowedPrivateKeyLengths.map(a=>Math.ceil(a/2)))):void 0;const s=Field$1(e.n,{BITS:n.nBitLength,allowedLengths:r,modFromBytes:n.wrapPrivateKey}),i={Fp:t,Fn:s,allowInfinityPoint:n.allowInfinityPoint,endo:n.endo,isTorsionFree:n.isTorsionFree,clearCofactor:n.clearCofactor,fromBytes:n.fromBytes,toBytes:n.toBytes};return{CURVE:e,curveOpts:i}}function _ecdsa_legacy_opts_to_new$1(n){const{CURVE:e,curveOpts:t}=_weierstrass_legacy_opts_to_new$1(n),r={hmac:n.hmac,randomBytes:n.randomBytes,lowS:n.lowS,bits2int:n.bits2int,bits2int_modN:n.bits2int_modN};return{CURVE:e,curveOpts:t,hash:n.hash,ecdsaOpts:r}}function _ecdsa_new_output_to_legacy$1(n,e){const t=e.Point;return Object.assign({},e,{ProjectivePoint:t,CURVE:Object.assign({},n,nLength$1(t.Fn.ORDER,t.Fn.BITS))})}function weierstrass$1(n){const{CURVE:e,curveOpts:t,hash:r,ecdsaOpts:s}=_ecdsa_legacy_opts_to_new$1(n),i=weierstrassN$1(e,t),a=ecdsa$1(i,r,s);return _ecdsa_new_output_to_legacy$1(n,a)}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */function createCurve$1(n,e){const t=r=>weierstrass$1({...n,hash:r});return{...t(e),create:t}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const secp256k1_CURVE$1={p:BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),n:BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),h:BigInt(1),a:BigInt(0),b:BigInt(7),Gx:BigInt("0x79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798"),Gy:BigInt("0x483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b8")},secp256k1_ENDO$1={beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),basises:[[BigInt("0x3086d221a7d46bcde86c90e49284eb15"),-BigInt("0xe4437ed6010e88286f547fa90abfe4c3")],[BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),BigInt("0x3086d221a7d46bcde86c90e49284eb15")]]},_0n$5=BigInt(0),_1n$5=BigInt(1),_2n$3=BigInt(2);function sqrtMod$1(n){const e=secp256k1_CURVE$1.p,t=BigInt(3),r=BigInt(6),s=BigInt(11),i=BigInt(22),a=BigInt(23),u=BigInt(44),l=BigInt(88),p=n*n*n%e,g=p*p*n%e,v=pow2$1(g,t,e)*g%e,m=pow2$1(v,t,e)*g%e,w=pow2$1(m,_2n$3,e)*p%e,T=pow2$1(w,s,e)*w%e,P=pow2$1(T,i,e)*T%e,W=pow2$1(P,u,e)*P%e,X=pow2$1(W,l,e)*W%e,ke=pow2$1(X,u,e)*P%e,ne=pow2$1(ke,t,e)*g%e,ye=pow2$1(ne,a,e)*T%e,Se=pow2$1(ye,r,e)*p%e,Ee=pow2$1(Se,_2n$3,e);if(!Fpk1$1.eql(Fpk1$1.sqr(Ee),n))throw new Error("Cannot find square root");return Ee}const Fpk1$1=Field$1(secp256k1_CURVE$1.p,{sqrt:sqrtMod$1}),secp256k1$1=createCurve$1({...secp256k1_CURVE$1,Fp:Fpk1$1,lowS:!0,endo:secp256k1_ENDO$1},sha256$3),TAGGED_HASH_PREFIXES$1={};function taggedHash$1(n,...e){let t=TAGGED_HASH_PREFIXES$1[n];if(t===void 0){const r=sha256$3(utf8ToBytes$1(n));t=concatBytes$1(r,r),TAGGED_HASH_PREFIXES$1[n]=t}return sha256$3(concatBytes$1(t,...e))}const pointToBytes$1=n=>n.toBytes(!0).slice(1),Pointk1$1=secp256k1$1.Point,hasEven$1=n=>n%_2n$3===_0n$5;function schnorrGetExtPubKey$1(n){const{Fn:e,BASE:t}=Pointk1$1,r=_normFnElement$1(e,n),s=t.multiply(r);return{scalar:hasEven$1(s.y)?r:e.neg(r),bytes:pointToBytes$1(s)}}function lift_x$1(n){const e=Fpk1$1;if(!e.isValidNot0(n))throw new Error("invalid x: Fail if x  p");const t=e.create(n*n),r=e.create(t*n+BigInt(7));let s=e.sqrt(r);hasEven$1(s)||(s=e.neg(s));const i=Pointk1$1.fromAffine({x:n,y:s});return i.assertValidity(),i}const num$1=bytesToNumberBE$1;function challenge$1(...n){return Pointk1$1.Fn.create(num$1(taggedHash$1("BIP0340/challenge",...n)))}function schnorrGetPublicKey$1(n){return schnorrGetExtPubKey$1(n).bytes}function schnorrSign$1(n,e,t=randomBytes$1(32)){const{Fn:r}=Pointk1$1,s=ensureBytes$1("message",n),{bytes:i,scalar:a}=schnorrGetExtPubKey$1(e),u=ensureBytes$1("auxRand",t,32),l=r.toBytes(a^num$1(taggedHash$1("BIP0340/aux",u))),p=taggedHash$1("BIP0340/nonce",l,i,s),{bytes:g,scalar:v}=schnorrGetExtPubKey$1(p),m=challenge$1(g,i,s),w=new Uint8Array(64);if(w.set(g,0),w.set(r.toBytes(r.create(v+m*a)),32),!schnorrVerify$1(w,s,i))throw new Error("sign: Invalid signature produced");return w}function schnorrVerify$1(n,e,t){const{Fn:r,BASE:s}=Pointk1$1,i=ensureBytes$1("signature",n,64),a=ensureBytes$1("message",e),u=ensureBytes$1("publicKey",t,32);try{const l=lift_x$1(num$1(u)),p=num$1(i.subarray(0,32));if(!inRange$1(p,_1n$5,secp256k1_CURVE$1.p))return!1;const g=num$1(i.subarray(32,64));if(!inRange$1(g,_1n$5,secp256k1_CURVE$1.n))return!1;const v=challenge$1(r.toBytes(p),pointToBytes$1(l),a),m=s.multiplyUnsafe(g).add(l.multiplyUnsafe(r.neg(v))),{x:w,y:T}=m.toAffine();return!(m.is0()||!hasEven$1(T)||w!==p)}catch{return!1}}const schnorr$1=(()=>{const t=(s=randomBytes$1(48))=>mapHashToField$1(s,secp256k1_CURVE$1.n);secp256k1$1.utils.randomSecretKey;function r(s){const i=t(s);return{secretKey:i,publicKey:schnorrGetPublicKey$1(i)}}return{keygen:r,getPublicKey:schnorrGetPublicKey$1,sign:schnorrSign$1,verify:schnorrVerify$1,Point:Pointk1$1,utils:{randomSecretKey:t,randomPrivateKey:t,taggedHash:taggedHash$1,lift_x:lift_x$1,pointToBytes:pointToBytes$1,numberToBytesBE:numberToBytesBE$1,bytesToNumberBE:bytesToNumberBE$1,mod:mod$1},lengths:{secretKey:32,publicKey:32,publicKeyHasPrefix:!1,signature:32*2,seed:48}}})(),sha256$2=sha256$3;var dist={},LRUCache$1={},LRUCacheNode$1={};Object.defineProperty(LRUCacheNode$1,"__esModule",{value:!0});LRUCacheNode$1.LRUCacheNode=void 0;class LRUCacheNode{constructor(e,t,r){const{entryExpirationTimeInMS:s=null,next:i=null,prev:a=null,onEntryEvicted:u,onEntryMarkedAsMostRecentlyUsed:l,clone:p,cloneFn:g}=r??{};if(typeof s=="number"&&(s<=0||Number.isNaN(s)))throw new Error("entryExpirationTimeInMS must either be null (no expiry) or greater than 0");this.clone=p??!1,this.cloneFn=g??this.defaultClone,this.key=e,this.internalValue=this.clone?this.cloneFn(t):t,this.created=Date.now(),this.entryExpirationTimeInMS=s,this.next=i,this.prev=a,this.onEntryEvicted=u,this.onEntryMarkedAsMostRecentlyUsed=l}get value(){return this.clone?this.cloneFn(this.internalValue):this.internalValue}get isExpired(){return typeof this.entryExpirationTimeInMS=="number"&&Date.now()-this.created>this.entryExpirationTimeInMS}invokeOnEvicted(){if(this.onEntryEvicted){const{key:e,value:t,isExpired:r}=this;this.onEntryEvicted({key:e,value:t,isExpired:r})}}invokeOnEntryMarkedAsMostRecentlyUsed(){if(this.onEntryMarkedAsMostRecentlyUsed){const{key:e,value:t}=this;this.onEntryMarkedAsMostRecentlyUsed({key:e,value:t})}}defaultClone(e){return typeof e=="boolean"||typeof e=="string"||typeof e=="number"?e:JSON.parse(JSON.stringify(e))}}LRUCacheNode$1.LRUCacheNode=LRUCacheNode;Object.defineProperty(LRUCache$1,"__esModule",{value:!0});LRUCache$1.LRUCache=void 0;const LRUCacheNode_1=LRUCacheNode$1;class LRUCache{constructor(e){this.lookupTable=new Map,this.head=null,this.tail=null;const{maxSize:t=25,entryExpirationTimeInMS:r=null,onEntryEvicted:s,onEntryMarkedAsMostRecentlyUsed:i,cloneFn:a,clone:u}=e??{};if(Number.isNaN(t)||t<=0)throw new Error("maxSize must be greater than 0.");if(typeof r=="number"&&(r<=0||Number.isNaN(r)))throw new Error("entryExpirationTimeInMS must either be null (no expiry) or greater than 0");this.maxSizeInternal=t,this.entryExpirationTimeInMS=r,this.onEntryEvicted=s,this.onEntryMarkedAsMostRecentlyUsed=i,this.clone=u,this.cloneFn=a}get size(){return this.cleanCache(),this.lookupTable.size}get remainingSize(){return this.maxSizeInternal-this.size}get newest(){return this.head?this.head.isExpired?(this.removeNodeFromListAndLookupTable(this.head),this.newest):this.mapNodeToEntry(this.head):null}get oldest(){return this.tail?this.tail.isExpired?(this.removeNodeFromListAndLookupTable(this.tail),this.oldest):this.mapNodeToEntry(this.tail):null}get maxSize(){return this.maxSizeInternal}set maxSize(e){if(Number.isNaN(e)||e<=0)throw new Error("maxSize must be greater than 0.");this.maxSizeInternal=e,this.enforceSizeLimit()}set(e,t,r){const s=this.lookupTable.get(e);s&&this.removeNodeFromListAndLookupTable(s);const i=new LRUCacheNode_1.LRUCacheNode(e,t,{entryExpirationTimeInMS:this.entryExpirationTimeInMS,onEntryEvicted:this.onEntryEvicted,onEntryMarkedAsMostRecentlyUsed:this.onEntryMarkedAsMostRecentlyUsed,clone:this.clone,cloneFn:this.cloneFn,...r});return this.setNodeAsHead(i),this.lookupTable.set(e,i),this.enforceSizeLimit(),this}get(e){const t=this.lookupTable.get(e);return t?t.isExpired?(this.removeNodeFromListAndLookupTable(t),null):(this.setNodeAsHead(t),t.value):null}peek(e){const t=this.lookupTable.get(e);return t?t.isExpired?(this.removeNodeFromListAndLookupTable(t),null):t.value:null}delete(e){const t=this.lookupTable.get(e);return t?this.removeNodeFromListAndLookupTable(t):!1}has(e){const t=this.lookupTable.get(e);return t?t.isExpired?(this.removeNodeFromListAndLookupTable(t),!1):!0:!1}clear(){this.head=null,this.tail=null,this.lookupTable.clear()}find(e){let t=this.head;for(;t;){if(t.isExpired){const s=t.next;this.removeNodeFromListAndLookupTable(t),t=s;continue}const r=this.mapNodeToEntry(t);if(e(r))return this.setNodeAsHead(t),r;t=t.next}return null}forEach(e){let t=this.head,r=0;for(;t;){if(t.isExpired){const s=t.next;this.removeNodeFromListAndLookupTable(t),t=s;continue}e(t.value,t.key,r),t=t.next,r++}}*values(){let e=this.head;for(;e;){if(e.isExpired){const t=e.next;this.removeNodeFromListAndLookupTable(e),e=t;continue}yield e.value,e=e.next}}*keys(){let e=this.head;for(;e;){if(e.isExpired){const t=e.next;this.removeNodeFromListAndLookupTable(e),e=t;continue}yield e.key,e=e.next}}*entries(){let e=this.head;for(;e;){if(e.isExpired){const t=e.next;this.removeNodeFromListAndLookupTable(e),e=t;continue}yield this.mapNodeToEntry(e),e=e.next}}*[Symbol.iterator](){let e=this.head;for(;e;){if(e.isExpired){const t=e.next;this.removeNodeFromListAndLookupTable(e),e=t;continue}yield this.mapNodeToEntry(e),e=e.next}}enforceSizeLimit(){let e=this.tail;for(;e!==null&&this.size>this.maxSizeInternal;){const t=e.prev;this.removeNodeFromListAndLookupTable(e),e=t}}mapNodeToEntry({key:e,value:t}){return{key:e,value:t}}setNodeAsHead(e){this.removeNodeFromList(e),this.head?(e.next=this.head,this.head.prev=e,this.head=e):(this.head=e,this.tail=e),e.invokeOnEntryMarkedAsMostRecentlyUsed()}removeNodeFromList(e){e.prev!==null&&(e.prev.next=e.next),e.next!==null&&(e.next.prev=e.prev),this.head===e&&(this.head=e.next),this.tail===e&&(this.tail=e.prev),e.next=null,e.prev=null}removeNodeFromListAndLookupTable(e){return e.invokeOnEvicted(),this.removeNodeFromList(e),this.lookupTable.delete(e.key)}cleanCache(){if(!this.entryExpirationTimeInMS)return;const e=[];for(const t of this.lookupTable.values())t.isExpired&&e.push(t);e.forEach(t=>this.removeNodeFromListAndLookupTable(t))}}LRUCache$1.LRUCache=LRUCache;(function(n){var e=commonjsGlobal&&commonjsGlobal.__createBinding||(Object.create?function(r,s,i,a){a===void 0&&(a=i);var u=Object.getOwnPropertyDescriptor(s,i);(!u||("get"in u?!s.__esModule:u.writable||u.configurable))&&(u={enumerable:!0,get:function(){return s[i]}}),Object.defineProperty(r,a,u)}:function(r,s,i,a){a===void 0&&(a=i),r[a]=s[i]}),t=commonjsGlobal&&commonjsGlobal.__exportStar||function(r,s){for(var i in r)i!=="default"&&!Object.prototype.hasOwnProperty.call(s,i)&&e(s,r,i)};Object.defineProperty(n,"__esModule",{value:!0}),t(LRUCache$1,n)})(dist);function pbkdf2Init(n,e,t,r){assert.hash(n);const s=checkOpts({dkLen:32,asyncTick:10},r),{c:i,dkLen:a,asyncTick:u}=s;if(assert.number(i),assert.number(a),assert.number(u),i<1)throw new Error("PBKDF2: iterations (c) should be >= 1");const l=toBytes$2(e),p=toBytes$2(t),g=new Uint8Array(a),v=hmac$2.create(n,l),m=v._cloneInto().update(p);return{c:i,dkLen:a,asyncTick:u,DK:g,PRF:v,PRFSalt:m}}function pbkdf2Output(n,e,t,r,s){return n.destroy(),e.destroy(),r&&r.destroy(),s.fill(0),t}function pbkdf2(n,e,t,r){const{c:s,dkLen:i,DK:a,PRF:u,PRFSalt:l}=pbkdf2Init(n,e,t,r);let p;const g=new Uint8Array(4),v=createView$2(g),m=new Uint8Array(u.outputLen);for(let w=1,T=0;T<i;w++,T+=u.outputLen){const P=a.subarray(T,T+u.outputLen);v.setInt32(0,w,!1),(p=l._cloneInto(p)).update(g).digestInto(m),P.set(m.subarray(0,P.length));for(let W=1;W<s;W++){u._cloneInto(p).update(m).digestInto(m);for(let X=0;X<P.length;X++)P[X]^=m[X]}}return pbkdf2Output(u,l,a,p,m)}const rotl=(n,e)=>n<<e|n>>>32-e;function XorAndSalsa(n,e,t,r,s,i){let a=n[e++]^t[r++],u=n[e++]^t[r++],l=n[e++]^t[r++],p=n[e++]^t[r++],g=n[e++]^t[r++],v=n[e++]^t[r++],m=n[e++]^t[r++],w=n[e++]^t[r++],T=n[e++]^t[r++],P=n[e++]^t[r++],W=n[e++]^t[r++],X=n[e++]^t[r++],ke=n[e++]^t[r++],ne=n[e++]^t[r++],ye=n[e++]^t[r++],Se=n[e++]^t[r++],Ee=a,ve=u,Ne=l,ie=p,De=g,H=v,U=m,E=w,$=T,_=P,A=W,M=X,G=ke,j=ne,z=ye,V=Se;for(let J=0;J<8;J+=2)De^=rotl(Ee+G|0,7),$^=rotl(De+Ee|0,9),G^=rotl($+De|0,13),Ee^=rotl(G+$|0,18),_^=rotl(H+ve|0,7),j^=rotl(_+H|0,9),ve^=rotl(j+_|0,13),H^=rotl(ve+j|0,18),z^=rotl(A+U|0,7),Ne^=rotl(z+A|0,9),U^=rotl(Ne+z|0,13),A^=rotl(U+Ne|0,18),ie^=rotl(V+M|0,7),E^=rotl(ie+V|0,9),M^=rotl(E+ie|0,13),V^=rotl(M+E|0,18),ve^=rotl(Ee+ie|0,7),Ne^=rotl(ve+Ee|0,9),ie^=rotl(Ne+ve|0,13),Ee^=rotl(ie+Ne|0,18),U^=rotl(H+De|0,7),E^=rotl(U+H|0,9),De^=rotl(E+U|0,13),H^=rotl(De+E|0,18),M^=rotl(A+_|0,7),$^=rotl(M+A|0,9),_^=rotl($+M|0,13),A^=rotl(_+$|0,18),G^=rotl(V+z|0,7),j^=rotl(G+V|0,9),z^=rotl(j+G|0,13),V^=rotl(z+j|0,18);s[i++]=a+Ee|0,s[i++]=u+ve|0,s[i++]=l+Ne|0,s[i++]=p+ie|0,s[i++]=g+De|0,s[i++]=v+H|0,s[i++]=m+U|0,s[i++]=w+E|0,s[i++]=T+$|0,s[i++]=P+_|0,s[i++]=W+A|0,s[i++]=X+M|0,s[i++]=ke+G|0,s[i++]=ne+j|0,s[i++]=ye+z|0,s[i++]=Se+V|0}function BlockMix(n,e,t,r,s){let i=r+0,a=r+16*s;for(let u=0;u<16;u++)t[a+u]=n[e+(2*s-1)*16+u];for(let u=0;u<s;u++,i+=16,e+=16)XorAndSalsa(t,a,n,e,t,i),u>0&&(a+=16),XorAndSalsa(t,i,n,e+=16,t,a)}function scryptInit(n,e,t){const r=checkOpts({dkLen:32,asyncTick:10,maxmem:1073742848},t),{N:s,r:i,p:a,dkLen:u,asyncTick:l,maxmem:p,onProgress:g}=r;if(assert.number(s),assert.number(i),assert.number(a),assert.number(u),assert.number(l),assert.number(p),g!==void 0&&typeof g!="function")throw new Error("progressCb should be function");const v=128*i,m=v/4;if(s<=1||s&s-1||s>=2**(v/8)||s>2**32)throw new Error("Scrypt: N must be larger than 1, a power of 2, less than 2^(128 * r / 8) and less than 2^32");if(a<0||a>(2**32-1)*32/v)throw new Error("Scrypt: p must be a positive integer less than or equal to ((2^32 - 1) * 32) / (128 * r)");if(u<0||u>(2**32-1)*32)throw new Error("Scrypt: dkLen should be positive integer less than or equal to (2^32 - 1) * 32");const w=v*(s+a);if(w>p)throw new Error(`Scrypt: parameters too large, ${w} (128 * r * (N + p)) > ${p} (maxmem)`);const T=pbkdf2(sha256$4,n,e,{c:1,dkLen:v*a}),P=u32(T),W=u32(new Uint8Array(v*s)),X=u32(new Uint8Array(v));let ke=()=>{};if(g){const ne=2*s*a,ye=Math.max(Math.floor(ne/1e4),1);let Se=0;ke=()=>{Se++,g&&(!(Se%ye)||Se===ne)&&g(Se/ne)}}return{N:s,r:i,p:a,dkLen:u,blockSize32:m,V:W,B32:P,B:T,tmp:X,blockMixCb:ke,asyncTick:l}}function scryptOutput(n,e,t,r,s){const i=pbkdf2(sha256$4,n,t,{c:1,dkLen:e});return t.fill(0),r.fill(0),s.fill(0),i}function scrypt(n,e,t){const{N:r,r:s,p:i,dkLen:a,blockSize32:u,V:l,B32:p,B:g,tmp:v,blockMixCb:m}=scryptInit(n,e,t);for(let w=0;w<i;w++){const T=u*w;for(let P=0;P<u;P++)l[P]=p[T+P];for(let P=0,W=0;P<r-1;P++)BlockMix(l,W,l,W+=u,s),m();BlockMix(l,(r-1)*u,p,T,s),m();for(let P=0;P<r;P++){const W=p[T+u-16]%r;for(let X=0;X<u;X++)v[X]=p[T+X]^l[W*u+X];BlockMix(v,0,p,T,s),m()}}return scryptOutput(n,a,g,l,v)}var Bech32MaxSize$1=5e3;function encodeBech32$1(n,e){let t=bech32$1.toWords(e);return bech32$1.encode(n,t,Bech32MaxSize$1)}function encodeBytes$1(n,e){return encodeBech32$1(n,e)}function encrypt$2(n,e,t=16,r=2){let s=randomBytes$2(16),i=2**t,a=scrypt(e.normalize("NFKC"),s,{N:i,r:8,p:1,dkLen:32}),u=randomBytes$2(24),l=Uint8Array.from([r]),g=xchacha20poly1305(a,u,l).encrypt(n),v=concatBytes$2(Uint8Array.from([2]),Uint8Array.from([t]),s,u,l,g);return encodeBytes$1("ncryptsec",v)}function decrypt$2(n,e){let{prefix:t,words:r}=bech32$1.decode(n,Bech32MaxSize$1);if(t!=="ncryptsec")throw new Error(`invalid prefix ${t}, expected 'ncryptsec'`);let s=new Uint8Array(bech32$1.fromWords(r)),i=s[0];if(i!==2)throw new Error(`invalid version ${i}, expected 0x02`);let u=2**s[1],l=s.slice(2,18),p=s.slice(18,42),g=s[42],v=Uint8Array.from([g]),m=s.slice(43),w=scrypt(e.normalize("NFKC"),l,{N:u,r:8,p:1,dkLen:32});return xchacha20poly1305(w,p,v).decrypt(m)}const nip49_star=Object.freeze(Object.defineProperty({__proto__:null,decrypt:decrypt$2,encrypt:encrypt$2},Symbol.toStringTag,{value:"Module"}));var utf8Decoder=new TextDecoder("utf-8"),utf8Encoder=new TextEncoder,NostrTypeGuard={isNProfile:n=>/^nprofile1[a-z\d]+$/.test(n||""),isNEvent:n=>/^nevent1[a-z\d]+$/.test(n||""),isNAddr:n=>/^naddr1[a-z\d]+$/.test(n||""),isNSec:n=>/^nsec1[a-z\d]{58}$/.test(n||""),isNPub:n=>/^npub1[a-z\d]{58}$/.test(n||""),isNote:n=>/^note1[a-z\d]+$/.test(n||""),isNcryptsec:n=>/^ncryptsec1[a-z\d]+$/.test(n||"")},Bech32MaxSize=5e3,BECH32_REGEX$1=/[\x21-\x7E]{1,83}1[023456789acdefghjklmnpqrstuvwxyz]{6,}/;function integerToUint8Array(n){const e=new Uint8Array(4);return e[0]=n>>24&255,e[1]=n>>16&255,e[2]=n>>8&255,e[3]=n&255,e}function decodeNostrURI(n){try{return n.startsWith("nostr:")&&(n=n.substring(6)),decode(n)}catch{return{type:"invalid",data:null}}}function decode(n){let{prefix:e,words:t}=bech32$1.decode(n,Bech32MaxSize),r=new Uint8Array(bech32$1.fromWords(t));switch(e){case"nprofile":{let s=parseTLV(r);if(!s[0]?.[0])throw new Error("missing TLV 0 for nprofile");if(s[0][0].length!==32)throw new Error("TLV 0 should be 32 bytes");return{type:"nprofile",data:{pubkey:bytesToHex$2(s[0][0]),relays:s[1]?s[1].map(i=>utf8Decoder.decode(i)):[]}}}case"nevent":{let s=parseTLV(r);if(!s[0]?.[0])throw new Error("missing TLV 0 for nevent");if(s[0][0].length!==32)throw new Error("TLV 0 should be 32 bytes");if(s[2]&&s[2][0].length!==32)throw new Error("TLV 2 should be 32 bytes");if(s[3]&&s[3][0].length!==4)throw new Error("TLV 3 should be 4 bytes");return{type:"nevent",data:{id:bytesToHex$2(s[0][0]),relays:s[1]?s[1].map(i=>utf8Decoder.decode(i)):[],author:s[2]?.[0]?bytesToHex$2(s[2][0]):void 0,kind:s[3]?.[0]?parseInt(bytesToHex$2(s[3][0]),16):void 0}}}case"naddr":{let s=parseTLV(r);if(!s[0]?.[0])throw new Error("missing TLV 0 for naddr");if(!s[2]?.[0])throw new Error("missing TLV 2 for naddr");if(s[2][0].length!==32)throw new Error("TLV 2 should be 32 bytes");if(!s[3]?.[0])throw new Error("missing TLV 3 for naddr");if(s[3][0].length!==4)throw new Error("TLV 3 should be 4 bytes");return{type:"naddr",data:{identifier:utf8Decoder.decode(s[0][0]),pubkey:bytesToHex$2(s[2][0]),kind:parseInt(bytesToHex$2(s[3][0]),16),relays:s[1]?s[1].map(i=>utf8Decoder.decode(i)):[]}}}case"nsec":return{type:e,data:r};case"npub":case"note":return{type:e,data:bytesToHex$2(r)};default:throw new Error(`unknown prefix ${e}`)}}function parseTLV(n){let e={},t=n;for(;t.length>0;){let r=t[0],s=t[1],i=t.slice(2,2+s);if(t=t.slice(2+s),i.length<s)throw new Error(`not enough data to read on TLV ${r}`);e[r]=e[r]||[],e[r].push(i)}return e}function nsecEncode(n){return encodeBytes("nsec",n)}function npubEncode(n){return encodeBytes("npub",hexToBytes$2(n))}function noteEncode(n){return encodeBytes("note",hexToBytes$2(n))}function encodeBech32(n,e){let t=bech32$1.toWords(e);return bech32$1.encode(n,t,Bech32MaxSize)}function encodeBytes(n,e){return encodeBech32(n,e)}function nprofileEncode(n){let e=encodeTLV({0:[hexToBytes$2(n.pubkey)],1:(n.relays||[]).map(t=>utf8Encoder.encode(t))});return encodeBech32("nprofile",e)}function neventEncode(n){let e;n.kind!==void 0&&(e=integerToUint8Array(n.kind));let t=encodeTLV({0:[hexToBytes$2(n.id)],1:(n.relays||[]).map(r=>utf8Encoder.encode(r)),2:n.author?[hexToBytes$2(n.author)]:[],3:e?[new Uint8Array(e)]:[]});return encodeBech32("nevent",t)}function naddrEncode(n){let e=new ArrayBuffer(4);new DataView(e).setUint32(0,n.kind,!1);let t=encodeTLV({0:[utf8Encoder.encode(n.identifier)],1:(n.relays||[]).map(r=>utf8Encoder.encode(r)),2:[hexToBytes$2(n.pubkey)],3:[new Uint8Array(e)]});return encodeBech32("naddr",t)}function encodeTLV(n){let e=[];return Object.entries(n).reverse().forEach(([t,r])=>{r.forEach(s=>{let i=new Uint8Array(s.length+2);i.set([parseInt(t)],0),i.set([s.length],1),i.set(s,2),e.push(i)})}),concatBytes$2(...e)}const nip19_star=Object.freeze(Object.defineProperty({__proto__:null,BECH32_REGEX:BECH32_REGEX$1,Bech32MaxSize,NostrTypeGuard,decode,decodeNostrURI,encodeBytes,naddrEncode,neventEncode,noteEncode,nprofileEncode,npubEncode,nsecEncode},Symbol.toStringTag,{value:"Module"}));var lib={};(function(n){/*! scure-base - MIT License (c) 2022 Paul Miller (paulmillr.com) */Object.defineProperty(n,"__esModule",{value:!0}),n.bytes=n.stringToBytes=n.str=n.bytesToString=n.hex=n.utf8=n.bech32m=n.bech32=n.base58check=n.base58xmr=n.base58xrp=n.base58flickr=n.base58=n.base64url=n.base64=n.base32crockford=n.base32hex=n.base32=n.base16=n.utils=n.assertNumber=void 0;function e(H){if(!Number.isSafeInteger(H))throw new Error(`Wrong integer: ${H}`)}n.assertNumber=e;function t(...H){const U=(_,A)=>M=>_(A(M)),E=Array.from(H).reverse().reduce((_,A)=>_?U(_,A.encode):A.encode,void 0),$=H.reduce((_,A)=>_?U(_,A.decode):A.decode,void 0);return{encode:E,decode:$}}function r(H){return{encode:U=>{if(!Array.isArray(U)||U.length&&typeof U[0]!="number")throw new Error("alphabet.encode input should be an array of numbers");return U.map(E=>{if(e(E),E<0||E>=H.length)throw new Error(`Digit index outside alphabet: ${E} (alphabet: ${H.length})`);return H[E]})},decode:U=>{if(!Array.isArray(U)||U.length&&typeof U[0]!="string")throw new Error("alphabet.decode input should be array of strings");return U.map(E=>{if(typeof E!="string")throw new Error(`alphabet.decode: not string element=${E}`);const $=H.indexOf(E);if($===-1)throw new Error(`Unknown letter: "${E}". Allowed: ${H}`);return $})}}}function s(H=""){if(typeof H!="string")throw new Error("join separator should be string");return{encode:U=>{if(!Array.isArray(U)||U.length&&typeof U[0]!="string")throw new Error("join.encode input should be array of strings");for(let E of U)if(typeof E!="string")throw new Error(`join.encode: non-string input=${E}`);return U.join(H)},decode:U=>{if(typeof U!="string")throw new Error("join.decode input should be string");return U.split(H)}}}function i(H,U="="){if(e(H),typeof U!="string")throw new Error("padding chr should be string");return{encode(E){if(!Array.isArray(E)||E.length&&typeof E[0]!="string")throw new Error("padding.encode input should be array of strings");for(let $ of E)if(typeof $!="string")throw new Error(`padding.encode: non-string input=${$}`);for(;E.length*H%8;)E.push(U);return E},decode(E){if(!Array.isArray(E)||E.length&&typeof E[0]!="string")throw new Error("padding.encode input should be array of strings");for(let _ of E)if(typeof _!="string")throw new Error(`padding.decode: non-string input=${_}`);let $=E.length;if($*H%8)throw new Error("Invalid padding: string should have whole number of bytes");for(;$>0&&E[$-1]===U;$--)if(!(($-1)*H%8))throw new Error("Invalid padding: string has too much padding");return E.slice(0,$)}}}function a(H){if(typeof H!="function")throw new Error("normalize fn should be function");return{encode:U=>U,decode:U=>H(U)}}function u(H,U,E){if(U<2)throw new Error(`convertRadix: wrong from=${U}, base cannot be less than 2`);if(E<2)throw new Error(`convertRadix: wrong to=${E}, base cannot be less than 2`);if(!Array.isArray(H))throw new Error("convertRadix: data should be array");if(!H.length)return[];let $=0;const _=[],A=Array.from(H);for(A.forEach(M=>{if(e(M),M<0||M>=U)throw new Error(`Wrong integer: ${M}`)});;){let M=0,G=!0;for(let j=$;j<A.length;j++){const z=A[j],V=U*M+z;if(!Number.isSafeInteger(V)||U*M/U!==M||V-z!==U*M)throw new Error("convertRadix: carry overflow");if(M=V%E,A[j]=Math.floor(V/E),!Number.isSafeInteger(A[j])||A[j]*E+M!==V)throw new Error("convertRadix: carry overflow");if(G)A[j]?G=!1:$=j;else continue}if(_.push(M),G)break}for(let M=0;M<H.length-1&&H[M]===0;M++)_.push(0);return _.reverse()}const l=(H,U)=>U?l(U,H%U):H,p=(H,U)=>H+(U-l(H,U));function g(H,U,E,$){if(!Array.isArray(H))throw new Error("convertRadix2: data should be array");if(U<=0||U>32)throw new Error(`convertRadix2: wrong from=${U}`);if(E<=0||E>32)throw new Error(`convertRadix2: wrong to=${E}`);if(p(U,E)>32)throw new Error(`convertRadix2: carry overflow from=${U} to=${E} carryBits=${p(U,E)}`);let _=0,A=0;const M=2**E-1,G=[];for(const j of H){if(e(j),j>=2**U)throw new Error(`convertRadix2: invalid data word=${j} from=${U}`);if(_=_<<U|j,A+U>32)throw new Error(`convertRadix2: carry overflow pos=${A} from=${U}`);for(A+=U;A>=E;A-=E)G.push((_>>A-E&M)>>>0);_&=2**A-1}if(_=_<<E-A&M,!$&&A>=U)throw new Error("Excess padding");if(!$&&_)throw new Error(`Non-zero padding: ${_}`);return $&&A>0&&G.push(_>>>0),G}function v(H){return e(H),{encode:U=>{if(!(U instanceof Uint8Array))throw new Error("radix.encode input should be Uint8Array");return u(Array.from(U),2**8,H)},decode:U=>{if(!Array.isArray(U)||U.length&&typeof U[0]!="number")throw new Error("radix.decode input should be array of strings");return Uint8Array.from(u(U,H,2**8))}}}function m(H,U=!1){if(e(H),H<=0||H>32)throw new Error("radix2: bits should be in (0..32]");if(p(8,H)>32||p(H,8)>32)throw new Error("radix2: carry overflow");return{encode:E=>{if(!(E instanceof Uint8Array))throw new Error("radix2.encode input should be Uint8Array");return g(Array.from(E),8,H,!U)},decode:E=>{if(!Array.isArray(E)||E.length&&typeof E[0]!="number")throw new Error("radix2.decode input should be array of strings");return Uint8Array.from(g(E,H,8,U))}}}function w(H){if(typeof H!="function")throw new Error("unsafeWrapper fn should be function");return function(...U){try{return H.apply(null,U)}catch{}}}function T(H,U){if(e(H),typeof U!="function")throw new Error("checksum fn should be function");return{encode(E){if(!(E instanceof Uint8Array))throw new Error("checksum.encode: input should be Uint8Array");const $=U(E).slice(0,H),_=new Uint8Array(E.length+H);return _.set(E),_.set($,E.length),_},decode(E){if(!(E instanceof Uint8Array))throw new Error("checksum.decode: input should be Uint8Array");const $=E.slice(0,-H),_=U($).slice(0,H),A=E.slice(-H);for(let M=0;M<H;M++)if(_[M]!==A[M])throw new Error("Invalid checksum");return $}}}n.utils={alphabet:r,chain:t,checksum:T,radix:v,radix2:m,join:s,padding:i},n.base16=t(m(4),r("0123456789ABCDEF"),s("")),n.base32=t(m(5),r("ABCDEFGHIJKLMNOPQRSTUVWXYZ234567"),i(5),s("")),n.base32hex=t(m(5),r("0123456789ABCDEFGHIJKLMNOPQRSTUV"),i(5),s("")),n.base32crockford=t(m(5),r("0123456789ABCDEFGHJKMNPQRSTVWXYZ"),s(""),a(H=>H.toUpperCase().replace(/O/g,"0").replace(/[IL]/g,"1"))),n.base64=t(m(6),r("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"),i(6),s("")),n.base64url=t(m(6),r("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_"),i(6),s(""));const P=H=>t(v(58),r(H),s(""));n.base58=P("123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"),n.base58flickr=P("123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"),n.base58xrp=P("rpshnaf39wBUDNEGHJKLM4PQRST7VWXYZ2bcdeCg65jkm8oFqi1tuvAxyz");const W=[0,2,3,5,6,7,9,10,11];n.base58xmr={encode(H){let U="";for(let E=0;E<H.length;E+=8){const $=H.subarray(E,E+8);U+=n.base58.encode($).padStart(W[$.length],"1")}return U},decode(H){let U=[];for(let E=0;E<H.length;E+=11){const $=H.slice(E,E+11),_=W.indexOf($.length),A=n.base58.decode($);for(let M=0;M<A.length-_;M++)if(A[M]!==0)throw new Error("base58xmr: wrong padding");U=U.concat(Array.from(A.slice(A.length-_)))}return Uint8Array.from(U)}};const X=H=>t(T(4,U=>H(H(U))),n.base58);n.base58check=X;const ke=t(r("qpzry9x8gf2tvdw0s3jn54khce6mua7l"),s("")),ne=[996825010,642813549,513874426,1027748829,705979059];function ye(H){const U=H>>25;let E=(H&33554431)<<5;for(let $=0;$<ne.length;$++)(U>>$&1)===1&&(E^=ne[$]);return E}function Se(H,U,E=1){const $=H.length;let _=1;for(let A=0;A<$;A++){const M=H.charCodeAt(A);if(M<33||M>126)throw new Error(`Invalid prefix (${H})`);_=ye(_)^M>>5}_=ye(_);for(let A=0;A<$;A++)_=ye(_)^H.charCodeAt(A)&31;for(let A of U)_=ye(_)^A;for(let A=0;A<6;A++)_=ye(_);return _^=E,ke.encode(g([_%2**30],30,5,!1))}function Ee(H){const U=H==="bech32"?1:734539939,E=m(5),$=E.decode,_=E.encode,A=w($);function M(V,J,fe=90){if(typeof V!="string")throw new Error(`bech32.encode prefix should be string, not ${typeof V}`);if(!Array.isArray(J)||J.length&&typeof J[0]!="number")throw new Error(`bech32.encode words should be array of numbers, not ${typeof J}`);const he=V.length+7+J.length;if(fe!==!1&&he>fe)throw new TypeError(`Length ${he} exceeds limit ${fe}`);return V=V.toLowerCase(),`${V}1${ke.encode(J)}${Se(V,J,U)}`}function G(V,J=90){if(typeof V!="string")throw new Error(`bech32.decode input should be string, not ${typeof V}`);if(V.length<8||J!==!1&&V.length>J)throw new TypeError(`Wrong string length: ${V.length} (${V}). Expected (8..${J})`);const fe=V.toLowerCase();if(V!==fe&&V!==V.toUpperCase())throw new Error("String must be lowercase or uppercase");V=fe;const he=V.lastIndexOf("1");if(he===0||he===-1)throw new Error('Letter "1" must be present between prefix and data only');const ue=V.slice(0,he),pe=V.slice(he+1);if(pe.length<6)throw new Error("Data must be at least 6 characters long");const ge=ke.decode(pe).slice(0,-6),Re=Se(ue,ge,U);if(!pe.endsWith(Re))throw new Error(`Invalid checksum in ${V}: expected "${Re}"`);return{prefix:ue,words:ge}}const j=w(G);function z(V){const{prefix:J,words:fe}=G(V,!1);return{prefix:J,words:fe,bytes:$(fe)}}return{encode:M,decode:G,decodeToBytes:z,decodeUnsafe:j,fromWords:$,fromWordsUnsafe:A,toWords:_}}n.bech32=Ee("bech32"),n.bech32m=Ee("bech32m"),n.utf8={encode:H=>new TextDecoder().decode(H),decode:H=>new TextEncoder().encode(H)},n.hex=t(m(4),r("0123456789abcdef"),s(""),a(H=>{if(typeof H!="string"||H.length%2)throw new TypeError(`hex.decode: expected string, got ${typeof H} with length ${H.length}`);return H.toLowerCase()}));const ve={utf8:n.utf8,hex:n.hex,base16:n.base16,base32:n.base32,base64:n.base64,base64url:n.base64url,base58:n.base58,base58xmr:n.base58xmr},Ne=`Invalid encoding type. Available types: ${Object.keys(ve).join(", ")}`,ie=(H,U)=>{if(typeof H!="string"||!ve.hasOwnProperty(H))throw new TypeError(Ne);if(!(U instanceof Uint8Array))throw new TypeError("bytesToString() expects Uint8Array");return ve[H].encode(U)};n.bytesToString=ie,n.str=n.bytesToString;const De=(H,U)=>{if(!ve.hasOwnProperty(H))throw new TypeError(Ne);if(typeof U!="string")throw new TypeError("stringToBytes() expects string");return ve[H].decode(U)};n.stringToBytes=De,n.bytes=n.stringToBytes})(lib);const{bech32,hex,utf8}=lib;BigInt(1e3),BigInt(1e6),BigInt(1e9),BigInt(1e12);BigInt("2100000000000000000");BigInt(1e11);const TAGCODES={payment_hash:1,payment_secret:16,description:13,payee:19,description_hash:23,expiry:6,min_final_cltv_expiry:24,fallback_address:9,route_hint:3,feature_bits:5,metadata:27};for(let n=0,e=Object.keys(TAGCODES);n<e.length;n++)e[n],TAGCODES[e[n]].toString();var __defProp$1=Object.defineProperty,__getOwnPropDesc$1=Object.getOwnPropertyDescriptor,__getOwnPropNames$1=Object.getOwnPropertyNames,__hasOwnProp$1=Object.prototype.hasOwnProperty,__copyProps$1=(n,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of __getOwnPropNames$1(e))!__hasOwnProp$1.call(n,s)&&s!==t&&__defProp$1(n,s,{get:()=>e[s],enumerable:!(r=__getOwnPropDesc$1(e,s))||r.enumerable});return n},__reExport$1=(n,e,t)=>(__copyProps$1(n,e,"default"),t);function getRelaysForSync$1(n,e,t="write"){if(!n.outboxTracker)return;const r=n.outboxTracker.data.get(e);if(r)return t==="write"?r.writeRelays:r.readRelays}async function getWriteRelaysFor$1(n,e,t="write"){if(n.outboxTracker)return n.outboxTracker.data.has(e)||await n.outboxTracker.trackUsers([e]),getRelaysForSync$1(n,e,t)}function getTopRelaysForAuthors$1(n,e){const t=new Map;return e.forEach(s=>{const i=getRelaysForSync$1(n,s);i&&i.forEach(a=>{const u=t.get(a)||0;t.set(a,u+1)})}),Array.from(t.entries()).sort((s,i)=>i[1]-s[1]).map(s=>s[0])}function getAllRelaysForAllPubkeys$1(n,e,t="read"){const r=new Map,s=new Set;return e.forEach(i=>{const a=getRelaysForSync$1(n,i,t);a&&a.size>0?(a.forEach(u=>{(r.get(u)||new Set).add(i)}),r.set(i,a)):s.add(i)}),{pubkeysToRelays:r,authorsMissingRelays:s}}function chooseRelayCombinationForPubkeys$1(n,e,t,{count:r,preferredRelays:s}={}){r??=2,s??=new Set;const i=n.pool,a=i.connectedRelays();a.forEach(m=>{s?.add(m.url)});const u=new Map,{pubkeysToRelays:l,authorsMissingRelays:p}=getAllRelaysForAllPubkeys$1(n,e,t),g=getTopRelaysForAuthors$1(n,e),v=(m,w)=>{const T=u.get(w)||[];T.push(m),u.set(w,T)};for(const[m,w]of l.entries()){let T=r;const P=new Set;for(const W of a)w.has(W.url)&&(v(m,W.url),P.add(W.url),T--);for(const W of w)P.has(W)||u.has(W)&&(v(m,W),P.add(W),T--);if(!(T<=0))for(const W of g){if(T<=0)break;P.has(W)||w.has(W)&&(v(m,W),P.add(W),T--)}}for(const m of p)i.permanentAndConnectedRelays().forEach(w=>{const T=u.get(w.url)||[];T.push(m),u.set(w.url,T)});return u}function getRelaysForFilterWithAuthors(n,e,t=2){return chooseRelayCombinationForPubkeys$1(n,e,"write",{count:t})}function tryNormalizeRelayUrl(n){try{return normalizeRelayUrl$1(n)}catch{return}}function normalizeRelayUrl$1(n){let e=normalizeUrl$1(n,{stripAuthentication:!1,stripWWW:!1,stripHash:!0});return e.endsWith("/")||(e+="/"),e}function normalize(n){const e=new Set;for(const t of n)try{e.add(normalizeRelayUrl$1(t))}catch{}return Array.from(e)}var DATA_URL_DEFAULT_MIME_TYPE$1="text/plain",DATA_URL_DEFAULT_CHARSET$1="us-ascii",testParameter$1=(n,e)=>e.some(t=>t instanceof RegExp?t.test(n):t===n),supportedProtocols$1=new Set(["https:","http:","file:"]),hasCustomProtocol$1=n=>{try{const{protocol:e}=new URL(n);return e.endsWith(":")&&!e.includes(".")&&!supportedProtocols$1.has(e)}catch{return!1}},normalizeDataURL$1=(n,{stripHash:e})=>{const t=/^data:(?<type>[^,]*?),(?<data>[^#]*?)(?:#(?<hash>.*))?$/.exec(n);if(!t)throw new Error(`Invalid URL: ${n}`);const r=t.groups?.type??"",s=t.groups?.data??"";let i=t.groups?.hash??"";const a=r.split(";");i=e?"":i;let u=!1;a[a.length-1]==="base64"&&(a.pop(),u=!0);const l=a.shift()?.toLowerCase()??"",g=[...a.map(v=>{let[m,w=""]=v.split("=").map(T=>T.trim());return m==="charset"&&(w=w.toLowerCase(),w===DATA_URL_DEFAULT_CHARSET$1)?"":`${m}${w?`=${w}`:""}`}).filter(Boolean)];return u&&g.push("base64"),(g.length>0||l&&l!==DATA_URL_DEFAULT_MIME_TYPE$1)&&g.unshift(l),`data:${g.join(";")},${u?s.trim():s}${i?`#${i}`:""}`};function normalizeUrl$1(n,e={}){if(e={defaultProtocol:"http",normalizeProtocol:!0,forceHttp:!1,forceHttps:!1,stripAuthentication:!0,stripHash:!1,stripTextFragment:!0,stripWWW:!0,removeQueryParameters:[/^utm_\w+/i],removeTrailingSlash:!0,removeSingleSlash:!0,removeDirectoryIndex:!1,removeExplicitPort:!1,sortQueryParameters:!0,...e},typeof e.defaultProtocol=="string"&&!e.defaultProtocol.endsWith(":")&&(e.defaultProtocol=`${e.defaultProtocol}:`),n=n.trim(),/^data:/i.test(n))return normalizeDataURL$1(n,e);if(hasCustomProtocol$1(n))return n;const t=n.startsWith("//");!t&&/^\.*\//.test(n)||(n=n.replace(/^(?!(?:\w+:)?\/\/)|^\/\//,e.defaultProtocol));const s=new URL(n);if(s.hostname=s.hostname.toLowerCase(),e.forceHttp&&e.forceHttps)throw new Error("The `forceHttp` and `forceHttps` options cannot be used together");if(e.forceHttp&&s.protocol==="https:"&&(s.protocol="http:"),e.forceHttps&&s.protocol==="http:"&&(s.protocol="https:"),e.stripAuthentication&&(s.username="",s.password=""),e.stripHash?s.hash="":e.stripTextFragment&&(s.hash=s.hash.replace(/#?:~:text.*?$/i,"")),s.pathname){const a=/\b[a-z][a-z\d+\-.]{1,50}:\/\//g;let u=0,l="";for(;;){const g=a.exec(s.pathname);if(!g)break;const v=g[0],m=g.index,w=s.pathname.slice(u,m);l+=w.replace(/\/{2,}/g,"/"),l+=v,u=m+v.length}const p=s.pathname.slice(u,s.pathname.length);l+=p.replace(/\/{2,}/g,"/"),s.pathname=l}if(s.pathname)try{s.pathname=decodeURI(s.pathname)}catch{}if(e.removeDirectoryIndex===!0&&(e.removeDirectoryIndex=[/^index\.[a-z]+$/]),Array.isArray(e.removeDirectoryIndex)&&e.removeDirectoryIndex.length>0){let a=s.pathname.split("/");const u=a[a.length-1];testParameter$1(u,e.removeDirectoryIndex)&&(a=a.slice(0,-1),s.pathname=`${a.slice(1).join("/")}/`)}if(s.hostname&&(s.hostname=s.hostname.replace(/\.$/,""),e.stripWWW&&/^www\.(?!www\.)[a-z\-\d]{1,63}\.[a-z.\-\d]{2,63}$/.test(s.hostname)&&(s.hostname=s.hostname.replace(/^www\./,""))),Array.isArray(e.removeQueryParameters))for(const a of[...s.searchParams.keys()])testParameter$1(a,e.removeQueryParameters)&&s.searchParams.delete(a);if(!Array.isArray(e.keepQueryParameters)&&e.removeQueryParameters===!0&&(s.search=""),Array.isArray(e.keepQueryParameters)&&e.keepQueryParameters.length>0)for(const a of[...s.searchParams.keys()])testParameter$1(a,e.keepQueryParameters)||s.searchParams.delete(a);if(e.sortQueryParameters){s.searchParams.sort();try{s.search=decodeURIComponent(s.search)}catch{}}e.removeTrailingSlash&&(s.pathname=s.pathname.replace(/\/$/,"")),e.removeExplicitPort&&s.port&&(s.port="");const i=n;return n=s.toString(),!e.removeSingleSlash&&s.pathname==="/"&&!i.endsWith("/")&&s.hash===""&&(n=n.replace(/\/$/,"")),(e.removeTrailingSlash||s.pathname==="/")&&s.hash===""&&e.removeSingleSlash&&(n=n.replace(/\/$/,"")),t&&!e.normalizeProtocol&&(n=n.replace(/^http:\/\//,"//")),e.stripProtocol&&(n=n.replace(/^(?:https?:)?\/\//,"")),n}var NDKRelayKeepalive$1=class{constructor(e=3e4,t){this.onSilenceDetected=t,this.timeout=e}lastActivity=Date.now();timer;timeout;isRunning=!1;recordActivity(){this.lastActivity=Date.now(),this.isRunning&&this.resetTimer()}start(){this.isRunning||(this.isRunning=!0,this.lastActivity=Date.now(),this.resetTimer())}stop(){this.isRunning=!1,this.timer&&(clearTimeout(this.timer),this.timer=void 0)}resetTimer(){this.timer&&clearTimeout(this.timer),this.timer=setTimeout(()=>{const e=Date.now()-this.lastActivity;if(e>=this.timeout)this.onSilenceDetected();else{const t=this.timeout-e;this.timer=setTimeout(()=>{this.onSilenceDetected()},t)}},this.timeout)}};async function probeRelayConnection$1(n){const e=`probe-${Math.random().toString(36).substring(7)}`;return new Promise(t=>{let r=!1;const s=setTimeout(()=>{r||(r=!0,n.send(["CLOSE",e]),t(!1))},5e3),i=()=>{r||(r=!0,clearTimeout(s),n.send(["CLOSE",e]),t(!0))};n.once("message",i),n.send(["REQ",e,{kinds:[99999],limit:0}])})}var MAX_RECONNECT_ATTEMPTS$1=5,FLAPPING_THRESHOLD_MS$1=1e3,NDKRelayConnectivity$1=class{ndkRelay;ws;_status;timeoutMs;connectedAt;_connectionStats={attempts:0,success:0,durations:[]};debug;netDebug;connectTimeout;reconnectTimeout;ndk;openSubs=new Map;openCountRequests=new Map;openEventPublishes=new Map;pendingAuthPublishes=new Map;serial=0;baseEoseTimeout=4400;keepalive;wsStateMonitor;sleepDetector;lastSleepCheck=Date.now();lastMessageSent=Date.now();wasIdle=!1;constructor(e,t){this.ndkRelay=e,this._status=1;const r=Math.floor(Math.random()*1e3);this.debug=this.ndkRelay.debug.extend(`connectivity${r}`),this.ndk=t,this.setupMonitoring()}setupMonitoring(){this.keepalive=new NDKRelayKeepalive$1(12e4,async()=>{this.debug("Relay silence detected, probing connection"),await probeRelayConnection$1({send:t=>this.send(JSON.stringify(t)),once:(t,r)=>{const s=i=>{try{const a=JSON.parse(i.data);(a[0]==="EOSE"||a[0]==="EVENT"||a[0]==="NOTICE")&&(r(),this.ws?.removeEventListener("message",s))}catch{}};this.ws?.addEventListener("message",s)}})||(this.debug("Probe failed, connection is stale"),this.handleStaleConnection())}),this.wsStateMonitor=setInterval(()=>{this._status===5&&(!this.ws||this.ws.readyState!==WebSocket.OPEN)&&(this.debug("WebSocket died silently, reconnecting"),this.handleStaleConnection())},5e3),this.sleepDetector=setInterval(()=>{const e=Date.now(),t=e-this.lastSleepCheck;t>15e3&&(this.debug(`Detected possible sleep/wake (${t}ms gap)`),this.handlePossibleWake()),this.lastSleepCheck=e},1e4)}handleStaleConnection(){this._status=1,this.wasIdle=!0,this.onDisconnect()}handlePossibleWake(){this.debug("System wake detected, checking all connections"),this.wasIdle=!0,this._status>=5&&(!this.ws||this.ws.readyState!==WebSocket.OPEN?this.handleStaleConnection():probeRelayConnection$1({send:e=>this.send(JSON.stringify(e)),once:(e,t)=>{const r=s=>{try{const i=JSON.parse(s.data);(i[0]==="EOSE"||i[0]==="EVENT"||i[0]==="NOTICE")&&(t(),this.ws?.removeEventListener("message",r))}catch{}};this.ws?.addEventListener("message",r)}}).then(e=>{e||this.handleStaleConnection()}))}resetReconnectionState(){this.wasIdle=!0,this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=void 0)}async connect(e,t=!0){if(this.ws&&this.ws.readyState!==WebSocket.OPEN&&this.ws.readyState!==WebSocket.CONNECTING){this.debug("Cleaning up stale WebSocket connection");try{this.ws.close()}catch{}this.ws=void 0,this._status=1}if(this._status!==2&&this._status!==1||this.reconnectTimeout){this.debug("Relay requested to be connected but was in state %s or it had a reconnect timeout",this._status);return}this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=void 0),this.connectTimeout&&(clearTimeout(this.connectTimeout),this.connectTimeout=void 0),e??=this.timeoutMs,!this.timeoutMs&&e&&(this.timeoutMs=e),this.timeoutMs&&(this.connectTimeout=setTimeout(()=>this.onConnectionError(t),this.timeoutMs));try{this.updateConnectionStats.attempt(),this._status===1?this._status=4:this._status=2,this.ws=new WebSocket(this.ndkRelay.url),this.ws.onopen=this.onConnect.bind(this),this.ws.onclose=this.onDisconnect.bind(this),this.ws.onmessage=this.onMessage.bind(this),this.ws.onerror=this.onError.bind(this)}catch(r){throw this.debug(`Failed to connect to ${this.ndkRelay.url}`,r),this._status=1,t?this.handleReconnection():this.ndkRelay.emit("delayed-connect",2*24*60*60*1e3),r}}disconnect(){this._status=0,this.keepalive?.stop(),this.wsStateMonitor&&(clearInterval(this.wsStateMonitor),this.wsStateMonitor=void 0),this.sleepDetector&&(clearInterval(this.sleepDetector),this.sleepDetector=void 0);try{this.ws?.close()}catch(e){this.debug("Failed to disconnect",e),this._status=1}}onConnectionError(e){this.debug(`Error connecting to ${this.ndkRelay.url}`,this.timeoutMs),e&&!this.reconnectTimeout&&this.handleReconnection()}onConnect(){this.netDebug?.("connected",this.ndkRelay),this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=void 0),this.connectTimeout&&(clearTimeout(this.connectTimeout),this.connectTimeout=void 0),this.updateConnectionStats.connected(),this._status=5,this.keepalive?.start(),this.wasIdle=!1,this.ndkRelay.emit("connect"),this.ndkRelay.emit("ready")}onDisconnect(){this.netDebug?.("disconnected",this.ndkRelay),this.updateConnectionStats.disconnected(),this.keepalive?.stop(),this.clearPendingPublishes(new Error(`Relay ${this.ndkRelay.url} disconnected`)),this._status===5&&this.handleReconnection(),this._status=1,this.ndkRelay.emit("disconnect")}onMessage(e){this.netDebug?.(e.data,this.ndkRelay,"recv"),this.keepalive?.recordActivity();try{const t=JSON.parse(e.data),[r,s,...i]=t,a=this.ndkRelay.getProtocolHandler(r);if(a){a(this.ndkRelay,t);return}switch(r){case"EVENT":{const u=this.openSubs.get(s),l=t[2];if(!u){this.debug(`Received event for unknown subscription ${s}`);return}u.onevent(l);return}case"COUNT":{const u=t[2],l=this.openCountRequests.get(s);l&&(l.resolve(u.count),this.openCountRequests.delete(s));return}case"EOSE":{const u=this.openSubs.get(s);if(!u)return;u.oneose(s);return}case"OK":{const u=t[2],l=t[3],p=this.openEventPublishes.get(s),g=p?.pop();if(!p||!g){this.debug("Received OK for unknown event publish",s);return}u?(g.resolve(l),this.pendingAuthPublishes.delete(s)):l&&(l.toLowerCase().includes("auth-required")||l.toLowerCase().includes("not authorized")||l.toLowerCase().includes("blocked: not authorized"))?this.pendingAuthPublishes.get(s)?(this.debug("Publish failed due to auth-required, will retry after auth",s),p.push(g),this.openEventPublishes.set(s,p)):g.reject(new Error(l)):(g.reject(new Error(l)),this.pendingAuthPublishes.delete(s)),p.length===0?this.openEventPublishes.delete(s):!u&&!(l?.toLowerCase().includes("auth-required")||l?.toLowerCase().includes("not authorized")||l?.toLowerCase().includes("blocked: not authorized"))&&this.openEventPublishes.set(s,p);return}case"CLOSED":{const u=this.openSubs.get(s);if(!u)return;u.onclosed(t[2]);return}case"NOTICE":this.onNotice(t[1]);return;case"AUTH":{this.onAuthRequested(t[1]);return}}}catch(t){this.debug(`Error parsing message from ${this.ndkRelay.url}: ${t.message}`,t?.stack);return}}async onAuthRequested(e){const t=this.ndkRelay.authPolicy??this.ndk?.relayAuthDefaultPolicy;if(this.debug("Relay requested authentication",{havePolicy:!!t}),this._status===7){this.debug("Already authenticating, ignoring");return}if(this._status=6,t){if(this._status>=5){this._status=7;let r;try{r=await t(this.ndkRelay,e)}catch(s){this.debug("Authentication policy threw an error",s),r=!1}if(this.debug("Authentication policy returned",!!r),r instanceof NDKEvent$1||r===!0){r instanceof NDKEvent$1&&await this.auth(r);const s=async()=>{if(this._status>=5&&this._status<8){const i=new NDKEvent$1(this.ndk);i.kind=22242,i.tags=[["relay",this.ndkRelay.url],["challenge",e]],await i.sign(),this.auth(i).then(()=>{this._status=8,this.ndkRelay.emit("authed"),this.debug("Authentication successful"),this.retryPendingAuthPublishes()}).catch(a=>{this._status=6,this.ndkRelay.emit("auth:failed",a),this.debug("Authentication failed",a),this.rejectPendingAuthPublishes(a)})}else this.debug("Authentication failed, it changed status, status is %d",this._status)};r===!0&&(this.ndk?.signer?s().catch(i=>{console.error("Error authenticating",i)}):(this.debug("No signer available for authentication localhost"),this.ndk?.once("signer:ready",s))),this._status=5,this.ndkRelay.emit("authed")}}}else this.ndkRelay.emit("auth",e)}onError(e){this.debug(`WebSocket error on ${this.ndkRelay.url}:`,e)}get status(){return this._status}isAvailable(){return this._status===5}isFlapping(){const e=this._connectionStats.durations;if(e.length%3!==0)return!1;const r=e.reduce((u,l)=>u+l,0)/e.length,s=e.map(u=>(u-r)**2).reduce((u,l)=>u+l,0)/e.length;return Math.sqrt(s)<FLAPPING_THRESHOLD_MS$1}async onNotice(e){this.ndkRelay.emit("notice",e)}handleReconnection(e=0){if(this.reconnectTimeout)return;if(this.isFlapping()){this.ndkRelay.emit("flapping",this._connectionStats),this._status=3;return}let t;if(this.wasIdle){const r=[0,1e3,2e3,5e3,1e4,3e4];t=r[Math.min(e,r.length-1)],this.debug(`Using aggressive reconnect after idle, attempt ${e}, delay ${t}ms`)}else this.connectedAt?t=Math.max(0,6e4-(Date.now()-this.connectedAt)):(t=Math.min(1e3*2**e,3e4),this.debug(`Using standard backoff, attempt ${e}, delay ${t}ms`));this.reconnectTimeout=setTimeout(()=>{this.reconnectTimeout=void 0,this._status=2,this.connect().catch(r=>{e<MAX_RECONNECT_ATTEMPTS$1?this.handleReconnection(e+1):(this.debug("Max reconnect attempts reached"),this.wasIdle=!1)})},t),this.ndkRelay.emit("delayed-connect",t),this.debug("Reconnecting in",t),this._connectionStats.nextReconnectAt=Date.now()+t}async send(e){Date.now()-this.lastMessageSent>12e4&&(this.wasIdle=!0),this._status>=5&&this.ws?.readyState===WebSocket.OPEN?(this.ws?.send(e),this.netDebug?.(e,this.ndkRelay,"send"),this.lastMessageSent=Date.now()):(this.debug(`Not connected to ${this.ndkRelay.url} (%d), not sending message ${e}`,this._status),this._status>=5&&this.ws?.readyState!==WebSocket.OPEN&&(this.debug(`Stale connection detected, WebSocket state: ${this.ws?.readyState}`),this.handleStaleConnection()))}async auth(e){const t=new Promise((r,s)=>{const i=this.openEventPublishes.get(e.id)??[];i.push({resolve:r,reject:s}),this.openEventPublishes.set(e.id,i)});return this.send(`["AUTH",${JSON.stringify(e.rawEvent())}]`),t}clearPendingPublishes(e){this.rejectPendingAuthPublishes(e);for(const[t,r]of this.openEventPublishes.entries()){for(;r.length>0;){const s=r.shift();s&&s.reject(e)}this.openEventPublishes.delete(t)}}retryPendingAuthPublishes(){if(this.pendingAuthPublishes.size!==0){this.debug(`Retrying ${this.pendingAuthPublishes.size} pending publishes after auth`);for(const[e,t]of this.pendingAuthPublishes.entries())this.debug(`Retrying publish for event ${e}`),this.send(`["EVENT",${JSON.stringify(t)}]`);this.pendingAuthPublishes.clear()}}rejectPendingAuthPublishes(e){if(this.pendingAuthPublishes.size!==0){this.debug(`Rejecting ${this.pendingAuthPublishes.size} pending publishes due to auth failure`);for(const[t]of this.pendingAuthPublishes.entries()){const r=this.openEventPublishes.get(t);if(r&&r.length>0){const s=r.pop();s&&s.reject(new Error(`Authentication failed: ${e.message}`)),r.length===0&&this.openEventPublishes.delete(t)}}this.pendingAuthPublishes.clear()}}async publish(e){const t=new Promise((r,s)=>{const i=this.openEventPublishes.get(e.id)??[];i.length>0&&console.warn(`Duplicate event publishing detected, you are publishing event ${e.id} twice`),i.push({resolve:r,reject:s}),this.openEventPublishes.set(e.id,i)});return this.pendingAuthPublishes.set(e.id,e),this.send(`["EVENT",${JSON.stringify(e)}]`),t}async count(e,t){this.serial++;const r=t?.id||`count:${this.serial}`,s=new Promise((i,a)=>{this.openCountRequests.set(r,{resolve:i,reject:a})});return this.send(`["COUNT","${r}",${JSON.stringify(e).substring(1)}`),s}close(e,t){this.send(`["CLOSE","${e}"]`);const r=this.openSubs.get(e);this.openSubs.delete(e),r&&r.onclose(t)}req(e){`${this.send(`["REQ","${e.subId}",${JSON.stringify(e.executeFilters).substring(1)}`)}`,this.openSubs.set(e.subId,e)}updateConnectionStats={connected:()=>{this._connectionStats.success++,this._connectionStats.connectedAt=Date.now()},disconnected:()=>{this._connectionStats.connectedAt&&(this._connectionStats.durations.push(Date.now()-this._connectionStats.connectedAt),this._connectionStats.durations.length>100&&this._connectionStats.durations.shift()),this._connectionStats.connectedAt=void 0},attempt:()=>{this._connectionStats.attempts++,this._connectionStats.connectedAt=Date.now()}};get connectionStats(){return this._connectionStats}get url(){return this.ndkRelay.url}get connected(){return this._status>=5&&this.ws?.readyState===WebSocket.OPEN}};async function fetchRelayInformation(n){const e=n.replace(/^wss:\/\//,"https://").replace(/^ws:\/\//,"http://"),t=await fetch(e,{headers:{Accept:"application/nostr+json"}});if(!t.ok)throw new Error(`Failed to fetch relay information: ${t.status} ${t.statusText}`);return await t.json()}var NDKRelayPublisher$1=class{ndkRelay;debug;constructor(e){this.ndkRelay=e,this.debug=e.debug.extend("publisher")}async publish(e,t=2500){let r;const s=()=>new Promise((v,m)=>{try{this.publishEvent(e).then(w=>{this.ndkRelay.emit("published",e),e.emit("relay:published",this.ndkRelay),v(!0)}).catch(m)}catch(w){m(w)}}),i=new Promise((v,m)=>{r=setTimeout(()=>{r=void 0,m(new Error(`Timeout: ${t}ms`))},t)}),a=()=>{s().then(v=>u(v)).catch(v=>l(v))};let u,l;const p=v=>{throw this.ndkRelay.debug("Publish failed",v,e.id),this.ndkRelay.emit("publish:failed",e,v),e.emit("relay:publish:failed",this.ndkRelay,v),v},g=()=>{r&&clearTimeout(r),this.ndkRelay.removeListener("connect",a)};return this.ndkRelay.status>=5?Promise.race([s(),i]).catch(p).finally(g):(this.ndkRelay.status<=1?(console.warn("Relay is disconnected, trying to connect to publish an event",this.ndkRelay.url),this.ndkRelay.connect()):console.warn("Relay not connected, waiting for connection to publish an event",this.ndkRelay.url),Promise.race([new Promise((v,m)=>{u=v,l=m,this.ndkRelay.on("connect",a)}),i]).catch(p).finally(g))}async publishEvent(e){return this.ndkRelay.connectivity.publish(e.rawEvent())}};function filterFingerprint$1(n,e){const t=[];for(const s of n){const i=Object.entries(s||{}).map(([a,u])=>["since","until"].includes(a)?`${a}:${u}`:a).sort().join("-");t.push(i)}let r=e?"+":"";return r+=t.join("|"),r}function mergeFilters$1(n){const e=[],t={};return n.filter(r=>!!r.limit).forEach(r=>e.push(r)),n=n.filter(r=>!r.limit),n.length===0?e:(n.forEach(r=>{Object.entries(r).forEach(([s,i])=>{Array.isArray(i)?t[s]===void 0?t[s]=[...i]:t[s]=Array.from(new Set([...t[s],...i])):t[s]=i})}),[...e,t])}var MAX_ITEMS=3;function formatArray(n,e){const r=(e?n.slice(0,MAX_ITEMS).map(e):n.slice(0,MAX_ITEMS)).join(",");return n.length>MAX_ITEMS?`${r}+${n.length-MAX_ITEMS}`:r}function formatFilters(n){return n.map(e=>{const t=[];e.ids?.length&&t.push(`ids:[${formatArray(e.ids,r=>String(r).slice(0,8))}]`),e.kinds?.length&&t.push(`kinds:[${formatArray(e.kinds)}]`),e.authors?.length&&t.push(`authors:[${formatArray(e.authors,r=>String(r).slice(0,8))}]`),e.since&&t.push(`since:${e.since}`),e.until&&t.push(`until:${e.until}`),e.limit&&t.push(`limit:${e.limit}`),e.search&&t.push(`search:"${String(e.search).slice(0,20)}"`);for(const[r,s]of Object.entries(e))r.startsWith("#")&&Array.isArray(s)&&s.length>0&&t.push(`${r}:[${formatArray(s,i=>String(i).slice(0,8))}]`);return`{${t.join(" ")}}`}).join(", ")}var NDKRelaySubscription$1=class{fingerprint;items=new Map;topSubManager;debug;status=0;onClose;relay;eosed=!1;executionTimer;fireTime;delayType;executeFilters;id=Math.random().toString(36).substring(7);constructor(e,t,r){this.relay=e,this.topSubManager=r,this.debug=e.debug.extend(`sub[${this.id}]`),this.fingerprint=t||Math.random().toString(36).substring(7)}_subId;get subId(){return this._subId?this._subId:(this._subId=this.fingerprint.slice(0,15),this._subId)}subIdParts=new Set;addSubIdPart(e){this.subIdParts.add(e)}addItem(e,t){if(this.debug("Adding item",{filters:formatFilters(t),internalId:e.internalId,status:this.status,fingerprint:this.fingerprint,id:this.subId,itemsSize:this.items.size}),!this.items.has(e.internalId))switch(e.on("close",this.removeItem.bind(this,e)),this.items.set(e.internalId,{subscription:e,filters:t}),this.status!==3&&e.subId&&(!this._subId||this._subId.length<25)&&(this.status===0||this.status===1)&&this.addSubIdPart(e.subId),this.status){case 0:this.evaluateExecutionPlan(e);break;case 3:break;case 1:this.evaluateExecutionPlan(e);break;case 4:throw this.debug("Subscription is closed, cannot add new items",{filters:formatFilters(t),subId:e.subId,internalId:e.internalId}),new Error("Cannot add new items to a closed subscription")}}removeItem(e){if(this.items.delete(e.internalId),this.items.size===0){if(!this.eosed)return;this.close(),this.cleanup()}}close(){if(this.status===4)return;const e=this.status;if(this.status=4,e===3)try{this.relay.close(this.subId)}catch(t){this.debug("Error closing subscription",t,this)}else this.debug("Subscription wanted to close but it wasn't running, this is probably ok",{subId:this.subId,prevStatus:e,sub:this});this.cleanup()}cleanup(){this.executionTimer&&clearTimeout(this.executionTimer),this.relay.off("ready",this.executeOnRelayReady),this.relay.off("authed",this.reExecuteAfterAuth),this.onClose&&this.onClose(this)}evaluateExecutionPlan(e){if(!e.isGroupable()){this.status=1,this.execute();return}if(e.filters.find(s=>!!s.limit)&&(this.executeFilters=this.compileFilters(),this.executeFilters.length>=10)){this.status=1,this.execute();return}const t=e.groupableDelay,r=e.groupableDelayType;if(!t)throw new Error("Cannot group a subscription without a delay");if(this.status===0)this.schedule(t,r);else{const s=this.delayType,i=this.fireTime-Date.now();if(s==="at-least"&&r==="at-least")i<t&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(t,r));else if(s==="at-least"&&r==="at-most")i>t&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(t,r));else if(s==="at-most"&&r==="at-most")i>t&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(t,r));else if(s==="at-most"&&r==="at-least")i>t&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(t,r));else throw new Error(`Unknown delay type combination ${s} ${r}`)}}schedule(e,t){this.status=1;const r=Date.now();this.fireTime=r+e,this.delayType=t;const s=setTimeout(this.execute.bind(this),e);t==="at-least"&&(this.executionTimer=s)}executeOnRelayReady=()=>{if(this.status===2){if(this.items.size===0){this.debug("No items to execute; this relay was probably too slow to respond and the caller gave up",{status:this.status,fingerprint:this.fingerprint,id:this.id,subId:this.subId}),this.cleanup();return}this.debug("Executing on relay ready",{status:this.status,fingerprint:this.fingerprint,itemsSize:this.items.size,filters:formatFilters(this.compileFilters())}),this.status=1,this.execute()}};finalizeSubId(){if(this.subIdParts.size>0){let t=Array.from(this.subIdParts).map(r=>r.substring(0,10)).join("-");t.length>20&&(t=t.substring(0,20)),this._subId=t}else this._subId=this.fingerprint.slice(0,15);this._subId+=`-${Math.random().toString(36).substring(2,7)}`}reExecuteAfterAuth=(()=>{const e=this.subId;this.debug("Re-executing after auth",this.items.size),this.eosed?this.relay.close(this.subId):this.debug("We are abandoning an opened subscription, once it EOSE's, the handler will close it",{oldSubId:e}),this._subId=void 0,this.status=1,this.execute(),this.debug("Re-executed after auth %s  %s",e,this.subId)}).bind(this);execute(){if(this.status===1){if(!this.relay.connected){this.status=2,this.debug("Waiting for relay to be ready",{status:this.status,id:this.subId,fingerprint:this.fingerprint,itemsSize:this.items.size}),this.relay.once("ready",this.executeOnRelayReady);return}this.relay.status<8&&this.relay.once("authed",this.reExecuteAfterAuth),this.status=3,this.finalizeSubId(),this.executeFilters=this.compileFilters(),this.relay.req(this)}}onstart(){}onevent(e){this.topSubManager.dispatchEvent(e,this.relay)}oneose(e){if(this.eosed=!0,e!==this.subId){this.debug("Received EOSE for an abandoned subscription",e,this.subId),this.relay.close(e);return}this.items.size===0&&this.close();for(const{subscription:t}of this.items.values())t.eoseReceived(this.relay),t.closeOnEose&&(this.debug("Removing item because of EOSE",{filters:formatFilters(t.filters),internalId:t.internalId,status:this.status,fingerprint:this.fingerprint,itemsSize:this.items.size}),this.removeItem(t))}onclose(e){this.status=4}onclosed(e){if(e)for(const{subscription:t}of this.items.values())t.closedReceived(this.relay,e)}compileFilters(){const e=[],t=Array.from(this.items.values()).map(s=>s.filters);if(!t[0])return this.debug(" No filters to merge",{itemsSize:this.items.size}),[];const r=t[0].length;for(let s=0;s<r;s++){const i=t.map(u=>u[s]),a=mergeFilters$1(i);e.push(...a)}return e}},NDKRelaySubscriptionManager$1=class{relay;subscriptions;generalSubManager;constructor(e,t){this.relay=e,this.subscriptions=new Map,this.generalSubManager=t}addSubscription(e,t){let r;if(!e.isGroupable())r=this.createSubscription(e,t);else{const s=filterFingerprint$1(t,e.closeOnEose);s&&(r=(this.subscriptions.get(s)||[]).find(a=>a.status<3)),r??=this.createSubscription(e,t,s)}r.addItem(e,t)}createSubscription(e,t,r){const s=new NDKRelaySubscription$1(this.relay,r||null,this.generalSubManager);s.onClose=this.onRelaySubscriptionClose.bind(this);const i=this.subscriptions.get(s.fingerprint)??[];return this.subscriptions.set(s.fingerprint,[...i,s]),s}onRelaySubscriptionClose(e){let t=this.subscriptions.get(e.fingerprint)??[];t?t.length===1?this.subscriptions.delete(e.fingerprint):(t=t.filter(r=>r.id!==e.id),this.subscriptions.set(e.fingerprint,t)):console.warn("Unexpectedly did not find a subscription with fingerprint",e.fingerprint)}},NDKRelay$1=class Ir extends lib$1.EventEmitter{url;scores;connectivity;subs;publisher;authPolicy;protocolHandlers=new Map;_relayInfo;lowestValidationRatio;targetValidationRatio;validationRatioFn;validatedEventCount=0;nonValidatedEventCount=0;trusted=!1;complaining=!1;debug;static defaultValidationRatioUpdateFn=(e,t,r)=>{if(e.lowestValidationRatio===void 0||e.targetValidationRatio===void 0)return 1;let s=e.validationRatio;if(e.validationRatio>e.targetValidationRatio){const i=t/100;s=Math.max(e.lowestValidationRatio,e.validationRatio-i)}return s<e.validationRatio?s:e.validationRatio};constructor(e,t,r){super(),this.url=normalizeRelayUrl$1(e),this.scores=new Map,this.debug=createDebug2(`ndk:relay:${e}`),this.connectivity=new NDKRelayConnectivity$1(this,r),this.connectivity.netDebug=r?.netDebug,this.req=this.connectivity.req.bind(this.connectivity),this.close=this.connectivity.close.bind(this.connectivity),this.subs=new NDKRelaySubscriptionManager$1(this,r.subManager),this.publisher=new NDKRelayPublisher$1(this),this.authPolicy=t,this.targetValidationRatio=r?.initialValidationRatio,this.lowestValidationRatio=r?.lowestValidationRatio,this.validationRatioFn=(r?.validationRatioFn??Ir.defaultValidationRatioUpdateFn).bind(this),this.updateValidationRatio(),r||console.trace("relay created without ndk")}updateValidationRatio(){if(this.validationRatioFn&&this.validatedEventCount>0){const e=this.validationRatioFn(this,this.validatedEventCount,this.nonValidatedEventCount);this.targetValidationRatio=e}setTimeout(()=>{this.updateValidationRatio()},3e4)}get status(){return this.connectivity.status}get connectionStats(){return this.connectivity.connectionStats}async connect(e,t=!0){return this.connectivity.connect(e,t)}disconnect(){this.status!==1&&this.connectivity.disconnect()}subscribe(e,t){this.subs.addSubscription(e,t)}async publish(e,t=2500){return this.publisher.publish(e,t)}referenceTags(){return[["r",this.url]]}addValidatedEvent(){this.validatedEventCount++}addNonValidatedEvent(){this.nonValidatedEventCount++}get validationRatio(){return this.nonValidatedEventCount===0?1:this.validatedEventCount/(this.validatedEventCount+this.nonValidatedEventCount)}shouldValidateEvent(){return this.trusted?!1:this.targetValidationRatio===void 0||this.targetValidationRatio>=1?!0:Math.random()<this.targetValidationRatio}get connected(){return this.connectivity.connected}req;close;registerProtocolHandler(e,t){this.protocolHandlers.set(e,t)}unregisterProtocolHandler(e){this.protocolHandlers.delete(e)}getProtocolHandler(e){return this.protocolHandlers.get(e)}async fetchInfo(e=!1){const r=this.connectivity.ndk;if(!e&&r?.cacheAdapter?.getRelayStatus){const s=await r.cacheAdapter.getRelayStatus(this.url);if(s?.nip11&&Date.now()-s.nip11.fetchedAt<864e5)return this._relayInfo=s.nip11.data,s.nip11.data}return!e&&this._relayInfo?this._relayInfo:(this._relayInfo=await fetchRelayInformation(this.url),r?.cacheAdapter?.updateRelayStatus&&await r.cacheAdapter.updateRelayStatus(this.url,{nip11:{data:this._relayInfo,fetchedAt:Date.now()}}),this._relayInfo)}get info(){return this._relayInfo}},NDKPublishError$1=class extends Error{errors;publishedToRelays;intendedRelaySet;constructor(e,t,r,s){super(e),this.errors=t,this.publishedToRelays=r,this.intendedRelaySet=s}get relayErrors(){const e=[];for(const[t,r]of this.errors)e.push(`${t.url}: ${r}`);return e.join(`
`)}},NDKRelaySet$1=class Kr{relays;debug;ndk;pool;constructor(e,t,r){this.relays=e,this.ndk=t,this.pool=r??t.pool,this.debug=t.debug.extend("relayset")}addRelay(e){this.relays.add(e)}get relayUrls(){return Array.from(this.relays).map(e=>e.url)}static fromRelayUrls(e,t,r=!0,s){if(s=s??t.pool,!s)throw new Error("No pool provided");const i=new Set;for(const a of e){const u=s.relays.get(normalizeRelayUrl$1(a));if(u)u.status<5&&r&&u.connect(),i.add(u);else{const l=new NDKRelay$1(normalizeRelayUrl$1(a),t?.relayAuthDefaultPolicy,t);s.useTemporaryRelay(l,void 0,`requested from fromRelayUrls ${e}`),i.add(l)}}return new Kr(new Set(i),t,s)}async publish(e,t,r=1){const s=new Set,i=new Map,a=e.isEphemeral();e.publishStatus="pending";const u=l=>{s.add(l)};e.on("relay:published",u);try{const l=Array.from(this.relays).map(p=>new Promise(g=>{const v=t?setTimeout(()=>{s.has(p)||(i.set(p,new Error(`Publish timeout after ${t}ms`)),g(!1))},t):null;p.publish(e,t).then(m=>{v&&clearTimeout(v),m?(s.add(p),g(!0)):g(!1)}).catch(m=>{v&&clearTimeout(v),a||i.set(p,m),g(!1)})}));if(await Promise.all(l),s.size<r){if(!a){const p=new NDKPublishError$1("Not enough relays received the event ("+s.size+" published, "+r+" required)",i,s,this);throw e.publishStatus="error",e.publishError=p,this.ndk?.emit("event:publish-failed",e,p,this.relayUrls),p}}else e.publishStatus="success",e.emit("published",{relaySet:this,publishedToRelays:s});return s}finally{e.off("relay:published",u)}}get size(){return this.relays.size}},d$2=createDebug2("ndk:outbox:calculate");async function calculateRelaySetFromEvent$1(n,e,t){const r=new Set,s=await getWriteRelaysFor$1(n,e.pubkey);s&&s.forEach(u=>{const l=n.pool?.getRelay(u);l&&r.add(l)});let i=e.tags.filter(u=>["a","e"].includes(u[0])).map(u=>u[2]).filter(u=>u?.startsWith("wss://")).filter(u=>{try{return new URL(u),!0}catch{return!1}}).map(u=>normalizeRelayUrl$1(u));i=Array.from(new Set(i)).slice(0,5),i.forEach(u=>{const l=n.pool?.getRelay(u,!0,!0);l&&(d$2("Adding relay hint %s",u),r.add(l))});const a=e.getMatchingTags("p").map(u=>u[1]);return a.length<5?Array.from(chooseRelayCombinationForPubkeys$1(n,a,"read",{preferredRelays:new Set(s)}).keys()).forEach(l=>{const p=n.pool?.getRelay(l,!1,!0);p&&(d$2("Adding p-tagged relay %s",l),r.add(p))}):d$2("Too many p-tags to consider %d",a.length),n.pool?.permanentAndConnectedRelays().forEach(u=>r.add(u)),t&&r.size<t&&n.explicitRelayUrls?.filter(l=>!Array.from(r).some(p=>p.url===l)).slice(0,t-r.size)?.forEach(l=>{const p=n.pool?.getRelay(l,!1,!0);p&&(d$2("Adding explicit relay %s",l),r.add(p))}),new NDKRelaySet$1(r,n)}function calculateRelaySetsFromFilter(n,e,t,r){const s=new Map,i=new Set;if(e.forEach(a=>{a.authors&&a.authors.forEach(u=>i.add(u))}),i.size>0){const a=getRelaysForFilterWithAuthors(n,Array.from(i),r);for(const u of a.keys())s.set(u,[]);for(const u of e)if(u.authors)for(const[l,p]of a.entries()){const g=u.authors.filter(v=>p.includes(v));s.set(l,[...s.get(l),{...u,authors:g}])}else for(const l of a.keys())s.set(l,[...s.get(l),u])}else n.explicitRelayUrls&&n.explicitRelayUrls.forEach(a=>{s.set(a,e)});return s.size===0&&t.permanentAndConnectedRelays().slice(0,5).forEach(a=>{s.set(a.url,e)}),s}function calculateRelaySetsFromFilters(n,e,t,r){return calculateRelaySetsFromFilter(n,e,t,r)}function isValidHex64(n){if(typeof n!="string"||n.length!==64)return!1;for(let e=0;e<64;e++){const t=n.charCodeAt(e);if(!(t>=48&&t<=57||t>=97&&t<=102||t>=65&&t<=70))return!1}return!0}function isValidPubkey(n){return isValidHex64(n)}function isValidNip05(n){if(typeof n!="string")return!1;for(let e=0;e<n.length;e++)if(n.charCodeAt(e)===46)return!0;return!1}function mergeTags$1(n,e){const t=new Map,r=a=>a.join(","),s=(a,u)=>a.every((l,p)=>l===u[p]),i=a=>{for(const[u,l]of t)if(s(l,a)||s(a,l)){a.length>=l.length&&t.set(u,a);return}t.set(r(a),a)};return n.concat(e).forEach(i),Array.from(t.values())}var hashtagRegex$1=/(?<=\s|^)(#[^\s!@#$%^&*()=+./,[{\]};:'"?><]+)/g;function generateHashtags$1(n){const e=n.match(hashtagRegex$1),t=new Set,r=new Set;if(e)for(const s of e)t.has(s.slice(1))||(r.add(s.slice(1)),t.add(s.slice(1)));return Array.from(r)}async function generateContentTags$1(n,e=[],t,r){if(t?.skipContentTagging)return{content:n,tags:e};const s=/(@|nostr:)(npub|nprofile|note|nevent|naddr)[a-zA-Z0-9]+/g,i=[],a=u=>{e.find(l=>["q",u[0]].includes(l[0])&&l[1]===u[1])||e.push(u)};if(n=n.replace(s,u=>{try{const l=u.split(/(@|nostr:)/)[2],{type:p,data:g}=nip19_exports$2.decode(l);let v;if(t?.filters){const m=!t.filters.includeTypes||t.filters.includeTypes.includes(p),w=t.filters.excludeTypes?.includes(p);if(!m||w)return u}switch(p){case"npub":t?.pTags!==!1&&(v=["p",g]);break;case"nprofile":t?.pTags!==!1&&(v=["p",g.pubkey]);break;case"note":i.push(new Promise(async m=>{const w=await maybeGetEventRelayUrl$1(l);a(["q",g,w]),m()}));break;case"nevent":i.push(new Promise(async m=>{const{id:w,author:T}=g;let{relays:P}=g;(!P||P.length===0)&&(P=[await maybeGetEventRelayUrl$1(l)]),a(["q",w,P[0]]),T&&t?.pTags!==!1&&t?.pTagOnQTags!==!1&&a(["p",T]),m()}));break;case"naddr":i.push(new Promise(async m=>{const w=[g.kind,g.pubkey,g.identifier].join(":");let T=g.relays??[];T.length===0&&(T=[await maybeGetEventRelayUrl$1(l)]),a(["q",w,T[0]]),t?.pTags!==!1&&t?.pTagOnQTags!==!1&&t?.pTagOnATags!==!1&&a(["p",g.pubkey]),m()}));break;default:return u}return v&&a(v),`nostr:${l}`}catch{return u}}),await Promise.all(i),!t?.filters?.excludeTypes?.includes("hashtag")){const u=generateHashtags$1(n).map(l=>["t",l]);e=mergeTags$1(e,u)}if(t?.pTags!==!1&&t?.copyPTagsFromTarget&&r){const u=r.getMatchingTags("p");for(const l of u)!l[1]||!isValidPubkey(l[1])||e.find(p=>p[0]==="p"&&p[1]===l[1])||e.push(l)}return{content:n,tags:e}}async function maybeGetEventRelayUrl$1(n){return""}async function encrypt$1(n,e,t="nip44"){let r;if(!this.ndk)throw new Error("No NDK instance found!");let s=e;if(s||(this.ndk.assertSigner(),s=this.ndk.signer),!s)throw new Error("no NDK signer");const i=n||(()=>{const a=this.getMatchingTags("p");if(a.length!==1)throw new Error("No recipient could be determined and no explicit recipient was provided");return this.ndk.getUser({pubkey:a[0][1]})})();if(t==="nip44"&&await isEncryptionEnabled$1(s,"nip44")&&(r=await s.encrypt(i,this.content,"nip44")),(!r||t==="nip04")&&await isEncryptionEnabled$1(s,"nip04")&&(r=await s.encrypt(i,this.content,"nip04")),!r)throw new Error("Failed to encrypt event.");this.content=r}async function decrypt$1(n,e,t){if(this.ndk?.cacheAdapter?.getDecryptedEvent){const u=await this.ndk.cacheAdapter.getDecryptedEvent(this.id);if(u){this.content=u.content;return}}let r;if(!this.ndk)throw new Error("No NDK instance found!");let s=e;if(s||(this.ndk.assertSigner(),s=this.ndk.signer),!s)throw new Error("no NDK signer");const i=n||this.author;if(!i)throw new Error("No sender provided and no author available");const a=t||(this.content.match(/\\?iv=/)?"nip04":"nip44");if((a==="nip04"||this.kind===4)&&await isEncryptionEnabled$1(s,"nip04")&&this.content.search("\\?iv=")&&(r=await s.decrypt(i,this.content,"nip04")),!r&&a==="nip44"&&await isEncryptionEnabled$1(s,"nip44")&&(r=await s.decrypt(i,this.content,"nip44")),!r)throw new Error("Failed to decrypt event.");this.content=r,this.ndk?.cacheAdapter?.addDecryptedEvent&&this.ndk.cacheAdapter.addDecryptedEvent(this.id,this)}async function isEncryptionEnabled$1(n,e){return n.encryptionEnabled?e?!!await n.encryptionEnabled(e):!0:!1}function eventHasETagMarkers$1(n){for(const e of n.tags)if(e[0]==="e"&&(e[3]??"").length>0)return!0;return!1}function getRootTag$1(n,e){e??=n.tagType();const t=n.tags.find(isTagRootTag$1);if(!t){if(eventHasETagMarkers$1(n))return;const r=n.getMatchingTags(e);if(r.length<3)return r[0]}return t}var nip22RootTags$1=new Set(["A","E","I"]),nip22ReplyTags$1=new Set(["a","e","i"]);function getReplyTag$1(n,e){if(n.kind===1111){let s;for(const i of n.tags)if(nip22RootTags$1.has(i[0]))s=i;else if(nip22ReplyTags$1.has(i[0])){s=i;break}return s}e??=n.tagType();let t=!1,r;for(const s of n.tags)if(s[0]===e){if((s[3]??"").length>0&&(t=!0),t&&s[3]==="reply")return s;t&&s[3]==="root"&&(r=s),t||(r=s)}return r}function isTagRootTag$1(n){return n[0]==="E"||n[3]==="root"}async function fetchTaggedEvent$1(n,e){if(!this.ndk)throw new Error("NDK instance not found");const t=this.getMatchingTags(n,e);if(t.length===0)return;const[r,s,i]=t[0],a=i!==""?this.ndk.pool.getRelay(i):void 0;return await this.ndk.fetchEvent(s,{},a)}async function fetchRootEvent$1(n){if(!this.ndk)throw new Error("NDK instance not found");const e=getRootTag$1(this);if(e)return this.ndk.fetchEventFromTag(e,this,n)}async function fetchReplyEvent$1(n){if(!this.ndk)throw new Error("NDK instance not found");const e=getReplyTag$1(this);if(e)return this.ndk.fetchEventFromTag(e,this,n)}function isReplaceable$1(){if(this.kind===void 0)throw new Error("Kind not set");return[0,3].includes(this.kind)||this.kind>=1e4&&this.kind<2e4||this.kind>=3e4&&this.kind<4e4}function isEphemeral$1(){if(this.kind===void 0)throw new Error("Kind not set");return this.kind>=2e4&&this.kind<3e4}function isParamReplaceable$1(){if(this.kind===void 0)throw new Error("Kind not set");return this.kind>=3e4&&this.kind<4e4}var DEFAULT_RELAY_COUNT$1=2;function encode$1(n=DEFAULT_RELAY_COUNT$1){let e=[];return this.onRelays.length>0?e=this.onRelays.map(t=>t.url):this.relay&&(e=[this.relay.url]),e.length>n&&(e=e.slice(0,n)),this.isParamReplaceable()?nip19_exports$2.naddrEncode({kind:this.kind,pubkey:this.pubkey,identifier:this.replaceableDTag(),relays:e}):e.length>0?nip19_exports$2.neventEncode({id:this.tagId(),relays:e,author:this.pubkey}):nip19_exports$2.noteEncode(this.tagId())}async function repost$1(n=!0,e){if(!e&&n){if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner(),e=this.ndk.signer}const t=new NDKEvent$1(this.ndk,{kind:getKind$1(this)});return this.isProtected||(t.content=JSON.stringify(this.rawEvent())),t.tag(this),this.kind!==1&&t.tags.push(["k",`${this.kind}`]),e&&await t.sign(e),n&&await t.publish(),t}function getKind$1(n){return n.kind===1?6:16}function getEventDetails(n){return"inspect"in n&&typeof n.inspect=="string"?n.inspect:JSON.stringify(n)}function validateForSerialization(n){if(typeof n.kind!="number")throw new Error(`Can't serialize event with invalid properties: kind (must be number, got ${typeof n.kind}). Event: ${getEventDetails(n)}`);if(typeof n.content!="string")throw new Error(`Can't serialize event with invalid properties: content (must be string, got ${typeof n.content}). Event: ${getEventDetails(n)}`);if(typeof n.created_at!="number")throw new Error(`Can't serialize event with invalid properties: created_at (must be number, got ${typeof n.created_at}). Event: ${getEventDetails(n)}`);if(typeof n.pubkey!="string")throw new Error(`Can't serialize event with invalid properties: pubkey (must be string, got ${typeof n.pubkey}). Event: ${getEventDetails(n)}`);if(!Array.isArray(n.tags))throw new Error(`Can't serialize event with invalid properties: tags (must be array, got ${typeof n.tags}). Event: ${getEventDetails(n)}`);for(let e=0;e<n.tags.length;e++){const t=n.tags[e];if(!Array.isArray(t))throw new Error(`Can't serialize event with invalid properties: tags[${e}] (must be array, got ${typeof t}). Event: ${getEventDetails(n)}`);for(let r=0;r<t.length;r++)if(typeof t[r]!="string")throw new Error(`Can't serialize event with invalid properties: tags[${e}][${r}] (must be string, got ${typeof t[r]}). Event: ${getEventDetails(n)}`)}}function serialize$1(n=!1,e=!1){validateForSerialization(this);const t=[0,this.pubkey,this.created_at,this.kind,this.tags,this.content];return n&&t.push(this.sig),e&&t.push(this.id),JSON.stringify(t)}function deserialize$1(n){const e=JSON.parse(n),t={pubkey:e[1],created_at:e[2],kind:e[3],tags:e[4],content:e[5]};if(e.length>=7){const r=e[6],s=e[7];r&&r.length===128?(t.sig=r,s&&s.length===64&&(t.id=s)):r&&r.length===64&&(t.id=r,s&&s.length===128&&(t.sig=s))}return t}var worker,processingQueue$1={};function signatureVerificationInit(n){worker=n,worker.onmessage=e=>{if(!Array.isArray(e.data)||e.data.length!==2){console.error("[NDK]  Signature verification worker received incompatible message format.",`

 Expected format: [eventId, boolean]`,`
 Received:`,e.data,`

 This likely means:`,`
  1. You have a STALE worker.js file that needs updating`,`
  2. Version mismatch between @nostr-dev-kit/ndk and deployed worker`,`
  3. Wrong worker is being used for signature verification`,`

 Solution: Update your worker files:`,`
  cp node_modules/@nostr-dev-kit/ndk/dist/workers/sig-verification.js public/`,`
  cp node_modules/@nostr-dev-kit/cache-sqlite-wasm/dist/worker.js public/`,`

 Or use Vite/bundler imports instead of static files:`,`
  import SigWorker from "@nostr-dev-kit/ndk/workers/sig-verification?worker"`);return}const[t,r]=e.data,s=processingQueue$1[t];if(!s){console.error("No record found for event",t);return}delete processingQueue$1[t];for(const i of s.resolves)i(r)}}async function verifySignatureAsync$1(n,e,t){const r=n.ndk,s=Date.now();let i;return r.signatureVerificationFunction?i=await r.signatureVerificationFunction(n):i=await new Promise(a=>{const u=n.serialize();let l=!1;processingQueue$1[n.id]||(processingQueue$1[n.id]={event:n,resolves:[],relay:t},l=!0),processingQueue$1[n.id].resolves.push(a),l&&worker?.postMessage({serialized:u,id:n.id,sig:n.sig,pubkey:n.pubkey})}),r.signatureVerificationTimeMs+=Date.now()-s,i}var PUBKEY_REGEX$1=/^[a-f0-9]{64}$/;function validate$1(){if(typeof this.kind!="number"||typeof this.content!="string"||typeof this.created_at!="number"||typeof this.pubkey!="string"||!this.pubkey.match(PUBKEY_REGEX$1)||!Array.isArray(this.tags))return!1;for(let n=0;n<this.tags.length;n++){const e=this.tags[n];if(!Array.isArray(e))return!1;for(let t=0;t<e.length;t++)if(typeof e[t]=="object")return!1}return!0}var verifiedSignatures$1=new dist.LRUCache({maxSize:1e3,entryExpirationTimeInMS:6e4});function verifySignature$1(n){if(typeof this.signatureVerified=="boolean")return this.signatureVerified;const e=verifiedSignatures$1.get(this.id);if(e!==null)return this.signatureVerified=!!e,this.signatureVerified;try{if(this.ndk?.asyncSigVerification){const t=this.relay;verifySignatureAsync$1(this,n,t).then(r=>{n&&(this.signatureVerified=r,r&&verifiedSignatures$1.set(this.id,this.sig)),r?t&&t.addValidatedEvent():(t?this.ndk?.reportInvalidSignature(this,t):this.ndk?.reportInvalidSignature(this),verifiedSignatures$1.set(this.id,!1))}).catch(r=>{console.error("signature verification error",this.id,r)})}else{const t=sha256$2(new TextEncoder().encode(this.serialize())),r=schnorr$1.verify(this.sig,t,this.pubkey);return r?verifiedSignatures$1.set(this.id,this.sig):verifiedSignatures$1.set(this.id,!1),this.signatureVerified=r,r}}catch{return this.signatureVerified=!1,!1}}function getEventHash$1(){return getEventHashFromSerializedEvent$1(this.serialize())}function getEventHashFromSerializedEvent$1(n){const e=sha256$2(new TextEncoder().encode(n));return bytesToHex$1(e)}var skipClientTagOnKinds$1=new Set([0,4,1059,13,3,9734,5]),NDKEvent$1=class gt extends lib$1.EventEmitter{ndk;created_at;content="";tags=[];kind;id="";sig;pubkey="";signatureVerified;_author=void 0;relay;get onRelays(){let e=[];return this.ndk?e=this.ndk.subManager.seenEvents.get(this.id)||[]:this.relay&&e.push(this.relay),e}publishStatus="success";publishError;constructor(e,t){super(),this.ndk=e,this.created_at=t?.created_at,this.content=t?.content||"",this.tags=t?.tags||[],this.id=t?.id||"",this.sig=t?.sig,this.pubkey=t?.pubkey||"",this.kind=t?.kind,t instanceof gt&&(this.relay&&(this.relay=t.relay,this.ndk?.subManager.seenEvent(t.id,this.relay)),this.publishStatus=t.publishStatus,this.publishError=t.publishError)}static deserialize(e,t){return new gt(e,deserialize$1(t))}rawEvent(){return{created_at:this.created_at,content:this.content,tags:this.tags,kind:this.kind,pubkey:this.pubkey,id:this.id,sig:this.sig}}set author(e){this.pubkey=e.pubkey,this._author=e,this._author.ndk??=this.ndk}get author(){if(this._author)return this._author;if(!this.ndk)throw new Error("No NDK instance found");const e=this.ndk.getUser({pubkey:this.pubkey});return this._author=e,e}tagExternal(e,t,r){const s=["i"],i=["k"];switch(t){case"url":{const a=new URL(e);a.hash="",s.push(a.toString()),i.push(`${a.protocol}//${a.host}`);break}case"hashtag":s.push(`#${e.toLowerCase()}`),i.push("#");break;case"geohash":s.push(`geo:${e.toLowerCase()}`),i.push("geo");break;case"isbn":s.push(`isbn:${e.replace(/-/g,"")}`),i.push("isbn");break;case"podcast:guid":s.push(`podcast:guid:${e}`),i.push("podcast:guid");break;case"podcast:item:guid":s.push(`podcast:item:guid:${e}`),i.push("podcast:item:guid");break;case"podcast:publisher:guid":s.push(`podcast:publisher:guid:${e}`),i.push("podcast:publisher:guid");break;case"isan":s.push(`isan:${e.split("-").slice(0,4).join("-")}`),i.push("isan");break;case"doi":s.push(`doi:${e.toLowerCase()}`),i.push("doi");break;default:throw new Error(`Unsupported NIP-73 entity type: ${t}`)}r&&s.push(r),this.tags.push(s),this.tags.push(i)}tag(e,t,r,s,i){let a=[];if(e.fetchProfile!==void 0){if(s??="p",s==="p"&&i?.pTags===!1)return;const l=[s,e.pubkey];t&&l.push("",t),a.push(l)}else if(e instanceof gt){const l=e;if(r??=l?.pubkey===this.pubkey,a=l.referenceTags(t,r,s,i),i?.pTags!==!1)for(const p of l.getMatchingTags("p"))!p[1]||!isValidPubkey(p[1])||p[1]!==this.pubkey&&(this.tags.find(g=>g[0]==="p"&&g[1]===p[1])||this.tags.push(["p",p[1]]))}else if(Array.isArray(e))a=[e];else throw new Error("Invalid argument",e);this.tags=mergeTags$1(this.tags,a)}async toNostrEvent(e,t){if(!e&&this.pubkey===""){const i=await this.ndk?.signer?.user();this.pubkey=i?.pubkey||""}this.created_at||(this.created_at=Math.floor(Date.now()/1e3));const{content:r,tags:s}=await this.generateTags(t);this.content=r||"",this.tags=s;try{this.id=this.getEventHash()}catch{}return this.rawEvent()}serialize=serialize$1.bind(this);getEventHash=getEventHash$1.bind(this);validate=validate$1.bind(this);verifySignature=verifySignature$1.bind(this);isReplaceable=isReplaceable$1.bind(this);isEphemeral=isEphemeral$1.bind(this);isDvm=()=>this.kind&&this.kind>=5e3&&this.kind<=7e3;isParamReplaceable=isParamReplaceable$1.bind(this);encode=encode$1.bind(this);encrypt=encrypt$1.bind(this);decrypt=decrypt$1.bind(this);getMatchingTags(e,t){const r=this.tags.filter(s=>s[0]===e);return t===void 0?r:r.filter(s=>s[3]===t)}hasTag(e,t){return this.tags.some(r=>r[0]===e&&(!t||r[3]===t))}tagValue(e,t){const r=this.getMatchingTags(e,t);if(r.length!==0)return r[0][1]}get alt(){return this.tagValue("alt")}set alt(e){this.removeTag("alt"),e&&this.tags.push(["alt",e])}get dTag(){return this.tagValue("d")}set dTag(e){this.removeTag("d"),e&&this.tags.push(["d",e])}removeTag(e,t){const r=Array.isArray(e)?e:[e];this.tags=this.tags.filter(s=>{const i=r.includes(s[0]),a=t?s[3]===t:!0;return!(i&&a)})}replaceTag(e){this.removeTag(e[0]),this.tags.push(e)}async sign(e,t){this.ndk?.aiGuardrails?.event?.signing(this),e?this.author=await e.user():(this.ndk?.assertSigner(),e=this.ndk?.signer);const r=await this.toNostrEvent(void 0,t);return this.sig=await e.sign(r),this.sig}async publishReplaceable(e,t,r){return this.id="",this.created_at=Math.floor(Date.now()/1e3),this.sig="",this.publish(e,t,r)}async publish(e,t,r,s){if(r||(r=1),this.sig||await this.sign(void 0,s),!this.ndk)throw new Error("NDKEvent must be associated with an NDK instance to publish");if(this.ndk.aiGuardrails?.event?.publishing(this),(!e||e.size===0)&&(e=this.ndk.devWriteRelaySet||await calculateRelaySetFromEvent$1(this.ndk,this,r)),this.kind===5&&this.ndk.cacheAdapter?.deleteEventIds){const u=this.getMatchingTags("e").map(l=>l[1]);this.ndk.cacheAdapter.deleteEventIds(u)}const i=this.rawEvent();if(this.ndk.cacheAdapter?.addUnpublishedEvent&&shouldTrackUnpublishedEvent$1(this))try{this.ndk.cacheAdapter.addUnpublishedEvent(this,e.relayUrls)}catch(u){console.error("Error adding unpublished event to cache",u)}this.kind===5&&this.ndk.cacheAdapter?.deleteEventIds&&this.ndk.cacheAdapter.deleteEventIds(this.getMatchingTags("e").map(u=>u[1])),this.ndk.subManager.dispatchEvent(i,void 0,!0);const a=await e.publish(this,t,r);return a.forEach(u=>this.ndk?.subManager.seenEvent(this.id,u)),a}async generateTags(e){let t=[];const r=await generateContentTags$1(this.content,this.tags,e,this),s=r.content;if(t=r.tags,this.kind&&this.isParamReplaceable()&&!this.getMatchingTags("d")[0]){const a=this.tagValue("title");let l=[...Array(a?6:16)].map(()=>Math.random().toString(36)[2]).join("");a&&a.length>0&&(l=`${a.replace(/[^a-z0-9]+/gi,"-").replace(/^-|-$/g,"")}-${l}`),t.push(["d",l])}if(this.shouldAddClientTag){const i=["client",this.ndk?.clientName??""];this.ndk?.clientNip89&&i.push(this.ndk?.clientNip89),t.push(i)}else this.shouldStripClientTag&&(t=t.filter(i=>i[0]!=="client"));return{content:s||"",tags:t}}get shouldAddClientTag(){return!(!this.ndk?.clientName&&!this.ndk?.clientNip89||skipClientTagOnKinds$1.has(this.kind)||this.isEphemeral()||this.isReplaceable()&&!this.isParamReplaceable()||this.isDvm()||this.hasTag("client"))}get shouldStripClientTag(){return skipClientTagOnKinds$1.has(this.kind)}muted(){return this.ndk?.muteFilter&&this.ndk.muteFilter(this)?"muted":null}replaceableDTag(){if(this.kind&&this.kind>=3e4&&this.kind<=4e4){const e=this.getMatchingTags("d")[0];return e?e[1]:""}throw new Error("Event is not a parameterized replaceable event")}deduplicationKey(){return this.kind===0||this.kind===3||this.kind&&this.kind>=1e4&&this.kind<2e4?`${this.kind}:${this.pubkey}`:this.tagId()}tagId(){return this.isParamReplaceable()?this.tagAddress():this.id}tagAddress(){if(this.isParamReplaceable()){const e=this.dTag??"";return`${this.kind}:${this.pubkey}:${e}`}if(this.isReplaceable())return`${this.kind}:${this.pubkey}:`;throw new Error("Event is not a replaceable event")}tagType(){return this.isParamReplaceable()?"a":"e"}tagReference(e){let t;return this.isParamReplaceable()?t=["a",this.tagAddress()]:t=["e",this.tagId()],this.relay?t.push(this.relay.url):t.push(""),t.push(e??""),this.isParamReplaceable()||t.push(this.pubkey),t}referenceTags(e,t,r,s){let i=[];return this.isParamReplaceable()?i=[[r??"a",this.tagAddress()],[r??"e",this.id]]:i=[[r??"e",this.id]],i=i.map(a=>(a[0]==="e"||e?a.push(this.relay?.url??""):this.relay?.url&&a.push(this.relay?.url),a)),i.forEach(a=>{a[0]==="e"?(a.push(e??""),a.push(this.pubkey)):e&&a.push(e)}),i=[...i,...this.getMatchingTags("h")],!t&&s?.pTags!==!1&&i.push(...this.author.referenceTags()),i}filter(){return this.isParamReplaceable()?{"#a":[this.tagId()]}:{"#e":[this.tagId()]}}nip22Filter(){return this.isParamReplaceable()?{"#A":[this.tagId()]}:{"#E":[this.tagId()]}}async delete(e,t=!0){if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner();const r=new gt(this.ndk,{kind:5,content:e||""});return r.tag(this,void 0,!0),r.tags.push(["k",this.kind?.toString()]),t&&(this.emit("deleted"),await r.publish()),r}set isProtected(e){this.removeTag("-"),e&&this.tags.push(["-"])}get isProtected(){return this.hasTag("-")}fetchTaggedEvent=fetchTaggedEvent$1.bind(this);fetchRootEvent=fetchRootEvent$1.bind(this);fetchReplyEvent=fetchReplyEvent$1.bind(this);repost=repost$1.bind(this);async react(e,t=!0){if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner();const r=new gt(this.ndk,{kind:7,content:e});return r.tag(this),this.kind!==1&&r.tags.push(["k",`${this.kind}`]),t&&await r.publish(),r}get isValid(){return this.validate()}get inspect(){return JSON.stringify(this.rawEvent(),null,4)}dump(){console.debug(JSON.stringify(this.rawEvent(),null,4)),console.debug("Event on relays:",this.onRelays.map(e=>e.url).join(", "))}reply(e,t){const r=new gt(this.ndk);if(this.ndk?.aiGuardrails?.event?.creatingReply(r),this.kind===1&&!e)r.kind=1,this.hasTag("e")?r.tags=[...r.tags,...this.getMatchingTags("e"),...this.getMatchingTags("p"),...this.getMatchingTags("a"),...this.referenceTags("reply",!1,void 0,t)]:r.tag(this,"root",!1,void 0,t);else{r.kind=1111;const s=["A","E","I","P"],i=this.tags.filter(a=>s.includes(a[0]));if(i.length>0){const a=this.tagValue("K");r.tags.push(...i),a&&r.tags.push(["K",a]);let u;if(this.isParamReplaceable()){u=["a",this.tagAddress()];const l=this.relay?.url??"";l&&u.push(l)}else{u=["e",this.tagId()];const l=this.relay?.url??"";u.push(l),u.push(this.pubkey)}r.tags.push(u)}else{let a,u;const l=this.relay?.url??"";this.isParamReplaceable()?(a=["a",this.tagAddress(),l],u=["A",this.tagAddress(),l]):(a=["e",this.tagId(),l,this.pubkey],u=["E",this.tagId(),l,this.pubkey]),r.tags.push(a),r.tags.push(u),r.tags.push(["K",this.kind?.toString()]),t?.pTags!==!1&&t?.pTagOnATags!==!1&&r.tags.push(["P",this.pubkey])}r.tags.push(["k",this.kind?.toString()]),t?.pTags!==!1&&(r.tags.push(...this.getMatchingTags("p")),r.tags.push(["p",this.pubkey]))}return r}},untrackedUnpublishedEvents$1=new Set([24133,13194,23194,23195]);function shouldTrackUnpublishedEvent$1(n){return!untrackedUnpublishedEvents$1.has(n.kind)}var NDKPool$1=class extends lib$1.EventEmitter{_relays=new Map;status="idle";autoConnectRelays=new Set;debug;temporaryRelayTimers=new Map;flappingRelays=new Set;backoffTimes=new Map;ndk;disconnectionTimes=new Map;systemEventDetector;constructor(e,t,{debug:r,name:s}={}){super(),this.debug=r??t.debug.extend("pool"),s&&(this._name=s),this.ndk=t,this.relayUrls=e,this.ndk.pools&&this.ndk.pools.push(this)}get relays(){return this._relays}set relayUrls(e){this._relays.clear();for(const t of e){const r=new NDKRelay$1(t,void 0,this.ndk);r.connectivity.netDebug=this.ndk.netDebug,this.addRelay(r)}}_name="unnamed";get name(){return this._name}set name(e){this._name=e,this.debug=this.debug.extend(e)}useTemporaryRelay(e,t=3e4,r){const s=this.relays.has(e.url);s||(this.addRelay(e),this.debug("Adding temporary relay %s for filters %o",e.url,r));const i=this.temporaryRelayTimers.get(e.url);if(i&&clearTimeout(i),!s||i){const a=setTimeout(()=>{this.ndk.explicitRelayUrls?.includes(e.url)||this.removeRelay(e.url)},t);this.temporaryRelayTimers.set(e.url,a)}}addRelay(e,t=!0){const r=this.relays.has(e.url),s=e.url.includes("/npub1");let i=!0;const a=e.url;if(r)return;if(this.ndk.relayConnectionFilter&&!this.ndk.relayConnectionFilter(a)){this.debug(`Refusing to add relay ${a}: blocked by relayConnectionFilter`);return}if(s){this.debug(`Refusing to add relay ${a}: is a filter relay`);return}if(this.ndk.cacheAdapter?.getRelayStatus){const T=this.ndk.cacheAdapter.getRelayStatus(a),P=T instanceof Promise?void 0:T;if(P?.dontConnectBefore){if(P.dontConnectBefore>Date.now()){const W=P.dontConnectBefore-Date.now();this.debug(`Refusing to add relay ${a}: delayed connect for ${W}ms`),setTimeout(()=>{this.addRelay(e,t)},W);return}i=!1}}const u=T=>this.emit("notice",e,T),l=()=>this.handleRelayConnect(a),p=()=>this.handleRelayReady(e),g=()=>{this.recordDisconnection(e),this.emit("relay:disconnect",e)},v=()=>this.handleFlapping(e),m=T=>this.emit("relay:auth",e,T),w=()=>this.emit("relay:authed",e);e.off("notice",u),e.off("connect",l),e.off("ready",p),e.off("disconnect",g),e.off("flapping",v),e.off("auth",m),e.off("authed",w),e.on("notice",u),e.on("connect",l),e.on("ready",p),e.on("disconnect",g),e.on("flapping",v),e.on("auth",m),e.on("authed",w),e.on("delayed-connect",T=>{this.ndk.cacheAdapter?.updateRelayStatus&&this.ndk.cacheAdapter.updateRelayStatus(e.url,{dontConnectBefore:Date.now()+T})}),this._relays.set(a,e),t&&this.autoConnectRelays.add(a),t&&this.status==="active"&&(this.emit("relay:connecting",e),e.connect(void 0,i).catch(T=>{this.debug(`Failed to connect to relay ${a}`,T)}))}removeRelay(e){const t=this.relays.get(e);if(t)return t.disconnect(),this.relays.delete(e),this.autoConnectRelays.delete(e),this.emit("relay:disconnect",t),!0;const r=this.temporaryRelayTimers.get(e);return r&&(clearTimeout(r),this.temporaryRelayTimers.delete(e)),!1}isRelayConnected(e){const t=normalizeRelayUrl$1(e),r=this.relays.get(t);return r?r.status===5:!1}getRelay(e,t=!0,r=!1,s){let i=this.relays.get(normalizeRelayUrl$1(e));return i||(i=new NDKRelay$1(e,void 0,this.ndk),i.connectivity.netDebug=this.ndk.netDebug,r?this.useTemporaryRelay(i,3e4,s):this.addRelay(i,t)),i}handleRelayConnect(e){const t=this.relays.get(e);if(!t){console.error("NDK BUG: relay not found in pool",{relayUrl:e});return}this.emit("relay:connect",t),this.stats().connected===this.relays.size&&this.emit("connect")}handleRelayReady(e){this.emit("relay:ready",e)}async connect(e){this.status="active",this.debug(`Connecting to ${this.relays.size} relays${e?`, timeout ${e}ms`:""}...`);const t=Array.from(this.autoConnectRelays.keys()).map(a=>this.relays.get(a)).filter(a=>!!a);for(const a of t)a.status!==5&&a.status!==4&&(this.emit("relay:connecting",a),a.connect().catch(u=>{this.debug(`Failed to connect to relay ${a.url}: ${u??"No reason specified"}`)}));const r=()=>t.every(a=>a.status===5),s=new Promise(a=>{if(r()){a();return}const u=[];for(const l of t){const p=()=>{if(r()){for(let g=0;g<t.length;g++)t[g].off("connect",u[g]);a()}};u.push(p),l.on("connect",p)}}),i=typeof e=="number"?new Promise(a=>setTimeout(a,e)):new Promise(()=>{});await Promise.race([s,i])}checkOnFlappingRelays(){const e=this.flappingRelays.size,t=this.relays.size;if(e/t>=.8)for(const r of this.flappingRelays)this.backoffTimes.set(r,0)}recordDisconnection(e){const t=Date.now();this.disconnectionTimes.set(e.url,t);for(const[r,s]of this.disconnectionTimes.entries())t-s>1e4&&this.disconnectionTimes.delete(r);this.checkForSystemWideDisconnection()}checkForSystemWideDisconnection(){const e=Date.now(),t=[];for(const r of this.disconnectionTimes.values())e-r<5e3&&t.push(r);t.length>this.relays.size/2&&this.relays.size>1&&(this.debug(`System-wide disconnection detected: ${t.length}/${this.relays.size} relays disconnected`),this.handleSystemWideReconnection())}handleSystemWideReconnection(){if(this.systemEventDetector){this.debug("System-wide reconnection already in progress, skipping");return}this.debug("Initiating system-wide reconnection with reset backoff"),this.systemEventDetector=setTimeout(()=>{this.systemEventDetector=void 0},1e4);for(const e of this.relays.values())e.connectivity&&(e.connectivity.resetReconnectionState(),e.status!==5&&e.status!==4&&e.connect().catch(t=>{this.debug(`Failed to reconnect relay ${e.url} after system event: ${t}`)}));this.disconnectionTimes.clear()}handleFlapping(e){this.debug(`Relay ${e.url} is flapping`);let t=this.backoffTimes.get(e.url)||5e3;t=t*2,this.backoffTimes.set(e.url,t),this.debug(`Backoff time for ${e.url} is ${t}ms`),setTimeout(()=>{this.debug(`Attempting to reconnect to ${e.url}`),this.emit("relay:connecting",e),e.connect(),this.checkOnFlappingRelays()},t),e.disconnect(),this.emit("flapping",e)}size(){return this.relays.size}stats(){const e={total:0,connected:0,disconnected:0,connecting:0};for(const t of this.relays.values())e.total++,t.status===5?e.connected++:t.status===1?e.disconnected++:t.status===4&&e.connecting++;return e}connectedRelays(){return Array.from(this.relays.values()).filter(e=>e.status>=5)}permanentAndConnectedRelays(){return Array.from(this.relays.values()).filter(e=>e.status>=5&&!this.temporaryRelayTimers.has(e.url))}urls(){return Array.from(this.relays.keys())}},NDKDVMJobFeedback=class Br extends NDKEvent$1{static kinds=[7e3];constructor(e,t){super(e,t),this.kind??=7e3}static async from(e){const t=new Br(e.ndk,e.rawEvent());return t.encrypted&&await t.dvmDecrypt(),t}get status(){return this.tagValue("status")}set status(e){this.removeTag("status"),e!==void 0&&this.tags.push(["status",e])}get encrypted(){return!!this.getMatchingTags("encrypted")[0]}async dvmDecrypt(){await this.decrypt();const e=JSON.parse(this.content);this.tags.push(...e)}},NDKCashuMintList$1=class Fr extends NDKEvent$1{static kind=10019;static kinds=[10019];_p2pk;constructor(e,t){super(e,t),this.kind??=10019}static from(e){return new Fr(e.ndk,e)}set relays(e){this.tags=this.tags.filter(t=>t[0]!=="relay");for(const t of e)this.tags.push(["relay",t])}get relays(){const e=[];for(const t of this.tags)t[0]==="relay"&&e.push(t[1]);return e}set mints(e){this.tags=this.tags.filter(t=>t[0]!=="mint");for(const t of e)this.tags.push(["mint",t])}get mints(){const e=[];for(const t of this.tags)t[0]==="mint"&&e.push(t[1]);return Array.from(new Set(e))}get p2pk(){return this._p2pk?this._p2pk:(this._p2pk=this.tagValue("pubkey")??this.pubkey,this._p2pk)}set p2pk(e){this._p2pk=e,this.removeTag("pubkey"),e&&this.tags.push(["pubkey",e])}get relaySet(){return NDKRelaySet$1.fromRelayUrls(this.relays,this.ndk)}},NDKArticle=class Ur extends NDKEvent$1{static kind=30023;static kinds=[30023];constructor(e,t){super(e,t),this.kind??=30023}static from(e){return new Ur(e.ndk,e)}get title(){return this.tagValue("title")}set title(e){this.removeTag("title"),e&&this.tags.push(["title",e])}get image(){return this.tagValue("image")}set image(e){this.removeTag("image"),e&&this.tags.push(["image",e])}get summary(){return this.tagValue("summary")}set summary(e){this.removeTag("summary"),e&&this.tags.push(["summary",e])}get published_at(){const e=this.tagValue("published_at");if(e){let t=Number.parseInt(e);return t>1e12&&(t=Math.floor(t/1e3)),t}}set published_at(e){this.removeTag("published_at"),e!==void 0&&this.tags.push(["published_at",e.toString()])}async generateTags(){return super.generateTags(),this.published_at||(this.published_at=this.created_at),super.generateTags()}get url(){return this.tagValue("url")}set url(e){e?this.tags.push(["url",e]):this.removeTag("url")}},NDKBlossomList=class Or extends NDKEvent$1{static kinds=[10063];constructor(e,t){super(e,t),this.kind??=10063}static from(e){return new Or(e.ndk,e.rawEvent())}get servers(){return this.tags.filter(e=>e[0]==="server").map(e=>e[1])}set servers(e){this.tags=this.tags.filter(t=>t[0]!=="server");for(const t of e)this.tags.push(["server",t])}get default(){const e=this.servers;return e.length>0?e[0]:void 0}set default(e){if(!e)return;const r=this.servers.filter(s=>s!==e);this.servers=[e,...r]}addServer(e){if(!e)return;const t=this.servers;t.includes(e)||(this.servers=[...t,e])}removeServer(e){if(!e)return;const t=this.servers;this.servers=t.filter(r=>r!==e)}},NDKFedimintMint=class Mr extends NDKEvent$1{static kind=38173;static kinds=[38173];constructor(e,t){super(e,t),this.kind??=38173}static async from(e){return new Mr(e.ndk,e)}get identifier(){return this.tagValue("d")}set identifier(e){this.removeTag("d"),e&&this.tags.push(["d",e])}get inviteCodes(){return this.getMatchingTags("u").map(e=>e[1])}set inviteCodes(e){this.removeTag("u");for(const t of e)this.tags.push(["u",t])}get modules(){return this.getMatchingTags("modules").map(e=>e[1])}set modules(e){this.removeTag("modules");for(const t of e)this.tags.push(["modules",t])}get network(){return this.tagValue("n")}set network(e){this.removeTag("n"),e&&this.tags.push(["n",e])}get metadata(){if(this.content)try{return JSON.parse(this.content)}catch{return}}set metadata(e){e?this.content=JSON.stringify(e):this.content=""}},NDKCashuMintAnnouncement=class Lr extends NDKEvent$1{static kind=38172;static kinds=[38172];constructor(e,t){super(e,t),this.kind??=38172}static async from(e){return new Lr(e.ndk,e)}get identifier(){return this.tagValue("d")}set identifier(e){this.removeTag("d"),e&&this.tags.push(["d",e])}get url(){return this.tagValue("u")}set url(e){this.removeTag("u"),e&&this.tags.push(["u",e])}get nuts(){return this.getMatchingTags("nuts").map(e=>e[1])}set nuts(e){this.removeTag("nuts");for(const t of e)this.tags.push(["nuts",t])}get network(){return this.tagValue("n")}set network(e){this.removeTag("n"),e&&this.tags.push(["n",e])}get metadata(){if(this.content)try{return JSON.parse(this.content)}catch{return}}set metadata(e){e?this.content=JSON.stringify(e):this.content=""}},NDKMintRecommendation=class Vr extends NDKEvent$1{static kind=38e3;static kinds=[38e3];constructor(e,t){super(e,t),this.kind??=38e3}static async from(e){return new Vr(e.ndk,e)}get recommendedKind(){const e=this.tagValue("k");return e?Number(e):void 0}set recommendedKind(e){this.removeTag("k"),e&&this.tags.push(["k",e.toString()])}get identifier(){return this.tagValue("d")}set identifier(e){this.removeTag("d"),e&&this.tags.push(["d",e])}get urls(){return this.getMatchingTags("u").map(e=>e[1])}set urls(e){this.removeTag("u");for(const t of e)this.tags.push(["u",t])}get mintEventPointers(){return this.getMatchingTags("a").map(e=>({kind:Number(e[1].split(":")[0]),identifier:e[1].split(":")[2],relay:e[2]}))}addMintEventPointer(e,t,r,s){const i=["a",`${e}:${t}:${r}`];s&&i.push(s),this.tags.push(i)}get review(){return this.content}set review(e){this.content=e}},NDKClassified=class Hr extends NDKEvent$1{static kinds=[30402];constructor(e,t){super(e,t),this.kind??=30402}static from(e){return new Hr(e.ndk,e)}get title(){return this.tagValue("title")}set title(e){this.removeTag("title"),e&&this.tags.push(["title",e])}get summary(){return this.tagValue("summary")}set summary(e){this.removeTag("summary"),e&&this.tags.push(["summary",e])}get published_at(){const e=this.tagValue("published_at");if(e)return Number.parseInt(e)}set published_at(e){this.removeTag("published_at"),e!==void 0&&this.tags.push(["published_at",e.toString()])}get location(){return this.tagValue("location")}set location(e){this.removeTag("location"),e&&this.tags.push(["location",e])}get price(){const e=this.tags.find(t=>t[0]==="price");if(e)return{amount:Number.parseFloat(e[1]),currency:e[2],frequency:e[3]}}set price(e){if(typeof e=="string"&&(e={amount:Number.parseFloat(e)}),e?.amount){const t=["price",e.amount.toString()];e.currency&&t.push(e.currency),e.frequency&&t.push(e.frequency),this.tags.push(t)}else this.removeTag("price")}async generateTags(){return super.generateTags(),this.published_at||(this.published_at=this.created_at),super.generateTags()}},NDKDraft=class jr extends NDKEvent$1{_event;static kind=31234;static kinds=[31234,1234];counterparty;constructor(e,t){super(e,t),this.kind??=31234}static from(e){return new jr(e.ndk,e)}set identifier(e){this.removeTag("d"),this.tags.push(["d",e])}get identifier(){return this.dTag}set event(e){e instanceof NDKEvent$1?this._event=e:this._event=new NDKEvent$1(void 0,e),this.prepareEvent()}set checkpoint(e){e?(this.tags.push(e.tagReference()),this.kind=1234):(this.removeTag("a"),this.kind=31234)}get isCheckpoint(){return this.kind===1234}get isProposal(){const e=this.tagValue("p");return!!e&&e!==this.pubkey}async getEvent(e){if(this._event)return this._event;if(e??=this.ndk?.signer,!e)throw new Error("No signer available");if(this.content&&this.content.length>0)try{const t=e.pubkey,s=[this.tagValue("p"),this.pubkey].filter(Boolean).find(u=>u!==t);let i;i=new NDKUser$1({pubkey:s??t}),await this.decrypt(i,e);const a=JSON.parse(this.content);return this._event=await wrapEvent(new NDKEvent$1(this.ndk,a)),this._event}catch(t){console.error(t);return}else return null}prepareEvent(){if(!this._event)throw new Error("No event has been provided");this.removeTag("k"),this._event.kind&&this.tags.push(["k",this._event.kind.toString()]),this.content=JSON.stringify(this._event.rawEvent())}async save({signer:e,publish:t,relaySet:r}){if(e??=this.ndk?.signer,!e)throw new Error("No signer available");const s=this.counterparty||await e.user();if(await this.encrypt(s,e),this.counterparty){const i=this.counterparty.pubkey;this.removeTag("p"),this.tags.push(["p",i])}if(t!==!1)return this.publishReplaceable(r)}};function mapImetaTag(n){const e={};if(n.length===2){const r=n[1].split(" ");for(let s=0;s<r.length;s+=2){const i=r[s],a=r[s+1];i==="fallback"?(e.fallback||(e.fallback=[]),e.fallback.push(a)):e[i]=a}return e}const t=n.slice(1);for(const r of t){const s=r.split(" "),i=s[0],a=s.slice(1).join(" ");i==="fallback"?(e.fallback||(e.fallback=[]),e.fallback.push(a)):e[i]=a}return e}function imetaTagToTag(n){const e=["imeta"];for(const[t,r]of Object.entries(n))if(Array.isArray(r))for(const s of r)e.push(`${t} ${s}`);else r&&e.push(`${t} ${r}`);return e}var NDKFollowPack=class zr extends NDKEvent$1{static kind=39089;static kinds=[39089,39092];constructor(e,t){super(e,t),this.kind??=39089}static from(e){return new zr(e.ndk,e)}get title(){return this.tagValue("title")}set title(e){this.removeTag("title"),e&&this.tags.push(["title",e])}get image(){const e=this.tags.find(t=>t[0]==="imeta");if(e){const t=mapImetaTag(e);if(t.url)return t.url}return this.tagValue("image")}set image(e){this.tags=this.tags.filter(t=>t[0]!=="imeta"&&t[0]!=="image"),typeof e=="string"?e!==void 0&&this.tags.push(["image",e]):e&&typeof e=="object"&&(this.tags.push(imetaTagToTag(e)),e.url&&this.tags.push(["image",e.url]))}get pubkeys(){return Array.from(new Set(this.tags.filter(e=>e[0]==="p"&&e[1]&&isValidPubkey(e[1])).map(e=>e[1])))}set pubkeys(e){this.tags=this.tags.filter(t=>t[0]!=="p");for(const t of e)this.tags.push(["p",t])}get description(){return this.tagValue("description")}set description(e){this.removeTag("description"),e&&this.tags.push(["description",e])}},NDKHighlight=class qr extends NDKEvent$1{_article;static kind=9802;static kinds=[9802];constructor(e,t){super(e,t),this.kind??=9802}static from(e){return new qr(e.ndk,e)}get url(){return this.tagValue("r")}set context(e){e===void 0?this.tags=this.tags.filter(([t,r])=>t!=="context"):(this.tags=this.tags.filter(([t,r])=>t!=="context"),this.tags.push(["context",e]))}get context(){return this.tags.find(([e,t])=>e==="context")?.[1]??void 0}get article(){return this._article}set article(e){this._article=e,typeof e=="string"?this.tags.push(["r",e]):this.tag(e)}getArticleTag(){return this.getMatchingTags("a")[0]||this.getMatchingTags("e")[0]||this.getMatchingTags("r")[0]}async getArticle(){if(this._article!==void 0)return this._article;let e;const t=this.getArticleTag();if(t){switch(t[0]){case"a":{const[r,s,i]=t[1].split(":");e=nip19_exports$2.naddrEncode({kind:Number.parseInt(r),pubkey:s,identifier:i});break}case"e":e=nip19_exports$2.noteEncode(t[1]);break;case"r":this._article=t[1];break}if(e){let r=await this.ndk?.fetchEvent(e);r&&(r.kind===30023&&(r=NDKArticle.from(r)),this._article=r)}return this._article}}},NDKImage=class Wr extends NDKEvent$1{static kind=20;static kinds=[20];_imetas;constructor(e,t){super(e,t),this.kind??=20}static from(e){return new Wr(e.ndk,e.rawEvent())}get isValid(){return this.imetas.length>0}get imetas(){return this._imetas?this._imetas:(this._imetas=this.tags.filter(e=>e[0]==="imeta").map(mapImetaTag).filter(e=>!!e.url),this._imetas)}set imetas(e){this._imetas=e,this.tags=this.tags.filter(t=>t[0]!=="imeta"),this.tags.push(...e.map(imetaTagToTag))}},NDKList=class Gr extends NDKEvent$1{_encryptedTags;static kinds=[30001,10004,10050,10030,10015,10001,10002,10007,10006,10003];encryptedTagsLength;constructor(e,t){super(e,t),this.kind??=30001}static from(e){return new Gr(e.ndk,e)}get title(){const e=this.tagValue("title")||this.tagValue("name");return e||(this.kind===3?"Contacts":this.kind===1e4?"Mute":this.kind===10001?"Pinned Notes":this.kind===10002?"Relay Metadata":this.kind===10003?"Bookmarks":this.kind===10004?"Communities":this.kind===10005?"Public Chats":this.kind===10006?"Blocked Relays":this.kind===10007?"Search Relays":this.kind===10050?"Direct Message Receive Relays":this.kind===10015?"Interests":this.kind===10030?"Emojis":this.tagValue("d"))}set title(e){this.removeTag(["title","name"]),e&&this.tags.push(["title",e])}get name(){return this.title}set name(e){this.title=e}get description(){return this.tagValue("description")}set description(e){this.removeTag("description"),e&&this.tags.push(["description",e])}get image(){return this.tagValue("image")}set image(e){this.removeTag("image"),e&&this.tags.push(["image",e])}isEncryptedTagsCacheValid(){return!!(this._encryptedTags&&this.encryptedTagsLength===this.content.length)}async encryptedTags(e=!0){if(e&&this.isEncryptedTagsCacheValid())return this._encryptedTags;if(!this.ndk)throw new Error("NDK instance not set");if(!this.ndk.signer)throw new Error("NDK signer not set");const t=await this.ndk.signer.user();try{if(this.content.length>0)try{const r=await this.ndk.signer.decrypt(t,this.content),s=JSON.parse(r);return s?.[0]?(this.encryptedTagsLength=this.content.length,this._encryptedTags=s):(this.encryptedTagsLength=this.content.length,this._encryptedTags=[])}catch{}}catch{}return[]}validateTag(e){return!0}getItems(e){return this.tags.filter(t=>t[0]===e)}get items(){return this.tags.filter(e=>!["d","L","l","title","name","description","published_at","summary","image","thumb","alt","expiration","subject","client"].includes(e[0]))}async addItem(e,t=void 0,r=!1,s="bottom"){if(!this.ndk)throw new Error("NDK instance not set");if(!this.ndk.signer)throw new Error("NDK signer not set");let i;if(e instanceof NDKEvent$1)i=[e.tagReference(t)];else if(e instanceof NDKUser$1)i=e.referenceTags();else if(e instanceof NDKRelay$1)i=e.referenceTags();else if(Array.isArray(e))i=[e];else throw new Error("Invalid object type");if(t&&i[0].push(t),r){const a=await this.ndk.signer.user(),u=await this.encryptedTags();s==="top"?u.unshift(...i):u.push(...i),this._encryptedTags=u,this.encryptedTagsLength=this.content.length,this.content=JSON.stringify(u),await this.encrypt(a)}else s==="top"?this.tags.unshift(...i):this.tags.push(...i);this.created_at=Math.floor(Date.now()/1e3),this.emit("change")}async removeItemByValue(e,t=!0){if(!this.ndk)throw new Error("NDK instance not set");if(!this.ndk.signer)throw new Error("NDK signer not set");const r=this.tags.findIndex(u=>u[1]===e);r>=0&&this.tags.splice(r,1);const s=await this.ndk.signer.user(),i=await this.encryptedTags(),a=i.findIndex(u=>u[1]===e);if(a>=0&&(i.splice(a,1),this._encryptedTags=i,this.encryptedTagsLength=this.content.length,this.content=JSON.stringify(i),await this.encrypt(s)),t)return this.publishReplaceable();this.created_at=Math.floor(Date.now()/1e3),this.emit("change")}async removeItem(e,t){if(!this.ndk)throw new Error("NDK instance not set");if(!this.ndk.signer)throw new Error("NDK signer not set");if(t){const r=await this.ndk.signer.user(),s=await this.encryptedTags();s.splice(e,1),this._encryptedTags=s,this.encryptedTagsLength=this.content.length,this.content=JSON.stringify(s),await this.encrypt(r)}else this.tags.splice(e,1);return this.created_at=Math.floor(Date.now()/1e3),this.emit("change"),this}has(e){return this.items.some(t=>t[1]===e)}filterForItems(){const e=new Set,t=new Map,r=[];for(const s of this.items)if(s[0]==="e"&&s[1])e.add(s[1]);else if(s[0]==="a"&&s[1]){const[i,a,u]=s[1].split(":");if(!i||!a)continue;const l=`${i}:${a}`,p=t.get(l)||[];p.push(u||""),t.set(l,p)}if(e.size>0&&r.push({ids:Array.from(e)}),t.size>0)for(const[s,i]of t.entries()){const[a,u]=s.split(":");r.push({kinds:[Number.parseInt(a)],authors:[u],"#d":i})}return r}},NDKAppHandlerEvent=class Yr extends NDKEvent$1{profile;static kinds=[31990];constructor(e,t){super(e,t),this.kind??=31990}static from(e){const t=new Yr(e.ndk,e.rawEvent());return t.isValid?t:null}get isValid(){const e=new Map,t=s=>[s[0],s[2]].join(":").toLowerCase(),r=["web","android","ios"];for(const s of this.tags)if(r.includes(s[0])){const i=t(s);if(e.has(i)&&e.get(i)!==s[1].toLowerCase())return!1;e.set(i,s[1].toLowerCase())}return!0}async fetchProfile(){if(this.profile===void 0&&this.content.length>0)try{const e=JSON.parse(this.content);if(e?.name)return e;this.profile=null}catch{this.profile=null}return new Promise((e,t)=>{const r=this.author;r.fetchProfile().then(()=>{e(r.profile)}).catch(t)})}},NDKNutzap=class Zn extends NDKEvent$1{debug;_proofs=[];static kind=9321;static kinds=[Zn.kind];constructor(e,t){super(e,t),this.kind??=9321,this.debug=e?.debug.extend("nutzap")??createDebug2("ndk:nutzap"),this.alt||(this.alt="This is a nutzap");try{const r=this.getMatchingTags("proof");r.length?this._proofs=r.map(s=>JSON.parse(s[1])):this._proofs=JSON.parse(this.content)}catch{return}}static from(e){const t=new Zn(e.ndk,e);if(!(!t._proofs||!t._proofs.length))return t}set comment(e){this.content=e??""}get comment(){const e=this.tagValue("comment");return e||this.content}set proofs(e){this._proofs=e,this.tags=this.tags.filter(t=>t[0]!=="proof");for(const t of e)this.tags.push(["proof",JSON.stringify(t)])}get proofs(){return this._proofs}get rawP2pk(){const e=this.proofs[0];try{const t=JSON.parse(e.secret);let r;if(typeof t=="string"?(r=JSON.parse(t),this.debug("stringified payload",e.secret)):typeof t=="object"&&(r=t),Array.isArray(r)&&r[0]==="P2PK"&&r.length>1&&typeof r[1]=="object"&&r[1]!==null||typeof r=="object"&&r!==null&&typeof r[1]?.data=="string")return r[1].data}catch(t){this.debug("error parsing p2pk pubkey",t,this.proofs[0])}}get p2pk(){const e=this.rawP2pk;if(e)return e.startsWith("02")?e.slice(2):e}get mint(){return this.tagValue("u")}set mint(e){this.replaceTag(["u",e])}get unit(){let e=this.tagValue("unit")??"sat";return e?.startsWith("msat")&&(e="sat"),e}set unit(e){if(this.removeTag("unit"),e?.startsWith("msat"))throw new Error("msat is not allowed, use sat denomination instead");e&&this.tag(["unit",e])}get amount(){return this.proofs.reduce((t,r)=>t+r.amount,0)}sender=this.author;set target(e){this.tags=this.tags.filter(t=>t[0]!=="p"),e instanceof NDKEvent$1&&this.tags.push(e.tagReference())}set recipientPubkey(e){this.removeTag("p"),this.tag(["p",e])}get recipientPubkey(){return this.tagValue("p")}get recipient(){const e=this.recipientPubkey;return this.ndk?this.ndk.getUser({pubkey:e}):new NDKUser$1({pubkey:e})}async toNostrEvent(){this.unit==="msat"&&(this.unit="sat"),this.removeTag("amount"),this.tags.push(["amount",this.amount.toString()]);const e=await super.toNostrEvent();return e.content=this.comment,e}get isValid(){let e=0,t=0,r=0;for(const s of this.tags)s[0]==="e"&&e++,s[0]==="p"&&t++,s[0]==="u"&&r++;return t===1&&r===1&&e<=1&&this.proofs.length>0}},NDKProject=class Zr extends NDKEvent$1{static kind=31933;static kinds=[31933];_signer;constructor(e,t){super(e,t),this.kind=31933}static from(e){return new Zr(e.ndk,e.rawEvent())}set repo(e){this.removeTag("repo"),e&&this.tags.push(["repo",e])}set hashtags(e){this.removeTag("hashtags"),e.filter(t=>t.length>0).length&&this.tags.push(["hashtags",...e])}get hashtags(){const e=this.tags.find(t=>t[0]==="hashtags");return e?e.slice(1):[]}get repo(){return this.tagValue("repo")}get title(){return this.tagValue("title")}set title(e){this.removeTag("title"),e&&this.tags.push(["title",e])}get picture(){return this.tagValue("picture")}set picture(e){this.removeTag("picture"),e&&this.tags.push(["picture",e])}set description(e){this.content=e}get description(){return this.content}get slug(){return this.dTag??"empty-dtag"}async getSigner(){if(this._signer)return this._signer;const e=this.tagValue("key");if(!e)this._signer=NDKPrivateKeySigner$1.generate(),await this.encryptAndSaveNsec();else{const t=await this.ndk?.signer?.decrypt(this.ndk.activeUser,e);if(!t)throw new Error("Failed to decrypt project key or missing signer context.");this._signer=new NDKPrivateKeySigner$1(t)}return this._signer}async getNsec(){return(await this.getSigner()).privateKey}async setNsec(e){this._signer=new NDKPrivateKeySigner$1(e),await this.encryptAndSaveNsec()}async encryptAndSaveNsec(){if(!this._signer)throw new Error("Signer is not set.");const e=this._signer.privateKey,t=await this.ndk?.signer?.encrypt(this.ndk.activeUser,e);t&&(this.removeTag("key"),this.tags.push(["key",t]))}},NDKProjectTemplate=class Jr extends NDKEvent$1{static kind=30717;static kinds=[30717];constructor(e,t){super(e,t),this.kind=30717}static from(e){return new Jr(e.ndk,e.rawEvent())}get templateId(){return this.dTag??""}set templateId(e){this.dTag=e}get name(){return this.tagValue("title")??""}set name(e){this.removeTag("title"),e&&this.tags.push(["title",e])}get description(){return this.tagValue("description")??""}set description(e){this.removeTag("description"),e&&this.tags.push(["description",e])}get repoUrl(){return this.tagValue("uri")??""}set repoUrl(e){this.removeTag("uri"),e&&this.tags.push(["uri",e])}get image(){return this.tagValue("image")}set image(e){this.removeTag("image"),e&&this.tags.push(["image",e])}get command(){return this.tagValue("command")}set command(e){this.removeTag("command"),e&&this.tags.push(["command",e])}get agentConfig(){const e=this.tagValue("agent");if(e)try{return JSON.parse(e)}catch{return}}set agentConfig(e){this.removeTag("agent"),e&&this.tags.push(["agent",JSON.stringify(e)])}get templateTags(){return this.getMatchingTags("t").map(e=>e[1]).filter(Boolean)}set templateTags(e){this.tags=this.tags.filter(t=>t[0]!=="t"),e.forEach(t=>{t&&this.tags.push(["t",t])})}},READ_MARKER="read",WRITE_MARKER="write",NDKRelayList=class Xr extends NDKEvent$1{static kinds=[10002];constructor(e,t){super(e,t),this.kind??=10002}static from(e){return new Xr(e.ndk,e.rawEvent())}get readRelayUrls(){return this.tags.filter(e=>e[0]==="r"||e[0]==="relay").filter(e=>!e[2]||e[2]&&e[2]===READ_MARKER).map(e=>tryNormalizeRelayUrl(e[1])).filter(e=>!!e)}set readRelayUrls(e){for(const t of e)this.tags.push(["r",t,READ_MARKER])}get writeRelayUrls(){return this.tags.filter(e=>e[0]==="r"||e[0]==="relay").filter(e=>!e[2]||e[2]&&e[2]===WRITE_MARKER).map(e=>tryNormalizeRelayUrl(e[1])).filter(e=>!!e)}set writeRelayUrls(e){for(const t of e)this.tags.push(["r",t,WRITE_MARKER])}get bothRelayUrls(){return this.tags.filter(e=>e[0]==="r"||e[0]==="relay").filter(e=>!e[2]).map(e=>e[1])}set bothRelayUrls(e){for(const t of e)this.tags.push(["r",t])}get relays(){return this.tags.filter(e=>e[0]==="r"||e[0]==="relay").map(e=>e[1])}get relaySet(){if(!this.ndk)throw new Error("NDKRelayList has no NDK instance");return new NDKRelaySet$1(new Set(this.relays.map(e=>this.ndk?.pool.getRelay(e)).filter(e=>!!e)),this.ndk)}};function relayListFromKind3(n,e){try{const t=JSON.parse(e.content),r=new NDKRelayList(n),s=new Set,i=new Set;for(let[a,u]of Object.entries(t)){try{a=normalizeRelayUrl$1(a)}catch{continue}if(!u)s.add(a),i.add(a);else{const l=u;l.write&&i.add(a),l.read&&s.add(a)}}return r.readRelayUrls=Array.from(s),r.writeRelayUrls=Array.from(i),r}catch{}}var NDKRepost=class Qr extends NDKEvent$1{_repostedEvents;static kinds=[6,16];static from(e){return new Qr(e.ndk,e.rawEvent())}async repostedEvents(e,t){const r=[];if(!this.ndk)throw new Error("NDK instance not set");if(this._repostedEvents!==void 0)return this._repostedEvents;for(const s of this.repostedEventIds()){const i=filterForId(s),a=await this.ndk.fetchEvent(i,t);a&&r.push(e?e.from(a):a)}return r}repostedEventIds(){return this.tags.filter(e=>e[0]==="e"||e[0]==="a").map(e=>e[1])}};function filterForId(n){if(n.match(/:/)){const[e,t,r]=n.split(":");return{kinds:[Number.parseInt(e)],authors:[t],"#d":[r]}}return{ids:[n]}}var NDKSimpleGroupMemberList=class es extends NDKEvent$1{relaySet;memberSet=new Set;static kind=39002;static kinds=[39002];constructor(e,t){super(e,t),this.kind??=39002,this.memberSet=new Set(this.members)}static from(e){return new es(e.ndk,e)}get members(){return this.getMatchingTags("p").map(e=>e[1])}hasMember(e){return this.memberSet.has(e)}async publish(e,t,r){return e??=this.relaySet,super.publishReplaceable(e,t,r)}},NDKSimpleGroupMetadata=class ts extends NDKEvent$1{static kind=39e3;static kinds=[39e3];constructor(e,t){super(e,t),this.kind??=39e3}static from(e){return new ts(e.ndk,e)}get name(){return this.tagValue("name")}get picture(){return this.tagValue("picture")}get about(){return this.tagValue("about")}get scope(){if(this.getMatchingTags("public").length>0)return"public";if(this.getMatchingTags("public").length>0)return"private"}set scope(e){this.removeTag("public"),this.removeTag("private"),e==="public"?this.tags.push(["public",""]):e==="private"&&this.tags.push(["private",""])}get access(){if(this.getMatchingTags("open").length>0)return"open";if(this.getMatchingTags("closed").length>0)return"closed"}set access(e){this.removeTag("open"),this.removeTag("closed"),e==="open"?this.tags.push(["open",""]):e==="closed"&&this.tags.push(["closed",""])}};function strToPosition(n){const[e,t]=n.split(",").map(Number);return{x:e,y:t}}function strToDimension(n){const[e,t]=n.split("x").map(Number);return{width:e,height:t}}var NDKStorySticker=class ns{static Text="text";static Pubkey="pubkey";static Event="event";static Prompt="prompt";static Countdown="countdown";type;value;position;dimension;properties;constructor(e){if(Array.isArray(e)){const t=e;if(t[0]!=="sticker"||t.length<5)throw new Error("Invalid sticker tag");this.type=t[1],this.value=t[2],this.position=strToPosition(t[3]),this.dimension=strToDimension(t[4]);const r={};for(let s=5;s<t.length;s++){const[i,...a]=t[s].split(" ");r[i]=a.join(" ")}Object.keys(r).length>0&&(this.properties=r)}else this.type=e,this.value=void 0,this.position={x:0,y:0},this.dimension={width:0,height:0}}static fromTag(e){try{return new ns(e)}catch{return null}}get style(){return this.properties?.style}set style(e){e?this.properties={...this.properties,style:e}:delete this.properties?.style}get rotation(){return this.properties?.rot?Number.parseFloat(this.properties.rot):void 0}set rotation(e){e!==void 0?this.properties={...this.properties,rot:e.toString()}:delete this.properties?.rot}get isValid(){return this.hasValidDimensions()&&this.hasValidPosition()}hasValidDimensions=()=>typeof this.dimension.width=="number"&&typeof this.dimension.height=="number"&&!Number.isNaN(this.dimension.width)&&!Number.isNaN(this.dimension.height);hasValidPosition=()=>typeof this.position.x=="number"&&typeof this.position.y=="number"&&!Number.isNaN(this.position.x)&&!Number.isNaN(this.position.y);toTag(){if(!this.isValid){const r=[this.hasValidDimensions()?void 0:"dimensions is invalid",this.hasValidPosition()?void 0:"position is invalid"].filter(Boolean);throw new Error(`Invalid sticker: ${r.join(", ")}`)}let e;switch(this.type){case"event":e=this.value.tagId();break;case"pubkey":e=this.value.pubkey;break;default:e=this.value}const t=["sticker",this.type,e,coordinates(this.position),dimension(this.dimension)];if(this.properties)for(const[r,s]of Object.entries(this.properties))t.push(`${r} ${s}`);return t}},NDKStory=class rs extends NDKEvent$1{static kind=23;static kinds=[23];_imeta;_dimensions;constructor(e,t){if(super(e,t),this.kind??=23,t)for(const r of t.tags)switch(r[0]){case"imeta":this._imeta=mapImetaTag(r);break;case"dim":this.dimensions=strToDimension(r[1]);break}}static from(e){return new rs(e.ndk,e)}get isValid(){return!!this.imeta}get imeta(){return this._imeta}set imeta(e){this._imeta=e,this.tags=this.tags.filter(t=>t[0]!=="imeta"),e&&this.tags.push(imetaTagToTag(e))}get dimensions(){const e=this.tagValue("dim");if(e)return strToDimension(e)}set dimensions(e){this.removeTag("dim"),e&&this.tags.push(["dim",`${e.width}x${e.height}`])}get duration(){const e=this.tagValue("dur");if(e)return Number.parseInt(e)}set duration(e){this.removeTag("dur"),e!==void 0&&this.tags.push(["dur",e.toString()])}get stickers(){const e=[];for(const t of this.tags){if(t[0]!=="sticker"||t.length<5)continue;const r=NDKStorySticker.fromTag(t);r&&e.push(r)}return e}addSticker(e){let t;if(e instanceof NDKStorySticker)t=e;else{const r=["sticker",e.type,typeof e.value=="string"?e.value:"",coordinates(e.position),dimension(e.dimension)];if(e.properties)for(const[s,i]of Object.entries(e.properties))r.push(`${s} ${i}`);t=new NDKStorySticker(r),t.value=e.value}t.type==="pubkey"?this.tag(t.value):t.type==="event"&&this.tag(t.value),this.tags.push(t.toTag())}removeSticker(e){const t=this.stickers;if(e<0||e>=t.length)return;let r=0;for(let s=0;s<this.tags.length;s++)if(this.tags[s][0]==="sticker"){if(r===e){this.tags.splice(s,1);break}r++}}},coordinates=n=>`${n.x},${n.y}`,dimension=n=>`${n.width}x${n.height}`,NDKSubscriptionReceipt=class ss extends NDKEvent$1{debug;static kinds=[7003];constructor(e,t){super(e,t),this.kind??=7003,this.debug=e?.debug.extend("subscription-start")??createDebug2("ndk:subscription-start")}static from(e){return new ss(e.ndk,e.rawEvent())}get recipient(){const e=this.getMatchingTags("p")?.[0];return e?new NDKUser$1({pubkey:e[1]}):void 0}set recipient(e){this.removeTag("p"),e&&this.tags.push(["p",e.pubkey])}get subscriber(){const e=this.getMatchingTags("P")?.[0];return e?new NDKUser$1({pubkey:e[1]}):void 0}set subscriber(e){this.removeTag("P"),e&&this.tags.push(["P",e.pubkey])}set subscriptionStart(e){this.debug(`before setting subscription start: ${this.rawEvent}`),this.removeTag("e"),this.tag(e,"subscription",!0),this.debug(`after setting subscription start: ${this.rawEvent}`)}get tierName(){return this.getMatchingTags("tier")?.[0]?.[1]}get isValid(){const e=this.validPeriod;if(!e||e.start>e.end)return!1;const t=this.getMatchingTags("p"),r=this.getMatchingTags("P");return!(t.length!==1||r.length!==1)}get validPeriod(){const e=this.getMatchingTags("valid")?.[0];if(e)try{return{start:new Date(Number.parseInt(e[1])*1e3),end:new Date(Number.parseInt(e[2])*1e3)}}catch{return}}set validPeriod(e){this.removeTag("valid"),e&&this.tags.push(["valid",Math.floor(e.start.getTime()/1e3).toString(),Math.floor(e.end.getTime()/1e3).toString()])}get startPeriod(){return this.validPeriod?.start}get endPeriod(){return this.validPeriod?.end}isActive(e){e??=new Date;const t=this.validPeriod;return!(!t||e<t.start||e>t.end)}},possibleIntervalFrequencies=["daily","weekly","monthly","quarterly","yearly"];function newAmount(n,e,t){return["amount",n.toString(),e,t]}function parseTagToSubscriptionAmount(n){const e=Number.parseInt(n[1]);if(Number.isNaN(e)||e===void 0||e===null||e<=0)return;const t=n[2];if(t===void 0||t==="")return;const r=n[3];if(r!==void 0&&possibleIntervalFrequencies.includes(r))return{amount:e,currency:t,term:r}}var NDKSubscriptionTier=class is extends NDKArticle{static kind=37001;static kinds=[37001];constructor(e,t){const r=t?.kind??37001;super(e,t),this.kind=r}static from(e){return new is(e.ndk,e)}get perks(){return this.getMatchingTags("perk").map(e=>e[1]).filter(e=>e!==void 0)}addPerk(e){this.tags.push(["perk",e])}get amounts(){return this.getMatchingTags("amount").map(e=>parseTagToSubscriptionAmount(e)).filter(e=>e!==void 0)}addAmount(e,t,r){this.tags.push(newAmount(e,t,r))}set relayUrl(e){this.tags.push(["r",e])}get relayUrls(){return this.getMatchingTags("r").map(e=>e[1]).filter(e=>e!==void 0)}get verifierPubkey(){return this.tagValue("p")}set verifierPubkey(e){this.removeTag("p"),e&&this.tags.push(["p",e])}get isValid(){return this.title!==void 0&&this.amounts.length>0}},NDKSubscriptionStart=class os extends NDKEvent$1{debug;static kinds=[7001];constructor(e,t){super(e,t),this.kind??=7001,this.debug=e?.debug.extend("subscription-start")??createDebug2("ndk:subscription-start")}static from(e){return new os(e.ndk,e.rawEvent())}get recipient(){const e=this.getMatchingTags("p")?.[0];return e?new NDKUser$1({pubkey:e[1]}):void 0}set recipient(e){this.removeTag("p"),e&&this.tags.push(["p",e.pubkey])}get amount(){const e=this.getMatchingTags("amount")?.[0];if(e)return parseTagToSubscriptionAmount(e)}set amount(e){this.removeTag("amount"),e&&this.tags.push(newAmount(e.amount,e.currency,e.term))}get tierId(){const e=this.getMatchingTags("e")?.[0],t=this.getMatchingTags("a")?.[0];if(!(!e||!t))return e[1]??t[1]}set tier(e){this.removeTag("e"),this.removeTag("a"),this.removeTag("event"),e&&(this.tag(e),this.removeTag("p"),this.tags.push(["p",e.pubkey]),this.tags.push(["event",JSON.stringify(e.rawEvent())]))}async fetchTier(){const e=this.tagValue("event");if(e)try{const s=JSON.parse(e);return new NDKSubscriptionTier(this.ndk,s)}catch{this.debug("Failed to parse event tag")}const t=this.tierId;if(!t)return;const r=await this.ndk?.fetchEvent(t);if(r)return NDKSubscriptionTier.from(r)}get isValid(){return this.getMatchingTags("amount").length!==1?(this.debug("Invalid # of amount tag"),!1):this.amount?this.getMatchingTags("p").length!==1?(this.debug("Invalid # of p tag"),!1):this.recipient?!0:(this.debug("Invalid p tag"),!1):(this.debug("Invalid amount tag"),!1)}},NDKTask=class as extends NDKEvent$1{static kind=1934;static kinds=[1934];constructor(e,t){super(e,t),this.kind=1934}static from(e){return new as(e.ndk,e.rawEvent())}set title(e){this.removeTag("title"),e&&this.tags.push(["title",e])}get title(){return this.tagValue("title")}set project(e){this.removeTag("a"),this.tags.push(e.tagReference())}get projectSlug(){const e=this.getMatchingTags("a")[0];return e?e[1].split(/:/)?.[2]:void 0}},NDKThread=class cs extends NDKEvent$1{static kind=11;static kinds=[11];constructor(e,t){super(e,t),this.kind??=11}static from(e){return new cs(e.ndk,e)}get title(){return this.tagValue("title")}set title(e){this.removeTag("title"),e&&this.tags.push(["title",e])}},NDKVideo=class us extends NDKEvent$1{static kind=21;static kinds=[34235,34236,22,21];_imetas;static from(e){return new us(e.ndk,e.rawEvent())}get title(){return this.tagValue("title")}set title(e){this.removeTag("title"),e&&this.tags.push(["title",e])}get thumbnail(){let e;return this.imetas&&this.imetas.length>0&&(e=this.imetas[0].image?.[0]),e??this.tagValue("thumb")}get imetas(){return this._imetas?this._imetas:(this._imetas=this.tags.filter(e=>e[0]==="imeta").map(mapImetaTag),this._imetas)}set imetas(e){this._imetas=e,this.tags=this.tags.filter(t=>t[0]!=="imeta"),this.tags.push(...e.map(imetaTagToTag))}get url(){return this.imetas&&this.imetas.length>0?this.imetas[0].url:this.tagValue("url")}get published_at(){const e=this.tagValue("published_at");if(e)return Number.parseInt(e)}async generateTags(){if(super.generateTags(),!this.kind&&this.imetas?.[0]?.dim){const[e,t]=this.imetas[0].dim.split("x"),r=e&&t&&Number.parseInt(e)<Number.parseInt(t);this.duration&&this.duration<120&&r?this.kind=22:this.kind=21}return super.generateTags()}get duration(){const e=this.tagValue("duration");if(e)return Number.parseInt(e)}set duration(e){this.removeTag("duration"),e!==void 0&&this.tags.push(["duration",Math.floor(e).toString()])}},NDKWiki=class ls extends NDKArticle{static kind=30818;static kinds=[30818];static from(e){return new ls(e.ndk,e.rawEvent())}get isDefered(){return this.hasTag("a","defer")}get deferedId(){return this.tagValue("a","defer")}set defer(e){this.removeTag("a","defer"),this.tag(e,"defer")}},NDKWikiMergeRequest=class hs extends NDKEvent$1{static kinds=[818];static from(e){return new hs(e.ndk,e.rawEvent())}get targetId(){return this.tagValue("a")}set target(e){this.tags=this.tags.filter(t=>{if(t[0]==="a"||t[0]==="e"&&t[3]!=="source")return!0}),this.tag(e)}get sourceId(){return this.tagValue("e","source")}set source(e){this.removeTag("e","source"),this.tag(e,"source",!1,"e")}},registeredEventClasses=new Set;function wrapEvent(n){const e=new Map,r=[...[NDKImage,NDKVideo,NDKCashuMintList$1,NDKArticle,NDKHighlight,NDKDraft,NDKWiki,NDKWikiMergeRequest,NDKNutzap,NDKProject,NDKTask,NDKProjectTemplate,NDKSimpleGroupMemberList,NDKSimpleGroupMetadata,NDKSubscriptionTier,NDKSubscriptionStart,NDKSubscriptionReceipt,NDKList,NDKRelayList,NDKStory,NDKBlossomList,NDKFollowPack,NDKThread,NDKRepost,NDKClassified,NDKAppHandlerEvent,NDKDVMJobFeedback,NDKCashuMintAnnouncement,NDKFedimintMint,NDKMintRecommendation],...registeredEventClasses];for(const i of r)for(const a of i.kinds)e.set(a,i);const s=e.get(n.kind);return s?s.from(n):n}function checkMissingKind(n,e){(n.kind===void 0||n.kind===null)&&e("event-missing-kind",`Cannot sign event without 'kind'.

 Event data:
    content: ${n.content?`"${n.content.substring(0,50)}${n.content.length>50?"...":""}"`:"(empty)"}
    tags: ${n.tags.length} tag${n.tags.length!==1?"s":""}
    kind: ${n.kind} 

Set event.kind before signing.`,"Example: event.kind = 1; // for text note",!1)}function checkContentIsObject(n,e){if(typeof n.content=="object"){const t=JSON.stringify(n.content,null,2).substring(0,200);e("event-content-is-object",`Event content is an object. Content must be a string.

 Your content (${typeof n.content}):
${t}${JSON.stringify(n.content).length>200?"...":""}

 event.content = { ... }  // WRONG
 event.content = JSON.stringify({ ... })  // CORRECT`,"Use JSON.stringify() for structured data: event.content = JSON.stringify(data)",!1)}}function checkCreatedAtMilliseconds(n,e){if(n.created_at&&n.created_at>1e10){const t=Math.floor(n.created_at/1e3),r=new Date(n.created_at).toISOString();e("event-created-at-milliseconds",`Event created_at is in milliseconds, not seconds.

 Your value:
    created_at: ${n.created_at} 
    Interpreted as: ${r}
    Should be: ${t} 

Nostr timestamps MUST be in seconds since Unix epoch.`,"Use Math.floor(Date.now() / 1000) instead of Date.now()",!1)}}function checkInvalidPTags(n,e){n.getMatchingTags("p").forEach((r,s)=>{if(r[1]&&!/^[0-9a-f]{64}$/i.test(r[1])){const i=JSON.stringify(r);e("tag-invalid-p-tag",`p-tag[${s}] has invalid pubkey.

 Your tag:
   ${i}

 Invalid value: "${r[1]}"
    Length: ${r[1].length} (expected 64)
    Format: ${r[1].startsWith("npub")?"bech32 (npub)":"unknown"}

p-tags MUST contain 64-character hex pubkeys.`,r[1].startsWith("npub")?`Use ndkUser.pubkey instead of npub:
    event.tags.push(['p', ndkUser.pubkey])
    event.tags.push(['p', 'npub1...'])`:"p-tags must contain valid hex pubkeys (64 characters, 0-9a-f)",!1)}})}function checkInvalidETags(n,e){n.getMatchingTags("e").forEach((r,s)=>{if(r[1]&&!/^[0-9a-f]{64}$/i.test(r[1])){const i=JSON.stringify(r),a=r[1].startsWith("note")||r[1].startsWith("nevent");e("tag-invalid-e-tag",`e-tag[${s}] has invalid event ID.

 Your tag:
   ${i}

 Invalid value: "${r[1]}"
    Length: ${r[1].length} (expected 64)
    Format: ${a?"bech32 (note/nevent)":"unknown"}

e-tags MUST contain 64-character hex event IDs.`,a?`Use event.id instead of bech32:
    event.tags.push(['e', referencedEvent.id])
    event.tags.push(['e', 'note1...'])`:"e-tags must contain valid hex event IDs (64 characters, 0-9a-f)",!1)}})}function checkManualReplyMarkers(n,e,t){if(n.kind!==1||t.has(n))return;const r=n.tags.filter(s=>s[0]==="e"&&(s[3]==="reply"||s[3]==="root"));if(r.length>0){const s=r.map((i,a)=>`   ${a+1}. ${JSON.stringify(i)}`).join(`
`);e("event-manual-reply-markers",`Event has ${r.length} e-tag(s) with manual reply/root markers.

 Your tags with markers:
${s}

  Manual reply markers detected! This will cause incorrect threading.`,`Reply events MUST be created using .reply():

    CORRECT:
   const replyEvent = originalEvent.reply();
   replyEvent.content = 'good point!';
   await replyEvent.publish();

    WRONG:
   event.tags.push(['e', eventId, '', 'reply']);

NDK handles all reply threading automatically - never add reply/root markers manually.`)}}function checkHashtagsWithPrefix(n,e){n.getMatchingTags("t").forEach((r,s)=>{if(r[1]&&r[1].startsWith("#")){const i=JSON.stringify(r);e("tag-hashtag-with-prefix",`t-tag[${s}] contains hashtag with # prefix.

 Your tag:
   ${i}

 Invalid value: "${r[1]}"

Hashtag tags should NOT include the # symbol.`,`Remove the # prefix from hashtag tags:
    event.tags.push(['t', 'nostr'])
    event.tags.push(['t', '#nostr'])`,!1)}})}function checkReplaceableWithOldTimestamp(n,e){if(n.kind===void 0||n.kind===null||!n.created_at||!n.isReplaceable())return;const t=Math.floor(Date.now()/1e3),r=t-n.created_at;if(r>10){const i=Math.floor(r/60),a=i>0?`${i} minute${i!==1?"s":""}`:`${r} seconds`;e("event-replaceable-old-timestamp",`Publishing a replaceable event with an old created_at timestamp.

 Event details:
    kind: ${n.kind} (replaceable)
    created_at: ${n.created_at}
    age: ${a} old
    current time: ${t}

  This is wrong and will be rejected by relays.`,`For replaceable events, use publishReplaceable():

    CORRECT:
   await event.publishReplaceable();
   // Automatically updates created_at to now

    WRONG:
   await event.publish();
   // Uses old created_at`)}}function signing(n,e,t,r){checkMissingKind(n,e),checkContentIsObject(n,e),checkCreatedAtMilliseconds(n,e),checkInvalidPTags(n,e),checkInvalidETags(n,e),checkHashtagsWithPrefix(n,e),checkManualReplyMarkers(n,t,r)}function publishing(n,e){checkReplaceableWithOldTimestamp(n,e)}function isNip33Pattern(n){const e=Array.isArray(n)?n:[n];if(e.length!==1)return!1;const t=e[0];return t.kinds&&Array.isArray(t.kinds)&&t.kinds.length===1&&t.authors&&Array.isArray(t.authors)&&t.authors.length===1&&t["#d"]&&Array.isArray(t["#d"])&&t["#d"].length===1}function isReplaceableEventFilter(n){const e=Array.isArray(n)?n:[n];return e.length===0?!1:e.every(t=>!t.kinds||!Array.isArray(t.kinds)||t.kinds.length===0||!t.authors||!Array.isArray(t.authors)||t.authors.length===0?!1:t.kinds.every(s=>s===0||s===3||s>=1e4&&s<=19999))}function formatFilter(n){return JSON.stringify(n,null,2).split(`
`).map((t,r)=>r===0?t:`   ${t}`).join(`
`)}function fetchingEvents(n,e,t,r,s){if(s(),e?.cacheUsage==="ONLY_CACHE")return;const i=Array.isArray(n)?n:[n],a=i.map(formatFilter).join(`

   ---

   `);if(isNip33Pattern(n))i[0],t("fetch-events-usage",`For fetching a NIP-33 addressable event, use fetchEvent() with the naddr directly.

 Your filter:
   `+a+`

   BAD:  const decoded = nip19.decode(naddr);
           const events = await ndk.fetchEvents({
             kinds: [decoded.data.kind],
             authors: [decoded.data.pubkey],
             "#d": [decoded.data.identifier]
           });
           const event = Array.from(events)[0];

   GOOD: const event = await ndk.fetchEvent(naddr);
   GOOD: const event = await ndk.fetchEvent('naddr1...');

fetchEvent() handles naddr decoding automatically and returns the event directly.`);else{if(isReplaceableEventFilter(n))return;{if(!r())return;let u="";const l=i.some(v=>v.limit!==void 0),p=new Set(i.flatMap(v=>v.kinds||[])).size,g=new Set(i.flatMap(v=>v.authors||[])).size;if(l){const v=Math.max(...i.map(m=>m.limit||0));u+=`
    Limit: ${v} event${v!==1?"s":""}`}p>0&&(u+=`
    Kinds: ${p} type${p!==1?"s":""}`),g>0&&(u+=`
    Authors: ${g} author${g!==1?"s":""}`),t("fetch-events-usage",`fetchEvents() is a BLOCKING operation that waits for EOSE.
In most cases, you should use subscribe() instead.

 Your filter`+(i.length>1?"s":"")+`:
   `+a+(u?`

 Filter analysis:`+u:"")+`

   BAD:  const events = await ndk.fetchEvents(filter);
   GOOD: ndk.subscribe(filter, { onEvent: (e) => ... });

Only use fetchEvents() when you MUST block until data arrives.`,"For one-time queries, use fetchEvent() instead of fetchEvents() when expecting a single result.")}}}var GuardrailCheckId={NDK_NO_CACHE:"ndk-no-cache",FILTER_BECH32_IN_ARRAY:"filter-bech32-in-array",FILTER_INVALID_HEX:"filter-invalid-hex",FILTER_ONLY_LIMIT:"filter-only-limit",FILTER_EMPTY:"filter-empty",FILTER_SINCE_AFTER_UNTIL:"filter-since-after-until",FILTER_INVALID_A_TAG:"filter-invalid-a-tag",FILTER_HASHTAG_WITH_PREFIX:"filter-hashtag-with-prefix"};function checkCachePresence(n,e){e(GuardrailCheckId.NDK_NO_CACHE)&&setTimeout(()=>{if(!n.cacheAdapter){const s=`
 AI_GUARDRAILS WARNING: NDK initialized without a cache adapter. Apps perform significantly better with caching.

 ${typeof window<"u"?"Consider using @nostr-dev-kit/ndk-cache-dexie or @nostr-dev-kit/ndk-cache-sqlite-wasm":"Consider using @nostr-dev-kit/ndk-cache-redis or @nostr-dev-kit/ndk-cache-sqlite"}

 To disable this check:
   ndk.aiGuardrails.skip('${GuardrailCheckId.NDK_NO_CACHE}')
   or set: ndk.aiGuardrails = { skip: new Set(['${GuardrailCheckId.NDK_NO_CACHE}']) }`;console.warn(s)}},2500)}var AIGuardrails=class{enabled=!1;skipSet=new Set;extensions=new Map;_nextCallDisabled=null;_replyEvents=new WeakSet;_fetchEventsCount=0;_subscribeCount=0;constructor(n=!1){this.setMode(n)}register(n,e){this.extensions.has(n)&&console.warn(`AIGuardrails: Extension '${n}' already registered, overwriting`);const t={};for(const[r,s]of Object.entries(e))typeof s=="function"&&(t[r]=(...i)=>{this.enabled&&s(...i,this.shouldCheck.bind(this),this.error.bind(this),this.warn.bind(this))});this.extensions.set(n,t),this[n]=t}setMode(n){typeof n=="boolean"?(this.enabled=n,this.skipSet.clear()):n&&typeof n=="object"&&(this.enabled=!0,this.skipSet=n.skip||new Set)}isEnabled(){return this.enabled}shouldCheck(n){return!(!this.enabled||this.skipSet.has(n)||this._nextCallDisabled==="all"||this._nextCallDisabled&&this._nextCallDisabled.has(n))}skip(n){this.skipSet.add(n)}enable(n){this.skipSet.delete(n)}getSkipped(){return Array.from(this.skipSet)}captureAndClearNextCallDisabled(){const n=this._nextCallDisabled;return this._nextCallDisabled=null,n}incrementFetchEventsCount(){this._fetchEventsCount++}incrementSubscribeCount(){this._subscribeCount++}shouldWarnAboutFetchEventsRatio(){const n=this._fetchEventsCount+this._subscribeCount;return n<=6?!1:this._fetchEventsCount/n>.5}error(n,e,t,r=!0){if(!this.shouldCheck(n))return;const s=this.formatMessage(n,"ERROR",e,t,r);throw console.error(s),new Error(s)}warn(n,e,t){if(!this.shouldCheck(n))return;const r=this.formatMessage(n,"WARNING",e,t,!0);throw console.error(r),new Error(r)}formatMessage(n,e,t,r,s=!0){let i=`
 AI_GUARDRAILS ${e}: ${t}`;return r&&(i+=`

 ${r}`),s&&(i+=`

 To disable this check:
   ndk.guardrailOff('${n}').yourMethod()  // For one call`,i+=`
   ndk.aiGuardrails.skip('${n}')  // Permanently`,i+=`
   or set: ndk.aiGuardrails = { skip: new Set(['${n}']) }`),i}ndkInstantiated(n){this.enabled&&checkCachePresence(n,this.shouldCheck.bind(this))}ndk={fetchingEvents:(n,e)=>{this.enabled&&fetchingEvents(n,e,this.warn.bind(this),this.shouldWarnAboutFetchEventsRatio.bind(this),this.incrementFetchEventsCount.bind(this))}};event={signing:n=>{this.enabled&&signing(n,this.error.bind(this),this.warn.bind(this),this._replyEvents)},publishing:n=>{this.enabled&&publishing(n,this.warn.bind(this))},received:(n,e)=>{this.enabled},creatingReply:n=>{this.enabled&&this._replyEvents.add(n)}};subscription={created:(n,e)=>{this.enabled&&this.incrementSubscribeCount()}};relay={connected:n=>{this.enabled}}};function processFilters(n,e="validate",t,r){if(e==="ignore")return n;const s=[],i=n.map((a,u)=>(r?.aiGuardrails.isEnabled()&&runAIGuardrailsForFilter(a,u,r),processFilter(a,e,u,s,t)));if(e==="validate"&&s.length>0)throw new Error(`Invalid filter(s) detected:
${s.join(`
`)}`);return i}function processFilter(n,e,t,r,s){const i=e==="validate",a=i?n:{...n};if(n.ids){const u=[];n.ids.forEach((l,p)=>{l===void 0?i?r.push(`Filter[${t}].ids[${p}] is undefined`):s?.(`Fixed: Removed undefined value at ids[${p}]`):typeof l!="string"?i?r.push(`Filter[${t}].ids[${p}] is not a string (got ${typeof l})`):s?.(`Fixed: Removed non-string value at ids[${p}] (was ${typeof l})`):isValidHex64(l)?u.push(l):i?r.push(`Filter[${t}].ids[${p}] is not a valid 64-char hex string: "${l}"`):s?.(`Fixed: Removed invalid hex string at ids[${p}]`)}),i||(a.ids=u.length>0?u:void 0)}if(n.authors){const u=[];n.authors.forEach((l,p)=>{l===void 0?i?r.push(`Filter[${t}].authors[${p}] is undefined`):s?.(`Fixed: Removed undefined value at authors[${p}]`):typeof l!="string"?i?r.push(`Filter[${t}].authors[${p}] is not a string (got ${typeof l})`):s?.(`Fixed: Removed non-string value at authors[${p}] (was ${typeof l})`):isValidHex64(l)?u.push(l):i?r.push(`Filter[${t}].authors[${p}] is not a valid 64-char hex pubkey: "${l}"`):s?.(`Fixed: Removed invalid hex pubkey at authors[${p}]`)}),i||(a.authors=u.length>0?u:void 0)}if(n.kinds){const u=[];n.kinds.forEach((l,p)=>{l===void 0?i?r.push(`Filter[${t}].kinds[${p}] is undefined`):s?.(`Fixed: Removed undefined value at kinds[${p}]`):typeof l!="number"?i?r.push(`Filter[${t}].kinds[${p}] is not a number (got ${typeof l})`):s?.(`Fixed: Removed non-number value at kinds[${p}] (was ${typeof l})`):Number.isInteger(l)?l<0||l>65535?i?r.push(`Filter[${t}].kinds[${p}] is out of valid range (0-65535): ${l}`):s?.(`Fixed: Removed out-of-range kind at kinds[${p}]: ${l}`):u.push(l):i?r.push(`Filter[${t}].kinds[${p}] is not an integer: ${l}`):s?.(`Fixed: Removed non-integer value at kinds[${p}]: ${l}`)}),i||(a.kinds=u.length>0?u:void 0)}for(const u in n)if(u.startsWith("#")&&u.length===2){const l=n[u];if(Array.isArray(l)){const p=[];l.forEach((g,v)=>{g===void 0?i?r.push(`Filter[${t}].${u}[${v}] is undefined`):s?.(`Fixed: Removed undefined value at ${u}[${v}]`):typeof g!="string"?i?r.push(`Filter[${t}].${u}[${v}] is not a string (got ${typeof g})`):s?.(`Fixed: Removed non-string value at ${u}[${v}] (was ${typeof g})`):(u==="#e"||u==="#p")&&!isValidHex64(g)?i?r.push(`Filter[${t}].${u}[${v}] is not a valid 64-char hex string: "${g}"`):s?.(`Fixed: Removed invalid hex string at ${u}[${v}]`):p.push(g)}),i||(a[u]=p.length>0?p:void 0)}}return i||Object.keys(a).forEach(u=>{a[u]===void 0&&delete a[u]}),a}function runAIGuardrailsForFilter(n,e,t){const r=t.aiGuardrails,s=JSON.stringify(n,null,2);if(Object.keys(n).length===1&&n.limit!==void 0&&r.error(GuardrailCheckId.FILTER_ONLY_LIMIT,`Filter[${e}] contains only 'limit' without any filtering criteria.

 Your filter:
${s}

  This will fetch random events from relays without any criteria.`,`Add filtering criteria:
    { kinds: [1], limit: 10 }
    { authors: [pubkey], limit: 10 }
    { limit: 10 }`),Object.keys(n).length===0&&r.error(GuardrailCheckId.FILTER_EMPTY,`Filter[${e}] is empty.

 Your filter:
${s}

  This will request ALL events from relays, which is never what you want.`,"Add filtering criteria like 'kinds', 'authors', or tags.",!1),n.since!==void 0&&n.until!==void 0&&n.since>n.until){const a=new Date(n.since*1e3).toISOString(),u=new Date(n.until*1e3).toISOString();r.error(GuardrailCheckId.FILTER_SINCE_AFTER_UNTIL,`Filter[${e}] has 'since' AFTER 'until'.

 Your filter:
${s}

 since: ${n.since} (${a})
 until: ${n.until} (${u})

No events can match this time range!`,"'since' must be BEFORE 'until'. Both are Unix timestamps in seconds.",!1)}const i=/^n(addr|event|ote|pub|profile)1/;n.ids&&n.ids.forEach((a,u)=>{typeof a=="string"&&(i.test(a)?r.error(GuardrailCheckId.FILTER_BECH32_IN_ARRAY,`Filter[${e}].ids[${u}] contains bech32: "${a}". IDs must be hex, not bech32.`,'Use filterFromId() to decode bech32 first: import { filterFromId } from "@nostr-dev-kit/ndk"',!1):isValidHex64(a)||r.error(GuardrailCheckId.FILTER_INVALID_HEX,`Filter[${e}].ids[${u}] is not a valid 64-char hex string: "${a}"`,`Event IDs must be 64-character hexadecimal strings. Invalid IDs often come from corrupted data in user-generated lists. Always validate hex strings before using them in filters:

   const validIds = ids.filter(id => /^[0-9a-f]{64}$/i.test(id));`,!1))}),n.authors&&n.authors.forEach((a,u)=>{typeof a=="string"&&(i.test(a)?r.error(GuardrailCheckId.FILTER_BECH32_IN_ARRAY,`Filter[${e}].authors[${u}] contains bech32: "${a}". Authors must be hex pubkeys, not npub.`,"Use ndkUser.pubkey instead. Example: { authors: [ndkUser.pubkey] }",!1):isValidHex64(a)||r.error(GuardrailCheckId.FILTER_INVALID_HEX,`Filter[${e}].authors[${u}] is not a valid 64-char hex pubkey: "${a}"`,`Kind:3 follow lists can contain invalid entries like labels ("Follow List"), partial strings ("highlig"), or other corrupted data. You MUST validate all pubkeys before using them in filters.

   Example:
   const validPubkeys = pubkeys.filter(p => /^[0-9a-f]{64}$/i.test(p));
   ndk.subscribe({ authors: validPubkeys, kinds: [1] });`,!1))});for(const a in n)if(a.startsWith("#")&&a.length===2){const u=n[a];Array.isArray(u)&&u.forEach((l,p)=>{typeof l=="string"&&(a==="#e"||a==="#p")&&(i.test(l)?r.error(GuardrailCheckId.FILTER_BECH32_IN_ARRAY,`Filter[${e}].${a}[${p}] contains bech32: "${l}". Tag values must be decoded.`,"Use filterFromId() or nip19.decode() to get the hex value first.",!1):isValidHex64(l)||r.error(GuardrailCheckId.FILTER_INVALID_HEX,`Filter[${e}].${a}[${p}] is not a valid 64-char hex string: "${l}"`,`${a==="#e"?"Event IDs":"Public keys"} in tag filters must be 64-character hexadecimal strings. Kind:3 follow lists and other user-generated content can contain invalid data. Always filter before using:

   const validValues = values.filter(v => /^[0-9a-f]{64}$/i.test(v));`,!1))})}n["#a"]&&n["#a"]?.forEach((u,l)=>{if(typeof u=="string")if(!/^\d+:[0-9a-f]{64}:.*$/.test(u))r.error(GuardrailCheckId.FILTER_INVALID_A_TAG,`Filter[${e}].#a[${l}] has invalid format: "${u}". Must be "kind:pubkey:d-tag".`,'Example: "30023:fa984bd7dbb282f07e16e7ae87b26a2a7b9b90b7246a44771f0cf5ae58018f52:my-article"',!1);else{const p=Number.parseInt(u.split(":")[0],10);(p<3e4||p>39999)&&r.error(GuardrailCheckId.FILTER_INVALID_A_TAG,`Filter[${e}].#a[${l}] uses non-addressable kind ${p}: "${u}". #a filters are only for addressable events (kinds 30000-39999).`,`Addressable events include:
    30000-30039: Parameterized Replaceable Events (profiles, settings, etc.)
    30040-39999: Other addressable events

For regular events (kind ${p}), use:
    #e filter for specific event IDs
    kinds + authors filters for event queries`,!1)}}),n["#t"]&&n["#t"]?.forEach((u,l)=>{typeof u=="string"&&u.startsWith("#")&&r.error(GuardrailCheckId.FILTER_HASHTAG_WITH_PREFIX,`Filter[${e}].#t[${l}] contains hashtag with # prefix: "${u}". Hashtag values should NOT include the # symbol.`,`Remove the # prefix from hashtag filters:
    { "#t": ["nostr"] }
    { "#t": ["#nostr"] }`,!1)})}function queryFullyFilled(n){return!!(filterIncludesIds(n.filter)&&resultHasAllRequestedIds(n))}function filterIncludesIds(n){return!!n.ids}function resultHasAllRequestedIds(n){const e=n.filter.ids;return!!e&&e.length===n.eventFirstSeen.size}function filterFromId(n){let e;if(n.match(NIP33_A_REGEX)){const[t,r,s]=n.split(":"),i={authors:[r],kinds:[Number.parseInt(t)]};return s&&(i["#d"]=[s]),i}if(n.match(BECH32_REGEX))try{switch(e=nip19_exports$2.decode(n),e.type){case"nevent":{const t={ids:[e.data.id]};return e.data.author&&(t.authors=[e.data.author]),e.data.kind&&(t.kinds=[e.data.kind]),t}case"note":return{ids:[e.data]};case"naddr":{const t={authors:[e.data.pubkey],kinds:[e.data.kind]};return e.data.identifier&&(t["#d"]=[e.data.identifier]),t}}}catch(t){console.error("Error decoding",n,t)}return{ids:[n]}}function isNip33AValue(n){return n.match(NIP33_A_REGEX)!==null}var NIP33_A_REGEX=/^(\d+):([0-9A-Fa-f]+)(?::(.*))?$/,BECH32_REGEX=/^n(event|ote|profile|pub|addr)1[\d\w]+$/;function relaysFromBech32(n,e){try{const t=nip19_exports$2.decode(n);if(["naddr","nevent"].includes(t?.type)){const r=t.data;if(r?.relays)return r.relays.map(s=>new NDKRelay$1(s,e.relayAuthDefaultPolicy,e))}}catch{}return[]}var defaultOpts={closeOnEose:!1,cacheUsage:"CACHE_FIRST",dontSaveToCache:!1,groupable:!0,groupableDelay:100,groupableDelayType:"at-most",cacheUnconstrainFilter:["limit","since","until"],includeMuted:!1},NDKSubscription=class extends lib$1.EventEmitter{subId;filters;opts;pool;skipVerification=!1;skipValidation=!1;exclusiveRelay=!1;relayFilters;relaySet;ndk;debug;eventFirstSeen=new Map;eosesSeen=new Set;lastEventReceivedAt;mostRecentCacheEventTimestamp;internalId;closeOnEose;poolMonitor;skipOptimisticPublishEvent=!1;cacheUnconstrainFilter;constructor(n,e,t,r){super(),this.ndk=n,this.opts={...defaultOpts,...t||{}},this.pool=this.opts.pool||n.pool;const s=Array.isArray(e)?e:[e],i=n.filterValidationMode==="validate"?"validate":n.filterValidationMode==="fix"?"fix":"ignore";if(this.filters=processFilters(s,i,n.debug,n),this.filters.length===0)throw new Error("Subscription must have at least one filter");this.subId=r||this.opts.subId,this.internalId=Math.random().toString(36).substring(7),this.debug=n.debug.extend(`subscription[${this.opts.subId??this.internalId}]`),this.opts.relaySet?this.relaySet=this.opts.relaySet:this.opts.relayUrls&&(this.relaySet=NDKRelaySet$1.fromRelayUrls(this.opts.relayUrls,this.ndk)),this.skipVerification=this.opts.skipVerification||!1,this.skipValidation=this.opts.skipValidation||!1,this.closeOnEose=this.opts.closeOnEose||!1,this.skipOptimisticPublishEvent=this.opts.skipOptimisticPublishEvent||!1,this.cacheUnconstrainFilter=this.opts.cacheUnconstrainFilter,this.exclusiveRelay=this.opts.exclusiveRelay||!1,this.opts.onEvent&&this.on("event",this.opts.onEvent),this.opts.onEose&&this.on("eose",this.opts.onEose),this.opts.onClose&&this.on("close",this.opts.onClose)}relaysMissingEose(){return this.relayFilters?Array.from(this.relayFilters?.keys()).filter(e=>!this.eosesSeen.has(this.pool.getRelay(e,!1,!1))):[]}get filter(){return this.filters[0]}get groupableDelay(){if(this.isGroupable())return this.opts?.groupableDelay}get groupableDelayType(){return this.opts?.groupableDelayType||"at-most"}isGroupable(){return this.opts?.groupable||!1}shouldQueryCache(){return this.opts.addSinceFromCache?!0:this.opts?.cacheUsage==="ONLY_RELAY"?!1:(this.filters.some(e=>e.kinds?.some(t=>kindIsEphemeral(t))),!0)}shouldQueryRelays(){return this.opts?.cacheUsage!=="ONLY_CACHE"}shouldWaitForCache(){return this.opts.addSinceFromCache?!0:!!this.opts.closeOnEose&&!!this.ndk.cacheAdapter?.locking&&this.opts.cacheUsage!=="PARALLEL"}start(n=!0){let e;const t=s=>{for(const i of s)i.created_at&&(!this.mostRecentCacheEventTimestamp||i.created_at>this.mostRecentCacheEventTimestamp)&&(this.mostRecentCacheEventTimestamp=i.created_at),this.eventReceived(i,void 0,!0,!1);n||(e=s)},r=()=>{this.shouldQueryRelays()?(this.startWithRelays(),this.startPoolMonitor()):this.emit("eose",this)};return this.shouldQueryCache()?(e=this.startWithCache(),e instanceof Promise?this.shouldWaitForCache()?(e.then(s=>{if(t(s),queryFullyFilled(this)){this.emit("eose",this);return}r()}),null):(e.then(s=>{t(s),this.shouldQueryRelays()||this.emit("eose",this)}),this.shouldQueryRelays()&&r(),null):(t(e),queryFullyFilled(this)?this.emit("eose",this):r(),e)):(r(),null)}startPoolMonitor(){this.debug.extend("pool-monitor"),this.poolMonitor=n=>{if(this.relayFilters?.has(n.url))return;calculateRelaySetsFromFilters(this.ndk,this.filters,this.pool,this.opts.relayGoalPerAuthor).get(n.url)&&(this.relayFilters?.set(n.url,this.filters),n.subscribe(this,this.filters))},this.pool.on("relay:connect",this.poolMonitor)}onStopped;stop(){this.emit("close",this),this.poolMonitor&&this.pool.off("relay:connect",this.poolMonitor),this.onStopped?.()}hasAuthorsFilter(){return this.filters.some(n=>n.authors?.length)}startWithCache(){return this.ndk.cacheAdapter?.query?this.ndk.cacheAdapter.query(this):[]}startWithRelays(){let n=this.filters;if(this.opts.addSinceFromCache&&this.mostRecentCacheEventTimestamp){const e=this.mostRecentCacheEventTimestamp+1;n=n.map(t=>({...t,since:Math.max(t.since||0,e)}))}if(!this.relaySet||this.relaySet.relays.size===0)this.relayFilters=calculateRelaySetsFromFilters(this.ndk,n,this.pool,this.opts.relayGoalPerAuthor);else{this.relayFilters=new Map;for(const e of this.relaySet.relays)this.relayFilters.set(e.url,n)}for(const[e,t]of this.relayFilters)this.pool.getRelay(e,!0,!0,t).subscribe(this,t)}refreshRelayConnections(){if(this.relaySet&&this.relaySet.relays.size>0)return;const n=calculateRelaySetsFromFilters(this.ndk,this.filters,this.pool,this.opts.relayGoalPerAuthor);for(const[e,t]of n)this.relayFilters?.has(e)||(this.relayFilters?.set(e,t),this.pool.getRelay(e,!0,!0,t).subscribe(this,t))}eventReceived(n,e,t=!1,r=!1){const s=n.id,i=this.eventFirstSeen.has(s);let a;if(n instanceof NDKEvent$1&&(a=n),i){const u=Date.now()-(this.eventFirstSeen.get(s)||0);if(this.emit("event:dup",n,e,u,this,t,r),this.opts?.onEventDup&&this.opts.onEventDup(n,e,u,this,t,r),!t&&!r&&e&&this.ndk.cacheAdapter?.setEventDup&&!this.opts.dontSaveToCache&&(a??=n instanceof NDKEvent$1?n:new NDKEvent$1(this.ndk,n),this.ndk.cacheAdapter.setEventDup(a,e)),e){const l=verifiedSignatures$1.get(s);if(l&&typeof l=="string")if(n.sig===l)e.addValidatedEvent();else{const p=n instanceof NDKEvent$1?n:new NDKEvent$1(this.ndk,n);this.ndk.reportInvalidSignature(p,e)}}}else{if(a??=new NDKEvent$1(this.ndk,n),a.ndk=this.ndk,a.relay=e,!t&&!r){if(!this.skipValidation&&!a.isValid){this.debug("Event failed validation %s from relay %s",s,e?.url);return}if(e)if(e.shouldValidateEvent()&&!this.skipVerification)if(a.relay=e,this.ndk.asyncSigVerification)a.verifySignature(!0);else{if(!a.verifySignature(!0)){this.debug("Event failed signature validation",n),this.ndk.reportInvalidSignature(a,e);return}e.addValidatedEvent()}else e.addNonValidatedEvent();this.ndk.cacheAdapter&&!this.opts.dontSaveToCache&&this.ndk.cacheAdapter.setEvent(a,this.filters,e)}if(!this.opts.includeMuted&&this.ndk.muteFilter&&this.ndk.muteFilter(a)){this.debug("Event muted, skipping");return}(!r||this.skipOptimisticPublishEvent!==!0)&&(this.emitEvent(this.opts?.wrap??!1,a,e,t,r),this.eventFirstSeen.set(s,Date.now()))}this.lastEventReceivedAt=Date.now()}emitEvent(n,e,t,r,s){const i=n?wrapEvent(e):e;i instanceof Promise?i.then(a=>this.emitEvent(!1,a,t,r,s)):i&&this.emit("event",i,t,this,r,s)}closedReceived(n,e){this.emit("closed",n,e)}eoseTimeout;eosed=!1;eoseReceived(n){this.debug("EOSE received from %s",n.url),this.eosesSeen.add(n);let e=this.lastEventReceivedAt?Date.now()-this.lastEventReceivedAt:void 0;const t=this.eosesSeen.size===this.relayFilters?.size,r=queryFullyFilled(this),s=i=>{this.debug("Performing EOSE: %s %d",i,this.eosed),!this.eosed&&(this.eoseTimeout&&clearTimeout(this.eoseTimeout),this.emit("eose",this),this.eosed=!0,this.opts?.closeOnEose&&this.stop())};if(r||t)s("query filled or seen all");else if(this.relayFilters){let i=1e3;const a=new Set(this.pool.connectedRelays().map(p=>p.url)),u=Array.from(this.relayFilters.keys()).filter(p=>a.has(p));if(u.length===0){this.debug("No connected relays, waiting for all relays to connect",Array.from(this.relayFilters.keys()).join(", "));return}const l=this.eosesSeen.size/u.length;if(this.debug("Percentage of relays that have sent EOSE",{subId:this.subId,percentageOfRelaysThatHaveSentEose:l,seen:this.eosesSeen.size,total:u.length}),this.eosesSeen.size>=2&&l>=.5){if(i=i*(1-l),i===0){s("time to wait was 0");return}this.eoseTimeout&&clearTimeout(this.eoseTimeout);const p=()=>{e=this.lastEventReceivedAt?Date.now()-this.lastEventReceivedAt:void 0,e!==void 0&&e<20?this.eoseTimeout=setTimeout(p,i):s(`send eose timeout: ${i}`)};this.eoseTimeout=setTimeout(p,i)}}}},kindIsEphemeral=n=>n>=2e4&&n<3e4;async function follows$1(n,e,t=3){if(!this.ndk)throw new Error("NDK not set");const r=await this.ndk.fetchEvent({kinds:[t],authors:[this.pubkey]},n||{groupable:!1});if(r){const s=new Set;return r.tags.forEach(i=>{i[0]==="p"&&i[1]&&isValidPubkey(i[1])&&s.add(i[1])}),e&&this.ndk?.outboxTracker?.trackUsers(Array.from(s)),[...s].reduce((i,a)=>{const u=new NDKUser$1({pubkey:a});return u.ndk=this.ndk,i.add(u),i},new Set)}return new Set}var NIP05_REGEX$1=/^(?:([\w.+-]+)@)?([\w.-]+)$/;async function getNip05For$1(n,e,t=fetch,r={}){return await n.queuesNip05.add({id:e,func:async()=>{if(n.cacheAdapter?.loadNip05){const l=await n.cacheAdapter.loadNip05(e);if(l!=="missing"){if(l){const p=new NDKUser$1({pubkey:l.pubkey,relayUrls:l.relays,nip46Urls:l.nip46});return p.ndk=n,p}if(r.cache!=="no-cache")return null}}const s=e.match(NIP05_REGEX$1);if(!s)return null;const[i,a="_",u]=s;try{const l=await t(`https://${u}/.well-known/nostr.json?name=${a}`,r),{names:p,relays:g,nip46:v}=parseNIP05Result$1(await l.json()),m=p[a.toLowerCase()];let w=null;return m&&(w={pubkey:m,relays:g?.[m],nip46:v?.[m]}),n?.cacheAdapter?.saveNip05&&n.cacheAdapter.saveNip05(e,w),w}catch(l){return n?.cacheAdapter?.saveNip05&&n?.cacheAdapter.saveNip05(e,null),console.error("Failed to fetch NIP05 for",e,l),null}}})}function parseNIP05Result$1(n){const e={names:{}};for(const[t,r]of Object.entries(n.names))typeof t=="string"&&typeof r=="string"&&(e.names[t.toLowerCase()]=r);if(n.relays){e.relays={};for(const[t,r]of Object.entries(n.relays))typeof t=="string"&&Array.isArray(r)&&(e.relays[t]=r.filter(s=>typeof s=="string"))}if(n.nip46){e.nip46={};for(const[t,r]of Object.entries(n.nip46))typeof t=="string"&&Array.isArray(r)&&(e.nip46[t]=r.filter(s=>typeof s=="string"))}return e}function profileFromEvent$1(n){const e={};let t;try{t=JSON.parse(n.content)}catch(r){throw new Error(`Failed to parse profile event: ${r}`)}e.profileEvent=JSON.stringify(n.rawEvent());for(const r of Object.keys(t))switch(r){case"name":e.name=t.name;break;case"display_name":e.displayName=t.display_name;break;case"image":case"picture":e.picture=t.picture||t.image,e.image=e.picture;break;case"banner":e.banner=t.banner;break;case"bio":e.bio=t.bio;break;case"nip05":e.nip05=t.nip05;break;case"lud06":e.lud06=t.lud06;break;case"lud16":e.lud16=t.lud16;break;case"about":e.about=t.about;break;case"website":e.website=t.website;break;default:e[r]=t[r];break}return e.created_at=n.created_at,e}function serializeProfile$1(n){const e={};for(const[t,r]of Object.entries(n))switch(t){case"username":case"name":e.name=r;break;case"displayName":e.display_name=r;break;case"image":case"picture":e.picture=r;break;case"bio":case"about":e.about=r;break;default:e[t]=r;break}return JSON.stringify(e)}var NDKUser$1=class ds{ndk;profile;profileEvent;_npub;_pubkey;relayUrls=[];nip46Urls=[];constructor(e){if(e.npub&&(this._npub=e.npub),e.hexpubkey&&(this._pubkey=e.hexpubkey),e.pubkey&&(this._pubkey=e.pubkey),e.relayUrls&&(this.relayUrls=e.relayUrls),e.nip46Urls&&(this.nip46Urls=e.nip46Urls),e.nprofile)try{const t=nip19_exports$2.decode(e.nprofile);t.type==="nprofile"&&(this._pubkey=t.data.pubkey,t.data.relays&&t.data.relays.length>0&&this.relayUrls.push(...t.data.relays))}catch(t){console.error("Failed to decode nprofile",t)}}get npub(){if(!this._npub){if(!this._pubkey)throw new Error("pubkey not set");this._npub=nip19_exports$2.npubEncode(this.pubkey)}return this._npub}get nprofile(){const e=this.profileEvent?.onRelays?.map(t=>t.url);return nip19_exports$2.nprofileEncode({pubkey:this.pubkey,relays:e})}set npub(e){this._npub=e}get pubkey(){if(!this._pubkey){if(!this._npub)throw new Error("npub not set");this._pubkey=nip19_exports$2.decode(this.npub).data}return this._pubkey}set pubkey(e){this._pubkey=e}filter(){return{"#p":[this.pubkey]}}async getZapInfo(e){if(!this.ndk)throw new Error("No NDK instance found");const t=async a=>{if(!e)return a;let u;const l=new Promise((p,g)=>{u=setTimeout(()=>g(new Error("Timeout")),e)});try{const p=await Promise.race([a,l]);return u&&clearTimeout(u),p}catch(p){if(p instanceof Error&&p.message==="Timeout")try{return await a}catch{return}return}},[r,s]=await Promise.all([t(this.fetchProfile()),t(this.ndk.fetchEvent({kinds:[10019],authors:[this.pubkey]}))]),i=new Map;if(s){const a=NDKCashuMintList$1.from(s);a.mints.length>0&&i.set("nip61",{mints:a.mints,relays:a.relays,p2pk:a.p2pk})}if(r){const{lud06:a,lud16:u}=r;i.set("nip57",{lud06:a,lud16:u})}return i}static async fromNip05(e,t,r=!1){if(!t)throw new Error("No NDK instance found");const s={};r&&(s.cache="no-cache");const i=await getNip05For$1(t,e,t?.httpFetch,s);if(i){const a=new ds({pubkey:i.pubkey,relayUrls:i.relays,nip46Urls:i.nip46});return a.ndk=t,a}}async fetchProfile(e,t=!1){if(!this.ndk)throw new Error("NDK not set");let r=null;if(this.ndk.cacheAdapter&&(this.ndk.cacheAdapter.fetchProfile||this.ndk.cacheAdapter.fetchProfileSync)&&e?.cacheUsage!=="ONLY_RELAY"){let s=null;if(this.ndk.cacheAdapter.fetchProfileSync?s=this.ndk.cacheAdapter.fetchProfileSync(this.pubkey):this.ndk.cacheAdapter.fetchProfile&&(s=await this.ndk.cacheAdapter.fetchProfile(this.pubkey)),s)return this.profile=s,s}return e??={},e.cacheUsage??="ONLY_RELAY",e.closeOnEose??=!0,e.groupable??=!0,e.groupableDelay??=250,r||(r=await this.ndk.fetchEvent({kinds:[0],authors:[this.pubkey]},e)),r?(this.profile=profileFromEvent$1(r),t&&this.profile&&this.ndk.cacheAdapter&&this.ndk.cacheAdapter.saveProfile&&this.ndk.cacheAdapter.saveProfile(this.pubkey,this.profile),this.profile):null}follows=follows$1.bind(this);async followSet(e,t,r=3){const s=await this.follows(e,t,r);return new Set(Array.from(s).map(i=>i.pubkey))}tagReference(){return["p",this.pubkey]}referenceTags(e){const t=[["p",this.pubkey]];return e&&t[0].push("",e),t}async publish(){if(!this.ndk)throw new Error("No NDK instance found");if(!this.profile)throw new Error("No profile available");this.ndk.assertSigner(),await new NDKEvent$1(this.ndk,{kind:0,content:serializeProfile$1(this.profile)}).publish()}async follow(e,t,r=3){if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner(),t||(t=await this.follows(void 0,void 0,r));const s=typeof e=="string"?e:e.pubkey;if(Array.from(t).some(u=>typeof u=="string"?u===s:u.pubkey===s))return!1;t.add(e);const a=new NDKEvent$1(this.ndk,{kind:r});for(const u of t)typeof u=="string"?a.tags.push(["p",u]):a.tag(u);return await a.publish(),!0}async unfollow(e,t,r=3){if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner(),t||(t=await this.follows(void 0,void 0,r));const s=typeof e=="string"?e:e.pubkey,i=new Set;let a=!1;for(const l of t)(typeof l=="string"?l:l.pubkey)!==s?i.add(l):a=!0;if(!a)return!1;const u=new NDKEvent$1(this.ndk,{kind:r});for(const l of i)typeof l=="string"?u.tags.push(["p",l]):u.tag(l);return await u.publish()}async validateNip05(e){if(!this.ndk)throw new Error("No NDK instance found");const t=await getNip05For$1(this.ndk,e);return t===null?null:t.pubkey===this.pubkey}},signerRegistry$1=new Map;function registerSigner$1(n,e){signerRegistry$1.set(n,e)}var NDKPrivateKeySigner$1=class dn{_user;_privateKey;_pubkey;constructor(e,t){if(typeof e=="string")if(e.startsWith("nsec1")){const{type:r,data:s}=nip19_exports$2.decode(e);if(r==="nsec")this._privateKey=s;else throw new Error("Invalid private key provided.")}else if(e.length===64)this._privateKey=hexToBytes$1(e);else throw new Error("Invalid private key provided.");else this._privateKey=e;this._pubkey=getPublicKey(this._privateKey),t&&(this._user=t.getUser({pubkey:this._pubkey})),this._user??=new NDKUser$1({pubkey:this._pubkey})}get privateKey(){if(!this._privateKey)throw new Error("Not ready");return bytesToHex$1(this._privateKey)}get pubkey(){if(!this._pubkey)throw new Error("Not ready");return this._pubkey}get nsec(){if(!this._privateKey)throw new Error("Not ready");return nip19_exports$2.nsecEncode(this._privateKey)}get npub(){if(!this._pubkey)throw new Error("Not ready");return nip19_exports$2.npubEncode(this._pubkey)}encryptToNcryptsec(e,t=16,r=2){if(!this._privateKey)throw new Error("Private key not available");return encrypt$2(this._privateKey,e,t,r)}static generate(){const e=generateSecretKey();return new dn(e)}static fromNcryptsec(e,t,r){const s=decrypt$2(e,t);return new dn(s,r)}async blockUntilReady(){return this._user}async user(){return this._user}get userSync(){return this._user}async sign(e){if(!this._privateKey)throw Error("Attempted to sign without a private key");return finalizeEvent(e,this._privateKey).sig}async encryptionEnabled(e){const t=[];return(!e||e==="nip04")&&t.push("nip04"),(!e||e==="nip44")&&t.push("nip44"),t}async encrypt(e,t,r){if(!this._privateKey||!this.privateKey)throw Error("Attempted to encrypt without a private key");const s=e.pubkey;if(r==="nip44"){const i=nip44_exports.v2.utils.getConversationKey(this._privateKey,s);return await nip44_exports.v2.encrypt(t,i)}return await nip04_exports.encrypt(this._privateKey,s,t)}async decrypt(e,t,r){if(!this._privateKey||!this.privateKey)throw Error("Attempted to decrypt without a private key");const s=e.pubkey;if(r==="nip44"){const i=nip44_exports.v2.utils.getConversationKey(this._privateKey,s);return await nip44_exports.v2.decrypt(t,i)}return await nip04_exports.decrypt(this._privateKey,s,t)}toPayload(){if(!this._privateKey)throw new Error("Private key not available");const e={type:"private-key",payload:this.privateKey};return JSON.stringify(e)}static async fromPayload(e,t){const r=JSON.parse(e);if(r.type!=="private-key")throw new Error(`Invalid payload type: expected 'private-key', got ${r.type}`);if(!r.payload||typeof r.payload!="string")throw new Error("Invalid payload content for private-key signer");return new dn(r.payload,t)}};registerSigner$1("private-key",NDKPrivateKeySigner$1);function dedup(n,e){return n.created_at>e.created_at?n:e}async function getRelayListForUser(n,e){return(await getRelayListForUsers([n],e)).get(n)}async function getRelayListForUsers(n,e,t=!1,r=1e3,s){const i=e.outboxPool||e.pool,a=new Set;for(const m of i.relays.values())a.add(m);if(s)for(const m of s.values())for(const w of m){const T=i.getRelay(w,!0,!0);T&&a.add(T)}const u=new Map,l=new Map,p=new NDKRelaySet$1(a,e);if(e.cacheAdapter?.locking&&!t){const m=await e.fetchEvents({kinds:[3,10002],authors:Array.from(new Set(n))},{cacheUsage:"ONLY_CACHE",subId:"ndk-relay-list-fetch"});for(const w of m)w.kind===10002&&u.set(w.pubkey,NDKRelayList.from(w));for(const w of m)if(w.kind===3){if(u.has(w.pubkey))continue;const T=relayListFromKind3(e,w);T&&l.set(w.pubkey,T)}n=n.filter(w=>!u.has(w)&&!l.has(w))}if(n.length===0)return u;const g=new Map,v=new Map;return new Promise(m=>{let w=!1;(async()=>{const P={closeOnEose:!0,pool:i,groupable:!0,subId:"ndk-relay-list-fetch",addSinceFromCache:!0,relaySet:p};p&&(P.relaySet=p),e.subscribe({kinds:[3,10002],authors:n},P,{onEvent:ne=>{if(ne.kind===10002){const ye=g.get(ne.pubkey);if(ye&&ye.created_at>ne.created_at)return;g.set(ne.pubkey,ne)}else if(ne.kind===3){const ye=v.get(ne.pubkey);if(ye&&ye.created_at>ne.created_at)return;v.set(ne.pubkey,ne)}},onEose:()=>{if(!w){w=!0,e.debug(`[getRelayListForUsers] EOSE - relayListEvents: ${g.size}, contactListEvents: ${v.size}`);for(const ne of g.values())u.set(ne.pubkey,NDKRelayList.from(ne));for(const ne of n){if(u.has(ne))continue;const ye=v.get(ne);if(!ye)continue;const Se=relayListFromKind3(e,ye);Se&&u.set(ne,Se)}e.debug(`[getRelayListForUsers] Returning ${u.size} relay lists for ${n.length} pubkeys`),m(u)}}});const W=Array.from(a).some(ne=>ne.status<=2),X=Array.from(a).some(ne=>ne.status===4);let ke=r;(W||X)&&(ke=r+3e3),e.debug(`[getRelayListForUsers] Setting fallback timeout to ${ke}ms (disconnected: ${W}, connecting: ${X})`,{pubkeys:n}),setTimeout(()=>{w||(w=!0,e.debug(`[getRelayListForUsers] Timeout reached, returning ${u.size} relay lists`),m(u))},ke)})()})}var OutboxItem=class{type;relayUrlScores;readRelays;writeRelays;constructor(n){this.type=n,this.relayUrlScores=new Map,this.readRelays=new Set,this.writeRelays=new Set}},OutboxTracker=class extends lib$1.EventEmitter{data;ndk;debug;constructor(n){super(),this.ndk=n,this.debug=n.debug.extend("outbox-tracker"),this.data=new dist.LRUCache({maxSize:1e5,entryExpirationTimeInMS:2*60*1e3})}async trackUsers(n,e=!1){const t=[];for(let r=0;r<n.length;r+=400){const s=n.slice(r,r+400),i=s.map(u=>getKeyFromItem(u)).filter(u=>!this.data.has(u));if(i.length===0)continue;for(const u of i)this.data.set(u,new OutboxItem("user"));const a=new Map;for(const u of s)u instanceof NDKUser$1&&u.relayUrls.length>0&&a.set(u.pubkey,u.relayUrls);t.push(new Promise(u=>{getRelayListForUsers(i,this.ndk,e,1e3,a).then(l=>{this.debug(`Received relay lists for ${l.size} pubkeys out of ${i.length} requested`);for(const[p,g]of l){let v=this.data.get(p);if(v??=new OutboxItem("user"),g){if(v.readRelays=new Set(normalize(g.readRelayUrls)),v.writeRelays=new Set(normalize(g.writeRelayUrls)),this.ndk.relayConnectionFilter){for(const m of v.readRelays)this.ndk.relayConnectionFilter(m)||v.readRelays.delete(m);for(const m of v.writeRelays)this.ndk.relayConnectionFilter(m)||v.writeRelays.delete(m)}this.data.set(p,v),this.emit("user:relay-list-updated",p,v),this.debug(`Adding ${v.readRelays.size} read relays and ${v.writeRelays.size} write relays for ${p}`,g?.rawEvent())}}}).finally(u)}))}return Promise.all(t)}track(n,e,t=!0){const r=getKeyFromItem(n);e??=getTypeFromItem(n);let s=this.data.get(r);return s||(s=new OutboxItem(e),n instanceof NDKUser$1&&this.trackUsers([n])),s}};function getKeyFromItem(n){return n instanceof NDKUser$1?n.pubkey:n}function getTypeFromItem(n){return n instanceof NDKUser$1?"user":"kind"}function correctRelaySet(n,e){const t=e.connectedRelays();if(!Array.from(n.relays).some(s=>t.map(i=>i.url).includes(s.url)))for(const s of t)n.addRelay(s);if(t.length===0)for(const s of e.relays.values())n.addRelay(s);return n}var NDKSubscriptionManager=class{subscriptions;seenEvents=new dist.LRUCache({maxSize:1e4,entryExpirationTimeInMS:5*60*1e3});constructor(){this.subscriptions=new Map}add(n){this.subscriptions.set(n.internalId,n),n.onStopped,n.onStopped=()=>{this.subscriptions.delete(n.internalId)},n.on("close",()=>{this.subscriptions.delete(n.internalId)})}seenEvent(n,e){const t=this.seenEvents.get(n)||[];t.some(r=>r.url===e.url)||t.push(e),this.seenEvents.set(n,t)}dispatchEvent(n,e,t=!1){e&&this.seenEvent(n.id,e);const r=this.subscriptions.values(),s=[];for(const i of r)matchFilters(i.filters,n)&&s.push(i);for(const i of s){if(i.exclusiveRelay&&i.relaySet){let a=!1;if(t?a=!i.skipOptimisticPublishEvent:e?a=i.relaySet.relays.has(e):a=(this.seenEvents.get(n.id)||[]).some(l=>i.relaySet.relays.has(l)),!a){i.debug.extend("exclusive-relay")("Rejected event %s from %s (relay not in exclusive set)",n.id,e?.url||(t?"optimistic":"cache"));continue}}i.eventReceived(n,e,!1,t)}}},debug6=createDebug2("ndk:active-user");async function getUserRelayList(n){if(!this.autoConnectUserRelays)return;const e=await getRelayListForUser(n.pubkey,this);if(e){for(const t of e.relays){let r=this.pool.relays.get(t);r||(r=new NDKRelay$1(t,this.relayAuthDefaultPolicy,this),this.pool.addRelay(r))}return debug6("Connected to %d user relays",e.relays.length),e}}async function setActiveUser(n){if(!this.autoConnectUserRelays)return;const e=this.outboxPool||this.pool;e.connectedRelays.length>0?await getUserRelayList.call(this,n):e.once("connect",async()=>{await getUserRelayList.call(this,n)})}function getEntity(n){try{const e=nip19_exports$2.decode(n);return e.type==="npub"?npub(this,e.data):e.type==="nprofile"?nprofile(this,e.data):e}catch{return null}}function npub(n,e){return n.getUser({pubkey:e})}function nprofile(n,e){const t=n.getUser({pubkey:e.pubkey});return e.relays&&(t.relayUrls=e.relays),t}function isValidHint(n){if(!n||n==="")return!1;try{return new URL(n),!0}catch{return!1}}async function fetchEventFromTag(n,e,t,r={type:"timeout"}){const s=this.debug.extend("fetch-event-from-tag"),[i,a,u]=n;t={},s("fetching event from tag",n,t,r);const l=getRelaysForSync$1(this,e.pubkey);if(l&&l.size>0){s("fetching event from author relays %o",Array.from(l));const P=NDKRelaySet$1.fromRelayUrls(Array.from(l),this),W=await this.fetchEvent(a,t,P);if(W)return W}else s("no author relays found for %s",e.pubkey,e);const p=calculateRelaySetsFromFilters(this,[{ids:[a]}],this.pool);s("fetching event without relay hint",p);const g=await this.fetchEvent(a,t);if(g)return g;if(u&&u!==""){const P=await this.fetchEvent(a,t,this.pool.getRelay(u,!0,!0,[{ids:[a]}]));if(P)return P}let v;const m=isValidHint(u)?this.pool.getRelay(u,!1,!0,[{ids:[a]}]):void 0,w=new Promise(P=>{this.fetchEvent(a,t,m).then(P)});if(!isValidHint(u)||r.type==="none")return w;const T=new Promise(async P=>{const W=r.relaySet,X=r.timeout??1500,ke=new Promise(ne=>setTimeout(ne,X));if(r.type==="timeout"&&await ke,v)P(v);else{s("fallback fetch triggered");const ne=await this.fetchEvent(a,t,W);P(ne)}});switch(r.type){case"timeout":return Promise.race([w,T]);case"eose":return v=await w,v||T}}var Queue=class{queue=[];maxConcurrency;processing=new Set;promises=new Map;constructor(n,e){this.maxConcurrency=e}add(n){if(this.promises.has(n.id))return this.promises.get(n.id);const e=new Promise((t,r)=>{this.queue.push({...n,func:()=>n.func().then(s=>(t(s),s),s=>{throw r(s),s})}),this.process()});return this.promises.set(n.id,e),e.finally(()=>{this.promises.delete(n.id),this.processing.delete(n.id),this.process()}),e}process(){if(this.processing.size>=this.maxConcurrency||this.queue.length===0)return;const n=this.queue.shift();!n||this.processing.has(n.id)||(this.processing.add(n.id),n.func())}clear(){this.queue=[]}clearProcessing(){this.processing.clear()}clearAll(){this.clear(),this.clearProcessing()}length(){return this.queue.length}},DEFAULT_OUTBOX_RELAYS=["wss://purplepag.es/","wss://nos.lol/"],NDK=class extends lib$1.EventEmitter{_explicitRelayUrls;pool;outboxPool;_signer;_activeUser;cacheAdapter;debug;devWriteRelaySet;outboxTracker;muteFilter;relayConnectionFilter;clientName;clientNip89;queuesZapConfig;queuesNip05;asyncSigVerification=!1;initialValidationRatio=1;lowestValidationRatio=.1;validationRatioFn;filterValidationMode="validate";subManager;aiGuardrails;_signatureVerificationFunction;_signatureVerificationWorker;signatureVerificationTimeMs=0;publishingFailureHandled=!1;pools=[];relayAuthDefaultPolicy;httpFetch;netDebug;autoConnectUserRelays=!0;_wallet;walletConfig;constructor(n={}){super(),this.debug=n.debug||createDebug2("ndk"),this.netDebug=n.netDebug,this._explicitRelayUrls=n.explicitRelayUrls||[],this.subManager=new NDKSubscriptionManager,this.pool=new NDKPool$1(n.explicitRelayUrls||[],this),this.pool.name="Main",this.pool.on("relay:auth",async(e,t)=>{this.relayAuthDefaultPolicy&&await this.relayAuthDefaultPolicy(e,t)}),this.autoConnectUserRelays=n.autoConnectUserRelays??!0,this.clientName=n.clientName,this.clientNip89=n.clientNip89,this.relayAuthDefaultPolicy=n.relayAuthDefaultPolicy,n.enableOutboxModel!==!1&&(this.outboxPool=new NDKPool$1(n.outboxRelayUrls||DEFAULT_OUTBOX_RELAYS,this,{debug:this.debug.extend("outbox-pool"),name:"Outbox Pool"}),this.outboxTracker=new OutboxTracker(this),this.outboxTracker.on("user:relay-list-updated",(e,t)=>{this.debug(`Outbox relay list updated for ${e}`);for(const r of this.subManager.subscriptions.values())r.filters.some(i=>i.authors?.includes(e))&&typeof r.refreshRelayConnections=="function"&&(this.debug(`Refreshing relay connections for subscription ${r.internalId}`),r.refreshRelayConnections())})),this.signer=n.signer,this.cacheAdapter=n.cacheAdapter,this.muteFilter=n.muteFilter,this.relayConnectionFilter=n.relayConnectionFilter,n.devWriteRelayUrls&&(this.devWriteRelaySet=NDKRelaySet$1.fromRelayUrls(n.devWriteRelayUrls,this)),this.queuesZapConfig=new Queue("zaps",3),this.queuesNip05=new Queue("nip05",10),n.signatureVerificationWorker&&(this.signatureVerificationWorker=n.signatureVerificationWorker),n.signatureVerificationFunction&&(this.signatureVerificationFunction=n.signatureVerificationFunction),this.initialValidationRatio=n.initialValidationRatio||1,this.lowestValidationRatio=n.lowestValidationRatio||.1,this.validationRatioFn=n.validationRatioFn||this.defaultValidationRatioFn,this.filterValidationMode=n.filterValidationMode||"validate",this.aiGuardrails=new AIGuardrails(n.aiGuardrails||!1),this.aiGuardrails.ndkInstantiated(this);try{this.httpFetch=fetch}catch{}}set explicitRelayUrls(n){this._explicitRelayUrls=n.map(normalizeRelayUrl$1),this.pool.relayUrls=n}get explicitRelayUrls(){return this._explicitRelayUrls||[]}set signatureVerificationWorker(n){this._signatureVerificationWorker=n,n?(signatureVerificationInit(n),this.asyncSigVerification=!0):this.asyncSigVerification=!1}set signatureVerificationFunction(n){this._signatureVerificationFunction=n,this.asyncSigVerification=!!n}get signatureVerificationFunction(){return this._signatureVerificationFunction}addExplicitRelay(n,e,t=!0){let r;return typeof n=="string"?r=new NDKRelay$1(n,e,this):r=n,this.pool.addRelay(r,t),this.explicitRelayUrls?.push(r.url),r}toJSON(){return{relayCount:this.pool.relays.size}.toString()}get activeUser(){return this._activeUser}set activeUser(n){const e=this._activeUser?.pubkey!==n?.pubkey;this._activeUser=n,e&&this.emit("activeUser:change",n),n&&e&&setActiveUser.call(this,n)}get signer(){return this._signer}set signer(n){this._signer=n,n&&this.emit("signer:ready",n),n?.user().then(e=>{e.ndk=this,this.activeUser=e})}async connect(n){this._signer&&this.autoConnectUserRelays&&(this.debug("Attempting to connect to user relays specified by signer %o",await this._signer.relays?.(this)),this._signer.relays&&(await this._signer.relays(this)).forEach(r=>this.pool.addRelay(r)));const e=[this.pool.connect(n)];return this.outboxPool&&e.push(this.outboxPool.connect(n)),this.cacheAdapter?.initializeAsync&&e.push(this.cacheAdapter.initializeAsync(this)),Promise.allSettled(e).then(()=>{})}reportInvalidSignature(n,e){this.debug(`Invalid signature detected for event ${n.id}${e?` from relay ${e.url}`:""}`),this.emit("event:invalid-sig",n,e)}defaultValidationRatioFn(n,e,t){if(e<10)return this.initialValidationRatio;const r=Math.min(e/100,1),s=this.initialValidationRatio*(1-r)+this.lowestValidationRatio*r;return Math.max(s,this.lowestValidationRatio)}getUser(n){if(typeof n=="string")if(n.startsWith("npub1")){const{type:t,data:r}=nip19_exports$2.decode(n);if(t!=="npub")throw new Error(`Invalid npub: ${n}`);return this.getUser({pubkey:r})}else if(n.startsWith("nprofile1")){const{type:t,data:r}=nip19_exports$2.decode(n);if(t!=="nprofile")throw new Error(`Invalid nprofile: ${n}`);return this.getUser({pubkey:r.pubkey,relayUrls:r.relays})}else return this.getUser({pubkey:n});const e=new NDKUser$1(n);return e.ndk=this,e}async getUserFromNip05(n,e=!1){return NDKUser$1.fromNip05(n,this,e)}async fetchUser(n,e=!1){if(isValidNip05(n))return NDKUser$1.fromNip05(n,this,e);if(n.startsWith("npub1")){const{type:t,data:r}=nip19_exports$2.decode(n);if(t!=="npub")throw new Error(`Invalid npub: ${n}`);const s=new NDKUser$1({pubkey:r});return s.ndk=this,s}else if(n.startsWith("nprofile1")){const{type:t,data:r}=nip19_exports$2.decode(n);if(t!=="nprofile")throw new Error(`Invalid nprofile: ${n}`);const s=new NDKUser$1({pubkey:r.pubkey,relayUrls:r.relays});return s.ndk=this,s}else{const t=new NDKUser$1({pubkey:n});return t.ndk=this,t}}subscribe(n,e,t=!0,r=!0){let s=e?.relaySet,i=r;t instanceof NDKRelaySet$1?(console.warn("relaySet is deprecated, use opts.relaySet instead. This will be removed in version v2.14.0"),s=t,i=r):(typeof t=="boolean"||typeof t=="object")&&(i=t);let a;const u={relaySet:s,...e};i&&typeof i=="object"&&(i.onEvent&&(u.onEvent=i.onEvent),i.onEose&&(u.onEose=i.onEose),i.onClose&&(u.onClose=i.onClose),i.onEvents&&(a=i.onEvents));const l=new NDKSubscription(this,n,u);this.subManager.add(l),this.aiGuardrails?.subscription?.created(Array.isArray(n)?n:[n],u);const p=l.pool;if(l.relaySet)for(const g of l.relaySet.relays)p.useTemporaryRelay(g,void 0,l.filters);if(this.outboxPool&&l.hasAuthorsFilter()){const g=l.filters.filter(v=>v.authors&&v.authors?.length>0).flatMap(v=>v.authors);this.outboxTracker?.trackUsers(g)}return i&&setTimeout(async()=>{this.cacheAdapter?.initializeAsync&&!this.cacheAdapter.ready&&await this.cacheAdapter.initializeAsync(this);const g=l.start(!a);g&&g.length>0&&a&&a(g)},0),l}fetchEventFromTag=fetchEventFromTag.bind(this);fetchEventSync(n){if(!this.cacheAdapter)throw new Error("Cache adapter not set");let e;typeof n=="string"?e=[filterFromId(n)]:e=n;const t=new NDKSubscription(this,e),r=this.cacheAdapter.query(t);if(r instanceof Promise)throw new Error("Cache adapter is async");return r.map(s=>(s.ndk=this,s))}async fetchEvent(n,e,t){let r,s;if(t instanceof NDKRelay$1?s=new NDKRelaySet$1(new Set([t]),this):t instanceof NDKRelaySet$1&&(s=t),!t&&typeof n=="string"&&!isNip33AValue(n)){const i=relaysFromBech32(n,this);i.length>0&&(s=new NDKRelaySet$1(new Set(i),this),s=correctRelaySet(s,this.pool))}if(typeof n=="string"?r=[filterFromId(n)]:Array.isArray(n)?r=n:r=[n],typeof n!="string"&&this.aiGuardrails?.ndk?.fetchingEvents(r),r.length===0)throw new Error(`Invalid filter: ${JSON.stringify(n)}`);return new Promise((i,a)=>{let u=null;const l={...e||{},closeOnEose:!0};s&&(l.relaySet=s);const p=setTimeout(()=>{g.stop(),this.aiGuardrails._nextCallDisabled=null,i(u)},1e4),g=this.subscribe(r,l,{onEvent:v=>{v.ndk=this,v.isReplaceable()?(!u||u.created_at<v.created_at)&&(u=v):(clearTimeout(p),this.aiGuardrails._nextCallDisabled=null,i(v))},onEose:()=>{clearTimeout(p),this.aiGuardrails._nextCallDisabled=null,i(u)}})})}async fetchEvents(n,e,t){return this.aiGuardrails?.ndk?.fetchingEvents(n,e),new Promise(r=>{const s=new Map,i={...e||{},closeOnEose:!0};t&&(i.relaySet=t);const a=u=>{let l;u instanceof NDKEvent$1?l=u:l=new NDKEvent$1(void 0,u);const p=l.deduplicationKey(),g=s.get(p);g&&(l=dedup(g,l)),l.ndk=this,s.set(p,l)};this.subscribe(n,{...i,onEvent:a,onEose:()=>{this.aiGuardrails._nextCallDisabled=null,r(new Set(s.values()))}})})}assertSigner(){if(!this.signer)throw this.emit("signer:required"),new Error("Signer required")}getEntity=getEntity.bind(this);guardrailOff(n){return n?typeof n=="string"?this.aiGuardrails._nextCallDisabled=new Set([n]):this.aiGuardrails._nextCallDisabled=new Set(n):this.aiGuardrails._nextCallDisabled="all",this}set wallet(n){if(!n){this._wallet=void 0,this.walletConfig=void 0;return}this._wallet=n,this.walletConfig??={},this.walletConfig.lnPay=n?.lnPay?.bind(n),this.walletConfig.cashuPay=n?.cashuPay?.bind(n)}get wallet(){return this._wallet}},nip19_exports$1={};__reExport$1(nip19_exports$1,nip19_star);var nip49_exports={};__reExport$1(nip49_exports,nip49_star);function disconnect$1(n,e){return e??=createDebug2("ndk:relay:auth-policies:disconnect"),async t=>{e?.(`Relay ${t.url} requested authentication, disconnecting`),n.removeRelay(t.url)}}async function signAndAuth$1(n,e,t,r,s,i){try{await n.sign(t),s(n)}catch(a){r?.(`Failed to publish auth event to relay ${e.url}`,a),i(n)}}function signIn$1({ndk:n,signer:e,debug:t}={}){return t??=createDebug2("ndk:auth-policies:signIn"),async(r,s)=>{t?.(`Relay ${r.url} requested authentication, signing in`);const i=new NDKEvent$1(n);return i.kind=22242,i.tags=[["relay",r.url],["challenge",s]],e??=n?.signer,new Promise(async(a,u)=>{e?await signAndAuth$1(i,r,e,t,a,u):n?.once("signer:ready",async l=>{await signAndAuth$1(i,r,l,t,a,u)})})}}var NDKRelayAuthPolicies$1={disconnect:disconnect$1,signIn:signIn$1};async function ndkSignerFromPayload$1(n,e){let t;try{t=JSON.parse(n)}catch(s){console.error("Failed to parse signer payload string",n,s);return}if(!t||typeof t.type!="string"){console.error("Failed to parse signer payload string",n,new Error("Missing type field"));return}const r=signerRegistry$1.get(t.type);if(!r)throw new Error(`Unknown signer type: ${t.type}`);try{return await r.fromPayload(n,e)}catch(s){const i=s instanceof Error?s.message:String(s);throw new Error(`Failed to deserialize signer type ${t.type}: ${i}`)}}var NDKNip07Signer$1=class fs{_userPromise;encryptionQueue=[];encryptionProcessing=!1;debug;waitTimeout;_pubkey;ndk;_user;constructor(e=1e3,t){this.debug=createDebug2("ndk:nip07"),this.waitTimeout=e,this.ndk=t}get pubkey(){if(!this._pubkey)throw new Error("Not ready");return this._pubkey}async blockUntilReady(){await this.waitForExtension();const e=await window.nostr?.getPublicKey();if(!e)throw new Error("User rejected access");this._pubkey=e;let t;return this.ndk?t=this.ndk.getUser({pubkey:e}):t=new NDKUser$1({pubkey:e}),this._user=t,t}async user(){return this._userPromise||(this._userPromise=this.blockUntilReady()),this._userPromise}get userSync(){if(!this._user)throw new Error("User not ready");return this._user}async sign(e){await this.waitForExtension();const t=await window.nostr?.signEvent(e);if(!t)throw new Error("Failed to sign event");return t.sig}async relays(e){await this.waitForExtension();const t=await window.nostr?.getRelays?.()||{},r=[];for(const s of Object.keys(t))t[s].read&&t[s].write&&r.push(s);return r.map(s=>new NDKRelay$1(s,e?.relayAuthDefaultPolicy,e))}async encryptionEnabled(e){const t=[];return(!e||e==="nip04")&&window.nostr?.nip04&&t.push("nip04"),(!e||e==="nip44")&&window.nostr?.nip44&&t.push("nip44"),t}async encrypt(e,t,r="nip04"){if(!await this.encryptionEnabled(r))throw new Error(`${r}encryption is not available from your browser extension`);await this.waitForExtension();const s=e.pubkey;return this.queueEncryption(r,"encrypt",s,t)}async decrypt(e,t,r="nip04"){if(!await this.encryptionEnabled(r))throw new Error(`${r}encryption is not available from your browser extension`);await this.waitForExtension();const s=e.pubkey;return this.queueEncryption(r,"decrypt",s,t)}async queueEncryption(e,t,r,s){return new Promise((i,a)=>{this.encryptionQueue.push({scheme:e,method:t,counterpartyHexpubkey:r,value:s,resolve:i,reject:a}),this.encryptionProcessing||this.processEncryptionQueue()})}async processEncryptionQueue(e,t=0){if(!e&&this.encryptionQueue.length===0){this.encryptionProcessing=!1;return}this.encryptionProcessing=!0;const r=e||this.encryptionQueue.shift();if(!r){this.encryptionProcessing=!1;return}const{scheme:s,method:i,counterpartyHexpubkey:a,value:u,resolve:l,reject:p}=r;this.debug("Processing encryption queue item",{method:i,counterpartyHexpubkey:a,value:u});try{const g=await window.nostr?.[s]?.[i](a,u);if(!g)throw new Error("Failed to encrypt/decrypt");l(g)}catch(g){const v=g instanceof Error?g.message:String(g);if(v.includes("call already executing")&&t<5){this.debug("Retrying encryption queue item",{method:i,counterpartyHexpubkey:a,value:u,retries:t}),setTimeout(()=>{this.processEncryptionQueue(r,t+1)},50*t);return}p(g instanceof Error?g:new Error(v))}this.processEncryptionQueue()}waitForExtension(){return new Promise((e,t)=>{if(window.nostr){e();return}let r;const s=setInterval(()=>{window.nostr&&(clearTimeout(r),clearInterval(s),e())},100);r=setTimeout(()=>{clearInterval(s),t(new Error("NIP-07 extension not available"))},this.waitTimeout)})}toPayload(){return JSON.stringify({type:"nip07",payload:""})}static async fromPayload(e,t){const r=JSON.parse(e);if(r.type!=="nip07")throw new Error(`Invalid payload type: expected 'nip07', got ${r.type}`);return new fs(void 0,t)}};registerSigner$1("nip07",NDKNip07Signer$1);var NDKNostrRpc$1=class extends lib$1.EventEmitter{ndk;signer;relaySet;debug;encryptionType="nip04";pool;constructor(e,t,r,s){if(super(),this.ndk=e,this.signer=t,s){this.pool=new NDKPool$1(s,e,{debug:r.extend("rpc-pool"),name:"Nostr RPC"}),this.relaySet=new NDKRelaySet$1(new Set,e,this.pool);for(const i of s){const a=this.pool.getRelay(i,!1,!1);a.authPolicy=NDKRelayAuthPolicies$1.signIn({ndk:e,signer:t,debug:r}),this.relaySet.addRelay(a),a.connect()}}this.debug=r.extend("rpc")}subscribe(e){return new Promise(t=>{const r=this.ndk.subscribe(e,{closeOnEose:!1,groupable:!1,cacheUsage:"ONLY_RELAY",pool:this.pool,relaySet:this.relaySet,onEvent:async s=>{try{const i=await this.parseEvent(s);i.method?this.emit("request",i):(this.emit(`response-${i.id}`,i),this.emit("response",i))}catch(i){this.debug("error parsing event",i,s.rawEvent())}},onEose:()=>{this.debug("eosed"),t(r)}})})}async parseEvent(e){this.encryptionType==="nip44"&&e.content.includes("?iv=")?this.encryptionType="nip04":this.encryptionType==="nip04"&&!e.content.includes("?iv=")&&(this.encryptionType="nip44");const t=this.ndk.getUser({pubkey:e.pubkey});t.ndk=this.ndk;let r;try{r=await this.signer.decrypt(t,e.content,this.encryptionType)}catch{const v=this.encryptionType==="nip04"?"nip44":"nip04";r=await this.signer.decrypt(t,e.content,v),this.encryptionType=v}const s=JSON.parse(r),{id:i,method:a,params:u,result:l,error:p}=s;return a?{id:i,pubkey:e.pubkey,method:a,params:u,event:e}:{id:i,result:l,error:p,event:e}}async sendResponse(e,t,r,s=24133,i){const a={id:e,result:r};i&&(a.error=i);const u=await this.signer.user(),l=this.ndk.getUser({pubkey:t}),p=new NDKEvent$1(this.ndk,{kind:s,content:JSON.stringify(a),tags:[["p",t]],pubkey:u.pubkey});p.content=await this.signer.encrypt(l,p.content,this.encryptionType),await p.sign(this.signer),await p.publish(this.relaySet)}async sendRequest(e,t,r=[],s=24133,i){const a=Math.random().toString(36).substring(7),u=await this.signer.user(),l=this.ndk.getUser({pubkey:e}),p={id:a,method:t,params:r},g=new Promise(()=>{const m=w=>{w.result==="auth_url"?(this.once(`response-${a}`,m),this.emit("authUrl",w.error)):i&&i(w)};this.once(`response-${a}`,m)}),v=new NDKEvent$1(this.ndk,{kind:s,content:JSON.stringify(p),tags:[["p",e]],pubkey:u.pubkey});return v.content=await this.signer.encrypt(l,v.content,this.encryptionType),await v.sign(this.signer),await v.publish(this.relaySet),g}};function nostrConnectGenerateSecret$1(){return Math.random().toString(36).substring(2,15)}function generateNostrConnectUri$1(n,e,t,r){const s={name:r?.name?encodeURIComponent(r.name):"",url:r?.url?encodeURIComponent(r.url):"",image:r?.image?encodeURIComponent(r.image):"",perms:r?.perms?encodeURIComponent(r.perms):""};let i=`nostrconnect://${n}?image=${s.image}&url=${s.url}&name=${s.name}&perms=${s.perms}&secret=${encodeURIComponent(e)}`;return t&&(i+=`&relay=${encodeURIComponent(t)}`),i}var NDKNip46Signer$1=class fn extends lib$1.EventEmitter{ndk;_user;bunkerPubkey;userPubkey;get pubkey(){if(!this.userPubkey)throw new Error("Not ready");return this.userPubkey}secret;localSigner;nip05;rpc;debug;relayUrls;subscription;nostrConnectUri;nostrConnectSecret;constructor(e,t,r,s,i){super(),this.ndk=e,this.debug=e.debug.extend("nip46:signer"),this.relayUrls=s,r?typeof r=="string"?this.localSigner=new NDKPrivateKeySigner$1(r):this.localSigner=r:this.localSigner=NDKPrivateKeySigner$1.generate(),t===!1||(t?t.startsWith("bunker://")?this.bunkerFlowInit(t):this.nip05Init(t):this.nostrconnectFlowInit(i)),this.rpc=new NDKNostrRpc$1(this.ndk,this.localSigner,this.debug,this.relayUrls)}static bunker(e,t,r){return new fn(e,t,r)}static nostrconnect(e,t,r,s){return new fn(e,void 0,r,[t],s)}nostrconnectFlowInit(e){this.nostrConnectSecret=nostrConnectGenerateSecret$1();const t=this.localSigner.pubkey;this.nostrConnectUri=generateNostrConnectUri$1(t,this.nostrConnectSecret,this.relayUrls?.[0],e)}bunkerFlowInit(e){const t=new URL(e),r=t.hostname||t.pathname.replace(/^\/\//,""),s=t.searchParams.get("pubkey"),i=t.searchParams.getAll("relay"),a=t.searchParams.get("secret");this.bunkerPubkey=r,this.userPubkey=s,this.relayUrls=i,this.secret=a}nip05Init(e){this.nip05=e}async startListening(){if(this.subscription)return;const e=await this.localSigner.user();if(!e)throw new Error("Local signer not ready");this.subscription=await this.rpc.subscribe({kinds:[24133],"#p":[e.pubkey]})}async user(){return this._user?this._user:this.blockUntilReady()}get userSync(){if(!this._user)throw new Error("Remote user not ready synchronously");return this._user}async blockUntilReadyNostrConnect(){return new Promise((e,t)=>{const r=s=>{s.result===this.nostrConnectSecret&&(this._user=s.event.author,this.userPubkey=s.event.pubkey,this.bunkerPubkey=s.event.pubkey,this.rpc.off("response",r),e(this._user))};this.startListening(),this.rpc.on("response",r)})}async blockUntilReady(){if(!this.bunkerPubkey&&!this.nostrConnectSecret&&!this.nip05)throw new Error("Bunker pubkey not set");if(this.nostrConnectSecret)return this.blockUntilReadyNostrConnect();if(this.nip05&&!this.userPubkey){const e=await NDKUser$1.fromNip05(this.nip05,this.ndk);e&&(this._user=e,this.userPubkey=e.pubkey,this.relayUrls=e.nip46Urls,this.rpc=new NDKNostrRpc$1(this.ndk,this.localSigner,this.debug,this.relayUrls))}if(!this.bunkerPubkey&&this.userPubkey)this.bunkerPubkey=this.userPubkey;else if(!this.bunkerPubkey)throw new Error("Bunker pubkey not set");return await this.startListening(),this.rpc.on("authUrl",(...e)=>{this.emit("authUrl",...e)}),new Promise((e,t)=>{const r=[this.userPubkey??""];if(this.secret&&r.push(this.secret),!this.bunkerPubkey)throw new Error("Bunker pubkey not set");this.rpc.sendRequest(this.bunkerPubkey,"connect",r,24133,s=>{s.result==="ack"?this.getPublicKey().then(i=>{this.userPubkey=i,this._user=this.ndk.getUser({pubkey:i}),e(this._user)}):t(s.error)})})}stop(){this.subscription?.stop(),this.subscription=void 0}async getPublicKey(){return this.userPubkey?this.userPubkey:new Promise((e,t)=>{if(!this.bunkerPubkey)throw new Error("Bunker pubkey not set");this.rpc.sendRequest(this.bunkerPubkey,"get_public_key",[],24133,r=>{e(r.result)})})}async encryptionEnabled(e){return e?[e]:Promise.resolve(["nip04","nip44"])}async encrypt(e,t,r="nip04"){return this.encryption(e,t,r,"encrypt")}async decrypt(e,t,r="nip04"){return this.encryption(e,t,r,"decrypt")}async encryption(e,t,r,s){return new Promise((a,u)=>{if(!this.bunkerPubkey)throw new Error("Bunker pubkey not set");this.rpc.sendRequest(this.bunkerPubkey,`${r}_${s}`,[e.pubkey,t],24133,l=>{l.error?u(l.error):a(l.result)})})}async sign(e){return new Promise((r,s)=>{if(!this.bunkerPubkey)throw new Error("Bunker pubkey not set");this.rpc.sendRequest(this.bunkerPubkey,"sign_event",[JSON.stringify(e)],24133,i=>{if(i.error)s(i.error);else{const a=JSON.parse(i.result);r(a.sig)}})})}async createAccount(e,t,r){await this.startListening();const s=[];return e&&s.push(e),t&&s.push(t),r&&s.push(r),new Promise((i,a)=>{if(!this.bunkerPubkey)throw new Error("Bunker pubkey not set");this.rpc.sendRequest(this.bunkerPubkey,"create_account",s,24133,u=>{if(u.error)a(u.error);else{const l=u.result;i(l)}})})}toPayload(){if(!this.bunkerPubkey||!this.userPubkey)throw new Error("NIP-46 signer is not fully initialized for serialization");const e={type:"nip46",payload:{bunkerPubkey:this.bunkerPubkey,userPubkey:this.userPubkey,relayUrls:this.relayUrls,secret:this.secret,localSignerPayload:this.localSigner.toPayload(),nip05:this.nip05||null}};return JSON.stringify(e)}static async fromPayload(e,t){if(!t)throw new Error("NDK instance is required to deserialize NIP-46 signer");const r=JSON.parse(e);if(r.type!=="nip46")throw new Error(`Invalid payload type: expected 'nip46', got ${r.type}`);const s=r.payload;if(!s||typeof s!="object"||!s.localSignerPayload)throw new Error("Invalid payload content for nip46 signer");const i=await ndkSignerFromPayload$1(s.localSignerPayload,t);if(!i)throw new Error("Failed to deserialize local signer for NIP-46");if(!(i instanceof NDKPrivateKeySigner$1))throw new Error("Local signer must be an instance of NDKPrivateKeySigner");let a;return a=new fn(t,!1,i,s.relayUrls),a.userPubkey=s.userPubkey,a.bunkerPubkey=s.bunkerPubkey,a.relayUrls=s.relayUrls,a.secret=s.secret,s.userPubkey&&(a._user=new NDKUser$1({pubkey:s.userPubkey}),a._user&&(a._user.ndk=t)),a}};registerSigner$1("nip46",NDKNip46Signer$1);createDebug2("ndk:zapper:ln");createDebug2("ndk:zapper");const crypto$1=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */function isBytes(n){return n instanceof Uint8Array||ArrayBuffer.isView(n)&&n.constructor.name==="Uint8Array"}function anumber(n){if(!Number.isSafeInteger(n)||n<0)throw new Error("positive integer expected, got "+n)}function abytes(n,...e){if(!isBytes(n))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(n.length))throw new Error("Uint8Array expected of length "+e+", got length="+n.length)}function ahash(n){if(typeof n!="function"||typeof n.create!="function")throw new Error("Hash should be wrapped by utils.createHasher");anumber(n.outputLen),anumber(n.blockLen)}function aexists(n,e=!0){if(n.destroyed)throw new Error("Hash instance has been destroyed");if(e&&n.finished)throw new Error("Hash#digest() has already been called")}function aoutput(n,e){abytes(n);const t=e.outputLen;if(n.length<t)throw new Error("digestInto() expects output buffer of length at least "+t)}function clean(...n){for(let e=0;e<n.length;e++)n[e].fill(0)}function createView(n){return new DataView(n.buffer,n.byteOffset,n.byteLength)}function rotr(n,e){return n<<32-e|n>>>e}const hasHexBuiltin=typeof Uint8Array.from([]).toHex=="function"&&typeof Uint8Array.fromHex=="function",hexes=Array.from({length:256},(n,e)=>e.toString(16).padStart(2,"0"));function bytesToHex(n){if(abytes(n),hasHexBuiltin)return n.toHex();let e="";for(let t=0;t<n.length;t++)e+=hexes[n[t]];return e}const asciis={_0:48,_9:57,A:65,F:70,a:97,f:102};function asciiToBase16(n){if(n>=asciis._0&&n<=asciis._9)return n-asciis._0;if(n>=asciis.A&&n<=asciis.F)return n-(asciis.A-10);if(n>=asciis.a&&n<=asciis.f)return n-(asciis.a-10)}function hexToBytes(n){if(typeof n!="string")throw new Error("hex string expected, got "+typeof n);if(hasHexBuiltin)return Uint8Array.fromHex(n);const e=n.length,t=e/2;if(e%2)throw new Error("hex string expected, got unpadded hex of length "+e);const r=new Uint8Array(t);for(let s=0,i=0;s<t;s++,i+=2){const a=asciiToBase16(n.charCodeAt(i)),u=asciiToBase16(n.charCodeAt(i+1));if(a===void 0||u===void 0){const l=n[i]+n[i+1];throw new Error('hex string expected, got non-hex character "'+l+'" at index '+i)}r[s]=a*16+u}return r}function utf8ToBytes(n){if(typeof n!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(n))}function toBytes(n){return typeof n=="string"&&(n=utf8ToBytes(n)),abytes(n),n}function concatBytes(...n){let e=0;for(let r=0;r<n.length;r++){const s=n[r];abytes(s),e+=s.length}const t=new Uint8Array(e);for(let r=0,s=0;r<n.length;r++){const i=n[r];t.set(i,s),s+=i.length}return t}class Hash{}function createHasher(n){const e=r=>n().update(toBytes(r)).digest(),t=n();return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=()=>n(),e}function randomBytes(n=32){if(crypto$1&&typeof crypto$1.getRandomValues=="function")return crypto$1.getRandomValues(new Uint8Array(n));if(crypto$1&&typeof crypto$1.randomBytes=="function")return Uint8Array.from(crypto$1.randomBytes(n));throw new Error("crypto.getRandomValues must be defined")}function setBigUint64(n,e,t,r){if(typeof n.setBigUint64=="function")return n.setBigUint64(e,t,r);const s=BigInt(32),i=BigInt(4294967295),a=Number(t>>s&i),u=Number(t&i),l=r?4:0,p=r?0:4;n.setUint32(e+l,a,r),n.setUint32(e+p,u,r)}function Chi(n,e,t){return n&e^~n&t}function Maj(n,e,t){return n&e^n&t^e&t}class HashMD extends Hash{constructor(e,t,r,s){super(),this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.blockLen=e,this.outputLen=t,this.padOffset=r,this.isLE=s,this.buffer=new Uint8Array(e),this.view=createView(this.buffer)}update(e){aexists(this),e=toBytes(e),abytes(e);const{view:t,buffer:r,blockLen:s}=this,i=e.length;for(let a=0;a<i;){const u=Math.min(s-this.pos,i-a);if(u===s){const l=createView(e);for(;s<=i-a;a+=s)this.process(l,a);continue}r.set(e.subarray(a,a+u),this.pos),this.pos+=u,a+=u,this.pos===s&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){aexists(this),aoutput(e,this),this.finished=!0;const{buffer:t,view:r,blockLen:s,isLE:i}=this;let{pos:a}=this;t[a++]=128,clean(this.buffer.subarray(a)),this.padOffset>s-a&&(this.process(r,0),a=0);for(let v=a;v<s;v++)t[v]=0;setBigUint64(r,s-8,BigInt(this.length*8),i),this.process(r,0);const u=createView(e),l=this.outputLen;if(l%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const p=l/4,g=this.get();if(p>g.length)throw new Error("_sha2: outputLen bigger than state");for(let v=0;v<p;v++)u.setUint32(4*v,g[v],i)}digest(){const{buffer:e,outputLen:t}=this;this.digestInto(e);const r=e.slice(0,t);return this.destroy(),r}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());const{blockLen:t,buffer:r,length:s,finished:i,destroyed:a,pos:u}=this;return e.destroyed=a,e.finished=i,e.length=s,e.pos=u,s%t&&e.buffer.set(r),e}clone(){return this._cloneInto()}}const SHA256_IV=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),SHA256_K=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),SHA256_W=new Uint32Array(64);class SHA256 extends HashMD{constructor(e=32){super(64,e,8,!1),this.A=SHA256_IV[0]|0,this.B=SHA256_IV[1]|0,this.C=SHA256_IV[2]|0,this.D=SHA256_IV[3]|0,this.E=SHA256_IV[4]|0,this.F=SHA256_IV[5]|0,this.G=SHA256_IV[6]|0,this.H=SHA256_IV[7]|0}get(){const{A:e,B:t,C:r,D:s,E:i,F:a,G:u,H:l}=this;return[e,t,r,s,i,a,u,l]}set(e,t,r,s,i,a,u,l){this.A=e|0,this.B=t|0,this.C=r|0,this.D=s|0,this.E=i|0,this.F=a|0,this.G=u|0,this.H=l|0}process(e,t){for(let v=0;v<16;v++,t+=4)SHA256_W[v]=e.getUint32(t,!1);for(let v=16;v<64;v++){const m=SHA256_W[v-15],w=SHA256_W[v-2],T=rotr(m,7)^rotr(m,18)^m>>>3,P=rotr(w,17)^rotr(w,19)^w>>>10;SHA256_W[v]=P+SHA256_W[v-7]+T+SHA256_W[v-16]|0}let{A:r,B:s,C:i,D:a,E:u,F:l,G:p,H:g}=this;for(let v=0;v<64;v++){const m=rotr(u,6)^rotr(u,11)^rotr(u,25),w=g+m+Chi(u,l,p)+SHA256_K[v]+SHA256_W[v]|0,P=(rotr(r,2)^rotr(r,13)^rotr(r,22))+Maj(r,s,i)|0;g=p,p=l,l=u,u=a+w|0,a=i,i=s,s=r,r=w+P|0}r=r+this.A|0,s=s+this.B|0,i=i+this.C|0,a=a+this.D|0,u=u+this.E|0,l=l+this.F|0,p=p+this.G|0,g=g+this.H|0,this.set(r,s,i,a,u,l,p,g)}roundClean(){clean(SHA256_W)}destroy(){this.set(0,0,0,0,0,0,0,0),clean(this.buffer)}}const sha256$1=createHasher(()=>new SHA256);class HMAC extends Hash{constructor(e,t){super(),this.finished=!1,this.destroyed=!1,ahash(e);const r=toBytes(t);if(this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const s=this.blockLen,i=new Uint8Array(s);i.set(r.length>s?e.create().update(r).digest():r);for(let a=0;a<i.length;a++)i[a]^=54;this.iHash.update(i),this.oHash=e.create();for(let a=0;a<i.length;a++)i[a]^=106;this.oHash.update(i),clean(i)}update(e){return aexists(this),this.iHash.update(e),this}digestInto(e){aexists(this),abytes(e,this.outputLen),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){const e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||(e=Object.create(Object.getPrototypeOf(this),{}));const{oHash:t,iHash:r,finished:s,destroyed:i,blockLen:a,outputLen:u}=this;return e=e,e.finished=s,e.destroyed=i,e.blockLen=a,e.outputLen=u,e.oHash=t._cloneInto(e.oHash),e.iHash=r._cloneInto(e.iHash),e}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}}const hmac=(n,e,t)=>new HMAC(n,e).update(t).digest();hmac.create=(n,e)=>new HMAC(n,e);/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const _0n$4=BigInt(0),_1n$4=BigInt(1);function _abool2(n,e=""){if(typeof n!="boolean"){const t=e&&`"${e}"`;throw new Error(t+"expected boolean, got type="+typeof n)}return n}function _abytes2(n,e,t=""){const r=isBytes(n),s=n?.length,i=e!==void 0;if(!r||i&&s!==e){const a=t&&`"${t}" `,u=i?` of length ${e}`:"",l=r?`length=${s}`:`type=${typeof n}`;throw new Error(a+"expected Uint8Array"+u+", got "+l)}return n}function numberToHexUnpadded(n){const e=n.toString(16);return e.length&1?"0"+e:e}function hexToNumber(n){if(typeof n!="string")throw new Error("hex string expected, got "+typeof n);return n===""?_0n$4:BigInt("0x"+n)}function bytesToNumberBE(n){return hexToNumber(bytesToHex(n))}function bytesToNumberLE(n){return abytes(n),hexToNumber(bytesToHex(Uint8Array.from(n).reverse()))}function numberToBytesBE(n,e){return hexToBytes(n.toString(16).padStart(e*2,"0"))}function numberToBytesLE(n,e){return numberToBytesBE(n,e).reverse()}function ensureBytes(n,e,t){let r;if(typeof e=="string")try{r=hexToBytes(e)}catch(i){throw new Error(n+" must be hex string or Uint8Array, cause: "+i)}else if(isBytes(e))r=Uint8Array.from(e);else throw new Error(n+" must be hex string or Uint8Array");const s=r.length;if(typeof t=="number"&&s!==t)throw new Error(n+" of length "+t+" expected, got "+s);return r}const isPosBig=n=>typeof n=="bigint"&&_0n$4<=n;function inRange(n,e,t){return isPosBig(n)&&isPosBig(e)&&isPosBig(t)&&e<=n&&n<t}function aInRange(n,e,t,r){if(!inRange(e,t,r))throw new Error("expected valid "+n+": "+t+" <= n < "+r+", got "+e)}function bitLen(n){let e;for(e=0;n>_0n$4;n>>=_1n$4,e+=1);return e}const bitMask=n=>(_1n$4<<BigInt(n))-_1n$4;function createHmacDrbg(n,e,t){if(typeof n!="number"||n<2)throw new Error("hashLen must be a number");if(typeof e!="number"||e<2)throw new Error("qByteLen must be a number");if(typeof t!="function")throw new Error("hmacFn must be a function");const r=w=>new Uint8Array(w),s=w=>Uint8Array.of(w);let i=r(n),a=r(n),u=0;const l=()=>{i.fill(1),a.fill(0),u=0},p=(...w)=>t(a,i,...w),g=(w=r(0))=>{a=p(s(0),w),i=p(),w.length!==0&&(a=p(s(1),w),i=p())},v=()=>{if(u++>=1e3)throw new Error("drbg: tried 1000 values");let w=0;const T=[];for(;w<e;){i=p();const P=i.slice();T.push(P),w+=i.length}return concatBytes(...T)};return(w,T)=>{l(),g(w);let P;for(;!(P=T(v()));)g();return l(),P}}function _validateObject(n,e,t={}){if(!n||typeof n!="object")throw new Error("expected valid options object");function r(s,i,a){const u=n[s];if(a&&u===void 0)return;const l=typeof u;if(l!==i||u===null)throw new Error(`param "${s}" is invalid: expected ${i}, got ${l}`)}Object.entries(e).forEach(([s,i])=>r(s,i,!1)),Object.entries(t).forEach(([s,i])=>r(s,i,!0))}function memoized(n){const e=new WeakMap;return(t,...r)=>{const s=e.get(t);if(s!==void 0)return s;const i=n(t,...r);return e.set(t,i),i}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const _0n$3=BigInt(0),_1n$3=BigInt(1),_2n$2=BigInt(2),_3n$1=BigInt(3),_4n$1=BigInt(4),_5n=BigInt(5),_7n=BigInt(7),_8n=BigInt(8),_9n=BigInt(9),_16n=BigInt(16);function mod(n,e){const t=n%e;return t>=_0n$3?t:e+t}function pow2(n,e,t){let r=n;for(;e-- >_0n$3;)r*=r,r%=t;return r}function invert(n,e){if(n===_0n$3)throw new Error("invert: expected non-zero number");if(e<=_0n$3)throw new Error("invert: expected positive modulus, got "+e);let t=mod(n,e),r=e,s=_0n$3,i=_1n$3;for(;t!==_0n$3;){const u=r/t,l=r%t,p=s-i*u;r=t,t=l,s=i,i=p}if(r!==_1n$3)throw new Error("invert: does not exist");return mod(s,e)}function assertIsSquare(n,e,t){if(!n.eql(n.sqr(e),t))throw new Error("Cannot find square root")}function sqrt3mod4(n,e){const t=(n.ORDER+_1n$3)/_4n$1,r=n.pow(e,t);return assertIsSquare(n,r,e),r}function sqrt5mod8(n,e){const t=(n.ORDER-_5n)/_8n,r=n.mul(e,_2n$2),s=n.pow(r,t),i=n.mul(e,s),a=n.mul(n.mul(i,_2n$2),s),u=n.mul(i,n.sub(a,n.ONE));return assertIsSquare(n,u,e),u}function sqrt9mod16(n){const e=Field(n),t=tonelliShanks(n),r=t(e,e.neg(e.ONE)),s=t(e,r),i=t(e,e.neg(r)),a=(n+_7n)/_16n;return(u,l)=>{let p=u.pow(l,a),g=u.mul(p,r);const v=u.mul(p,s),m=u.mul(p,i),w=u.eql(u.sqr(g),l),T=u.eql(u.sqr(v),l);p=u.cmov(p,g,w),g=u.cmov(m,v,T);const P=u.eql(u.sqr(g),l),W=u.cmov(p,g,P);return assertIsSquare(u,W,l),W}}function tonelliShanks(n){if(n<_3n$1)throw new Error("sqrt is not defined for small field");let e=n-_1n$3,t=0;for(;e%_2n$2===_0n$3;)e/=_2n$2,t++;let r=_2n$2;const s=Field(n);for(;FpLegendre(s,r)===1;)if(r++>1e3)throw new Error("Cannot find square root: probably non-prime P");if(t===1)return sqrt3mod4;let i=s.pow(r,e);const a=(e+_1n$3)/_2n$2;return function(l,p){if(l.is0(p))return p;if(FpLegendre(l,p)!==1)throw new Error("Cannot find square root");let g=t,v=l.mul(l.ONE,i),m=l.pow(p,e),w=l.pow(p,a);for(;!l.eql(m,l.ONE);){if(l.is0(m))return l.ZERO;let T=1,P=l.sqr(m);for(;!l.eql(P,l.ONE);)if(T++,P=l.sqr(P),T===g)throw new Error("Cannot find square root");const W=_1n$3<<BigInt(g-T-1),X=l.pow(v,W);g=T,v=l.sqr(X),m=l.mul(m,v),w=l.mul(w,X)}return w}}function FpSqrt(n){return n%_4n$1===_3n$1?sqrt3mod4:n%_8n===_5n?sqrt5mod8:n%_16n===_9n?sqrt9mod16(n):tonelliShanks(n)}const FIELD_FIELDS=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function validateField(n){const e={ORDER:"bigint",MASK:"bigint",BYTES:"number",BITS:"number"},t=FIELD_FIELDS.reduce((r,s)=>(r[s]="function",r),e);return _validateObject(n,t),n}function FpPow(n,e,t){if(t<_0n$3)throw new Error("invalid exponent, negatives unsupported");if(t===_0n$3)return n.ONE;if(t===_1n$3)return e;let r=n.ONE,s=e;for(;t>_0n$3;)t&_1n$3&&(r=n.mul(r,s)),s=n.sqr(s),t>>=_1n$3;return r}function FpInvertBatch(n,e,t=!1){const r=new Array(e.length).fill(t?n.ZERO:void 0),s=e.reduce((a,u,l)=>n.is0(u)?a:(r[l]=a,n.mul(a,u)),n.ONE),i=n.inv(s);return e.reduceRight((a,u,l)=>n.is0(u)?a:(r[l]=n.mul(a,r[l]),n.mul(a,u)),i),r}function FpLegendre(n,e){const t=(n.ORDER-_1n$3)/_2n$2,r=n.pow(e,t),s=n.eql(r,n.ONE),i=n.eql(r,n.ZERO),a=n.eql(r,n.neg(n.ONE));if(!s&&!i&&!a)throw new Error("invalid Legendre symbol result");return s?1:i?0:-1}function nLength(n,e){e!==void 0&&anumber(e);const t=e!==void 0?e:n.toString(2).length,r=Math.ceil(t/8);return{nBitLength:t,nByteLength:r}}function Field(n,e,t=!1,r={}){if(n<=_0n$3)throw new Error("invalid field: expected ORDER > 0, got "+n);let s,i,a=!1,u;if(typeof e=="object"&&e!=null){if(r.sqrt||t)throw new Error("cannot specify opts in two arguments");const m=e;m.BITS&&(s=m.BITS),m.sqrt&&(i=m.sqrt),typeof m.isLE=="boolean"&&(t=m.isLE),typeof m.modFromBytes=="boolean"&&(a=m.modFromBytes),u=m.allowedLengths}else typeof e=="number"&&(s=e),r.sqrt&&(i=r.sqrt);const{nBitLength:l,nByteLength:p}=nLength(n,s);if(p>2048)throw new Error("invalid field: expected ORDER of <= 2048 bytes");let g;const v=Object.freeze({ORDER:n,isLE:t,BITS:l,BYTES:p,MASK:bitMask(l),ZERO:_0n$3,ONE:_1n$3,allowedLengths:u,create:m=>mod(m,n),isValid:m=>{if(typeof m!="bigint")throw new Error("invalid field element: expected bigint, got "+typeof m);return _0n$3<=m&&m<n},is0:m=>m===_0n$3,isValidNot0:m=>!v.is0(m)&&v.isValid(m),isOdd:m=>(m&_1n$3)===_1n$3,neg:m=>mod(-m,n),eql:(m,w)=>m===w,sqr:m=>mod(m*m,n),add:(m,w)=>mod(m+w,n),sub:(m,w)=>mod(m-w,n),mul:(m,w)=>mod(m*w,n),pow:(m,w)=>FpPow(v,m,w),div:(m,w)=>mod(m*invert(w,n),n),sqrN:m=>m*m,addN:(m,w)=>m+w,subN:(m,w)=>m-w,mulN:(m,w)=>m*w,inv:m=>invert(m,n),sqrt:i||(m=>(g||(g=FpSqrt(n)),g(v,m))),toBytes:m=>t?numberToBytesLE(m,p):numberToBytesBE(m,p),fromBytes:(m,w=!0)=>{if(u){if(!u.includes(m.length)||m.length>p)throw new Error("Field.fromBytes: expected "+u+" bytes, got "+m.length);const P=new Uint8Array(p);P.set(m,t?0:P.length-m.length),m=P}if(m.length!==p)throw new Error("Field.fromBytes: expected "+p+" bytes, got "+m.length);let T=t?bytesToNumberLE(m):bytesToNumberBE(m);if(a&&(T=mod(T,n)),!w&&!v.isValid(T))throw new Error("invalid field element: outside of range 0..ORDER");return T},invertBatch:m=>FpInvertBatch(v,m),cmov:(m,w,T)=>T?w:m});return Object.freeze(v)}function getFieldBytesLength(n){if(typeof n!="bigint")throw new Error("field order must be bigint");const e=n.toString(2).length;return Math.ceil(e/8)}function getMinHashLength(n){const e=getFieldBytesLength(n);return e+Math.ceil(e/2)}function mapHashToField(n,e,t=!1){const r=n.length,s=getFieldBytesLength(e),i=getMinHashLength(e);if(r<16||r<i||r>1024)throw new Error("expected "+i+"-1024 bytes of input, got "+r);const a=t?bytesToNumberLE(n):bytesToNumberBE(n),u=mod(a,e-_1n$3)+_1n$3;return t?numberToBytesLE(u,s):numberToBytesBE(u,s)}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const _0n$2=BigInt(0),_1n$2=BigInt(1);function negateCt(n,e){const t=e.negate();return n?t:e}function normalizeZ(n,e){const t=FpInvertBatch(n.Fp,e.map(r=>r.Z));return e.map((r,s)=>n.fromAffine(r.toAffine(t[s])))}function validateW(n,e){if(!Number.isSafeInteger(n)||n<=0||n>e)throw new Error("invalid window size, expected [1.."+e+"], got W="+n)}function calcWOpts(n,e){validateW(n,e);const t=Math.ceil(e/n)+1,r=2**(n-1),s=2**n,i=bitMask(n),a=BigInt(n);return{windows:t,windowSize:r,mask:i,maxNumber:s,shiftBy:a}}function calcOffsets(n,e,t){const{windowSize:r,mask:s,maxNumber:i,shiftBy:a}=t;let u=Number(n&s),l=n>>a;u>r&&(u-=i,l+=_1n$2);const p=e*r,g=p+Math.abs(u)-1,v=u===0,m=u<0,w=e%2!==0;return{nextN:l,offset:g,isZero:v,isNeg:m,isNegF:w,offsetF:p}}function validateMSMPoints(n,e){if(!Array.isArray(n))throw new Error("array expected");n.forEach((t,r)=>{if(!(t instanceof e))throw new Error("invalid point at index "+r)})}function validateMSMScalars(n,e){if(!Array.isArray(n))throw new Error("array of scalars expected");n.forEach((t,r)=>{if(!e.isValid(t))throw new Error("invalid scalar at index "+r)})}const pointPrecomputes=new WeakMap,pointWindowSizes=new WeakMap;function getW(n){return pointWindowSizes.get(n)||1}function assert0(n){if(n!==_0n$2)throw new Error("invalid wNAF")}class wNAF{constructor(e,t){this.BASE=e.BASE,this.ZERO=e.ZERO,this.Fn=e.Fn,this.bits=t}_unsafeLadder(e,t,r=this.ZERO){let s=e;for(;t>_0n$2;)t&_1n$2&&(r=r.add(s)),s=s.double(),t>>=_1n$2;return r}precomputeWindow(e,t){const{windows:r,windowSize:s}=calcWOpts(t,this.bits),i=[];let a=e,u=a;for(let l=0;l<r;l++){u=a,i.push(u);for(let p=1;p<s;p++)u=u.add(a),i.push(u);a=u.double()}return i}wNAF(e,t,r){if(!this.Fn.isValid(r))throw new Error("invalid scalar");let s=this.ZERO,i=this.BASE;const a=calcWOpts(e,this.bits);for(let u=0;u<a.windows;u++){const{nextN:l,offset:p,isZero:g,isNeg:v,isNegF:m,offsetF:w}=calcOffsets(r,u,a);r=l,g?i=i.add(negateCt(m,t[w])):s=s.add(negateCt(v,t[p]))}return assert0(r),{p:s,f:i}}wNAFUnsafe(e,t,r,s=this.ZERO){const i=calcWOpts(e,this.bits);for(let a=0;a<i.windows&&r!==_0n$2;a++){const{nextN:u,offset:l,isZero:p,isNeg:g}=calcOffsets(r,a,i);if(r=u,!p){const v=t[l];s=s.add(g?v.negate():v)}}return assert0(r),s}getPrecomputes(e,t,r){let s=pointPrecomputes.get(t);return s||(s=this.precomputeWindow(t,e),e!==1&&(typeof r=="function"&&(s=r(s)),pointPrecomputes.set(t,s))),s}cached(e,t,r){const s=getW(e);return this.wNAF(s,this.getPrecomputes(s,e,r),t)}unsafe(e,t,r,s){const i=getW(e);return i===1?this._unsafeLadder(e,t,s):this.wNAFUnsafe(i,this.getPrecomputes(i,e,r),t,s)}createCache(e,t){validateW(t,this.bits),pointWindowSizes.set(e,t),pointPrecomputes.delete(e)}hasCache(e){return getW(e)!==1}}function mulEndoUnsafe(n,e,t,r){let s=e,i=n.ZERO,a=n.ZERO;for(;t>_0n$2||r>_0n$2;)t&_1n$2&&(i=i.add(s)),r&_1n$2&&(a=a.add(s)),s=s.double(),t>>=_1n$2,r>>=_1n$2;return{p1:i,p2:a}}function pippenger(n,e,t,r){validateMSMPoints(t,n),validateMSMScalars(r,e);const s=t.length,i=r.length;if(s!==i)throw new Error("arrays of points and scalars must have equal length");const a=n.ZERO,u=bitLen(BigInt(s));let l=1;u>12?l=u-3:u>4?l=u-2:u>0&&(l=2);const p=bitMask(l),g=new Array(Number(p)+1).fill(a),v=Math.floor((e.BITS-1)/l)*l;let m=a;for(let w=v;w>=0;w-=l){g.fill(a);for(let P=0;P<i;P++){const W=r[P],X=Number(W>>BigInt(w)&p);g[X]=g[X].add(t[P])}let T=a;for(let P=g.length-1,W=a;P>0;P--)W=W.add(g[P]),T=T.add(W);if(m=m.add(T),w!==0)for(let P=0;P<l;P++)m=m.double()}return m}function createField(n,e,t){if(e){if(e.ORDER!==n)throw new Error("Field.ORDER must match order: Fp == p, Fn == n");return validateField(e),e}else return Field(n,{isLE:t})}function _createCurveFields(n,e,t={},r){if(r===void 0&&(r=n==="edwards"),!e||typeof e!="object")throw new Error(`expected valid ${n} CURVE object`);for(const l of["p","n","h"]){const p=e[l];if(!(typeof p=="bigint"&&p>_0n$2))throw new Error(`CURVE.${l} must be positive bigint`)}const s=createField(e.p,t.Fp,r),i=createField(e.n,t.Fn,r),u=["Gx","Gy","a","b"];for(const l of u)if(!s.isValid(e[l]))throw new Error(`CURVE.${l} must be valid field element of CURVE.Fp`);return e=Object.freeze(Object.assign({},e)),{CURVE:e,Fp:s,Fn:i}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const divNearest=(n,e)=>(n+(n>=0?e:-e)/_2n$1)/e;function _splitEndoScalar(n,e,t){const[[r,s],[i,a]]=e,u=divNearest(a*n,t),l=divNearest(-s*n,t);let p=n-u*r-l*i,g=-u*s-l*a;const v=p<_0n$1,m=g<_0n$1;v&&(p=-p),m&&(g=-g);const w=bitMask(Math.ceil(bitLen(t)/2))+_1n$1;if(p<_0n$1||p>=w||g<_0n$1||g>=w)throw new Error("splitScalar (endomorphism): failed, k="+n);return{k1neg:v,k1:p,k2neg:m,k2:g}}function validateSigFormat(n){if(!["compact","recovered","der"].includes(n))throw new Error('Signature format must be "compact", "recovered", or "der"');return n}function validateSigOpts(n,e){const t={};for(let r of Object.keys(e))t[r]=n[r]===void 0?e[r]:n[r];return _abool2(t.lowS,"lowS"),_abool2(t.prehash,"prehash"),t.format!==void 0&&validateSigFormat(t.format),t}class DERErr extends Error{constructor(e=""){super(e)}}const DER={Err:DERErr,_tlv:{encode:(n,e)=>{const{Err:t}=DER;if(n<0||n>256)throw new t("tlv.encode: wrong tag");if(e.length&1)throw new t("tlv.encode: unpadded data");const r=e.length/2,s=numberToHexUnpadded(r);if(s.length/2&128)throw new t("tlv.encode: long form length too big");const i=r>127?numberToHexUnpadded(s.length/2|128):"";return numberToHexUnpadded(n)+i+s+e},decode(n,e){const{Err:t}=DER;let r=0;if(n<0||n>256)throw new t("tlv.encode: wrong tag");if(e.length<2||e[r++]!==n)throw new t("tlv.decode: wrong tlv");const s=e[r++],i=!!(s&128);let a=0;if(!i)a=s;else{const l=s&127;if(!l)throw new t("tlv.decode(long): indefinite length not supported");if(l>4)throw new t("tlv.decode(long): byte length is too big");const p=e.subarray(r,r+l);if(p.length!==l)throw new t("tlv.decode: length bytes not complete");if(p[0]===0)throw new t("tlv.decode(long): zero leftmost byte");for(const g of p)a=a<<8|g;if(r+=l,a<128)throw new t("tlv.decode(long): not minimal encoding")}const u=e.subarray(r,r+a);if(u.length!==a)throw new t("tlv.decode: wrong value length");return{v:u,l:e.subarray(r+a)}}},_int:{encode(n){const{Err:e}=DER;if(n<_0n$1)throw new e("integer: negative integers are not allowed");let t=numberToHexUnpadded(n);if(Number.parseInt(t[0],16)&8&&(t="00"+t),t.length&1)throw new e("unexpected DER parsing assertion: unpadded hex");return t},decode(n){const{Err:e}=DER;if(n[0]&128)throw new e("invalid signature integer: negative");if(n[0]===0&&!(n[1]&128))throw new e("invalid signature integer: unnecessary leading zero");return bytesToNumberBE(n)}},toSig(n){const{Err:e,_int:t,_tlv:r}=DER,s=ensureBytes("signature",n),{v:i,l:a}=r.decode(48,s);if(a.length)throw new e("invalid signature: left bytes after parsing");const{v:u,l}=r.decode(2,i),{v:p,l:g}=r.decode(2,l);if(g.length)throw new e("invalid signature: left bytes after parsing");return{r:t.decode(u),s:t.decode(p)}},hexFromSig(n){const{_tlv:e,_int:t}=DER,r=e.encode(2,t.encode(n.r)),s=e.encode(2,t.encode(n.s)),i=r+s;return e.encode(48,i)}},_0n$1=BigInt(0),_1n$1=BigInt(1),_2n$1=BigInt(2),_3n=BigInt(3),_4n=BigInt(4);function _normFnElement(n,e){const{BYTES:t}=n;let r;if(typeof e=="bigint")r=e;else{let s=ensureBytes("private key",e);try{r=n.fromBytes(s)}catch{throw new Error(`invalid private key: expected ui8a of size ${t}, got ${typeof e}`)}}if(!n.isValidNot0(r))throw new Error("invalid private key: out of range [1..N-1]");return r}function weierstrassN(n,e={}){const t=_createCurveFields("weierstrass",n,e),{Fp:r,Fn:s}=t;let i=t.CURVE;const{h:a,n:u}=i;_validateObject(e,{},{allowInfinityPoint:"boolean",clearCofactor:"function",isTorsionFree:"function",fromBytes:"function",toBytes:"function",endo:"object",wrapPrivateKey:"boolean"});const{endo:l}=e;if(l&&(!r.is0(i.a)||typeof l.beta!="bigint"||!Array.isArray(l.basises)))throw new Error('invalid endo: expected "beta": bigint and "basises": array');const p=getWLengths(r,s);function g(){if(!r.isOdd)throw new Error("compression is not supported: Field does not have .isOdd()")}function v(U,E,$){const{x:_,y:A}=E.toAffine(),M=r.toBytes(_);if(_abool2($,"isCompressed"),$){g();const G=!r.isOdd(A);return concatBytes(pprefix(G),M)}else return concatBytes(Uint8Array.of(4),M,r.toBytes(A))}function m(U){_abytes2(U,void 0,"Point");const{publicKey:E,publicKeyUncompressed:$}=p,_=U.length,A=U[0],M=U.subarray(1);if(_===E&&(A===2||A===3)){const G=r.fromBytes(M);if(!r.isValid(G))throw new Error("bad point: is not on curve, wrong x");const j=P(G);let z;try{z=r.sqrt(j)}catch(fe){const he=fe instanceof Error?": "+fe.message:"";throw new Error("bad point: is not on curve, sqrt error"+he)}g();const V=r.isOdd(z);return(A&1)===1!==V&&(z=r.neg(z)),{x:G,y:z}}else if(_===$&&A===4){const G=r.BYTES,j=r.fromBytes(M.subarray(0,G)),z=r.fromBytes(M.subarray(G,G*2));if(!W(j,z))throw new Error("bad point: is not on curve");return{x:j,y:z}}else throw new Error(`bad point: got length ${_}, expected compressed=${E} or uncompressed=${$}`)}const w=e.toBytes||v,T=e.fromBytes||m;function P(U){const E=r.sqr(U),$=r.mul(E,U);return r.add(r.add($,r.mul(U,i.a)),i.b)}function W(U,E){const $=r.sqr(E),_=P(U);return r.eql($,_)}if(!W(i.Gx,i.Gy))throw new Error("bad curve params: generator point");const X=r.mul(r.pow(i.a,_3n),_4n),ke=r.mul(r.sqr(i.b),BigInt(27));if(r.is0(r.add(X,ke)))throw new Error("bad curve params: a or b");function ne(U,E,$=!1){if(!r.isValid(E)||$&&r.is0(E))throw new Error(`bad point coordinate ${U}`);return E}function ye(U){if(!(U instanceof ie))throw new Error("ProjectivePoint expected")}function Se(U){if(!l||!l.basises)throw new Error("no endo");return _splitEndoScalar(U,l.basises,s.ORDER)}const Ee=memoized((U,E)=>{const{X:$,Y:_,Z:A}=U;if(r.eql(A,r.ONE))return{x:$,y:_};const M=U.is0();E==null&&(E=M?r.ONE:r.inv(A));const G=r.mul($,E),j=r.mul(_,E),z=r.mul(A,E);if(M)return{x:r.ZERO,y:r.ZERO};if(!r.eql(z,r.ONE))throw new Error("invZ was invalid");return{x:G,y:j}}),ve=memoized(U=>{if(U.is0()){if(e.allowInfinityPoint&&!r.is0(U.Y))return;throw new Error("bad point: ZERO")}const{x:E,y:$}=U.toAffine();if(!r.isValid(E)||!r.isValid($))throw new Error("bad point: x or y not field elements");if(!W(E,$))throw new Error("bad point: equation left != right");if(!U.isTorsionFree())throw new Error("bad point: not in prime-order subgroup");return!0});function Ne(U,E,$,_,A){return $=new ie(r.mul($.X,U),$.Y,$.Z),E=negateCt(_,E),$=negateCt(A,$),E.add($)}class ie{constructor(E,$,_){this.X=ne("x",E),this.Y=ne("y",$,!0),this.Z=ne("z",_),Object.freeze(this)}static CURVE(){return i}static fromAffine(E){const{x:$,y:_}=E||{};if(!E||!r.isValid($)||!r.isValid(_))throw new Error("invalid affine point");if(E instanceof ie)throw new Error("projective point not allowed");return r.is0($)&&r.is0(_)?ie.ZERO:new ie($,_,r.ONE)}static fromBytes(E){const $=ie.fromAffine(T(_abytes2(E,void 0,"point")));return $.assertValidity(),$}static fromHex(E){return ie.fromBytes(ensureBytes("pointHex",E))}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(E=8,$=!0){return H.createCache(this,E),$||this.multiply(_3n),this}assertValidity(){ve(this)}hasEvenY(){const{y:E}=this.toAffine();if(!r.isOdd)throw new Error("Field doesn't support isOdd");return!r.isOdd(E)}equals(E){ye(E);const{X:$,Y:_,Z:A}=this,{X:M,Y:G,Z:j}=E,z=r.eql(r.mul($,j),r.mul(M,A)),V=r.eql(r.mul(_,j),r.mul(G,A));return z&&V}negate(){return new ie(this.X,r.neg(this.Y),this.Z)}double(){const{a:E,b:$}=i,_=r.mul($,_3n),{X:A,Y:M,Z:G}=this;let j=r.ZERO,z=r.ZERO,V=r.ZERO,J=r.mul(A,A),fe=r.mul(M,M),he=r.mul(G,G),ue=r.mul(A,M);return ue=r.add(ue,ue),V=r.mul(A,G),V=r.add(V,V),j=r.mul(E,V),z=r.mul(_,he),z=r.add(j,z),j=r.sub(fe,z),z=r.add(fe,z),z=r.mul(j,z),j=r.mul(ue,j),V=r.mul(_,V),he=r.mul(E,he),ue=r.sub(J,he),ue=r.mul(E,ue),ue=r.add(ue,V),V=r.add(J,J),J=r.add(V,J),J=r.add(J,he),J=r.mul(J,ue),z=r.add(z,J),he=r.mul(M,G),he=r.add(he,he),J=r.mul(he,ue),j=r.sub(j,J),V=r.mul(he,fe),V=r.add(V,V),V=r.add(V,V),new ie(j,z,V)}add(E){ye(E);const{X:$,Y:_,Z:A}=this,{X:M,Y:G,Z:j}=E;let z=r.ZERO,V=r.ZERO,J=r.ZERO;const fe=i.a,he=r.mul(i.b,_3n);let ue=r.mul($,M),pe=r.mul(_,G),ge=r.mul(A,j),Re=r.add($,_),Z=r.add(M,G);Re=r.mul(Re,Z),Z=r.add(ue,pe),Re=r.sub(Re,Z),Z=r.add($,A);let $e=r.add(M,j);return Z=r.mul(Z,$e),$e=r.add(ue,ge),Z=r.sub(Z,$e),$e=r.add(_,A),z=r.add(G,j),$e=r.mul($e,z),z=r.add(pe,ge),$e=r.sub($e,z),J=r.mul(fe,Z),z=r.mul(he,ge),J=r.add(z,J),z=r.sub(pe,J),J=r.add(pe,J),V=r.mul(z,J),pe=r.add(ue,ue),pe=r.add(pe,ue),ge=r.mul(fe,ge),Z=r.mul(he,Z),pe=r.add(pe,ge),ge=r.sub(ue,ge),ge=r.mul(fe,ge),Z=r.add(Z,ge),ue=r.mul(pe,Z),V=r.add(V,ue),ue=r.mul($e,Z),z=r.mul(Re,z),z=r.sub(z,ue),ue=r.mul(Re,pe),J=r.mul($e,J),J=r.add(J,ue),new ie(z,V,J)}subtract(E){return this.add(E.negate())}is0(){return this.equals(ie.ZERO)}multiply(E){const{endo:$}=e;if(!s.isValidNot0(E))throw new Error("invalid scalar: out of range");let _,A;const M=G=>H.cached(this,G,j=>normalizeZ(ie,j));if($){const{k1neg:G,k1:j,k2neg:z,k2:V}=Se(E),{p:J,f:fe}=M(j),{p:he,f:ue}=M(V);A=fe.add(ue),_=Ne($.beta,J,he,G,z)}else{const{p:G,f:j}=M(E);_=G,A=j}return normalizeZ(ie,[_,A])[0]}multiplyUnsafe(E){const{endo:$}=e,_=this;if(!s.isValid(E))throw new Error("invalid scalar: out of range");if(E===_0n$1||_.is0())return ie.ZERO;if(E===_1n$1)return _;if(H.hasCache(this))return this.multiply(E);if($){const{k1neg:A,k1:M,k2neg:G,k2:j}=Se(E),{p1:z,p2:V}=mulEndoUnsafe(ie,_,M,j);return Ne($.beta,z,V,A,G)}else return H.unsafe(_,E)}multiplyAndAddUnsafe(E,$,_){const A=this.multiplyUnsafe($).add(E.multiplyUnsafe(_));return A.is0()?void 0:A}toAffine(E){return Ee(this,E)}isTorsionFree(){const{isTorsionFree:E}=e;return a===_1n$1?!0:E?E(ie,this):H.unsafe(this,u).is0()}clearCofactor(){const{clearCofactor:E}=e;return a===_1n$1?this:E?E(ie,this):this.multiplyUnsafe(a)}isSmallOrder(){return this.multiplyUnsafe(a).is0()}toBytes(E=!0){return _abool2(E,"isCompressed"),this.assertValidity(),w(ie,this,E)}toHex(E=!0){return bytesToHex(this.toBytes(E))}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}get px(){return this.X}get py(){return this.X}get pz(){return this.Z}toRawBytes(E=!0){return this.toBytes(E)}_setWindowSize(E){this.precompute(E)}static normalizeZ(E){return normalizeZ(ie,E)}static msm(E,$){return pippenger(ie,s,E,$)}static fromPrivateKey(E){return ie.BASE.multiply(_normFnElement(s,E))}}ie.BASE=new ie(i.Gx,i.Gy,r.ONE),ie.ZERO=new ie(r.ZERO,r.ONE,r.ZERO),ie.Fp=r,ie.Fn=s;const De=s.BITS,H=new wNAF(ie,e.endo?Math.ceil(De/2):De);return ie.BASE.precompute(8),ie}function pprefix(n){return Uint8Array.of(n?2:3)}function getWLengths(n,e){return{secretKey:e.BYTES,publicKey:1+n.BYTES,publicKeyUncompressed:1+2*n.BYTES,publicKeyHasPrefix:!0,signature:2*e.BYTES}}function ecdh(n,e={}){const{Fn:t}=n,r=e.randomBytes||randomBytes,s=Object.assign(getWLengths(n.Fp,t),{seed:getMinHashLength(t.ORDER)});function i(w){try{return!!_normFnElement(t,w)}catch{return!1}}function a(w,T){const{publicKey:P,publicKeyUncompressed:W}=s;try{const X=w.length;return T===!0&&X!==P||T===!1&&X!==W?!1:!!n.fromBytes(w)}catch{return!1}}function u(w=r(s.seed)){return mapHashToField(_abytes2(w,s.seed,"seed"),t.ORDER)}function l(w,T=!0){return n.BASE.multiply(_normFnElement(t,w)).toBytes(T)}function p(w){const T=u(w);return{secretKey:T,publicKey:l(T)}}function g(w){if(typeof w=="bigint")return!1;if(w instanceof n)return!0;const{secretKey:T,publicKey:P,publicKeyUncompressed:W}=s;if(t.allowedLengths||T===P)return;const X=ensureBytes("key",w).length;return X===P||X===W}function v(w,T,P=!0){if(g(w)===!0)throw new Error("first arg must be private key");if(g(T)===!1)throw new Error("second arg must be public key");const W=_normFnElement(t,w);return n.fromHex(T).multiply(W).toBytes(P)}return Object.freeze({getPublicKey:l,getSharedSecret:v,keygen:p,Point:n,utils:{isValidSecretKey:i,isValidPublicKey:a,randomSecretKey:u,isValidPrivateKey:i,randomPrivateKey:u,normPrivateKeyToScalar:w=>_normFnElement(t,w),precompute(w=8,T=n.BASE){return T.precompute(w,!1)}},lengths:s})}function ecdsa(n,e,t={}){ahash(e),_validateObject(t,{},{hmac:"function",lowS:"boolean",randomBytes:"function",bits2int:"function",bits2int_modN:"function"});const r=t.randomBytes||randomBytes,s=t.hmac||(($,..._)=>hmac(e,$,concatBytes(..._))),{Fp:i,Fn:a}=n,{ORDER:u,BITS:l}=a,{keygen:p,getPublicKey:g,getSharedSecret:v,utils:m,lengths:w}=ecdh(n,t),T={prehash:!1,lowS:typeof t.lowS=="boolean"?t.lowS:!1,format:void 0,extraEntropy:!1},P="compact";function W($){const _=u>>_1n$1;return $>_}function X($,_){if(!a.isValidNot0(_))throw new Error(`invalid signature ${$}: out of range 1..Point.Fn.ORDER`);return _}function ke($,_){validateSigFormat(_);const A=w.signature,M=_==="compact"?A:_==="recovered"?A+1:void 0;return _abytes2($,M,`${_} signature`)}class ne{constructor(_,A,M){this.r=X("r",_),this.s=X("s",A),M!=null&&(this.recovery=M),Object.freeze(this)}static fromBytes(_,A=P){ke(_,A);let M;if(A==="der"){const{r:V,s:J}=DER.toSig(_abytes2(_));return new ne(V,J)}A==="recovered"&&(M=_[0],A="compact",_=_.subarray(1));const G=a.BYTES,j=_.subarray(0,G),z=_.subarray(G,G*2);return new ne(a.fromBytes(j),a.fromBytes(z),M)}static fromHex(_,A){return this.fromBytes(hexToBytes(_),A)}addRecoveryBit(_){return new ne(this.r,this.s,_)}recoverPublicKey(_){const A=i.ORDER,{r:M,s:G,recovery:j}=this;if(j==null||![0,1,2,3].includes(j))throw new Error("recovery id invalid");if(u*_2n$1<A&&j>1)throw new Error("recovery id is ambiguous for h>1 curve");const V=j===2||j===3?M+u:M;if(!i.isValid(V))throw new Error("recovery id 2 or 3 invalid");const J=i.toBytes(V),fe=n.fromBytes(concatBytes(pprefix((j&1)===0),J)),he=a.inv(V),ue=Se(ensureBytes("msgHash",_)),pe=a.create(-ue*he),ge=a.create(G*he),Re=n.BASE.multiplyUnsafe(pe).add(fe.multiplyUnsafe(ge));if(Re.is0())throw new Error("point at infinify");return Re.assertValidity(),Re}hasHighS(){return W(this.s)}toBytes(_=P){if(validateSigFormat(_),_==="der")return hexToBytes(DER.hexFromSig(this));const A=a.toBytes(this.r),M=a.toBytes(this.s);if(_==="recovered"){if(this.recovery==null)throw new Error("recovery bit must be present");return concatBytes(Uint8Array.of(this.recovery),A,M)}return concatBytes(A,M)}toHex(_){return bytesToHex(this.toBytes(_))}assertValidity(){}static fromCompact(_){return ne.fromBytes(ensureBytes("sig",_),"compact")}static fromDER(_){return ne.fromBytes(ensureBytes("sig",_),"der")}normalizeS(){return this.hasHighS()?new ne(this.r,a.neg(this.s),this.recovery):this}toDERRawBytes(){return this.toBytes("der")}toDERHex(){return bytesToHex(this.toBytes("der"))}toCompactRawBytes(){return this.toBytes("compact")}toCompactHex(){return bytesToHex(this.toBytes("compact"))}}const ye=t.bits2int||function(_){if(_.length>8192)throw new Error("input is too large");const A=bytesToNumberBE(_),M=_.length*8-l;return M>0?A>>BigInt(M):A},Se=t.bits2int_modN||function(_){return a.create(ye(_))},Ee=bitMask(l);function ve($){return aInRange("num < 2^"+l,$,_0n$1,Ee),a.toBytes($)}function Ne($,_){return _abytes2($,void 0,"message"),_?_abytes2(e($),void 0,"prehashed message"):$}function ie($,_,A){if(["recovered","canonical"].some(pe=>pe in A))throw new Error("sign() legacy options not supported");const{lowS:M,prehash:G,extraEntropy:j}=validateSigOpts(A,T);$=Ne($,G);const z=Se($),V=_normFnElement(a,_),J=[ve(V),ve(z)];if(j!=null&&j!==!1){const pe=j===!0?r(w.secretKey):j;J.push(ensureBytes("extraEntropy",pe))}const fe=concatBytes(...J),he=z;function ue(pe){const ge=ye(pe);if(!a.isValidNot0(ge))return;const Re=a.inv(ge),Z=n.BASE.multiply(ge).toAffine(),$e=a.create(Z.x);if($e===_0n$1)return;const Ve=a.create(Re*a.create(he+$e*V));if(Ve===_0n$1)return;let xe=(Z.x===$e?0:2)|Number(Z.y&_1n$1),qe=Ve;return M&&W(Ve)&&(qe=a.neg(Ve),xe^=1),new ne($e,qe,xe)}return{seed:fe,k2sig:ue}}function De($,_,A={}){$=ensureBytes("message",$);const{seed:M,k2sig:G}=ie($,_,A);return createHmacDrbg(e.outputLen,a.BYTES,s)(M,G)}function H($){let _;const A=typeof $=="string"||isBytes($),M=!A&&$!==null&&typeof $=="object"&&typeof $.r=="bigint"&&typeof $.s=="bigint";if(!A&&!M)throw new Error("invalid signature, expected Uint8Array, hex string or Signature instance");if(M)_=new ne($.r,$.s);else if(A){try{_=ne.fromBytes(ensureBytes("sig",$),"der")}catch(G){if(!(G instanceof DER.Err))throw G}if(!_)try{_=ne.fromBytes(ensureBytes("sig",$),"compact")}catch{return!1}}return _||!1}function U($,_,A,M={}){const{lowS:G,prehash:j,format:z}=validateSigOpts(M,T);if(A=ensureBytes("publicKey",A),_=Ne(ensureBytes("message",_),j),"strict"in M)throw new Error("options.strict was renamed to lowS");const V=z===void 0?H($):ne.fromBytes(ensureBytes("sig",$),z);if(V===!1)return!1;try{const J=n.fromBytes(A);if(G&&V.hasHighS())return!1;const{r:fe,s:he}=V,ue=Se(_),pe=a.inv(he),ge=a.create(ue*pe),Re=a.create(fe*pe),Z=n.BASE.multiplyUnsafe(ge).add(J.multiplyUnsafe(Re));return Z.is0()?!1:a.create(Z.x)===fe}catch{return!1}}function E($,_,A={}){const{prehash:M}=validateSigOpts(A,T);return _=Ne(_,M),ne.fromBytes($,"recovered").recoverPublicKey(_).toBytes()}return Object.freeze({keygen:p,getPublicKey:g,getSharedSecret:v,utils:m,lengths:w,Point:n,sign:De,verify:U,recoverPublicKey:E,Signature:ne,hash:e})}function _weierstrass_legacy_opts_to_new(n){const e={a:n.a,b:n.b,p:n.Fp.ORDER,n:n.n,h:n.h,Gx:n.Gx,Gy:n.Gy},t=n.Fp;let r=n.allowedPrivateKeyLengths?Array.from(new Set(n.allowedPrivateKeyLengths.map(a=>Math.ceil(a/2)))):void 0;const s=Field(e.n,{BITS:n.nBitLength,allowedLengths:r,modFromBytes:n.wrapPrivateKey}),i={Fp:t,Fn:s,allowInfinityPoint:n.allowInfinityPoint,endo:n.endo,isTorsionFree:n.isTorsionFree,clearCofactor:n.clearCofactor,fromBytes:n.fromBytes,toBytes:n.toBytes};return{CURVE:e,curveOpts:i}}function _ecdsa_legacy_opts_to_new(n){const{CURVE:e,curveOpts:t}=_weierstrass_legacy_opts_to_new(n),r={hmac:n.hmac,randomBytes:n.randomBytes,lowS:n.lowS,bits2int:n.bits2int,bits2int_modN:n.bits2int_modN};return{CURVE:e,curveOpts:t,hash:n.hash,ecdsaOpts:r}}function _ecdsa_new_output_to_legacy(n,e){const t=e.Point;return Object.assign({},e,{ProjectivePoint:t,CURVE:Object.assign({},n,nLength(t.Fn.ORDER,t.Fn.BITS))})}function weierstrass(n){const{CURVE:e,curveOpts:t,hash:r,ecdsaOpts:s}=_ecdsa_legacy_opts_to_new(n),i=weierstrassN(e,t),a=ecdsa(i,r,s);return _ecdsa_new_output_to_legacy(n,a)}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */function createCurve(n,e){const t=r=>weierstrass({...n,hash:r});return{...t(e),create:t}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const secp256k1_CURVE={p:BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),n:BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),h:BigInt(1),a:BigInt(0),b:BigInt(7),Gx:BigInt("0x79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798"),Gy:BigInt("0x483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b8")},secp256k1_ENDO={beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),basises:[[BigInt("0x3086d221a7d46bcde86c90e49284eb15"),-BigInt("0xe4437ed6010e88286f547fa90abfe4c3")],[BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),BigInt("0x3086d221a7d46bcde86c90e49284eb15")]]},_0n=BigInt(0),_1n=BigInt(1),_2n=BigInt(2);function sqrtMod(n){const e=secp256k1_CURVE.p,t=BigInt(3),r=BigInt(6),s=BigInt(11),i=BigInt(22),a=BigInt(23),u=BigInt(44),l=BigInt(88),p=n*n*n%e,g=p*p*n%e,v=pow2(g,t,e)*g%e,m=pow2(v,t,e)*g%e,w=pow2(m,_2n,e)*p%e,T=pow2(w,s,e)*w%e,P=pow2(T,i,e)*T%e,W=pow2(P,u,e)*P%e,X=pow2(W,l,e)*W%e,ke=pow2(X,u,e)*P%e,ne=pow2(ke,t,e)*g%e,ye=pow2(ne,a,e)*T%e,Se=pow2(ye,r,e)*p%e,Ee=pow2(Se,_2n,e);if(!Fpk1.eql(Fpk1.sqr(Ee),n))throw new Error("Cannot find square root");return Ee}const Fpk1=Field(secp256k1_CURVE.p,{sqrt:sqrtMod}),secp256k1=createCurve({...secp256k1_CURVE,Fp:Fpk1,lowS:!0,endo:secp256k1_ENDO},sha256$1),TAGGED_HASH_PREFIXES={};function taggedHash(n,...e){let t=TAGGED_HASH_PREFIXES[n];if(t===void 0){const r=sha256$1(utf8ToBytes(n));t=concatBytes(r,r),TAGGED_HASH_PREFIXES[n]=t}return sha256$1(concatBytes(t,...e))}const pointToBytes=n=>n.toBytes(!0).slice(1),Pointk1=secp256k1.Point,hasEven=n=>n%_2n===_0n;function schnorrGetExtPubKey(n){const{Fn:e,BASE:t}=Pointk1,r=_normFnElement(e,n),s=t.multiply(r);return{scalar:hasEven(s.y)?r:e.neg(r),bytes:pointToBytes(s)}}function lift_x(n){const e=Fpk1;if(!e.isValidNot0(n))throw new Error("invalid x: Fail if x  p");const t=e.create(n*n),r=e.create(t*n+BigInt(7));let s=e.sqrt(r);hasEven(s)||(s=e.neg(s));const i=Pointk1.fromAffine({x:n,y:s});return i.assertValidity(),i}const num=bytesToNumberBE;function challenge(...n){return Pointk1.Fn.create(num(taggedHash("BIP0340/challenge",...n)))}function schnorrGetPublicKey(n){return schnorrGetExtPubKey(n).bytes}function schnorrSign(n,e,t=randomBytes(32)){const{Fn:r}=Pointk1,s=ensureBytes("message",n),{bytes:i,scalar:a}=schnorrGetExtPubKey(e),u=ensureBytes("auxRand",t,32),l=r.toBytes(a^num(taggedHash("BIP0340/aux",u))),p=taggedHash("BIP0340/nonce",l,i,s),{bytes:g,scalar:v}=schnorrGetExtPubKey(p),m=challenge(g,i,s),w=new Uint8Array(64);if(w.set(g,0),w.set(r.toBytes(r.create(v+m*a)),32),!schnorrVerify(w,s,i))throw new Error("sign: Invalid signature produced");return w}function schnorrVerify(n,e,t){const{Fn:r,BASE:s}=Pointk1,i=ensureBytes("signature",n,64),a=ensureBytes("message",e),u=ensureBytes("publicKey",t,32);try{const l=lift_x(num(u)),p=num(i.subarray(0,32));if(!inRange(p,_1n,secp256k1_CURVE.p))return!1;const g=num(i.subarray(32,64));if(!inRange(g,_1n,secp256k1_CURVE.n))return!1;const v=challenge(r.toBytes(p),pointToBytes(l),a),m=s.multiplyUnsafe(g).add(l.multiplyUnsafe(r.neg(v))),{x:w,y:T}=m.toAffine();return!(m.is0()||!hasEven(T)||w!==p)}catch{return!1}}const schnorr=(()=>{const t=(s=randomBytes(48))=>mapHashToField(s,secp256k1_CURVE.n);secp256k1.utils.randomSecretKey;function r(s){const i=t(s);return{secretKey:i,publicKey:schnorrGetPublicKey(i)}}return{keygen:r,getPublicKey:schnorrGetPublicKey,sign:schnorrSign,verify:schnorrVerify,Point:Pointk1,utils:{randomSecretKey:t,randomPrivateKey:t,taggedHash,lift_x,pointToBytes,numberToBytesBE,bytesToNumberBE,mod},lengths:{secretKey:32,publicKey:32,publicKeyHasPrefix:!1,signature:32*2,seed:48}}})(),sha256=sha256$1;var __defProp=Object.defineProperty,__getOwnPropDesc=Object.getOwnPropertyDescriptor,__getOwnPropNames=Object.getOwnPropertyNames,__hasOwnProp=Object.prototype.hasOwnProperty,__copyProps=(n,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of __getOwnPropNames(e))!__hasOwnProp.call(n,s)&&s!==t&&__defProp(n,s,{get:()=>e[s],enumerable:!(r=__getOwnPropDesc(e,s))||r.enumerable});return n},__reExport=(n,e,t)=>(__copyProps(n,e,"default"),t);function getRelaysForSync(n,e,t="write"){if(!n.outboxTracker)return;const r=n.outboxTracker.data.get(e);if(r)return t==="write"?r.writeRelays:r.readRelays}async function getWriteRelaysFor(n,e,t="write"){if(n.outboxTracker)return n.outboxTracker.data.has(e)||await n.outboxTracker.trackUsers([e]),getRelaysForSync(n,e,t)}function getTopRelaysForAuthors(n,e){const t=new Map;return e.forEach(s=>{const i=getRelaysForSync(n,s);i&&i.forEach(a=>{const u=t.get(a)||0;t.set(a,u+1)})}),Array.from(t.entries()).sort((s,i)=>i[1]-s[1]).map(s=>s[0])}function getAllRelaysForAllPubkeys(n,e,t="read"){const r=new Map,s=new Set;return e.forEach(i=>{const a=getRelaysForSync(n,i,t);a&&a.size>0?(a.forEach(u=>{(r.get(u)||new Set).add(i)}),r.set(i,a)):s.add(i)}),{pubkeysToRelays:r,authorsMissingRelays:s}}function chooseRelayCombinationForPubkeys(n,e,t,{count:r,preferredRelays:s}={}){r??=2,s??=new Set;const i=n.pool,a=i.connectedRelays();a.forEach(m=>{s?.add(m.url)});const u=new Map,{pubkeysToRelays:l,authorsMissingRelays:p}=getAllRelaysForAllPubkeys(n,e,t),g=getTopRelaysForAuthors(n,e),v=(m,w)=>{const T=u.get(w)||[];T.push(m),u.set(w,T)};for(const[m,w]of l.entries()){let T=r;const P=new Set;for(const W of a)w.has(W.url)&&(v(m,W.url),P.add(W.url),T--);for(const W of w)P.has(W)||u.has(W)&&(v(m,W),P.add(W),T--);if(!(T<=0))for(const W of g){if(T<=0)break;P.has(W)||w.has(W)&&(v(m,W),P.add(W),T--)}}for(const m of p)i.permanentAndConnectedRelays().forEach(w=>{const T=u.get(w.url)||[];T.push(m),u.set(w.url,T)});return u}function normalizeRelayUrl(n){let e=normalizeUrl(n,{stripAuthentication:!1,stripWWW:!1,stripHash:!0});return e.endsWith("/")||(e+="/"),e}var DATA_URL_DEFAULT_MIME_TYPE="text/plain",DATA_URL_DEFAULT_CHARSET="us-ascii",testParameter=(n,e)=>e.some(t=>t instanceof RegExp?t.test(n):t===n),supportedProtocols=new Set(["https:","http:","file:"]),hasCustomProtocol=n=>{try{const{protocol:e}=new URL(n);return e.endsWith(":")&&!e.includes(".")&&!supportedProtocols.has(e)}catch{return!1}},normalizeDataURL=(n,{stripHash:e})=>{const t=/^data:(?<type>[^,]*?),(?<data>[^#]*?)(?:#(?<hash>.*))?$/.exec(n);if(!t)throw new Error(`Invalid URL: ${n}`);const r=t.groups?.type??"",s=t.groups?.data??"";let i=t.groups?.hash??"";const a=r.split(";");i=e?"":i;let u=!1;a[a.length-1]==="base64"&&(a.pop(),u=!0);const l=a.shift()?.toLowerCase()??"",g=[...a.map(v=>{let[m,w=""]=v.split("=").map(T=>T.trim());return m==="charset"&&(w=w.toLowerCase(),w===DATA_URL_DEFAULT_CHARSET)?"":`${m}${w?`=${w}`:""}`}).filter(Boolean)];return u&&g.push("base64"),(g.length>0||l&&l!==DATA_URL_DEFAULT_MIME_TYPE)&&g.unshift(l),`data:${g.join(";")},${u?s.trim():s}${i?`#${i}`:""}`};function normalizeUrl(n,e={}){if(e={defaultProtocol:"http",normalizeProtocol:!0,forceHttp:!1,forceHttps:!1,stripAuthentication:!0,stripHash:!1,stripTextFragment:!0,stripWWW:!0,removeQueryParameters:[/^utm_\w+/i],removeTrailingSlash:!0,removeSingleSlash:!0,removeDirectoryIndex:!1,removeExplicitPort:!1,sortQueryParameters:!0,...e},typeof e.defaultProtocol=="string"&&!e.defaultProtocol.endsWith(":")&&(e.defaultProtocol=`${e.defaultProtocol}:`),n=n.trim(),/^data:/i.test(n))return normalizeDataURL(n,e);if(hasCustomProtocol(n))return n;const t=n.startsWith("//");!t&&/^\.*\//.test(n)||(n=n.replace(/^(?!(?:\w+:)?\/\/)|^\/\//,e.defaultProtocol));const s=new URL(n);if(s.hostname=s.hostname.toLowerCase(),e.forceHttp&&e.forceHttps)throw new Error("The `forceHttp` and `forceHttps` options cannot be used together");if(e.forceHttp&&s.protocol==="https:"&&(s.protocol="http:"),e.forceHttps&&s.protocol==="http:"&&(s.protocol="https:"),e.stripAuthentication&&(s.username="",s.password=""),e.stripHash?s.hash="":e.stripTextFragment&&(s.hash=s.hash.replace(/#?:~:text.*?$/i,"")),s.pathname){const a=/\b[a-z][a-z\d+\-.]{1,50}:\/\//g;let u=0,l="";for(;;){const g=a.exec(s.pathname);if(!g)break;const v=g[0],m=g.index,w=s.pathname.slice(u,m);l+=w.replace(/\/{2,}/g,"/"),l+=v,u=m+v.length}const p=s.pathname.slice(u,s.pathname.length);l+=p.replace(/\/{2,}/g,"/"),s.pathname=l}if(s.pathname)try{s.pathname=decodeURI(s.pathname)}catch{}if(e.removeDirectoryIndex===!0&&(e.removeDirectoryIndex=[/^index\.[a-z]+$/]),Array.isArray(e.removeDirectoryIndex)&&e.removeDirectoryIndex.length>0){let a=s.pathname.split("/");const u=a[a.length-1];testParameter(u,e.removeDirectoryIndex)&&(a=a.slice(0,-1),s.pathname=`${a.slice(1).join("/")}/`)}if(s.hostname&&(s.hostname=s.hostname.replace(/\.$/,""),e.stripWWW&&/^www\.(?!www\.)[a-z\-\d]{1,63}\.[a-z.\-\d]{2,63}$/.test(s.hostname)&&(s.hostname=s.hostname.replace(/^www\./,""))),Array.isArray(e.removeQueryParameters))for(const a of[...s.searchParams.keys()])testParameter(a,e.removeQueryParameters)&&s.searchParams.delete(a);if(!Array.isArray(e.keepQueryParameters)&&e.removeQueryParameters===!0&&(s.search=""),Array.isArray(e.keepQueryParameters)&&e.keepQueryParameters.length>0)for(const a of[...s.searchParams.keys()])testParameter(a,e.keepQueryParameters)||s.searchParams.delete(a);if(e.sortQueryParameters){s.searchParams.sort();try{s.search=decodeURIComponent(s.search)}catch{}}e.removeTrailingSlash&&(s.pathname=s.pathname.replace(/\/$/,"")),e.removeExplicitPort&&s.port&&(s.port="");const i=n;return n=s.toString(),!e.removeSingleSlash&&s.pathname==="/"&&!i.endsWith("/")&&s.hash===""&&(n=n.replace(/\/$/,"")),(e.removeTrailingSlash||s.pathname==="/")&&s.hash===""&&e.removeSingleSlash&&(n=n.replace(/\/$/,"")),t&&!e.normalizeProtocol&&(n=n.replace(/^http:\/\//,"//")),e.stripProtocol&&(n=n.replace(/^(?:https?:)?\/\//,"")),n}var NDKRelayKeepalive=class{constructor(n=3e4,e){this.onSilenceDetected=e,this.timeout=n}lastActivity=Date.now();timer;timeout;isRunning=!1;recordActivity(){this.lastActivity=Date.now(),this.isRunning&&this.resetTimer()}start(){this.isRunning||(this.isRunning=!0,this.lastActivity=Date.now(),this.resetTimer())}stop(){this.isRunning=!1,this.timer&&(clearTimeout(this.timer),this.timer=void 0)}resetTimer(){this.timer&&clearTimeout(this.timer),this.timer=setTimeout(()=>{const n=Date.now()-this.lastActivity;if(n>=this.timeout)this.onSilenceDetected();else{const e=this.timeout-n;this.timer=setTimeout(()=>{this.onSilenceDetected()},e)}},this.timeout)}};async function probeRelayConnection(n){const e=`probe-${Math.random().toString(36).substring(7)}`;return new Promise(t=>{let r=!1;const s=setTimeout(()=>{r||(r=!0,n.send(["CLOSE",e]),t(!1))},5e3),i=()=>{r||(r=!0,clearTimeout(s),n.send(["CLOSE",e]),t(!0))};n.once("message",i),n.send(["REQ",e,{kinds:[99999],limit:0}])})}var MAX_RECONNECT_ATTEMPTS=5,FLAPPING_THRESHOLD_MS=1e3,NDKRelayConnectivity=class{ndkRelay;ws;_status;timeoutMs;connectedAt;_connectionStats={attempts:0,success:0,durations:[]};debug;netDebug;connectTimeout;reconnectTimeout;ndk;openSubs=new Map;openCountRequests=new Map;openEventPublishes=new Map;serial=0;baseEoseTimeout=4400;keepalive;wsStateMonitor;sleepDetector;lastSleepCheck=Date.now();lastMessageSent=Date.now();wasIdle=!1;constructor(n,e){this.ndkRelay=n,this._status=1;const t=Math.floor(Math.random()*1e3);this.debug=this.ndkRelay.debug.extend(`connectivity${t}`),this.ndk=e,this.setupMonitoring()}setupMonitoring(){this.keepalive=new NDKRelayKeepalive(3e4,async()=>{this.debug("Relay silence detected, probing connection"),await probeRelayConnection({send:e=>this.send(JSON.stringify(e)),once:(e,t)=>{const r=s=>{try{const i=JSON.parse(s.data);(i[0]==="EOSE"||i[0]==="EVENT"||i[0]==="NOTICE")&&(t(),this.ws?.removeEventListener("message",r))}catch{}};this.ws?.addEventListener("message",r)}})||(this.debug("Probe failed, connection is stale"),this.handleStaleConnection())}),this.wsStateMonitor=setInterval(()=>{this._status===5&&(!this.ws||this.ws.readyState!==WebSocket.OPEN)&&(this.debug("WebSocket died silently, reconnecting"),this.handleStaleConnection())},5e3),this.sleepDetector=setInterval(()=>{const n=Date.now(),e=n-this.lastSleepCheck;e>15e3&&(this.debug(`Detected possible sleep/wake (${e}ms gap)`),this.handlePossibleWake()),this.lastSleepCheck=n},1e4)}handleStaleConnection(){this._status=1,this.wasIdle=!0,this.onDisconnect()}handlePossibleWake(){this.debug("System wake detected, checking all connections"),this.wasIdle=!0,this._status>=5&&(!this.ws||this.ws.readyState!==WebSocket.OPEN?this.handleStaleConnection():probeRelayConnection({send:n=>this.send(JSON.stringify(n)),once:(n,e)=>{const t=r=>{try{const s=JSON.parse(r.data);(s[0]==="EOSE"||s[0]==="EVENT"||s[0]==="NOTICE")&&(e(),this.ws?.removeEventListener("message",t))}catch{}};this.ws?.addEventListener("message",t)}}).then(n=>{n||this.handleStaleConnection()}))}resetReconnectionState(){this.wasIdle=!0,this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=void 0)}async connect(n,e=!0){if(this.ws&&this.ws.readyState!==WebSocket.OPEN&&this.ws.readyState!==WebSocket.CONNECTING){this.debug("Cleaning up stale WebSocket connection");try{this.ws.close()}catch{}this.ws=void 0,this._status=1}if(this._status!==2&&this._status!==1||this.reconnectTimeout){this.debug("Relay requested to be connected but was in state %s or it had a reconnect timeout",this._status);return}this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=void 0),this.connectTimeout&&(clearTimeout(this.connectTimeout),this.connectTimeout=void 0),n??=this.timeoutMs,!this.timeoutMs&&n&&(this.timeoutMs=n),this.timeoutMs&&(this.connectTimeout=setTimeout(()=>this.onConnectionError(e),this.timeoutMs));try{this.updateConnectionStats.attempt(),this._status===1?this._status=4:this._status=2,this.ws=new WebSocket(this.ndkRelay.url),this.ws.onopen=this.onConnect.bind(this),this.ws.onclose=this.onDisconnect.bind(this),this.ws.onmessage=this.onMessage.bind(this),this.ws.onerror=this.onError.bind(this)}catch(t){throw this.debug(`Failed to connect to ${this.ndkRelay.url}`,t),this._status=1,e?this.handleReconnection():this.ndkRelay.emit("delayed-connect",2*24*60*60*1e3),t}}disconnect(){this._status=0,this.keepalive?.stop(),this.wsStateMonitor&&(clearInterval(this.wsStateMonitor),this.wsStateMonitor=void 0),this.sleepDetector&&(clearInterval(this.sleepDetector),this.sleepDetector=void 0);try{this.ws?.close()}catch(n){this.debug("Failed to disconnect",n),this._status=1}}onConnectionError(n){this.debug(`Error connecting to ${this.ndkRelay.url}`,this.timeoutMs),n&&!this.reconnectTimeout&&this.handleReconnection()}onConnect(){this.netDebug?.("connected",this.ndkRelay),this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=void 0),this.connectTimeout&&(clearTimeout(this.connectTimeout),this.connectTimeout=void 0),this.updateConnectionStats.connected(),this._status=5,this.keepalive?.start(),this.wasIdle=!1,this.ndkRelay.emit("connect"),this.ndkRelay.emit("ready")}onDisconnect(){this.netDebug?.("disconnected",this.ndkRelay),this.updateConnectionStats.disconnected(),this.keepalive?.stop(),this._status===5&&this.handleReconnection(),this._status=1,this.ndkRelay.emit("disconnect")}onMessage(n){this.netDebug?.(n.data,this.ndkRelay,"recv"),this.keepalive?.recordActivity();try{const e=JSON.parse(n.data),[t,r,...s]=e;switch(t){case"EVENT":{const i=this.openSubs.get(r),a=e[2];if(!i){this.debug(`Received event for unknown subscription ${r}`);return}i.onevent(a);return}case"COUNT":{const i=e[2],a=this.openCountRequests.get(r);a&&(a.resolve(i.count),this.openCountRequests.delete(r));return}case"EOSE":{const i=this.openSubs.get(r);if(!i)return;i.oneose(r);return}case"OK":{const i=e[2],a=e[3],u=this.openEventPublishes.get(r),l=u?.pop();if(!u||!l){this.debug("Received OK for unknown event publish",r);return}i?l.resolve(a):l.reject(new Error(a)),u.length===0?this.openEventPublishes.delete(r):this.openEventPublishes.set(r,u);return}case"CLOSED":{const i=this.openSubs.get(r);if(!i)return;i.onclosed(e[2]);return}case"NOTICE":this.onNotice(e[1]);return;case"AUTH":{this.onAuthRequested(e[1]);return}}}catch(e){this.debug(`Error parsing message from ${this.ndkRelay.url}: ${e.message}`,e?.stack);return}}async onAuthRequested(n){const e=this.ndkRelay.authPolicy??this.ndk?.relayAuthDefaultPolicy;if(this.debug("Relay requested authentication",{havePolicy:!!e}),this._status===7){this.debug("Already authenticating, ignoring");return}if(this._status=6,e){if(this._status>=5){this._status=7;let t;try{t=await e(this.ndkRelay,n)}catch(r){this.debug("Authentication policy threw an error",r),t=!1}if(this.debug("Authentication policy returned",!!t),t instanceof NDKEvent||t===!0){t instanceof NDKEvent&&await this.auth(t);const r=async()=>{if(this._status>=5&&this._status<8){const s=new NDKEvent(this.ndk);s.kind=22242,s.tags=[["relay",this.ndkRelay.url],["challenge",n]],await s.sign(),this.auth(s).then(()=>{this._status=8,this.ndkRelay.emit("authed"),this.debug("Authentication successful")}).catch(i=>{this._status=6,this.ndkRelay.emit("auth:failed",i),this.debug("Authentication failed",i)})}else this.debug("Authentication failed, it changed status, status is %d",this._status)};t===!0&&(this.ndk?.signer?r().catch(s=>{console.error("Error authenticating",s)}):(this.debug("No signer available for authentication localhost"),this.ndk?.once("signer:ready",r))),this._status=5,this.ndkRelay.emit("authed")}}}else this.ndkRelay.emit("auth",n)}onError(n){this.debug(`WebSocket error on ${this.ndkRelay.url}:`,n)}get status(){return this._status}isAvailable(){return this._status===5}isFlapping(){const n=this._connectionStats.durations;if(n.length%3!==0)return!1;const t=n.reduce((a,u)=>a+u,0)/n.length,r=n.map(a=>(a-t)**2).reduce((a,u)=>a+u,0)/n.length;return Math.sqrt(r)<FLAPPING_THRESHOLD_MS}async onNotice(n){this.ndkRelay.emit("notice",n)}handleReconnection(n=0){if(this.reconnectTimeout)return;if(this.isFlapping()){this.ndkRelay.emit("flapping",this._connectionStats),this._status=3;return}let e;if(this.wasIdle){const t=[0,1e3,2e3,5e3,1e4,3e4];e=t[Math.min(n,t.length-1)],this.debug(`Using aggressive reconnect after idle, attempt ${n}, delay ${e}ms`)}else this.connectedAt?e=Math.max(0,6e4-(Date.now()-this.connectedAt)):(e=Math.min(1e3*Math.pow(2,n),3e4),this.debug(`Using standard backoff, attempt ${n}, delay ${e}ms`));this.reconnectTimeout=setTimeout(()=>{this.reconnectTimeout=void 0,this._status=2,this.connect().catch(t=>{n<MAX_RECONNECT_ATTEMPTS?this.handleReconnection(n+1):(this.debug("Max reconnect attempts reached"),this.wasIdle=!1)})},e),this.ndkRelay.emit("delayed-connect",e),this.debug("Reconnecting in",e),this._connectionStats.nextReconnectAt=Date.now()+e}async send(n){Date.now()-this.lastMessageSent>12e4&&(this.wasIdle=!0),this._status>=5&&this.ws?.readyState===WebSocket.OPEN?(this.ws?.send(n),this.netDebug?.(n,this.ndkRelay,"send"),this.lastMessageSent=Date.now()):(this.debug(`Not connected to ${this.ndkRelay.url} (%d), not sending message ${n}`,this._status),this._status>=5&&this.ws?.readyState!==WebSocket.OPEN&&(this.debug(`Stale connection detected, WebSocket state: ${this.ws?.readyState}`),this.handleStaleConnection()))}async auth(n){const e=new Promise((t,r)=>{const s=this.openEventPublishes.get(n.id)??[];s.push({resolve:t,reject:r}),this.openEventPublishes.set(n.id,s)});return this.send(`["AUTH",${JSON.stringify(n.rawEvent())}]`),e}async publish(n){const e=new Promise((t,r)=>{const s=this.openEventPublishes.get(n.id)??[];s.length>0&&console.warn(`Duplicate event publishing detected, you are publishing event ${n.id} twice`),s.push({resolve:t,reject:r}),this.openEventPublishes.set(n.id,s)});return this.send(`["EVENT",${JSON.stringify(n)}]`),e}async count(n,e){this.serial++;const t=e?.id||`count:${this.serial}`,r=new Promise((s,i)=>{this.openCountRequests.set(t,{resolve:s,reject:i})});return this.send(`["COUNT","${t}",${JSON.stringify(n).substring(1)}`),r}close(n,e){this.send(`["CLOSE","${n}"]`);const t=this.openSubs.get(n);this.openSubs.delete(n),t&&t.onclose(e)}req(n){`${this.send(`["REQ","${n.subId}",${JSON.stringify(n.executeFilters).substring(1)}`)}`,this.openSubs.set(n.subId,n)}updateConnectionStats={connected:()=>{this._connectionStats.success++,this._connectionStats.connectedAt=Date.now()},disconnected:()=>{this._connectionStats.connectedAt&&(this._connectionStats.durations.push(Date.now()-this._connectionStats.connectedAt),this._connectionStats.durations.length>100&&this._connectionStats.durations.shift()),this._connectionStats.connectedAt=void 0},attempt:()=>{this._connectionStats.attempts++,this._connectionStats.connectedAt=Date.now()}};get connectionStats(){return this._connectionStats}get url(){return this.ndkRelay.url}get connected(){return this._status>=5&&this.ws?.readyState===WebSocket.OPEN}},NDKRelayPublisher=class{ndkRelay;debug;constructor(n){this.ndkRelay=n,this.debug=n.debug.extend("publisher")}async publish(n,e=2500){let t;const r=()=>new Promise((g,v)=>{try{this.publishEvent(n).then(m=>{this.ndkRelay.emit("published",n),n.emit("relay:published",this.ndkRelay),g(!0)}).catch(v)}catch(m){v(m)}}),s=new Promise((g,v)=>{t=setTimeout(()=>{t=void 0,v(new Error(`Timeout: ${e}ms`))},e)}),i=()=>{r().then(g=>a(g)).catch(g=>u(g))};let a,u;const l=g=>{throw this.ndkRelay.debug("Publish failed",g,n.id),this.ndkRelay.emit("publish:failed",n,g),n.emit("relay:publish:failed",this.ndkRelay,g),g},p=()=>{t&&clearTimeout(t),this.ndkRelay.removeListener("connect",i)};return this.ndkRelay.status>=5?Promise.race([r(),s]).catch(l).finally(p):(this.ndkRelay.status<=1?(console.warn("Relay is disconnected, trying to connect to publish an event",this.ndkRelay.url),this.ndkRelay.connect()):console.warn("Relay not connected, waiting for connection to publish an event",this.ndkRelay.url),Promise.race([new Promise((g,v)=>{a=g,u=v,this.ndkRelay.on("connect",i)}),s]).catch(l).finally(p))}async publishEvent(n){return this.ndkRelay.connectivity.publish(n.rawEvent())}};function filterFingerprint(n,e){const t=[];for(const s of n){const i=Object.entries(s||{}).map(([a,u])=>["since","until"].includes(a)?`${a}:${u}`:a).sort().join("-");t.push(i)}let r=e?"+":"";return r+=t.join("|"),r}function mergeFilters(n){const e=[],t={};return n.filter(r=>!!r.limit).forEach(r=>e.push(r)),n=n.filter(r=>!r.limit),n.length===0?e:(n.forEach(r=>{Object.entries(r).forEach(([s,i])=>{Array.isArray(i)?t[s]===void 0?t[s]=[...i]:t[s]=Array.from(new Set([...t[s],...i])):t[s]=i})}),[...e,t])}var NDKRelaySubscription=class{fingerprint;items=new Map;topSubManager;debug;status=0;onClose;relay;eosed=!1;executionTimer;fireTime;delayType;executeFilters;id=Math.random().toString(36).substring(7);constructor(n,e,t){this.relay=n,this.topSubManager=t,this.debug=n.debug.extend(`sub[${this.id}]`),this.fingerprint=e||Math.random().toString(36).substring(7)}_subId;get subId(){return this._subId?this._subId:(this._subId=this.fingerprint.slice(0,15),this._subId)}subIdParts=new Set;addSubIdPart(n){this.subIdParts.add(n)}addItem(n,e){if(this.debug("Adding item",{filters:e,internalId:n.internalId,status:this.status,fingerprint:this.fingerprint,id:this.subId,items:this.items,itemsSize:this.items.size}),!this.items.has(n.internalId))switch(n.on("close",this.removeItem.bind(this,n)),this.items.set(n.internalId,{subscription:n,filters:e}),this.status!==3&&n.subId&&(!this._subId||this._subId.length<48)&&(this.status===0||this.status===1)&&this.addSubIdPart(n.subId),this.status){case 0:this.evaluateExecutionPlan(n);break;case 3:break;case 1:this.evaluateExecutionPlan(n);break;case 4:throw this.debug("Subscription is closed, cannot add new items %o (%o)",n,e),new Error("Cannot add new items to a closed subscription")}}removeItem(n){if(this.items.delete(n.internalId),this.items.size===0){if(!this.eosed)return;this.close(),this.cleanup()}}close(){if(this.status===4)return;const n=this.status;if(this.status=4,n===3)try{this.relay.close(this.subId)}catch(e){this.debug("Error closing subscription",e,this)}else this.debug("Subscription wanted to close but it wasn't running, this is probably ok",{subId:this.subId,prevStatus:n,sub:this});this.cleanup()}cleanup(){this.executionTimer&&clearTimeout(this.executionTimer),this.relay.off("ready",this.executeOnRelayReady),this.relay.off("authed",this.reExecuteAfterAuth),this.onClose&&this.onClose(this)}evaluateExecutionPlan(n){if(!n.isGroupable()){this.status=1,this.execute();return}if(n.filters.find(r=>!!r.limit)&&(this.executeFilters=this.compileFilters(),this.executeFilters.length>=10)){this.status=1,this.execute();return}const e=n.groupableDelay,t=n.groupableDelayType;if(!e)throw new Error("Cannot group a subscription without a delay");if(this.status===0)this.schedule(e,t);else{const r=this.delayType,s=this.fireTime-Date.now();if(r==="at-least"&&t==="at-least")s<e&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(e,t));else if(r==="at-least"&&t==="at-most")s>e&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(e,t));else if(r==="at-most"&&t==="at-most")s>e&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(e,t));else if(r==="at-most"&&t==="at-least")s>e&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(e,t));else throw new Error(`Unknown delay type combination ${r} ${t}`)}}schedule(n,e){this.status=1;const t=Date.now();this.fireTime=t+n,this.delayType=e;const r=setTimeout(this.execute.bind(this),n);e==="at-least"&&(this.executionTimer=r)}executeOnRelayReady=()=>{if(this.status===2){if(this.items.size===0){this.debug("No items to execute; this relay was probably too slow to respond and the caller gave up",{status:this.status,fingerprint:this.fingerprint,items:this.items,itemsSize:this.items.size,id:this.id,subId:this.subId}),this.cleanup();return}this.debug("Executing on relay ready",{status:this.status,fingerprint:this.fingerprint,items:this.items,itemsSize:this.items.size}),this.status=1,this.execute()}};finalizeSubId(){this.subIdParts.size>0?this._subId=Array.from(this.subIdParts).join("-"):this._subId=this.fingerprint.slice(0,15),this._subId+=`-${Math.random().toString(36).substring(2,7)}`}reExecuteAfterAuth=(()=>{const n=this.subId;this.debug("Re-executing after auth",this.items.size),this.eosed?this.relay.close(this.subId):this.debug("We are abandoning an opened subscription, once it EOSE's, the handler will close it",{oldSubId:n}),this._subId=void 0,this.status=1,this.execute(),this.debug("Re-executed after auth %s  %s",n,this.subId)}).bind(this);execute(){if(this.status===1){if(!this.relay.connected){this.status=2,this.debug("Waiting for relay to be ready",{status:this.status,id:this.subId,fingerprint:this.fingerprint,items:this.items,itemsSize:this.items.size}),this.relay.once("ready",this.executeOnRelayReady);return}this.relay.status<8&&this.relay.once("authed",this.reExecuteAfterAuth),this.status=3,this.finalizeSubId(),this.executeFilters=this.compileFilters(),this.relay.req(this)}}onstart(){}onevent(n){this.topSubManager.dispatchEvent(n,this.relay)}oneose(n){if(this.eosed=!0,n!==this.subId){this.debug("Received EOSE for an abandoned subscription",n,this.subId),this.relay.close(n);return}this.items.size===0&&this.close();for(const{subscription:e}of this.items.values())e.eoseReceived(this.relay),e.closeOnEose&&(this.debug("Removing item because of EOSE",{filters:e.filters,internalId:e.internalId,status:this.status,fingerprint:this.fingerprint,items:this.items,itemsSize:this.items.size}),this.removeItem(e))}onclose(n){this.status=4}onclosed(n){if(n)for(const{subscription:e}of this.items.values())e.closedReceived(this.relay,n)}compileFilters(){const n=[],e=Array.from(this.items.values()).map(r=>r.filters);if(!e[0])return this.debug(" No filters to merge",this.items),console.error("BUG: No filters to merge!",this.items),[];const t=e[0].length;for(let r=0;r<t;r++){const s=e.map(i=>i[r]);n.push(...mergeFilters(s))}return n}},NDKRelaySubscriptionManager=class{relay;subscriptions;generalSubManager;constructor(n,e){this.relay=n,this.subscriptions=new Map,this.generalSubManager=e}addSubscription(n,e){let t;if(!n.isGroupable())t=this.createSubscription(n,e);else{const r=filterFingerprint(e,n.closeOnEose);r&&(t=(this.subscriptions.get(r)||[]).find(i=>i.status<3)),t??=this.createSubscription(n,e,r)}t.addItem(n,e)}createSubscription(n,e,t){const r=new NDKRelaySubscription(this.relay,t||null,this.generalSubManager);r.onClose=this.onRelaySubscriptionClose.bind(this);const s=this.subscriptions.get(r.fingerprint)??[];return this.subscriptions.set(r.fingerprint,[...s,r]),r}onRelaySubscriptionClose(n){let e=this.subscriptions.get(n.fingerprint)??[];e?e.length===1?this.subscriptions.delete(n.fingerprint):(e=e.filter(t=>t.id!==n.id),this.subscriptions.set(n.fingerprint,e)):console.warn("Unexpectedly did not find a subscription with fingerprint",n.fingerprint)}},NDKRelay=class ps extends lib$1.EventEmitter{url;scores;connectivity;subs;publisher;authPolicy;lowestValidationRatio;targetValidationRatio;validationRatioFn;validatedEventCount=0;nonValidatedEventCount=0;trusted=!1;complaining=!1;debug;static defaultValidationRatioUpdateFn=(e,t,r)=>{if(e.lowestValidationRatio===void 0||e.targetValidationRatio===void 0)return 1;let s=e.validationRatio;if(e.validationRatio>e.targetValidationRatio){const i=t/100;s=Math.max(e.lowestValidationRatio,e.validationRatio-i)}return s<e.validationRatio?s:e.validationRatio};constructor(e,t,r){super(),this.url=normalizeRelayUrl(e),this.scores=new Map,this.debug=createDebug2(`ndk:relay:${e}`),this.connectivity=new NDKRelayConnectivity(this,r),this.connectivity.netDebug=r?.netDebug,this.req=this.connectivity.req.bind(this.connectivity),this.close=this.connectivity.close.bind(this.connectivity),this.subs=new NDKRelaySubscriptionManager(this,r.subManager),this.publisher=new NDKRelayPublisher(this),this.authPolicy=t,this.targetValidationRatio=r?.initialValidationRatio,this.lowestValidationRatio=r?.lowestValidationRatio,this.validationRatioFn=(r?.validationRatioFn??ps.defaultValidationRatioUpdateFn).bind(this),this.updateValidationRatio(),r||console.trace("relay created without ndk")}updateValidationRatio(){if(this.validationRatioFn&&this.validatedEventCount>0){const e=this.validationRatioFn(this,this.validatedEventCount,this.nonValidatedEventCount);this.targetValidationRatio=e}setTimeout(()=>{this.updateValidationRatio()},3e4)}get status(){return this.connectivity.status}get connectionStats(){return this.connectivity.connectionStats}async connect(e,t=!0){return this.connectivity.connect(e,t)}disconnect(){this.status!==1&&this.connectivity.disconnect()}subscribe(e,t){this.subs.addSubscription(e,t)}async publish(e,t=2500){return this.publisher.publish(e,t)}referenceTags(){return[["r",this.url]]}addValidatedEvent(){this.validatedEventCount++}addNonValidatedEvent(){this.nonValidatedEventCount++}get validationRatio(){return this.nonValidatedEventCount===0?1:this.validatedEventCount/(this.validatedEventCount+this.nonValidatedEventCount)}shouldValidateEvent(){return this.trusted?!1:this.targetValidationRatio===void 0||this.targetValidationRatio>=1?!0:Math.random()<this.targetValidationRatio}get connected(){return this.connectivity.connected}req;close},NDKPublishError=class extends Error{errors;publishedToRelays;intendedRelaySet;constructor(n,e,t,r){super(n),this.errors=e,this.publishedToRelays=t,this.intendedRelaySet=r}get relayErrors(){const n=[];for(const[e,t]of this.errors)n.push(`${e.url}: ${t}`);return n.join(`
`)}},NDKRelaySet=class ys{relays;debug;ndk;pool;constructor(e,t,r){this.relays=e,this.ndk=t,this.pool=r??t.pool,this.debug=t.debug.extend("relayset")}addRelay(e){this.relays.add(e)}get relayUrls(){return Array.from(this.relays).map(e=>e.url)}static fromRelayUrls(e,t,r=!0,s){if(s=s??t.pool,!s)throw new Error("No pool provided");const i=new Set;for(const a of e){const u=s.relays.get(normalizeRelayUrl(a));if(u)u.status<5&&r&&u.connect(),i.add(u);else{const l=new NDKRelay(normalizeRelayUrl(a),t?.relayAuthDefaultPolicy,t);s.useTemporaryRelay(l,void 0,`requested from fromRelayUrls ${e}`),i.add(l)}}return new ys(new Set(i),t,s)}async publish(e,t,r=1){const s=new Set,i=new Map,a=e.isEphemeral();e.publishStatus="pending";const u=l=>{s.add(l)};e.on("relay:published",u);try{const l=Array.from(this.relays).map(p=>new Promise(g=>{const v=t?setTimeout(()=>{s.has(p)||(i.set(p,new Error(`Publish timeout after ${t}ms`)),g(!1))},t):null;p.publish(e,t).then(m=>{v&&clearTimeout(v),m?(s.add(p),g(!0)):g(!1)}).catch(m=>{v&&clearTimeout(v),a||i.set(p,m),g(!1)})}));if(await Promise.all(l),s.size<r){if(!a){const p=new NDKPublishError("Not enough relays received the event ("+s.size+" published, "+r+" required)",i,s,this);throw e.publishStatus="error",e.publishError=p,this.ndk?.emit("event:publish-failed",e,p,this.relayUrls),p}}else e.publishStatus="success",e.emit("published",{relaySet:this,publishedToRelays:s});return s}finally{e.off("relay:published",u)}}get size(){return this.relays.size}},d$1=createDebug2("ndk:outbox:calculate");async function calculateRelaySetFromEvent(n,e,t){const r=new Set,s=await getWriteRelaysFor(n,e.pubkey);s&&s.forEach(u=>{const l=n.pool?.getRelay(u);l&&r.add(l)});let i=e.tags.filter(u=>["a","e"].includes(u[0])).map(u=>u[2]).filter(u=>u?.startsWith("wss://")).filter(u=>{try{return new URL(u),!0}catch{return!1}}).map(u=>normalizeRelayUrl(u));i=Array.from(new Set(i)).slice(0,5),i.forEach(u=>{const l=n.pool?.getRelay(u,!0,!0);l&&(d$1("Adding relay hint %s",u),r.add(l))});const a=e.getMatchingTags("p").map(u=>u[1]);return a.length<5?Array.from(chooseRelayCombinationForPubkeys(n,a,"read",{preferredRelays:new Set(s)}).keys()).forEach(l=>{const p=n.pool?.getRelay(l,!1,!0);p&&(d$1("Adding p-tagged relay %s",l),r.add(p))}):d$1("Too many p-tags to consider %d",a.length),n.pool?.permanentAndConnectedRelays().forEach(u=>r.add(u)),t&&r.size<t&&n.explicitRelayUrls?.filter(l=>!Array.from(r).some(p=>p.url===l)).slice(0,t-r.size)?.forEach(l=>{const p=n.pool?.getRelay(l,!1,!0);p&&(d$1("Adding explicit relay %s",l),r.add(p))}),new NDKRelaySet(r,n)}function mergeTags(n,e){const t=new Map,r=a=>a.join(","),s=(a,u)=>a.every((l,p)=>l===u[p]),i=a=>{for(const[u,l]of t)if(s(l,a)||s(a,l)){a.length>=l.length&&t.set(u,a);return}t.set(r(a),a)};return n.concat(e).forEach(i),Array.from(t.values())}var hashtagRegex=/(?<=\s|^)(#[^\s!@#$%^&*()=+./,[{\]};:'"?><]+)/g;function generateHashtags(n){const e=n.match(hashtagRegex),t=new Set,r=new Set;if(e)for(const s of e)t.has(s.slice(1))||(r.add(s.slice(1)),t.add(s.slice(1)));return Array.from(r)}async function generateContentTags(n,e=[],t,r){if(t?.skipContentTagging)return{content:n,tags:e};const s=/(@|nostr:)(npub|nprofile|note|nevent|naddr)[a-zA-Z0-9]+/g,i=[],a=u=>{e.find(l=>["q",u[0]].includes(l[0])&&l[1]===u[1])||e.push(u)};if(n=n.replace(s,u=>{try{const l=u.split(/(@|nostr:)/)[2],{type:p,data:g}=nip19_exports$2.decode(l);let v;if(t?.filters){const m=!t.filters.includeTypes||t.filters.includeTypes.includes(p),w=t.filters.excludeTypes?.includes(p);if(!m||w)return u}switch(p){case"npub":t?.pTags!==!1&&(v=["p",g]);break;case"nprofile":t?.pTags!==!1&&(v=["p",g.pubkey]);break;case"note":i.push(new Promise(async m=>{const w=await maybeGetEventRelayUrl(l);a(["q",g,w]),m()}));break;case"nevent":i.push(new Promise(async m=>{const{id:w,author:T}=g;let{relays:P}=g;(!P||P.length===0)&&(P=[await maybeGetEventRelayUrl(l)]),a(["q",w,P[0]]),T&&t?.pTags!==!1&&t?.pTagOnQTags!==!1&&a(["p",T]),m()}));break;case"naddr":i.push(new Promise(async m=>{const w=[g.kind,g.pubkey,g.identifier].join(":");let T=g.relays??[];T.length===0&&(T=[await maybeGetEventRelayUrl(l)]),a(["q",w,T[0]]),t?.pTags!==!1&&t?.pTagOnQTags!==!1&&t?.pTagOnATags!==!1&&a(["p",g.pubkey]),m()}));break;default:return u}return v&&a(v),`nostr:${l}`}catch{return u}}),await Promise.all(i),!t?.filters?.excludeTypes?.includes("hashtag")){const u=generateHashtags(n).map(l=>["t",l]);e=mergeTags(e,u)}if(t?.pTags!==!1&&t?.copyPTagsFromTarget&&r){const u=r.getMatchingTags("p");for(const l of u)e.find(p=>p[0]==="p"&&p[1]===l[1])||e.push(l)}return{content:n,tags:e}}async function maybeGetEventRelayUrl(n){return""}async function encrypt(n,e,t="nip44"){let r;if(!this.ndk)throw new Error("No NDK instance found!");let s=e;if(s||(this.ndk.assertSigner(),s=this.ndk.signer),!s)throw new Error("no NDK signer");const i=n||(()=>{const a=this.getMatchingTags("p");if(a.length!==1)throw new Error("No recipient could be determined and no explicit recipient was provided");return this.ndk.getUser({pubkey:a[0][1]})})();if(t==="nip44"&&await isEncryptionEnabled(s,"nip44")&&(r=await s.encrypt(i,this.content,"nip44")),(!r||t==="nip04")&&await isEncryptionEnabled(s,"nip04")&&(r=await s.encrypt(i,this.content,"nip04")),!r)throw new Error("Failed to encrypt event.");this.content=r}async function decrypt(n,e,t){if(this.ndk?.cacheAdapter?.getDecryptedEvent){let u=null;if(typeof this.ndk.cacheAdapter.getDecryptedEvent=="function"&&(u=this.ndk.cacheAdapter.getDecryptedEvent(this.id)),u){this.content=u.content;return}}let r;if(!this.ndk)throw new Error("No NDK instance found!");let s=e;if(s||(this.ndk.assertSigner(),s=this.ndk.signer),!s)throw new Error("no NDK signer");const i=n||this.author;if(!i)throw new Error("No sender provided and no author available");const a=t||(this.content.match(/\\?iv=/)?"nip04":"nip44");if((a==="nip04"||this.kind===4)&&await isEncryptionEnabled(s,"nip04")&&this.content.search("\\?iv=")&&(r=await s.decrypt(i,this.content,"nip04")),!r&&a==="nip44"&&await isEncryptionEnabled(s,"nip44")&&(r=await s.decrypt(i,this.content,"nip44")),!r)throw new Error("Failed to decrypt event.");this.content=r,this.ndk?.cacheAdapter?.addDecryptedEvent&&this.ndk.cacheAdapter.addDecryptedEvent(this)}async function isEncryptionEnabled(n,e){return n.encryptionEnabled?e?!!await n.encryptionEnabled(e):!0:!1}function eventHasETagMarkers(n){for(const e of n.tags)if(e[0]==="e"&&(e[3]??"").length>0)return!0;return!1}function getRootTag(n,e){e??=n.tagType();const t=n.tags.find(isTagRootTag);if(!t){if(eventHasETagMarkers(n))return;const r=n.getMatchingTags(e);if(r.length<3)return r[0]}return t}var nip22RootTags=new Set(["A","E","I"]),nip22ReplyTags=new Set(["a","e","i"]);function getReplyTag(n,e){if(n.kind===1111){let s;for(const i of n.tags)if(nip22RootTags.has(i[0]))s=i;else if(nip22ReplyTags.has(i[0])){s=i;break}return s}e??=n.tagType();let t=!1,r;for(const s of n.tags)if(s[0]===e){if((s[3]??"").length>0&&(t=!0),t&&s[3]==="reply")return s;t&&s[3]==="root"&&(r=s),t||(r=s)}return r}function isTagRootTag(n){return n[0]==="E"||n[3]==="root"}async function fetchTaggedEvent(n,e){if(!this.ndk)throw new Error("NDK instance not found");const t=this.getMatchingTags(n,e);if(t.length===0)return;const[r,s,i]=t[0];let a=i!==""?this.ndk.pool.getRelay(i):void 0;return await this.ndk.fetchEvent(s,{},a)}async function fetchRootEvent(n){if(!this.ndk)throw new Error("NDK instance not found");const e=getRootTag(this);if(e)return this.ndk.fetchEventFromTag(e,this,n)}async function fetchReplyEvent(n){if(!this.ndk)throw new Error("NDK instance not found");const e=getReplyTag(this);if(e)return this.ndk.fetchEventFromTag(e,this,n)}function isReplaceable(){if(this.kind===void 0)throw new Error("Kind not set");return[0,3].includes(this.kind)||this.kind>=1e4&&this.kind<2e4||this.kind>=3e4&&this.kind<4e4}function isEphemeral(){if(this.kind===void 0)throw new Error("Kind not set");return this.kind>=2e4&&this.kind<3e4}function isParamReplaceable(){if(this.kind===void 0)throw new Error("Kind not set");return this.kind>=3e4&&this.kind<4e4}var DEFAULT_RELAY_COUNT=2;function encode(n=DEFAULT_RELAY_COUNT){let e=[];return this.onRelays.length>0?e=this.onRelays.map(t=>t.url):this.relay&&(e=[this.relay.url]),e.length>n&&(e=e.slice(0,n)),this.isParamReplaceable()?nip19_exports$2.naddrEncode({kind:this.kind,pubkey:this.pubkey,identifier:this.replaceableDTag(),relays:e}):e.length>0?nip19_exports$2.neventEncode({id:this.tagId(),relays:e,author:this.pubkey}):nip19_exports$2.noteEncode(this.tagId())}async function repost(n=!0,e){if(!e&&n){if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner(),e=this.ndk.signer}const t=new NDKEvent(this.ndk,{kind:getKind(this)});return this.isProtected||(t.content=JSON.stringify(this.rawEvent())),t.tag(this),this.kind!==1&&t.tags.push(["k",`${this.kind}`]),e&&await t.sign(e),n&&await t.publish(),t}function getKind(n){return n.kind===1?6:16}function serialize(n=!1,e=!1){const t=[0,this.pubkey,this.created_at,this.kind,this.tags,this.content];return n&&t.push(this.sig),e&&t.push(this.id),JSON.stringify(t)}function deserialize(n){const e=JSON.parse(n),t={pubkey:e[1],created_at:e[2],kind:e[3],tags:e[4],content:e[5]};if(e.length>=7){const r=e[6],s=e[7];r&&r.length===128?(t.sig=r,s&&s.length===64&&(t.id=s)):r&&r.length===64&&(t.id=r,s&&s.length===128&&(t.sig=s))}return t}var processingQueue={};async function verifySignatureAsync(n,e,t){const r=n.ndk,s=Date.now();let i;return r.signatureVerificationFunction?(console.log("[NDK-CORE] Using custom signature verification function async"),i=await r.signatureVerificationFunction(n),console.log("Custom signature verification result",n.id,{result:i})):(console.log("Using worker-based signature verification async"),i=await new Promise(a=>{n.serialize();let u=!1;processingQueue[n.id]||(processingQueue[n.id]={event:n,resolves:[],relay:t},u=!0),processingQueue[n.id].resolves.push(a)})),r.signatureVerificationTimeMs+=Date.now()-s,i}var PUBKEY_REGEX=/^[a-f0-9]{64}$/;function validate(){if(typeof this.kind!="number"||typeof this.content!="string"||typeof this.created_at!="number"||typeof this.pubkey!="string"||!this.pubkey.match(PUBKEY_REGEX)||!Array.isArray(this.tags))return!1;for(let n=0;n<this.tags.length;n++){const e=this.tags[n];if(!Array.isArray(e))return!1;for(let t=0;t<e.length;t++)if(typeof e[t]=="object")return!1}return!0}var verifiedSignatures=new dist.LRUCache({maxSize:1e3,entryExpirationTimeInMS:6e4});function verifySignature(n){if(typeof this.signatureVerified=="boolean")return this.signatureVerified;const e=verifiedSignatures.get(this.id);if(e!==null)return this.signatureVerified=!!e,this.signatureVerified;try{if(this.ndk?.asyncSigVerification)verifySignatureAsync(this,n,this.relay).then(t=>{n&&(this.signatureVerified=t,t&&verifiedSignatures.set(this.id,this.sig)),t||(this.relay?this.ndk?.reportInvalidSignature(this,this.relay):this.ndk?.reportInvalidSignature(this),verifiedSignatures.set(this.id,!1))}).catch(t=>{console.error("signature verification error",this.id,t)});else{const t=sha256(new TextEncoder().encode(this.serialize())),r=schnorr.verify(this.sig,t,this.pubkey);return r?verifiedSignatures.set(this.id,this.sig):verifiedSignatures.set(this.id,!1),this.signatureVerified=r,r}}catch{return this.signatureVerified=!1,!1}}function getEventHash(){return getEventHashFromSerializedEvent(this.serialize())}function getEventHashFromSerializedEvent(n){const e=sha256(new TextEncoder().encode(n));return bytesToHex(e)}var skipClientTagOnKinds=new Set([0,4,1059,13,3,9734,5]),NDKEvent=class mt extends lib$1.EventEmitter{ndk;created_at;content="";tags=[];kind;id="";sig;pubkey="";signatureVerified;_author=void 0;relay;get onRelays(){let e=[];return this.ndk?e=this.ndk.subManager.seenEvents.get(this.id)||[]:this.relay&&e.push(this.relay),e}publishStatus="success";publishError;constructor(e,t){super(),this.ndk=e,this.created_at=t?.created_at,this.content=t?.content||"",this.tags=t?.tags||[],this.id=t?.id||"",this.sig=t?.sig,this.pubkey=t?.pubkey||"",this.kind=t?.kind,t instanceof mt&&(this.relay&&(this.relay=t.relay,this.ndk?.subManager.seenEvent(t.id,this.relay)),this.publishStatus=t.publishStatus,this.publishError=t.publishError)}static deserialize(e,t){return new mt(e,deserialize(t))}rawEvent(){return{created_at:this.created_at,content:this.content,tags:this.tags,kind:this.kind,pubkey:this.pubkey,id:this.id,sig:this.sig}}set author(e){this.pubkey=e.pubkey,this._author=e,this._author.ndk??=this.ndk}get author(){if(this._author)return this._author;if(!this.ndk)throw new Error("No NDK instance found");const e=this.ndk.getUser({pubkey:this.pubkey});return this._author=e,e}tagExternal(e,t,r){const s=["i"],i=["k"];switch(t){case"url":{const a=new URL(e);a.hash="",s.push(a.toString()),i.push(`${a.protocol}//${a.host}`);break}case"hashtag":s.push(`#${e.toLowerCase()}`),i.push("#");break;case"geohash":s.push(`geo:${e.toLowerCase()}`),i.push("geo");break;case"isbn":s.push(`isbn:${e.replace(/-/g,"")}`),i.push("isbn");break;case"podcast:guid":s.push(`podcast:guid:${e}`),i.push("podcast:guid");break;case"podcast:item:guid":s.push(`podcast:item:guid:${e}`),i.push("podcast:item:guid");break;case"podcast:publisher:guid":s.push(`podcast:publisher:guid:${e}`),i.push("podcast:publisher:guid");break;case"isan":s.push(`isan:${e.split("-").slice(0,4).join("-")}`),i.push("isan");break;case"doi":s.push(`doi:${e.toLowerCase()}`),i.push("doi");break;default:throw new Error(`Unsupported NIP-73 entity type: ${t}`)}r&&s.push(r),this.tags.push(s),this.tags.push(i)}tag(e,t,r,s,i){let a=[];if(e.fetchProfile!==void 0){if(s??="p",s==="p"&&i?.pTags===!1)return;const l=[s,e.pubkey];t&&l.push("",t),a.push(l)}else if(e instanceof mt){const l=e;if(r??=l?.pubkey===this.pubkey,a=l.referenceTags(t,r,s,i),i?.pTags!==!1)for(const p of l.getMatchingTags("p"))p[1]!==this.pubkey&&(this.tags.find(g=>g[0]==="p"&&g[1]===p[1])||this.tags.push(["p",p[1]]))}else if(Array.isArray(e))a=[e];else throw new Error("Invalid argument",e);this.tags=mergeTags(this.tags,a)}async toNostrEvent(e,t){if(!e&&this.pubkey===""){const i=await this.ndk?.signer?.user();this.pubkey=i?.pubkey||""}this.created_at||(this.created_at=Math.floor(Date.now()/1e3));const{content:r,tags:s}=await this.generateTags(t);this.content=r||"",this.tags=s;try{this.id=this.getEventHash()}catch{}return this.rawEvent()}serialize=serialize.bind(this);getEventHash=getEventHash.bind(this);validate=validate.bind(this);verifySignature=verifySignature.bind(this);isReplaceable=isReplaceable.bind(this);isEphemeral=isEphemeral.bind(this);isDvm=()=>this.kind&&this.kind>=5e3&&this.kind<=7e3;isParamReplaceable=isParamReplaceable.bind(this);encode=encode.bind(this);encrypt=encrypt.bind(this);decrypt=decrypt.bind(this);getMatchingTags(e,t){const r=this.tags.filter(s=>s[0]===e);return t===void 0?r:r.filter(s=>s[3]===t)}hasTag(e,t){return this.tags.some(r=>r[0]===e&&(!t||r[3]===t))}tagValue(e,t){const r=this.getMatchingTags(e,t);if(r.length!==0)return r[0][1]}get alt(){return this.tagValue("alt")}set alt(e){this.removeTag("alt"),e&&this.tags.push(["alt",e])}get dTag(){return this.tagValue("d")}set dTag(e){this.removeTag("d"),e&&this.tags.push(["d",e])}removeTag(e,t){const r=Array.isArray(e)?e:[e];this.tags=this.tags.filter(s=>{const i=r.includes(s[0]),a=t?s[3]===t:!0;return!(i&&a)})}replaceTag(e){this.removeTag(e[0]),this.tags.push(e)}async sign(e,t){e?this.author=await e.user():(this.ndk?.assertSigner(),e=this.ndk?.signer);const r=await this.toNostrEvent(void 0,t);return this.sig=await e.sign(r),this.sig}async publishReplaceable(e,t,r){return this.id="",this.created_at=Math.floor(Date.now()/1e3),this.sig="",this.publish(e,t,r)}async publish(e,t,r,s){if(r||(r=1),this.sig||await this.sign(void 0,s),!this.ndk)throw new Error("NDKEvent must be associated with an NDK instance to publish");if((!e||e.size===0)&&(e=this.ndk.devWriteRelaySet||await calculateRelaySetFromEvent(this.ndk,this,r)),this.kind===5&&this.ndk.cacheAdapter?.deleteEventIds){const u=this.getMatchingTags("e").map(l=>l[1]);this.ndk.cacheAdapter.deleteEventIds(u)}const i=this.rawEvent();if(this.ndk.cacheAdapter?.addUnpublishedEvent&&shouldTrackUnpublishedEvent(this))try{this.ndk.cacheAdapter.addUnpublishedEvent(this,e.relayUrls)}catch(u){console.error("Error adding unpublished event to cache",u)}this.kind===5&&this.ndk.cacheAdapter?.deleteEventIds&&this.ndk.cacheAdapter.deleteEventIds(this.getMatchingTags("e").map(u=>u[1])),this.ndk.subManager.dispatchEvent(i,void 0,!0);const a=await e.publish(this,t,r);return a.forEach(u=>this.ndk?.subManager.seenEvent(this.id,u)),a}async generateTags(e){let t=[];const r=await generateContentTags(this.content,this.tags,e,this),s=r.content;if(t=r.tags,this.kind&&this.isParamReplaceable()&&!this.getMatchingTags("d")[0]){const a=this.tagValue("title");let l=[...Array(a?6:16)].map(()=>Math.random().toString(36)[2]).join("");a&&a.length>0&&(l=`${a.replace(/[^a-z0-9]+/gi,"-").replace(/^-|-$/g,"")}-${l}`),t.push(["d",l])}if(this.shouldAddClientTag){const i=["client",this.ndk?.clientName??""];this.ndk?.clientNip89&&i.push(this.ndk?.clientNip89),t.push(i)}else this.shouldStripClientTag&&(t=t.filter(i=>i[0]!=="client"));return{content:s||"",tags:t}}get shouldAddClientTag(){return!(!this.ndk?.clientName&&!this.ndk?.clientNip89||skipClientTagOnKinds.has(this.kind)||this.isEphemeral()||this.isReplaceable()&&!this.isParamReplaceable()||this.isDvm()||this.hasTag("client"))}get shouldStripClientTag(){return skipClientTagOnKinds.has(this.kind)}muted(){const e=this.ndk?.mutedIds.get(this.pubkey);if(e&&e==="p")return"author";const t=this.tagReference(),r=this.ndk?.mutedIds.get(t[1]);return r&&r===t[0]?"event":null}replaceableDTag(){if(this.kind&&this.kind>=3e4&&this.kind<=4e4){const e=this.getMatchingTags("d")[0];return e?e[1]:""}throw new Error("Event is not a parameterized replaceable event")}deduplicationKey(){return this.kind===0||this.kind===3||this.kind&&this.kind>=1e4&&this.kind<2e4?`${this.kind}:${this.pubkey}`:this.tagId()}tagId(){return this.isParamReplaceable()?this.tagAddress():this.id}tagAddress(){if(this.isParamReplaceable()){const e=this.dTag??"";return`${this.kind}:${this.pubkey}:${e}`}if(this.isReplaceable())return`${this.kind}:${this.pubkey}:`;throw new Error("Event is not a replaceable event")}tagType(){return this.isParamReplaceable()?"a":"e"}tagReference(e){let t;return this.isParamReplaceable()?t=["a",this.tagAddress()]:t=["e",this.tagId()],this.relay?t.push(this.relay.url):t.push(""),t.push(e??""),this.isParamReplaceable()||t.push(this.pubkey),t}referenceTags(e,t,r,s){let i=[];return this.isParamReplaceable()?i=[[r??"a",this.tagAddress()],[r??"e",this.id]]:i=[[r??"e",this.id]],i=i.map(a=>(a[0]==="e"||e?a.push(this.relay?.url??""):this.relay?.url&&a.push(this.relay?.url),a)),i.forEach(a=>{a[0]==="e"?(a.push(e??""),a.push(this.pubkey)):e&&a.push(e)}),i=[...i,...this.getMatchingTags("h")],!t&&s?.pTags!==!1&&i.push(...this.author.referenceTags()),i}filter(){return this.isParamReplaceable()?{"#a":[this.tagId()]}:{"#e":[this.tagId()]}}nip22Filter(){return this.isParamReplaceable()?{"#A":[this.tagId()]}:{"#E":[this.tagId()]}}async delete(e,t=!0){if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner();const r=new mt(this.ndk,{kind:5,content:e||""});return r.tag(this,void 0,!0),r.tags.push(["k",this.kind?.toString()]),t&&(this.emit("deleted"),await r.publish()),r}set isProtected(e){this.removeTag("-"),e&&this.tags.push(["-"])}get isProtected(){return this.hasTag("-")}fetchTaggedEvent=fetchTaggedEvent.bind(this);fetchRootEvent=fetchRootEvent.bind(this);fetchReplyEvent=fetchReplyEvent.bind(this);repost=repost.bind(this);async react(e,t=!0){if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner();const r=new mt(this.ndk,{kind:7,content:e});return r.tag(this),this.kind!==1&&r.tags.push(["k",`${this.kind}`]),t&&await r.publish(),r}get isValid(){return this.validate()}get inspect(){return JSON.stringify(this.rawEvent(),null,4)}dump(){console.debug(JSON.stringify(this.rawEvent(),null,4)),console.debug("Event on relays:",this.onRelays.map(e=>e.url).join(", "))}reply(e,t){const r=new mt(this.ndk);if(this.kind===1&&!e)r.kind=1,this.hasTag("e")?r.tags=[...r.tags,...this.getMatchingTags("e"),...this.getMatchingTags("p"),...this.getMatchingTags("a"),...this.referenceTags("reply",!1,void 0,t)]:r.tag(this,"root",!1,void 0,t);else{r.kind=1111;const s=["A","E","I","P"],i=this.tags.filter(a=>s.includes(a[0]));if(i.length>0){const a=this.tagValue("K");r.tags.push(...i),a&&r.tags.push(["K",a]);let u;if(this.isParamReplaceable()){u=["a",this.tagAddress()];const l=this.relay?.url??"";l&&u.push(l)}else{u=["e",this.tagId()];const l=this.relay?.url??"";u.push(l),u.push(this.pubkey)}r.tags.push(u)}else{let a,u;const l=this.relay?.url??"";this.isParamReplaceable()?(a=["a",this.tagAddress(),l],u=["A",this.tagAddress(),l]):(a=["e",this.tagId(),l,this.pubkey],u=["E",this.tagId(),l,this.pubkey]),r.tags.push(a),r.tags.push(u),r.tags.push(["K",this.kind?.toString()]),t?.pTags!==!1&&t?.pTagOnATags!==!1&&r.tags.push(["P",this.pubkey])}r.tags.push(["k",this.kind?.toString()]),t?.pTags!==!1&&(r.tags.push(...this.getMatchingTags("p")),r.tags.push(["p",this.pubkey]))}return r}},untrackedUnpublishedEvents=new Set([24133,13194,23194,23195]);function shouldTrackUnpublishedEvent(n){return!untrackedUnpublishedEvents.has(n.kind)}var NDKPool=class extends lib$1.EventEmitter{_relays=new Map;status="idle";autoConnectRelays=new Set;poolBlacklistRelayUrls=new Set;debug;temporaryRelayTimers=new Map;flappingRelays=new Set;backoffTimes=new Map;ndk;disconnectionTimes=new Map;systemEventDetector;get blacklistRelayUrls(){const n=new Set(this.ndk.blacklistRelayUrls);return this.poolBlacklistRelayUrls.forEach(e=>n.add(e)),n}constructor(n,e,t,{debug:r,name:s}={}){super(),this.debug=r??t.debug.extend("pool"),s&&(this._name=s),this.ndk=t,this.relayUrls=n,this.poolBlacklistRelayUrls=new Set(e),this.ndk.pools.push(this)}get relays(){return this._relays}set relayUrls(n){this._relays.clear();for(const e of n){const t=new NDKRelay(e,void 0,this.ndk);t.connectivity.netDebug=this.ndk.netDebug,this.addRelay(t)}}_name="unnamed";get name(){return this._name}set name(n){this._name=n,this.debug=this.debug.extend(n)}useTemporaryRelay(n,e=3e4,t){const r=this.relays.has(n.url);r||(this.addRelay(n),this.debug("Adding temporary relay %s for filters %o",n.url,t));const s=this.temporaryRelayTimers.get(n.url);if(s&&clearTimeout(s),!r||s){const i=setTimeout(()=>{this.ndk.explicitRelayUrls?.includes(n.url)||this.removeRelay(n.url)},e);this.temporaryRelayTimers.set(n.url,i)}}addRelay(n,e=!0){const t=this.relays.has(n.url),r=this.blacklistRelayUrls?.has(n.url),s=n.url.includes("/npub1");let i=!0;const a=n.url;if(t)return;if(r){this.debug(`Refusing to add relay ${a}: blacklisted`);return}if(s){this.debug(`Refusing to add relay ${a}: is a filter relay`);return}if(this.ndk.cacheAdapter?.getRelayStatus){const T=this.ndk.cacheAdapter.getRelayStatus(a);if(T?.dontConnectBefore){if(T.dontConnectBefore>Date.now()){const P=T.dontConnectBefore-Date.now();this.debug(`Refusing to add relay ${a}: delayed connect for ${P}ms`),setTimeout(()=>{this.addRelay(n,e)},P);return}i=!1}}const u=T=>this.emit("notice",n,T),l=()=>this.handleRelayConnect(a),p=()=>this.handleRelayReady(n),g=()=>{this.recordDisconnection(n),this.emit("relay:disconnect",n)},v=()=>this.handleFlapping(n),m=T=>this.emit("relay:auth",n,T),w=()=>this.emit("relay:authed",n);n.off("notice",u),n.off("connect",l),n.off("ready",p),n.off("disconnect",g),n.off("flapping",v),n.off("auth",m),n.off("authed",w),n.on("notice",u),n.on("connect",l),n.on("ready",p),n.on("disconnect",g),n.on("flapping",v),n.on("auth",m),n.on("authed",w),n.on("delayed-connect",T=>{this.ndk.cacheAdapter?.updateRelayStatus&&this.ndk.cacheAdapter.updateRelayStatus(n.url,{dontConnectBefore:Date.now()+T})}),this._relays.set(a,n),e&&this.autoConnectRelays.add(a),e&&this.status==="active"&&(this.emit("relay:connecting",n),n.connect(void 0,i).catch(T=>{this.debug(`Failed to connect to relay ${a}`,T)}))}removeRelay(n){const e=this.relays.get(n);if(e)return e.disconnect(),this.relays.delete(n),this.autoConnectRelays.delete(n),this.emit("relay:disconnect",e),!0;const t=this.temporaryRelayTimers.get(n);return t&&(clearTimeout(t),this.temporaryRelayTimers.delete(n)),!1}isRelayConnected(n){const e=normalizeRelayUrl(n),t=this.relays.get(e);return t?t.status===5:!1}getRelay(n,e=!0,t=!1,r){let s=this.relays.get(normalizeRelayUrl(n));return s||(s=new NDKRelay(n,void 0,this.ndk),s.connectivity.netDebug=this.ndk.netDebug,t?this.useTemporaryRelay(s,3e4,r):this.addRelay(s,e)),s}handleRelayConnect(n){const e=this.relays.get(n);if(!e){console.error("NDK BUG: relay not found in pool",{relayUrl:n});return}this.emit("relay:connect",e),this.stats().connected===this.relays.size&&this.emit("connect")}handleRelayReady(n){this.emit("relay:ready",n)}async connect(n){this.status="active",this.debug(`Connecting to ${this.relays.size} relays${n?`, timeout ${n}ms`:""}...`);const e=Array.from(this.autoConnectRelays.keys()).map(i=>this.relays.get(i)).filter(i=>!!i);for(const i of e)i.status!==5&&i.status!==4&&(this.emit("relay:connecting",i),i.connect().catch(a=>{this.debug(`Failed to connect to relay ${i.url}: ${a??"No reason specified"}`)}));const t=()=>e.every(i=>i.status===5),r=new Promise(i=>{if(t()){i();return}const a=[];for(const u of e){const l=()=>{if(t()){for(let p=0;p<e.length;p++)e[p].off("connect",a[p]);i()}};a.push(l),u.on("connect",l)}}),s=typeof n=="number"?new Promise(i=>setTimeout(i,n)):new Promise(()=>{});await Promise.race([r,s])}checkOnFlappingRelays(){const n=this.flappingRelays.size,e=this.relays.size;if(n/e>=.8)for(const t of this.flappingRelays)this.backoffTimes.set(t,0)}recordDisconnection(n){const e=Date.now();this.disconnectionTimes.set(n.url,e);for(const[t,r]of this.disconnectionTimes.entries())e-r>1e4&&this.disconnectionTimes.delete(t);this.checkForSystemWideDisconnection()}checkForSystemWideDisconnection(){const n=Date.now(),e=[];for(const t of this.disconnectionTimes.values())n-t<5e3&&e.push(t);e.length>this.relays.size/2&&this.relays.size>1&&(this.debug(`System-wide disconnection detected: ${e.length}/${this.relays.size} relays disconnected`),this.handleSystemWideReconnection())}handleSystemWideReconnection(){this.debug("Initiating system-wide reconnection with reset backoff"),this.systemEventDetector&&clearTimeout(this.systemEventDetector),this.systemEventDetector=setTimeout(()=>{this.systemEventDetector=void 0},1e4);for(const n of this.relays.values())n.connectivity&&(n.connectivity.resetReconnectionState(),n.status!==5&&n.status!==4&&n.connect().catch(e=>{this.debug(`Failed to reconnect relay ${n.url} after system event: ${e}`)}));this.disconnectionTimes.clear()}handleFlapping(n){this.debug(`Relay ${n.url} is flapping`);let e=this.backoffTimes.get(n.url)||5e3;e=e*2,this.backoffTimes.set(n.url,e),this.debug(`Backoff time for ${n.url} is ${e}ms`),setTimeout(()=>{this.debug(`Attempting to reconnect to ${n.url}`),this.emit("relay:connecting",n),n.connect(),this.checkOnFlappingRelays()},e),n.disconnect(),this.emit("flapping",n)}size(){return this.relays.size}stats(){const n={total:0,connected:0,disconnected:0,connecting:0};for(const e of this.relays.values())n.total++,e.status===5?n.connected++:e.status===1?n.disconnected++:e.status===4&&n.connecting++;return n}connectedRelays(){return Array.from(this.relays.values()).filter(n=>n.status>=5)}permanentAndConnectedRelays(){return Array.from(this.relays.values()).filter(n=>n.status>=5&&!this.temporaryRelayTimers.has(n.url))}urls(){return Array.from(this.relays.keys())}},NDKCashuMintList=class gs extends NDKEvent{static kind=10019;static kinds=[10019];_p2pk;constructor(e,t){super(e,t),this.kind??=10019}static from(e){return new gs(e.ndk,e)}set relays(e){this.tags=this.tags.filter(t=>t[0]!=="relay");for(const t of e)this.tags.push(["relay",t])}get relays(){const e=[];for(const t of this.tags)t[0]==="relay"&&e.push(t[1]);return e}set mints(e){this.tags=this.tags.filter(t=>t[0]!=="mint");for(const t of e)this.tags.push(["mint",t])}get mints(){const e=[];for(const t of this.tags)t[0]==="mint"&&e.push(t[1]);return Array.from(new Set(e))}get p2pk(){return this._p2pk?this._p2pk:(this._p2pk=this.tagValue("pubkey")??this.pubkey,this._p2pk)}set p2pk(e){this._p2pk=e,this.removeTag("pubkey"),e&&this.tags.push(["pubkey",e])}get relaySet(){return NDKRelaySet.fromRelayUrls(this.relays,this.ndk)}};(class Jn extends NDKEvent{debug;_proofs=[];static kind=9321;static kinds=[Jn.kind];constructor(e,t){super(e,t),this.kind??=9321,this.debug=e?.debug.extend("nutzap")??createDebug2("ndk:nutzap"),this.alt||(this.alt="This is a nutzap");try{const r=this.getMatchingTags("proof");r.length?this._proofs=r.map(s=>JSON.parse(s[1])):this._proofs=JSON.parse(this.content)}catch{return}}static from(e){const t=new Jn(e.ndk,e);if(!(!t._proofs||!t._proofs.length))return t}set comment(e){this.content=e??""}get comment(){const e=this.tagValue("comment");return e||this.content}set proofs(e){this._proofs=e,this.tags=this.tags.filter(t=>t[0]!=="proof");for(const t of e)this.tags.push(["proof",JSON.stringify(t)])}get proofs(){return this._proofs}get rawP2pk(){const e=this.proofs[0];try{const t=JSON.parse(e.secret);let r;if(typeof t=="string"?(r=JSON.parse(t),this.debug("stringified payload",e.secret)):typeof t=="object"&&(r=t),Array.isArray(r)&&r[0]==="P2PK"&&r.length>1&&typeof r[1]=="object"&&r[1]!==null||typeof r=="object"&&r!==null&&typeof r[1]?.data=="string")return r[1].data}catch(t){this.debug("error parsing p2pk pubkey",t,this.proofs[0])}}get p2pk(){const e=this.rawP2pk;if(e)return e.startsWith("02")?e.slice(2):e}get mint(){return this.tagValue("u")}set mint(e){this.replaceTag(["u",e])}get unit(){let e=this.tagValue("unit")??"sat";return e?.startsWith("msat")&&(e="sat"),e}set unit(e){if(this.removeTag("unit"),e?.startsWith("msat"))throw new Error("msat is not allowed, use sat denomination instead");e&&this.tag(["unit",e])}get amount(){return this.proofs.reduce((t,r)=>t+r.amount,0)}sender=this.author;set target(e){this.tags=this.tags.filter(t=>t[0]!=="p"),e instanceof NDKEvent&&this.tags.push(e.tagReference())}set recipientPubkey(e){this.removeTag("p"),this.tag(["p",e])}get recipientPubkey(){return this.tagValue("p")}get recipient(){const e=this.recipientPubkey;return this.ndk?this.ndk.getUser({pubkey:e}):new NDKUser({pubkey:e})}async toNostrEvent(){this.unit==="msat"&&(this.unit="sat"),this.removeTag("amount"),this.tags.push(["amount",this.amount.toString()]);const e=await super.toNostrEvent();return e.content=this.comment,e}get isValid(){let e=0,t=0,r=0;for(const s of this.tags)s[0]==="e"&&e++,s[0]==="p"&&t++,s[0]==="u"&&r++;return t===1&&r===1&&e<=1&&this.proofs.length>0}});var signerRegistry=new Map;function registerSigner(n,e){signerRegistry.set(n,e)}var NDKPrivateKeySigner=class Xn{_user;_privateKey;_pubkey;constructor(e,t){if(typeof e=="string")if(e.startsWith("nsec1")){const{type:r,data:s}=nip19_exports$2.decode(e);if(r==="nsec")this._privateKey=s;else throw new Error("Invalid private key provided.")}else if(e.length===64)this._privateKey=hexToBytes(e);else throw new Error("Invalid private key provided.");else this._privateKey=e;this._pubkey=getPublicKey(this._privateKey),t&&(this._user=t.getUser({pubkey:this._pubkey})),this._user??=new NDKUser({pubkey:this._pubkey})}get privateKey(){if(!this._privateKey)throw new Error("Not ready");return bytesToHex(this._privateKey)}get pubkey(){if(!this._pubkey)throw new Error("Not ready");return this._pubkey}get nsec(){if(!this._privateKey)throw new Error("Not ready");return nip19_exports$2.nsecEncode(this._privateKey)}get npub(){if(!this._pubkey)throw new Error("Not ready");return nip19_exports$2.npubEncode(this._pubkey)}static generate(){const e=generateSecretKey();return new Xn(e)}async blockUntilReady(){return this._user}async user(){return this._user}get userSync(){return this._user}async sign(e){if(!this._privateKey)throw Error("Attempted to sign without a private key");return finalizeEvent(e,this._privateKey).sig}async encryptionEnabled(e){const t=[];return(!e||e==="nip04")&&t.push("nip04"),(!e||e==="nip44")&&t.push("nip44"),t}async encrypt(e,t,r){if(!this._privateKey||!this.privateKey)throw Error("Attempted to encrypt without a private key");const s=e.pubkey;if(r==="nip44"){const i=nip44_exports.v2.utils.getConversationKey(this._privateKey,s);return await nip44_exports.v2.encrypt(t,i)}return await nip04_exports.encrypt(this._privateKey,s,t)}async decrypt(e,t,r){if(!this._privateKey||!this.privateKey)throw Error("Attempted to decrypt without a private key");const s=e.pubkey;if(r==="nip44"){const i=nip44_exports.v2.utils.getConversationKey(this._privateKey,s);return await nip44_exports.v2.decrypt(t,i)}return await nip04_exports.decrypt(this._privateKey,s,t)}toPayload(){if(!this._privateKey)throw new Error("Private key not available");const e={type:"private-key",payload:this.privateKey};return JSON.stringify(e)}static async fromPayload(e,t){const r=JSON.parse(e);if(r.type!=="private-key")throw new Error(`Invalid payload type: expected 'private-key', got ${r.type}`);if(!r.payload||typeof r.payload!="string")throw new Error("Invalid payload content for private-key signer");return new Xn(r.payload,t)}};registerSigner("private-key",NDKPrivateKeySigner);async function follows(n,e,t=3){if(!this.ndk)throw new Error("NDK not set");const r=await this.ndk.fetchEvent({kinds:[t],authors:[this.pubkey]},n||{groupable:!1});if(r){const s=new Set;return r.tags.forEach(i=>{i[0]==="p"&&s.add(i[1])}),e&&this.ndk?.outboxTracker?.trackUsers(Array.from(s)),[...s].reduce((i,a)=>{const u=new NDKUser({pubkey:a});return u.ndk=this.ndk,i.add(u),i},new Set)}return new Set}var NIP05_REGEX=/^(?:([\w.+-]+)@)?([\w.-]+)$/;async function getNip05For(n,e,t=fetch,r={}){return await n.queuesNip05.add({id:e,func:async()=>{if(n.cacheAdapter?.loadNip05){const l=await n.cacheAdapter.loadNip05(e);if(l!=="missing"){if(l){const p=new NDKUser({pubkey:l.pubkey,relayUrls:l.relays,nip46Urls:l.nip46});return p.ndk=n,p}if(r.cache!=="no-cache")return null}}const s=e.match(NIP05_REGEX);if(!s)return null;const[i,a="_",u]=s;try{const l=await t(`https://${u}/.well-known/nostr.json?name=${a}`,r),{names:p,relays:g,nip46:v}=parseNIP05Result(await l.json()),m=p[a.toLowerCase()];let w=null;return m&&(w={pubkey:m,relays:g?.[m],nip46:v?.[m]}),n?.cacheAdapter?.saveNip05&&n.cacheAdapter.saveNip05(e,w),w}catch(l){return n?.cacheAdapter?.saveNip05&&n?.cacheAdapter.saveNip05(e,null),console.error("Failed to fetch NIP05 for",e,l),null}}})}function parseNIP05Result(n){const e={names:{}};for(const[t,r]of Object.entries(n.names))typeof t=="string"&&typeof r=="string"&&(e.names[t.toLowerCase()]=r);if(n.relays){e.relays={};for(const[t,r]of Object.entries(n.relays))typeof t=="string"&&Array.isArray(r)&&(e.relays[t]=r.filter(s=>typeof s=="string"))}if(n.nip46){e.nip46={};for(const[t,r]of Object.entries(n.nip46))typeof t=="string"&&Array.isArray(r)&&(e.nip46[t]=r.filter(s=>typeof s=="string"))}return e}function profileFromEvent(n){const e={};let t;try{t=JSON.parse(n.content)}catch(r){throw new Error(`Failed to parse profile event: ${r}`)}e.profileEvent=JSON.stringify(n.rawEvent());for(const r of Object.keys(t))switch(r){case"name":e.name=t.name;break;case"display_name":e.displayName=t.display_name;break;case"image":case"picture":e.picture=t.picture||t.image,e.image=e.picture;break;case"banner":e.banner=t.banner;break;case"bio":e.bio=t.bio;break;case"nip05":e.nip05=t.nip05;break;case"lud06":e.lud06=t.lud06;break;case"lud16":e.lud16=t.lud16;break;case"about":e.about=t.about;break;case"website":e.website=t.website;break;default:e[r]=t[r];break}return e.created_at=n.created_at,e}function serializeProfile(n){const e={};for(const[t,r]of Object.entries(n))switch(t){case"username":case"name":e.name=r;break;case"displayName":e.display_name=r;break;case"image":case"picture":e.picture=r;break;case"bio":case"about":e.about=r;break;default:e[t]=r;break}return JSON.stringify(e)}var NDKUser=class bs{ndk;profile;profileEvent;_npub;_pubkey;relayUrls=[];nip46Urls=[];constructor(e){if(e.npub&&(this._npub=e.npub),e.hexpubkey&&(this._pubkey=e.hexpubkey),e.pubkey&&(this._pubkey=e.pubkey),e.relayUrls&&(this.relayUrls=e.relayUrls),e.nip46Urls&&(this.nip46Urls=e.nip46Urls),e.nprofile)try{const t=nip19_exports$2.decode(e.nprofile);t.type==="nprofile"&&(this._pubkey=t.data.pubkey,t.data.relays&&t.data.relays.length>0&&this.relayUrls.push(...t.data.relays))}catch(t){console.error("Failed to decode nprofile",t)}}get npub(){if(!this._npub){if(!this._pubkey)throw new Error("pubkey not set");this._npub=nip19_exports$2.npubEncode(this.pubkey)}return this._npub}get nprofile(){const e=this.profileEvent?.onRelays?.map(t=>t.url);return nip19_exports$2.nprofileEncode({pubkey:this.pubkey,relays:e})}set npub(e){this._npub=e}get pubkey(){if(!this._pubkey){if(!this._npub)throw new Error("npub not set");this._pubkey=nip19_exports$2.decode(this.npub).data}return this._pubkey}set pubkey(e){this._pubkey=e}filter(){return{"#p":[this.pubkey]}}async getZapInfo(e){if(!this.ndk)throw new Error("No NDK instance found");const t=async a=>{if(!e)return a;let u;const l=new Promise((p,g)=>{u=setTimeout(()=>g(new Error("Timeout")),e)});try{const p=await Promise.race([a,l]);return u&&clearTimeout(u),p}catch(p){if(p instanceof Error&&p.message==="Timeout")try{return await a}catch{return}return}},[r,s]=await Promise.all([t(this.fetchProfile()),t(this.ndk.fetchEvent({kinds:[10019],authors:[this.pubkey]}))]),i=new Map;if(s){const a=NDKCashuMintList.from(s);a.mints.length>0&&i.set("nip61",{mints:a.mints,relays:a.relays,p2pk:a.p2pk})}if(r){const{lud06:a,lud16:u}=r;i.set("nip57",{lud06:a,lud16:u})}return i}static async fromNip05(e,t,r=!1){if(!t)throw new Error("No NDK instance found");const s={};r&&(s.cache="no-cache");const i=await getNip05For(t,e,t?.httpFetch,s);if(i){const a=new bs({pubkey:i.pubkey,relayUrls:i.relays,nip46Urls:i.nip46});return a.ndk=t,a}}async fetchProfile(e,t=!1){if(!this.ndk)throw new Error("NDK not set");let r=null;if(this.ndk.cacheAdapter&&(this.ndk.cacheAdapter.fetchProfile||this.ndk.cacheAdapter.fetchProfileSync)&&e?.cacheUsage!=="ONLY_RELAY"){let s=null;if(this.ndk.cacheAdapter.fetchProfileSync?s=this.ndk.cacheAdapter.fetchProfileSync(this.pubkey):this.ndk.cacheAdapter.fetchProfile&&(s=await this.ndk.cacheAdapter.fetchProfile(this.pubkey)),s)return this.profile=s,s}return e??={},e.cacheUsage??="ONLY_RELAY",e.closeOnEose??=!0,e.groupable??=!0,e.groupableDelay??=250,r||(r=await this.ndk.fetchEvent({kinds:[0],authors:[this.pubkey]},e)),r?(this.profile=profileFromEvent(r),t&&this.profile&&this.ndk.cacheAdapter&&this.ndk.cacheAdapter.saveProfile&&this.ndk.cacheAdapter.saveProfile(this.pubkey,this.profile),this.profile):null}follows=follows.bind(this);async followSet(e,t,r=3){const s=await this.follows(e,t,r);return new Set(Array.from(s).map(i=>i.pubkey))}tagReference(){return["p",this.pubkey]}referenceTags(e){const t=[["p",this.pubkey]];return e&&t[0].push("",e),t}async publish(){if(!this.ndk)throw new Error("No NDK instance found");if(!this.profile)throw new Error("No profile available");this.ndk.assertSigner(),await new NDKEvent(this.ndk,{kind:0,content:serializeProfile(this.profile)}).publish()}async follow(e,t,r=3){if(!this.ndk)throw new Error("No NDK instance found");if(this.ndk.assertSigner(),t||(t=await this.follows(void 0,void 0,r)),t.has(e))return!1;t.add(e);const s=new NDKEvent(this.ndk,{kind:r});for(const i of t)s.tag(i);return await s.publish(),!0}async unfollow(e,t,r=3){if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner(),t||(t=await this.follows(void 0,void 0,r));const s=new Set;let i=!1;for(const u of t)u.pubkey!==e.pubkey?s.add(u):i=!0;if(!i)return!1;const a=new NDKEvent(this.ndk,{kind:r});for(const u of s)a.tag(u);return await a.publish()}async validateNip05(e){if(!this.ndk)throw new Error("No NDK instance found");const t=await getNip05For(this.ndk,e);return t===null?null:t.pubkey===this.pubkey}};function disconnect(n,e){return e??=createDebug2("ndk:relay:auth-policies:disconnect"),async t=>{e?.(`Relay ${t.url} requested authentication, disconnecting`),n.removeRelay(t.url)}}async function signAndAuth(n,e,t,r,s,i){try{await n.sign(t),s(n)}catch(a){r?.(`Failed to publish auth event to relay ${e.url}`,a),i(n)}}function signIn({ndk:n,signer:e,debug:t}={}){return t??=createDebug2("ndk:auth-policies:signIn"),async(r,s)=>{t?.(`Relay ${r.url} requested authentication, signing in`);const i=new NDKEvent(n);return i.kind=22242,i.tags=[["relay",r.url],["challenge",s]],e??=n?.signer,new Promise(async(a,u)=>{e?await signAndAuth(i,r,e,t,a,u):n?.once("signer:ready",async l=>{await signAndAuth(i,r,l,t,a,u)})})}}var NDKRelayAuthPolicies={disconnect,signIn},NDKNip07Signer=class vs{_userPromise;encryptionQueue=[];encryptionProcessing=!1;debug;waitTimeout;_pubkey;ndk;_user;constructor(e=1e3,t){this.debug=createDebug2("ndk:nip07"),this.waitTimeout=e,this.ndk=t}get pubkey(){if(!this._pubkey)throw new Error("Not ready");return this._pubkey}async blockUntilReady(){await this.waitForExtension();const e=await window.nostr?.getPublicKey();if(!e)throw new Error("User rejected access");this._pubkey=e;let t;return this.ndk?t=this.ndk.getUser({pubkey:e}):t=new NDKUser({pubkey:e}),this._user=t,t}async user(){return this._userPromise||(this._userPromise=this.blockUntilReady()),this._userPromise}get userSync(){if(!this._user)throw new Error("User not ready");return this._user}async sign(e){await this.waitForExtension();const t=await window.nostr?.signEvent(e);if(!t)throw new Error("Failed to sign event");return t.sig}async relays(e){await this.waitForExtension();const t=await window.nostr?.getRelays?.()||{},r=[];for(const s of Object.keys(t))t[s].read&&t[s].write&&r.push(s);return r.map(s=>new NDKRelay(s,e?.relayAuthDefaultPolicy,e))}async encryptionEnabled(e){const t=[];return(!e||e==="nip04")&&window.nostr?.nip04&&t.push("nip04"),(!e||e==="nip44")&&window.nostr?.nip44&&t.push("nip44"),t}async encrypt(e,t,r="nip04"){if(!await this.encryptionEnabled(r))throw new Error(`${r}encryption is not available from your browser extension`);await this.waitForExtension();const s=e.pubkey;return this.queueEncryption(r,"encrypt",s,t)}async decrypt(e,t,r="nip04"){if(!await this.encryptionEnabled(r))throw new Error(`${r}encryption is not available from your browser extension`);await this.waitForExtension();const s=e.pubkey;return this.queueEncryption(r,"decrypt",s,t)}async queueEncryption(e,t,r,s){return new Promise((i,a)=>{this.encryptionQueue.push({scheme:e,method:t,counterpartyHexpubkey:r,value:s,resolve:i,reject:a}),this.encryptionProcessing||this.processEncryptionQueue()})}async processEncryptionQueue(e,t=0){if(!e&&this.encryptionQueue.length===0){this.encryptionProcessing=!1;return}this.encryptionProcessing=!0;const r=e||this.encryptionQueue.shift();if(!r){this.encryptionProcessing=!1;return}const{scheme:s,method:i,counterpartyHexpubkey:a,value:u,resolve:l,reject:p}=r;this.debug("Processing encryption queue item",{method:i,counterpartyHexpubkey:a,value:u});try{const g=await window.nostr?.[s]?.[i](a,u);if(!g)throw new Error("Failed to encrypt/decrypt");l(g)}catch(g){const v=g instanceof Error?g.message:String(g);if(v.includes("call already executing")&&t<5){this.debug("Retrying encryption queue item",{method:i,counterpartyHexpubkey:a,value:u,retries:t}),setTimeout(()=>{this.processEncryptionQueue(r,t+1)},50*t);return}p(g instanceof Error?g:new Error(v))}this.processEncryptionQueue()}waitForExtension(){return new Promise((e,t)=>{if(window.nostr){e();return}let r;const s=setInterval(()=>{window.nostr&&(clearTimeout(r),clearInterval(s),e())},100);r=setTimeout(()=>{clearInterval(s),t(new Error("NIP-07 extension not available"))},this.waitTimeout)})}toPayload(){return JSON.stringify({type:"nip07",payload:""})}static async fromPayload(e,t){const r=JSON.parse(e);if(r.type!=="nip07")throw new Error(`Invalid payload type: expected 'nip07', got ${r.type}`);return new vs(void 0,t)}};registerSigner("nip07",NDKNip07Signer);var NDKNostrRpc=class extends lib$1.EventEmitter{ndk;signer;relaySet;debug;encryptionType="nip04";pool;constructor(n,e,t,r){if(super(),this.ndk=n,this.signer=e,r){this.pool=new NDKPool(r,[],n,{debug:t.extend("rpc-pool"),name:"Nostr RPC"}),this.relaySet=new NDKRelaySet(new Set,n,this.pool);for(const s of r){const i=this.pool.getRelay(s,!1,!1);i.authPolicy=NDKRelayAuthPolicies.signIn({ndk:n,signer:e,debug:t}),this.relaySet.addRelay(i),i.connect()}}this.debug=t.extend("rpc")}subscribe(n){const e=this.ndk.subscribe(n,{closeOnEose:!1,groupable:!1,cacheUsage:"ONLY_RELAY",pool:this.pool,relaySet:this.relaySet},!1);return e.on("event",async t=>{try{const r=await this.parseEvent(t);r.method?this.emit("request",r):(this.emit(`response-${r.id}`,r),this.emit("response",r))}catch(r){this.debug("error parsing event",r,t.rawEvent())}}),new Promise(t=>{e.on("eose",()=>{this.debug("eosed"),t(e)}),e.start()})}async parseEvent(n){this.encryptionType==="nip44"&&n.content.includes("?iv=")?this.encryptionType="nip04":this.encryptionType==="nip04"&&!n.content.includes("?iv=")&&(this.encryptionType="nip44");const e=this.ndk.getUser({pubkey:n.pubkey});e.ndk=this.ndk;let t;try{t=await this.signer.decrypt(e,n.content,this.encryptionType)}catch{const g=this.encryptionType==="nip04"?"nip44":"nip04";t=await this.signer.decrypt(e,n.content,g),this.encryptionType=g}const r=JSON.parse(t),{id:s,method:i,params:a,result:u,error:l}=r;return i?{id:s,pubkey:n.pubkey,method:i,params:a,event:n}:{id:s,result:u,error:l,event:n}}async sendResponse(n,e,t,r=24133,s){const i={id:n,result:t};s&&(i.error=s);const a=await this.signer.user(),u=this.ndk.getUser({pubkey:e}),l=new NDKEvent(this.ndk,{kind:r,content:JSON.stringify(i),tags:[["p",e]],pubkey:a.pubkey});l.content=await this.signer.encrypt(u,l.content,this.encryptionType),await l.sign(this.signer),await l.publish(this.relaySet)}async sendRequest(n,e,t=[],r=24133,s){const i=Math.random().toString(36).substring(7),a=await this.signer.user(),u=this.ndk.getUser({pubkey:n}),l={id:i,method:e,params:t},p=new Promise(()=>{const v=m=>{m.result==="auth_url"?(this.once(`response-${i}`,v),this.emit("authUrl",m.error)):s&&s(m)};this.once(`response-${i}`,v)}),g=new NDKEvent(this.ndk,{kind:r,content:JSON.stringify(l),tags:[["p",n]],pubkey:a.pubkey});return g.content=await this.signer.encrypt(u,g.content,this.encryptionType),await g.sign(this.signer),await g.publish(this.relaySet),p}};async function ndkSignerFromPayload(n,e){let t;try{t=JSON.parse(n)}catch(s){console.error("Failed to parse signer payload string",n,s);return}if(!t||typeof t.type!="string"){console.error("Failed to parse signer payload string",n,new Error("Missing type field"));return}const r=signerRegistry.get(t.type);if(!r)throw new Error(`Unknown signer type: ${t.type}`);try{return await r.fromPayload(n,e)}catch(s){const i=s instanceof Error?s.message:String(s);throw new Error(`Failed to deserialize signer type ${t.type}: ${i}`)}}function nostrConnectGenerateSecret(){return Math.random().toString(36).substring(2,15)}function generateNostrConnectUri(n,e,t,r){const s={name:r?.name?encodeURIComponent(r.name):"",url:r?.url?encodeURIComponent(r.url):"",image:r?.image?encodeURIComponent(r.image):"",perms:r?.perms?encodeURIComponent(r.perms):""};let i=`nostrconnect://${n}?image=${s.image}&url=${s.url}&name=${s.name}&perms=${s.perms}&secret=${encodeURIComponent(e)}`;return t&&(i+=`&relay=${encodeURIComponent(t)}`),i}var NDKNip46Signer=class pn extends lib$1.EventEmitter{ndk;_user;bunkerPubkey;userPubkey;get pubkey(){if(!this.userPubkey)throw new Error("Not ready");return this.userPubkey}secret;localSigner;nip05;rpc;debug;relayUrls;subscription;nostrConnectUri;nostrConnectSecret;constructor(e,t,r,s,i){super(),this.ndk=e,this.debug=e.debug.extend("nip46:signer"),this.relayUrls=s,r?typeof r=="string"?this.localSigner=new NDKPrivateKeySigner(r):this.localSigner=r:this.localSigner=NDKPrivateKeySigner.generate(),t===!1||(t?t.startsWith("bunker://")?this.bunkerFlowInit(t):this.nip05Init(t):this.nostrconnectFlowInit(i)),this.rpc=new NDKNostrRpc(this.ndk,this.localSigner,this.debug,this.relayUrls)}static bunker(e,t,r){return new pn(e,t,r)}static nostrconnect(e,t,r,s){return new pn(e,void 0,r,[t],s)}nostrconnectFlowInit(e){this.nostrConnectSecret=nostrConnectGenerateSecret();const t=this.localSigner.pubkey;this.nostrConnectUri=generateNostrConnectUri(t,this.nostrConnectSecret,this.relayUrls?.[0],e)}bunkerFlowInit(e){const t=new URL(e),r=t.hostname||t.pathname.replace(/^\/\//,""),s=t.searchParams.get("pubkey"),i=t.searchParams.getAll("relay"),a=t.searchParams.get("secret");this.bunkerPubkey=r,this.userPubkey=s,this.relayUrls=i,this.secret=a}nip05Init(e){this.nip05=e}async startListening(){if(this.subscription)return;const e=await this.localSigner.user();if(!e)throw new Error("Local signer not ready");this.subscription=await this.rpc.subscribe({kinds:[24133],"#p":[e.pubkey]})}async user(){return this._user?this._user:this.blockUntilReady()}get userSync(){if(!this._user)throw new Error("Remote user not ready synchronously");return this._user}async blockUntilReadyNostrConnect(){return new Promise((e,t)=>{const r=s=>{s.result===this.nostrConnectSecret&&(this._user=s.event.author,this.userPubkey=s.event.pubkey,this.bunkerPubkey=s.event.pubkey,this.rpc.off("response",r),e(this._user))};this.startListening(),this.rpc.on("response",r)})}async blockUntilReady(){if(!this.bunkerPubkey&&!this.nostrConnectSecret&&!this.nip05)throw new Error("Bunker pubkey not set");if(this.nostrConnectSecret)return this.blockUntilReadyNostrConnect();if(this.nip05&&!this.userPubkey){const e=await NDKUser.fromNip05(this.nip05,this.ndk);e&&(this._user=e,this.userPubkey=e.pubkey,this.relayUrls=e.nip46Urls,this.rpc=new NDKNostrRpc(this.ndk,this.localSigner,this.debug,this.relayUrls))}if(!this.bunkerPubkey&&this.userPubkey)this.bunkerPubkey=this.userPubkey;else if(!this.bunkerPubkey)throw new Error("Bunker pubkey not set");return await this.startListening(),this.rpc.on("authUrl",(...e)=>{this.emit("authUrl",...e)}),new Promise((e,t)=>{const r=[this.userPubkey??""];if(this.secret&&r.push(this.secret),!this.bunkerPubkey)throw new Error("Bunker pubkey not set");this.rpc.sendRequest(this.bunkerPubkey,"connect",r,24133,s=>{s.result==="ack"?this.getPublicKey().then(i=>{this.userPubkey=i,this._user=this.ndk.getUser({pubkey:i}),e(this._user)}):t(s.error)})})}stop(){this.subscription?.stop(),this.subscription=void 0}async getPublicKey(){return this.userPubkey?this.userPubkey:new Promise((e,t)=>{if(!this.bunkerPubkey)throw new Error("Bunker pubkey not set");this.rpc.sendRequest(this.bunkerPubkey,"get_public_key",[],24133,r=>{e(r.result)})})}async encryptionEnabled(e){return e?[e]:Promise.resolve(["nip04","nip44"])}async encrypt(e,t,r="nip04"){return this.encryption(e,t,r,"encrypt")}async decrypt(e,t,r="nip04"){return this.encryption(e,t,r,"decrypt")}async encryption(e,t,r,s){return new Promise((a,u)=>{if(!this.bunkerPubkey)throw new Error("Bunker pubkey not set");this.rpc.sendRequest(this.bunkerPubkey,`${r}_${s}`,[e.pubkey,t],24133,l=>{l.error?u(l.error):a(l.result)})})}async sign(e){return new Promise((r,s)=>{if(!this.bunkerPubkey)throw new Error("Bunker pubkey not set");this.rpc.sendRequest(this.bunkerPubkey,"sign_event",[JSON.stringify(e)],24133,i=>{if(i.error)s(i.error);else{const a=JSON.parse(i.result);r(a.sig)}})})}async createAccount(e,t,r){await this.startListening();const s=[];return e&&s.push(e),t&&s.push(t),r&&s.push(r),new Promise((i,a)=>{if(!this.bunkerPubkey)throw new Error("Bunker pubkey not set");this.rpc.sendRequest(this.bunkerPubkey,"create_account",s,24133,u=>{if(u.error)a(u.error);else{const l=u.result;i(l)}})})}toPayload(){if(!this.bunkerPubkey||!this.userPubkey)throw new Error("NIP-46 signer is not fully initialized for serialization");const e={type:"nip46",payload:{bunkerPubkey:this.bunkerPubkey,userPubkey:this.userPubkey,relayUrls:this.relayUrls,secret:this.secret,localSignerPayload:this.localSigner.toPayload(),nip05:this.nip05||null}};return JSON.stringify(e)}static async fromPayload(e,t){if(!t)throw new Error("NDK instance is required to deserialize NIP-46 signer");const r=JSON.parse(e);if(r.type!=="nip46")throw new Error(`Invalid payload type: expected 'nip46', got ${r.type}`);const s=r.payload;if(!s||typeof s!="object"||!s.localSignerPayload)throw new Error("Invalid payload content for nip46 signer");const i=await ndkSignerFromPayload(s.localSignerPayload,t);if(!i)throw new Error("Failed to deserialize local signer for NIP-46");if(!(i instanceof NDKPrivateKeySigner))throw new Error("Local signer must be an instance of NDKPrivateKeySigner");let a;return a=new pn(t,!1,i,s.relayUrls),a.userPubkey=s.userPubkey,a.bunkerPubkey=s.bunkerPubkey,a.relayUrls=s.relayUrls,a.secret=s.secret,s.userPubkey&&(a._user=new NDKUser({pubkey:s.userPubkey}),a._user&&(a._user.ndk=t)),a}};registerSigner("nip46",NDKNip46Signer);createDebug2("ndk:active-user");createDebug2("ndk:zapper:ln");createDebug2("ndk:zapper");var nip19_exports={};__reExport(nip19_exports,nip19_star);var dexie_min={exports:{}};(function(n,e){(function(t,r){n.exports=r()})(commonjsGlobal,function(){var t=function(o,c){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(h,f){h.__proto__=f}||function(h,f){for(var y in f)Object.prototype.hasOwnProperty.call(f,y)&&(h[y]=f[y])})(o,c)},r=function(){return(r=Object.assign||function(o){for(var c,h=1,f=arguments.length;h<f;h++)for(var y in c=arguments[h])Object.prototype.hasOwnProperty.call(c,y)&&(o[y]=c[y]);return o}).apply(this,arguments)};function s(o,c,h){for(var f,y=0,b=c.length;y<b;y++)!f&&y in c||((f=f||Array.prototype.slice.call(c,0,y))[y]=c[y]);return o.concat(f||Array.prototype.slice.call(c))}var i=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:commonjsGlobal,a=Object.keys,u=Array.isArray;function l(o,c){return typeof c!="object"||a(c).forEach(function(h){o[h]=c[h]}),o}typeof Promise>"u"||i.Promise||(i.Promise=Promise);var p=Object.getPrototypeOf,g={}.hasOwnProperty;function v(o,c){return g.call(o,c)}function m(o,c){typeof c=="function"&&(c=c(p(o))),(typeof Reflect>"u"?a:Reflect.ownKeys)(c).forEach(function(h){T(o,h,c[h])})}var w=Object.defineProperty;function T(o,c,h,f){w(o,c,l(h&&v(h,"get")&&typeof h.get=="function"?{get:h.get,set:h.set,configurable:!0}:{value:h,configurable:!0,writable:!0},f))}function P(o){return{from:function(c){return o.prototype=Object.create(c.prototype),T(o.prototype,"constructor",o),{extend:m.bind(null,o.prototype)}}}}var W=Object.getOwnPropertyDescriptor,X=[].slice;function ke(o,c,h){return X.call(o,c,h)}function ne(o,c){return c(o)}function ye(o){if(!o)throw new Error("Assertion Failed")}function Se(o){i.setImmediate?setImmediate(o):setTimeout(o,0)}function Ee(o,c){if(typeof c=="string"&&v(o,c))return o[c];if(!c)return o;if(typeof c!="string"){for(var h=[],f=0,y=c.length;f<y;++f){var b=Ee(o,c[f]);h.push(b)}return h}var k=c.indexOf(".");if(k!==-1){var S=o[c.substr(0,k)];return S==null?void 0:Ee(S,c.substr(k+1))}}function ve(o,c,h){if(o&&c!==void 0&&!("isFrozen"in Object&&Object.isFrozen(o)))if(typeof c!="string"&&"length"in c){ye(typeof h!="string"&&"length"in h);for(var f=0,y=c.length;f<y;++f)ve(o,c[f],h[f])}else{var b,k,S=c.indexOf(".");S!==-1?(b=c.substr(0,S),(k=c.substr(S+1))===""?h===void 0?u(o)&&!isNaN(parseInt(b))?o.splice(b,1):delete o[b]:o[b]=h:ve(S=!(S=o[b])||!v(o,b)?o[b]={}:S,k,h)):h===void 0?u(o)&&!isNaN(parseInt(c))?o.splice(c,1):delete o[c]:o[c]=h}}function Ne(o){var c,h={};for(c in o)v(o,c)&&(h[c]=o[c]);return h}var ie=[].concat;function De(o){return ie.apply([],o)}var ot="BigUint64Array,BigInt64Array,Array,Boolean,String,Date,RegExp,Blob,File,FileList,FileSystemFileHandle,FileSystemDirectoryHandle,ArrayBuffer,DataView,Uint8ClampedArray,ImageBitmap,ImageData,Map,Set,CryptoKey".split(",").concat(De([8,16,32,64].map(function(o){return["Int","Uint","Float"].map(function(c){return c+o+"Array"})}))).filter(function(o){return i[o]}),H=new Set(ot.map(function(o){return i[o]})),U=null;function E(o){return U=new WeakMap,o=function c(h){if(!h||typeof h!="object")return h;var f=U.get(h);if(f)return f;if(u(h)){f=[],U.set(h,f);for(var y=0,b=h.length;y<b;++y)f.push(c(h[y]))}else if(H.has(h.constructor))f=h;else{var k,S=p(h);for(k in f=S===Object.prototype?{}:Object.create(S),U.set(h,f),h)v(h,k)&&(f[k]=c(h[k]))}return f}(o),U=null,o}var $={}.toString;function _(o){return $.call(o).slice(8,-1)}var A=typeof Symbol<"u"?Symbol.iterator:"@@iterator",M=typeof A=="symbol"?function(o){var c;return o!=null&&(c=o[A])&&c.apply(o)}:function(){return null};function G(o,c){return c=o.indexOf(c),0<=c&&o.splice(c,1),0<=c}var j={};function z(o){var c,h,f,y;if(arguments.length===1){if(u(o))return o.slice();if(this===j&&typeof o=="string")return[o];if(y=M(o)){for(h=[];!(f=y.next()).done;)h.push(f.value);return h}if(o==null)return[o];if(typeof(c=o.length)!="number")return[o];for(h=new Array(c);c--;)h[c]=o[c];return h}for(c=arguments.length,h=new Array(c);c--;)h[c]=arguments[c];return h}var V=typeof Symbol<"u"?function(o){return o[Symbol.toStringTag]==="AsyncFunction"}:function(){return!1},Rt=["Unknown","Constraint","Data","TransactionInactive","ReadOnly","Version","NotFound","InvalidState","InvalidAccess","Abort","Timeout","QuotaExceeded","Syntax","DataClone"],ze=["Modify","Bulk","OpenFailed","VersionChange","Schema","Upgrade","InvalidTable","MissingAPI","NoSuchDatabase","InvalidArgument","SubTransaction","Unsupported","Internal","DatabaseClosed","PrematureCommit","ForeignAwait"].concat(Rt),J={VersionChanged:"Database version changed by other database connection",DatabaseClosed:"Database has been closed",Abort:"Transaction aborted",TransactionInactive:"Transaction has already completed or failed",MissingAPI:"IndexedDB API missing. Please visit https://tinyurl.com/y2uuvskb"};function fe(o,c){this.name=o,this.message=c}function he(o,c){return o+". Errors: "+Object.keys(c).map(function(h){return c[h].toString()}).filter(function(h,f,y){return y.indexOf(h)===f}).join(`
`)}function ue(o,c,h,f){this.failures=c,this.failedKeys=f,this.successCount=h,this.message=he(o,c)}function pe(o,c){this.name="BulkError",this.failures=Object.keys(c).map(function(h){return c[h]}),this.failuresByPos=c,this.message=he(o,this.failures)}P(fe).from(Error).extend({toString:function(){return this.name+": "+this.message}}),P(ue).from(fe),P(pe).from(fe);var ge=ze.reduce(function(o,c){return o[c]=c+"Error",o},{}),Re=fe,Z=ze.reduce(function(o,c){var h=c+"Error";function f(y,b){this.name=h,y?typeof y=="string"?(this.message="".concat(y).concat(b?`
 `+b:""),this.inner=b||null):typeof y=="object"&&(this.message="".concat(y.name," ").concat(y.message),this.inner=y):(this.message=J[c]||h,this.inner=null)}return P(f).from(Re),o[c]=f,o},{});Z.Syntax=SyntaxError,Z.Type=TypeError,Z.Range=RangeError;var $e=Rt.reduce(function(o,c){return o[c+"Error"]=Z[c],o},{}),Ve=ze.reduce(function(o,c){return["Syntax","Type","Range"].indexOf(c)===-1&&(o[c+"Error"]=Z[c]),o},{});function xe(){}function qe(o){return o}function ws(o,c){return o==null||o===qe?c:function(h){return c(o(h))}}function it(o,c){return function(){o.apply(this,arguments),c.apply(this,arguments)}}function ks(o,c){return o===xe?c:function(){var h=o.apply(this,arguments);h!==void 0&&(arguments[0]=h);var f=this.onsuccess,y=this.onerror;this.onsuccess=null,this.onerror=null;var b=c.apply(this,arguments);return f&&(this.onsuccess=this.onsuccess?it(f,this.onsuccess):f),y&&(this.onerror=this.onerror?it(y,this.onerror):y),b!==void 0?b:h}}function Es(o,c){return o===xe?c:function(){o.apply(this,arguments);var h=this.onsuccess,f=this.onerror;this.onsuccess=this.onerror=null,c.apply(this,arguments),h&&(this.onsuccess=this.onsuccess?it(h,this.onsuccess):h),f&&(this.onerror=this.onerror?it(f,this.onerror):f)}}function _s(o,c){return o===xe?c:function(h){var f=o.apply(this,arguments);l(h,f);var y=this.onsuccess,b=this.onerror;return this.onsuccess=null,this.onerror=null,h=c.apply(this,arguments),y&&(this.onsuccess=this.onsuccess?it(y,this.onsuccess):y),b&&(this.onerror=this.onerror?it(b,this.onerror):b),f===void 0?h===void 0?void 0:h:l(f,h)}}function $s(o,c){return o===xe?c:function(){return c.apply(this,arguments)!==!1&&o.apply(this,arguments)}}function yn(o,c){return o===xe?c:function(){var h=o.apply(this,arguments);if(h&&typeof h.then=="function"){for(var f=this,y=arguments.length,b=new Array(y);y--;)b[y]=arguments[y];return h.then(function(){return c.apply(f,b)})}return c.apply(this,arguments)}}Ve.ModifyError=ue,Ve.DexieError=fe,Ve.BulkError=pe;var We=typeof location<"u"&&/^(http|https):\/\/(localhost|127\.0\.0\.1)/.test(location.href);function Qn(o){We=o}var Tt={},er=100,ot=typeof Promise>"u"?[]:function(){var o=Promise.resolve();if(typeof crypto>"u"||!crypto.subtle)return[o,p(o),o];var c=crypto.subtle.digest("SHA-512",new Uint8Array([0]));return[c,p(c),o]}(),Rt=ot[0],ze=ot[1],ot=ot[2],ze=ze&&ze.then,at=Rt&&Rt.constructor,gn=!!ot,xt=function(o,c){At.push([o,c]),Ot&&(queueMicrotask(Ts),Ot=!1)},mn=!0,Ot=!0,ct=[],Mt=[],bn=qe,Xe={id:"global",global:!0,ref:0,unhandleds:[],onunhandled:xe,pgp:!1,env:{},finalize:xe},de=Xe,At=[],ut=0,Lt=[];function ce(o){if(typeof this!="object")throw new TypeError("Promises must be constructed via new");this._listeners=[],this._lib=!1;var c=this._PSD=de;if(typeof o!="function"){if(o!==Tt)throw new TypeError("Not a function");return this._state=arguments[1],this._value=arguments[2],void(this._state===!1&&wn(this,this._value))}this._state=null,this._value=null,++c.ref,function h(f,y){try{y(function(b){if(f._state===null){if(b===f)throw new TypeError("A promise cannot be resolved with itself.");var k=f._lib&&bt();b&&typeof b.then=="function"?h(f,function(S,x){b instanceof ce?b._then(S,x):b.then(S,x)}):(f._state=!0,f._value=b,nr(f)),k&&vt()}},wn.bind(null,f))}catch(b){wn(f,b)}}(this,o)}var vn={get:function(){var o=de,c=zt;function h(f,y){var b=this,k=!o.global&&(o!==de||c!==zt),S=k&&!et(),x=new ce(function(N,K){kn(b,new tr(sr(f,o,k,S),sr(y,o,k,S),N,K,o))});return this._consoleTask&&(x._consoleTask=this._consoleTask),x}return h.prototype=Tt,h},set:function(o){T(this,"then",o&&o.prototype===Tt?vn:{get:function(){return o},set:vn.set})}};function tr(o,c,h,f,y){this.onFulfilled=typeof o=="function"?o:null,this.onRejected=typeof c=="function"?c:null,this.resolve=h,this.reject=f,this.psd=y}function wn(o,c){var h,f;Mt.push(c),o._state===null&&(h=o._lib&&bt(),c=bn(c),o._state=!1,o._value=c,f=o,ct.some(function(y){return y._value===f._value})||ct.push(f),nr(o),h&&vt())}function nr(o){var c=o._listeners;o._listeners=[];for(var h=0,f=c.length;h<f;++h)kn(o,c[h]);var y=o._PSD;--y.ref||y.finalize(),ut===0&&(++ut,xt(function(){--ut==0&&En()},[]))}function kn(o,c){if(o._state!==null){var h=o._state?c.onFulfilled:c.onRejected;if(h===null)return(o._state?c.resolve:c.reject)(o._value);++c.psd.ref,++ut,xt(Ss,[h,o,c])}else o._listeners.push(c)}function Ss(o,c,h){try{var f,y=c._value;!c._state&&Mt.length&&(Mt=[]),f=We&&c._consoleTask?c._consoleTask.run(function(){return o(y)}):o(y),c._state||Mt.indexOf(y)!==-1||function(b){for(var k=ct.length;k;)if(ct[--k]._value===b._value)return ct.splice(k,1)}(c),h.resolve(f)}catch(b){h.reject(b)}finally{--ut==0&&En(),--h.psd.ref||h.psd.finalize()}}function Ts(){lt(Xe,function(){bt()&&vt()})}function bt(){var o=mn;return Ot=mn=!1,o}function vt(){var o,c,h;do for(;0<At.length;)for(o=At,At=[],h=o.length,c=0;c<h;++c){var f=o[c];f[0].apply(null,f[1])}while(0<At.length);Ot=mn=!0}function En(){var o=ct;ct=[],o.forEach(function(f){f._PSD.onunhandled.call(null,f._value,f)});for(var c=Lt.slice(0),h=c.length;h;)c[--h]()}function Vt(o){return new ce(Tt,!1,o)}function Pe(o,c){var h=de;return function(){var f=bt(),y=de;try{return tt(h,!0),o.apply(this,arguments)}catch(b){c&&c(b)}finally{tt(y,!1),f&&vt()}}}m(ce.prototype,{then:vn,_then:function(o,c){kn(this,new tr(null,null,o,c,de))},catch:function(o){if(arguments.length===1)return this.then(null,o);var c=o,h=arguments[1];return typeof c=="function"?this.then(null,function(f){return(f instanceof c?h:Vt)(f)}):this.then(null,function(f){return(f&&f.name===c?h:Vt)(f)})},finally:function(o){return this.then(function(c){return ce.resolve(o()).then(function(){return c})},function(c){return ce.resolve(o()).then(function(){return Vt(c)})})},timeout:function(o,c){var h=this;return o<1/0?new ce(function(f,y){var b=setTimeout(function(){return y(new Z.Timeout(c))},o);h.then(f,y).finally(clearTimeout.bind(null,b))}):this}}),typeof Symbol<"u"&&Symbol.toStringTag&&T(ce.prototype,Symbol.toStringTag,"Dexie.Promise"),Xe.env=rr(),m(ce,{all:function(){var o=z.apply(null,arguments).map(qt);return new ce(function(c,h){o.length===0&&c([]);var f=o.length;o.forEach(function(y,b){return ce.resolve(y).then(function(k){o[b]=k,--f||c(o)},h)})})},resolve:function(o){return o instanceof ce?o:o&&typeof o.then=="function"?new ce(function(c,h){o.then(c,h)}):new ce(Tt,!0,o)},reject:Vt,race:function(){var o=z.apply(null,arguments).map(qt);return new ce(function(c,h){o.map(function(f){return ce.resolve(f).then(c,h)})})},PSD:{get:function(){return de},set:function(o){return de=o}},totalEchoes:{get:function(){return zt}},newPSD:Qe,usePSD:lt,scheduler:{get:function(){return xt},set:function(o){xt=o}},rejectionMapper:{get:function(){return bn},set:function(o){bn=o}},follow:function(o,c){return new ce(function(h,f){return Qe(function(y,b){var k=de;k.unhandleds=[],k.onunhandled=b,k.finalize=it(function(){var S,x=this;S=function(){x.unhandleds.length===0?y():b(x.unhandleds[0])},Lt.push(function N(){S(),Lt.splice(Lt.indexOf(N),1)}),++ut,xt(function(){--ut==0&&En()},[])},k.finalize),o()},c,h,f)})}}),at&&(at.allSettled&&T(ce,"allSettled",function(){var o=z.apply(null,arguments).map(qt);return new ce(function(c){o.length===0&&c([]);var h=o.length,f=new Array(h);o.forEach(function(y,b){return ce.resolve(y).then(function(k){return f[b]={status:"fulfilled",value:k}},function(k){return f[b]={status:"rejected",reason:k}}).then(function(){return--h||c(f)})})})}),at.any&&typeof AggregateError<"u"&&T(ce,"any",function(){var o=z.apply(null,arguments).map(qt);return new ce(function(c,h){o.length===0&&h(new AggregateError([]));var f=o.length,y=new Array(f);o.forEach(function(b,k){return ce.resolve(b).then(function(S){return c(S)},function(S){y[k]=S,--f||h(new AggregateError(y))})})})}),at.withResolvers&&(ce.withResolvers=at.withResolvers));var Be={awaits:0,echoes:0,id:0},Rs=0,Ht=[],jt=0,zt=0,xs=0;function Qe(o,c,h,f){var y=de,b=Object.create(y);return b.parent=y,b.ref=0,b.global=!1,b.id=++xs,Xe.env,b.env=gn?{Promise:ce,PromiseProp:{value:ce,configurable:!0,writable:!0},all:ce.all,race:ce.race,allSettled:ce.allSettled,any:ce.any,resolve:ce.resolve,reject:ce.reject}:{},c&&l(b,c),++y.ref,b.finalize=function(){--this.parent.ref||this.parent.finalize()},f=lt(b,o,h,f),b.ref===0&&b.finalize(),f}function wt(){return Be.id||(Be.id=++Rs),++Be.awaits,Be.echoes+=er,Be.id}function et(){return!!Be.awaits&&(--Be.awaits==0&&(Be.id=0),Be.echoes=Be.awaits*er,!0)}function qt(o){return Be.echoes&&o&&o.constructor===at?(wt(),o.then(function(c){return et(),c},function(c){return et(),Ie(c)})):o}function As(){var o=Ht[Ht.length-1];Ht.pop(),tt(o,!1)}function tt(o,c){var h,f=de;(c?!Be.echoes||jt++&&o===de:!jt||--jt&&o===de)||queueMicrotask(c?function(y){++zt,Be.echoes&&--Be.echoes!=0||(Be.echoes=Be.awaits=Be.id=0),Ht.push(de),tt(y,!0)}.bind(null,o):As),o!==de&&(de=o,f===Xe&&(Xe.env=rr()),gn&&(h=Xe.env.Promise,c=o.env,(f.global||o.global)&&(Object.defineProperty(i,"Promise",c.PromiseProp),h.all=c.all,h.race=c.race,h.resolve=c.resolve,h.reject=c.reject,c.allSettled&&(h.allSettled=c.allSettled),c.any&&(h.any=c.any))))}function rr(){var o=i.Promise;return gn?{Promise:o,PromiseProp:Object.getOwnPropertyDescriptor(i,"Promise"),all:o.all,race:o.race,allSettled:o.allSettled,any:o.any,resolve:o.resolve,reject:o.reject}:{}}function lt(o,c,h,f,y){var b=de;try{return tt(o,!0),c(h,f,y)}finally{tt(b,!1)}}function sr(o,c,h,f){return typeof o!="function"?o:function(){var y=de;h&&wt(),tt(c,!0);try{return o.apply(this,arguments)}finally{tt(y,!1),f&&queueMicrotask(et)}}}function _n(o){Promise===at&&Be.echoes===0?jt===0?o():enqueueNativeMicroTask(o):setTimeout(o,0)}(""+ze).indexOf("[native code]")===-1&&(wt=et=xe);var Ie=ce.reject,ht="",Ze="Invalid key provided. Keys must be of type string, number, Date or Array<string | number | Date>.",ir="String expected.",kt=[],Wt="__dbnames",$n="readonly",Sn="readwrite";function dt(o,c){return o?c?function(){return o.apply(this,arguments)&&c.apply(this,arguments)}:o:c}var or={type:3,lower:-1/0,lowerOpen:!1,upper:[[]],upperOpen:!1};function Gt(o){return typeof o!="string"||/\./.test(o)?function(c){return c}:function(c){return c[o]===void 0&&o in c&&delete(c=E(c))[o],c}}function ar(){throw Z.Type("Entity instances must never be new:ed. Instances are generated by the framework bypassing the constructor.")}function Te(o,c){try{var h=cr(o),f=cr(c);if(h!==f)return h==="Array"?1:f==="Array"?-1:h==="binary"?1:f==="binary"?-1:h==="string"?1:f==="string"?-1:h==="Date"?1:f!=="Date"?NaN:-1;switch(h){case"number":case"Date":case"string":return c<o?1:o<c?-1:0;case"binary":return function(y,b){for(var k=y.length,S=b.length,x=k<S?k:S,N=0;N<x;++N)if(y[N]!==b[N])return y[N]<b[N]?-1:1;return k===S?0:k<S?-1:1}(ur(o),ur(c));case"Array":return function(y,b){for(var k=y.length,S=b.length,x=k<S?k:S,N=0;N<x;++N){var K=Te(y[N],b[N]);if(K!==0)return K}return k===S?0:k<S?-1:1}(o,c)}}catch{}return NaN}function cr(o){var c=typeof o;return c!="object"?c:ArrayBuffer.isView(o)?"binary":(o=_(o),o==="ArrayBuffer"?"binary":o)}function ur(o){return o instanceof Uint8Array?o:ArrayBuffer.isView(o)?new Uint8Array(o.buffer,o.byteOffset,o.byteLength):new Uint8Array(o)}function Yt(o,c,h){var f=o.schema.yProps;return f?(c&&0<h.numFailures&&(c=c.filter(function(y,b){return!h.failures[b]})),Promise.all(f.map(function(y){return y=y.updatesTable,c?o.db.table(y).where("k").anyOf(c).delete():o.db.table(y).clear()})).then(function(){return h})):h}var Nt=(lr.prototype.execute=function(o){var c=this["@@propmod"];if(c.add!==void 0){var h=c.add;if(u(h))return s(s([],u(o)?o:[],!0),h).sort();if(typeof h=="number")return(Number(o)||0)+h;if(typeof h=="bigint")try{return BigInt(o)+h}catch{return BigInt(0)+h}throw new TypeError("Invalid term ".concat(h))}if(c.remove!==void 0){var f=c.remove;if(u(f))return u(o)?o.filter(function(y){return!f.includes(y)}).sort():[];if(typeof f=="number")return Number(o)-f;if(typeof f=="bigint")try{return BigInt(o)-f}catch{return BigInt(0)-f}throw new TypeError("Invalid subtrahend ".concat(f))}return h=(h=c.replacePrefix)===null||h===void 0?void 0:h[0],h&&typeof o=="string"&&o.startsWith(h)?c.replacePrefix[1]+o.substring(h.length):o},lr);function lr(o){this["@@propmod"]=o}function hr(o,c){for(var h=a(c),f=h.length,y=!1,b=0;b<f;++b){var k=h[b],S=c[k],x=Ee(o,k);S instanceof Nt?(ve(o,k,S.execute(x)),y=!0):x!==S&&(ve(o,k,S),y=!0)}return y}var dr=(Ce.prototype._trans=function(o,c,h){var f=this._tx||de.trans,y=this.name,b=We&&typeof console<"u"&&console.createTask&&console.createTask("Dexie: ".concat(o==="readonly"?"read":"write"," ").concat(this.name));function k(N,K,R){if(!R.schema[y])throw new Z.NotFound("Table "+y+" not part of transaction");return c(R.idbtrans,R)}var S=bt();try{var x=f&&f.db._novip===this.db._novip?f===de.trans?f._promise(o,k,h):Qe(function(){return f._promise(o,k,h)},{trans:f,transless:de.transless||de}):function N(K,R,F,C){if(K.idbdb&&(K._state.openComplete||de.letThrough||K._vip)){var D=K._createTransaction(R,F,K._dbSchema);try{D.create(),K._state.PR1398_maxLoop=3}catch(I){return I.name===ge.InvalidState&&K.isOpen()&&0<--K._state.PR1398_maxLoop?(console.warn("Dexie: Need to reopen db"),K.close({disableAutoOpen:!1}),K.open().then(function(){return N(K,R,F,C)})):Ie(I)}return D._promise(R,function(I,B){return Qe(function(){return de.trans=D,C(I,B,D)})}).then(function(I){if(R==="readwrite")try{D.idbtrans.commit()}catch{}return R==="readonly"?I:D._completion.then(function(){return I})})}if(K._state.openComplete)return Ie(new Z.DatabaseClosed(K._state.dbOpenError));if(!K._state.isBeingOpened){if(!K._state.autoOpen)return Ie(new Z.DatabaseClosed);K.open().catch(xe)}return K._state.dbReadyPromise.then(function(){return N(K,R,F,C)})}(this.db,o,[this.name],k);return b&&(x._consoleTask=b,x=x.catch(function(N){return console.trace(N),Ie(N)})),x}finally{S&&vt()}},Ce.prototype.get=function(o,c){var h=this;return o&&o.constructor===Object?this.where(o).first(c):o==null?Ie(new Z.Type("Invalid argument to Table.get()")):this._trans("readonly",function(f){return h.core.get({trans:f,key:o}).then(function(y){return h.hook.reading.fire(y)})}).then(c)},Ce.prototype.where=function(o){if(typeof o=="string")return new this.db.WhereClause(this,o);if(u(o))return new this.db.WhereClause(this,"[".concat(o.join("+"),"]"));var c=a(o);if(c.length===1)return this.where(c[0]).equals(o[c[0]]);var h=this.schema.indexes.concat(this.schema.primKey).filter(function(S){if(S.compound&&c.every(function(N){return 0<=S.keyPath.indexOf(N)})){for(var x=0;x<c.length;++x)if(c.indexOf(S.keyPath[x])===-1)return!1;return!0}return!1}).sort(function(S,x){return S.keyPath.length-x.keyPath.length})[0];if(h&&this.db._maxKey!==ht){var b=h.keyPath.slice(0,c.length);return this.where(b).equals(b.map(function(x){return o[x]}))}!h&&We&&console.warn("The query ".concat(JSON.stringify(o)," on ").concat(this.name," would benefit from a ")+"compound index [".concat(c.join("+"),"]"));var f=this.schema.idxByName;function y(S,x){return Te(S,x)===0}var k=c.reduce(function(R,x){var N=R[0],K=R[1],R=f[x],F=o[x];return[N||R,N||!R?dt(K,R&&R.multi?function(C){return C=Ee(C,x),u(C)&&C.some(function(D){return y(F,D)})}:function(C){return y(F,Ee(C,x))}):K]},[null,null]),b=k[0],k=k[1];return b?this.where(b.name).equals(o[b.keyPath]).filter(k):h?this.filter(k):this.where(c).equals("")},Ce.prototype.filter=function(o){return this.toCollection().and(o)},Ce.prototype.count=function(o){return this.toCollection().count(o)},Ce.prototype.offset=function(o){return this.toCollection().offset(o)},Ce.prototype.limit=function(o){return this.toCollection().limit(o)},Ce.prototype.each=function(o){return this.toCollection().each(o)},Ce.prototype.toArray=function(o){return this.toCollection().toArray(o)},Ce.prototype.toCollection=function(){return new this.db.Collection(new this.db.WhereClause(this))},Ce.prototype.orderBy=function(o){return new this.db.Collection(new this.db.WhereClause(this,u(o)?"[".concat(o.join("+"),"]"):o))},Ce.prototype.reverse=function(){return this.toCollection().reverse()},Ce.prototype.mapToClass=function(o){var c,h=this.db,f=this.name;function y(){return c!==null&&c.apply(this,arguments)||this}(this.schema.mappedClass=o).prototype instanceof ar&&(function(x,N){if(typeof N!="function"&&N!==null)throw new TypeError("Class extends value "+String(N)+" is not a constructor or null");function K(){this.constructor=x}t(x,N),x.prototype=N===null?Object.create(N):(K.prototype=N.prototype,new K)}(y,c=o),Object.defineProperty(y.prototype,"db",{get:function(){return h},enumerable:!1,configurable:!0}),y.prototype.table=function(){return f},o=y);for(var b=new Set,k=o.prototype;k;k=p(k))Object.getOwnPropertyNames(k).forEach(function(x){return b.add(x)});function S(x){if(!x)return x;var N,K=Object.create(o.prototype);for(N in x)if(!b.has(N))try{K[N]=x[N]}catch{}return K}return this.schema.readHook&&this.hook.reading.unsubscribe(this.schema.readHook),this.schema.readHook=S,this.hook("reading",S),o},Ce.prototype.defineClass=function(){return this.mapToClass(function(o){l(this,o)})},Ce.prototype.add=function(o,c){var h=this,f=this.schema.primKey,y=f.auto,b=f.keyPath,k=o;return b&&y&&(k=Gt(b)(o)),this._trans("readwrite",function(S){return h.core.mutate({trans:S,type:"add",keys:c!=null?[c]:null,values:[k]})}).then(function(S){return S.numFailures?ce.reject(S.failures[0]):S.lastResult}).then(function(S){if(b)try{ve(o,b,S)}catch{}return S})},Ce.prototype.upsert=function(o,c){var h=this,f=this.schema.primKey.keyPath;return this._trans("readwrite",function(y){return h.core.get({trans:y,key:o}).then(function(b){var k=b??{};return hr(k,c),f&&ve(k,f,o),h.core.mutate({trans:y,type:"put",values:[k],keys:[o],upsert:!0,updates:{keys:[o],changeSpecs:[c]}}).then(function(S){return S.numFailures?ce.reject(S.failures[0]):!!b})})})},Ce.prototype.update=function(o,c){return typeof o!="object"||u(o)?this.where(":id").equals(o).modify(c):(o=Ee(o,this.schema.primKey.keyPath),o===void 0?Ie(new Z.InvalidArgument("Given object does not contain its primary key")):this.where(":id").equals(o).modify(c))},Ce.prototype.put=function(o,c){var h=this,f=this.schema.primKey,y=f.auto,b=f.keyPath,k=o;return b&&y&&(k=Gt(b)(o)),this._trans("readwrite",function(S){return h.core.mutate({trans:S,type:"put",values:[k],keys:c!=null?[c]:null})}).then(function(S){return S.numFailures?ce.reject(S.failures[0]):S.lastResult}).then(function(S){if(b)try{ve(o,b,S)}catch{}return S})},Ce.prototype.delete=function(o){var c=this;return this._trans("readwrite",function(h){return c.core.mutate({trans:h,type:"delete",keys:[o]}).then(function(f){return Yt(c,[o],f)}).then(function(f){return f.numFailures?ce.reject(f.failures[0]):void 0})})},Ce.prototype.clear=function(){var o=this;return this._trans("readwrite",function(c){return o.core.mutate({trans:c,type:"deleteRange",range:or}).then(function(h){return Yt(o,null,h)})}).then(function(c){return c.numFailures?ce.reject(c.failures[0]):void 0})},Ce.prototype.bulkGet=function(o){var c=this;return this._trans("readonly",function(h){return c.core.getMany({keys:o,trans:h}).then(function(f){return f.map(function(y){return c.hook.reading.fire(y)})})})},Ce.prototype.bulkAdd=function(o,c,h){var f=this,y=Array.isArray(c)?c:void 0,b=(h=h||(y?void 0:c))?h.allKeys:void 0;return this._trans("readwrite",function(k){var N=f.schema.primKey,S=N.auto,N=N.keyPath;if(N&&y)throw new Z.InvalidArgument("bulkAdd(): keys argument invalid on tables with inbound keys");if(y&&y.length!==o.length)throw new Z.InvalidArgument("Arguments objects and keys must have the same length");var x=o.length,N=N&&S?o.map(Gt(N)):o;return f.core.mutate({trans:k,type:"add",keys:y,values:N,wantResults:b}).then(function(D){var R=D.numFailures,F=D.results,C=D.lastResult,D=D.failures;if(R===0)return b?F:C;throw new pe("".concat(f.name,".bulkAdd(): ").concat(R," of ").concat(x," operations failed"),D)})})},Ce.prototype.bulkPut=function(o,c,h){var f=this,y=Array.isArray(c)?c:void 0,b=(h=h||(y?void 0:c))?h.allKeys:void 0;return this._trans("readwrite",function(k){var N=f.schema.primKey,S=N.auto,N=N.keyPath;if(N&&y)throw new Z.InvalidArgument("bulkPut(): keys argument invalid on tables with inbound keys");if(y&&y.length!==o.length)throw new Z.InvalidArgument("Arguments objects and keys must have the same length");var x=o.length,N=N&&S?o.map(Gt(N)):o;return f.core.mutate({trans:k,type:"put",keys:y,values:N,wantResults:b}).then(function(D){var R=D.numFailures,F=D.results,C=D.lastResult,D=D.failures;if(R===0)return b?F:C;throw new pe("".concat(f.name,".bulkPut(): ").concat(R," of ").concat(x," operations failed"),D)})})},Ce.prototype.bulkUpdate=function(o){var c=this,h=this.core,f=o.map(function(k){return k.key}),y=o.map(function(k){return k.changes}),b=[];return this._trans("readwrite",function(k){return h.getMany({trans:k,keys:f,cache:"clone"}).then(function(S){var x=[],N=[];o.forEach(function(R,F){var C=R.key,D=R.changes,I=S[F];if(I){for(var B=0,O=Object.keys(D);B<O.length;B++){var L=O[B],q=D[L];if(L===c.schema.primKey.keyPath){if(Te(q,C)!==0)throw new Z.Constraint("Cannot update primary key in bulkUpdate()")}else ve(I,L,q)}b.push(F),x.push(C),N.push(I)}});var K=x.length;return h.mutate({trans:k,type:"put",keys:x,values:N,updates:{keys:f,changeSpecs:y}}).then(function(R){var F=R.numFailures,C=R.failures;if(F===0)return K;for(var D=0,I=Object.keys(C);D<I.length;D++){var B,O=I[D],L=b[Number(O)];L!=null&&(B=C[O],delete C[O],C[L]=B)}throw new pe("".concat(c.name,".bulkUpdate(): ").concat(F," of ").concat(K," operations failed"),C)})})})},Ce.prototype.bulkDelete=function(o){var c=this,h=o.length;return this._trans("readwrite",function(f){return c.core.mutate({trans:f,type:"delete",keys:o}).then(function(y){return Yt(c,o,y)})}).then(function(k){var y=k.numFailures,b=k.lastResult,k=k.failures;if(y===0)return b;throw new pe("".concat(c.name,".bulkDelete(): ").concat(y," of ").concat(h," operations failed"),k)})},Ce);function Ce(){}function Ct(o){function c(k,S){if(S){for(var x=arguments.length,N=new Array(x-1);--x;)N[x-1]=arguments[x];return h[k].subscribe.apply(null,N),o}if(typeof k=="string")return h[k]}var h={};c.addEventType=b;for(var f=1,y=arguments.length;f<y;++f)b(arguments[f]);return c;function b(k,S,x){if(typeof k!="object"){var N;S=S||$s;var K={subscribers:[],fire:x=x||xe,subscribe:function(R){K.subscribers.indexOf(R)===-1&&(K.subscribers.push(R),K.fire=S(K.fire,R))},unsubscribe:function(R){K.subscribers=K.subscribers.filter(function(F){return F!==R}),K.fire=K.subscribers.reduce(S,x)}};return h[k]=c[k]=K}a(N=k).forEach(function(R){var F=N[R];if(u(F))b(R,N[R][0],N[R][1]);else{if(F!=="asap")throw new Z.InvalidArgument("Invalid event config");var C=b(R,qe,function(){for(var D=arguments.length,I=new Array(D);D--;)I[D]=arguments[D];C.subscribers.forEach(function(B){Se(function(){B.apply(null,I)})})})}})}}function Pt(o,c){return P(c).from({prototype:o}),c}function Et(o,c){return!(o.filter||o.algorithm||o.or)&&(c?o.justLimit:!o.replayFilter)}function Tn(o,c){o.filter=dt(o.filter,c)}function Rn(o,c,h){var f=o.replayFilter;o.replayFilter=f?function(){return dt(f(),c())}:c,o.justLimit=h&&!f}function Zt(o,c){if(o.isPrimKey)return c.primaryKey;var h=c.getIndexByKeyPath(o.index);if(!h)throw new Z.Schema("KeyPath "+o.index+" on object store "+c.name+" is not indexed");return h}function fr(o,c,h){var f=Zt(o,c.schema);return c.openCursor({trans:h,values:!o.keysOnly,reverse:o.dir==="prev",unique:!!o.unique,query:{index:f,range:o.range}})}function Jt(o,c,h,f){var y=o.replayFilter?dt(o.filter,o.replayFilter()):o.filter;if(o.or){var b={},k=function(S,x,N){var K,R;y&&!y(x,N,function(F){return x.stop(F)},function(F){return x.fail(F)})||((R=""+(K=x.primaryKey))=="[object ArrayBuffer]"&&(R=""+new Uint8Array(K)),v(b,R)||(b[R]=!0,c(S,x,N)))};return Promise.all([o.or._iterate(k,h),pr(fr(o,f,h),o.algorithm,k,!o.keysOnly&&o.valueMapper)])}return pr(fr(o,f,h),dt(o.algorithm,y),c,!o.keysOnly&&o.valueMapper)}function pr(o,c,h,f){var y=Pe(f?function(b,k,S){return h(f(b),k,S)}:h);return o.then(function(b){if(b)return b.start(function(){var k=function(){return b.continue()};c&&!c(b,function(S){return k=S},function(S){b.stop(S),k=xe},function(S){b.fail(S),k=xe})||y(b.value,b,function(S){return k=S}),k()})})}var Ns=(Ae.prototype._read=function(o,c){var h=this._ctx;return h.error?h.table._trans(null,Ie.bind(null,h.error)):h.table._trans("readonly",o).then(c)},Ae.prototype._write=function(o){var c=this._ctx;return c.error?c.table._trans(null,Ie.bind(null,c.error)):c.table._trans("readwrite",o,"locked")},Ae.prototype._addAlgorithm=function(o){var c=this._ctx;c.algorithm=dt(c.algorithm,o)},Ae.prototype._iterate=function(o,c){return Jt(this._ctx,o,c,this._ctx.table.core)},Ae.prototype.clone=function(o){var c=Object.create(this.constructor.prototype),h=Object.create(this._ctx);return o&&l(h,o),c._ctx=h,c},Ae.prototype.raw=function(){return this._ctx.valueMapper=null,this},Ae.prototype.each=function(o){var c=this._ctx;return this._read(function(h){return Jt(c,o,h,c.table.core)})},Ae.prototype.count=function(o){var c=this;return this._read(function(h){var f=c._ctx,y=f.table.core;if(Et(f,!0))return y.count({trans:h,query:{index:Zt(f,y.schema),range:f.range}}).then(function(k){return Math.min(k,f.limit)});var b=0;return Jt(f,function(){return++b,!1},h,y).then(function(){return b})}).then(o)},Ae.prototype.sortBy=function(o,c){var h=o.split(".").reverse(),f=h[0],y=h.length-1;function b(x,N){return N?b(x[h[N]],N-1):x[f]}var k=this._ctx.dir==="next"?1:-1;function S(x,N){return Te(b(x,y),b(N,y))*k}return this.toArray(function(x){return x.sort(S)}).then(c)},Ae.prototype.toArray=function(o){var c=this;return this._read(function(h){var f=c._ctx;if(f.dir==="next"&&Et(f,!0)&&0<f.limit){var y=f.valueMapper,b=Zt(f,f.table.core.schema);return f.table.core.query({trans:h,limit:f.limit,values:!0,query:{index:b,range:f.range}}).then(function(S){return S=S.result,y?S.map(y):S})}var k=[];return Jt(f,function(S){return k.push(S)},h,f.table.core).then(function(){return k})},o)},Ae.prototype.offset=function(o){var c=this._ctx;return o<=0||(c.offset+=o,Et(c)?Rn(c,function(){var h=o;return function(f,y){return h===0||(h===1?--h:y(function(){f.advance(h),h=0}),!1)}}):Rn(c,function(){var h=o;return function(){return--h<0}})),this},Ae.prototype.limit=function(o){return this._ctx.limit=Math.min(this._ctx.limit,o),Rn(this._ctx,function(){var c=o;return function(h,f,y){return--c<=0&&f(y),0<=c}},!0),this},Ae.prototype.until=function(o,c){return Tn(this._ctx,function(h,f,y){return!o(h.value)||(f(y),c)}),this},Ae.prototype.first=function(o){return this.limit(1).toArray(function(c){return c[0]}).then(o)},Ae.prototype.last=function(o){return this.reverse().first(o)},Ae.prototype.filter=function(o){var c;return Tn(this._ctx,function(h){return o(h.value)}),(c=this._ctx).isMatch=dt(c.isMatch,o),this},Ae.prototype.and=function(o){return this.filter(o)},Ae.prototype.or=function(o){return new this.db.WhereClause(this._ctx.table,o,this)},Ae.prototype.reverse=function(){return this._ctx.dir=this._ctx.dir==="prev"?"next":"prev",this._ondirectionchange&&this._ondirectionchange(this._ctx.dir),this},Ae.prototype.desc=function(){return this.reverse()},Ae.prototype.eachKey=function(o){var c=this._ctx;return c.keysOnly=!c.isMatch,this.each(function(h,f){o(f.key,f)})},Ae.prototype.eachUniqueKey=function(o){return this._ctx.unique="unique",this.eachKey(o)},Ae.prototype.eachPrimaryKey=function(o){var c=this._ctx;return c.keysOnly=!c.isMatch,this.each(function(h,f){o(f.primaryKey,f)})},Ae.prototype.keys=function(o){var c=this._ctx;c.keysOnly=!c.isMatch;var h=[];return this.each(function(f,y){h.push(y.key)}).then(function(){return h}).then(o)},Ae.prototype.primaryKeys=function(o){var c=this._ctx;if(c.dir==="next"&&Et(c,!0)&&0<c.limit)return this._read(function(f){var y=Zt(c,c.table.core.schema);return c.table.core.query({trans:f,values:!1,limit:c.limit,query:{index:y,range:c.range}})}).then(function(f){return f.result}).then(o);c.keysOnly=!c.isMatch;var h=[];return this.each(function(f,y){h.push(y.primaryKey)}).then(function(){return h}).then(o)},Ae.prototype.uniqueKeys=function(o){return this._ctx.unique="unique",this.keys(o)},Ae.prototype.firstKey=function(o){return this.limit(1).keys(function(c){return c[0]}).then(o)},Ae.prototype.lastKey=function(o){return this.reverse().firstKey(o)},Ae.prototype.distinct=function(){var o=this._ctx,o=o.index&&o.table.schema.idxByName[o.index];if(!o||!o.multi)return this;var c={};return Tn(this._ctx,function(y){var f=y.primaryKey.toString(),y=v(c,f);return c[f]=!0,!y}),this},Ae.prototype.modify=function(o){var c=this,h=this._ctx;return this._write(function(f){var y=typeof o=="function"?o:function(I){return hr(I,o)},b=h.table.core,N=b.schema.primaryKey,k=N.outbound,S=N.extractKey,x=200,N=c.db._options.modifyChunkSize;N&&(x=typeof N=="object"?N[b.name]||N["*"]||200:N);function K(I,L){var O=L.failures,L=L.numFailures;F+=I-L;for(var q=0,Y=a(O);q<Y.length;q++){var te=Y[q];R.push(O[te])}}var R=[],F=0,C=[],D=o===yr;return c.clone().primaryKeys().then(function(I){function B(L){var q=Math.min(x,I.length-L),Y=I.slice(L,L+q);return(D?Promise.resolve([]):b.getMany({trans:f,keys:Y,cache:"immutable"})).then(function(te){var oe=[],Q=[],re=k?[]:null,ae=D?Y:[];if(!D)for(var se=0;se<q;++se){var le=te[se],be={value:E(le),primKey:I[L+se]};y.call(be,be.value,be)!==!1&&(be.value==null?ae.push(I[L+se]):k||Te(S(le),S(be.value))===0?(Q.push(be.value),k&&re.push(I[L+se])):(ae.push(I[L+se]),oe.push(be.value)))}return Promise.resolve(0<oe.length&&b.mutate({trans:f,type:"add",values:oe}).then(function(we){for(var _e in we.failures)ae.splice(parseInt(_e),1);K(oe.length,we)})).then(function(){return(0<Q.length||O&&typeof o=="object")&&b.mutate({trans:f,type:"put",keys:re,values:Q,criteria:O,changeSpec:typeof o!="function"&&o,isAdditionalChunk:0<L}).then(function(we){return K(Q.length,we)})}).then(function(){return(0<ae.length||O&&D)&&b.mutate({trans:f,type:"delete",keys:ae,criteria:O,isAdditionalChunk:0<L}).then(function(we){return Yt(h.table,ae,we)}).then(function(we){return K(ae.length,we)})}).then(function(){return I.length>L+q&&B(L+x)})})}var O=Et(h)&&h.limit===1/0&&(typeof o!="function"||D)&&{index:h.index,range:h.range};return B(0).then(function(){if(0<R.length)throw new ue("Error modifying one or more objects",R,F,C);return I.length})})})},Ae.prototype.delete=function(){var o=this._ctx,c=o.range;return!Et(o)||o.table.schema.yProps||!o.isPrimKey&&c.type!==3?this.modify(yr):this._write(function(h){var f=o.table.core.schema.primaryKey,y=c;return o.table.core.count({trans:h,query:{index:f,range:y}}).then(function(b){return o.table.core.mutate({trans:h,type:"deleteRange",range:y}).then(function(x){var S=x.failures,x=x.numFailures;if(x)throw new ue("Could not delete some values",Object.keys(S).map(function(N){return S[N]}),b-x);return b-x})})})},Ae);function Ae(){}var yr=function(o,c){return c.value=null};function Cs(o,c){return o<c?-1:o===c?0:1}function Ps(o,c){return c<o?-1:o===c?0:1}function He(o,c,h){return o=o instanceof mr?new o.Collection(o):o,o._ctx.error=new(h||TypeError)(c),o}function _t(o){return new o.Collection(o,function(){return gr("")}).limit(0)}function Xt(o,c,h,f){var y,b,k,S,x,N,K,R=h.length;if(!h.every(function(D){return typeof D=="string"}))return He(o,ir);function F(D){y=D==="next"?function(B){return B.toUpperCase()}:function(B){return B.toLowerCase()},b=D==="next"?function(B){return B.toLowerCase()}:function(B){return B.toUpperCase()},k=D==="next"?Cs:Ps;var I=h.map(function(B){return{lower:b(B),upper:y(B)}}).sort(function(B,O){return k(B.lower,O.lower)});S=I.map(function(B){return B.upper}),x=I.map(function(B){return B.lower}),K=(N=D)==="next"?"":f}F("next"),o=new o.Collection(o,function(){return nt(S[0],x[R-1]+f)}),o._ondirectionchange=function(D){F(D)};var C=0;return o._addAlgorithm(function(D,I,B){var O=D.key;if(typeof O!="string")return!1;var L=b(O);if(c(L,x,C))return!0;for(var q=null,Y=C;Y<R;++Y){var te=function(oe,Q,re,ae,se,le){for(var be=Math.min(oe.length,ae.length),we=-1,_e=0;_e<be;++_e){var je=Q[_e];if(je!==ae[_e])return se(oe[_e],re[_e])<0?oe.substr(0,_e)+re[_e]+re.substr(_e+1):se(oe[_e],ae[_e])<0?oe.substr(0,_e)+ae[_e]+re.substr(_e+1):0<=we?oe.substr(0,we)+Q[we]+re.substr(we+1):null;se(oe[_e],je)<0&&(we=_e)}return be<ae.length&&le==="next"?oe+re.substr(oe.length):be<oe.length&&le==="prev"?oe.substr(0,re.length):we<0?null:oe.substr(0,we)+ae[we]+re.substr(we+1)}(O,L,S[Y],x[Y],k,N);te===null&&q===null?C=Y+1:(q===null||0<k(q,te))&&(q=te)}return I(q!==null?function(){D.continue(q+K)}:B),!1}),o}function nt(o,c,h,f){return{type:2,lower:o,upper:c,lowerOpen:h,upperOpen:f}}function gr(o){return{type:1,lower:o,upper:o}}var mr=(Object.defineProperty(Fe.prototype,"Collection",{get:function(){return this._ctx.table.db.Collection},enumerable:!1,configurable:!0}),Fe.prototype.between=function(o,c,h,f){h=h!==!1,f=f===!0;try{return 0<this._cmp(o,c)||this._cmp(o,c)===0&&(h||f)&&(!h||!f)?_t(this):new this.Collection(this,function(){return nt(o,c,!h,!f)})}catch{return He(this,Ze)}},Fe.prototype.equals=function(o){return o==null?He(this,Ze):new this.Collection(this,function(){return gr(o)})},Fe.prototype.above=function(o){return o==null?He(this,Ze):new this.Collection(this,function(){return nt(o,void 0,!0)})},Fe.prototype.aboveOrEqual=function(o){return o==null?He(this,Ze):new this.Collection(this,function(){return nt(o,void 0,!1)})},Fe.prototype.below=function(o){return o==null?He(this,Ze):new this.Collection(this,function(){return nt(void 0,o,!1,!0)})},Fe.prototype.belowOrEqual=function(o){return o==null?He(this,Ze):new this.Collection(this,function(){return nt(void 0,o)})},Fe.prototype.startsWith=function(o){return typeof o!="string"?He(this,ir):this.between(o,o+ht,!0,!0)},Fe.prototype.startsWithIgnoreCase=function(o){return o===""?this.startsWith(o):Xt(this,function(c,h){return c.indexOf(h[0])===0},[o],ht)},Fe.prototype.equalsIgnoreCase=function(o){return Xt(this,function(c,h){return c===h[0]},[o],"")},Fe.prototype.anyOfIgnoreCase=function(){var o=z.apply(j,arguments);return o.length===0?_t(this):Xt(this,function(c,h){return h.indexOf(c)!==-1},o,"")},Fe.prototype.startsWithAnyOfIgnoreCase=function(){var o=z.apply(j,arguments);return o.length===0?_t(this):Xt(this,function(c,h){return h.some(function(f){return c.indexOf(f)===0})},o,ht)},Fe.prototype.anyOf=function(){var o=this,c=z.apply(j,arguments),h=this._cmp;try{c.sort(h)}catch{return He(this,Ze)}if(c.length===0)return _t(this);var f=new this.Collection(this,function(){return nt(c[0],c[c.length-1])});f._ondirectionchange=function(b){h=b==="next"?o._ascending:o._descending,c.sort(h)};var y=0;return f._addAlgorithm(function(b,k,S){for(var x=b.key;0<h(x,c[y]);)if(++y===c.length)return k(S),!1;return h(x,c[y])===0||(k(function(){b.continue(c[y])}),!1)}),f},Fe.prototype.notEqual=function(o){return this.inAnyRange([[-1/0,o],[o,this.db._maxKey]],{includeLowers:!1,includeUppers:!1})},Fe.prototype.noneOf=function(){var o=z.apply(j,arguments);if(o.length===0)return new this.Collection(this);try{o.sort(this._ascending)}catch{return He(this,Ze)}var c=o.reduce(function(h,f){return h?h.concat([[h[h.length-1][1],f]]):[[-1/0,f]]},null);return c.push([o[o.length-1],this.db._maxKey]),this.inAnyRange(c,{includeLowers:!1,includeUppers:!1})},Fe.prototype.inAnyRange=function(O,c){var h=this,f=this._cmp,y=this._ascending,b=this._descending,k=this._min,S=this._max;if(O.length===0)return _t(this);if(!O.every(function(L){return L[0]!==void 0&&L[1]!==void 0&&y(L[0],L[1])<=0}))return He(this,"First argument to inAnyRange() must be an Array of two-value Arrays [lower,upper] where upper must not be lower than lower",Z.InvalidArgument);var x=!c||c.includeLowers!==!1,N=c&&c.includeUppers===!0,K,R=y;function F(L,q){return R(L[0],q[0])}try{(K=O.reduce(function(L,q){for(var Y=0,te=L.length;Y<te;++Y){var oe=L[Y];if(f(q[0],oe[1])<0&&0<f(q[1],oe[0])){oe[0]=k(oe[0],q[0]),oe[1]=S(oe[1],q[1]);break}}return Y===te&&L.push(q),L},[])).sort(F)}catch{return He(this,Ze)}var C=0,D=N?function(L){return 0<y(L,K[C][1])}:function(L){return 0<=y(L,K[C][1])},I=x?function(L){return 0<b(L,K[C][0])}:function(L){return 0<=b(L,K[C][0])},B=D,O=new this.Collection(this,function(){return nt(K[0][0],K[K.length-1][1],!x,!N)});return O._ondirectionchange=function(L){R=L==="next"?(B=D,y):(B=I,b),K.sort(F)},O._addAlgorithm(function(L,q,Y){for(var te,oe=L.key;B(oe);)if(++C===K.length)return q(Y),!1;return!D(te=oe)&&!I(te)||(h._cmp(oe,K[C][1])===0||h._cmp(oe,K[C][0])===0||q(function(){R===y?L.continue(K[C][0]):L.continue(K[C][1])}),!1)}),O},Fe.prototype.startsWithAnyOf=function(){var o=z.apply(j,arguments);return o.every(function(c){return typeof c=="string"})?o.length===0?_t(this):this.inAnyRange(o.map(function(c){return[c,c+ht]})):He(this,"startsWithAnyOf() only works with strings")},Fe);function Fe(){}function Ge(o){return Pe(function(c){return Dt(c),o(c.target.error),!1})}function Dt(o){o.stopPropagation&&o.stopPropagation(),o.preventDefault&&o.preventDefault()}var It="storagemutated",xn="x-storagemutated-1",rt=Ct(null,It),Ds=(Ye.prototype._lock=function(){return ye(!de.global),++this._reculock,this._reculock!==1||de.global||(de.lockOwnerFor=this),this},Ye.prototype._unlock=function(){if(ye(!de.global),--this._reculock==0)for(de.global||(de.lockOwnerFor=null);0<this._blockedFuncs.length&&!this._locked();){var o=this._blockedFuncs.shift();try{lt(o[1],o[0])}catch{}}return this},Ye.prototype._locked=function(){return this._reculock&&de.lockOwnerFor!==this},Ye.prototype.create=function(o){var c=this;if(!this.mode)return this;var h=this.db.idbdb,f=this.db._state.dbOpenError;if(ye(!this.idbtrans),!o&&!h)switch(f&&f.name){case"DatabaseClosedError":throw new Z.DatabaseClosed(f);case"MissingAPIError":throw new Z.MissingAPI(f.message,f);default:throw new Z.OpenFailed(f)}if(!this.active)throw new Z.TransactionInactive;return ye(this._completion._state===null),(o=this.idbtrans=o||(this.db.core||h).transaction(this.storeNames,this.mode,{durability:this.chromeTransactionDurability})).onerror=Pe(function(y){Dt(y),c._reject(o.error)}),o.onabort=Pe(function(y){Dt(y),c.active&&c._reject(new Z.Abort(o.error)),c.active=!1,c.on("abort").fire(y)}),o.oncomplete=Pe(function(){c.active=!1,c._resolve(),"mutatedParts"in o&&rt.storagemutated.fire(o.mutatedParts)}),this},Ye.prototype._promise=function(o,c,h){var f=this;if(o==="readwrite"&&this.mode!=="readwrite")return Ie(new Z.ReadOnly("Transaction is readonly"));if(!this.active)return Ie(new Z.TransactionInactive);if(this._locked())return new ce(function(b,k){f._blockedFuncs.push([function(){f._promise(o,c,h).then(b,k)},de])});if(h)return Qe(function(){var b=new ce(function(k,S){f._lock();var x=c(k,S,f);x&&x.then&&x.then(k,S)});return b.finally(function(){return f._unlock()}),b._lib=!0,b});var y=new ce(function(b,k){var S=c(b,k,f);S&&S.then&&S.then(b,k)});return y._lib=!0,y},Ye.prototype._root=function(){return this.parent?this.parent._root():this},Ye.prototype.waitFor=function(o){var c,h=this._root(),f=ce.resolve(o);h._waitingFor?h._waitingFor=h._waitingFor.then(function(){return f}):(h._waitingFor=f,h._waitingQueue=[],c=h.idbtrans.objectStore(h.storeNames[0]),function b(){for(++h._spinCount;h._waitingQueue.length;)h._waitingQueue.shift()();h._waitingFor&&(c.get(-1/0).onsuccess=b)}());var y=h._waitingFor;return new ce(function(b,k){f.then(function(S){return h._waitingQueue.push(Pe(b.bind(null,S)))},function(S){return h._waitingQueue.push(Pe(k.bind(null,S)))}).finally(function(){h._waitingFor===y&&(h._waitingFor=null)})})},Ye.prototype.abort=function(){this.active&&(this.active=!1,this.idbtrans&&this.idbtrans.abort(),this._reject(new Z.Abort))},Ye.prototype.table=function(o){var c=this._memoizedTables||(this._memoizedTables={});if(v(c,o))return c[o];var h=this.schema[o];if(!h)throw new Z.NotFound("Table "+o+" not part of transaction");return h=new this.db.Table(o,h,this),h.core=this.db.core.table(o),c[o]=h},Ye);function Ye(){}function An(o,c,h,f,y,b,k,S){return{name:o,keyPath:c,unique:h,multi:f,auto:y,compound:b,src:(h&&!k?"&":"")+(f?"*":"")+(y?"++":"")+br(c),type:S}}function br(o){return typeof o=="string"?o:o?"["+[].join.call(o,"+")+"]":""}function Nn(o,c,h){return{name:o,primKey:c,indexes:h,mappedClass:null,idxByName:(f=function(y){return[y.name,y]},h.reduce(function(y,b,k){return k=f(b,k),k&&(y[k[0]]=k[1]),y},{}))};var f}var Kt=function(o){try{return o.only([[]]),Kt=function(){return[[]]},[[]]}catch{return Kt=function(){return ht},ht}};function Cn(o){return o==null?function(){}:typeof o=="string"?(c=o).split(".").length===1?function(h){return h[c]}:function(h){return Ee(h,c)}:function(h){return Ee(h,o)};var c}function vr(o){return[].slice.call(o)}var Is=0;function Bt(o){return o==null?":id":typeof o=="string"?o:"[".concat(o.join("+"),"]")}function Ks(o,c,x){function f(B){if(B.type===3)return null;if(B.type===4)throw new Error("Cannot convert never type to IDBKeyRange");var C=B.lower,D=B.upper,I=B.lowerOpen,B=B.upperOpen;return C===void 0?D===void 0?null:c.upperBound(D,!!B):D===void 0?c.lowerBound(C,!!I):c.bound(C,D,!!I,!!B)}function y(F){var C,D=F.name;return{name:D,schema:F,mutate:function(I){var B=I.trans,O=I.type,L=I.keys,q=I.values,Y=I.range;return new Promise(function(te,oe){te=Pe(te);var Q=B.objectStore(D),re=Q.keyPath==null,ae=O==="put"||O==="add";if(!ae&&O!=="delete"&&O!=="deleteRange")throw new Error("Invalid operation type: "+O);var se,le=(L||q||{length:1}).length;if(L&&q&&L.length!==q.length)throw new Error("Given keys array must have same length as given values array.");if(le===0)return te({numFailures:0,failures:{},results:[],lastResult:void 0});function be(Le){++je,Dt(Le)}var we=[],_e=[],je=0;if(O==="deleteRange"){if(Y.type===4)return te({numFailures:je,failures:_e,results:[],lastResult:void 0});Y.type===3?we.push(se=Q.clear()):we.push(se=Q.delete(f(Y)))}else{var re=ae?re?[q,L]:[q,null]:[L,null],me=re[0],Oe=re[1];if(ae)for(var Me=0;Me<le;++Me)we.push(se=Oe&&Oe[Me]!==void 0?Q[O](me[Me],Oe[Me]):Q[O](me[Me])),se.onerror=be;else for(Me=0;Me<le;++Me)we.push(se=Q[O](me[Me])),se.onerror=be}function hn(Le){Le=Le.target.result,we.forEach(function(yt,Yn){return yt.error!=null&&(_e[Yn]=yt.error)}),te({numFailures:je,failures:_e,results:O==="delete"?L:we.map(function(yt){return yt.result}),lastResult:Le})}se.onerror=function(Le){be(Le),hn(Le)},se.onsuccess=hn})},getMany:function(I){var B=I.trans,O=I.keys;return new Promise(function(L,q){L=Pe(L);for(var Y,te=B.objectStore(D),oe=O.length,Q=new Array(oe),re=0,ae=0,se=function(we){we=we.target,Q[we._pos]=we.result,++ae===re&&L(Q)},le=Ge(q),be=0;be<oe;++be)O[be]!=null&&((Y=te.get(O[be]))._pos=be,Y.onsuccess=se,Y.onerror=le,++re);re===0&&L(Q)})},get:function(I){var B=I.trans,O=I.key;return new Promise(function(L,q){L=Pe(L);var Y=B.objectStore(D).get(O);Y.onsuccess=function(te){return L(te.target.result)},Y.onerror=Ge(q)})},query:(C=N,function(I){return new Promise(function(B,O){B=Pe(B);var L,q,Y,re=I.trans,te=I.values,oe=I.limit,se=I.query,Q=oe===1/0?void 0:oe,ae=se.index,se=se.range,re=re.objectStore(D),ae=ae.isPrimaryKey?re:re.index(ae.name),se=f(se);if(oe===0)return B({result:[]});C?((Q=te?ae.getAll(se,Q):ae.getAllKeys(se,Q)).onsuccess=function(le){return B({result:le.target.result})},Q.onerror=Ge(O)):(L=0,q=!te&&"openKeyCursor"in ae?ae.openKeyCursor(se):ae.openCursor(se),Y=[],q.onsuccess=function(le){var be=q.result;return be?(Y.push(te?be.value:be.primaryKey),++L===oe?B({result:Y}):void be.continue()):B({result:Y})},q.onerror=Ge(O))})}),openCursor:function(I){var B=I.trans,O=I.values,L=I.query,q=I.reverse,Y=I.unique;return new Promise(function(te,oe){te=Pe(te);var ae=L.index,Q=L.range,re=B.objectStore(D),re=ae.isPrimaryKey?re:re.index(ae.name),ae=q?Y?"prevunique":"prev":Y?"nextunique":"next",se=!O&&"openKeyCursor"in re?re.openKeyCursor(f(Q),ae):re.openCursor(f(Q),ae);se.onerror=Ge(oe),se.onsuccess=Pe(function(le){var be,we,_e,je,me=se.result;me?(me.___id=++Is,me.done=!1,be=me.continue.bind(me),we=(we=me.continuePrimaryKey)&&we.bind(me),_e=me.advance.bind(me),je=function(){throw new Error("Cursor not stopped")},me.trans=B,me.stop=me.continue=me.continuePrimaryKey=me.advance=function(){throw new Error("Cursor not started")},me.fail=Pe(oe),me.next=function(){var Oe=this,Me=1;return this.start(function(){return Me--?Oe.continue():Oe.stop()}).then(function(){return Oe})},me.start=function(Oe){function Me(){if(se.result)try{Oe()}catch(Le){me.fail(Le)}else me.done=!0,me.start=function(){throw new Error("Cursor behind last entry")},me.stop()}var hn=new Promise(function(Le,yt){Le=Pe(Le),se.onerror=Ge(yt),me.fail=yt,me.stop=function(Yn){me.stop=me.continue=me.continuePrimaryKey=me.advance=je,Le(Yn)}});return se.onsuccess=Pe(function(Le){se.onsuccess=Me,Me()}),me.continue=be,me.continuePrimaryKey=we,me.advance=_e,Me(),hn},te(me)):te(null)},oe)})},count:function(I){var B=I.query,O=I.trans,L=B.index,q=B.range;return new Promise(function(Y,te){var oe=O.objectStore(D),Q=L.isPrimaryKey?oe:oe.index(L.name),oe=f(q),Q=oe?Q.count(oe):Q.count();Q.onsuccess=Pe(function(re){return Y(re.target.result)}),Q.onerror=Ge(te)})}}}var b,k,S,K=(k=x,S=vr((b=o).objectStoreNames),{schema:{name:b.name,tables:S.map(function(F){return k.objectStore(F)}).map(function(F){var C=F.keyPath,B=F.autoIncrement,D=u(C),I={},B={name:F.name,primaryKey:{name:null,isPrimaryKey:!0,outbound:C==null,compound:D,keyPath:C,autoIncrement:B,unique:!0,extractKey:Cn(C)},indexes:vr(F.indexNames).map(function(O){return F.index(O)}).map(function(Y){var L=Y.name,q=Y.unique,te=Y.multiEntry,Y=Y.keyPath,te={name:L,compound:u(Y),keyPath:Y,unique:q,multiEntry:te,extractKey:Cn(Y)};return I[Bt(Y)]=te}),getIndexByKeyPath:function(O){return I[Bt(O)]}};return I[":id"]=B.primaryKey,C!=null&&(I[Bt(C)]=B.primaryKey),B})},hasGetAll:0<S.length&&"getAll"in k.objectStore(S[0])&&!(typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604)}),x=K.schema,N=K.hasGetAll,K=x.tables.map(y),R={};return K.forEach(function(F){return R[F.name]=F}),{stack:"dbcore",transaction:o.transaction.bind(o),table:function(F){if(!R[F])throw new Error("Table '".concat(F,"' not found"));return R[F]},MIN_KEY:-1/0,MAX_KEY:Kt(c),schema:x}}function Bs(o,c,h,f){var y=h.IDBKeyRange;return h.indexedDB,{dbcore:(f=Ks(c,y,f),o.dbcore.reduce(function(b,k){return k=k.create,r(r({},b),k(b))},f))}}function Qt(o,f){var h=f.db,f=Bs(o._middlewares,h,o._deps,f);o.core=f.dbcore,o.tables.forEach(function(y){var b=y.name;o.core.schema.tables.some(function(k){return k.name===b})&&(y.core=o.core.table(b),o[b]instanceof o.Table&&(o[b].core=y.core))})}function en(o,c,h,f){h.forEach(function(y){var b=f[y];c.forEach(function(k){var S=function x(N,K){return W(N,K)||(N=p(N))&&x(N,K)}(k,y);(!S||"value"in S&&S.value===void 0)&&(k===o.Transaction.prototype||k instanceof o.Transaction?T(k,y,{get:function(){return this.table(y)},set:function(x){w(this,y,{value:x,writable:!0,configurable:!0,enumerable:!0})}}):k[y]=new o.Table(y,b))})})}function Pn(o,c){c.forEach(function(h){for(var f in h)h[f]instanceof o.Table&&delete h[f]})}function Fs(o,c){return o._cfg.version-c._cfg.version}function Us(o,c,h,f){var y=o._dbSchema;h.objectStoreNames.contains("$meta")&&!y.$meta&&(y.$meta=Nn("$meta",kr("")[0],[]),o._storeNames.push("$meta"));var b=o._createTransaction("readwrite",o._storeNames,y);b.create(h),b._completion.catch(f);var k=b._reject.bind(b),S=de.transless||de;Qe(function(){return de.trans=b,de.transless=S,c!==0?(Qt(o,h),N=c,((x=b).storeNames.includes("$meta")?x.table("$meta").get("version").then(function(K){return K??N}):ce.resolve(N)).then(function(K){return F=K,C=b,D=h,I=[],K=(R=o)._versions,B=R._dbSchema=nn(0,R.idbdb,D),(K=K.filter(function(O){return O._cfg.version>=F})).length!==0?(K.forEach(function(O){I.push(function(){var L=B,q=O._cfg.dbschema;rn(R,L,D),rn(R,q,D),B=R._dbSchema=q;var Y=Dn(L,q);Y.add.forEach(function(ae){In(D,ae[0],ae[1].primKey,ae[1].indexes)}),Y.change.forEach(function(ae){if(ae.recreate)throw new Z.Upgrade("Not yet support for changing primary key");var se=D.objectStore(ae.name);ae.add.forEach(function(le){return tn(se,le)}),ae.change.forEach(function(le){se.deleteIndex(le.name),tn(se,le)}),ae.del.forEach(function(le){return se.deleteIndex(le)})});var te=O._cfg.contentUpgrade;if(te&&O._cfg.version>F){Qt(R,D),C._memoizedTables={};var oe=Ne(q);Y.del.forEach(function(ae){oe[ae]=L[ae]}),Pn(R,[R.Transaction.prototype]),en(R,[R.Transaction.prototype],a(oe),oe),C.schema=oe;var Q,re=V(te);return re&&wt(),Y=ce.follow(function(){var ae;(Q=te(C))&&re&&(ae=et.bind(null,null),Q.then(ae,ae))}),Q&&typeof Q.then=="function"?ce.resolve(Q):Y.then(function(){return Q})}}),I.push(function(L){var q,Y,te=O._cfg.dbschema;q=te,Y=L,[].slice.call(Y.db.objectStoreNames).forEach(function(oe){return q[oe]==null&&Y.db.deleteObjectStore(oe)}),Pn(R,[R.Transaction.prototype]),en(R,[R.Transaction.prototype],R._storeNames,R._dbSchema),C.schema=R._dbSchema}),I.push(function(L){R.idbdb.objectStoreNames.contains("$meta")&&(Math.ceil(R.idbdb.version/10)===O._cfg.version?(R.idbdb.deleteObjectStore("$meta"),delete R._dbSchema.$meta,R._storeNames=R._storeNames.filter(function(q){return q!=="$meta"})):L.objectStore("$meta").put(O._cfg.version,"version"))})}),function O(){return I.length?ce.resolve(I.shift()(C.idbtrans)).then(O):ce.resolve()}().then(function(){wr(B,D)})):ce.resolve();var R,F,C,D,I,B}).catch(k)):(a(y).forEach(function(K){In(h,K,y[K].primKey,y[K].indexes)}),Qt(o,h),void ce.follow(function(){return o.on.populate.fire(b)}).catch(k));var x,N})}function Os(o,c){wr(o._dbSchema,c),c.db.version%10!=0||c.objectStoreNames.contains("$meta")||c.db.createObjectStore("$meta").add(Math.ceil(c.db.version/10-1),"version");var h=nn(0,o.idbdb,c);rn(o,o._dbSchema,c);for(var f=0,y=Dn(h,o._dbSchema).change;f<y.length;f++){var b=function(k){if(k.change.length||k.recreate)return console.warn("Unable to patch indexes of table ".concat(k.name," because it has changes on the type of index or primary key.")),{value:void 0};var S=c.objectStore(k.name);k.add.forEach(function(x){We&&console.debug("Dexie upgrade patch: Creating missing index ".concat(k.name,".").concat(x.src)),tn(S,x)})}(y[f]);if(typeof b=="object")return b.value}}function Dn(o,c){var h,f={del:[],add:[],change:[]};for(h in o)c[h]||f.del.push(h);for(h in c){var y=o[h],b=c[h];if(y){var k={name:h,def:b,recreate:!1,del:[],add:[],change:[]};if(""+(y.primKey.keyPath||"")!=""+(b.primKey.keyPath||"")||y.primKey.auto!==b.primKey.auto)k.recreate=!0,f.change.push(k);else{var S=y.idxByName,x=b.idxByName,N=void 0;for(N in S)x[N]||k.del.push(N);for(N in x){var K=S[N],R=x[N];K?K.src!==R.src&&k.change.push(R):k.add.push(R)}(0<k.del.length||0<k.add.length||0<k.change.length)&&f.change.push(k)}}else f.add.push([h,b])}return f}function In(o,c,h,f){var y=o.db.createObjectStore(c,h.keyPath?{keyPath:h.keyPath,autoIncrement:h.auto}:{autoIncrement:h.auto});return f.forEach(function(b){return tn(y,b)}),y}function wr(o,c){a(o).forEach(function(h){c.db.objectStoreNames.contains(h)||(We&&console.debug("Dexie: Creating missing table",h),In(c,h,o[h].primKey,o[h].indexes))})}function tn(o,c){o.createIndex(c.name,c.keyPath,{unique:c.unique,multiEntry:c.multi})}function nn(o,c,h){var f={};return ke(c.objectStoreNames,0).forEach(function(y){for(var b=h.objectStore(y),k=An(br(N=b.keyPath),N||"",!0,!1,!!b.autoIncrement,N&&typeof N!="string",!0),S=[],x=0;x<b.indexNames.length;++x){var K=b.index(b.indexNames[x]),N=K.keyPath,K=An(K.name,N,!!K.unique,!!K.multiEntry,!1,N&&typeof N!="string",!1);S.push(K)}f[y]=Nn(y,k,S)}),f}function rn(o,c,h){for(var f=h.db.objectStoreNames,y=0;y<f.length;++y){var b=f[y],k=h.objectStore(b);o._hasGetAll="getAll"in k;for(var S=0;S<k.indexNames.length;++S){var x=k.indexNames[S],N=k.index(x).keyPath,K=typeof N=="string"?N:"["+ke(N).join("+")+"]";!c[b]||(N=c[b].idxByName[K])&&(N.name=x,delete c[b].idxByName[K],c[b].idxByName[x]=N)}}typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&i.WorkerGlobalScope&&i instanceof i.WorkerGlobalScope&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604&&(o._hasGetAll=!1)}function kr(o){return o.split(",").map(function(c,h){var b=c.split(":"),f=(y=b[1])===null||y===void 0?void 0:y.trim(),y=(c=b[0].trim()).replace(/([&*]|\+\+)/g,""),b=/^\[/.test(y)?y.match(/^\[(.*)\]$/)[1].split("+"):y;return An(y,b||null,/\&/.test(c),/\*/.test(c),/\+\+/.test(c),u(b),h===0,f)})}var Ms=($t.prototype._createTableSchema=Nn,$t.prototype._parseIndexSyntax=kr,$t.prototype._parseStoresSpec=function(o,c){var h=this;a(o).forEach(function(f){if(o[f]!==null){var y=h._parseIndexSyntax(o[f]),b=y.shift();if(!b)throw new Z.Schema("Invalid schema for table "+f+": "+o[f]);if(b.unique=!0,b.multi)throw new Z.Schema("Primary key cannot be multiEntry*");y.forEach(function(k){if(k.auto)throw new Z.Schema("Only primary key can be marked as autoIncrement (++)");if(!k.keyPath)throw new Z.Schema("Index must have a name and cannot be an empty string")}),y=h._createTableSchema(f,b,y),c[f]=y}})},$t.prototype.stores=function(h){var c=this.db;this._cfg.storesSource=this._cfg.storesSource?l(this._cfg.storesSource,h):h;var h=c._versions,f={},y={};return h.forEach(function(b){l(f,b._cfg.storesSource),y=b._cfg.dbschema={},b._parseStoresSpec(f,y)}),c._dbSchema=y,Pn(c,[c._allTables,c,c.Transaction.prototype]),en(c,[c._allTables,c,c.Transaction.prototype,this._cfg.tables],a(y),y),c._storeNames=a(y),this},$t.prototype.upgrade=function(o){return this._cfg.contentUpgrade=yn(this._cfg.contentUpgrade||xe,o),this},$t);function $t(){}function Kn(o,c){var h=o._dbNamesDB;return h||(h=o._dbNamesDB=new Je(Wt,{addons:[],indexedDB:o,IDBKeyRange:c})).version(1).stores({dbnames:"name"}),h.table("dbnames")}function Bn(o){return o&&typeof o.databases=="function"}function Fn(o){return Qe(function(){return de.letThrough=!0,o()})}function Un(o){return!("from"in o)}var Ue=function(o,c){if(!this){var h=new Ue;return o&&"d"in o&&l(h,o),h}l(this,arguments.length?{d:1,from:o,to:1<arguments.length?c:o}:{d:0})};function Ft(o,c,h){var f=Te(c,h);if(!isNaN(f)){if(0<f)throw RangeError();if(Un(o))return l(o,{from:c,to:h,d:1});var y=o.l,f=o.r;if(Te(h,o.from)<0)return y?Ft(y,c,h):o.l={from:c,to:h,d:1,l:null,r:null},_r(o);if(0<Te(c,o.to))return f?Ft(f,c,h):o.r={from:c,to:h,d:1,l:null,r:null},_r(o);Te(c,o.from)<0&&(o.from=c,o.l=null,o.d=f?f.d+1:1),0<Te(h,o.to)&&(o.to=h,o.r=null,o.d=o.l?o.l.d+1:1),h=!o.r,y&&!o.l&&Ut(o,y),f&&h&&Ut(o,f)}}function Ut(o,c){Un(c)||function h(f,x){var b=x.from,k=x.to,S=x.l,x=x.r;Ft(f,b,k),S&&h(f,S),x&&h(f,x)}(o,c)}function Er(o,c){var h=sn(c),f=h.next();if(f.done)return!1;for(var y=f.value,b=sn(o),k=b.next(y.from),S=k.value;!f.done&&!k.done;){if(Te(S.from,y.to)<=0&&0<=Te(S.to,y.from))return!0;Te(y.from,S.from)<0?y=(f=h.next(S.from)).value:S=(k=b.next(y.from)).value}return!1}function sn(o){var c=Un(o)?null:{s:0,n:o};return{next:function(h){for(var f=0<arguments.length;c;)switch(c.s){case 0:if(c.s=1,f)for(;c.n.l&&Te(h,c.n.from)<0;)c={up:c,n:c.n.l,s:1};else for(;c.n.l;)c={up:c,n:c.n.l,s:1};case 1:if(c.s=2,!f||Te(h,c.n.to)<=0)return{value:c.n,done:!1};case 2:if(c.n.r){c.s=3,c={up:c,n:c.n.r,s:0};continue}case 3:c=c.up}return{done:!0}}}}function _r(o){var c,h,f=(((c=o.r)===null||c===void 0?void 0:c.d)||0)-(((h=o.l)===null||h===void 0?void 0:h.d)||0),y=1<f?"r":f<-1?"l":"";y&&(c=y=="r"?"l":"r",h=r({},o),f=o[y],o.from=f.from,o.to=f.to,o[y]=f[y],h[y]=f[c],(o[c]=h).d=$r(h)),o.d=$r(o)}function $r(h){var c=h.r,h=h.l;return(c?h?Math.max(c.d,h.d):c.d:h?h.d:0)+1}function on(o,c){return a(c).forEach(function(h){o[h]?Ut(o[h],c[h]):o[h]=function f(y){var b,k,S={};for(b in y)v(y,b)&&(k=y[b],S[b]=!k||typeof k!="object"||H.has(k.constructor)?k:f(k));return S}(c[h])}),o}function On(o,c){return o.all||c.all||Object.keys(o).some(function(h){return c[h]&&Er(c[h],o[h])})}m(Ue.prototype,((ze={add:function(o){return Ut(this,o),this},addKey:function(o){return Ft(this,o,o),this},addKeys:function(o){var c=this;return o.forEach(function(h){return Ft(c,h,h)}),this},hasKey:function(o){var c=sn(this).next(o).value;return c&&Te(c.from,o)<=0&&0<=Te(c.to,o)}})[A]=function(){return sn(this)},ze));var ft={},Mn={},Ln=!1;function an(o){on(Mn,o),Ln||(Ln=!0,setTimeout(function(){Ln=!1,Vn(Mn,!(Mn={}))},0))}function Vn(o,c){c===void 0&&(c=!1);var h=new Set;if(o.all)for(var f=0,y=Object.values(ft);f<y.length;f++)Sr(k=y[f],o,h,c);else for(var b in o){var k,S=/^idb\:\/\/(.*)\/(.*)\//.exec(b);S&&(b=S[1],S=S[2],(k=ft["idb://".concat(b,"/").concat(S)])&&Sr(k,o,h,c))}h.forEach(function(x){return x()})}function Sr(o,c,h,f){for(var y=[],b=0,k=Object.entries(o.queries.query);b<k.length;b++){for(var S=k[b],x=S[0],N=[],K=0,R=S[1];K<R.length;K++){var F=R[K];On(c,F.obsSet)?F.subscribers.forEach(function(B){return h.add(B)}):f&&N.push(F)}f&&y.push([x,N])}if(f)for(var C=0,D=y;C<D.length;C++){var I=D[C],x=I[0],N=I[1];o.queries.query[x]=N}}function Ls(o){var c=o._state,h=o._deps.indexedDB;if(c.isBeingOpened||o.idbdb)return c.dbReadyPromise.then(function(){return c.dbOpenError?Ie(c.dbOpenError):o});c.isBeingOpened=!0,c.dbOpenError=null,c.openComplete=!1;var f=c.openCanceller,y=Math.round(10*o.verno),b=!1;function k(){if(c.openCanceller!==f)throw new Z.DatabaseClosed("db.open() was cancelled")}function S(){return new ce(function(F,C){if(k(),!h)throw new Z.MissingAPI;var D=o.name,I=c.autoSchema||!y?h.open(D):h.open(D,y);if(!I)throw new Z.MissingAPI;I.onerror=Ge(C),I.onblocked=Pe(o._fireOnBlocked),I.onupgradeneeded=Pe(function(B){var O;K=I.transaction,c.autoSchema&&!o._options.allowEmptyDB?(I.onerror=Dt,K.abort(),I.result.close(),(O=h.deleteDatabase(D)).onsuccess=O.onerror=Pe(function(){C(new Z.NoSuchDatabase("Database ".concat(D," doesnt exist")))})):(K.onerror=Ge(C),B=B.oldVersion>Math.pow(2,62)?0:B.oldVersion,R=B<1,o.idbdb=I.result,b&&Os(o,K),Us(o,B/10,K,C))},C),I.onsuccess=Pe(function(){K=null;var B,O,L,q,Y,te=o.idbdb=I.result,oe=ke(te.objectStoreNames);if(0<oe.length)try{var Q=te.transaction((q=oe).length===1?q[0]:q,"readonly");if(c.autoSchema)O=te,L=Q,(B=o).verno=O.version/10,L=B._dbSchema=nn(0,O,L),B._storeNames=ke(O.objectStoreNames,0),en(B,[B._allTables],a(L),L);else if(rn(o,o._dbSchema,Q),((Y=Dn(nn(0,(Y=o).idbdb,Q),Y._dbSchema)).add.length||Y.change.some(function(re){return re.add.length||re.change.length}))&&!b)return console.warn("Dexie SchemaDiff: Schema was extended without increasing the number passed to db.version(). Dexie will add missing parts and increment native version number to workaround this."),te.close(),y=te.version+1,b=!0,F(S());Qt(o,Q)}catch{}kt.push(o),te.onversionchange=Pe(function(re){c.vcFired=!0,o.on("versionchange").fire(re)}),te.onclose=Pe(function(){o.close({disableAutoOpen:!1})}),R&&(Y=o._deps,Q=D,te=Y.indexedDB,Y=Y.IDBKeyRange,Bn(te)||Q===Wt||Kn(te,Y).put({name:Q}).catch(xe)),F()},C)}).catch(function(F){switch(F?.name){case"UnknownError":if(0<c.PR1398_maxLoop)return c.PR1398_maxLoop--,console.warn("Dexie: Workaround for Chrome UnknownError on open()"),S();break;case"VersionError":if(0<y)return y=0,S()}return ce.reject(F)})}var x,N=c.dbReadyResolve,K=null,R=!1;return ce.race([f,(typeof navigator>"u"?ce.resolve():!navigator.userAgentData&&/Safari\//.test(navigator.userAgent)&&!/Chrom(e|ium)\//.test(navigator.userAgent)&&indexedDB.databases?new Promise(function(F){function C(){return indexedDB.databases().finally(F)}x=setInterval(C,100),C()}).finally(function(){return clearInterval(x)}):Promise.resolve()).then(S)]).then(function(){return k(),c.onReadyBeingFired=[],ce.resolve(Fn(function(){return o.on.ready.fire(o.vip)})).then(function F(){if(0<c.onReadyBeingFired.length){var C=c.onReadyBeingFired.reduce(yn,xe);return c.onReadyBeingFired=[],ce.resolve(Fn(function(){return C(o.vip)})).then(F)}})}).finally(function(){c.openCanceller===f&&(c.onReadyBeingFired=null,c.isBeingOpened=!1)}).catch(function(F){c.dbOpenError=F;try{K&&K.abort()}catch{}return f===c.openCanceller&&o._close(),Ie(F)}).finally(function(){c.openComplete=!0,N()}).then(function(){var F;return R&&(F={},o.tables.forEach(function(C){C.schema.indexes.forEach(function(D){D.name&&(F["idb://".concat(o.name,"/").concat(C.name,"/").concat(D.name)]=new Ue(-1/0,[[[]]]))}),F["idb://".concat(o.name,"/").concat(C.name,"/")]=F["idb://".concat(o.name,"/").concat(C.name,"/:dels")]=new Ue(-1/0,[[[]]])}),rt(It).fire(F),Vn(F,!0)),o})}function Hn(o){function c(b){return o.next(b)}var h=y(c),f=y(function(b){return o.throw(b)});function y(b){return function(x){var S=b(x),x=S.value;return S.done?x:x&&typeof x.then=="function"?x.then(h,f):u(x)?Promise.all(x).then(h,f):h(x)}}return y(c)()}function cn(o,c,h){for(var f=u(o)?o.slice():[o],y=0;y<h;++y)f.push(c);return f}var Vs={stack:"dbcore",name:"VirtualIndexMiddleware",level:1,create:function(o){return r(r({},o),{table:function(c){var h=o.table(c),f=h.schema,y={},b=[];function k(R,F,C){var D=Bt(R),I=y[D]=y[D]||[],B=R==null?0:typeof R=="string"?1:R.length,O=0<F,O=r(r({},C),{name:O?"".concat(D,"(virtual-from:").concat(C.name,")"):C.name,lowLevelIndex:C,isVirtual:O,keyTail:F,keyLength:B,extractKey:Cn(R),unique:!O&&C.unique});return I.push(O),O.isPrimaryKey||b.push(O),1<B&&k(B===2?R[0]:R.slice(0,B-1),F+1,C),I.sort(function(L,q){return L.keyTail-q.keyTail}),O}c=k(f.primaryKey.keyPath,0,f.primaryKey),y[":id"]=[c];for(var S=0,x=f.indexes;S<x.length;S++){var N=x[S];k(N.keyPath,0,N)}function K(R){var F,C=R.query.index;return C.isVirtual?r(r({},R),{query:{index:C.lowLevelIndex,range:(F=R.query.range,C=C.keyTail,{type:F.type===1?2:F.type,lower:cn(F.lower,F.lowerOpen?o.MAX_KEY:o.MIN_KEY,C),lowerOpen:!0,upper:cn(F.upper,F.upperOpen?o.MIN_KEY:o.MAX_KEY,C),upperOpen:!0})}}):R}return r(r({},h),{schema:r(r({},f),{primaryKey:c,indexes:b,getIndexByKeyPath:function(R){return(R=y[Bt(R)])&&R[0]}}),count:function(R){return h.count(K(R))},query:function(R){return h.query(K(R))},openCursor:function(R){var F=R.query.index,C=F.keyTail,D=F.isVirtual,I=F.keyLength;return D?h.openCursor(K(R)).then(function(O){return O&&B(O)}):h.openCursor(R);function B(O){return Object.create(O,{continue:{value:function(L){L!=null?O.continue(cn(L,R.reverse?o.MAX_KEY:o.MIN_KEY,C)):R.unique?O.continue(O.key.slice(0,I).concat(R.reverse?o.MIN_KEY:o.MAX_KEY,C)):O.continue()}},continuePrimaryKey:{value:function(L,q){O.continuePrimaryKey(cn(L,o.MAX_KEY,C),q)}},primaryKey:{get:function(){return O.primaryKey}},key:{get:function(){var L=O.key;return I===1?L[0]:L.slice(0,I)}},value:{get:function(){return O.value}}})}}})}})}};function jn(o,c,h,f){return h=h||{},f=f||"",a(o).forEach(function(y){var b,k,S;v(c,y)?(b=o[y],k=c[y],typeof b=="object"&&typeof k=="object"&&b&&k?(S=_(b))!==_(k)?h[f+y]=c[y]:S==="Object"?jn(b,k,h,f+y+"."):b!==k&&(h[f+y]=c[y]):b!==k&&(h[f+y]=c[y])):h[f+y]=void 0}),a(c).forEach(function(y){v(o,y)||(h[f+y]=c[y])}),h}function zn(o,c){return c.type==="delete"?c.keys:c.keys||c.values.map(o.extractKey)}var Hs={stack:"dbcore",name:"HooksMiddleware",level:2,create:function(o){return r(r({},o),{table:function(c){var h=o.table(c),f=h.schema.primaryKey;return r(r({},h),{mutate:function(y){var b=de.trans,k=b.table(c).hook,S=k.deleting,x=k.creating,N=k.updating;switch(y.type){case"add":if(x.fire===xe)break;return b._promise("readwrite",function(){return K(y)},!0);case"put":if(x.fire===xe&&N.fire===xe)break;return b._promise("readwrite",function(){return K(y)},!0);case"delete":if(S.fire===xe)break;return b._promise("readwrite",function(){return K(y)},!0);case"deleteRange":if(S.fire===xe)break;return b._promise("readwrite",function(){return function R(F,C,D){return h.query({trans:F,values:!1,query:{index:f,range:C},limit:D}).then(function(I){var B=I.result;return K({type:"delete",keys:B,trans:F}).then(function(O){return 0<O.numFailures?Promise.reject(O.failures[0]):B.length<D?{failures:[],numFailures:0,lastResult:void 0}:R(F,r(r({},C),{lower:B[B.length-1],lowerOpen:!0}),D)})})}(y.trans,y.range,1e4)},!0)}return h.mutate(y);function K(R){var F,C,D,I=de.trans,B=R.keys||zn(f,R);if(!B)throw new Error("Keys missing");return(R=R.type==="add"||R.type==="put"?r(r({},R),{keys:B}):r({},R)).type!=="delete"&&(R.values=s([],R.values)),R.keys&&(R.keys=s([],R.keys)),F=h,D=B,((C=R).type==="add"?Promise.resolve([]):F.getMany({trans:C.trans,keys:D,cache:"immutable"})).then(function(O){var L=B.map(function(q,Y){var te,oe,Q,re=O[Y],ae={onerror:null,onsuccess:null};return R.type==="delete"?S.fire.call(ae,q,re,I):R.type==="add"||re===void 0?(te=x.fire.call(ae,q,R.values[Y],I),q==null&&te!=null&&(R.keys[Y]=q=te,f.outbound||ve(R.values[Y],f.keyPath,q))):(te=jn(re,R.values[Y]),(oe=N.fire.call(ae,te,q,re,I))&&(Q=R.values[Y],Object.keys(oe).forEach(function(se){v(Q,se)?Q[se]=oe[se]:ve(Q,se,oe[se])}))),ae});return h.mutate(R).then(function(q){for(var Y=q.failures,te=q.results,oe=q.numFailures,q=q.lastResult,Q=0;Q<B.length;++Q){var re=(te||B)[Q],ae=L[Q];re==null?ae.onerror&&ae.onerror(Y[Q]):ae.onsuccess&&ae.onsuccess(R.type==="put"&&O[Q]?R.values[Q]:re)}return{failures:Y,results:te,numFailures:oe,lastResult:q}}).catch(function(q){return L.forEach(function(Y){return Y.onerror&&Y.onerror(q)}),Promise.reject(q)})})}}})}})}};function Tr(o,c,h){try{if(!c||c.keys.length<o.length)return null;for(var f=[],y=0,b=0;y<c.keys.length&&b<o.length;++y)Te(c.keys[y],o[b])===0&&(f.push(h?E(c.values[y]):c.values[y]),++b);return f.length===o.length?f:null}catch{return null}}var js={stack:"dbcore",level:-1,create:function(o){return{table:function(c){var h=o.table(c);return r(r({},h),{getMany:function(f){if(!f.cache)return h.getMany(f);var y=Tr(f.keys,f.trans._cache,f.cache==="clone");return y?ce.resolve(y):h.getMany(f).then(function(b){return f.trans._cache={keys:f.keys,values:f.cache==="clone"?E(b):b},b})},mutate:function(f){return f.type!=="add"&&(f.trans._cache=null),h.mutate(f)}})}}}};function Rr(o,c){return o.trans.mode==="readonly"&&!!o.subscr&&!o.trans.explicit&&o.trans.db._options.cache!=="disabled"&&!c.schema.primaryKey.outbound}function xr(o,c){switch(o){case"query":return c.values&&!c.unique;case"get":case"getMany":case"count":case"openCursor":return!1}}var zs={stack:"dbcore",level:0,name:"Observability",create:function(o){var c=o.schema.name,h=new Ue(o.MIN_KEY,o.MAX_KEY);return r(r({},o),{transaction:function(f,y,b){if(de.subscr&&y!=="readonly")throw new Z.ReadOnly("Readwrite transaction in liveQuery context. Querier source: ".concat(de.querier));return o.transaction(f,y,b)},table:function(f){var y=o.table(f),b=y.schema,k=b.primaryKey,R=b.indexes,S=k.extractKey,x=k.outbound,N=k.autoIncrement&&R.filter(function(C){return C.compound&&C.keyPath.includes(k.keyPath)}),K=r(r({},y),{mutate:function(C){function D(se){return se="idb://".concat(c,"/").concat(f,"/").concat(se),q[se]||(q[se]=new Ue)}var I,B,O,L=C.trans,q=C.mutatedParts||(C.mutatedParts={}),Y=D(""),te=D(":dels"),oe=C.type,ae=C.type==="deleteRange"?[C.range]:C.type==="delete"?[C.keys]:C.values.length<50?[zn(k,C).filter(function(se){return se}),C.values]:[],Q=ae[0],re=ae[1],ae=C.trans._cache;return u(Q)?(Y.addKeys(Q),(ae=oe==="delete"||Q.length===re.length?Tr(Q,ae):null)||te.addKeys(Q),(ae||re)&&(I=D,B=ae,O=re,b.indexes.forEach(function(se){var le=I(se.name||"");function be(_e){return _e!=null?se.extractKey(_e):null}function we(_e){return se.multiEntry&&u(_e)?_e.forEach(function(je){return le.addKey(je)}):le.addKey(_e)}(B||O).forEach(function(_e,Oe){var me=B&&be(B[Oe]),Oe=O&&be(O[Oe]);Te(me,Oe)!==0&&(me!=null&&we(me),Oe!=null&&we(Oe))})}))):Q?(re={from:(re=Q.lower)!==null&&re!==void 0?re:o.MIN_KEY,to:(re=Q.upper)!==null&&re!==void 0?re:o.MAX_KEY},te.add(re),Y.add(re)):(Y.add(h),te.add(h),b.indexes.forEach(function(se){return D(se.name).add(h)})),y.mutate(C).then(function(se){return!Q||C.type!=="add"&&C.type!=="put"||(Y.addKeys(se.results),N&&N.forEach(function(le){for(var be=C.values.map(function(me){return le.extractKey(me)}),we=le.keyPath.findIndex(function(me){return me===k.keyPath}),_e=0,je=se.results.length;_e<je;++_e)be[_e][we]=se.results[_e];D(le.name).addKeys(be)})),L.mutatedParts=on(L.mutatedParts||{},q),se})}}),R=function(D){var I=D.query,D=I.index,I=I.range;return[D,new Ue((D=I.lower)!==null&&D!==void 0?D:o.MIN_KEY,(I=I.upper)!==null&&I!==void 0?I:o.MAX_KEY)]},F={get:function(C){return[k,new Ue(C.key)]},getMany:function(C){return[k,new Ue().addKeys(C.keys)]},count:R,query:R,openCursor:R};return a(F).forEach(function(C){K[C]=function(D){var I=de.subscr,B=!!I,O=Rr(de,y)&&xr(C,D)?D.obsSet={}:I;if(B){var L=function(re){return re="idb://".concat(c,"/").concat(f,"/").concat(re),O[re]||(O[re]=new Ue)},q=L(""),Y=L(":dels"),I=F[C](D),B=I[0],I=I[1];if((C==="query"&&B.isPrimaryKey&&!D.values?Y:L(B.name||"")).add(I),!B.isPrimaryKey){if(C!=="count"){var te=C==="query"&&x&&D.values&&y.query(r(r({},D),{values:!1}));return y[C].apply(this,arguments).then(function(re){if(C==="query"){if(x&&D.values)return te.then(function(be){return be=be.result,q.addKeys(be),re});var ae=D.values?re.result.map(S):re.result;(D.values?q:Y).addKeys(ae)}else if(C==="openCursor"){var se=re,le=D.values;return se&&Object.create(se,{key:{get:function(){return Y.addKey(se.primaryKey),se.key}},primaryKey:{get:function(){var be=se.primaryKey;return Y.addKey(be),be}},value:{get:function(){return le&&q.addKey(se.primaryKey),se.value}}})}return re})}Y.add(h)}}return y[C].apply(this,arguments)}}),K}})}};function Ar(o,c,h){if(h.numFailures===0)return c;if(c.type==="deleteRange")return null;var f=c.keys?c.keys.length:"values"in c&&c.values?c.values.length:1;return h.numFailures===f?null:(c=r({},c),u(c.keys)&&(c.keys=c.keys.filter(function(y,b){return!(b in h.failures)})),"values"in c&&u(c.values)&&(c.values=c.values.filter(function(y,b){return!(b in h.failures)})),c)}function qn(o,c){return h=o,((f=c).lower===void 0||(f.lowerOpen?0<Te(h,f.lower):0<=Te(h,f.lower)))&&(o=o,(c=c).upper===void 0||(c.upperOpen?Te(o,c.upper)<0:Te(o,c.upper)<=0));var h,f}function Nr(o,c,F,f,y,b){if(!F||F.length===0)return o;var k=c.query.index,S=k.multiEntry,x=c.query.range,N=f.schema.primaryKey.extractKey,K=k.extractKey,R=(k.lowLevelIndex||k).extractKey,F=F.reduce(function(C,D){var I=C,B=[];if(D.type==="add"||D.type==="put")for(var O=new Ue,L=D.values.length-1;0<=L;--L){var q,Y=D.values[L],te=N(Y);O.hasKey(te)||(q=K(Y),(S&&u(q)?q.some(function(se){return qn(se,x)}):qn(q,x))&&(O.addKey(te),B.push(Y)))}switch(D.type){case"add":var oe=new Ue().addKeys(c.values?C.map(function(le){return N(le)}):C),I=C.concat(c.values?B.filter(function(le){return le=N(le),!oe.hasKey(le)&&(oe.addKey(le),!0)}):B.map(function(le){return N(le)}).filter(function(le){return!oe.hasKey(le)&&(oe.addKey(le),!0)}));break;case"put":var Q=new Ue().addKeys(D.values.map(function(le){return N(le)}));I=C.filter(function(le){return!Q.hasKey(c.values?N(le):le)}).concat(c.values?B:B.map(function(le){return N(le)}));break;case"delete":var re=new Ue().addKeys(D.keys);I=C.filter(function(le){return!re.hasKey(c.values?N(le):le)});break;case"deleteRange":var ae=D.range;I=C.filter(function(le){return!qn(N(le),ae)})}return I},o);return F===o?o:(F.sort(function(C,D){return Te(R(C),R(D))||Te(N(C),N(D))}),c.limit&&c.limit<1/0&&(F.length>c.limit?F.length=c.limit:o.length===c.limit&&F.length<c.limit&&(y.dirty=!0)),b?Object.freeze(F):F)}function Cr(o,c){return Te(o.lower,c.lower)===0&&Te(o.upper,c.upper)===0&&!!o.lowerOpen==!!c.lowerOpen&&!!o.upperOpen==!!c.upperOpen}function qs(o,c){return function(h,f,y,b){if(h===void 0)return f!==void 0?-1:0;if(f===void 0)return 1;if((f=Te(h,f))===0){if(y&&b)return 0;if(y)return 1;if(b)return-1}return f}(o.lower,c.lower,o.lowerOpen,c.lowerOpen)<=0&&0<=function(h,f,y,b){if(h===void 0)return f!==void 0?1:0;if(f===void 0)return-1;if((f=Te(h,f))===0){if(y&&b)return 0;if(y)return-1;if(b)return 1}return f}(o.upper,c.upper,o.upperOpen,c.upperOpen)}function Ws(o,c,h,f){o.subscribers.add(h),f.addEventListener("abort",function(){var y,b;o.subscribers.delete(h),o.subscribers.size===0&&(y=o,b=c,setTimeout(function(){y.subscribers.size===0&&G(b,y)},3e3))})}var Gs={stack:"dbcore",level:0,name:"Cache",create:function(o){var c=o.schema.name;return r(r({},o),{transaction:function(h,f,y){var b,k,S=o.transaction(h,f,y);return f==="readwrite"&&(k=(b=new AbortController).signal,y=function(x){return function(){if(b.abort(),f==="readwrite"){for(var N=new Set,K=0,R=h;K<R.length;K++){var F=R[K],C=ft["idb://".concat(c,"/").concat(F)];if(C){var D=o.table(F),I=C.optimisticOps.filter(function(le){return le.trans===S});if(S._explicit&&x&&S.mutatedParts)for(var B=0,O=Object.values(C.queries.query);B<O.length;B++)for(var L=0,q=(oe=O[B]).slice();L<q.length;L++)On((Q=q[L]).obsSet,S.mutatedParts)&&(G(oe,Q),Q.subscribers.forEach(function(le){return N.add(le)}));else if(0<I.length){C.optimisticOps=C.optimisticOps.filter(function(le){return le.trans!==S});for(var Y=0,te=Object.values(C.queries.query);Y<te.length;Y++)for(var oe,Q,re,ae=0,se=(oe=te[Y]).slice();ae<se.length;ae++)(Q=se[ae]).res!=null&&S.mutatedParts&&(x&&!Q.dirty?(re=Object.isFrozen(Q.res),re=Nr(Q.res,Q.req,I,D,Q,re),Q.dirty?(G(oe,Q),Q.subscribers.forEach(function(le){return N.add(le)})):re!==Q.res&&(Q.res=re,Q.promise=ce.resolve({result:re}))):(Q.dirty&&G(oe,Q),Q.subscribers.forEach(function(le){return N.add(le)})))}}}N.forEach(function(le){return le()})}}},S.addEventListener("abort",y(!1),{signal:k}),S.addEventListener("error",y(!1),{signal:k}),S.addEventListener("complete",y(!0),{signal:k})),S},table:function(h){var f=o.table(h),y=f.schema.primaryKey;return r(r({},f),{mutate:function(b){var k=de.trans;if(y.outbound||k.db._options.cache==="disabled"||k.explicit||k.idbtrans.mode!=="readwrite")return f.mutate(b);var S=ft["idb://".concat(c,"/").concat(h)];return S?(k=f.mutate(b),b.type!=="add"&&b.type!=="put"||!(50<=b.values.length||zn(y,b).some(function(x){return x==null}))?(S.optimisticOps.push(b),b.mutatedParts&&an(b.mutatedParts),k.then(function(x){0<x.numFailures&&(G(S.optimisticOps,b),(x=Ar(0,b,x))&&S.optimisticOps.push(x),b.mutatedParts&&an(b.mutatedParts))}),k.catch(function(){G(S.optimisticOps,b),b.mutatedParts&&an(b.mutatedParts)})):k.then(function(x){var N=Ar(0,r(r({},b),{values:b.values.map(function(K,R){var F;return x.failures[R]?K:(K=(F=y.keyPath)!==null&&F!==void 0&&F.includes(".")?E(K):r({},K),ve(K,y.keyPath,x.results[R]),K)})}),x);S.optimisticOps.push(N),queueMicrotask(function(){return b.mutatedParts&&an(b.mutatedParts)})}),k):f.mutate(b)},query:function(b){if(!Rr(de,f)||!xr("query",b))return f.query(b);var k=((N=de.trans)===null||N===void 0?void 0:N.db._options.cache)==="immutable",R=de,S=R.requery,x=R.signal,N=function(D,I,B,O){var L=ft["idb://".concat(D,"/").concat(I)];if(!L)return[];if(!(I=L.queries[B]))return[null,!1,L,null];var q=I[(O.query?O.query.index.name:null)||""];if(!q)return[null,!1,L,null];switch(B){case"query":var Y=q.find(function(te){return te.req.limit===O.limit&&te.req.values===O.values&&Cr(te.req.query.range,O.query.range)});return Y?[Y,!0,L,q]:[q.find(function(te){return("limit"in te.req?te.req.limit:1/0)>=O.limit&&(!O.values||te.req.values)&&qs(te.req.query.range,O.query.range)}),!1,L,q];case"count":return Y=q.find(function(te){return Cr(te.req.query.range,O.query.range)}),[Y,!!Y,L,q]}}(c,h,"query",b),K=N[0],R=N[1],F=N[2],C=N[3];return K&&R?K.obsSet=b.obsSet:(R=f.query(b).then(function(D){var I=D.result;if(K&&(K.res=I),k){for(var B=0,O=I.length;B<O;++B)Object.freeze(I[B]);Object.freeze(I)}else D.result=E(I);return D}).catch(function(D){return C&&K&&G(C,K),Promise.reject(D)}),K={obsSet:b.obsSet,promise:R,subscribers:new Set,type:"query",req:b,dirty:!1},C?C.push(K):(C=[K],(F=F||(ft["idb://".concat(c,"/").concat(h)]={queries:{query:{},count:{}},objs:new Map,optimisticOps:[],unsignaledParts:{}})).queries.query[b.query.index.name||""]=C)),Ws(K,C,S,x),K.promise.then(function(D){return{result:Nr(D.result,b,F?.optimisticOps,f,K,k)}})}})}})}};function un(o,c){return new Proxy(o,{get:function(h,f,y){return f==="db"?c:Reflect.get(h,f,y)}})}var Je=(Ke.prototype.version=function(o){if(isNaN(o)||o<.1)throw new Z.Type("Given version is not a positive number");if(o=Math.round(10*o)/10,this.idbdb||this._state.isBeingOpened)throw new Z.Schema("Cannot add version when database is open");this.verno=Math.max(this.verno,o);var c=this._versions,h=c.filter(function(f){return f._cfg.version===o})[0];return h||(h=new this.Version(o),c.push(h),c.sort(Fs),h.stores({}),this._state.autoSchema=!1,h)},Ke.prototype._whenReady=function(o){var c=this;return this.idbdb&&(this._state.openComplete||de.letThrough||this._vip)?o():new ce(function(h,f){if(c._state.openComplete)return f(new Z.DatabaseClosed(c._state.dbOpenError));if(!c._state.isBeingOpened){if(!c._state.autoOpen)return void f(new Z.DatabaseClosed);c.open().catch(xe)}c._state.dbReadyPromise.then(h,f)}).then(o)},Ke.prototype.use=function(o){var c=o.stack,h=o.create,f=o.level,y=o.name;return y&&this.unuse({stack:c,name:y}),o=this._middlewares[c]||(this._middlewares[c]=[]),o.push({stack:c,create:h,level:f??10,name:y}),o.sort(function(b,k){return b.level-k.level}),this},Ke.prototype.unuse=function(o){var c=o.stack,h=o.name,f=o.create;return c&&this._middlewares[c]&&(this._middlewares[c]=this._middlewares[c].filter(function(y){return f?y.create!==f:!!h&&y.name!==h})),this},Ke.prototype.open=function(){var o=this;return lt(Xe,function(){return Ls(o)})},Ke.prototype._close=function(){this.on.close.fire(new CustomEvent("close"));var o=this._state,c=kt.indexOf(this);if(0<=c&&kt.splice(c,1),this.idbdb){try{this.idbdb.close()}catch{}this.idbdb=null}o.isBeingOpened||(o.dbReadyPromise=new ce(function(h){o.dbReadyResolve=h}),o.openCanceller=new ce(function(h,f){o.cancelOpen=f}))},Ke.prototype.close=function(h){var c=(h===void 0?{disableAutoOpen:!0}:h).disableAutoOpen,h=this._state;c?(h.isBeingOpened&&h.cancelOpen(new Z.DatabaseClosed),this._close(),h.autoOpen=!1,h.dbOpenError=new Z.DatabaseClosed):(this._close(),h.autoOpen=this._options.autoOpen||h.isBeingOpened,h.openComplete=!1,h.dbOpenError=null)},Ke.prototype.delete=function(o){var c=this;o===void 0&&(o={disableAutoOpen:!0});var h=0<arguments.length&&typeof arguments[0]!="object",f=this._state;return new ce(function(y,b){function k(){c.close(o);var S=c._deps.indexedDB.deleteDatabase(c.name);S.onsuccess=Pe(function(){var x,N,K;x=c._deps,N=c.name,K=x.indexedDB,x=x.IDBKeyRange,Bn(K)||N===Wt||Kn(K,x).delete(N).catch(xe),y()}),S.onerror=Ge(b),S.onblocked=c._fireOnBlocked}if(h)throw new Z.InvalidArgument("Invalid closeOptions argument to db.delete()");f.isBeingOpened?f.dbReadyPromise.then(k):k()})},Ke.prototype.backendDB=function(){return this.idbdb},Ke.prototype.isOpen=function(){return this.idbdb!==null},Ke.prototype.hasBeenClosed=function(){var o=this._state.dbOpenError;return o&&o.name==="DatabaseClosed"},Ke.prototype.hasFailed=function(){return this._state.dbOpenError!==null},Ke.prototype.dynamicallyOpened=function(){return this._state.autoSchema},Object.defineProperty(Ke.prototype,"tables",{get:function(){var o=this;return a(this._allTables).map(function(c){return o._allTables[c]})},enumerable:!1,configurable:!0}),Ke.prototype.transaction=function(){var o=function(c,h,f){var y=arguments.length;if(y<2)throw new Z.InvalidArgument("Too few arguments");for(var b=new Array(y-1);--y;)b[y-1]=arguments[y];return f=b.pop(),[c,De(b),f]}.apply(this,arguments);return this._transaction.apply(this,o)},Ke.prototype._transaction=function(o,c,h){var f=this,y=de.trans;y&&y.db===this&&o.indexOf("!")===-1||(y=null);var b,k,S=o.indexOf("?")!==-1;o=o.replace("!","").replace("?","");try{if(k=c.map(function(N){if(N=N instanceof f.Table?N.name:N,typeof N!="string")throw new TypeError("Invalid table argument to Dexie.transaction(). Only Table or String are allowed");return N}),o=="r"||o===$n)b=$n;else{if(o!="rw"&&o!=Sn)throw new Z.InvalidArgument("Invalid transaction mode: "+o);b=Sn}if(y){if(y.mode===$n&&b===Sn){if(!S)throw new Z.SubTransaction("Cannot enter a sub-transaction with READWRITE mode when parent transaction is READONLY");y=null}y&&k.forEach(function(N){if(y&&y.storeNames.indexOf(N)===-1){if(!S)throw new Z.SubTransaction("Table "+N+" not included in parent transaction.");y=null}}),S&&y&&!y.active&&(y=null)}}catch(N){return y?y._promise(null,function(K,R){R(N)}):Ie(N)}var x=function N(K,R,F,C,D){return ce.resolve().then(function(){var I=de.transless||de,B=K._createTransaction(R,F,K._dbSchema,C);if(B.explicit=!0,I={trans:B,transless:I},C)B.idbtrans=C.idbtrans;else try{B.create(),B.idbtrans._explicit=!0,K._state.PR1398_maxLoop=3}catch(q){return q.name===ge.InvalidState&&K.isOpen()&&0<--K._state.PR1398_maxLoop?(console.warn("Dexie: Need to reopen db"),K.close({disableAutoOpen:!1}),K.open().then(function(){return N(K,R,F,null,D)})):Ie(q)}var O,L=V(D);return L&&wt(),I=ce.follow(function(){var q;(O=D.call(B,B))&&(L?(q=et.bind(null,null),O.then(q,q)):typeof O.next=="function"&&typeof O.throw=="function"&&(O=Hn(O)))},I),(O&&typeof O.then=="function"?ce.resolve(O).then(function(q){return B.active?q:Ie(new Z.PrematureCommit("Transaction committed too early. See http://bit.ly/2kdckMn"))}):I.then(function(){return O})).then(function(q){return C&&B._resolve(),B._completion.then(function(){return q})}).catch(function(q){return B._reject(q),Ie(q)})})}.bind(null,this,b,k,y,h);return y?y._promise(b,x,"lock"):de.trans?lt(de.transless,function(){return f._whenReady(x)}):this._whenReady(x)},Ke.prototype.table=function(o){if(!v(this._allTables,o))throw new Z.InvalidTable("Table ".concat(o," does not exist"));return this._allTables[o]},Ke);function Ke(o,c){var h=this;this._middlewares={},this.verno=0;var f=Ke.dependencies;this._options=c=r({addons:Ke.addons,autoOpen:!0,indexedDB:f.indexedDB,IDBKeyRange:f.IDBKeyRange,cache:"cloned"},c),this._deps={indexedDB:c.indexedDB,IDBKeyRange:c.IDBKeyRange},f=c.addons,this._dbSchema={},this._versions=[],this._storeNames=[],this._allTables={},this.idbdb=null,this._novip=this;var y,b,k,S,x,N={dbOpenError:null,isBeingOpened:!1,onReadyBeingFired:null,openComplete:!1,dbReadyResolve:xe,dbReadyPromise:null,cancelOpen:xe,openCanceller:null,autoSchema:!0,PR1398_maxLoop:3,autoOpen:c.autoOpen};N.dbReadyPromise=new ce(function(R){N.dbReadyResolve=R}),N.openCanceller=new ce(function(R,F){N.cancelOpen=F}),this._state=N,this.name=o,this.on=Ct(this,"populate","blocked","versionchange","close",{ready:[yn,xe]}),this.once=function(R,F){var C=function(){for(var D=[],I=0;I<arguments.length;I++)D[I]=arguments[I];h.on(R).unsubscribe(C),F.apply(h,D)};return h.on(R,C)},this.on.ready.subscribe=ne(this.on.ready.subscribe,function(R){return function(F,C){Ke.vip(function(){var D,I=h._state;I.openComplete?(I.dbOpenError||ce.resolve().then(F),C&&R(F)):I.onReadyBeingFired?(I.onReadyBeingFired.push(F),C&&R(F)):(R(F),D=h,C||R(function B(){D.on.ready.unsubscribe(F),D.on.ready.unsubscribe(B)}))})}}),this.Collection=(y=this,Pt(Ns.prototype,function(O,B){this.db=y;var C=or,D=null;if(B)try{C=B()}catch(L){D=L}var I=O._ctx,B=I.table,O=B.hook.reading.fire;this._ctx={table:B,index:I.index,isPrimKey:!I.index||B.schema.primKey.keyPath&&I.index===B.schema.primKey.name,range:C,keysOnly:!1,dir:"next",unique:"",algorithm:null,filter:null,replayFilter:null,justLimit:!0,isMatch:null,offset:0,limit:1/0,error:D,or:I.or,valueMapper:O!==qe?O:null}})),this.Table=(b=this,Pt(dr.prototype,function(R,F,C){this.db=b,this._tx=C,this.name=R,this.schema=F,this.hook=b._allTables[R]?b._allTables[R].hook:Ct(null,{creating:[ks,xe],reading:[ws,qe],updating:[_s,xe],deleting:[Es,xe]})})),this.Transaction=(k=this,Pt(Ds.prototype,function(R,F,C,D,I){var B=this;R!=="readonly"&&F.forEach(function(O){O=(O=C[O])===null||O===void 0?void 0:O.yProps,O&&(F=F.concat(O.map(function(L){return L.updatesTable})))}),this.db=k,this.mode=R,this.storeNames=F,this.schema=C,this.chromeTransactionDurability=D,this.idbtrans=null,this.on=Ct(this,"complete","error","abort"),this.parent=I||null,this.active=!0,this._reculock=0,this._blockedFuncs=[],this._resolve=null,this._reject=null,this._waitingFor=null,this._waitingQueue=null,this._spinCount=0,this._completion=new ce(function(O,L){B._resolve=O,B._reject=L}),this._completion.then(function(){B.active=!1,B.on.complete.fire()},function(O){var L=B.active;return B.active=!1,B.on.error.fire(O),B.parent?B.parent._reject(O):L&&B.idbtrans&&B.idbtrans.abort(),Ie(O)})})),this.Version=(S=this,Pt(Ms.prototype,function(R){this.db=S,this._cfg={version:R,storesSource:null,dbschema:{},tables:{},contentUpgrade:null}})),this.WhereClause=(x=this,Pt(mr.prototype,function(R,F,C){if(this.db=x,this._ctx={table:R,index:F===":id"?null:F,or:C},this._cmp=this._ascending=Te,this._descending=function(D,I){return Te(I,D)},this._max=function(D,I){return 0<Te(D,I)?D:I},this._min=function(D,I){return Te(D,I)<0?D:I},this._IDBKeyRange=x._deps.IDBKeyRange,!this._IDBKeyRange)throw new Z.MissingAPI})),this.on("versionchange",function(R){0<R.newVersion?console.warn("Another connection wants to upgrade database '".concat(h.name,"'. Closing db now to resume the upgrade.")):console.warn("Another connection wants to delete database '".concat(h.name,"'. Closing db now to resume the delete request.")),h.close({disableAutoOpen:!1})}),this.on("blocked",function(R){!R.newVersion||R.newVersion<R.oldVersion?console.warn("Dexie.delete('".concat(h.name,"') was blocked")):console.warn("Upgrade '".concat(h.name,"' blocked by other connection holding version ").concat(R.oldVersion/10))}),this._maxKey=Kt(c.IDBKeyRange),this._createTransaction=function(R,F,C,D){return new h.Transaction(R,F,C,h._options.chromeTransactionDurability,D)},this._fireOnBlocked=function(R){h.on("blocked").fire(R),kt.filter(function(F){return F.name===h.name&&F!==h&&!F._state.vcFired}).map(function(F){return F.on("versionchange").fire(R)})},this.use(js),this.use(Gs),this.use(zs),this.use(Vs),this.use(Hs);var K=new Proxy(this,{get:function(R,F,C){if(F==="_vip")return!0;if(F==="table")return function(I){return un(h.table(I),K)};var D=Reflect.get(R,F,C);return D instanceof dr?un(D,K):F==="tables"?D.map(function(I){return un(I,K)}):F==="_createTransaction"?function(){return un(D.apply(this,arguments),K)}:D}});this.vip=K,f.forEach(function(R){return R(h)})}var ln,ze=typeof Symbol<"u"&&"observable"in Symbol?Symbol.observable:"@@observable",Ys=(Wn.prototype.subscribe=function(o,c,h){return this._subscribe(o&&typeof o!="function"?o:{next:o,error:c,complete:h})},Wn.prototype[ze]=function(){return this},Wn);function Wn(o){this._subscribe=o}try{ln={indexedDB:i.indexedDB||i.mozIndexedDB||i.webkitIndexedDB||i.msIndexedDB,IDBKeyRange:i.IDBKeyRange||i.webkitIDBKeyRange}}catch{ln={indexedDB:null,IDBKeyRange:null}}function Pr(o){var c,h=!1,f=new Ys(function(y){var b=V(o),k,S=!1,x={},N={},K={get closed(){return S},unsubscribe:function(){S||(S=!0,k&&k.abort(),R&&rt.storagemutated.unsubscribe(C))}};y.start&&y.start(K);var R=!1,F=function(){return _n(D)},C=function(I){on(x,I),On(N,x)&&F()},D=function(){var I,B,O;!S&&ln.indexedDB&&(x={},I={},k&&k.abort(),k=new AbortController,O=function(L){var q=bt();try{b&&wt();var Y=Qe(o,L);return Y=b?Y.finally(et):Y}finally{q&&vt()}}(B={subscr:I,signal:k.signal,requery:F,querier:o,trans:null}),Promise.resolve(O).then(function(L){h=!0,c=L,S||B.signal.aborted||(x={},function(q){for(var Y in q)if(v(q,Y))return;return 1}(N=I)||R||(rt(It,C),R=!0),_n(function(){return!S&&y.next&&y.next(L)}))},function(L){h=!1,["DatabaseClosedError","AbortError"].includes(L?.name)||S||_n(function(){S||y.error&&y.error(L)})}))};return setTimeout(F,0),K});return f.hasValue=function(){return h},f.getValue=function(){return c},f}var pt=Je;function Gn(o){var c=st;try{st=!0,rt.storagemutated.fire(o),Vn(o,!0)}finally{st=c}}m(pt,r(r({},Ve),{delete:function(o){return new pt(o,{addons:[]}).delete()},exists:function(o){return new pt(o,{addons:[]}).open().then(function(c){return c.close(),!0}).catch("NoSuchDatabaseError",function(){return!1})},getDatabaseNames:function(o){try{return c=pt.dependencies,h=c.indexedDB,c=c.IDBKeyRange,(Bn(h)?Promise.resolve(h.databases()).then(function(f){return f.map(function(y){return y.name}).filter(function(y){return y!==Wt})}):Kn(h,c).toCollection().primaryKeys()).then(o)}catch{return Ie(new Z.MissingAPI)}var c,h},defineClass:function(){return function(o){l(this,o)}},ignoreTransaction:function(o){return de.trans?lt(de.transless,o):o()},vip:Fn,async:function(o){return function(){try{var c=Hn(o.apply(this,arguments));return c&&typeof c.then=="function"?c:ce.resolve(c)}catch(h){return Ie(h)}}},spawn:function(o,c,h){try{var f=Hn(o.apply(h,c||[]));return f&&typeof f.then=="function"?f:ce.resolve(f)}catch(y){return Ie(y)}},currentTransaction:{get:function(){return de.trans||null}},waitFor:function(o,c){return c=ce.resolve(typeof o=="function"?pt.ignoreTransaction(o):o).timeout(c||6e4),de.trans?de.trans.waitFor(c):c},Promise:ce,debug:{get:function(){return We},set:function(o){Qn(o)}},derive:P,extend:l,props:m,override:ne,Events:Ct,on:rt,liveQuery:Pr,extendObservabilitySet:on,getByKeyPath:Ee,setByKeyPath:ve,delByKeyPath:function(o,c){typeof c=="string"?ve(o,c,void 0):"length"in c&&[].map.call(c,function(h){ve(o,h,void 0)})},shallowClone:Ne,deepClone:E,getObjectDiff:jn,cmp:Te,asap:Se,minKey:-1/0,addons:[],connections:kt,errnames:ge,dependencies:ln,cache:ft,semVer:"4.2.1",version:"4.2.1".split(".").map(function(o){return parseInt(o)}).reduce(function(o,c,h){return o+c/Math.pow(10,2*h)})})),pt.maxKey=Kt(pt.dependencies.IDBKeyRange),typeof dispatchEvent<"u"&&typeof addEventListener<"u"&&(rt(It,function(o){st||(o=new CustomEvent(xn,{detail:o}),st=!0,dispatchEvent(o),st=!1)}),addEventListener(xn,function(o){o=o.detail,st||Gn(o)}));var St,st=!1,Dr=function(){};return typeof BroadcastChannel<"u"&&((Dr=function(){(St=new BroadcastChannel(xn)).onmessage=function(o){return o.data&&Gn(o.data)}})(),typeof St.unref=="function"&&St.unref(),rt(It,function(o){st||St.postMessage(o)})),typeof addEventListener<"u"&&(addEventListener("pagehide",function(o){if(!Je.disableBfCache&&o.persisted){We&&console.debug("Dexie: handling persisted pagehide"),St?.close();for(var c=0,h=kt;c<h.length;c++)h[c].close({disableAutoOpen:!1})}}),addEventListener("pageshow",function(o){!Je.disableBfCache&&o.persisted&&(We&&console.debug("Dexie: handling persisted pageshow"),Dr(),Gn({all:new Ue(-1/0,[[]])}))})),ce.rejectionMapper=function(o,c){return!o||o instanceof fe||o instanceof TypeError||o instanceof SyntaxError||!o.name||!$e[o.name]?o:(c=new $e[o.name](c||o.message,o),"stack"in o&&T(c,"stack",{get:function(){return this.inner.stack}}),c)},Qn(We),r(Je,Object.freeze({__proto__:null,Dexie:Je,liveQuery:Pr,Entity:ar,cmp:Te,PropModification:Nt,replacePrefix:function(o,c){return new Nt({replacePrefix:[o,c]})},add:function(o){return new Nt({add:o})},remove:function(o){return new Nt({remove:o})},default:Je,RangeSet:Ue,mergeRanges:Ut,rangesOverlap:Er}),{default:Je}),Je})})(dexie_min);var dexie_minExports=dexie_min.exports;const _Dexie=getDefaultExportFromCjs(dexie_minExports),DexieSymbol=Symbol.for("Dexie"),Dexie=globalThis[DexieSymbol]||(globalThis[DexieSymbol]=_Dexie);if(_Dexie.semVer!==Dexie.semVer)throw new Error(`Two different versions of Dexie loaded in the same app: ${_Dexie.semVer} and ${Dexie.semVer}`);const{liveQuery,mergeRanges,rangesOverlap,RangeSet,cmp,Entity,PropModification,replacePrefix,add,remove,DexieYProvider}=Dexie;async function eventTagsWarmUp(n,e){const t=await e.limit(n.maxSize).toArray();for(const r of t)n.add(r.tagValue,r.eventId,!1)}var eventTagsDump=(n,e)=>async(t,r)=>{const s=[];for(const i of t){const a=r.get(i);if(a)for(const u of a)s.push({tagValue:i,eventId:u})}s.length>0&&(e(`Saving ${s.length} events cache entries to database`),await n.bulkPut(s)),t.clear()};async function eventsWarmUp(n,e){const t=await e.limit(n.maxSize).toArray();for(const r of t)n.set(r.id,r,!1)}var eventsDump=(n,e)=>async(t,r)=>{const s=[];for(const i of t){const a=r.get(i);a&&s.push(a)}s.length>0&&(e(`Saving ${s.length} events cache entries to database`),await n.bulkPut(s)),t.clear()};async function nip05WarmUp(n,e){const t=await e.limit(n.maxSize).toArray();for(const r of t)n.set(r.nip05,r,!1)}var nip05Dump=(n,e)=>async(t,r)=>{const s=[];for(const i of t){const a=r.get(i);a&&s.push({nip05:i,...a})}s.length&&(e(`Saving ${s.length} NIP-05 cache entries to database`),await n.bulkPut(s)),t.clear()},Database=class extends Dexie{profiles;events;eventTags;nip05;lnurl;relayStatus;unpublishedEvents;constructor(n){super(n),this.version(15).stores({profiles:"&pubkey",events:"&id, kind",eventTags:"&tagValue",nip05:"&nip05",lnurl:"&pubkey",relayStatus:"&url",unpublishedEvents:"&id"})}},db;function createDatabase(n){db=new Database(n)}var d=createDebug2("ndk:dexie-adapter:profiles");async function profilesWarmUp(n,e){const t=await e.limit(n.maxSize).toArray();for(const r of t){const s=r;n.set(r.pubkey,s,!1)}d("Loaded %d profiles from database",n.size())}var profilesDump=(n,e)=>async(t,r)=>{const s=[];for(const i of t){const a=r.get(i);a&&s.push(a)}s.length&&(e(`Saving ${s.length} users to database`),await n.bulkPut(s)),t.clear()};async function relayInfoWarmUp(n,e){const t=await e.limit(n.maxSize).toArray();for(const r of t)n.set(r.url,{url:r.url,updatedAt:r.updatedAt,lastConnectedAt:r.lastConnectedAt,dontConnectBefore:r.dontConnectBefore},!1)}var relayInfoDump=(n,e)=>async(t,r)=>{const s=[];for(const i of t){const a=r.get(i);a&&s.push({url:i,updatedAt:a.updatedAt,lastConnectedAt:a.lastConnectedAt,dontConnectBefore:a.dontConnectBefore})}s.length>0&&(e(`Saving ${s.length} relay status cache entries to database`),await n.bulkPut(s)),t.clear()},WRITE_STATUS_THRESHOLD=3;async function unpublishedEventsWarmUp(n,e){await e.each(t=>{n.set(t.event.id,t,!1)})}function unpublishedEventsDump(n,e){return async(t,r)=>{const s=[];for(const i of t){const a=r.get(i);a&&s.push(a)}s.length>0&&(e(`Saving ${s.length} unpublished events cache entries to database`),await n.bulkPut(s)),t.clear()}}async function discardUnpublishedEvent(n,e){await n.delete(e)}async function getUnpublishedEvents(n){const e=[];return await n.each(t=>{e.push({event:new NDKEvent(void 0,t.event),relays:Object.keys(t.relays),lastTryAt:t.lastTryAt})}),e}function addUnpublishedEvent(n,e){const t={};e.forEach(s=>t[s]=!1),this.unpublishedEvents.set(n.id,{id:n.id,event:n.rawEvent(),relays:t});const r=s=>{const i=s.url,a=this.unpublishedEvents.get(n.id);if(!a){n.off("publushed",r);return}a.relays[i]=!0,this.unpublishedEvents.set(n.id,a);const u=Object.values(a.relays).filter(p=>p).length,l=Object.values(a.relays).length-u;(u>=WRITE_STATUS_THRESHOLD||l===0)&&(this.unpublishedEvents.delete(n.id),n.off("published",r))};n.on("published",r)}async function zapperWarmUp(n,e){const t=await e.limit(n.maxSize).toArray();for(const r of t)n.set(r.pubkey,{document:r.document,fetchedAt:r.fetchedAt},!1)}var zapperDump=(n,e)=>async(t,r)=>{const s=[];for(const i of t){const a=r.get(i);a&&s.push({pubkey:i,...a})}s.length&&(e(`Saving ${s.length} zapper cache entries to database`),await n.bulkPut(s)),t.clear()},CacheHandler=class{cache;dirtyKeys=new Set;options;debug;indexes;isSet=!1;maxSize=0;constructor(n){this.debug=n.debug,this.options=n,this.maxSize=n.maxSize,n.maxSize>0&&(this.cache=new dist.LRUCache({maxSize:n.maxSize}),setInterval(()=>this.dump().catch(console.error),1e3*10)),this.indexes=new Map}getSet(n){return this.cache?.get(n)}getAllWithFilter(n){const e=new Map;return this.cache?.forEach((t,r)=>{n(r,t)&&e.set(r,t)}),e}get(n){return this.cache?.get(n)}async getWithFallback(n,e){let t=this.get(n);return t||(t=await e.get(n),t&&this.set(n,t)),t}async getManyWithFallback(n,e){const t=[],r=[];for(const s of n){const i=this.get(s);i?t.push(i):r.push(s)}if(t.length>0&&this.debug(`Cache hit for keys ${t.length} and miss for ${r.length} keys`),r.length>0){const s=Date.now(),i=await e.bulkGet(r),a=Date.now();let u=0;for(const l of i)l&&(this.set(l.id,l),t.push(l),u++);this.debug(`Time spent querying database: ${a-s}ms for ${r.length} keys, which added ${u} entries to the cache`)}return t}add(n,e,t=!0){const r=this.get(n)??new Set;r.add(e),this.cache?.set(n,r),t&&this.dirtyKeys.add(n)}set(n,e,t=!0){this.cache?.set(n,e),t&&this.dirtyKeys.add(n);for(const[r,s]of this.indexes.entries()){const i=e[r];if(i){const a=s.get(i)||new Set;a.add(n),s.set(i,a)}}}size(){return this.cache?.size||0}delete(n){this.cache?.delete(n),this.dirtyKeys.add(n)}async dump(){this.dirtyKeys.size>0&&this.cache&&(await this.options.dump(this.dirtyKeys,this.cache),this.dirtyKeys.clear())}addIndex(n){this.indexes.set(n,new dist.LRUCache({maxSize:this.options.maxSize}))}getFromIndex(n,e){const t=new Set,r=this.indexes.get(n);if(r){const s=r.get(e);if(s)for(const i of s.values()){const a=this.get(i);a&&t.add(a)}}return t}},INDEXABLE_TAGS_LIMIT=10,NDKCacheAdapterDexie=class{debug;locking=!1;ready=!1;profiles;zappers;nip05s;events;eventTags;relayInfo;unpublishedEvents;warmedUp=!1;warmUpPromise;devMode=!1;saveSig;_onReady;constructor(n={}){createDatabase(n.dbName||"ndk"),this.debug=n.debug||createDebug2("ndk:dexie-adapter"),this.saveSig=n.saveSig||!1,this.profiles=new CacheHandler({maxSize:n.profileCacheSize||1e5,dump:profilesDump(db.profiles,this.debug),debug:this.debug}),this.zappers=new CacheHandler({maxSize:n.zapperCacheSize||200,dump:zapperDump(db.lnurl,this.debug),debug:this.debug}),this.nip05s=new CacheHandler({maxSize:n.nip05CacheSize||1e3,dump:nip05Dump(db.nip05,this.debug),debug:this.debug}),this.events=new CacheHandler({maxSize:n.eventCacheSize||5e4,dump:eventsDump(db.events,this.debug),debug:this.debug}),this.events.addIndex("pubkey"),this.events.addIndex("kind"),this.eventTags=new CacheHandler({maxSize:n.eventTagsCacheSize||1e5,dump:eventTagsDump(db.eventTags,this.debug),debug:this.debug}),this.relayInfo=new CacheHandler({maxSize:500,debug:this.debug,dump:relayInfoDump(db.relayStatus,this.debug)}),this.unpublishedEvents=new CacheHandler({maxSize:5e3,debug:this.debug,dump:unpublishedEventsDump(db.unpublishedEvents,this.debug)});const e=(r,s)=>{const i=Date.now();return s().then(()=>{const a=Date.now();this.debug(r,"took",a-i,"ms")})},t=Date.now();this.warmUpPromise=Promise.allSettled([e("profilesWarmUp",()=>profilesWarmUp(this.profiles,db.profiles)),e("zapperWarmUp",()=>zapperWarmUp(this.zappers,db.lnurl)),e("nip05WarmUp",()=>nip05WarmUp(this.nip05s,db.nip05)),e("relayInfoWarmUp",()=>relayInfoWarmUp(this.relayInfo,db.relayStatus)),e("unpublishedEventsWarmUp",()=>unpublishedEventsWarmUp(this.unpublishedEvents,db.unpublishedEvents)),e("eventsWarmUp",()=>eventsWarmUp(this.events,db.events)),e("eventTagsWarmUp",()=>eventTagsWarmUp(this.eventTags,db.eventTags))]),this.warmUpPromise.then(()=>{const r=Date.now();this.warmedUp=!0,this.ready=!0,this.locking=!0,this.debug("Warm up completed, time",r-t,"ms"),this._onReady&&this._onReady()})}onReady(n){this._onReady=n}async query(n){if(!this.warmedUp){const r=Date.now();await this.warmUpPromise,this.debug("froze query for",Date.now()-r,"ms",n.filters)}const e=Date.now();n.filters.map(r=>this.processFilter(r,n));const t=Date.now()-e;return t>100&&this.debug("query took",t,"ms",n.filter),[]}async fetchProfile(n){return this.profiles?await this.profiles.getWithFallback(n,db.profiles):null}fetchProfileSync(n){return this.profiles?this.profiles.get(n):null}async getProfiles(n){if(this.profiles)return this.profiles.getAllWithFilter(n)}saveProfile(n,e){const t=this.profiles.get(n);if(t?.created_at&&e.created_at&&t.created_at>=e.created_at)return;const r=Math.floor(Date.now()/1e3);this.profiles.set(n,{pubkey:n,...e,cachedAt:r}),this.debug("Saved profile for pubkey",n,e)}async loadNip05(n,e=3600){const t=this.nip05s?.get(n);if(t){if(t.profile===null)return t.fetchedAt+e*1e3<Date.now()?"missing":null;try{return JSON.parse(t.profile)}catch{return"missing"}}const r=await db.nip05.get({nip05:n});if(!r)return"missing";const s=Date.now();if(r.profile===null)return r.fetchedAt+e*1e3<s?"missing":null;try{return JSON.parse(r.profile)}catch{return"missing"}}async saveNip05(n,e){try{const t=e?JSON.stringify(e):null;this.nip05s.set(n,{profile:t,fetchedAt:Date.now()})}catch(t){console.error("Failed to save NIP-05 profile for nip05:",n,t)}}async loadUsersLNURLDoc(n,e=86400,t=3600){const r=this.zappers?.get(n);if(r){if(r.document===null)return r.fetchedAt+t*1e3<Date.now()?"missing":null;try{return JSON.parse(r.document)}catch{return"missing"}}const s=await db.lnurl.get({pubkey:n});if(!s)return"missing";const i=Date.now();if(s.fetchedAt+e*1e3<i)return"missing";if(s.document===null)return s.fetchedAt+t*1e3<i?"missing":null;try{return JSON.parse(s.document)}catch{return"missing"}}async saveUsersLNURLDoc(n,e){try{const t=e?JSON.stringify(e):null;this.zappers?.set(n,{document:t,fetchedAt:Date.now()})}catch(t){console.error("Failed to save LNURL document for pubkey:",n,t)}}processFilter(n,e){const t={...n};t.limit=void 0;const r=new Set(Object.keys(t||{}));r.delete("since"),r.delete("limit"),r.delete("until");try{if(this.byNip33Query(r,n,e)||this.byAuthors(n,e)||this.byIdsQuery(n,e)||this.byTags(n,e)||this.byKinds(r,n,e))return}catch(s){console.error(s)}}async deleteEventIds(n){n.forEach(e=>this.events.delete(e)),await db.events.where({id:n}).delete()}addUnpublishedEvent=addUnpublishedEvent.bind(this);getUnpublishedEvents=()=>getUnpublishedEvents(db.unpublishedEvents);discardUnpublishedEvent=n=>discardUnpublishedEvent(db.unpublishedEvents,n);async setEvent(n,e,t){if(n.kind===0){if(!this.profiles)return;try{const s=profileFromEvent(n);this.saveProfile(n.pubkey,s)}catch{this.debug(`Failed to save profile for pubkey: ${n.pubkey}`)}}let r=!0;if(n.isParamReplaceable()){const s=this.events.get(n.tagId());s&&n.created_at&&s.createdAt>n.created_at&&(r=!1)}if(r){const s={id:n.tagId(),pubkey:n.pubkey,kind:n.kind,createdAt:n.created_at??Date.now(),relay:t?.url,event:n.serialize(this.saveSig,!0)};this.saveSig&&n.sig&&(s.sig=n.sig),this.events.set(n.tagId(),s);const i=getIndexableTags(n);for(const a of i)this.eventTags.add(a[0]+a[1],n.tagId())}}updateRelayStatus(n,e){const t={url:n,updatedAt:Date.now(),...e};this.relayInfo.set(n,t)}getRelayStatus(n){const e=this.relayInfo.get(n);if(e)return{lastConnectedAt:e.lastConnectedAt,dontConnectBefore:e.dontConnectBefore}}byAuthors(n,e){if(!n.authors)return!1;let t=0;for(const r of n.authors){let s=Array.from(this.events.getFromIndex("pubkey",r));n.kinds&&(s=s.filter(i=>n.kinds?.includes(i.kind))),foundEvents(e,s,n),t+=s.length}return!0}byIdsQuery(n,e){if(n.ids){for(const t of n.ids){const r=this.events.get(t);r&&foundEvent(e,r,r.relay,n)}return!0}return!1}byNip33Query(n,e,t){const r=["#d","authors","kinds"];if(n.size===r.length&&r.every(i=>n.has(i))&&e.kinds&&e.authors){for(const i of e.kinds)if(i>=3e4&&i<4e4)for(const u of e.authors)for(const l of e["#d"]){const p=`${i}:${u}:${l}`,g=this.events.get(p);g&&foundEvent(t,g,g.relay,e)}return!0}return!1}byTags(n,e){const t=Object.entries(n).filter(([r])=>r.startsWith("#")&&r.length===2).map(([r,s])=>[r[1],s]);if(t.length===0)return!1;for(const[r,s]of t)for(const i of s){const a=r+i,u=this.eventTags.getSet(a);u&&u.forEach(l=>{const p=this.events.get(l);p&&(!n.kinds||n.kinds.includes(p.kind))&&foundEvent(e,p,p.relay,n)})}return!0}byKinds(n,e,t){if(!e.kinds||n.size!==1||!n.has("kinds"))return!1;const r=e.limit||500;let s=0;const i=new Set,a=[...e.kinds].sort((u,l)=>(this.events.indexes.get("kind")?.get(u)?.size||0)-(this.events.indexes.get("kind")?.get(l)?.size||0));for(const u of a){const l=this.events.getFromIndex("kind",u);for(const p of l)if(!i.has(p.id)&&(i.add(p.id),foundEvent(t,p,p.relay,e),s++,s>=r))break;if(s>=r)break}return!0}};function foundEvents(n,e,t){t?.limit&&e.length>t.limit&&(e=e.sort((r,s)=>s.createdAt-r.createdAt).slice(0,t.limit));for(const r of e)foundEvent(n,r,r.relay,t)}function foundEvent(n,e,t,r){try{const s=deserialize(e.event);if(r&&!matchFilter(r,s))return;const i=new NDKEvent(void 0,s),a=t?n.pool.getRelay(t,!1):void 0;i.relay=a,n.eventReceived(i,a,!0)}catch(s){console.error("failed to deserialize event",s)}}function getIndexableTags(n){const e=[];if(n.kind===3)return[];for(const t of n.tags)if(t[0].length===1&&(e.push(t),e.length>=INDEXABLE_TAGS_LIMIT))return[];return e}const relayUrls=["wss://relay.damus.io","wss://relay.nostr.band","wss://nos.lol"];let ndkInstance=null;function getNDK(){if(!ndkInstance){const n=new NDKCacheAdapterDexie({dbName:"fairfield-nostr-cache"});ndkInstance=new NDK({explicitRelayUrls:relayUrls,cacheAdapter:n})}return ndkInstance}const ndk=getNDK();export{channelStore as c,ndk as n};
//# sourceMappingURL=CSRwVd6A.js.map
