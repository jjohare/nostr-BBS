import{w as writable}from"./DkN-uFVr.js";import{h as createView$1,i as assert,j as checkOpts,t as toBytes$1,k as hmac$1,l as u32,s as sha256$2,r as randomBytes$1,x as xchacha20poly1305,o as concatBytes$1,p as bech32$1,q as bytesToHex$1,v as hexToBytes$1,n as nip19_exports$1,w as matchFilters,g as getPublicKey,a as generateSecretKey,f as finalizeEvent,b as nip44_exports,c as nip04_exports}from"./C3bkP_Kp.js";var commonjsGlobal=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function getDefaultExportFromCjs(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var lib$1={},types={};Object.defineProperty(types,"__esModule",{value:!0});var ee={},taskCollection$1={},taskCollection={},utils$1={};Object.defineProperty(utils$1,"__esModule",{value:!0});utils$1._fast_remove_single=void 0;function _fast_remove_single(t,e){e!==-1&&(e===0?t.shift():e===t.length-1?t.length=t.length-1:t.splice(e,1))}utils$1._fast_remove_single=_fast_remove_single;var bakeCollection={};(function(exports$1){Object.defineProperty(exports$1,"__esModule",{value:!0}),exports$1.bakeCollectionVariadic=exports$1.bakeCollectionAwait=exports$1.bakeCollection=exports$1.BAKED_EMPTY_FUNC=void 0,exports$1.BAKED_EMPTY_FUNC=function(){};var FORLOOP_FALLBACK=1500;function generateArgsDefCode(t){var e="";if(t===0)return e;for(var s=0;s<t-1;++s)e+="arg"+String(s)+", ";return e+="arg"+String(t-1),e}function generateBodyPartsCode(t,e){for(var s="",n="",i=0;i<e;++i)s+="var f".concat(i," = collection[").concat(i,`];
`),n+="f".concat(i,"(").concat(t,`)
`);return{funcDefCode:s,funcCallCode:n}}function generateBodyPartsVariadicCode(t){for(var e="",s="",n=0;n<t;++n)e+="var f".concat(n," = collection[").concat(n,`];
`),s+="f".concat(n,`.apply(undefined, arguments)
`);return{funcDefCode:e,funcCallCode:s}}function bakeCollection(collection,fixedArgsNum){if(collection.length===0)return exports$1.BAKED_EMPTY_FUNC;if(collection.length===1)return collection[0];var funcFactoryCode;if(collection.length<FORLOOP_FALLBACK){var argsDefCode=generateArgsDefCode(fixedArgsNum),_a=generateBodyPartsCode(argsDefCode,collection.length),funcDefCode=_a.funcDefCode,funcCallCode=_a.funcCallCode;funcFactoryCode=`(function(collection) {
            `.concat(funcDefCode,`
            collection = undefined;
            return (function(`).concat(argsDefCode,`) {
                `).concat(funcCallCode,`
            });
        })`)}else{var argsDefCode=generateArgsDefCode(fixedArgsNum);collection.length%10===0?funcFactoryCode=`(function(collection) {
                return (function(`.concat(argsDefCode,`) {
                    for (var i = 0; i < collection.length; i += 10) {
                        collection[i](`).concat(argsDefCode,`);
                        collection[i+1](`).concat(argsDefCode,`);
                        collection[i+2](`).concat(argsDefCode,`);
                        collection[i+3](`).concat(argsDefCode,`);
                        collection[i+4](`).concat(argsDefCode,`);
                        collection[i+5](`).concat(argsDefCode,`);
                        collection[i+6](`).concat(argsDefCode,`);
                        collection[i+7](`).concat(argsDefCode,`);
                        collection[i+8](`).concat(argsDefCode,`);
                        collection[i+9](`).concat(argsDefCode,`);
                    }
                });
            })`):collection.length%4===0?funcFactoryCode=`(function(collection) {
                return (function(`.concat(argsDefCode,`) {
                    for (var i = 0; i < collection.length; i += 4) {
                        collection[i](`).concat(argsDefCode,`);
                        collection[i+1](`).concat(argsDefCode,`);
                        collection[i+2](`).concat(argsDefCode,`);
                        collection[i+3](`).concat(argsDefCode,`);
                    }
                });
            })`):collection.length%3===0?funcFactoryCode=`(function(collection) {
                return (function(`.concat(argsDefCode,`) {
                    for (var i = 0; i < collection.length; i += 3) {
                        collection[i](`).concat(argsDefCode,`);
                        collection[i+1](`).concat(argsDefCode,`);
                        collection[i+2](`).concat(argsDefCode,`);
                    }
                });
            })`):funcFactoryCode=`(function(collection) {
                return (function(`.concat(argsDefCode,`) {
                    for (var i = 0; i < collection.length; ++i) {
                        collection[i](`).concat(argsDefCode,`);
                    }
                });
            })`)}{var funcFactory=eval(funcFactoryCode);return funcFactory(collection)}}exports$1.bakeCollection=bakeCollection;function bakeCollectionAwait(collection,fixedArgsNum){if(collection.length===0)return exports$1.BAKED_EMPTY_FUNC;if(collection.length===1)return collection[0];var funcFactoryCode;if(collection.length<FORLOOP_FALLBACK){var argsDefCode=generateArgsDefCode(fixedArgsNum),_a=generateBodyPartsCode(argsDefCode,collection.length),funcDefCode=_a.funcDefCode,funcCallCode=_a.funcCallCode;funcFactoryCode=`(function(collection) {
            `.concat(funcDefCode,`
            collection = undefined;
            return (function(`).concat(argsDefCode,`) {
                return Promise.all([ `).concat(funcCallCode,` ]);
            });
        })`)}else{var argsDefCode=generateArgsDefCode(fixedArgsNum);funcFactoryCode=`(function(collection) {
            return (function(`.concat(argsDefCode,`) {
                var promises = Array(collection.length);
                for (var i = 0; i < collection.length; ++i) {
                    promises[i] = collection[i](`).concat(argsDefCode,`);
                }
                return Promise.all(promises);
            });
        })`)}{var funcFactory=eval(funcFactoryCode);return funcFactory(collection)}}exports$1.bakeCollectionAwait=bakeCollectionAwait;function bakeCollectionVariadic(collection){if(collection.length===0)return exports$1.BAKED_EMPTY_FUNC;if(collection.length===1)return collection[0];var funcFactoryCode;if(collection.length<FORLOOP_FALLBACK){var _a=generateBodyPartsVariadicCode(collection.length),funcDefCode=_a.funcDefCode,funcCallCode=_a.funcCallCode;funcFactoryCode=`(function(collection) {
            `.concat(funcDefCode,`
            collection = undefined;
            return (function() {
                `).concat(funcCallCode,`
            });
        })`)}else funcFactoryCode=`(function(collection) {
            return (function() {
                for (var i = 0; i < collection.length; ++i) {
                    collection[i].apply(undefined, arguments);
                }
            });
        })`;{var funcFactory=eval(funcFactoryCode);return funcFactory(collection)}}exports$1.bakeCollectionVariadic=bakeCollectionVariadic})(bakeCollection);var __spreadArray$1=commonjsGlobal&&commonjsGlobal.__spreadArray||function(t,e,s){if(s||arguments.length===2)for(var n=0,i=e.length,r;n<i;n++)(r||!(n in e))&&(r||(r=Array.prototype.slice.call(e,0,n)),r[n]=e[n]);return t.concat(r||Array.prototype.slice.call(e))};Object.defineProperty(taskCollection,"__esModule",{value:!0});taskCollection.TaskCollection=void 0;var utils_1$1=utils$1,bake_collection_1=bakeCollection;function push_norebuild(t,e){var s=this.length;if(s>1)if(e){var n;(n=this._tasks).push.apply(n,arguments),this.length+=arguments.length}else this._tasks.push(t),this.length++;else if(e){if(s===1){var i=Array(1+arguments.length);i.push(i),i.push.apply(i,arguments),this._tasks=i}else{var i=Array(arguments.length);i.push.apply(i,arguments),this._tasks=i}this.length+=arguments.length}else s===1?this._tasks=[this._tasks,t]:this._tasks=t,this.length++}function push_rebuild(t,e){var s=this.length;if(s>1)if(e){var n;(n=this._tasks).push.apply(n,arguments),this.length+=arguments.length}else this._tasks.push(t),this.length++;else if(e){if(s===1){var i=Array(1+arguments.length);i.push(i),i.push.apply(i,arguments),this._tasks=i}else{var i=Array(arguments.length);i.push.apply(i,arguments),this._tasks=i}this.length+=arguments.length}else s===1?this._tasks=[this._tasks,t]:this._tasks=t,this.length++;this.firstEmitBuildStrategy?this.call=rebuild_on_first_call:this.rebuild()}function removeLast_norebuild(t){this.length!==0&&(this.length===1?this._tasks===t&&(this.length=0):((0,utils_1$1._fast_remove_single)(this._tasks,this._tasks.lastIndexOf(t)),this._tasks.length===1?(this._tasks=this._tasks[0],this.length=1):this.length=this._tasks.length))}function removeLast_rebuild(t){if(this.length!==0){if(this.length===1)if(this._tasks===t&&(this.length=0),this.firstEmitBuildStrategy){this.call=bake_collection_1.BAKED_EMPTY_FUNC;return}else{this.rebuild();return}else(0,utils_1$1._fast_remove_single)(this._tasks,this._tasks.lastIndexOf(t)),this._tasks.length===1?(this._tasks=this._tasks[0],this.length=1):this.length=this._tasks.length;this.firstEmitBuildStrategy?this.call=rebuild_on_first_call:this.rebuild()}}function insert_norebuild(t){for(var e,s=[],n=1;n<arguments.length;n++)s[n-1]=arguments[n];this.length===0?(this._tasks=s,this.length=1):this.length===1?(s.unshift(this._tasks),this._tasks=s,this.length=this._tasks.length):((e=this._tasks).splice.apply(e,__spreadArray$1([t,0],s,!1)),this.length=this._tasks.length)}function insert_rebuild(t){for(var e,s=[],n=1;n<arguments.length;n++)s[n-1]=arguments[n];this.length===0?(this._tasks=s,this.length=1):this.length===1?(s.unshift(this._tasks),this._tasks=s,this.length=this._tasks.length):((e=this._tasks).splice.apply(e,__spreadArray$1([t,0],s,!1)),this.length=this._tasks.length),this.firstEmitBuildStrategy?this.call=rebuild_on_first_call:this.rebuild()}function rebuild_noawait(){this.length===0?this.call=bake_collection_1.BAKED_EMPTY_FUNC:this.length===1?this.call=this._tasks:this.call=(0,bake_collection_1.bakeCollection)(this._tasks,this.argsNum)}function rebuild_await(){this.length===0?this.call=bake_collection_1.BAKED_EMPTY_FUNC:this.length===1?this.call=this._tasks:this.call=(0,bake_collection_1.bakeCollectionAwait)(this._tasks,this.argsNum)}function rebuild_on_first_call(){this.rebuild(),this.call.apply(void 0,arguments)}var TaskCollection=function(){function t(e,s,n,i){s===void 0&&(s=!0),n===void 0&&(n=null),i===void 0&&(i=!1),this.awaitTasks=i,this.call=bake_collection_1.BAKED_EMPTY_FUNC,this.argsNum=e,this.firstEmitBuildStrategy=!0,i?this.rebuild=rebuild_await.bind(this):this.rebuild=rebuild_noawait.bind(this),this.setAutoRebuild(s),n?typeof n=="function"?(this._tasks=n,this.length=1):(this._tasks=n,this.length=n.length):(this._tasks=null,this.length=0),s&&this.rebuild()}return t}();taskCollection.TaskCollection=TaskCollection;function fastClear(){this._tasks=null,this.length=0,this.call=bake_collection_1.BAKED_EMPTY_FUNC}function clear(){this._tasks=null,this.length=0,this.call=bake_collection_1.BAKED_EMPTY_FUNC}function growArgsNum(t){this.argsNum<t&&(this.argsNum=t,this.firstEmitBuildStrategy?this.call=rebuild_on_first_call:this.rebuild())}function setAutoRebuild(t){t?(this.push=push_rebuild.bind(this),this.insert=insert_rebuild.bind(this),this.removeLast=removeLast_rebuild.bind(this)):(this.push=push_norebuild.bind(this),this.insert=insert_norebuild.bind(this),this.removeLast=removeLast_norebuild.bind(this))}function tasksAsArray(){return this.length===0?[]:this.length===1?[this._tasks]:this._tasks}function setTasks(t){t.length===0?(this.length=0,this.call=bake_collection_1.BAKED_EMPTY_FUNC):t.length===1?(this.length=1,this.call=t[0],this._tasks=t[0]):(this.length=t.length,this._tasks=t,this.firstEmitBuildStrategy?this.call=rebuild_on_first_call:this.rebuild())}TaskCollection.prototype.fastClear=fastClear;TaskCollection.prototype.clear=clear;TaskCollection.prototype.growArgsNum=growArgsNum;TaskCollection.prototype.setAutoRebuild=setAutoRebuild;TaskCollection.prototype.tasksAsArray=tasksAsArray;TaskCollection.prototype.setTasks=setTasks;(function(t){var e=commonjsGlobal&&commonjsGlobal.__createBinding||(Object.create?function(n,i,r,o){o===void 0&&(o=r);var a=Object.getOwnPropertyDescriptor(i,r);(!a||("get"in a?!i.__esModule:a.writable||a.configurable))&&(a={enumerable:!0,get:function(){return i[r]}}),Object.defineProperty(n,o,a)}:function(n,i,r,o){o===void 0&&(o=r),n[o]=i[r]}),s=commonjsGlobal&&commonjsGlobal.__exportStar||function(n,i){for(var r in n)r!=="default"&&!Object.prototype.hasOwnProperty.call(i,r)&&e(i,n,r)};Object.defineProperty(t,"__esModule",{value:!0}),s(taskCollection,t)})(taskCollection$1);var utils={};Object.defineProperty(utils,"__esModule",{value:!0});utils.nullObj=void 0;function nullObj(){var t={};return t.__proto__=null,t}utils.nullObj=nullObj;var __spreadArray=commonjsGlobal&&commonjsGlobal.__spreadArray||function(t,e,s){if(s||arguments.length===2)for(var n=0,i=e.length,r;n<i;n++)(r||!(n in e))&&(r||(r=Array.prototype.slice.call(e,0,n)),r[n]=e[n]);return t.concat(r||Array.prototype.slice.call(e))};Object.defineProperty(ee,"__esModule",{value:!0});ee.EventEmitter=void 0;var task_collection_1=taskCollection$1,utils_1=utils$1,utils_2=utils;function emit(t,e,s,n,i,r){var o=this.events[t];if(o){if(o.length===0)return!1;if(o.argsNum<6)o.call(e,s,n,i,r);else{for(var a=new Array(o.argsNum),c=0,l=a.length;c<l;++c)a[c]=arguments[c+1];o.call.apply(void 0,a)}return!0}return!1}function emitHasOnce(t,e,s,n,i,r){var o=this.events[t],a;if(o!==void 0){if(o.length===0)return!1;if(o.argsNum<6)o.call(e,s,n,i,r);else{a=new Array(o.argsNum);for(var c=0,l=a.length;c<l;++c)a[c]=arguments[c+1];o.call.apply(void 0,a)}}var u=this.onceEvents[t];if(u){if(typeof u=="function")if(this.onceEvents[t]=void 0,arguments.length<6)u(e,s,n,i,r);else{if(a===void 0){a=new Array(arguments.length-1);for(var c=0,l=a.length;c<l;++c)a[c]=arguments[c+1]}u.apply(void 0,a)}else{var h=u;if(this.onceEvents[t]=void 0,arguments.length<6)for(var c=0;c<h.length;++c)h[c](e,s,n,i,r);else{if(a===void 0){a=new Array(arguments.length-1);for(var c=0,l=a.length;c<l;++c)a[c]=arguments[c+1]}for(var c=0;c<h.length;++c)h[c].apply(void 0,a)}}return!0}return o!==void 0}var EventEmitter=function(){function t(){this.events=(0,utils_2.nullObj)(),this.onceEvents=(0,utils_2.nullObj)(),this._symbolKeys=new Set,this.maxListeners=1/0}return Object.defineProperty(t.prototype,"_eventsCount",{get:function(){return this.eventNames().length},enumerable:!1,configurable:!0}),t}();ee.EventEmitter=EventEmitter;function once(t,e){switch(this.emit===emit&&(this.emit=emitHasOnce),typeof this.onceEvents[t]){case"undefined":this.onceEvents[t]=e,typeof t=="symbol"&&this._symbolKeys.add(t);break;case"function":this.onceEvents[t]=[this.onceEvents[t],e];break;case"object":this.onceEvents[t].push(e)}return this}function addListener(t,e,s){if(s===void 0&&(s=e.length),typeof e!="function")throw new TypeError("The listener must be a function");var n=this.events[t];return n?(n.push(e),n.growArgsNum(s),this.maxListeners!==1/0&&this.maxListeners<=n.length&&console.warn('Maximum event listeners for "'.concat(String(t),'" event!'))):(this.events[t]=new task_collection_1.TaskCollection(s,!0,e,!1),typeof t=="symbol"&&this._symbolKeys.add(t)),this}function removeListener(t,e){var s=this.events[t];s&&s.removeLast(e);var n=this.onceEvents[t];return n&&(typeof n=="function"?this.onceEvents[t]=void 0:typeof n=="object"&&(n.length===1&&n[0]===e?this.onceEvents[t]=void 0:(0,utils_1._fast_remove_single)(n,n.lastIndexOf(e)))),this}function addListenerBound(t,e,s,n){s===void 0&&(s=this),n===void 0&&(n=e.length),this.boundFuncs||(this.boundFuncs=new Map);var i=e.bind(s);return this.boundFuncs.set(e,i),this.addListener(t,i,n)}function removeListenerBound(t,e){var s,n,i=(s=this.boundFuncs)===null||s===void 0?void 0:s.get(e);return(n=this.boundFuncs)===null||n===void 0||n.delete(e),this.removeListener(t,i)}function hasListeners(t){return this.events[t]&&!!this.events[t].length}function prependListener(t,e,s){if(s===void 0&&(s=e.length),typeof e!="function")throw new TypeError("The listener must be a function");var n=this.events[t];return!n||!(n instanceof task_collection_1.TaskCollection)?(n=this.events[t]=new task_collection_1.TaskCollection(s,!0,e,!1),typeof t=="symbol"&&this._symbolKeys.add(t)):(n.insert(0,e),n.growArgsNum(s),this.maxListeners!==1/0&&this.maxListeners<=n.length&&console.warn('Maximum event listeners for "'.concat(String(t),'" event!'))),this}function prependOnceListener(t,e){this.emit===emit&&(this.emit=emitHasOnce);var s=this.onceEvents[t];return s?typeof s!="object"?(this.onceEvents[t]=[e,s],typeof t=="symbol"&&this._symbolKeys.add(t)):(s.unshift(e),this.maxListeners!==1/0&&this.maxListeners<=s.length&&console.warn('Maximum event listeners for "'.concat(String(t),'" once event!'))):(this.onceEvents[t]=[e],typeof t=="symbol"&&this._symbolKeys.add(t)),this}function removeAllListeners(t){return t===void 0?(this.events=(0,utils_2.nullObj)(),this.onceEvents=(0,utils_2.nullObj)(),this._symbolKeys=new Set):(this.events[t]=void 0,this.onceEvents[t]=void 0,typeof t=="symbol"&&this._symbolKeys.delete(t)),this}function setMaxListeners(t){return this.maxListeners=t,this}function getMaxListeners(){return this.maxListeners}function listeners(t){return this.emit===emit?this.events[t]?this.events[t].tasksAsArray().slice():[]:this.events[t]&&this.onceEvents[t]?__spreadArray(__spreadArray([],this.events[t].tasksAsArray(),!0),typeof this.onceEvents[t]=="function"?[this.onceEvents[t]]:this.onceEvents[t],!0):this.events[t]?this.events[t].tasksAsArray():this.onceEvents[t]?typeof this.onceEvents[t]=="function"?[this.onceEvents[t]]:this.onceEvents[t]:[]}function eventNames(){var t=this;if(this.emit===emit){var e=Object.keys(this.events);return __spreadArray(__spreadArray([],e,!0),Array.from(this._symbolKeys),!0).filter(function(n){return n in t.events&&t.events[n]&&t.events[n].length})}else{var e=Object.keys(this.events).filter(function(i){return t.events[i]&&t.events[i].length}),s=Object.keys(this.onceEvents).filter(function(i){return t.onceEvents[i]&&t.onceEvents[i].length});return __spreadArray(__spreadArray(__spreadArray([],e,!0),s,!0),Array.from(this._symbolKeys).filter(function(i){return i in t.events&&t.events[i]&&t.events[i].length||i in t.onceEvents&&t.onceEvents[i]&&t.onceEvents[i].length}),!0)}}function listenerCount(t){return this.emit===emit?this.events[t]&&this.events[t].length||0:(this.events[t]&&this.events[t].length||0)+(this.onceEvents[t]&&this.onceEvents[t].length||0)}EventEmitter.prototype.emit=emit;EventEmitter.prototype.on=addListener;EventEmitter.prototype.once=once;EventEmitter.prototype.addListener=addListener;EventEmitter.prototype.removeListener=removeListener;EventEmitter.prototype.addListenerBound=addListenerBound;EventEmitter.prototype.removeListenerBound=removeListenerBound;EventEmitter.prototype.hasListeners=hasListeners;EventEmitter.prototype.prependListener=prependListener;EventEmitter.prototype.prependOnceListener=prependOnceListener;EventEmitter.prototype.off=removeListener;EventEmitter.prototype.removeAllListeners=removeAllListeners;EventEmitter.prototype.setMaxListeners=setMaxListeners;EventEmitter.prototype.getMaxListeners=getMaxListeners;EventEmitter.prototype.listeners=listeners;EventEmitter.prototype.eventNames=eventNames;EventEmitter.prototype.listenerCount=listenerCount;(function(t){var e=commonjsGlobal&&commonjsGlobal.__createBinding||(Object.create?function(n,i,r,o){o===void 0&&(o=r);var a=Object.getOwnPropertyDescriptor(i,r);(!a||("get"in a?!i.__esModule:a.writable||a.configurable))&&(a={enumerable:!0,get:function(){return i[r]}}),Object.defineProperty(n,o,a)}:function(n,i,r,o){o===void 0&&(o=r),n[o]=i[r]}),s=commonjsGlobal&&commonjsGlobal.__exportStar||function(n,i){for(var r in n)r!=="default"&&!Object.prototype.hasOwnProperty.call(i,r)&&e(i,n,r)};Object.defineProperty(t,"__esModule",{value:!0}),s(types,t),s(ee,t)})(lib$1);var browser={exports:{}},ms,hasRequiredMs;function requireMs(){if(hasRequiredMs)return ms;hasRequiredMs=1;var t=1e3,e=t*60,s=e*60,n=s*24,i=n*7,r=n*365.25;ms=function(u,h){h=h||{};var f=typeof u;if(f==="string"&&u.length>0)return o(u);if(f==="number"&&isFinite(u))return h.long?c(u):a(u);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(u))};function o(u){if(u=String(u),!(u.length>100)){var h=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(u);if(h){var f=parseFloat(h[1]),p=(h[2]||"ms").toLowerCase();switch(p){case"years":case"year":case"yrs":case"yr":case"y":return f*r;case"weeks":case"week":case"w":return f*i;case"days":case"day":case"d":return f*n;case"hours":case"hour":case"hrs":case"hr":case"h":return f*s;case"minutes":case"minute":case"mins":case"min":case"m":return f*e;case"seconds":case"second":case"secs":case"sec":case"s":return f*t;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return f;default:return}}}}function a(u){var h=Math.abs(u);return h>=n?Math.round(u/n)+"d":h>=s?Math.round(u/s)+"h":h>=e?Math.round(u/e)+"m":h>=t?Math.round(u/t)+"s":u+"ms"}function c(u){var h=Math.abs(u);return h>=n?l(u,h,n,"day"):h>=s?l(u,h,s,"hour"):h>=e?l(u,h,e,"minute"):h>=t?l(u,h,t,"second"):u+" ms"}function l(u,h,f,p){var v=h>=f*1.5;return Math.round(u/f)+" "+p+(v?"s":"")}return ms}function setup(t){s.debug=s,s.default=s,s.coerce=c,s.disable=o,s.enable=i,s.enabled=a,s.humanize=requireMs(),s.destroy=l,Object.keys(t).forEach(u=>{s[u]=t[u]}),s.names=[],s.skips=[],s.formatters={};function e(u){let h=0;for(let f=0;f<u.length;f++)h=(h<<5)-h+u.charCodeAt(f),h|=0;return s.colors[Math.abs(h)%s.colors.length]}s.selectColor=e;function s(u){let h,f=null,p,v;function k(...R){if(!k.enabled)return;const D=k,U=Number(new Date),C=U-(h||U);D.diff=C,D.prev=h,D.curr=U,h=U,R[0]=s.coerce(R[0]),typeof R[0]!="string"&&R.unshift("%O");let P=0;R[0]=R[0].replace(/%([a-zA-Z%])/g,(V,H)=>{if(V==="%%")return"%";P++;const z=s.formatters[H];if(typeof z=="function"){const F=R[P];V=z.call(D,F),R.splice(P,1),P--}return V}),s.formatArgs.call(D,R),(D.log||s.log).apply(D,R)}return k.namespace=u,k.useColors=s.useColors(),k.color=s.selectColor(u),k.extend=n,k.destroy=s.destroy,Object.defineProperty(k,"enabled",{enumerable:!0,configurable:!1,get:()=>f!==null?f:(p!==s.namespaces&&(p=s.namespaces,v=s.enabled(u)),v),set:R=>{f=R}}),typeof s.init=="function"&&s.init(k),k}function n(u,h){const f=s(this.namespace+(typeof h>"u"?":":h)+u);return f.log=this.log,f}function i(u){s.save(u),s.namespaces=u,s.names=[],s.skips=[];const h=(typeof u=="string"?u:"").trim().replace(/\s+/g,",").split(",").filter(Boolean);for(const f of h)f[0]==="-"?s.skips.push(f.slice(1)):s.names.push(f)}function r(u,h){let f=0,p=0,v=-1,k=0;for(;f<u.length;)if(p<h.length&&(h[p]===u[f]||h[p]==="*"))h[p]==="*"?(v=p,k=f,p++):(f++,p++);else if(v!==-1)p=v+1,k++,f=k;else return!1;for(;p<h.length&&h[p]==="*";)p++;return p===h.length}function o(){const u=[...s.names,...s.skips.map(h=>"-"+h)].join(",");return s.enable(""),u}function a(u){for(const h of s.skips)if(r(u,h))return!1;for(const h of s.names)if(r(u,h))return!0;return!1}function c(u){return u instanceof Error?u.stack||u.message:u}function l(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return s.enable(s.load()),s}var common=setup;(function(t,e){var s={};e.formatArgs=i,e.save=r,e.load=o,e.useColors=n,e.storage=a(),e.destroy=(()=>{let l=!1;return()=>{l||(l=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),e.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function n(){if(typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs))return!0;if(typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;let l;return typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&(l=navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/))&&parseInt(l[1],10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function i(l){if(l[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+l[0]+(this.useColors?"%c ":" ")+"+"+t.exports.humanize(this.diff),!this.useColors)return;const u="color: "+this.color;l.splice(1,0,u,"color: inherit");let h=0,f=0;l[0].replace(/%[a-zA-Z%]/g,p=>{p!=="%%"&&(h++,p==="%c"&&(f=h))}),l.splice(f,0,u)}e.log=console.debug||console.log||(()=>{});function r(l){try{l?e.storage.setItem("debug",l):e.storage.removeItem("debug")}catch{}}function o(){let l;try{l=e.storage.getItem("debug")||e.storage.getItem("DEBUG")}catch{}return!l&&typeof process<"u"&&"env"in process&&(l=s.DEBUG),l}function a(){try{return localStorage}catch{}}t.exports=common(e);const{formatters:c}=t.exports;c.j=function(l){try{return JSON.stringify(l)}catch(u){return"[UnexpectedJSONParseError]: "+u.message}}})(browser,browser.exports);var browserExports=browser.exports;const createDebug2=getDefaultExportFromCjs(browserExports),crypto=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */function isBytes(t){return t instanceof Uint8Array||ArrayBuffer.isView(t)&&t.constructor.name==="Uint8Array"}function anumber(t){if(!Number.isSafeInteger(t)||t<0)throw new Error("positive integer expected, got "+t)}function abytes(t,...e){if(!isBytes(t))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(t.length))throw new Error("Uint8Array expected of length "+e+", got length="+t.length)}function ahash(t){if(typeof t!="function"||typeof t.create!="function")throw new Error("Hash should be wrapped by utils.createHasher");anumber(t.outputLen),anumber(t.blockLen)}function aexists(t,e=!0){if(t.destroyed)throw new Error("Hash instance has been destroyed");if(e&&t.finished)throw new Error("Hash#digest() has already been called")}function aoutput(t,e){abytes(t);const s=e.outputLen;if(t.length<s)throw new Error("digestInto() expects output buffer of length at least "+s)}function clean(...t){for(let e=0;e<t.length;e++)t[e].fill(0)}function createView(t){return new DataView(t.buffer,t.byteOffset,t.byteLength)}function rotr(t,e){return t<<32-e|t>>>e}const hasHexBuiltin=typeof Uint8Array.from([]).toHex=="function"&&typeof Uint8Array.fromHex=="function",hexes=Array.from({length:256},(t,e)=>e.toString(16).padStart(2,"0"));function bytesToHex(t){if(abytes(t),hasHexBuiltin)return t.toHex();let e="";for(let s=0;s<t.length;s++)e+=hexes[t[s]];return e}const asciis={_0:48,_9:57,A:65,F:70,a:97,f:102};function asciiToBase16(t){if(t>=asciis._0&&t<=asciis._9)return t-asciis._0;if(t>=asciis.A&&t<=asciis.F)return t-(asciis.A-10);if(t>=asciis.a&&t<=asciis.f)return t-(asciis.a-10)}function hexToBytes(t){if(typeof t!="string")throw new Error("hex string expected, got "+typeof t);if(hasHexBuiltin)return Uint8Array.fromHex(t);const e=t.length,s=e/2;if(e%2)throw new Error("hex string expected, got unpadded hex of length "+e);const n=new Uint8Array(s);for(let i=0,r=0;i<s;i++,r+=2){const o=asciiToBase16(t.charCodeAt(r)),a=asciiToBase16(t.charCodeAt(r+1));if(o===void 0||a===void 0){const c=t[r]+t[r+1];throw new Error('hex string expected, got non-hex character "'+c+'" at index '+r)}n[i]=o*16+a}return n}function utf8ToBytes(t){if(typeof t!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(t))}function toBytes(t){return typeof t=="string"&&(t=utf8ToBytes(t)),abytes(t),t}function concatBytes(...t){let e=0;for(let n=0;n<t.length;n++){const i=t[n];abytes(i),e+=i.length}const s=new Uint8Array(e);for(let n=0,i=0;n<t.length;n++){const r=t[n];s.set(r,i),i+=r.length}return s}class Hash{}function createHasher(t){const e=n=>t().update(toBytes(n)).digest(),s=t();return e.outputLen=s.outputLen,e.blockLen=s.blockLen,e.create=()=>t(),e}function randomBytes(t=32){if(crypto&&typeof crypto.getRandomValues=="function")return crypto.getRandomValues(new Uint8Array(t));if(crypto&&typeof crypto.randomBytes=="function")return Uint8Array.from(crypto.randomBytes(t));throw new Error("crypto.getRandomValues must be defined")}function setBigUint64(t,e,s,n){if(typeof t.setBigUint64=="function")return t.setBigUint64(e,s,n);const i=BigInt(32),r=BigInt(4294967295),o=Number(s>>i&r),a=Number(s&r),c=n?4:0,l=n?0:4;t.setUint32(e+c,o,n),t.setUint32(e+l,a,n)}function Chi(t,e,s){return t&e^~t&s}function Maj(t,e,s){return t&e^t&s^e&s}class HashMD extends Hash{constructor(e,s,n,i){super(),this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.blockLen=e,this.outputLen=s,this.padOffset=n,this.isLE=i,this.buffer=new Uint8Array(e),this.view=createView(this.buffer)}update(e){aexists(this),e=toBytes(e),abytes(e);const{view:s,buffer:n,blockLen:i}=this,r=e.length;for(let o=0;o<r;){const a=Math.min(i-this.pos,r-o);if(a===i){const c=createView(e);for(;i<=r-o;o+=i)this.process(c,o);continue}n.set(e.subarray(o,o+a),this.pos),this.pos+=a,o+=a,this.pos===i&&(this.process(s,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){aexists(this),aoutput(e,this),this.finished=!0;const{buffer:s,view:n,blockLen:i,isLE:r}=this;let{pos:o}=this;s[o++]=128,clean(this.buffer.subarray(o)),this.padOffset>i-o&&(this.process(n,0),o=0);for(let h=o;h<i;h++)s[h]=0;setBigUint64(n,i-8,BigInt(this.length*8),r),this.process(n,0);const a=createView(e),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const l=c/4,u=this.get();if(l>u.length)throw new Error("_sha2: outputLen bigger than state");for(let h=0;h<l;h++)a.setUint32(4*h,u[h],r)}digest(){const{buffer:e,outputLen:s}=this;this.digestInto(e);const n=e.slice(0,s);return this.destroy(),n}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());const{blockLen:s,buffer:n,length:i,finished:r,destroyed:o,pos:a}=this;return e.destroyed=o,e.finished=r,e.length=i,e.pos=a,i%s&&e.buffer.set(n),e}clone(){return this._cloneInto()}}const SHA256_IV=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),SHA256_K=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),SHA256_W=new Uint32Array(64);class SHA256 extends HashMD{constructor(e=32){super(64,e,8,!1),this.A=SHA256_IV[0]|0,this.B=SHA256_IV[1]|0,this.C=SHA256_IV[2]|0,this.D=SHA256_IV[3]|0,this.E=SHA256_IV[4]|0,this.F=SHA256_IV[5]|0,this.G=SHA256_IV[6]|0,this.H=SHA256_IV[7]|0}get(){const{A:e,B:s,C:n,D:i,E:r,F:o,G:a,H:c}=this;return[e,s,n,i,r,o,a,c]}set(e,s,n,i,r,o,a,c){this.A=e|0,this.B=s|0,this.C=n|0,this.D=i|0,this.E=r|0,this.F=o|0,this.G=a|0,this.H=c|0}process(e,s){for(let h=0;h<16;h++,s+=4)SHA256_W[h]=e.getUint32(s,!1);for(let h=16;h<64;h++){const f=SHA256_W[h-15],p=SHA256_W[h-2],v=rotr(f,7)^rotr(f,18)^f>>>3,k=rotr(p,17)^rotr(p,19)^p>>>10;SHA256_W[h]=k+SHA256_W[h-7]+v+SHA256_W[h-16]|0}let{A:n,B:i,C:r,D:o,E:a,F:c,G:l,H:u}=this;for(let h=0;h<64;h++){const f=rotr(a,6)^rotr(a,11)^rotr(a,25),p=u+f+Chi(a,c,l)+SHA256_K[h]+SHA256_W[h]|0,k=(rotr(n,2)^rotr(n,13)^rotr(n,22))+Maj(n,i,r)|0;u=l,l=c,c=a,a=o+p|0,o=r,r=i,i=n,n=p+k|0}n=n+this.A|0,i=i+this.B|0,r=r+this.C|0,o=o+this.D|0,a=a+this.E|0,c=c+this.F|0,l=l+this.G|0,u=u+this.H|0,this.set(n,i,r,o,a,c,l,u)}roundClean(){clean(SHA256_W)}destroy(){this.set(0,0,0,0,0,0,0,0),clean(this.buffer)}}const sha256$1=createHasher(()=>new SHA256);class HMAC extends Hash{constructor(e,s){super(),this.finished=!1,this.destroyed=!1,ahash(e);const n=toBytes(s);if(this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const i=this.blockLen,r=new Uint8Array(i);r.set(n.length>i?e.create().update(n).digest():n);for(let o=0;o<r.length;o++)r[o]^=54;this.iHash.update(r),this.oHash=e.create();for(let o=0;o<r.length;o++)r[o]^=106;this.oHash.update(r),clean(r)}update(e){return aexists(this),this.iHash.update(e),this}digestInto(e){aexists(this),abytes(e,this.outputLen),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){const e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||(e=Object.create(Object.getPrototypeOf(this),{}));const{oHash:s,iHash:n,finished:i,destroyed:r,blockLen:o,outputLen:a}=this;return e=e,e.finished=i,e.destroyed=r,e.blockLen=o,e.outputLen=a,e.oHash=s._cloneInto(e.oHash),e.iHash=n._cloneInto(e.iHash),e}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}}const hmac=(t,e,s)=>new HMAC(t,e).update(s).digest();hmac.create=(t,e)=>new HMAC(t,e);/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const _0n$4=BigInt(0),_1n$4=BigInt(1);function _abool2(t,e=""){if(typeof t!="boolean"){const s=e&&`"${e}"`;throw new Error(s+"expected boolean, got type="+typeof t)}return t}function _abytes2(t,e,s=""){const n=isBytes(t),i=t?.length,r=e!==void 0;if(!n||r&&i!==e){const o=s&&`"${s}" `,a=r?` of length ${e}`:"",c=n?`length=${i}`:`type=${typeof t}`;throw new Error(o+"expected Uint8Array"+a+", got "+c)}return t}function numberToHexUnpadded(t){const e=t.toString(16);return e.length&1?"0"+e:e}function hexToNumber(t){if(typeof t!="string")throw new Error("hex string expected, got "+typeof t);return t===""?_0n$4:BigInt("0x"+t)}function bytesToNumberBE(t){return hexToNumber(bytesToHex(t))}function bytesToNumberLE(t){return abytes(t),hexToNumber(bytesToHex(Uint8Array.from(t).reverse()))}function numberToBytesBE(t,e){return hexToBytes(t.toString(16).padStart(e*2,"0"))}function numberToBytesLE(t,e){return numberToBytesBE(t,e).reverse()}function ensureBytes(t,e,s){let n;if(typeof e=="string")try{n=hexToBytes(e)}catch(r){throw new Error(t+" must be hex string or Uint8Array, cause: "+r)}else if(isBytes(e))n=Uint8Array.from(e);else throw new Error(t+" must be hex string or Uint8Array");const i=n.length;if(typeof s=="number"&&i!==s)throw new Error(t+" of length "+s+" expected, got "+i);return n}const isPosBig=t=>typeof t=="bigint"&&_0n$4<=t;function inRange(t,e,s){return isPosBig(t)&&isPosBig(e)&&isPosBig(s)&&e<=t&&t<s}function aInRange(t,e,s,n){if(!inRange(e,s,n))throw new Error("expected valid "+t+": "+s+" <= n < "+n+", got "+e)}function bitLen(t){let e;for(e=0;t>_0n$4;t>>=_1n$4,e+=1);return e}const bitMask=t=>(_1n$4<<BigInt(t))-_1n$4;function createHmacDrbg(t,e,s){if(typeof t!="number"||t<2)throw new Error("hashLen must be a number");if(typeof e!="number"||e<2)throw new Error("qByteLen must be a number");if(typeof s!="function")throw new Error("hmacFn must be a function");const n=p=>new Uint8Array(p),i=p=>Uint8Array.of(p);let r=n(t),o=n(t),a=0;const c=()=>{r.fill(1),o.fill(0),a=0},l=(...p)=>s(o,r,...p),u=(p=n(0))=>{o=l(i(0),p),r=l(),p.length!==0&&(o=l(i(1),p),r=l())},h=()=>{if(a++>=1e3)throw new Error("drbg: tried 1000 values");let p=0;const v=[];for(;p<e;){r=l();const k=r.slice();v.push(k),p+=r.length}return concatBytes(...v)};return(p,v)=>{c(),u(p);let k;for(;!(k=v(h()));)u();return c(),k}}function _validateObject(t,e,s={}){if(!t||typeof t!="object")throw new Error("expected valid options object");function n(i,r,o){const a=t[i];if(o&&a===void 0)return;const c=typeof a;if(c!==r||a===null)throw new Error(`param "${i}" is invalid: expected ${r}, got ${c}`)}Object.entries(e).forEach(([i,r])=>n(i,r,!1)),Object.entries(s).forEach(([i,r])=>n(i,r,!0))}function memoized(t){const e=new WeakMap;return(s,...n)=>{const i=e.get(s);if(i!==void 0)return i;const r=t(s,...n);return e.set(s,r),r}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const _0n$3=BigInt(0),_1n$3=BigInt(1),_2n$2=BigInt(2),_3n$1=BigInt(3),_4n$1=BigInt(4),_5n=BigInt(5),_7n=BigInt(7),_8n=BigInt(8),_9n=BigInt(9),_16n=BigInt(16);function mod(t,e){const s=t%e;return s>=_0n$3?s:e+s}function pow2(t,e,s){let n=t;for(;e-- >_0n$3;)n*=n,n%=s;return n}function invert(t,e){if(t===_0n$3)throw new Error("invert: expected non-zero number");if(e<=_0n$3)throw new Error("invert: expected positive modulus, got "+e);let s=mod(t,e),n=e,i=_0n$3,r=_1n$3;for(;s!==_0n$3;){const a=n/s,c=n%s,l=i-r*a;n=s,s=c,i=r,r=l}if(n!==_1n$3)throw new Error("invert: does not exist");return mod(i,e)}function assertIsSquare(t,e,s){if(!t.eql(t.sqr(e),s))throw new Error("Cannot find square root")}function sqrt3mod4(t,e){const s=(t.ORDER+_1n$3)/_4n$1,n=t.pow(e,s);return assertIsSquare(t,n,e),n}function sqrt5mod8(t,e){const s=(t.ORDER-_5n)/_8n,n=t.mul(e,_2n$2),i=t.pow(n,s),r=t.mul(e,i),o=t.mul(t.mul(r,_2n$2),i),a=t.mul(r,t.sub(o,t.ONE));return assertIsSquare(t,a,e),a}function sqrt9mod16(t){const e=Field(t),s=tonelliShanks(t),n=s(e,e.neg(e.ONE)),i=s(e,n),r=s(e,e.neg(n)),o=(t+_7n)/_16n;return(a,c)=>{let l=a.pow(c,o),u=a.mul(l,n);const h=a.mul(l,i),f=a.mul(l,r),p=a.eql(a.sqr(u),c),v=a.eql(a.sqr(h),c);l=a.cmov(l,u,p),u=a.cmov(f,h,v);const k=a.eql(a.sqr(u),c),R=a.cmov(l,u,k);return assertIsSquare(a,R,c),R}}function tonelliShanks(t){if(t<_3n$1)throw new Error("sqrt is not defined for small field");let e=t-_1n$3,s=0;for(;e%_2n$2===_0n$3;)e/=_2n$2,s++;let n=_2n$2;const i=Field(t);for(;FpLegendre(i,n)===1;)if(n++>1e3)throw new Error("Cannot find square root: probably non-prime P");if(s===1)return sqrt3mod4;let r=i.pow(n,e);const o=(e+_1n$3)/_2n$2;return function(c,l){if(c.is0(l))return l;if(FpLegendre(c,l)!==1)throw new Error("Cannot find square root");let u=s,h=c.mul(c.ONE,r),f=c.pow(l,e),p=c.pow(l,o);for(;!c.eql(f,c.ONE);){if(c.is0(f))return c.ZERO;let v=1,k=c.sqr(f);for(;!c.eql(k,c.ONE);)if(v++,k=c.sqr(k),v===u)throw new Error("Cannot find square root");const R=_1n$3<<BigInt(u-v-1),D=c.pow(h,R);u=v,h=c.sqr(D),f=c.mul(f,h),p=c.mul(p,D)}return p}}function FpSqrt(t){return t%_4n$1===_3n$1?sqrt3mod4:t%_8n===_5n?sqrt5mod8:t%_16n===_9n?sqrt9mod16(t):tonelliShanks(t)}const FIELD_FIELDS=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function validateField(t){const e={ORDER:"bigint",MASK:"bigint",BYTES:"number",BITS:"number"},s=FIELD_FIELDS.reduce((n,i)=>(n[i]="function",n),e);return _validateObject(t,s),t}function FpPow(t,e,s){if(s<_0n$3)throw new Error("invalid exponent, negatives unsupported");if(s===_0n$3)return t.ONE;if(s===_1n$3)return e;let n=t.ONE,i=e;for(;s>_0n$3;)s&_1n$3&&(n=t.mul(n,i)),i=t.sqr(i),s>>=_1n$3;return n}function FpInvertBatch(t,e,s=!1){const n=new Array(e.length).fill(s?t.ZERO:void 0),i=e.reduce((o,a,c)=>t.is0(a)?o:(n[c]=o,t.mul(o,a)),t.ONE),r=t.inv(i);return e.reduceRight((o,a,c)=>t.is0(a)?o:(n[c]=t.mul(o,n[c]),t.mul(o,a)),r),n}function FpLegendre(t,e){const s=(t.ORDER-_1n$3)/_2n$2,n=t.pow(e,s),i=t.eql(n,t.ONE),r=t.eql(n,t.ZERO),o=t.eql(n,t.neg(t.ONE));if(!i&&!r&&!o)throw new Error("invalid Legendre symbol result");return i?1:r?0:-1}function nLength(t,e){e!==void 0&&anumber(e);const s=e!==void 0?e:t.toString(2).length,n=Math.ceil(s/8);return{nBitLength:s,nByteLength:n}}function Field(t,e,s=!1,n={}){if(t<=_0n$3)throw new Error("invalid field: expected ORDER > 0, got "+t);let i,r,o=!1,a;if(typeof e=="object"&&e!=null){if(n.sqrt||s)throw new Error("cannot specify opts in two arguments");const f=e;f.BITS&&(i=f.BITS),f.sqrt&&(r=f.sqrt),typeof f.isLE=="boolean"&&(s=f.isLE),typeof f.modFromBytes=="boolean"&&(o=f.modFromBytes),a=f.allowedLengths}else typeof e=="number"&&(i=e),n.sqrt&&(r=n.sqrt);const{nBitLength:c,nByteLength:l}=nLength(t,i);if(l>2048)throw new Error("invalid field: expected ORDER of <= 2048 bytes");let u;const h=Object.freeze({ORDER:t,isLE:s,BITS:c,BYTES:l,MASK:bitMask(c),ZERO:_0n$3,ONE:_1n$3,allowedLengths:a,create:f=>mod(f,t),isValid:f=>{if(typeof f!="bigint")throw new Error("invalid field element: expected bigint, got "+typeof f);return _0n$3<=f&&f<t},is0:f=>f===_0n$3,isValidNot0:f=>!h.is0(f)&&h.isValid(f),isOdd:f=>(f&_1n$3)===_1n$3,neg:f=>mod(-f,t),eql:(f,p)=>f===p,sqr:f=>mod(f*f,t),add:(f,p)=>mod(f+p,t),sub:(f,p)=>mod(f-p,t),mul:(f,p)=>mod(f*p,t),pow:(f,p)=>FpPow(h,f,p),div:(f,p)=>mod(f*invert(p,t),t),sqrN:f=>f*f,addN:(f,p)=>f+p,subN:(f,p)=>f-p,mulN:(f,p)=>f*p,inv:f=>invert(f,t),sqrt:r||(f=>(u||(u=FpSqrt(t)),u(h,f))),toBytes:f=>s?numberToBytesLE(f,l):numberToBytesBE(f,l),fromBytes:(f,p=!0)=>{if(a){if(!a.includes(f.length)||f.length>l)throw new Error("Field.fromBytes: expected "+a+" bytes, got "+f.length);const k=new Uint8Array(l);k.set(f,s?0:k.length-f.length),f=k}if(f.length!==l)throw new Error("Field.fromBytes: expected "+l+" bytes, got "+f.length);let v=s?bytesToNumberLE(f):bytesToNumberBE(f);if(o&&(v=mod(v,t)),!p&&!h.isValid(v))throw new Error("invalid field element: outside of range 0..ORDER");return v},invertBatch:f=>FpInvertBatch(h,f),cmov:(f,p,v)=>v?p:f});return Object.freeze(h)}function getFieldBytesLength(t){if(typeof t!="bigint")throw new Error("field order must be bigint");const e=t.toString(2).length;return Math.ceil(e/8)}function getMinHashLength(t){const e=getFieldBytesLength(t);return e+Math.ceil(e/2)}function mapHashToField(t,e,s=!1){const n=t.length,i=getFieldBytesLength(e),r=getMinHashLength(e);if(n<16||n<r||n>1024)throw new Error("expected "+r+"-1024 bytes of input, got "+n);const o=s?bytesToNumberLE(t):bytesToNumberBE(t),a=mod(o,e-_1n$3)+_1n$3;return s?numberToBytesLE(a,i):numberToBytesBE(a,i)}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const _0n$2=BigInt(0),_1n$2=BigInt(1);function negateCt(t,e){const s=e.negate();return t?s:e}function normalizeZ(t,e){const s=FpInvertBatch(t.Fp,e.map(n=>n.Z));return e.map((n,i)=>t.fromAffine(n.toAffine(s[i])))}function validateW(t,e){if(!Number.isSafeInteger(t)||t<=0||t>e)throw new Error("invalid window size, expected [1.."+e+"], got W="+t)}function calcWOpts(t,e){validateW(t,e);const s=Math.ceil(e/t)+1,n=2**(t-1),i=2**t,r=bitMask(t),o=BigInt(t);return{windows:s,windowSize:n,mask:r,maxNumber:i,shiftBy:o}}function calcOffsets(t,e,s){const{windowSize:n,mask:i,maxNumber:r,shiftBy:o}=s;let a=Number(t&i),c=t>>o;a>n&&(a-=r,c+=_1n$2);const l=e*n,u=l+Math.abs(a)-1,h=a===0,f=a<0,p=e%2!==0;return{nextN:c,offset:u,isZero:h,isNeg:f,isNegF:p,offsetF:l}}function validateMSMPoints(t,e){if(!Array.isArray(t))throw new Error("array expected");t.forEach((s,n)=>{if(!(s instanceof e))throw new Error("invalid point at index "+n)})}function validateMSMScalars(t,e){if(!Array.isArray(t))throw new Error("array of scalars expected");t.forEach((s,n)=>{if(!e.isValid(s))throw new Error("invalid scalar at index "+n)})}const pointPrecomputes=new WeakMap,pointWindowSizes=new WeakMap;function getW(t){return pointWindowSizes.get(t)||1}function assert0(t){if(t!==_0n$2)throw new Error("invalid wNAF")}class wNAF{constructor(e,s){this.BASE=e.BASE,this.ZERO=e.ZERO,this.Fn=e.Fn,this.bits=s}_unsafeLadder(e,s,n=this.ZERO){let i=e;for(;s>_0n$2;)s&_1n$2&&(n=n.add(i)),i=i.double(),s>>=_1n$2;return n}precomputeWindow(e,s){const{windows:n,windowSize:i}=calcWOpts(s,this.bits),r=[];let o=e,a=o;for(let c=0;c<n;c++){a=o,r.push(a);for(let l=1;l<i;l++)a=a.add(o),r.push(a);o=a.double()}return r}wNAF(e,s,n){if(!this.Fn.isValid(n))throw new Error("invalid scalar");let i=this.ZERO,r=this.BASE;const o=calcWOpts(e,this.bits);for(let a=0;a<o.windows;a++){const{nextN:c,offset:l,isZero:u,isNeg:h,isNegF:f,offsetF:p}=calcOffsets(n,a,o);n=c,u?r=r.add(negateCt(f,s[p])):i=i.add(negateCt(h,s[l]))}return assert0(n),{p:i,f:r}}wNAFUnsafe(e,s,n,i=this.ZERO){const r=calcWOpts(e,this.bits);for(let o=0;o<r.windows&&n!==_0n$2;o++){const{nextN:a,offset:c,isZero:l,isNeg:u}=calcOffsets(n,o,r);if(n=a,!l){const h=s[c];i=i.add(u?h.negate():h)}}return assert0(n),i}getPrecomputes(e,s,n){let i=pointPrecomputes.get(s);return i||(i=this.precomputeWindow(s,e),e!==1&&(typeof n=="function"&&(i=n(i)),pointPrecomputes.set(s,i))),i}cached(e,s,n){const i=getW(e);return this.wNAF(i,this.getPrecomputes(i,e,n),s)}unsafe(e,s,n,i){const r=getW(e);return r===1?this._unsafeLadder(e,s,i):this.wNAFUnsafe(r,this.getPrecomputes(r,e,n),s,i)}createCache(e,s){validateW(s,this.bits),pointWindowSizes.set(e,s),pointPrecomputes.delete(e)}hasCache(e){return getW(e)!==1}}function mulEndoUnsafe(t,e,s,n){let i=e,r=t.ZERO,o=t.ZERO;for(;s>_0n$2||n>_0n$2;)s&_1n$2&&(r=r.add(i)),n&_1n$2&&(o=o.add(i)),i=i.double(),s>>=_1n$2,n>>=_1n$2;return{p1:r,p2:o}}function pippenger(t,e,s,n){validateMSMPoints(s,t),validateMSMScalars(n,e);const i=s.length,r=n.length;if(i!==r)throw new Error("arrays of points and scalars must have equal length");const o=t.ZERO,a=bitLen(BigInt(i));let c=1;a>12?c=a-3:a>4?c=a-2:a>0&&(c=2);const l=bitMask(c),u=new Array(Number(l)+1).fill(o),h=Math.floor((e.BITS-1)/c)*c;let f=o;for(let p=h;p>=0;p-=c){u.fill(o);for(let k=0;k<r;k++){const R=n[k],D=Number(R>>BigInt(p)&l);u[D]=u[D].add(s[k])}let v=o;for(let k=u.length-1,R=o;k>0;k--)R=R.add(u[k]),v=v.add(R);if(f=f.add(v),p!==0)for(let k=0;k<c;k++)f=f.double()}return f}function createField(t,e,s){if(e){if(e.ORDER!==t)throw new Error("Field.ORDER must match order: Fp == p, Fn == n");return validateField(e),e}else return Field(t,{isLE:s})}function _createCurveFields(t,e,s={},n){if(n===void 0&&(n=t==="edwards"),!e||typeof e!="object")throw new Error(`expected valid ${t} CURVE object`);for(const c of["p","n","h"]){const l=e[c];if(!(typeof l=="bigint"&&l>_0n$2))throw new Error(`CURVE.${c} must be positive bigint`)}const i=createField(e.p,s.Fp,n),r=createField(e.n,s.Fn,n),a=["Gx","Gy","a","b"];for(const c of a)if(!i.isValid(e[c]))throw new Error(`CURVE.${c} must be valid field element of CURVE.Fp`);return e=Object.freeze(Object.assign({},e)),{CURVE:e,Fp:i,Fn:r}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const divNearest=(t,e)=>(t+(t>=0?e:-e)/_2n$1)/e;function _splitEndoScalar(t,e,s){const[[n,i],[r,o]]=e,a=divNearest(o*t,s),c=divNearest(-i*t,s);let l=t-a*n-c*r,u=-a*i-c*o;const h=l<_0n$1,f=u<_0n$1;h&&(l=-l),f&&(u=-u);const p=bitMask(Math.ceil(bitLen(s)/2))+_1n$1;if(l<_0n$1||l>=p||u<_0n$1||u>=p)throw new Error("splitScalar (endomorphism): failed, k="+t);return{k1neg:h,k1:l,k2neg:f,k2:u}}function validateSigFormat(t){if(!["compact","recovered","der"].includes(t))throw new Error('Signature format must be "compact", "recovered", or "der"');return t}function validateSigOpts(t,e){const s={};for(let n of Object.keys(e))s[n]=t[n]===void 0?e[n]:t[n];return _abool2(s.lowS,"lowS"),_abool2(s.prehash,"prehash"),s.format!==void 0&&validateSigFormat(s.format),s}class DERErr extends Error{constructor(e=""){super(e)}}const DER={Err:DERErr,_tlv:{encode:(t,e)=>{const{Err:s}=DER;if(t<0||t>256)throw new s("tlv.encode: wrong tag");if(e.length&1)throw new s("tlv.encode: unpadded data");const n=e.length/2,i=numberToHexUnpadded(n);if(i.length/2&128)throw new s("tlv.encode: long form length too big");const r=n>127?numberToHexUnpadded(i.length/2|128):"";return numberToHexUnpadded(t)+r+i+e},decode(t,e){const{Err:s}=DER;let n=0;if(t<0||t>256)throw new s("tlv.encode: wrong tag");if(e.length<2||e[n++]!==t)throw new s("tlv.decode: wrong tlv");const i=e[n++],r=!!(i&128);let o=0;if(!r)o=i;else{const c=i&127;if(!c)throw new s("tlv.decode(long): indefinite length not supported");if(c>4)throw new s("tlv.decode(long): byte length is too big");const l=e.subarray(n,n+c);if(l.length!==c)throw new s("tlv.decode: length bytes not complete");if(l[0]===0)throw new s("tlv.decode(long): zero leftmost byte");for(const u of l)o=o<<8|u;if(n+=c,o<128)throw new s("tlv.decode(long): not minimal encoding")}const a=e.subarray(n,n+o);if(a.length!==o)throw new s("tlv.decode: wrong value length");return{v:a,l:e.subarray(n+o)}}},_int:{encode(t){const{Err:e}=DER;if(t<_0n$1)throw new e("integer: negative integers are not allowed");let s=numberToHexUnpadded(t);if(Number.parseInt(s[0],16)&8&&(s="00"+s),s.length&1)throw new e("unexpected DER parsing assertion: unpadded hex");return s},decode(t){const{Err:e}=DER;if(t[0]&128)throw new e("invalid signature integer: negative");if(t[0]===0&&!(t[1]&128))throw new e("invalid signature integer: unnecessary leading zero");return bytesToNumberBE(t)}},toSig(t){const{Err:e,_int:s,_tlv:n}=DER,i=ensureBytes("signature",t),{v:r,l:o}=n.decode(48,i);if(o.length)throw new e("invalid signature: left bytes after parsing");const{v:a,l:c}=n.decode(2,r),{v:l,l:u}=n.decode(2,c);if(u.length)throw new e("invalid signature: left bytes after parsing");return{r:s.decode(a),s:s.decode(l)}},hexFromSig(t){const{_tlv:e,_int:s}=DER,n=e.encode(2,s.encode(t.r)),i=e.encode(2,s.encode(t.s)),r=n+i;return e.encode(48,r)}},_0n$1=BigInt(0),_1n$1=BigInt(1),_2n$1=BigInt(2),_3n=BigInt(3),_4n=BigInt(4);function _normFnElement(t,e){const{BYTES:s}=t;let n;if(typeof e=="bigint")n=e;else{let i=ensureBytes("private key",e);try{n=t.fromBytes(i)}catch{throw new Error(`invalid private key: expected ui8a of size ${s}, got ${typeof e}`)}}if(!t.isValidNot0(n))throw new Error("invalid private key: out of range [1..N-1]");return n}function weierstrassN(t,e={}){const s=_createCurveFields("weierstrass",t,e),{Fp:n,Fn:i}=s;let r=s.CURVE;const{h:o,n:a}=r;_validateObject(e,{},{allowInfinityPoint:"boolean",clearCofactor:"function",isTorsionFree:"function",fromBytes:"function",toBytes:"function",endo:"object",wrapPrivateKey:"boolean"});const{endo:c}=e;if(c&&(!n.is0(r.a)||typeof c.beta!="bigint"||!Array.isArray(c.basises)))throw new Error('invalid endo: expected "beta": bigint and "basises": array');const l=getWLengths(n,i);function u(){if(!n.isOdd)throw new Error("compression is not supported: Field does not have .isOdd()")}function h(b,g,m){const{x:y,y:w}=g.toAffine(),_=n.toBytes(y);if(_abool2(m,"isCompressed"),m){u();const A=!n.isOdd(w);return concatBytes(pprefix(A),_)}else return concatBytes(Uint8Array.of(4),_,n.toBytes(w))}function f(b){_abytes2(b,void 0,"Point");const{publicKey:g,publicKeyUncompressed:m}=l,y=b.length,w=b[0],_=b.subarray(1);if(y===g&&(w===2||w===3)){const A=n.fromBytes(_);if(!n.isValid(A))throw new Error("bad point: is not on curve, wrong x");const S=k(A);let N;try{N=n.sqrt(S)}catch(K){const I=K instanceof Error?": "+K.message:"";throw new Error("bad point: is not on curve, sqrt error"+I)}u();const T=n.isOdd(N);return(w&1)===1!==T&&(N=n.neg(N)),{x:A,y:N}}else if(y===m&&w===4){const A=n.BYTES,S=n.fromBytes(_.subarray(0,A)),N=n.fromBytes(_.subarray(A,A*2));if(!R(S,N))throw new Error("bad point: is not on curve");return{x:S,y:N}}else throw new Error(`bad point: got length ${y}, expected compressed=${g} or uncompressed=${m}`)}const p=e.toBytes||h,v=e.fromBytes||f;function k(b){const g=n.sqr(b),m=n.mul(g,b);return n.add(n.add(m,n.mul(b,r.a)),r.b)}function R(b,g){const m=n.sqr(g),y=k(b);return n.eql(m,y)}if(!R(r.Gx,r.Gy))throw new Error("bad curve params: generator point");const D=n.mul(n.pow(r.a,_3n),_4n),U=n.mul(n.sqr(r.b),BigInt(27));if(n.is0(n.add(D,U)))throw new Error("bad curve params: a or b");function C(b,g,m=!1){if(!n.isValid(g)||m&&n.is0(g))throw new Error(`bad point coordinate ${b}`);return g}function P(b){if(!(b instanceof F))throw new Error("ProjectivePoint expected")}function M(b){if(!c||!c.basises)throw new Error("no endo");return _splitEndoScalar(b,c.basises,i.ORDER)}const V=memoized((b,g)=>{const{X:m,Y:y,Z:w}=b;if(n.eql(w,n.ONE))return{x:m,y};const _=b.is0();g==null&&(g=_?n.ONE:n.inv(w));const A=n.mul(m,g),S=n.mul(y,g),N=n.mul(w,g);if(_)return{x:n.ZERO,y:n.ZERO};if(!n.eql(N,n.ONE))throw new Error("invZ was invalid");return{x:A,y:S}}),H=memoized(b=>{if(b.is0()){if(e.allowInfinityPoint&&!n.is0(b.Y))return;throw new Error("bad point: ZERO")}const{x:g,y:m}=b.toAffine();if(!n.isValid(g)||!n.isValid(m))throw new Error("bad point: x or y not field elements");if(!R(g,m))throw new Error("bad point: equation left != right");if(!b.isTorsionFree())throw new Error("bad point: not in prime-order subgroup");return!0});function z(b,g,m,y,w){return m=new F(n.mul(m.X,b),m.Y,m.Z),g=negateCt(y,g),m=negateCt(w,m),g.add(m)}class F{constructor(g,m,y){this.X=C("x",g),this.Y=C("y",m,!0),this.Z=C("z",y),Object.freeze(this)}static CURVE(){return r}static fromAffine(g){const{x:m,y}=g||{};if(!g||!n.isValid(m)||!n.isValid(y))throw new Error("invalid affine point");if(g instanceof F)throw new Error("projective point not allowed");return n.is0(m)&&n.is0(y)?F.ZERO:new F(m,y,n.ONE)}static fromBytes(g){const m=F.fromAffine(v(_abytes2(g,void 0,"point")));return m.assertValidity(),m}static fromHex(g){return F.fromBytes(ensureBytes("pointHex",g))}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(g=8,m=!0){return E.createCache(this,g),m||this.multiply(_3n),this}assertValidity(){H(this)}hasEvenY(){const{y:g}=this.toAffine();if(!n.isOdd)throw new Error("Field doesn't support isOdd");return!n.isOdd(g)}equals(g){P(g);const{X:m,Y:y,Z:w}=this,{X:_,Y:A,Z:S}=g,N=n.eql(n.mul(m,S),n.mul(_,w)),T=n.eql(n.mul(y,S),n.mul(A,w));return N&&T}negate(){return new F(this.X,n.neg(this.Y),this.Z)}double(){const{a:g,b:m}=r,y=n.mul(m,_3n),{X:w,Y:_,Z:A}=this;let S=n.ZERO,N=n.ZERO,T=n.ZERO,x=n.mul(w,w),K=n.mul(_,_),I=n.mul(A,A),$=n.mul(w,_);return $=n.add($,$),T=n.mul(w,A),T=n.add(T,T),S=n.mul(g,T),N=n.mul(y,I),N=n.add(S,N),S=n.sub(K,N),N=n.add(K,N),N=n.mul(S,N),S=n.mul($,S),T=n.mul(y,T),I=n.mul(g,I),$=n.sub(x,I),$=n.mul(g,$),$=n.add($,T),T=n.add(x,x),x=n.add(T,x),x=n.add(x,I),x=n.mul(x,$),N=n.add(N,x),I=n.mul(_,A),I=n.add(I,I),x=n.mul(I,$),S=n.sub(S,x),T=n.mul(I,K),T=n.add(T,T),T=n.add(T,T),new F(S,N,T)}add(g){P(g);const{X:m,Y:y,Z:w}=this,{X:_,Y:A,Z:S}=g;let N=n.ZERO,T=n.ZERO,x=n.ZERO;const K=r.a,I=n.mul(r.b,_3n);let $=n.mul(m,_),B=n.mul(y,A),L=n.mul(w,S),j=n.add(m,y),O=n.add(_,A);j=n.mul(j,O),O=n.add($,B),j=n.sub(j,O),O=n.add(m,w);let q=n.add(_,S);return O=n.mul(O,q),q=n.add($,L),O=n.sub(O,q),q=n.add(y,w),N=n.add(A,S),q=n.mul(q,N),N=n.add(B,L),q=n.sub(q,N),x=n.mul(K,O),N=n.mul(I,L),x=n.add(N,x),N=n.sub(B,x),x=n.add(B,x),T=n.mul(N,x),B=n.add($,$),B=n.add(B,$),L=n.mul(K,L),O=n.mul(I,O),B=n.add(B,L),L=n.sub($,L),L=n.mul(K,L),O=n.add(O,L),$=n.mul(B,O),T=n.add(T,$),$=n.mul(q,O),N=n.mul(j,N),N=n.sub(N,$),$=n.mul(j,B),x=n.mul(q,x),x=n.add(x,$),new F(N,T,x)}subtract(g){return this.add(g.negate())}is0(){return this.equals(F.ZERO)}multiply(g){const{endo:m}=e;if(!i.isValidNot0(g))throw new Error("invalid scalar: out of range");let y,w;const _=A=>E.cached(this,A,S=>normalizeZ(F,S));if(m){const{k1neg:A,k1:S,k2neg:N,k2:T}=M(g),{p:x,f:K}=_(S),{p:I,f:$}=_(T);w=K.add($),y=z(m.beta,x,I,A,N)}else{const{p:A,f:S}=_(g);y=A,w=S}return normalizeZ(F,[y,w])[0]}multiplyUnsafe(g){const{endo:m}=e,y=this;if(!i.isValid(g))throw new Error("invalid scalar: out of range");if(g===_0n$1||y.is0())return F.ZERO;if(g===_1n$1)return y;if(E.hasCache(this))return this.multiply(g);if(m){const{k1neg:w,k1:_,k2neg:A,k2:S}=M(g),{p1:N,p2:T}=mulEndoUnsafe(F,y,_,S);return z(m.beta,N,T,w,A)}else return E.unsafe(y,g)}multiplyAndAddUnsafe(g,m,y){const w=this.multiplyUnsafe(m).add(g.multiplyUnsafe(y));return w.is0()?void 0:w}toAffine(g){return V(this,g)}isTorsionFree(){const{isTorsionFree:g}=e;return o===_1n$1?!0:g?g(F,this):E.unsafe(this,a).is0()}clearCofactor(){const{clearCofactor:g}=e;return o===_1n$1?this:g?g(F,this):this.multiplyUnsafe(o)}isSmallOrder(){return this.multiplyUnsafe(o).is0()}toBytes(g=!0){return _abool2(g,"isCompressed"),this.assertValidity(),p(F,this,g)}toHex(g=!0){return bytesToHex(this.toBytes(g))}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}get px(){return this.X}get py(){return this.X}get pz(){return this.Z}toRawBytes(g=!0){return this.toBytes(g)}_setWindowSize(g){this.precompute(g)}static normalizeZ(g){return normalizeZ(F,g)}static msm(g,m){return pippenger(F,i,g,m)}static fromPrivateKey(g){return F.BASE.multiply(_normFnElement(i,g))}}F.BASE=new F(r.Gx,r.Gy,n.ONE),F.ZERO=new F(n.ZERO,n.ONE,n.ZERO),F.Fp=n,F.Fn=i;const G=i.BITS,E=new wNAF(F,e.endo?Math.ceil(G/2):G);return F.BASE.precompute(8),F}function pprefix(t){return Uint8Array.of(t?2:3)}function getWLengths(t,e){return{secretKey:e.BYTES,publicKey:1+t.BYTES,publicKeyUncompressed:1+2*t.BYTES,publicKeyHasPrefix:!0,signature:2*e.BYTES}}function ecdh(t,e={}){const{Fn:s}=t,n=e.randomBytes||randomBytes,i=Object.assign(getWLengths(t.Fp,s),{seed:getMinHashLength(s.ORDER)});function r(p){try{return!!_normFnElement(s,p)}catch{return!1}}function o(p,v){const{publicKey:k,publicKeyUncompressed:R}=i;try{const D=p.length;return v===!0&&D!==k||v===!1&&D!==R?!1:!!t.fromBytes(p)}catch{return!1}}function a(p=n(i.seed)){return mapHashToField(_abytes2(p,i.seed,"seed"),s.ORDER)}function c(p,v=!0){return t.BASE.multiply(_normFnElement(s,p)).toBytes(v)}function l(p){const v=a(p);return{secretKey:v,publicKey:c(v)}}function u(p){if(typeof p=="bigint")return!1;if(p instanceof t)return!0;const{secretKey:v,publicKey:k,publicKeyUncompressed:R}=i;if(s.allowedLengths||v===k)return;const D=ensureBytes("key",p).length;return D===k||D===R}function h(p,v,k=!0){if(u(p)===!0)throw new Error("first arg must be private key");if(u(v)===!1)throw new Error("second arg must be public key");const R=_normFnElement(s,p);return t.fromHex(v).multiply(R).toBytes(k)}return Object.freeze({getPublicKey:c,getSharedSecret:h,keygen:l,Point:t,utils:{isValidSecretKey:r,isValidPublicKey:o,randomSecretKey:a,isValidPrivateKey:r,randomPrivateKey:a,normPrivateKeyToScalar:p=>_normFnElement(s,p),precompute(p=8,v=t.BASE){return v.precompute(p,!1)}},lengths:i})}function ecdsa(t,e,s={}){ahash(e),_validateObject(s,{},{hmac:"function",lowS:"boolean",randomBytes:"function",bits2int:"function",bits2int_modN:"function"});const n=s.randomBytes||randomBytes,i=s.hmac||((m,...y)=>hmac(e,m,concatBytes(...y))),{Fp:r,Fn:o}=t,{ORDER:a,BITS:c}=o,{keygen:l,getPublicKey:u,getSharedSecret:h,utils:f,lengths:p}=ecdh(t,s),v={prehash:!1,lowS:typeof s.lowS=="boolean"?s.lowS:!1,format:void 0,extraEntropy:!1},k="compact";function R(m){const y=a>>_1n$1;return m>y}function D(m,y){if(!o.isValidNot0(y))throw new Error(`invalid signature ${m}: out of range 1..Point.Fn.ORDER`);return y}function U(m,y){validateSigFormat(y);const w=p.signature,_=y==="compact"?w:y==="recovered"?w+1:void 0;return _abytes2(m,_,`${y} signature`)}class C{constructor(y,w,_){this.r=D("r",y),this.s=D("s",w),_!=null&&(this.recovery=_),Object.freeze(this)}static fromBytes(y,w=k){U(y,w);let _;if(w==="der"){const{r:T,s:x}=DER.toSig(_abytes2(y));return new C(T,x)}w==="recovered"&&(_=y[0],w="compact",y=y.subarray(1));const A=o.BYTES,S=y.subarray(0,A),N=y.subarray(A,A*2);return new C(o.fromBytes(S),o.fromBytes(N),_)}static fromHex(y,w){return this.fromBytes(hexToBytes(y),w)}addRecoveryBit(y){return new C(this.r,this.s,y)}recoverPublicKey(y){const w=r.ORDER,{r:_,s:A,recovery:S}=this;if(S==null||![0,1,2,3].includes(S))throw new Error("recovery id invalid");if(a*_2n$1<w&&S>1)throw new Error("recovery id is ambiguous for h>1 curve");const T=S===2||S===3?_+a:_;if(!r.isValid(T))throw new Error("recovery id 2 or 3 invalid");const x=r.toBytes(T),K=t.fromBytes(concatBytes(pprefix((S&1)===0),x)),I=o.inv(T),$=M(ensureBytes("msgHash",y)),B=o.create(-$*I),L=o.create(A*I),j=t.BASE.multiplyUnsafe(B).add(K.multiplyUnsafe(L));if(j.is0())throw new Error("point at infinify");return j.assertValidity(),j}hasHighS(){return R(this.s)}toBytes(y=k){if(validateSigFormat(y),y==="der")return hexToBytes(DER.hexFromSig(this));const w=o.toBytes(this.r),_=o.toBytes(this.s);if(y==="recovered"){if(this.recovery==null)throw new Error("recovery bit must be present");return concatBytes(Uint8Array.of(this.recovery),w,_)}return concatBytes(w,_)}toHex(y){return bytesToHex(this.toBytes(y))}assertValidity(){}static fromCompact(y){return C.fromBytes(ensureBytes("sig",y),"compact")}static fromDER(y){return C.fromBytes(ensureBytes("sig",y),"der")}normalizeS(){return this.hasHighS()?new C(this.r,o.neg(this.s),this.recovery):this}toDERRawBytes(){return this.toBytes("der")}toDERHex(){return bytesToHex(this.toBytes("der"))}toCompactRawBytes(){return this.toBytes("compact")}toCompactHex(){return bytesToHex(this.toBytes("compact"))}}const P=s.bits2int||function(y){if(y.length>8192)throw new Error("input is too large");const w=bytesToNumberBE(y),_=y.length*8-c;return _>0?w>>BigInt(_):w},M=s.bits2int_modN||function(y){return o.create(P(y))},V=bitMask(c);function H(m){return aInRange("num < 2^"+c,m,_0n$1,V),o.toBytes(m)}function z(m,y){return _abytes2(m,void 0,"message"),y?_abytes2(e(m),void 0,"prehashed message"):m}function F(m,y,w){if(["recovered","canonical"].some(B=>B in w))throw new Error("sign() legacy options not supported");const{lowS:_,prehash:A,extraEntropy:S}=validateSigOpts(w,v);m=z(m,A);const N=M(m),T=_normFnElement(o,y),x=[H(T),H(N)];if(S!=null&&S!==!1){const B=S===!0?n(p.secretKey):S;x.push(ensureBytes("extraEntropy",B))}const K=concatBytes(...x),I=N;function $(B){const L=P(B);if(!o.isValidNot0(L))return;const j=o.inv(L),O=t.BASE.multiply(L).toAffine(),q=o.create(O.x);if(q===_0n$1)return;const Y=o.create(j*o.create(I+q*T));if(Y===_0n$1)return;let Q=(O.x===q?0:2)|Number(O.y&_1n$1),te=Y;return _&&R(Y)&&(te=o.neg(Y),Q^=1),new C(q,te,Q)}return{seed:K,k2sig:$}}function G(m,y,w={}){m=ensureBytes("message",m);const{seed:_,k2sig:A}=F(m,y,w);return createHmacDrbg(e.outputLen,o.BYTES,i)(_,A)}function E(m){let y;const w=typeof m=="string"||isBytes(m),_=!w&&m!==null&&typeof m=="object"&&typeof m.r=="bigint"&&typeof m.s=="bigint";if(!w&&!_)throw new Error("invalid signature, expected Uint8Array, hex string or Signature instance");if(_)y=new C(m.r,m.s);else if(w){try{y=C.fromBytes(ensureBytes("sig",m),"der")}catch(A){if(!(A instanceof DER.Err))throw A}if(!y)try{y=C.fromBytes(ensureBytes("sig",m),"compact")}catch{return!1}}return y||!1}function b(m,y,w,_={}){const{lowS:A,prehash:S,format:N}=validateSigOpts(_,v);if(w=ensureBytes("publicKey",w),y=z(ensureBytes("message",y),S),"strict"in _)throw new Error("options.strict was renamed to lowS");const T=N===void 0?E(m):C.fromBytes(ensureBytes("sig",m),N);if(T===!1)return!1;try{const x=t.fromBytes(w);if(A&&T.hasHighS())return!1;const{r:K,s:I}=T,$=M(y),B=o.inv(I),L=o.create($*B),j=o.create(K*B),O=t.BASE.multiplyUnsafe(L).add(x.multiplyUnsafe(j));return O.is0()?!1:o.create(O.x)===K}catch{return!1}}function g(m,y,w={}){const{prehash:_}=validateSigOpts(w,v);return y=z(y,_),C.fromBytes(m,"recovered").recoverPublicKey(y).toBytes()}return Object.freeze({keygen:l,getPublicKey:u,getSharedSecret:h,utils:f,lengths:p,Point:t,sign:G,verify:b,recoverPublicKey:g,Signature:C,hash:e})}function _weierstrass_legacy_opts_to_new(t){const e={a:t.a,b:t.b,p:t.Fp.ORDER,n:t.n,h:t.h,Gx:t.Gx,Gy:t.Gy},s=t.Fp;let n=t.allowedPrivateKeyLengths?Array.from(new Set(t.allowedPrivateKeyLengths.map(o=>Math.ceil(o/2)))):void 0;const i=Field(e.n,{BITS:t.nBitLength,allowedLengths:n,modFromBytes:t.wrapPrivateKey}),r={Fp:s,Fn:i,allowInfinityPoint:t.allowInfinityPoint,endo:t.endo,isTorsionFree:t.isTorsionFree,clearCofactor:t.clearCofactor,fromBytes:t.fromBytes,toBytes:t.toBytes};return{CURVE:e,curveOpts:r}}function _ecdsa_legacy_opts_to_new(t){const{CURVE:e,curveOpts:s}=_weierstrass_legacy_opts_to_new(t),n={hmac:t.hmac,randomBytes:t.randomBytes,lowS:t.lowS,bits2int:t.bits2int,bits2int_modN:t.bits2int_modN};return{CURVE:e,curveOpts:s,hash:t.hash,ecdsaOpts:n}}function _ecdsa_new_output_to_legacy(t,e){const s=e.Point;return Object.assign({},e,{ProjectivePoint:s,CURVE:Object.assign({},t,nLength(s.Fn.ORDER,s.Fn.BITS))})}function weierstrass(t){const{CURVE:e,curveOpts:s,hash:n,ecdsaOpts:i}=_ecdsa_legacy_opts_to_new(t),r=weierstrassN(e,s),o=ecdsa(r,n,i);return _ecdsa_new_output_to_legacy(t,o)}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */function createCurve(t,e){const s=n=>weierstrass({...t,hash:n});return{...s(e),create:s}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const secp256k1_CURVE={p:BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),n:BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),h:BigInt(1),a:BigInt(0),b:BigInt(7),Gx:BigInt("0x79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798"),Gy:BigInt("0x483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b8")},secp256k1_ENDO={beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),basises:[[BigInt("0x3086d221a7d46bcde86c90e49284eb15"),-BigInt("0xe4437ed6010e88286f547fa90abfe4c3")],[BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),BigInt("0x3086d221a7d46bcde86c90e49284eb15")]]},_0n=BigInt(0),_1n=BigInt(1),_2n=BigInt(2);function sqrtMod(t){const e=secp256k1_CURVE.p,s=BigInt(3),n=BigInt(6),i=BigInt(11),r=BigInt(22),o=BigInt(23),a=BigInt(44),c=BigInt(88),l=t*t*t%e,u=l*l*t%e,h=pow2(u,s,e)*u%e,f=pow2(h,s,e)*u%e,p=pow2(f,_2n,e)*l%e,v=pow2(p,i,e)*p%e,k=pow2(v,r,e)*v%e,R=pow2(k,a,e)*k%e,D=pow2(R,c,e)*R%e,U=pow2(D,a,e)*k%e,C=pow2(U,s,e)*u%e,P=pow2(C,o,e)*v%e,M=pow2(P,n,e)*l%e,V=pow2(M,_2n,e);if(!Fpk1.eql(Fpk1.sqr(V),t))throw new Error("Cannot find square root");return V}const Fpk1=Field(secp256k1_CURVE.p,{sqrt:sqrtMod}),secp256k1=createCurve({...secp256k1_CURVE,Fp:Fpk1,lowS:!0,endo:secp256k1_ENDO},sha256$1),TAGGED_HASH_PREFIXES={};function taggedHash(t,...e){let s=TAGGED_HASH_PREFIXES[t];if(s===void 0){const n=sha256$1(utf8ToBytes(t));s=concatBytes(n,n),TAGGED_HASH_PREFIXES[t]=s}return sha256$1(concatBytes(s,...e))}const pointToBytes=t=>t.toBytes(!0).slice(1),Pointk1=secp256k1.Point,hasEven=t=>t%_2n===_0n;function schnorrGetExtPubKey(t){const{Fn:e,BASE:s}=Pointk1,n=_normFnElement(e,t),i=s.multiply(n);return{scalar:hasEven(i.y)?n:e.neg(n),bytes:pointToBytes(i)}}function lift_x(t){const e=Fpk1;if(!e.isValidNot0(t))throw new Error("invalid x: Fail if x  p");const s=e.create(t*t),n=e.create(s*t+BigInt(7));let i=e.sqrt(n);hasEven(i)||(i=e.neg(i));const r=Pointk1.fromAffine({x:t,y:i});return r.assertValidity(),r}const num=bytesToNumberBE;function challenge(...t){return Pointk1.Fn.create(num(taggedHash("BIP0340/challenge",...t)))}function schnorrGetPublicKey(t){return schnorrGetExtPubKey(t).bytes}function schnorrSign(t,e,s=randomBytes(32)){const{Fn:n}=Pointk1,i=ensureBytes("message",t),{bytes:r,scalar:o}=schnorrGetExtPubKey(e),a=ensureBytes("auxRand",s,32),c=n.toBytes(o^num(taggedHash("BIP0340/aux",a))),l=taggedHash("BIP0340/nonce",c,r,i),{bytes:u,scalar:h}=schnorrGetExtPubKey(l),f=challenge(u,r,i),p=new Uint8Array(64);if(p.set(u,0),p.set(n.toBytes(n.create(h+f*o)),32),!schnorrVerify(p,i,r))throw new Error("sign: Invalid signature produced");return p}function schnorrVerify(t,e,s){const{Fn:n,BASE:i}=Pointk1,r=ensureBytes("signature",t,64),o=ensureBytes("message",e),a=ensureBytes("publicKey",s,32);try{const c=lift_x(num(a)),l=num(r.subarray(0,32));if(!inRange(l,_1n,secp256k1_CURVE.p))return!1;const u=num(r.subarray(32,64));if(!inRange(u,_1n,secp256k1_CURVE.n))return!1;const h=challenge(n.toBytes(l),pointToBytes(c),o),f=i.multiplyUnsafe(u).add(c.multiplyUnsafe(n.neg(h))),{x:p,y:v}=f.toAffine();return!(f.is0()||!hasEven(v)||p!==l)}catch{return!1}}const schnorr=(()=>{const s=(i=randomBytes(48))=>mapHashToField(i,secp256k1_CURVE.n);secp256k1.utils.randomSecretKey;function n(i){const r=s(i);return{secretKey:r,publicKey:schnorrGetPublicKey(r)}}return{keygen:n,getPublicKey:schnorrGetPublicKey,sign:schnorrSign,verify:schnorrVerify,Point:Pointk1,utils:{randomSecretKey:s,randomPrivateKey:s,taggedHash,lift_x,pointToBytes,numberToBytesBE,bytesToNumberBE,mod},lengths:{secretKey:32,publicKey:32,publicKeyHasPrefix:!1,signature:32*2,seed:48}}})(),sha256=sha256$1;var dist={},LRUCache$1={},LRUCacheNode$1={};Object.defineProperty(LRUCacheNode$1,"__esModule",{value:!0});LRUCacheNode$1.LRUCacheNode=void 0;class LRUCacheNode{constructor(e,s,n){const{entryExpirationTimeInMS:i=null,next:r=null,prev:o=null,onEntryEvicted:a,onEntryMarkedAsMostRecentlyUsed:c,clone:l,cloneFn:u}=n??{};if(typeof i=="number"&&(i<=0||Number.isNaN(i)))throw new Error("entryExpirationTimeInMS must either be null (no expiry) or greater than 0");this.clone=l??!1,this.cloneFn=u??this.defaultClone,this.key=e,this.internalValue=this.clone?this.cloneFn(s):s,this.created=Date.now(),this.entryExpirationTimeInMS=i,this.next=r,this.prev=o,this.onEntryEvicted=a,this.onEntryMarkedAsMostRecentlyUsed=c}get value(){return this.clone?this.cloneFn(this.internalValue):this.internalValue}get isExpired(){return typeof this.entryExpirationTimeInMS=="number"&&Date.now()-this.created>this.entryExpirationTimeInMS}invokeOnEvicted(){if(this.onEntryEvicted){const{key:e,value:s,isExpired:n}=this;this.onEntryEvicted({key:e,value:s,isExpired:n})}}invokeOnEntryMarkedAsMostRecentlyUsed(){if(this.onEntryMarkedAsMostRecentlyUsed){const{key:e,value:s}=this;this.onEntryMarkedAsMostRecentlyUsed({key:e,value:s})}}defaultClone(e){return typeof e=="boolean"||typeof e=="string"||typeof e=="number"?e:JSON.parse(JSON.stringify(e))}}LRUCacheNode$1.LRUCacheNode=LRUCacheNode;Object.defineProperty(LRUCache$1,"__esModule",{value:!0});LRUCache$1.LRUCache=void 0;const LRUCacheNode_1=LRUCacheNode$1;class LRUCache{constructor(e){this.lookupTable=new Map,this.head=null,this.tail=null;const{maxSize:s=25,entryExpirationTimeInMS:n=null,onEntryEvicted:i,onEntryMarkedAsMostRecentlyUsed:r,cloneFn:o,clone:a}=e??{};if(Number.isNaN(s)||s<=0)throw new Error("maxSize must be greater than 0.");if(typeof n=="number"&&(n<=0||Number.isNaN(n)))throw new Error("entryExpirationTimeInMS must either be null (no expiry) or greater than 0");this.maxSizeInternal=s,this.entryExpirationTimeInMS=n,this.onEntryEvicted=i,this.onEntryMarkedAsMostRecentlyUsed=r,this.clone=a,this.cloneFn=o}get size(){return this.cleanCache(),this.lookupTable.size}get remainingSize(){return this.maxSizeInternal-this.size}get newest(){return this.head?this.head.isExpired?(this.removeNodeFromListAndLookupTable(this.head),this.newest):this.mapNodeToEntry(this.head):null}get oldest(){return this.tail?this.tail.isExpired?(this.removeNodeFromListAndLookupTable(this.tail),this.oldest):this.mapNodeToEntry(this.tail):null}get maxSize(){return this.maxSizeInternal}set maxSize(e){if(Number.isNaN(e)||e<=0)throw new Error("maxSize must be greater than 0.");this.maxSizeInternal=e,this.enforceSizeLimit()}set(e,s,n){const i=this.lookupTable.get(e);i&&this.removeNodeFromListAndLookupTable(i);const r=new LRUCacheNode_1.LRUCacheNode(e,s,{entryExpirationTimeInMS:this.entryExpirationTimeInMS,onEntryEvicted:this.onEntryEvicted,onEntryMarkedAsMostRecentlyUsed:this.onEntryMarkedAsMostRecentlyUsed,clone:this.clone,cloneFn:this.cloneFn,...n});return this.setNodeAsHead(r),this.lookupTable.set(e,r),this.enforceSizeLimit(),this}get(e){const s=this.lookupTable.get(e);return s?s.isExpired?(this.removeNodeFromListAndLookupTable(s),null):(this.setNodeAsHead(s),s.value):null}peek(e){const s=this.lookupTable.get(e);return s?s.isExpired?(this.removeNodeFromListAndLookupTable(s),null):s.value:null}delete(e){const s=this.lookupTable.get(e);return s?this.removeNodeFromListAndLookupTable(s):!1}has(e){const s=this.lookupTable.get(e);return s?s.isExpired?(this.removeNodeFromListAndLookupTable(s),!1):!0:!1}clear(){this.head=null,this.tail=null,this.lookupTable.clear()}find(e){let s=this.head;for(;s;){if(s.isExpired){const i=s.next;this.removeNodeFromListAndLookupTable(s),s=i;continue}const n=this.mapNodeToEntry(s);if(e(n))return this.setNodeAsHead(s),n;s=s.next}return null}forEach(e){let s=this.head,n=0;for(;s;){if(s.isExpired){const i=s.next;this.removeNodeFromListAndLookupTable(s),s=i;continue}e(s.value,s.key,n),s=s.next,n++}}*values(){let e=this.head;for(;e;){if(e.isExpired){const s=e.next;this.removeNodeFromListAndLookupTable(e),e=s;continue}yield e.value,e=e.next}}*keys(){let e=this.head;for(;e;){if(e.isExpired){const s=e.next;this.removeNodeFromListAndLookupTable(e),e=s;continue}yield e.key,e=e.next}}*entries(){let e=this.head;for(;e;){if(e.isExpired){const s=e.next;this.removeNodeFromListAndLookupTable(e),e=s;continue}yield this.mapNodeToEntry(e),e=e.next}}*[Symbol.iterator](){let e=this.head;for(;e;){if(e.isExpired){const s=e.next;this.removeNodeFromListAndLookupTable(e),e=s;continue}yield this.mapNodeToEntry(e),e=e.next}}enforceSizeLimit(){let e=this.tail;for(;e!==null&&this.size>this.maxSizeInternal;){const s=e.prev;this.removeNodeFromListAndLookupTable(e),e=s}}mapNodeToEntry({key:e,value:s}){return{key:e,value:s}}setNodeAsHead(e){this.removeNodeFromList(e),this.head?(e.next=this.head,this.head.prev=e,this.head=e):(this.head=e,this.tail=e),e.invokeOnEntryMarkedAsMostRecentlyUsed()}removeNodeFromList(e){e.prev!==null&&(e.prev.next=e.next),e.next!==null&&(e.next.prev=e.prev),this.head===e&&(this.head=e.next),this.tail===e&&(this.tail=e.prev),e.next=null,e.prev=null}removeNodeFromListAndLookupTable(e){return e.invokeOnEvicted(),this.removeNodeFromList(e),this.lookupTable.delete(e.key)}cleanCache(){if(!this.entryExpirationTimeInMS)return;const e=[];for(const s of this.lookupTable.values())s.isExpired&&e.push(s);e.forEach(s=>this.removeNodeFromListAndLookupTable(s))}}LRUCache$1.LRUCache=LRUCache;(function(t){var e=commonjsGlobal&&commonjsGlobal.__createBinding||(Object.create?function(n,i,r,o){o===void 0&&(o=r);var a=Object.getOwnPropertyDescriptor(i,r);(!a||("get"in a?!i.__esModule:a.writable||a.configurable))&&(a={enumerable:!0,get:function(){return i[r]}}),Object.defineProperty(n,o,a)}:function(n,i,r,o){o===void 0&&(o=r),n[o]=i[r]}),s=commonjsGlobal&&commonjsGlobal.__exportStar||function(n,i){for(var r in n)r!=="default"&&!Object.prototype.hasOwnProperty.call(i,r)&&e(i,n,r)};Object.defineProperty(t,"__esModule",{value:!0}),s(LRUCache$1,t)})(dist);function pbkdf2Init(t,e,s,n){assert.hash(t);const i=checkOpts({dkLen:32,asyncTick:10},n),{c:r,dkLen:o,asyncTick:a}=i;if(assert.number(r),assert.number(o),assert.number(a),r<1)throw new Error("PBKDF2: iterations (c) should be >= 1");const c=toBytes$1(e),l=toBytes$1(s),u=new Uint8Array(o),h=hmac$1.create(t,c),f=h._cloneInto().update(l);return{c:r,dkLen:o,asyncTick:a,DK:u,PRF:h,PRFSalt:f}}function pbkdf2Output(t,e,s,n,i){return t.destroy(),e.destroy(),n&&n.destroy(),i.fill(0),s}function pbkdf2(t,e,s,n){const{c:i,dkLen:r,DK:o,PRF:a,PRFSalt:c}=pbkdf2Init(t,e,s,n);let l;const u=new Uint8Array(4),h=createView$1(u),f=new Uint8Array(a.outputLen);for(let p=1,v=0;v<r;p++,v+=a.outputLen){const k=o.subarray(v,v+a.outputLen);h.setInt32(0,p,!1),(l=c._cloneInto(l)).update(u).digestInto(f),k.set(f.subarray(0,k.length));for(let R=1;R<i;R++){a._cloneInto(l).update(f).digestInto(f);for(let D=0;D<k.length;D++)k[D]^=f[D]}}return pbkdf2Output(a,c,o,l,f)}const rotl=(t,e)=>t<<e|t>>>32-e;function XorAndSalsa(t,e,s,n,i,r){let o=t[e++]^s[n++],a=t[e++]^s[n++],c=t[e++]^s[n++],l=t[e++]^s[n++],u=t[e++]^s[n++],h=t[e++]^s[n++],f=t[e++]^s[n++],p=t[e++]^s[n++],v=t[e++]^s[n++],k=t[e++]^s[n++],R=t[e++]^s[n++],D=t[e++]^s[n++],U=t[e++]^s[n++],C=t[e++]^s[n++],P=t[e++]^s[n++],M=t[e++]^s[n++],V=o,H=a,z=c,F=l,G=u,E=h,b=f,g=p,m=v,y=k,w=R,_=D,A=U,S=C,N=P,T=M;for(let x=0;x<8;x+=2)G^=rotl(V+A|0,7),m^=rotl(G+V|0,9),A^=rotl(m+G|0,13),V^=rotl(A+m|0,18),y^=rotl(E+H|0,7),S^=rotl(y+E|0,9),H^=rotl(S+y|0,13),E^=rotl(H+S|0,18),N^=rotl(w+b|0,7),z^=rotl(N+w|0,9),b^=rotl(z+N|0,13),w^=rotl(b+z|0,18),F^=rotl(T+_|0,7),g^=rotl(F+T|0,9),_^=rotl(g+F|0,13),T^=rotl(_+g|0,18),H^=rotl(V+F|0,7),z^=rotl(H+V|0,9),F^=rotl(z+H|0,13),V^=rotl(F+z|0,18),b^=rotl(E+G|0,7),g^=rotl(b+E|0,9),G^=rotl(g+b|0,13),E^=rotl(G+g|0,18),_^=rotl(w+y|0,7),m^=rotl(_+w|0,9),y^=rotl(m+_|0,13),w^=rotl(y+m|0,18),A^=rotl(T+N|0,7),S^=rotl(A+T|0,9),N^=rotl(S+A|0,13),T^=rotl(N+S|0,18);i[r++]=o+V|0,i[r++]=a+H|0,i[r++]=c+z|0,i[r++]=l+F|0,i[r++]=u+G|0,i[r++]=h+E|0,i[r++]=f+b|0,i[r++]=p+g|0,i[r++]=v+m|0,i[r++]=k+y|0,i[r++]=R+w|0,i[r++]=D+_|0,i[r++]=U+A|0,i[r++]=C+S|0,i[r++]=P+N|0,i[r++]=M+T|0}function BlockMix(t,e,s,n,i){let r=n+0,o=n+16*i;for(let a=0;a<16;a++)s[o+a]=t[e+(2*i-1)*16+a];for(let a=0;a<i;a++,r+=16,e+=16)XorAndSalsa(s,o,t,e,s,r),a>0&&(o+=16),XorAndSalsa(s,r,t,e+=16,s,o)}function scryptInit(t,e,s){const n=checkOpts({dkLen:32,asyncTick:10,maxmem:1073742848},s),{N:i,r,p:o,dkLen:a,asyncTick:c,maxmem:l,onProgress:u}=n;if(assert.number(i),assert.number(r),assert.number(o),assert.number(a),assert.number(c),assert.number(l),u!==void 0&&typeof u!="function")throw new Error("progressCb should be function");const h=128*r,f=h/4;if(i<=1||i&i-1||i>=2**(h/8)||i>2**32)throw new Error("Scrypt: N must be larger than 1, a power of 2, less than 2^(128 * r / 8) and less than 2^32");if(o<0||o>(2**32-1)*32/h)throw new Error("Scrypt: p must be a positive integer less than or equal to ((2^32 - 1) * 32) / (128 * r)");if(a<0||a>(2**32-1)*32)throw new Error("Scrypt: dkLen should be positive integer less than or equal to (2^32 - 1) * 32");const p=h*(i+o);if(p>l)throw new Error(`Scrypt: parameters too large, ${p} (128 * r * (N + p)) > ${l} (maxmem)`);const v=pbkdf2(sha256$2,t,e,{c:1,dkLen:h*o}),k=u32(v),R=u32(new Uint8Array(h*i)),D=u32(new Uint8Array(h));let U=()=>{};if(u){const C=2*i*o,P=Math.max(Math.floor(C/1e4),1);let M=0;U=()=>{M++,u&&(!(M%P)||M===C)&&u(M/C)}}return{N:i,r,p:o,dkLen:a,blockSize32:f,V:R,B32:k,B:v,tmp:D,blockMixCb:U,asyncTick:c}}function scryptOutput(t,e,s,n,i){const r=pbkdf2(sha256$2,t,s,{c:1,dkLen:e});return s.fill(0),n.fill(0),i.fill(0),r}function scrypt(t,e,s){const{N:n,r:i,p:r,dkLen:o,blockSize32:a,V:c,B32:l,B:u,tmp:h,blockMixCb:f}=scryptInit(t,e,s);for(let p=0;p<r;p++){const v=a*p;for(let k=0;k<a;k++)c[k]=l[v+k];for(let k=0,R=0;k<n-1;k++)BlockMix(c,R,c,R+=a,i),f();BlockMix(c,(n-1)*a,l,v,i),f();for(let k=0;k<n;k++){const R=l[v+a-16]%n;for(let D=0;D<a;D++)h[D]=l[v+D]^c[R*a+D];BlockMix(h,0,l,v,i),f()}}return scryptOutput(t,o,u,c,h)}var Bech32MaxSize$1=5e3;function encodeBech32$1(t,e){let s=bech32$1.toWords(e);return bech32$1.encode(t,s,Bech32MaxSize$1)}function encodeBytes$1(t,e){return encodeBech32$1(t,e)}function encrypt$1(t,e,s=16,n=2){let i=randomBytes$1(16),r=2**s,o=scrypt(e.normalize("NFKC"),i,{N:r,r:8,p:1,dkLen:32}),a=randomBytes$1(24),c=Uint8Array.from([n]),u=xchacha20poly1305(o,a,c).encrypt(t),h=concatBytes$1(Uint8Array.from([2]),Uint8Array.from([s]),i,a,c,u);return encodeBytes$1("ncryptsec",h)}function decrypt$1(t,e){let{prefix:s,words:n}=bech32$1.decode(t,Bech32MaxSize$1);if(s!=="ncryptsec")throw new Error(`invalid prefix ${s}, expected 'ncryptsec'`);let i=new Uint8Array(bech32$1.fromWords(n)),r=i[0];if(r!==2)throw new Error(`invalid version ${r}, expected 0x02`);let a=2**i[1],c=i.slice(2,18),l=i.slice(18,42),u=i[42],h=Uint8Array.from([u]),f=i.slice(43),p=scrypt(e.normalize("NFKC"),c,{N:a,r:8,p:1,dkLen:32});return xchacha20poly1305(p,l,h).decrypt(f)}const nip49_star=Object.freeze(Object.defineProperty({__proto__:null,decrypt:decrypt$1,encrypt:encrypt$1},Symbol.toStringTag,{value:"Module"}));var utf8Decoder=new TextDecoder("utf-8"),utf8Encoder=new TextEncoder,NostrTypeGuard={isNProfile:t=>/^nprofile1[a-z\d]+$/.test(t||""),isNEvent:t=>/^nevent1[a-z\d]+$/.test(t||""),isNAddr:t=>/^naddr1[a-z\d]+$/.test(t||""),isNSec:t=>/^nsec1[a-z\d]{58}$/.test(t||""),isNPub:t=>/^npub1[a-z\d]{58}$/.test(t||""),isNote:t=>/^note1[a-z\d]+$/.test(t||""),isNcryptsec:t=>/^ncryptsec1[a-z\d]+$/.test(t||"")},Bech32MaxSize=5e3,BECH32_REGEX$1=/[\x21-\x7E]{1,83}1[023456789acdefghjklmnpqrstuvwxyz]{6,}/;function integerToUint8Array(t){const e=new Uint8Array(4);return e[0]=t>>24&255,e[1]=t>>16&255,e[2]=t>>8&255,e[3]=t&255,e}function decodeNostrURI(t){try{return t.startsWith("nostr:")&&(t=t.substring(6)),decode(t)}catch{return{type:"invalid",data:null}}}function decode(t){let{prefix:e,words:s}=bech32$1.decode(t,Bech32MaxSize),n=new Uint8Array(bech32$1.fromWords(s));switch(e){case"nprofile":{let i=parseTLV(n);if(!i[0]?.[0])throw new Error("missing TLV 0 for nprofile");if(i[0][0].length!==32)throw new Error("TLV 0 should be 32 bytes");return{type:"nprofile",data:{pubkey:bytesToHex$1(i[0][0]),relays:i[1]?i[1].map(r=>utf8Decoder.decode(r)):[]}}}case"nevent":{let i=parseTLV(n);if(!i[0]?.[0])throw new Error("missing TLV 0 for nevent");if(i[0][0].length!==32)throw new Error("TLV 0 should be 32 bytes");if(i[2]&&i[2][0].length!==32)throw new Error("TLV 2 should be 32 bytes");if(i[3]&&i[3][0].length!==4)throw new Error("TLV 3 should be 4 bytes");return{type:"nevent",data:{id:bytesToHex$1(i[0][0]),relays:i[1]?i[1].map(r=>utf8Decoder.decode(r)):[],author:i[2]?.[0]?bytesToHex$1(i[2][0]):void 0,kind:i[3]?.[0]?parseInt(bytesToHex$1(i[3][0]),16):void 0}}}case"naddr":{let i=parseTLV(n);if(!i[0]?.[0])throw new Error("missing TLV 0 for naddr");if(!i[2]?.[0])throw new Error("missing TLV 2 for naddr");if(i[2][0].length!==32)throw new Error("TLV 2 should be 32 bytes");if(!i[3]?.[0])throw new Error("missing TLV 3 for naddr");if(i[3][0].length!==4)throw new Error("TLV 3 should be 4 bytes");return{type:"naddr",data:{identifier:utf8Decoder.decode(i[0][0]),pubkey:bytesToHex$1(i[2][0]),kind:parseInt(bytesToHex$1(i[3][0]),16),relays:i[1]?i[1].map(r=>utf8Decoder.decode(r)):[]}}}case"nsec":return{type:e,data:n};case"npub":case"note":return{type:e,data:bytesToHex$1(n)};default:throw new Error(`unknown prefix ${e}`)}}function parseTLV(t){let e={},s=t;for(;s.length>0;){let n=s[0],i=s[1],r=s.slice(2,2+i);if(s=s.slice(2+i),r.length<i)throw new Error(`not enough data to read on TLV ${n}`);e[n]=e[n]||[],e[n].push(r)}return e}function nsecEncode(t){return encodeBytes("nsec",t)}function npubEncode(t){return encodeBytes("npub",hexToBytes$1(t))}function noteEncode(t){return encodeBytes("note",hexToBytes$1(t))}function encodeBech32(t,e){let s=bech32$1.toWords(e);return bech32$1.encode(t,s,Bech32MaxSize)}function encodeBytes(t,e){return encodeBech32(t,e)}function nprofileEncode(t){let e=encodeTLV({0:[hexToBytes$1(t.pubkey)],1:(t.relays||[]).map(s=>utf8Encoder.encode(s))});return encodeBech32("nprofile",e)}function neventEncode(t){let e;t.kind!==void 0&&(e=integerToUint8Array(t.kind));let s=encodeTLV({0:[hexToBytes$1(t.id)],1:(t.relays||[]).map(n=>utf8Encoder.encode(n)),2:t.author?[hexToBytes$1(t.author)]:[],3:e?[new Uint8Array(e)]:[]});return encodeBech32("nevent",s)}function naddrEncode(t){let e=new ArrayBuffer(4);new DataView(e).setUint32(0,t.kind,!1);let s=encodeTLV({0:[utf8Encoder.encode(t.identifier)],1:(t.relays||[]).map(n=>utf8Encoder.encode(n)),2:[hexToBytes$1(t.pubkey)],3:[new Uint8Array(e)]});return encodeBech32("naddr",s)}function encodeTLV(t){let e=[];return Object.entries(t).reverse().forEach(([s,n])=>{n.forEach(i=>{let r=new Uint8Array(i.length+2);r.set([parseInt(s)],0),r.set([i.length],1),r.set(i,2),e.push(r)})}),concatBytes$1(...e)}const nip19_star=Object.freeze(Object.defineProperty({__proto__:null,BECH32_REGEX:BECH32_REGEX$1,Bech32MaxSize,NostrTypeGuard,decode,decodeNostrURI,encodeBytes,naddrEncode,neventEncode,noteEncode,nprofileEncode,npubEncode,nsecEncode},Symbol.toStringTag,{value:"Module"}));var lib={};(function(t){/*! scure-base - MIT License (c) 2022 Paul Miller (paulmillr.com) */Object.defineProperty(t,"__esModule",{value:!0}),t.bytes=t.stringToBytes=t.str=t.bytesToString=t.hex=t.utf8=t.bech32m=t.bech32=t.base58check=t.base58xmr=t.base58xrp=t.base58flickr=t.base58=t.base64url=t.base64=t.base32crockford=t.base32hex=t.base32=t.base16=t.utils=t.assertNumber=void 0;function e(E){if(!Number.isSafeInteger(E))throw new Error(`Wrong integer: ${E}`)}t.assertNumber=e;function s(...E){const b=(y,w)=>_=>y(w(_)),g=Array.from(E).reverse().reduce((y,w)=>y?b(y,w.encode):w.encode,void 0),m=E.reduce((y,w)=>y?b(y,w.decode):w.decode,void 0);return{encode:g,decode:m}}function n(E){return{encode:b=>{if(!Array.isArray(b)||b.length&&typeof b[0]!="number")throw new Error("alphabet.encode input should be an array of numbers");return b.map(g=>{if(e(g),g<0||g>=E.length)throw new Error(`Digit index outside alphabet: ${g} (alphabet: ${E.length})`);return E[g]})},decode:b=>{if(!Array.isArray(b)||b.length&&typeof b[0]!="string")throw new Error("alphabet.decode input should be array of strings");return b.map(g=>{if(typeof g!="string")throw new Error(`alphabet.decode: not string element=${g}`);const m=E.indexOf(g);if(m===-1)throw new Error(`Unknown letter: "${g}". Allowed: ${E}`);return m})}}}function i(E=""){if(typeof E!="string")throw new Error("join separator should be string");return{encode:b=>{if(!Array.isArray(b)||b.length&&typeof b[0]!="string")throw new Error("join.encode input should be array of strings");for(let g of b)if(typeof g!="string")throw new Error(`join.encode: non-string input=${g}`);return b.join(E)},decode:b=>{if(typeof b!="string")throw new Error("join.decode input should be string");return b.split(E)}}}function r(E,b="="){if(e(E),typeof b!="string")throw new Error("padding chr should be string");return{encode(g){if(!Array.isArray(g)||g.length&&typeof g[0]!="string")throw new Error("padding.encode input should be array of strings");for(let m of g)if(typeof m!="string")throw new Error(`padding.encode: non-string input=${m}`);for(;g.length*E%8;)g.push(b);return g},decode(g){if(!Array.isArray(g)||g.length&&typeof g[0]!="string")throw new Error("padding.encode input should be array of strings");for(let y of g)if(typeof y!="string")throw new Error(`padding.decode: non-string input=${y}`);let m=g.length;if(m*E%8)throw new Error("Invalid padding: string should have whole number of bytes");for(;m>0&&g[m-1]===b;m--)if(!((m-1)*E%8))throw new Error("Invalid padding: string has too much padding");return g.slice(0,m)}}}function o(E){if(typeof E!="function")throw new Error("normalize fn should be function");return{encode:b=>b,decode:b=>E(b)}}function a(E,b,g){if(b<2)throw new Error(`convertRadix: wrong from=${b}, base cannot be less than 2`);if(g<2)throw new Error(`convertRadix: wrong to=${g}, base cannot be less than 2`);if(!Array.isArray(E))throw new Error("convertRadix: data should be array");if(!E.length)return[];let m=0;const y=[],w=Array.from(E);for(w.forEach(_=>{if(e(_),_<0||_>=b)throw new Error(`Wrong integer: ${_}`)});;){let _=0,A=!0;for(let S=m;S<w.length;S++){const N=w[S],T=b*_+N;if(!Number.isSafeInteger(T)||b*_/b!==_||T-N!==b*_)throw new Error("convertRadix: carry overflow");if(_=T%g,w[S]=Math.floor(T/g),!Number.isSafeInteger(w[S])||w[S]*g+_!==T)throw new Error("convertRadix: carry overflow");if(A)w[S]?A=!1:m=S;else continue}if(y.push(_),A)break}for(let _=0;_<E.length-1&&E[_]===0;_++)y.push(0);return y.reverse()}const c=(E,b)=>b?c(b,E%b):E,l=(E,b)=>E+(b-c(E,b));function u(E,b,g,m){if(!Array.isArray(E))throw new Error("convertRadix2: data should be array");if(b<=0||b>32)throw new Error(`convertRadix2: wrong from=${b}`);if(g<=0||g>32)throw new Error(`convertRadix2: wrong to=${g}`);if(l(b,g)>32)throw new Error(`convertRadix2: carry overflow from=${b} to=${g} carryBits=${l(b,g)}`);let y=0,w=0;const _=2**g-1,A=[];for(const S of E){if(e(S),S>=2**b)throw new Error(`convertRadix2: invalid data word=${S} from=${b}`);if(y=y<<b|S,w+b>32)throw new Error(`convertRadix2: carry overflow pos=${w} from=${b}`);for(w+=b;w>=g;w-=g)A.push((y>>w-g&_)>>>0);y&=2**w-1}if(y=y<<g-w&_,!m&&w>=b)throw new Error("Excess padding");if(!m&&y)throw new Error(`Non-zero padding: ${y}`);return m&&w>0&&A.push(y>>>0),A}function h(E){return e(E),{encode:b=>{if(!(b instanceof Uint8Array))throw new Error("radix.encode input should be Uint8Array");return a(Array.from(b),2**8,E)},decode:b=>{if(!Array.isArray(b)||b.length&&typeof b[0]!="number")throw new Error("radix.decode input should be array of strings");return Uint8Array.from(a(b,E,2**8))}}}function f(E,b=!1){if(e(E),E<=0||E>32)throw new Error("radix2: bits should be in (0..32]");if(l(8,E)>32||l(E,8)>32)throw new Error("radix2: carry overflow");return{encode:g=>{if(!(g instanceof Uint8Array))throw new Error("radix2.encode input should be Uint8Array");return u(Array.from(g),8,E,!b)},decode:g=>{if(!Array.isArray(g)||g.length&&typeof g[0]!="number")throw new Error("radix2.decode input should be array of strings");return Uint8Array.from(u(g,E,8,b))}}}function p(E){if(typeof E!="function")throw new Error("unsafeWrapper fn should be function");return function(...b){try{return E.apply(null,b)}catch{}}}function v(E,b){if(e(E),typeof b!="function")throw new Error("checksum fn should be function");return{encode(g){if(!(g instanceof Uint8Array))throw new Error("checksum.encode: input should be Uint8Array");const m=b(g).slice(0,E),y=new Uint8Array(g.length+E);return y.set(g),y.set(m,g.length),y},decode(g){if(!(g instanceof Uint8Array))throw new Error("checksum.decode: input should be Uint8Array");const m=g.slice(0,-E),y=b(m).slice(0,E),w=g.slice(-E);for(let _=0;_<E;_++)if(y[_]!==w[_])throw new Error("Invalid checksum");return m}}}t.utils={alphabet:n,chain:s,checksum:v,radix:h,radix2:f,join:i,padding:r},t.base16=s(f(4),n("0123456789ABCDEF"),i("")),t.base32=s(f(5),n("ABCDEFGHIJKLMNOPQRSTUVWXYZ234567"),r(5),i("")),t.base32hex=s(f(5),n("0123456789ABCDEFGHIJKLMNOPQRSTUV"),r(5),i("")),t.base32crockford=s(f(5),n("0123456789ABCDEFGHJKMNPQRSTVWXYZ"),i(""),o(E=>E.toUpperCase().replace(/O/g,"0").replace(/[IL]/g,"1"))),t.base64=s(f(6),n("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"),r(6),i("")),t.base64url=s(f(6),n("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_"),r(6),i(""));const k=E=>s(h(58),n(E),i(""));t.base58=k("123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"),t.base58flickr=k("123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"),t.base58xrp=k("rpshnaf39wBUDNEGHJKLM4PQRST7VWXYZ2bcdeCg65jkm8oFqi1tuvAxyz");const R=[0,2,3,5,6,7,9,10,11];t.base58xmr={encode(E){let b="";for(let g=0;g<E.length;g+=8){const m=E.subarray(g,g+8);b+=t.base58.encode(m).padStart(R[m.length],"1")}return b},decode(E){let b=[];for(let g=0;g<E.length;g+=11){const m=E.slice(g,g+11),y=R.indexOf(m.length),w=t.base58.decode(m);for(let _=0;_<w.length-y;_++)if(w[_]!==0)throw new Error("base58xmr: wrong padding");b=b.concat(Array.from(w.slice(w.length-y)))}return Uint8Array.from(b)}};const D=E=>s(v(4,b=>E(E(b))),t.base58);t.base58check=D;const U=s(n("qpzry9x8gf2tvdw0s3jn54khce6mua7l"),i("")),C=[996825010,642813549,513874426,1027748829,705979059];function P(E){const b=E>>25;let g=(E&33554431)<<5;for(let m=0;m<C.length;m++)(b>>m&1)===1&&(g^=C[m]);return g}function M(E,b,g=1){const m=E.length;let y=1;for(let w=0;w<m;w++){const _=E.charCodeAt(w);if(_<33||_>126)throw new Error(`Invalid prefix (${E})`);y=P(y)^_>>5}y=P(y);for(let w=0;w<m;w++)y=P(y)^E.charCodeAt(w)&31;for(let w of b)y=P(y)^w;for(let w=0;w<6;w++)y=P(y);return y^=g,U.encode(u([y%2**30],30,5,!1))}function V(E){const b=E==="bech32"?1:734539939,g=f(5),m=g.decode,y=g.encode,w=p(m);function _(T,x,K=90){if(typeof T!="string")throw new Error(`bech32.encode prefix should be string, not ${typeof T}`);if(!Array.isArray(x)||x.length&&typeof x[0]!="number")throw new Error(`bech32.encode words should be array of numbers, not ${typeof x}`);const I=T.length+7+x.length;if(K!==!1&&I>K)throw new TypeError(`Length ${I} exceeds limit ${K}`);return T=T.toLowerCase(),`${T}1${U.encode(x)}${M(T,x,b)}`}function A(T,x=90){if(typeof T!="string")throw new Error(`bech32.decode input should be string, not ${typeof T}`);if(T.length<8||x!==!1&&T.length>x)throw new TypeError(`Wrong string length: ${T.length} (${T}). Expected (8..${x})`);const K=T.toLowerCase();if(T!==K&&T!==T.toUpperCase())throw new Error("String must be lowercase or uppercase");T=K;const I=T.lastIndexOf("1");if(I===0||I===-1)throw new Error('Letter "1" must be present between prefix and data only');const $=T.slice(0,I),B=T.slice(I+1);if(B.length<6)throw new Error("Data must be at least 6 characters long");const L=U.decode(B).slice(0,-6),j=M($,L,b);if(!B.endsWith(j))throw new Error(`Invalid checksum in ${T}: expected "${j}"`);return{prefix:$,words:L}}const S=p(A);function N(T){const{prefix:x,words:K}=A(T,!1);return{prefix:x,words:K,bytes:m(K)}}return{encode:_,decode:A,decodeToBytes:N,decodeUnsafe:S,fromWords:m,fromWordsUnsafe:w,toWords:y}}t.bech32=V("bech32"),t.bech32m=V("bech32m"),t.utf8={encode:E=>new TextDecoder().decode(E),decode:E=>new TextEncoder().encode(E)},t.hex=s(f(4),n("0123456789abcdef"),i(""),o(E=>{if(typeof E!="string"||E.length%2)throw new TypeError(`hex.decode: expected string, got ${typeof E} with length ${E.length}`);return E.toLowerCase()}));const H={utf8:t.utf8,hex:t.hex,base16:t.base16,base32:t.base32,base64:t.base64,base64url:t.base64url,base58:t.base58,base58xmr:t.base58xmr},z=`Invalid encoding type. Available types: ${Object.keys(H).join(", ")}`,F=(E,b)=>{if(typeof E!="string"||!H.hasOwnProperty(E))throw new TypeError(z);if(!(b instanceof Uint8Array))throw new TypeError("bytesToString() expects Uint8Array");return H[E].encode(b)};t.bytesToString=F,t.str=t.bytesToString;const G=(E,b)=>{if(!H.hasOwnProperty(E))throw new TypeError(z);if(typeof b!="string")throw new TypeError("stringToBytes() expects string");return H[E].decode(b)};t.stringToBytes=G,t.bytes=t.stringToBytes})(lib);const{bech32,hex,utf8}=lib;BigInt(1e3),BigInt(1e6),BigInt(1e9),BigInt(1e12);BigInt("2100000000000000000");BigInt(1e11);const TAGCODES={payment_hash:1,payment_secret:16,description:13,payee:19,description_hash:23,expiry:6,min_final_cltv_expiry:24,fallback_address:9,route_hint:3,feature_bits:5,metadata:27};for(let t=0,e=Object.keys(TAGCODES);t<e.length;t++)e[t],TAGCODES[e[t]].toString();var __defProp=Object.defineProperty,__getOwnPropDesc=Object.getOwnPropertyDescriptor,__getOwnPropNames=Object.getOwnPropertyNames,__hasOwnProp=Object.prototype.hasOwnProperty,__copyProps=(t,e,s,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of __getOwnPropNames(e))!__hasOwnProp.call(t,i)&&i!==s&&__defProp(t,i,{get:()=>e[i],enumerable:!(n=__getOwnPropDesc(e,i))||n.enumerable});return t},__reExport=(t,e,s)=>(__copyProps(t,e,"default"),s);function getRelaysForSync(t,e,s="write"){if(!t.outboxTracker)return;const n=t.outboxTracker.data.get(e);if(n)return s==="write"?n.writeRelays:n.readRelays}async function getWriteRelaysFor(t,e,s="write"){if(t.outboxTracker)return t.outboxTracker.data.has(e)||await t.outboxTracker.trackUsers([e]),getRelaysForSync(t,e,s)}function getTopRelaysForAuthors(t,e){const s=new Map;return e.forEach(i=>{const r=getRelaysForSync(t,i);r&&r.forEach(o=>{const a=s.get(o)||0;s.set(o,a+1)})}),Array.from(s.entries()).sort((i,r)=>r[1]-i[1]).map(i=>i[0])}function getAllRelaysForAllPubkeys(t,e,s="read"){const n=new Map,i=new Set;return e.forEach(r=>{const o=getRelaysForSync(t,r,s);o&&o.size>0?(o.forEach(a=>{(n.get(a)||new Set).add(r)}),n.set(r,o)):i.add(r)}),{pubkeysToRelays:n,authorsMissingRelays:i}}function chooseRelayCombinationForPubkeys(t,e,s,{count:n,preferredRelays:i}={}){n??=2,i??=new Set;const r=t.pool,o=r.connectedRelays();o.forEach(f=>{i?.add(f.url)});const a=new Map,{pubkeysToRelays:c,authorsMissingRelays:l}=getAllRelaysForAllPubkeys(t,e,s),u=getTopRelaysForAuthors(t,e),h=(f,p)=>{const v=a.get(p)||[];v.push(f),a.set(p,v)};for(const[f,p]of c.entries()){let v=n;const k=new Set;for(const R of o)p.has(R.url)&&(h(f,R.url),k.add(R.url),v--);for(const R of p)k.has(R)||a.has(R)&&(h(f,R),k.add(R),v--);if(!(v<=0))for(const R of u){if(v<=0)break;k.has(R)||p.has(R)&&(h(f,R),k.add(R),v--)}}for(const f of l)r.permanentAndConnectedRelays().forEach(p=>{const v=a.get(p.url)||[];v.push(f),a.set(p.url,v)});return a}function getRelaysForFilterWithAuthors(t,e,s=2){return chooseRelayCombinationForPubkeys(t,e,"write",{count:s})}function tryNormalizeRelayUrl(t){try{return normalizeRelayUrl(t)}catch{return}}function normalizeRelayUrl(t){let e=normalizeUrl(t,{stripAuthentication:!1,stripWWW:!1,stripHash:!0});return e.endsWith("/")||(e+="/"),e}function normalize(t){const e=new Set;for(const s of t)try{e.add(normalizeRelayUrl(s))}catch{}return Array.from(e)}var DATA_URL_DEFAULT_MIME_TYPE="text/plain",DATA_URL_DEFAULT_CHARSET="us-ascii",testParameter=(t,e)=>e.some(s=>s instanceof RegExp?s.test(t):s===t),supportedProtocols=new Set(["https:","http:","file:"]),hasCustomProtocol=t=>{try{const{protocol:e}=new URL(t);return e.endsWith(":")&&!e.includes(".")&&!supportedProtocols.has(e)}catch{return!1}},normalizeDataURL=(t,{stripHash:e})=>{const s=/^data:(?<type>[^,]*?),(?<data>[^#]*?)(?:#(?<hash>.*))?$/.exec(t);if(!s)throw new Error(`Invalid URL: ${t}`);const n=s.groups?.type??"",i=s.groups?.data??"";let r=s.groups?.hash??"";const o=n.split(";");r=e?"":r;let a=!1;o[o.length-1]==="base64"&&(o.pop(),a=!0);const c=o.shift()?.toLowerCase()??"",u=[...o.map(h=>{let[f,p=""]=h.split("=").map(v=>v.trim());return f==="charset"&&(p=p.toLowerCase(),p===DATA_URL_DEFAULT_CHARSET)?"":`${f}${p?`=${p}`:""}`}).filter(Boolean)];return a&&u.push("base64"),(u.length>0||c&&c!==DATA_URL_DEFAULT_MIME_TYPE)&&u.unshift(c),`data:${u.join(";")},${a?i.trim():i}${r?`#${r}`:""}`};function normalizeUrl(t,e={}){if(e={defaultProtocol:"http",normalizeProtocol:!0,forceHttp:!1,forceHttps:!1,stripAuthentication:!0,stripHash:!1,stripTextFragment:!0,stripWWW:!0,removeQueryParameters:[/^utm_\w+/i],removeTrailingSlash:!0,removeSingleSlash:!0,removeDirectoryIndex:!1,removeExplicitPort:!1,sortQueryParameters:!0,...e},typeof e.defaultProtocol=="string"&&!e.defaultProtocol.endsWith(":")&&(e.defaultProtocol=`${e.defaultProtocol}:`),t=t.trim(),/^data:/i.test(t))return normalizeDataURL(t,e);if(hasCustomProtocol(t))return t;const s=t.startsWith("//");!s&&/^\.*\//.test(t)||(t=t.replace(/^(?!(?:\w+:)?\/\/)|^\/\//,e.defaultProtocol));const i=new URL(t);if(i.hostname=i.hostname.toLowerCase(),e.forceHttp&&e.forceHttps)throw new Error("The `forceHttp` and `forceHttps` options cannot be used together");if(e.forceHttp&&i.protocol==="https:"&&(i.protocol="http:"),e.forceHttps&&i.protocol==="http:"&&(i.protocol="https:"),e.stripAuthentication&&(i.username="",i.password=""),e.stripHash?i.hash="":e.stripTextFragment&&(i.hash=i.hash.replace(/#?:~:text.*?$/i,"")),i.pathname){const o=/\b[a-z][a-z\d+\-.]{1,50}:\/\//g;let a=0,c="";for(;;){const u=o.exec(i.pathname);if(!u)break;const h=u[0],f=u.index,p=i.pathname.slice(a,f);c+=p.replace(/\/{2,}/g,"/"),c+=h,a=f+h.length}const l=i.pathname.slice(a,i.pathname.length);c+=l.replace(/\/{2,}/g,"/"),i.pathname=c}if(i.pathname)try{i.pathname=decodeURI(i.pathname)}catch{}if(e.removeDirectoryIndex===!0&&(e.removeDirectoryIndex=[/^index\.[a-z]+$/]),Array.isArray(e.removeDirectoryIndex)&&e.removeDirectoryIndex.length>0){let o=i.pathname.split("/");const a=o[o.length-1];testParameter(a,e.removeDirectoryIndex)&&(o=o.slice(0,-1),i.pathname=`${o.slice(1).join("/")}/`)}if(i.hostname&&(i.hostname=i.hostname.replace(/\.$/,""),e.stripWWW&&/^www\.(?!www\.)[a-z\-\d]{1,63}\.[a-z.\-\d]{2,63}$/.test(i.hostname)&&(i.hostname=i.hostname.replace(/^www\./,""))),Array.isArray(e.removeQueryParameters))for(const o of[...i.searchParams.keys()])testParameter(o,e.removeQueryParameters)&&i.searchParams.delete(o);if(!Array.isArray(e.keepQueryParameters)&&e.removeQueryParameters===!0&&(i.search=""),Array.isArray(e.keepQueryParameters)&&e.keepQueryParameters.length>0)for(const o of[...i.searchParams.keys()])testParameter(o,e.keepQueryParameters)||i.searchParams.delete(o);if(e.sortQueryParameters){i.searchParams.sort();try{i.search=decodeURIComponent(i.search)}catch{}}e.removeTrailingSlash&&(i.pathname=i.pathname.replace(/\/$/,"")),e.removeExplicitPort&&i.port&&(i.port="");const r=t;return t=i.toString(),!e.removeSingleSlash&&i.pathname==="/"&&!r.endsWith("/")&&i.hash===""&&(t=t.replace(/\/$/,"")),(e.removeTrailingSlash||i.pathname==="/")&&i.hash===""&&e.removeSingleSlash&&(t=t.replace(/\/$/,"")),s&&!e.normalizeProtocol&&(t=t.replace(/^http:\/\//,"//")),e.stripProtocol&&(t=t.replace(/^(?:https?:)?\/\//,"")),t}var NDKRelayKeepalive=class{constructor(t=3e4,e){this.onSilenceDetected=e,this.timeout=t}lastActivity=Date.now();timer;timeout;isRunning=!1;recordActivity(){this.lastActivity=Date.now(),this.isRunning&&this.resetTimer()}start(){this.isRunning||(this.isRunning=!0,this.lastActivity=Date.now(),this.resetTimer())}stop(){this.isRunning=!1,this.timer&&(clearTimeout(this.timer),this.timer=void 0)}resetTimer(){this.timer&&clearTimeout(this.timer),this.timer=setTimeout(()=>{const t=Date.now()-this.lastActivity;if(t>=this.timeout)this.onSilenceDetected();else{const e=this.timeout-t;this.timer=setTimeout(()=>{this.onSilenceDetected()},e)}},this.timeout)}};async function probeRelayConnection(t){const e=`probe-${Math.random().toString(36).substring(7)}`;return new Promise(s=>{let n=!1;const i=setTimeout(()=>{n||(n=!0,t.send(["CLOSE",e]),s(!1))},5e3),r=()=>{n||(n=!0,clearTimeout(i),t.send(["CLOSE",e]),s(!0))};t.once("message",r),t.send(["REQ",e,{kinds:[99999],limit:0}])})}var MAX_RECONNECT_ATTEMPTS=5,FLAPPING_THRESHOLD_MS=1e3,NDKRelayConnectivity=class{ndkRelay;ws;_status;timeoutMs;connectedAt;_connectionStats={attempts:0,success:0,durations:[]};debug;netDebug;connectTimeout;reconnectTimeout;ndk;openSubs=new Map;openCountRequests=new Map;openEventPublishes=new Map;pendingAuthPublishes=new Map;serial=0;baseEoseTimeout=4400;keepalive;wsStateMonitor;sleepDetector;lastSleepCheck=Date.now();lastMessageSent=Date.now();wasIdle=!1;constructor(t,e){this.ndkRelay=t,this._status=1;const s=Math.floor(Math.random()*1e3);this.debug=this.ndkRelay.debug.extend(`connectivity${s}`),this.ndk=e,this.setupMonitoring()}setupMonitoring(){this.keepalive=new NDKRelayKeepalive(12e4,async()=>{this.debug("Relay silence detected, probing connection"),await probeRelayConnection({send:e=>this.send(JSON.stringify(e)),once:(e,s)=>{const n=i=>{try{const r=JSON.parse(i.data);(r[0]==="EOSE"||r[0]==="EVENT"||r[0]==="NOTICE")&&(s(),this.ws?.removeEventListener("message",n))}catch{}};this.ws?.addEventListener("message",n)}})||(this.debug("Probe failed, connection is stale"),this.handleStaleConnection())}),this.wsStateMonitor=setInterval(()=>{this._status===5&&(!this.ws||this.ws.readyState!==WebSocket.OPEN)&&(this.debug("WebSocket died silently, reconnecting"),this.handleStaleConnection())},5e3),this.sleepDetector=setInterval(()=>{const t=Date.now(),e=t-this.lastSleepCheck;e>15e3&&(this.debug(`Detected possible sleep/wake (${e}ms gap)`),this.handlePossibleWake()),this.lastSleepCheck=t},1e4)}handleStaleConnection(){this._status=1,this.wasIdle=!0,this.onDisconnect()}handlePossibleWake(){this.debug("System wake detected, checking all connections"),this.wasIdle=!0,this._status>=5&&(!this.ws||this.ws.readyState!==WebSocket.OPEN?this.handleStaleConnection():probeRelayConnection({send:t=>this.send(JSON.stringify(t)),once:(t,e)=>{const s=n=>{try{const i=JSON.parse(n.data);(i[0]==="EOSE"||i[0]==="EVENT"||i[0]==="NOTICE")&&(e(),this.ws?.removeEventListener("message",s))}catch{}};this.ws?.addEventListener("message",s)}}).then(t=>{t||this.handleStaleConnection()}))}resetReconnectionState(){this.wasIdle=!0,this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=void 0)}async connect(t,e=!0){if(this.ws&&this.ws.readyState!==WebSocket.OPEN&&this.ws.readyState!==WebSocket.CONNECTING){this.debug("Cleaning up stale WebSocket connection");try{this.ws.close()}catch{}this.ws=void 0,this._status=1}if(this._status!==2&&this._status!==1||this.reconnectTimeout){this.debug("Relay requested to be connected but was in state %s or it had a reconnect timeout",this._status);return}this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=void 0),this.connectTimeout&&(clearTimeout(this.connectTimeout),this.connectTimeout=void 0),t??=this.timeoutMs,!this.timeoutMs&&t&&(this.timeoutMs=t),this.timeoutMs&&(this.connectTimeout=setTimeout(()=>this.onConnectionError(e),this.timeoutMs));try{this.updateConnectionStats.attempt(),this._status===1?this._status=4:this._status=2,this.ws=new WebSocket(this.ndkRelay.url),this.ws.onopen=this.onConnect.bind(this),this.ws.onclose=this.onDisconnect.bind(this),this.ws.onmessage=this.onMessage.bind(this),this.ws.onerror=this.onError.bind(this)}catch(s){throw this.debug(`Failed to connect to ${this.ndkRelay.url}`,s),this._status=1,e?this.handleReconnection():this.ndkRelay.emit("delayed-connect",2*24*60*60*1e3),s}}disconnect(){this._status=0,this.keepalive?.stop(),this.wsStateMonitor&&(clearInterval(this.wsStateMonitor),this.wsStateMonitor=void 0),this.sleepDetector&&(clearInterval(this.sleepDetector),this.sleepDetector=void 0);try{this.ws?.close()}catch(t){this.debug("Failed to disconnect",t),this._status=1}}onConnectionError(t){this.debug(`Error connecting to ${this.ndkRelay.url}`,this.timeoutMs),t&&!this.reconnectTimeout&&this.handleReconnection()}onConnect(){this.netDebug?.("connected",this.ndkRelay),this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=void 0),this.connectTimeout&&(clearTimeout(this.connectTimeout),this.connectTimeout=void 0),this.updateConnectionStats.connected(),this._status=5,this.keepalive?.start(),this.wasIdle=!1,this.ndkRelay.emit("connect"),this.ndkRelay.emit("ready")}onDisconnect(){this.netDebug?.("disconnected",this.ndkRelay),this.updateConnectionStats.disconnected(),this.keepalive?.stop(),this.clearPendingPublishes(new Error(`Relay ${this.ndkRelay.url} disconnected`)),this._status===5&&this.handleReconnection(),this._status=1,this.ndkRelay.emit("disconnect")}onMessage(t){this.netDebug?.(t.data,this.ndkRelay,"recv"),this.keepalive?.recordActivity();try{const e=JSON.parse(t.data),[s,n,...i]=e,r=this.ndkRelay.getProtocolHandler(s);if(r){r(this.ndkRelay,e);return}switch(s){case"EVENT":{const o=this.openSubs.get(n),a=e[2];if(!o){this.debug(`Received event for unknown subscription ${n}`);return}o.onevent(a);return}case"COUNT":{const o=e[2],a=this.openCountRequests.get(n);a&&(a.resolve(o.count),this.openCountRequests.delete(n));return}case"EOSE":{const o=this.openSubs.get(n);if(!o)return;o.oneose(n);return}case"OK":{const o=e[2],a=e[3],c=this.openEventPublishes.get(n),l=c?.pop();if(!c||!l){this.debug("Received OK for unknown event publish",n);return}o?(l.resolve(a),this.pendingAuthPublishes.delete(n)):a&&(a.toLowerCase().includes("auth-required")||a.toLowerCase().includes("not authorized")||a.toLowerCase().includes("blocked: not authorized"))?this.pendingAuthPublishes.get(n)?(this.debug("Publish failed due to auth-required, will retry after auth",n),c.push(l),this.openEventPublishes.set(n,c)):l.reject(new Error(a)):(l.reject(new Error(a)),this.pendingAuthPublishes.delete(n)),c.length===0?this.openEventPublishes.delete(n):!o&&!(a?.toLowerCase().includes("auth-required")||a?.toLowerCase().includes("not authorized")||a?.toLowerCase().includes("blocked: not authorized"))&&this.openEventPublishes.set(n,c);return}case"CLOSED":{const o=this.openSubs.get(n);if(!o)return;o.onclosed(e[2]);return}case"NOTICE":this.onNotice(e[1]);return;case"AUTH":{this.onAuthRequested(e[1]);return}}}catch(e){this.debug(`Error parsing message from ${this.ndkRelay.url}: ${e.message}`,e?.stack);return}}async onAuthRequested(t){const e=this.ndkRelay.authPolicy??this.ndk?.relayAuthDefaultPolicy;if(this.debug("Relay requested authentication",{havePolicy:!!e}),this._status===7){this.debug("Already authenticating, ignoring");return}if(this._status=6,e){if(this._status>=5){this._status=7;let s;try{s=await e(this.ndkRelay,t)}catch(n){this.debug("Authentication policy threw an error",n),s=!1}if(this.debug("Authentication policy returned",!!s),s instanceof NDKEvent||s===!0){s instanceof NDKEvent&&await this.auth(s);const n=async()=>{if(this._status>=5&&this._status<8){const i=new NDKEvent(this.ndk);i.kind=22242,i.tags=[["relay",this.ndkRelay.url],["challenge",t]],await i.sign(),this.auth(i).then(()=>{this._status=8,this.ndkRelay.emit("authed"),this.debug("Authentication successful"),this.retryPendingAuthPublishes()}).catch(r=>{this._status=6,this.ndkRelay.emit("auth:failed",r),this.debug("Authentication failed",r),this.rejectPendingAuthPublishes(r)})}else this.debug("Authentication failed, it changed status, status is %d",this._status)};s===!0&&(this.ndk?.signer?n().catch(i=>{console.error("Error authenticating",i)}):(this.debug("No signer available for authentication localhost"),this.ndk?.once("signer:ready",n))),this._status=5,this.ndkRelay.emit("authed")}}}else this.ndkRelay.emit("auth",t)}onError(t){this.debug(`WebSocket error on ${this.ndkRelay.url}:`,t)}get status(){return this._status}isAvailable(){return this._status===5}isFlapping(){const t=this._connectionStats.durations;if(t.length%3!==0)return!1;const s=t.reduce((o,a)=>o+a,0)/t.length,n=t.map(o=>(o-s)**2).reduce((o,a)=>o+a,0)/t.length;return Math.sqrt(n)<FLAPPING_THRESHOLD_MS}async onNotice(t){this.ndkRelay.emit("notice",t)}handleReconnection(t=0){if(this.reconnectTimeout)return;if(this.isFlapping()){this.ndkRelay.emit("flapping",this._connectionStats),this._status=3;return}let e;if(this.wasIdle){const s=[0,1e3,2e3,5e3,1e4,3e4];e=s[Math.min(t,s.length-1)],this.debug(`Using aggressive reconnect after idle, attempt ${t}, delay ${e}ms`)}else this.connectedAt?e=Math.max(0,6e4-(Date.now()-this.connectedAt)):(e=Math.min(1e3*2**t,3e4),this.debug(`Using standard backoff, attempt ${t}, delay ${e}ms`));this.reconnectTimeout=setTimeout(()=>{this.reconnectTimeout=void 0,this._status=2,this.connect().catch(s=>{t<MAX_RECONNECT_ATTEMPTS?this.handleReconnection(t+1):(this.debug("Max reconnect attempts reached"),this.wasIdle=!1)})},e),this.ndkRelay.emit("delayed-connect",e),this.debug("Reconnecting in",e),this._connectionStats.nextReconnectAt=Date.now()+e}async send(t){Date.now()-this.lastMessageSent>12e4&&(this.wasIdle=!0),this._status>=5&&this.ws?.readyState===WebSocket.OPEN?(this.ws?.send(t),this.netDebug?.(t,this.ndkRelay,"send"),this.lastMessageSent=Date.now()):(this.debug(`Not connected to ${this.ndkRelay.url} (%d), not sending message ${t}`,this._status),this._status>=5&&this.ws?.readyState!==WebSocket.OPEN&&(this.debug(`Stale connection detected, WebSocket state: ${this.ws?.readyState}`),this.handleStaleConnection()))}async auth(t){const e=new Promise((s,n)=>{const i=this.openEventPublishes.get(t.id)??[];i.push({resolve:s,reject:n}),this.openEventPublishes.set(t.id,i)});return this.send(`["AUTH",${JSON.stringify(t.rawEvent())}]`),e}clearPendingPublishes(t){this.rejectPendingAuthPublishes(t);for(const[e,s]of this.openEventPublishes.entries()){for(;s.length>0;){const n=s.shift();n&&n.reject(t)}this.openEventPublishes.delete(e)}}retryPendingAuthPublishes(){if(this.pendingAuthPublishes.size!==0){this.debug(`Retrying ${this.pendingAuthPublishes.size} pending publishes after auth`);for(const[t,e]of this.pendingAuthPublishes.entries())this.debug(`Retrying publish for event ${t}`),this.send(`["EVENT",${JSON.stringify(e)}]`);this.pendingAuthPublishes.clear()}}rejectPendingAuthPublishes(t){if(this.pendingAuthPublishes.size!==0){this.debug(`Rejecting ${this.pendingAuthPublishes.size} pending publishes due to auth failure`);for(const[e]of this.pendingAuthPublishes.entries()){const s=this.openEventPublishes.get(e);if(s&&s.length>0){const n=s.pop();n&&n.reject(new Error(`Authentication failed: ${t.message}`)),s.length===0&&this.openEventPublishes.delete(e)}}this.pendingAuthPublishes.clear()}}async publish(t){const e=new Promise((s,n)=>{const i=this.openEventPublishes.get(t.id)??[];i.length>0&&console.warn(`Duplicate event publishing detected, you are publishing event ${t.id} twice`),i.push({resolve:s,reject:n}),this.openEventPublishes.set(t.id,i)});return this.pendingAuthPublishes.set(t.id,t),this.send(`["EVENT",${JSON.stringify(t)}]`),e}async count(t,e){this.serial++;const s=e?.id||`count:${this.serial}`,n=new Promise((i,r)=>{this.openCountRequests.set(s,{resolve:i,reject:r})});return this.send(`["COUNT","${s}",${JSON.stringify(t).substring(1)}`),n}close(t,e){this.send(`["CLOSE","${t}"]`);const s=this.openSubs.get(t);this.openSubs.delete(t),s&&s.onclose(e)}req(t){`${this.send(`["REQ","${t.subId}",${JSON.stringify(t.executeFilters).substring(1)}`)}`,this.openSubs.set(t.subId,t)}updateConnectionStats={connected:()=>{this._connectionStats.success++,this._connectionStats.connectedAt=Date.now()},disconnected:()=>{this._connectionStats.connectedAt&&(this._connectionStats.durations.push(Date.now()-this._connectionStats.connectedAt),this._connectionStats.durations.length>100&&this._connectionStats.durations.shift()),this._connectionStats.connectedAt=void 0},attempt:()=>{this._connectionStats.attempts++,this._connectionStats.connectedAt=Date.now()}};get connectionStats(){return this._connectionStats}get url(){return this.ndkRelay.url}get connected(){return this._status>=5&&this.ws?.readyState===WebSocket.OPEN}};async function fetchRelayInformation(t){const e=t.replace(/^wss:\/\//,"https://").replace(/^ws:\/\//,"http://"),s=await fetch(e,{headers:{Accept:"application/nostr+json"}});if(!s.ok)throw new Error(`Failed to fetch relay information: ${s.status} ${s.statusText}`);return await s.json()}var NDKRelayPublisher=class{ndkRelay;debug;constructor(t){this.ndkRelay=t,this.debug=t.debug.extend("publisher")}async publish(t,e=2500){let s;const n=()=>new Promise((u,h)=>{try{this.publishEvent(t).then(f=>{this.ndkRelay.emit("published",t),t.emit("relay:published",this.ndkRelay),u(!0)}).catch(h)}catch(f){h(f)}}),i=new Promise((u,h)=>{s=setTimeout(()=>{s=void 0,h(new Error(`Timeout: ${e}ms`))},e)}),r=()=>{n().then(u=>o(u)).catch(u=>a(u))};let o,a;const c=u=>{throw this.ndkRelay.debug("Publish failed",u,t.id),this.ndkRelay.emit("publish:failed",t,u),t.emit("relay:publish:failed",this.ndkRelay,u),u},l=()=>{s&&clearTimeout(s),this.ndkRelay.removeListener("connect",r)};return this.ndkRelay.status>=5?Promise.race([n(),i]).catch(c).finally(l):(this.ndkRelay.status<=1?(console.warn("Relay is disconnected, trying to connect to publish an event",this.ndkRelay.url),this.ndkRelay.connect()):console.warn("Relay not connected, waiting for connection to publish an event",this.ndkRelay.url),Promise.race([new Promise((u,h)=>{o=u,a=h,this.ndkRelay.on("connect",r)}),i]).catch(c).finally(l))}async publishEvent(t){return this.ndkRelay.connectivity.publish(t.rawEvent())}};function filterFingerprint(t,e){const s=[];for(const i of t){const r=Object.entries(i||{}).map(([o,a])=>["since","until"].includes(o)?`${o}:${a}`:o).sort().join("-");s.push(r)}let n=e?"+":"";return n+=s.join("|"),n}function mergeFilters(t){const e=[],s={};return t.filter(n=>!!n.limit).forEach(n=>e.push(n)),t=t.filter(n=>!n.limit),t.length===0?e:(t.forEach(n=>{Object.entries(n).forEach(([i,r])=>{Array.isArray(r)?s[i]===void 0?s[i]=[...r]:s[i]=Array.from(new Set([...s[i],...r])):s[i]=r})}),[...e,s])}var MAX_ITEMS=3;function formatArray(t,e){const n=(e?t.slice(0,MAX_ITEMS).map(e):t.slice(0,MAX_ITEMS)).join(",");return t.length>MAX_ITEMS?`${n}+${t.length-MAX_ITEMS}`:n}function formatFilters(t){return t.map(e=>{const s=[];e.ids?.length&&s.push(`ids:[${formatArray(e.ids,n=>String(n).slice(0,8))}]`),e.kinds?.length&&s.push(`kinds:[${formatArray(e.kinds)}]`),e.authors?.length&&s.push(`authors:[${formatArray(e.authors,n=>String(n).slice(0,8))}]`),e.since&&s.push(`since:${e.since}`),e.until&&s.push(`until:${e.until}`),e.limit&&s.push(`limit:${e.limit}`),e.search&&s.push(`search:"${String(e.search).slice(0,20)}"`);for(const[n,i]of Object.entries(e))n.startsWith("#")&&Array.isArray(i)&&i.length>0&&s.push(`${n}:[${formatArray(i,r=>String(r).slice(0,8))}]`);return`{${s.join(" ")}}`}).join(", ")}var NDKRelaySubscription=class{fingerprint;items=new Map;topSubManager;debug;status=0;onClose;relay;eosed=!1;executionTimer;fireTime;delayType;executeFilters;id=Math.random().toString(36).substring(7);constructor(t,e,s){this.relay=t,this.topSubManager=s,this.debug=t.debug.extend(`sub[${this.id}]`),this.fingerprint=e||Math.random().toString(36).substring(7)}_subId;get subId(){return this._subId?this._subId:(this._subId=this.fingerprint.slice(0,15),this._subId)}subIdParts=new Set;addSubIdPart(t){this.subIdParts.add(t)}addItem(t,e){if(this.debug("Adding item",{filters:formatFilters(e),internalId:t.internalId,status:this.status,fingerprint:this.fingerprint,id:this.subId,itemsSize:this.items.size}),!this.items.has(t.internalId))switch(t.on("close",this.removeItem.bind(this,t)),this.items.set(t.internalId,{subscription:t,filters:e}),this.status!==3&&t.subId&&(!this._subId||this._subId.length<25)&&(this.status===0||this.status===1)&&this.addSubIdPart(t.subId),this.status){case 0:this.evaluateExecutionPlan(t);break;case 3:break;case 1:this.evaluateExecutionPlan(t);break;case 4:throw this.debug("Subscription is closed, cannot add new items",{filters:formatFilters(e),subId:t.subId,internalId:t.internalId}),new Error("Cannot add new items to a closed subscription")}}removeItem(t){if(this.items.delete(t.internalId),this.items.size===0){if(!this.eosed)return;this.close(),this.cleanup()}}close(){if(this.status===4)return;const t=this.status;if(this.status=4,t===3)try{this.relay.close(this.subId)}catch(e){this.debug("Error closing subscription",e,this)}else this.debug("Subscription wanted to close but it wasn't running, this is probably ok",{subId:this.subId,prevStatus:t,sub:this});this.cleanup()}cleanup(){this.executionTimer&&clearTimeout(this.executionTimer),this.relay.off("ready",this.executeOnRelayReady),this.relay.off("authed",this.reExecuteAfterAuth),this.onClose&&this.onClose(this)}evaluateExecutionPlan(t){if(!t.isGroupable()){this.status=1,this.execute();return}if(t.filters.find(n=>!!n.limit)&&(this.executeFilters=this.compileFilters(),this.executeFilters.length>=10)){this.status=1,this.execute();return}const e=t.groupableDelay,s=t.groupableDelayType;if(!e)throw new Error("Cannot group a subscription without a delay");if(this.status===0)this.schedule(e,s);else{const n=this.delayType,i=this.fireTime-Date.now();if(n==="at-least"&&s==="at-least")i<e&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(e,s));else if(n==="at-least"&&s==="at-most")i>e&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(e,s));else if(n==="at-most"&&s==="at-most")i>e&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(e,s));else if(n==="at-most"&&s==="at-least")i>e&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(e,s));else throw new Error(`Unknown delay type combination ${n} ${s}`)}}schedule(t,e){this.status=1;const s=Date.now();this.fireTime=s+t,this.delayType=e;const n=setTimeout(this.execute.bind(this),t);e==="at-least"&&(this.executionTimer=n)}executeOnRelayReady=()=>{if(this.status===2){if(this.items.size===0){this.debug("No items to execute; this relay was probably too slow to respond and the caller gave up",{status:this.status,fingerprint:this.fingerprint,id:this.id,subId:this.subId}),this.cleanup();return}this.debug("Executing on relay ready",{status:this.status,fingerprint:this.fingerprint,itemsSize:this.items.size,filters:formatFilters(this.compileFilters())}),this.status=1,this.execute()}};finalizeSubId(){if(this.subIdParts.size>0){let e=Array.from(this.subIdParts).map(s=>s.substring(0,10)).join("-");e.length>20&&(e=e.substring(0,20)),this._subId=e}else this._subId=this.fingerprint.slice(0,15);this._subId+=`-${Math.random().toString(36).substring(2,7)}`}reExecuteAfterAuth=(()=>{const t=this.subId;this.debug("Re-executing after auth",this.items.size),this.eosed?this.relay.close(this.subId):this.debug("We are abandoning an opened subscription, once it EOSE's, the handler will close it",{oldSubId:t}),this._subId=void 0,this.status=1,this.execute(),this.debug("Re-executed after auth %s  %s",t,this.subId)}).bind(this);execute(){if(this.status===1){if(!this.relay.connected){this.status=2,this.debug("Waiting for relay to be ready",{status:this.status,id:this.subId,fingerprint:this.fingerprint,itemsSize:this.items.size}),this.relay.once("ready",this.executeOnRelayReady);return}this.relay.status<8&&this.relay.once("authed",this.reExecuteAfterAuth),this.status=3,this.finalizeSubId(),this.executeFilters=this.compileFilters(),this.relay.req(this)}}onstart(){}onevent(t){this.topSubManager.dispatchEvent(t,this.relay)}oneose(t){if(this.eosed=!0,t!==this.subId){this.debug("Received EOSE for an abandoned subscription",t,this.subId),this.relay.close(t);return}this.items.size===0&&this.close();for(const{subscription:e}of this.items.values())e.eoseReceived(this.relay),e.closeOnEose&&(this.debug("Removing item because of EOSE",{filters:formatFilters(e.filters),internalId:e.internalId,status:this.status,fingerprint:this.fingerprint,itemsSize:this.items.size}),this.removeItem(e))}onclose(t){this.status=4}onclosed(t){if(t)for(const{subscription:e}of this.items.values())e.closedReceived(this.relay,t)}compileFilters(){const t=[],e=Array.from(this.items.values()).map(n=>n.filters);if(!e[0])return this.debug(" No filters to merge",{itemsSize:this.items.size}),[];const s=e[0].length;for(let n=0;n<s;n++){const i=e.map(o=>o[n]),r=mergeFilters(i);t.push(...r)}return t}},NDKRelaySubscriptionManager=class{relay;subscriptions;generalSubManager;constructor(t,e){this.relay=t,this.subscriptions=new Map,this.generalSubManager=e}addSubscription(t,e){let s;if(!t.isGroupable())s=this.createSubscription(t,e);else{const n=filterFingerprint(e,t.closeOnEose);n&&(s=(this.subscriptions.get(n)||[]).find(r=>r.status<3)),s??=this.createSubscription(t,e,n)}s.addItem(t,e)}createSubscription(t,e,s){const n=new NDKRelaySubscription(this.relay,s||null,this.generalSubManager);n.onClose=this.onRelaySubscriptionClose.bind(this);const i=this.subscriptions.get(n.fingerprint)??[];return this.subscriptions.set(n.fingerprint,[...i,n]),n}onRelaySubscriptionClose(t){let e=this.subscriptions.get(t.fingerprint)??[];e?e.length===1?this.subscriptions.delete(t.fingerprint):(e=e.filter(s=>s.id!==t.id),this.subscriptions.set(t.fingerprint,e)):console.warn("Unexpectedly did not find a subscription with fingerprint",t.fingerprint)}},NDKRelay=class se extends lib$1.EventEmitter{url;scores;connectivity;subs;publisher;authPolicy;protocolHandlers=new Map;_relayInfo;lowestValidationRatio;targetValidationRatio;validationRatioFn;validatedEventCount=0;nonValidatedEventCount=0;trusted=!1;complaining=!1;debug;static defaultValidationRatioUpdateFn=(e,s,n)=>{if(e.lowestValidationRatio===void 0||e.targetValidationRatio===void 0)return 1;let i=e.validationRatio;if(e.validationRatio>e.targetValidationRatio){const r=s/100;i=Math.max(e.lowestValidationRatio,e.validationRatio-r)}return i<e.validationRatio?i:e.validationRatio};constructor(e,s,n){super(),this.url=normalizeRelayUrl(e),this.scores=new Map,this.debug=createDebug2(`ndk:relay:${e}`),this.connectivity=new NDKRelayConnectivity(this,n),this.connectivity.netDebug=n?.netDebug,this.req=this.connectivity.req.bind(this.connectivity),this.close=this.connectivity.close.bind(this.connectivity),this.subs=new NDKRelaySubscriptionManager(this,n.subManager),this.publisher=new NDKRelayPublisher(this),this.authPolicy=s,this.targetValidationRatio=n?.initialValidationRatio,this.lowestValidationRatio=n?.lowestValidationRatio,this.validationRatioFn=(n?.validationRatioFn??se.defaultValidationRatioUpdateFn).bind(this),this.updateValidationRatio(),n||console.trace("relay created without ndk")}updateValidationRatio(){if(this.validationRatioFn&&this.validatedEventCount>0){const e=this.validationRatioFn(this,this.validatedEventCount,this.nonValidatedEventCount);this.targetValidationRatio=e}setTimeout(()=>{this.updateValidationRatio()},3e4)}get status(){return this.connectivity.status}get connectionStats(){return this.connectivity.connectionStats}async connect(e,s=!0){return this.connectivity.connect(e,s)}disconnect(){this.status!==1&&this.connectivity.disconnect()}subscribe(e,s){this.subs.addSubscription(e,s)}async publish(e,s=2500){return this.publisher.publish(e,s)}referenceTags(){return[["r",this.url]]}addValidatedEvent(){this.validatedEventCount++}addNonValidatedEvent(){this.nonValidatedEventCount++}get validationRatio(){return this.nonValidatedEventCount===0?1:this.validatedEventCount/(this.validatedEventCount+this.nonValidatedEventCount)}shouldValidateEvent(){return this.trusted?!1:this.targetValidationRatio===void 0||this.targetValidationRatio>=1?!0:Math.random()<this.targetValidationRatio}get connected(){return this.connectivity.connected}req;close;registerProtocolHandler(e,s){this.protocolHandlers.set(e,s)}unregisterProtocolHandler(e){this.protocolHandlers.delete(e)}getProtocolHandler(e){return this.protocolHandlers.get(e)}async fetchInfo(e=!1){const n=this.connectivity.ndk;if(!e&&n?.cacheAdapter?.getRelayStatus){const i=await n.cacheAdapter.getRelayStatus(this.url);if(i?.nip11&&Date.now()-i.nip11.fetchedAt<864e5)return this._relayInfo=i.nip11.data,i.nip11.data}return!e&&this._relayInfo?this._relayInfo:(this._relayInfo=await fetchRelayInformation(this.url),n?.cacheAdapter?.updateRelayStatus&&await n.cacheAdapter.updateRelayStatus(this.url,{nip11:{data:this._relayInfo,fetchedAt:Date.now()}}),this._relayInfo)}get info(){return this._relayInfo}},NDKPublishError=class extends Error{errors;publishedToRelays;intendedRelaySet;constructor(t,e,s,n){super(t),this.errors=e,this.publishedToRelays=s,this.intendedRelaySet=n}get relayErrors(){const t=[];for(const[e,s]of this.errors)t.push(`${e.url}: ${s}`);return t.join(`
`)}},NDKRelaySet=class ne{relays;debug;ndk;pool;constructor(e,s,n){this.relays=e,this.ndk=s,this.pool=n??s.pool,this.debug=s.debug.extend("relayset")}addRelay(e){this.relays.add(e)}get relayUrls(){return Array.from(this.relays).map(e=>e.url)}static fromRelayUrls(e,s,n=!0,i){if(i=i??s.pool,!i)throw new Error("No pool provided");const r=new Set;for(const o of e){const a=i.relays.get(normalizeRelayUrl(o));if(a)a.status<5&&n&&a.connect(),r.add(a);else{const c=new NDKRelay(normalizeRelayUrl(o),s?.relayAuthDefaultPolicy,s);i.useTemporaryRelay(c,void 0,`requested from fromRelayUrls ${e}`),r.add(c)}}return new ne(new Set(r),s,i)}async publish(e,s,n=1){const i=new Set,r=new Map,o=e.isEphemeral();e.publishStatus="pending";const a=c=>{i.add(c)};e.on("relay:published",a);try{const c=Array.from(this.relays).map(l=>new Promise(u=>{const h=s?setTimeout(()=>{i.has(l)||(r.set(l,new Error(`Publish timeout after ${s}ms`)),u(!1))},s):null;l.publish(e,s).then(f=>{h&&clearTimeout(h),f?(i.add(l),u(!0)):u(!1)}).catch(f=>{h&&clearTimeout(h),o||r.set(l,f),u(!1)})}));if(await Promise.all(c),i.size<n){if(!o){const l=new NDKPublishError("Not enough relays received the event ("+i.size+" published, "+n+" required)",r,i,this);throw e.publishStatus="error",e.publishError=l,this.ndk?.emit("event:publish-failed",e,l,this.relayUrls),l}}else e.publishStatus="success",e.emit("published",{relaySet:this,publishedToRelays:i});return i}finally{e.off("relay:published",a)}}get size(){return this.relays.size}},d=createDebug2("ndk:outbox:calculate");async function calculateRelaySetFromEvent(t,e,s){const n=new Set,i=await getWriteRelaysFor(t,e.pubkey);i&&i.forEach(a=>{const c=t.pool?.getRelay(a);c&&n.add(c)});let r=e.tags.filter(a=>["a","e"].includes(a[0])).map(a=>a[2]).filter(a=>a?.startsWith("wss://")).filter(a=>{try{return new URL(a),!0}catch{return!1}}).map(a=>normalizeRelayUrl(a));r=Array.from(new Set(r)).slice(0,5),r.forEach(a=>{const c=t.pool?.getRelay(a,!0,!0);c&&(d("Adding relay hint %s",a),n.add(c))});const o=e.getMatchingTags("p").map(a=>a[1]);return o.length<5?Array.from(chooseRelayCombinationForPubkeys(t,o,"read",{preferredRelays:new Set(i)}).keys()).forEach(c=>{const l=t.pool?.getRelay(c,!1,!0);l&&(d("Adding p-tagged relay %s",c),n.add(l))}):d("Too many p-tags to consider %d",o.length),t.pool?.permanentAndConnectedRelays().forEach(a=>n.add(a)),s&&n.size<s&&t.explicitRelayUrls?.filter(c=>!Array.from(n).some(l=>l.url===c)).slice(0,s-n.size)?.forEach(c=>{const l=t.pool?.getRelay(c,!1,!0);l&&(d("Adding explicit relay %s",c),n.add(l))}),new NDKRelaySet(n,t)}function calculateRelaySetsFromFilter(t,e,s,n){const i=new Map,r=new Set;if(e.forEach(o=>{o.authors&&o.authors.forEach(a=>r.add(a))}),r.size>0){const o=getRelaysForFilterWithAuthors(t,Array.from(r),n);for(const a of o.keys())i.set(a,[]);for(const a of e)if(a.authors)for(const[c,l]of o.entries()){const u=a.authors.filter(h=>l.includes(h));i.set(c,[...i.get(c),{...a,authors:u}])}else for(const c of o.keys())i.set(c,[...i.get(c),a])}else t.explicitRelayUrls&&t.explicitRelayUrls.forEach(o=>{i.set(o,e)});return i.size===0&&s.permanentAndConnectedRelays().slice(0,5).forEach(o=>{i.set(o.url,e)}),i}function calculateRelaySetsFromFilters(t,e,s,n){return calculateRelaySetsFromFilter(t,e,s,n)}function isValidHex64(t){if(typeof t!="string"||t.length!==64)return!1;for(let e=0;e<64;e++){const s=t.charCodeAt(e);if(!(s>=48&&s<=57||s>=97&&s<=102||s>=65&&s<=70))return!1}return!0}function isValidPubkey(t){return isValidHex64(t)}function isValidNip05(t){if(typeof t!="string")return!1;for(let e=0;e<t.length;e++)if(t.charCodeAt(e)===46)return!0;return!1}function mergeTags(t,e){const s=new Map,n=o=>o.join(","),i=(o,a)=>o.every((c,l)=>c===a[l]),r=o=>{for(const[a,c]of s)if(i(c,o)||i(o,c)){o.length>=c.length&&s.set(a,o);return}s.set(n(o),o)};return t.concat(e).forEach(r),Array.from(s.values())}var hashtagRegex=/(?<=\s|^)(#[^\s!@#$%^&*()=+./,[{\]};:'"?><]+)/g;function generateHashtags(t){const e=t.match(hashtagRegex),s=new Set,n=new Set;if(e)for(const i of e)s.has(i.slice(1))||(n.add(i.slice(1)),s.add(i.slice(1)));return Array.from(n)}async function generateContentTags(t,e=[],s,n){if(s?.skipContentTagging)return{content:t,tags:e};const i=/(@|nostr:)(npub|nprofile|note|nevent|naddr)[a-zA-Z0-9]+/g,r=[],o=a=>{e.find(c=>["q",a[0]].includes(c[0])&&c[1]===a[1])||e.push(a)};if(t=t.replace(i,a=>{try{const c=a.split(/(@|nostr:)/)[2],{type:l,data:u}=nip19_exports$1.decode(c);let h;if(s?.filters){const f=!s.filters.includeTypes||s.filters.includeTypes.includes(l),p=s.filters.excludeTypes?.includes(l);if(!f||p)return a}switch(l){case"npub":s?.pTags!==!1&&(h=["p",u]);break;case"nprofile":s?.pTags!==!1&&(h=["p",u.pubkey]);break;case"note":r.push(new Promise(async f=>{const p=await maybeGetEventRelayUrl(c);o(["q",u,p]),f()}));break;case"nevent":r.push(new Promise(async f=>{const{id:p,author:v}=u;let{relays:k}=u;(!k||k.length===0)&&(k=[await maybeGetEventRelayUrl(c)]),o(["q",p,k[0]]),v&&s?.pTags!==!1&&s?.pTagOnQTags!==!1&&o(["p",v]),f()}));break;case"naddr":r.push(new Promise(async f=>{const p=[u.kind,u.pubkey,u.identifier].join(":");let v=u.relays??[];v.length===0&&(v=[await maybeGetEventRelayUrl(c)]),o(["q",p,v[0]]),s?.pTags!==!1&&s?.pTagOnQTags!==!1&&s?.pTagOnATags!==!1&&o(["p",u.pubkey]),f()}));break;default:return a}return h&&o(h),`nostr:${c}`}catch{return a}}),await Promise.all(r),!s?.filters?.excludeTypes?.includes("hashtag")){const a=generateHashtags(t).map(c=>["t",c]);e=mergeTags(e,a)}if(s?.pTags!==!1&&s?.copyPTagsFromTarget&&n){const a=n.getMatchingTags("p");for(const c of a)!c[1]||!isValidPubkey(c[1])||e.find(l=>l[0]==="p"&&l[1]===c[1])||e.push(c)}return{content:t,tags:e}}async function maybeGetEventRelayUrl(t){return""}async function encrypt(t,e,s="nip44"){let n;if(!this.ndk)throw new Error("No NDK instance found!");let i=e;if(i||(this.ndk.assertSigner(),i=this.ndk.signer),!i)throw new Error("no NDK signer");const r=t||(()=>{const o=this.getMatchingTags("p");if(o.length!==1)throw new Error("No recipient could be determined and no explicit recipient was provided");return this.ndk.getUser({pubkey:o[0][1]})})();if(s==="nip44"&&await isEncryptionEnabled(i,"nip44")&&(n=await i.encrypt(r,this.content,"nip44")),(!n||s==="nip04")&&await isEncryptionEnabled(i,"nip04")&&(n=await i.encrypt(r,this.content,"nip04")),!n)throw new Error("Failed to encrypt event.");this.content=n}async function decrypt(t,e,s){if(this.ndk?.cacheAdapter?.getDecryptedEvent){const a=await this.ndk.cacheAdapter.getDecryptedEvent(this.id);if(a){this.content=a.content;return}}let n;if(!this.ndk)throw new Error("No NDK instance found!");let i=e;if(i||(this.ndk.assertSigner(),i=this.ndk.signer),!i)throw new Error("no NDK signer");const r=t||this.author;if(!r)throw new Error("No sender provided and no author available");const o=s||(this.content.match(/\\?iv=/)?"nip04":"nip44");if((o==="nip04"||this.kind===4)&&await isEncryptionEnabled(i,"nip04")&&this.content.search("\\?iv=")&&(n=await i.decrypt(r,this.content,"nip04")),!n&&o==="nip44"&&await isEncryptionEnabled(i,"nip44")&&(n=await i.decrypt(r,this.content,"nip44")),!n)throw new Error("Failed to decrypt event.");this.content=n,this.ndk?.cacheAdapter?.addDecryptedEvent&&this.ndk.cacheAdapter.addDecryptedEvent(this.id,this)}async function isEncryptionEnabled(t,e){return t.encryptionEnabled?e?!!await t.encryptionEnabled(e):!0:!1}function eventHasETagMarkers(t){for(const e of t.tags)if(e[0]==="e"&&(e[3]??"").length>0)return!0;return!1}function getRootTag(t,e){e??=t.tagType();const s=t.tags.find(isTagRootTag);if(!s){if(eventHasETagMarkers(t))return;const n=t.getMatchingTags(e);if(n.length<3)return n[0]}return s}var nip22RootTags=new Set(["A","E","I"]),nip22ReplyTags=new Set(["a","e","i"]);function getReplyTag(t,e){if(t.kind===1111){let i;for(const r of t.tags)if(nip22RootTags.has(r[0]))i=r;else if(nip22ReplyTags.has(r[0])){i=r;break}return i}e??=t.tagType();let s=!1,n;for(const i of t.tags)if(i[0]===e){if((i[3]??"").length>0&&(s=!0),s&&i[3]==="reply")return i;s&&i[3]==="root"&&(n=i),s||(n=i)}return n}function isTagRootTag(t){return t[0]==="E"||t[3]==="root"}async function fetchTaggedEvent(t,e){if(!this.ndk)throw new Error("NDK instance not found");const s=this.getMatchingTags(t,e);if(s.length===0)return;const[n,i,r]=s[0],o=r!==""?this.ndk.pool.getRelay(r):void 0;return await this.ndk.fetchEvent(i,{},o)}async function fetchRootEvent(t){if(!this.ndk)throw new Error("NDK instance not found");const e=getRootTag(this);if(e)return this.ndk.fetchEventFromTag(e,this,t)}async function fetchReplyEvent(t){if(!this.ndk)throw new Error("NDK instance not found");const e=getReplyTag(this);if(e)return this.ndk.fetchEventFromTag(e,this,t)}function isReplaceable(){if(this.kind===void 0)throw new Error("Kind not set");return[0,3].includes(this.kind)||this.kind>=1e4&&this.kind<2e4||this.kind>=3e4&&this.kind<4e4}function isEphemeral(){if(this.kind===void 0)throw new Error("Kind not set");return this.kind>=2e4&&this.kind<3e4}function isParamReplaceable(){if(this.kind===void 0)throw new Error("Kind not set");return this.kind>=3e4&&this.kind<4e4}var DEFAULT_RELAY_COUNT=2;function encode(t=DEFAULT_RELAY_COUNT){let e=[];return this.onRelays.length>0?e=this.onRelays.map(s=>s.url):this.relay&&(e=[this.relay.url]),e.length>t&&(e=e.slice(0,t)),this.isParamReplaceable()?nip19_exports$1.naddrEncode({kind:this.kind,pubkey:this.pubkey,identifier:this.replaceableDTag(),relays:e}):e.length>0?nip19_exports$1.neventEncode({id:this.tagId(),relays:e,author:this.pubkey}):nip19_exports$1.noteEncode(this.tagId())}async function repost(t=!0,e){if(!e&&t){if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner(),e=this.ndk.signer}const s=new NDKEvent(this.ndk,{kind:getKind(this)});return this.isProtected||(s.content=JSON.stringify(this.rawEvent())),s.tag(this),this.kind!==1&&s.tags.push(["k",`${this.kind}`]),e&&await s.sign(e),t&&await s.publish(),s}function getKind(t){return t.kind===1?6:16}function getEventDetails(t){return"inspect"in t&&typeof t.inspect=="string"?t.inspect:JSON.stringify(t)}function validateForSerialization(t){if(typeof t.kind!="number")throw new Error(`Can't serialize event with invalid properties: kind (must be number, got ${typeof t.kind}). Event: ${getEventDetails(t)}`);if(typeof t.content!="string")throw new Error(`Can't serialize event with invalid properties: content (must be string, got ${typeof t.content}). Event: ${getEventDetails(t)}`);if(typeof t.created_at!="number")throw new Error(`Can't serialize event with invalid properties: created_at (must be number, got ${typeof t.created_at}). Event: ${getEventDetails(t)}`);if(typeof t.pubkey!="string")throw new Error(`Can't serialize event with invalid properties: pubkey (must be string, got ${typeof t.pubkey}). Event: ${getEventDetails(t)}`);if(!Array.isArray(t.tags))throw new Error(`Can't serialize event with invalid properties: tags (must be array, got ${typeof t.tags}). Event: ${getEventDetails(t)}`);for(let e=0;e<t.tags.length;e++){const s=t.tags[e];if(!Array.isArray(s))throw new Error(`Can't serialize event with invalid properties: tags[${e}] (must be array, got ${typeof s}). Event: ${getEventDetails(t)}`);for(let n=0;n<s.length;n++)if(typeof s[n]!="string")throw new Error(`Can't serialize event with invalid properties: tags[${e}][${n}] (must be string, got ${typeof s[n]}). Event: ${getEventDetails(t)}`)}}function serialize(t=!1,e=!1){validateForSerialization(this);const s=[0,this.pubkey,this.created_at,this.kind,this.tags,this.content];return t&&s.push(this.sig),e&&s.push(this.id),JSON.stringify(s)}function deserialize(t){const e=JSON.parse(t),s={pubkey:e[1],created_at:e[2],kind:e[3],tags:e[4],content:e[5]};if(e.length>=7){const n=e[6],i=e[7];n&&n.length===128?(s.sig=n,i&&i.length===64&&(s.id=i)):n&&n.length===64&&(s.id=n,i&&i.length===128&&(s.sig=i))}return s}var worker,processingQueue={};function signatureVerificationInit(t){worker=t,worker.onmessage=e=>{if(!Array.isArray(e.data)||e.data.length!==2){console.error("[NDK]  Signature verification worker received incompatible message format.",`

 Expected format: [eventId, boolean]`,`
 Received:`,e.data,`

 This likely means:`,`
  1. You have a STALE worker.js file that needs updating`,`
  2. Version mismatch between @nostr-dev-kit/ndk and deployed worker`,`
  3. Wrong worker is being used for signature verification`,`

 Solution: Update your worker files:`,`
  cp node_modules/@nostr-dev-kit/ndk/dist/workers/sig-verification.js public/`,`
  cp node_modules/@nostr-dev-kit/cache-sqlite-wasm/dist/worker.js public/`,`

 Or use Vite/bundler imports instead of static files:`,`
  import SigWorker from "@nostr-dev-kit/ndk/workers/sig-verification?worker"`);return}const[s,n]=e.data,i=processingQueue[s];if(!i){console.error("No record found for event",s);return}delete processingQueue[s];for(const r of i.resolves)r(n)}}async function verifySignatureAsync(t,e,s){const n=t.ndk,i=Date.now();let r;return n.signatureVerificationFunction?r=await n.signatureVerificationFunction(t):r=await new Promise(o=>{const a=t.serialize();let c=!1;processingQueue[t.id]||(processingQueue[t.id]={event:t,resolves:[],relay:s},c=!0),processingQueue[t.id].resolves.push(o),c&&worker?.postMessage({serialized:a,id:t.id,sig:t.sig,pubkey:t.pubkey})}),n.signatureVerificationTimeMs+=Date.now()-i,r}var PUBKEY_REGEX=/^[a-f0-9]{64}$/;function validate(){if(typeof this.kind!="number"||typeof this.content!="string"||typeof this.created_at!="number"||typeof this.pubkey!="string"||!this.pubkey.match(PUBKEY_REGEX)||!Array.isArray(this.tags))return!1;for(let t=0;t<this.tags.length;t++){const e=this.tags[t];if(!Array.isArray(e))return!1;for(let s=0;s<e.length;s++)if(typeof e[s]=="object")return!1}return!0}var verifiedSignatures=new dist.LRUCache({maxSize:1e3,entryExpirationTimeInMS:6e4});function verifySignature(t){if(typeof this.signatureVerified=="boolean")return this.signatureVerified;const e=verifiedSignatures.get(this.id);if(e!==null)return this.signatureVerified=!!e,this.signatureVerified;try{if(this.ndk?.asyncSigVerification){const s=this.relay;verifySignatureAsync(this,t,s).then(n=>{t&&(this.signatureVerified=n,n&&verifiedSignatures.set(this.id,this.sig)),n?s&&s.addValidatedEvent():(s?this.ndk?.reportInvalidSignature(this,s):this.ndk?.reportInvalidSignature(this),verifiedSignatures.set(this.id,!1))}).catch(n=>{console.error("signature verification error",this.id,n)})}else{const s=sha256(new TextEncoder().encode(this.serialize())),n=schnorr.verify(this.sig,s,this.pubkey);return n?verifiedSignatures.set(this.id,this.sig):verifiedSignatures.set(this.id,!1),this.signatureVerified=n,n}}catch{return this.signatureVerified=!1,!1}}function getEventHash(){return getEventHashFromSerializedEvent(this.serialize())}function getEventHashFromSerializedEvent(t){const e=sha256(new TextEncoder().encode(t));return bytesToHex(e)}var skipClientTagOnKinds=new Set([0,4,1059,13,3,9734,5]),NDKEvent=class W extends lib$1.EventEmitter{ndk;created_at;content="";tags=[];kind;id="";sig;pubkey="";signatureVerified;_author=void 0;relay;get onRelays(){let e=[];return this.ndk?e=this.ndk.subManager.seenEvents.get(this.id)||[]:this.relay&&e.push(this.relay),e}publishStatus="success";publishError;constructor(e,s){super(),this.ndk=e,this.created_at=s?.created_at,this.content=s?.content||"",this.tags=s?.tags||[],this.id=s?.id||"",this.sig=s?.sig,this.pubkey=s?.pubkey||"",this.kind=s?.kind,s instanceof W&&(this.relay&&(this.relay=s.relay,this.ndk?.subManager.seenEvent(s.id,this.relay)),this.publishStatus=s.publishStatus,this.publishError=s.publishError)}static deserialize(e,s){return new W(e,deserialize(s))}rawEvent(){return{created_at:this.created_at,content:this.content,tags:this.tags,kind:this.kind,pubkey:this.pubkey,id:this.id,sig:this.sig}}set author(e){this.pubkey=e.pubkey,this._author=e,this._author.ndk??=this.ndk}get author(){if(this._author)return this._author;if(!this.ndk)throw new Error("No NDK instance found");const e=this.ndk.getUser({pubkey:this.pubkey});return this._author=e,e}tagExternal(e,s,n){const i=["i"],r=["k"];switch(s){case"url":{const o=new URL(e);o.hash="",i.push(o.toString()),r.push(`${o.protocol}//${o.host}`);break}case"hashtag":i.push(`#${e.toLowerCase()}`),r.push("#");break;case"geohash":i.push(`geo:${e.toLowerCase()}`),r.push("geo");break;case"isbn":i.push(`isbn:${e.replace(/-/g,"")}`),r.push("isbn");break;case"podcast:guid":i.push(`podcast:guid:${e}`),r.push("podcast:guid");break;case"podcast:item:guid":i.push(`podcast:item:guid:${e}`),r.push("podcast:item:guid");break;case"podcast:publisher:guid":i.push(`podcast:publisher:guid:${e}`),r.push("podcast:publisher:guid");break;case"isan":i.push(`isan:${e.split("-").slice(0,4).join("-")}`),r.push("isan");break;case"doi":i.push(`doi:${e.toLowerCase()}`),r.push("doi");break;default:throw new Error(`Unsupported NIP-73 entity type: ${s}`)}n&&i.push(n),this.tags.push(i),this.tags.push(r)}tag(e,s,n,i,r){let o=[];if(e.fetchProfile!==void 0){if(i??="p",i==="p"&&r?.pTags===!1)return;const c=[i,e.pubkey];s&&c.push("",s),o.push(c)}else if(e instanceof W){const c=e;if(n??=c?.pubkey===this.pubkey,o=c.referenceTags(s,n,i,r),r?.pTags!==!1)for(const l of c.getMatchingTags("p"))!l[1]||!isValidPubkey(l[1])||l[1]!==this.pubkey&&(this.tags.find(u=>u[0]==="p"&&u[1]===l[1])||this.tags.push(["p",l[1]]))}else if(Array.isArray(e))o=[e];else throw new Error("Invalid argument",e);this.tags=mergeTags(this.tags,o)}async toNostrEvent(e,s){if(!e&&this.pubkey===""){const r=await this.ndk?.signer?.user();this.pubkey=r?.pubkey||""}this.created_at||(this.created_at=Math.floor(Date.now()/1e3));const{content:n,tags:i}=await this.generateTags(s);this.content=n||"",this.tags=i;try{this.id=this.getEventHash()}catch{}return this.rawEvent()}serialize=serialize.bind(this);getEventHash=getEventHash.bind(this);validate=validate.bind(this);verifySignature=verifySignature.bind(this);isReplaceable=isReplaceable.bind(this);isEphemeral=isEphemeral.bind(this);isDvm=()=>this.kind&&this.kind>=5e3&&this.kind<=7e3;isParamReplaceable=isParamReplaceable.bind(this);encode=encode.bind(this);encrypt=encrypt.bind(this);decrypt=decrypt.bind(this);getMatchingTags(e,s){const n=this.tags.filter(i=>i[0]===e);return s===void 0?n:n.filter(i=>i[3]===s)}hasTag(e,s){return this.tags.some(n=>n[0]===e&&(!s||n[3]===s))}tagValue(e,s){const n=this.getMatchingTags(e,s);if(n.length!==0)return n[0][1]}get alt(){return this.tagValue("alt")}set alt(e){this.removeTag("alt"),e&&this.tags.push(["alt",e])}get dTag(){return this.tagValue("d")}set dTag(e){this.removeTag("d"),e&&this.tags.push(["d",e])}removeTag(e,s){const n=Array.isArray(e)?e:[e];this.tags=this.tags.filter(i=>{const r=n.includes(i[0]),o=s?i[3]===s:!0;return!(r&&o)})}replaceTag(e){this.removeTag(e[0]),this.tags.push(e)}async sign(e,s){this.ndk?.aiGuardrails?.event?.signing(this),e?this.author=await e.user():(this.ndk?.assertSigner(),e=this.ndk?.signer);const n=await this.toNostrEvent(void 0,s);return this.sig=await e.sign(n),this.sig}async publishReplaceable(e,s,n){return this.id="",this.created_at=Math.floor(Date.now()/1e3),this.sig="",this.publish(e,s,n)}async publish(e,s,n,i){if(n||(n=1),this.sig||await this.sign(void 0,i),!this.ndk)throw new Error("NDKEvent must be associated with an NDK instance to publish");if(this.ndk.aiGuardrails?.event?.publishing(this),(!e||e.size===0)&&(e=this.ndk.devWriteRelaySet||await calculateRelaySetFromEvent(this.ndk,this,n)),this.kind===5&&this.ndk.cacheAdapter?.deleteEventIds){const a=this.getMatchingTags("e").map(c=>c[1]);this.ndk.cacheAdapter.deleteEventIds(a)}const r=this.rawEvent();if(this.ndk.cacheAdapter?.addUnpublishedEvent&&shouldTrackUnpublishedEvent(this))try{this.ndk.cacheAdapter.addUnpublishedEvent(this,e.relayUrls)}catch(a){console.error("Error adding unpublished event to cache",a)}this.kind===5&&this.ndk.cacheAdapter?.deleteEventIds&&this.ndk.cacheAdapter.deleteEventIds(this.getMatchingTags("e").map(a=>a[1])),this.ndk.subManager.dispatchEvent(r,void 0,!0);const o=await e.publish(this,s,n);return o.forEach(a=>this.ndk?.subManager.seenEvent(this.id,a)),o}async generateTags(e){let s=[];const n=await generateContentTags(this.content,this.tags,e,this),i=n.content;if(s=n.tags,this.kind&&this.isParamReplaceable()&&!this.getMatchingTags("d")[0]){const o=this.tagValue("title");let c=[...Array(o?6:16)].map(()=>Math.random().toString(36)[2]).join("");o&&o.length>0&&(c=`${o.replace(/[^a-z0-9]+/gi,"-").replace(/^-|-$/g,"")}-${c}`),s.push(["d",c])}if(this.shouldAddClientTag){const r=["client",this.ndk?.clientName??""];this.ndk?.clientNip89&&r.push(this.ndk?.clientNip89),s.push(r)}else this.shouldStripClientTag&&(s=s.filter(r=>r[0]!=="client"));return{content:i||"",tags:s}}get shouldAddClientTag(){return!(!this.ndk?.clientName&&!this.ndk?.clientNip89||skipClientTagOnKinds.has(this.kind)||this.isEphemeral()||this.isReplaceable()&&!this.isParamReplaceable()||this.isDvm()||this.hasTag("client"))}get shouldStripClientTag(){return skipClientTagOnKinds.has(this.kind)}muted(){return this.ndk?.muteFilter&&this.ndk.muteFilter(this)?"muted":null}replaceableDTag(){if(this.kind&&this.kind>=3e4&&this.kind<=4e4){const e=this.getMatchingTags("d")[0];return e?e[1]:""}throw new Error("Event is not a parameterized replaceable event")}deduplicationKey(){return this.kind===0||this.kind===3||this.kind&&this.kind>=1e4&&this.kind<2e4?`${this.kind}:${this.pubkey}`:this.tagId()}tagId(){return this.isParamReplaceable()?this.tagAddress():this.id}tagAddress(){if(this.isParamReplaceable()){const e=this.dTag??"";return`${this.kind}:${this.pubkey}:${e}`}if(this.isReplaceable())return`${this.kind}:${this.pubkey}:`;throw new Error("Event is not a replaceable event")}tagType(){return this.isParamReplaceable()?"a":"e"}tagReference(e){let s;return this.isParamReplaceable()?s=["a",this.tagAddress()]:s=["e",this.tagId()],this.relay?s.push(this.relay.url):s.push(""),s.push(e??""),this.isParamReplaceable()||s.push(this.pubkey),s}referenceTags(e,s,n,i){let r=[];return this.isParamReplaceable()?r=[[n??"a",this.tagAddress()],[n??"e",this.id]]:r=[[n??"e",this.id]],r=r.map(o=>(o[0]==="e"||e?o.push(this.relay?.url??""):this.relay?.url&&o.push(this.relay?.url),o)),r.forEach(o=>{o[0]==="e"?(o.push(e??""),o.push(this.pubkey)):e&&o.push(e)}),r=[...r,...this.getMatchingTags("h")],!s&&i?.pTags!==!1&&r.push(...this.author.referenceTags()),r}filter(){return this.isParamReplaceable()?{"#a":[this.tagId()]}:{"#e":[this.tagId()]}}nip22Filter(){return this.isParamReplaceable()?{"#A":[this.tagId()]}:{"#E":[this.tagId()]}}async delete(e,s=!0){if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner();const n=new W(this.ndk,{kind:5,content:e||""});return n.tag(this,void 0,!0),n.tags.push(["k",this.kind?.toString()]),s&&(this.emit("deleted"),await n.publish()),n}set isProtected(e){this.removeTag("-"),e&&this.tags.push(["-"])}get isProtected(){return this.hasTag("-")}fetchTaggedEvent=fetchTaggedEvent.bind(this);fetchRootEvent=fetchRootEvent.bind(this);fetchReplyEvent=fetchReplyEvent.bind(this);repost=repost.bind(this);async react(e,s=!0){if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner();const n=new W(this.ndk,{kind:7,content:e});return n.tag(this),this.kind!==1&&n.tags.push(["k",`${this.kind}`]),s&&await n.publish(),n}get isValid(){return this.validate()}get inspect(){return JSON.stringify(this.rawEvent(),null,4)}dump(){console.debug(JSON.stringify(this.rawEvent(),null,4)),console.debug("Event on relays:",this.onRelays.map(e=>e.url).join(", "))}reply(e,s){const n=new W(this.ndk);if(this.ndk?.aiGuardrails?.event?.creatingReply(n),this.kind===1&&!e)n.kind=1,this.hasTag("e")?n.tags=[...n.tags,...this.getMatchingTags("e"),...this.getMatchingTags("p"),...this.getMatchingTags("a"),...this.referenceTags("reply",!1,void 0,s)]:n.tag(this,"root",!1,void 0,s);else{n.kind=1111;const i=["A","E","I","P"],r=this.tags.filter(o=>i.includes(o[0]));if(r.length>0){const o=this.tagValue("K");n.tags.push(...r),o&&n.tags.push(["K",o]);let a;if(this.isParamReplaceable()){a=["a",this.tagAddress()];const c=this.relay?.url??"";c&&a.push(c)}else{a=["e",this.tagId()];const c=this.relay?.url??"";a.push(c),a.push(this.pubkey)}n.tags.push(a)}else{let o,a;const c=this.relay?.url??"";this.isParamReplaceable()?(o=["a",this.tagAddress(),c],a=["A",this.tagAddress(),c]):(o=["e",this.tagId(),c,this.pubkey],a=["E",this.tagId(),c,this.pubkey]),n.tags.push(o),n.tags.push(a),n.tags.push(["K",this.kind?.toString()]),s?.pTags!==!1&&s?.pTagOnATags!==!1&&n.tags.push(["P",this.pubkey])}n.tags.push(["k",this.kind?.toString()]),s?.pTags!==!1&&(n.tags.push(...this.getMatchingTags("p")),n.tags.push(["p",this.pubkey]))}return n}},untrackedUnpublishedEvents=new Set([24133,13194,23194,23195]);function shouldTrackUnpublishedEvent(t){return!untrackedUnpublishedEvents.has(t.kind)}var NDKPool=class extends lib$1.EventEmitter{_relays=new Map;status="idle";autoConnectRelays=new Set;debug;temporaryRelayTimers=new Map;flappingRelays=new Set;backoffTimes=new Map;ndk;disconnectionTimes=new Map;systemEventDetector;constructor(t,e,{debug:s,name:n}={}){super(),this.debug=s??e.debug.extend("pool"),n&&(this._name=n),this.ndk=e,this.relayUrls=t,this.ndk.pools&&this.ndk.pools.push(this)}get relays(){return this._relays}set relayUrls(t){this._relays.clear();for(const e of t){const s=new NDKRelay(e,void 0,this.ndk);s.connectivity.netDebug=this.ndk.netDebug,this.addRelay(s)}}_name="unnamed";get name(){return this._name}set name(t){this._name=t,this.debug=this.debug.extend(t)}useTemporaryRelay(t,e=3e4,s){const n=this.relays.has(t.url);n||(this.addRelay(t),this.debug("Adding temporary relay %s for filters %o",t.url,s));const i=this.temporaryRelayTimers.get(t.url);if(i&&clearTimeout(i),!n||i){const r=setTimeout(()=>{this.ndk.explicitRelayUrls?.includes(t.url)||this.removeRelay(t.url)},e);this.temporaryRelayTimers.set(t.url,r)}}addRelay(t,e=!0){const s=this.relays.has(t.url),n=t.url.includes("/npub1");let i=!0;const r=t.url;if(s)return;if(this.ndk.relayConnectionFilter&&!this.ndk.relayConnectionFilter(r)){this.debug(`Refusing to add relay ${r}: blocked by relayConnectionFilter`);return}if(n){this.debug(`Refusing to add relay ${r}: is a filter relay`);return}if(this.ndk.cacheAdapter?.getRelayStatus){const p=this.ndk.cacheAdapter.getRelayStatus(r),v=p instanceof Promise?void 0:p;if(v?.dontConnectBefore){if(v.dontConnectBefore>Date.now()){const k=v.dontConnectBefore-Date.now();this.debug(`Refusing to add relay ${r}: delayed connect for ${k}ms`),setTimeout(()=>{this.addRelay(t,e)},k);return}i=!1}}const o=p=>this.emit("notice",t,p),a=()=>this.handleRelayConnect(r),c=()=>this.handleRelayReady(t),l=()=>{this.recordDisconnection(t),this.emit("relay:disconnect",t)},u=()=>this.handleFlapping(t),h=p=>this.emit("relay:auth",t,p),f=()=>this.emit("relay:authed",t);t.off("notice",o),t.off("connect",a),t.off("ready",c),t.off("disconnect",l),t.off("flapping",u),t.off("auth",h),t.off("authed",f),t.on("notice",o),t.on("connect",a),t.on("ready",c),t.on("disconnect",l),t.on("flapping",u),t.on("auth",h),t.on("authed",f),t.on("delayed-connect",p=>{this.ndk.cacheAdapter?.updateRelayStatus&&this.ndk.cacheAdapter.updateRelayStatus(t.url,{dontConnectBefore:Date.now()+p})}),this._relays.set(r,t),e&&this.autoConnectRelays.add(r),e&&this.status==="active"&&(this.emit("relay:connecting",t),t.connect(void 0,i).catch(p=>{this.debug(`Failed to connect to relay ${r}`,p)}))}removeRelay(t){const e=this.relays.get(t);if(e)return e.disconnect(),this.relays.delete(t),this.autoConnectRelays.delete(t),this.emit("relay:disconnect",e),!0;const s=this.temporaryRelayTimers.get(t);return s&&(clearTimeout(s),this.temporaryRelayTimers.delete(t)),!1}isRelayConnected(t){const e=normalizeRelayUrl(t),s=this.relays.get(e);return s?s.status===5:!1}getRelay(t,e=!0,s=!1,n){let i=this.relays.get(normalizeRelayUrl(t));return i||(i=new NDKRelay(t,void 0,this.ndk),i.connectivity.netDebug=this.ndk.netDebug,s?this.useTemporaryRelay(i,3e4,n):this.addRelay(i,e)),i}handleRelayConnect(t){const e=this.relays.get(t);if(!e){console.error("NDK BUG: relay not found in pool",{relayUrl:t});return}this.emit("relay:connect",e),this.stats().connected===this.relays.size&&this.emit("connect")}handleRelayReady(t){this.emit("relay:ready",t)}async connect(t){this.status="active",this.debug(`Connecting to ${this.relays.size} relays${t?`, timeout ${t}ms`:""}...`);const e=Array.from(this.autoConnectRelays.keys()).map(r=>this.relays.get(r)).filter(r=>!!r);for(const r of e)r.status!==5&&r.status!==4&&(this.emit("relay:connecting",r),r.connect().catch(o=>{this.debug(`Failed to connect to relay ${r.url}: ${o??"No reason specified"}`)}));const s=()=>e.every(r=>r.status===5),n=new Promise(r=>{if(s()){r();return}const o=[];for(const a of e){const c=()=>{if(s()){for(let l=0;l<e.length;l++)e[l].off("connect",o[l]);r()}};o.push(c),a.on("connect",c)}}),i=typeof t=="number"?new Promise(r=>setTimeout(r,t)):new Promise(()=>{});await Promise.race([n,i])}checkOnFlappingRelays(){const t=this.flappingRelays.size,e=this.relays.size;if(t/e>=.8)for(const s of this.flappingRelays)this.backoffTimes.set(s,0)}recordDisconnection(t){const e=Date.now();this.disconnectionTimes.set(t.url,e);for(const[s,n]of this.disconnectionTimes.entries())e-n>1e4&&this.disconnectionTimes.delete(s);this.checkForSystemWideDisconnection()}checkForSystemWideDisconnection(){const t=Date.now(),e=[];for(const s of this.disconnectionTimes.values())t-s<5e3&&e.push(s);e.length>this.relays.size/2&&this.relays.size>1&&(this.debug(`System-wide disconnection detected: ${e.length}/${this.relays.size} relays disconnected`),this.handleSystemWideReconnection())}handleSystemWideReconnection(){if(this.systemEventDetector){this.debug("System-wide reconnection already in progress, skipping");return}this.debug("Initiating system-wide reconnection with reset backoff"),this.systemEventDetector=setTimeout(()=>{this.systemEventDetector=void 0},1e4);for(const t of this.relays.values())t.connectivity&&(t.connectivity.resetReconnectionState(),t.status!==5&&t.status!==4&&t.connect().catch(e=>{this.debug(`Failed to reconnect relay ${t.url} after system event: ${e}`)}));this.disconnectionTimes.clear()}handleFlapping(t){this.debug(`Relay ${t.url} is flapping`);let e=this.backoffTimes.get(t.url)||5e3;e=e*2,this.backoffTimes.set(t.url,e),this.debug(`Backoff time for ${t.url} is ${e}ms`),setTimeout(()=>{this.debug(`Attempting to reconnect to ${t.url}`),this.emit("relay:connecting",t),t.connect(),this.checkOnFlappingRelays()},e),t.disconnect(),this.emit("flapping",t)}size(){return this.relays.size}stats(){const t={total:0,connected:0,disconnected:0,connecting:0};for(const e of this.relays.values())t.total++,e.status===5?t.connected++:e.status===1?t.disconnected++:e.status===4&&t.connecting++;return t}connectedRelays(){return Array.from(this.relays.values()).filter(t=>t.status>=5)}permanentAndConnectedRelays(){return Array.from(this.relays.values()).filter(t=>t.status>=5&&!this.temporaryRelayTimers.has(t.url))}urls(){return Array.from(this.relays.keys())}},NDKDVMJobFeedback=class ie extends NDKEvent{static kinds=[7e3];constructor(e,s){super(e,s),this.kind??=7e3}static async from(e){const s=new ie(e.ndk,e.rawEvent());return s.encrypted&&await s.dvmDecrypt(),s}get status(){return this.tagValue("status")}set status(e){this.removeTag("status"),e!==void 0&&this.tags.push(["status",e])}get encrypted(){return!!this.getMatchingTags("encrypted")[0]}async dvmDecrypt(){await this.decrypt();const e=JSON.parse(this.content);this.tags.push(...e)}},NDKCashuMintList=class re extends NDKEvent{static kind=10019;static kinds=[10019];_p2pk;constructor(e,s){super(e,s),this.kind??=10019}static from(e){return new re(e.ndk,e)}set relays(e){this.tags=this.tags.filter(s=>s[0]!=="relay");for(const s of e)this.tags.push(["relay",s])}get relays(){const e=[];for(const s of this.tags)s[0]==="relay"&&e.push(s[1]);return e}set mints(e){this.tags=this.tags.filter(s=>s[0]!=="mint");for(const s of e)this.tags.push(["mint",s])}get mints(){const e=[];for(const s of this.tags)s[0]==="mint"&&e.push(s[1]);return Array.from(new Set(e))}get p2pk(){return this._p2pk?this._p2pk:(this._p2pk=this.tagValue("pubkey")??this.pubkey,this._p2pk)}set p2pk(e){this._p2pk=e,this.removeTag("pubkey"),e&&this.tags.push(["pubkey",e])}get relaySet(){return NDKRelaySet.fromRelayUrls(this.relays,this.ndk)}},NDKArticle=class oe extends NDKEvent{static kind=30023;static kinds=[30023];constructor(e,s){super(e,s),this.kind??=30023}static from(e){return new oe(e.ndk,e)}get title(){return this.tagValue("title")}set title(e){this.removeTag("title"),e&&this.tags.push(["title",e])}get image(){return this.tagValue("image")}set image(e){this.removeTag("image"),e&&this.tags.push(["image",e])}get summary(){return this.tagValue("summary")}set summary(e){this.removeTag("summary"),e&&this.tags.push(["summary",e])}get published_at(){const e=this.tagValue("published_at");if(e){let s=Number.parseInt(e);return s>1e12&&(s=Math.floor(s/1e3)),s}}set published_at(e){this.removeTag("published_at"),e!==void 0&&this.tags.push(["published_at",e.toString()])}async generateTags(){return super.generateTags(),this.published_at||(this.published_at=this.created_at),super.generateTags()}get url(){return this.tagValue("url")}set url(e){e?this.tags.push(["url",e]):this.removeTag("url")}},NDKBlossomList=class ae extends NDKEvent{static kinds=[10063];constructor(e,s){super(e,s),this.kind??=10063}static from(e){return new ae(e.ndk,e.rawEvent())}get servers(){return this.tags.filter(e=>e[0]==="server").map(e=>e[1])}set servers(e){this.tags=this.tags.filter(s=>s[0]!=="server");for(const s of e)this.tags.push(["server",s])}get default(){const e=this.servers;return e.length>0?e[0]:void 0}set default(e){if(!e)return;const n=this.servers.filter(i=>i!==e);this.servers=[e,...n]}addServer(e){if(!e)return;const s=this.servers;s.includes(e)||(this.servers=[...s,e])}removeServer(e){if(!e)return;const s=this.servers;this.servers=s.filter(n=>n!==e)}},NDKFedimintMint=class ce extends NDKEvent{static kind=38173;static kinds=[38173];constructor(e,s){super(e,s),this.kind??=38173}static async from(e){return new ce(e.ndk,e)}get identifier(){return this.tagValue("d")}set identifier(e){this.removeTag("d"),e&&this.tags.push(["d",e])}get inviteCodes(){return this.getMatchingTags("u").map(e=>e[1])}set inviteCodes(e){this.removeTag("u");for(const s of e)this.tags.push(["u",s])}get modules(){return this.getMatchingTags("modules").map(e=>e[1])}set modules(e){this.removeTag("modules");for(const s of e)this.tags.push(["modules",s])}get network(){return this.tagValue("n")}set network(e){this.removeTag("n"),e&&this.tags.push(["n",e])}get metadata(){if(this.content)try{return JSON.parse(this.content)}catch{return}}set metadata(e){e?this.content=JSON.stringify(e):this.content=""}},NDKCashuMintAnnouncement=class le extends NDKEvent{static kind=38172;static kinds=[38172];constructor(e,s){super(e,s),this.kind??=38172}static async from(e){return new le(e.ndk,e)}get identifier(){return this.tagValue("d")}set identifier(e){this.removeTag("d"),e&&this.tags.push(["d",e])}get url(){return this.tagValue("u")}set url(e){this.removeTag("u"),e&&this.tags.push(["u",e])}get nuts(){return this.getMatchingTags("nuts").map(e=>e[1])}set nuts(e){this.removeTag("nuts");for(const s of e)this.tags.push(["nuts",s])}get network(){return this.tagValue("n")}set network(e){this.removeTag("n"),e&&this.tags.push(["n",e])}get metadata(){if(this.content)try{return JSON.parse(this.content)}catch{return}}set metadata(e){e?this.content=JSON.stringify(e):this.content=""}},NDKMintRecommendation=class ue extends NDKEvent{static kind=38e3;static kinds=[38e3];constructor(e,s){super(e,s),this.kind??=38e3}static async from(e){return new ue(e.ndk,e)}get recommendedKind(){const e=this.tagValue("k");return e?Number(e):void 0}set recommendedKind(e){this.removeTag("k"),e&&this.tags.push(["k",e.toString()])}get identifier(){return this.tagValue("d")}set identifier(e){this.removeTag("d"),e&&this.tags.push(["d",e])}get urls(){return this.getMatchingTags("u").map(e=>e[1])}set urls(e){this.removeTag("u");for(const s of e)this.tags.push(["u",s])}get mintEventPointers(){return this.getMatchingTags("a").map(e=>({kind:Number(e[1].split(":")[0]),identifier:e[1].split(":")[2],relay:e[2]}))}addMintEventPointer(e,s,n,i){const r=["a",`${e}:${s}:${n}`];i&&r.push(i),this.tags.push(r)}get review(){return this.content}set review(e){this.content=e}},NDKClassified=class he extends NDKEvent{static kinds=[30402];constructor(e,s){super(e,s),this.kind??=30402}static from(e){return new he(e.ndk,e)}get title(){return this.tagValue("title")}set title(e){this.removeTag("title"),e&&this.tags.push(["title",e])}get summary(){return this.tagValue("summary")}set summary(e){this.removeTag("summary"),e&&this.tags.push(["summary",e])}get published_at(){const e=this.tagValue("published_at");if(e)return Number.parseInt(e)}set published_at(e){this.removeTag("published_at"),e!==void 0&&this.tags.push(["published_at",e.toString()])}get location(){return this.tagValue("location")}set location(e){this.removeTag("location"),e&&this.tags.push(["location",e])}get price(){const e=this.tags.find(s=>s[0]==="price");if(e)return{amount:Number.parseFloat(e[1]),currency:e[2],frequency:e[3]}}set price(e){if(typeof e=="string"&&(e={amount:Number.parseFloat(e)}),e?.amount){const s=["price",e.amount.toString()];e.currency&&s.push(e.currency),e.frequency&&s.push(e.frequency),this.tags.push(s)}else this.removeTag("price")}async generateTags(){return super.generateTags(),this.published_at||(this.published_at=this.created_at),super.generateTags()}},NDKDraft=class de extends NDKEvent{_event;static kind=31234;static kinds=[31234,1234];counterparty;constructor(e,s){super(e,s),this.kind??=31234}static from(e){return new de(e.ndk,e)}set identifier(e){this.removeTag("d"),this.tags.push(["d",e])}get identifier(){return this.dTag}set event(e){e instanceof NDKEvent?this._event=e:this._event=new NDKEvent(void 0,e),this.prepareEvent()}set checkpoint(e){e?(this.tags.push(e.tagReference()),this.kind=1234):(this.removeTag("a"),this.kind=31234)}get isCheckpoint(){return this.kind===1234}get isProposal(){const e=this.tagValue("p");return!!e&&e!==this.pubkey}async getEvent(e){if(this._event)return this._event;if(e??=this.ndk?.signer,!e)throw new Error("No signer available");if(this.content&&this.content.length>0)try{const s=e.pubkey,i=[this.tagValue("p"),this.pubkey].filter(Boolean).find(a=>a!==s);let r;r=new NDKUser({pubkey:i??s}),await this.decrypt(r,e);const o=JSON.parse(this.content);return this._event=await wrapEvent(new NDKEvent(this.ndk,o)),this._event}catch(s){console.error(s);return}else return null}prepareEvent(){if(!this._event)throw new Error("No event has been provided");this.removeTag("k"),this._event.kind&&this.tags.push(["k",this._event.kind.toString()]),this.content=JSON.stringify(this._event.rawEvent())}async save({signer:e,publish:s,relaySet:n}){if(e??=this.ndk?.signer,!e)throw new Error("No signer available");const i=this.counterparty||await e.user();if(await this.encrypt(i,e),this.counterparty){const r=this.counterparty.pubkey;this.removeTag("p"),this.tags.push(["p",r])}if(s!==!1)return this.publishReplaceable(n)}};function mapImetaTag(t){const e={};if(t.length===2){const n=t[1].split(" ");for(let i=0;i<n.length;i+=2){const r=n[i],o=n[i+1];r==="fallback"?(e.fallback||(e.fallback=[]),e.fallback.push(o)):e[r]=o}return e}const s=t.slice(1);for(const n of s){const i=n.split(" "),r=i[0],o=i.slice(1).join(" ");r==="fallback"?(e.fallback||(e.fallback=[]),e.fallback.push(o)):e[r]=o}return e}function imetaTagToTag(t){const e=["imeta"];for(const[s,n]of Object.entries(t))if(Array.isArray(n))for(const i of n)e.push(`${s} ${i}`);else n&&e.push(`${s} ${n}`);return e}var NDKFollowPack=class fe extends NDKEvent{static kind=39089;static kinds=[39089,39092];constructor(e,s){super(e,s),this.kind??=39089}static from(e){return new fe(e.ndk,e)}get title(){return this.tagValue("title")}set title(e){this.removeTag("title"),e&&this.tags.push(["title",e])}get image(){const e=this.tags.find(s=>s[0]==="imeta");if(e){const s=mapImetaTag(e);if(s.url)return s.url}return this.tagValue("image")}set image(e){this.tags=this.tags.filter(s=>s[0]!=="imeta"&&s[0]!=="image"),typeof e=="string"?e!==void 0&&this.tags.push(["image",e]):e&&typeof e=="object"&&(this.tags.push(imetaTagToTag(e)),e.url&&this.tags.push(["image",e.url]))}get pubkeys(){return Array.from(new Set(this.tags.filter(e=>e[0]==="p"&&e[1]&&isValidPubkey(e[1])).map(e=>e[1])))}set pubkeys(e){this.tags=this.tags.filter(s=>s[0]!=="p");for(const s of e)this.tags.push(["p",s])}get description(){return this.tagValue("description")}set description(e){this.removeTag("description"),e&&this.tags.push(["description",e])}},NDKHighlight=class pe extends NDKEvent{_article;static kind=9802;static kinds=[9802];constructor(e,s){super(e,s),this.kind??=9802}static from(e){return new pe(e.ndk,e)}get url(){return this.tagValue("r")}set context(e){e===void 0?this.tags=this.tags.filter(([s,n])=>s!=="context"):(this.tags=this.tags.filter(([s,n])=>s!=="context"),this.tags.push(["context",e]))}get context(){return this.tags.find(([e,s])=>e==="context")?.[1]??void 0}get article(){return this._article}set article(e){this._article=e,typeof e=="string"?this.tags.push(["r",e]):this.tag(e)}getArticleTag(){return this.getMatchingTags("a")[0]||this.getMatchingTags("e")[0]||this.getMatchingTags("r")[0]}async getArticle(){if(this._article!==void 0)return this._article;let e;const s=this.getArticleTag();if(s){switch(s[0]){case"a":{const[n,i,r]=s[1].split(":");e=nip19_exports$1.naddrEncode({kind:Number.parseInt(n),pubkey:i,identifier:r});break}case"e":e=nip19_exports$1.noteEncode(s[1]);break;case"r":this._article=s[1];break}if(e){let n=await this.ndk?.fetchEvent(e);n&&(n.kind===30023&&(n=NDKArticle.from(n)),this._article=n)}return this._article}}},NDKImage=class ge extends NDKEvent{static kind=20;static kinds=[20];_imetas;constructor(e,s){super(e,s),this.kind??=20}static from(e){return new ge(e.ndk,e.rawEvent())}get isValid(){return this.imetas.length>0}get imetas(){return this._imetas?this._imetas:(this._imetas=this.tags.filter(e=>e[0]==="imeta").map(mapImetaTag).filter(e=>!!e.url),this._imetas)}set imetas(e){this._imetas=e,this.tags=this.tags.filter(s=>s[0]!=="imeta"),this.tags.push(...e.map(imetaTagToTag))}},NDKList=class ye extends NDKEvent{_encryptedTags;static kinds=[30001,10004,10050,10030,10015,10001,10002,10007,10006,10003];encryptedTagsLength;constructor(e,s){super(e,s),this.kind??=30001}static from(e){return new ye(e.ndk,e)}get title(){const e=this.tagValue("title")||this.tagValue("name");return e||(this.kind===3?"Contacts":this.kind===1e4?"Mute":this.kind===10001?"Pinned Notes":this.kind===10002?"Relay Metadata":this.kind===10003?"Bookmarks":this.kind===10004?"Communities":this.kind===10005?"Public Chats":this.kind===10006?"Blocked Relays":this.kind===10007?"Search Relays":this.kind===10050?"Direct Message Receive Relays":this.kind===10015?"Interests":this.kind===10030?"Emojis":this.tagValue("d"))}set title(e){this.removeTag(["title","name"]),e&&this.tags.push(["title",e])}get name(){return this.title}set name(e){this.title=e}get description(){return this.tagValue("description")}set description(e){this.removeTag("description"),e&&this.tags.push(["description",e])}get image(){return this.tagValue("image")}set image(e){this.removeTag("image"),e&&this.tags.push(["image",e])}isEncryptedTagsCacheValid(){return!!(this._encryptedTags&&this.encryptedTagsLength===this.content.length)}async encryptedTags(e=!0){if(e&&this.isEncryptedTagsCacheValid())return this._encryptedTags;if(!this.ndk)throw new Error("NDK instance not set");if(!this.ndk.signer)throw new Error("NDK signer not set");const s=await this.ndk.signer.user();try{if(this.content.length>0)try{const n=await this.ndk.signer.decrypt(s,this.content),i=JSON.parse(n);return i?.[0]?(this.encryptedTagsLength=this.content.length,this._encryptedTags=i):(this.encryptedTagsLength=this.content.length,this._encryptedTags=[])}catch{}}catch{}return[]}validateTag(e){return!0}getItems(e){return this.tags.filter(s=>s[0]===e)}get items(){return this.tags.filter(e=>!["d","L","l","title","name","description","published_at","summary","image","thumb","alt","expiration","subject","client"].includes(e[0]))}async addItem(e,s=void 0,n=!1,i="bottom"){if(!this.ndk)throw new Error("NDK instance not set");if(!this.ndk.signer)throw new Error("NDK signer not set");let r;if(e instanceof NDKEvent)r=[e.tagReference(s)];else if(e instanceof NDKUser)r=e.referenceTags();else if(e instanceof NDKRelay)r=e.referenceTags();else if(Array.isArray(e))r=[e];else throw new Error("Invalid object type");if(s&&r[0].push(s),n){const o=await this.ndk.signer.user(),a=await this.encryptedTags();i==="top"?a.unshift(...r):a.push(...r),this._encryptedTags=a,this.encryptedTagsLength=this.content.length,this.content=JSON.stringify(a),await this.encrypt(o)}else i==="top"?this.tags.unshift(...r):this.tags.push(...r);this.created_at=Math.floor(Date.now()/1e3),this.emit("change")}async removeItemByValue(e,s=!0){if(!this.ndk)throw new Error("NDK instance not set");if(!this.ndk.signer)throw new Error("NDK signer not set");const n=this.tags.findIndex(a=>a[1]===e);n>=0&&this.tags.splice(n,1);const i=await this.ndk.signer.user(),r=await this.encryptedTags(),o=r.findIndex(a=>a[1]===e);if(o>=0&&(r.splice(o,1),this._encryptedTags=r,this.encryptedTagsLength=this.content.length,this.content=JSON.stringify(r),await this.encrypt(i)),s)return this.publishReplaceable();this.created_at=Math.floor(Date.now()/1e3),this.emit("change")}async removeItem(e,s){if(!this.ndk)throw new Error("NDK instance not set");if(!this.ndk.signer)throw new Error("NDK signer not set");if(s){const n=await this.ndk.signer.user(),i=await this.encryptedTags();i.splice(e,1),this._encryptedTags=i,this.encryptedTagsLength=this.content.length,this.content=JSON.stringify(i),await this.encrypt(n)}else this.tags.splice(e,1);return this.created_at=Math.floor(Date.now()/1e3),this.emit("change"),this}has(e){return this.items.some(s=>s[1]===e)}filterForItems(){const e=new Set,s=new Map,n=[];for(const i of this.items)if(i[0]==="e"&&i[1])e.add(i[1]);else if(i[0]==="a"&&i[1]){const[r,o,a]=i[1].split(":");if(!r||!o)continue;const c=`${r}:${o}`,l=s.get(c)||[];l.push(a||""),s.set(c,l)}if(e.size>0&&n.push({ids:Array.from(e)}),s.size>0)for(const[i,r]of s.entries()){const[o,a]=i.split(":");n.push({kinds:[Number.parseInt(o)],authors:[a],"#d":r})}return n}},NDKAppHandlerEvent=class me extends NDKEvent{profile;static kinds=[31990];constructor(e,s){super(e,s),this.kind??=31990}static from(e){const s=new me(e.ndk,e.rawEvent());return s.isValid?s:null}get isValid(){const e=new Map,s=i=>[i[0],i[2]].join(":").toLowerCase(),n=["web","android","ios"];for(const i of this.tags)if(n.includes(i[0])){const r=s(i);if(e.has(r)&&e.get(r)!==i[1].toLowerCase())return!1;e.set(r,i[1].toLowerCase())}return!0}async fetchProfile(){if(this.profile===void 0&&this.content.length>0)try{const e=JSON.parse(this.content);if(e?.name)return e;this.profile=null}catch{this.profile=null}return new Promise((e,s)=>{const n=this.author;n.fetchProfile().then(()=>{e(n.profile)}).catch(s)})}},NDKNutzap=class X extends NDKEvent{debug;_proofs=[];static kind=9321;static kinds=[X.kind];constructor(e,s){super(e,s),this.kind??=9321,this.debug=e?.debug.extend("nutzap")??createDebug2("ndk:nutzap"),this.alt||(this.alt="This is a nutzap");try{const n=this.getMatchingTags("proof");n.length?this._proofs=n.map(i=>JSON.parse(i[1])):this._proofs=JSON.parse(this.content)}catch{return}}static from(e){const s=new X(e.ndk,e);if(!(!s._proofs||!s._proofs.length))return s}set comment(e){this.content=e??""}get comment(){const e=this.tagValue("comment");return e||this.content}set proofs(e){this._proofs=e,this.tags=this.tags.filter(s=>s[0]!=="proof");for(const s of e)this.tags.push(["proof",JSON.stringify(s)])}get proofs(){return this._proofs}get rawP2pk(){const e=this.proofs[0];try{const s=JSON.parse(e.secret);let n;if(typeof s=="string"?(n=JSON.parse(s),this.debug("stringified payload",e.secret)):typeof s=="object"&&(n=s),Array.isArray(n)&&n[0]==="P2PK"&&n.length>1&&typeof n[1]=="object"&&n[1]!==null||typeof n=="object"&&n!==null&&typeof n[1]?.data=="string")return n[1].data}catch(s){this.debug("error parsing p2pk pubkey",s,this.proofs[0])}}get p2pk(){const e=this.rawP2pk;if(e)return e.startsWith("02")?e.slice(2):e}get mint(){return this.tagValue("u")}set mint(e){this.replaceTag(["u",e])}get unit(){let e=this.tagValue("unit")??"sat";return e?.startsWith("msat")&&(e="sat"),e}set unit(e){if(this.removeTag("unit"),e?.startsWith("msat"))throw new Error("msat is not allowed, use sat denomination instead");e&&this.tag(["unit",e])}get amount(){return this.proofs.reduce((s,n)=>s+n.amount,0)}sender=this.author;set target(e){this.tags=this.tags.filter(s=>s[0]!=="p"),e instanceof NDKEvent&&this.tags.push(e.tagReference())}set recipientPubkey(e){this.removeTag("p"),this.tag(["p",e])}get recipientPubkey(){return this.tagValue("p")}get recipient(){const e=this.recipientPubkey;return this.ndk?this.ndk.getUser({pubkey:e}):new NDKUser({pubkey:e})}async toNostrEvent(){this.unit==="msat"&&(this.unit="sat"),this.removeTag("amount"),this.tags.push(["amount",this.amount.toString()]);const e=await super.toNostrEvent();return e.content=this.comment,e}get isValid(){let e=0,s=0,n=0;for(const i of this.tags)i[0]==="e"&&e++,i[0]==="p"&&s++,i[0]==="u"&&n++;return s===1&&n===1&&e<=1&&this.proofs.length>0}},NDKProject=class be extends NDKEvent{static kind=31933;static kinds=[31933];_signer;constructor(e,s){super(e,s),this.kind=31933}static from(e){return new be(e.ndk,e.rawEvent())}set repo(e){this.removeTag("repo"),e&&this.tags.push(["repo",e])}set hashtags(e){this.removeTag("hashtags"),e.filter(s=>s.length>0).length&&this.tags.push(["hashtags",...e])}get hashtags(){const e=this.tags.find(s=>s[0]==="hashtags");return e?e.slice(1):[]}get repo(){return this.tagValue("repo")}get title(){return this.tagValue("title")}set title(e){this.removeTag("title"),e&&this.tags.push(["title",e])}get picture(){return this.tagValue("picture")}set picture(e){this.removeTag("picture"),e&&this.tags.push(["picture",e])}set description(e){this.content=e}get description(){return this.content}get slug(){return this.dTag??"empty-dtag"}async getSigner(){if(this._signer)return this._signer;const e=this.tagValue("key");if(!e)this._signer=NDKPrivateKeySigner.generate(),await this.encryptAndSaveNsec();else{const s=await this.ndk?.signer?.decrypt(this.ndk.activeUser,e);if(!s)throw new Error("Failed to decrypt project key or missing signer context.");this._signer=new NDKPrivateKeySigner(s)}return this._signer}async getNsec(){return(await this.getSigner()).privateKey}async setNsec(e){this._signer=new NDKPrivateKeySigner(e),await this.encryptAndSaveNsec()}async encryptAndSaveNsec(){if(!this._signer)throw new Error("Signer is not set.");const e=this._signer.privateKey,s=await this.ndk?.signer?.encrypt(this.ndk.activeUser,e);s&&(this.removeTag("key"),this.tags.push(["key",s]))}},NDKProjectTemplate=class we extends NDKEvent{static kind=30717;static kinds=[30717];constructor(e,s){super(e,s),this.kind=30717}static from(e){return new we(e.ndk,e.rawEvent())}get templateId(){return this.dTag??""}set templateId(e){this.dTag=e}get name(){return this.tagValue("title")??""}set name(e){this.removeTag("title"),e&&this.tags.push(["title",e])}get description(){return this.tagValue("description")??""}set description(e){this.removeTag("description"),e&&this.tags.push(["description",e])}get repoUrl(){return this.tagValue("uri")??""}set repoUrl(e){this.removeTag("uri"),e&&this.tags.push(["uri",e])}get image(){return this.tagValue("image")}set image(e){this.removeTag("image"),e&&this.tags.push(["image",e])}get command(){return this.tagValue("command")}set command(e){this.removeTag("command"),e&&this.tags.push(["command",e])}get agentConfig(){const e=this.tagValue("agent");if(e)try{return JSON.parse(e)}catch{return}}set agentConfig(e){this.removeTag("agent"),e&&this.tags.push(["agent",JSON.stringify(e)])}get templateTags(){return this.getMatchingTags("t").map(e=>e[1]).filter(Boolean)}set templateTags(e){this.tags=this.tags.filter(s=>s[0]!=="t"),e.forEach(s=>{s&&this.tags.push(["t",s])})}},READ_MARKER="read",WRITE_MARKER="write",NDKRelayList=class ve extends NDKEvent{static kinds=[10002];constructor(e,s){super(e,s),this.kind??=10002}static from(e){return new ve(e.ndk,e.rawEvent())}get readRelayUrls(){return this.tags.filter(e=>e[0]==="r"||e[0]==="relay").filter(e=>!e[2]||e[2]&&e[2]===READ_MARKER).map(e=>tryNormalizeRelayUrl(e[1])).filter(e=>!!e)}set readRelayUrls(e){for(const s of e)this.tags.push(["r",s,READ_MARKER])}get writeRelayUrls(){return this.tags.filter(e=>e[0]==="r"||e[0]==="relay").filter(e=>!e[2]||e[2]&&e[2]===WRITE_MARKER).map(e=>tryNormalizeRelayUrl(e[1])).filter(e=>!!e)}set writeRelayUrls(e){for(const s of e)this.tags.push(["r",s,WRITE_MARKER])}get bothRelayUrls(){return this.tags.filter(e=>e[0]==="r"||e[0]==="relay").filter(e=>!e[2]).map(e=>e[1])}set bothRelayUrls(e){for(const s of e)this.tags.push(["r",s])}get relays(){return this.tags.filter(e=>e[0]==="r"||e[0]==="relay").map(e=>e[1])}get relaySet(){if(!this.ndk)throw new Error("NDKRelayList has no NDK instance");return new NDKRelaySet(new Set(this.relays.map(e=>this.ndk?.pool.getRelay(e)).filter(e=>!!e)),this.ndk)}};function relayListFromKind3(t,e){try{const s=JSON.parse(e.content),n=new NDKRelayList(t),i=new Set,r=new Set;for(let[o,a]of Object.entries(s)){try{o=normalizeRelayUrl(o)}catch{continue}if(!a)i.add(o),r.add(o);else{const c=a;c.write&&r.add(o),c.read&&i.add(o)}}return n.readRelayUrls=Array.from(i),n.writeRelayUrls=Array.from(r),n}catch{}}var NDKRepost=class Ee extends NDKEvent{_repostedEvents;static kinds=[6,16];static from(e){return new Ee(e.ndk,e.rawEvent())}async repostedEvents(e,s){const n=[];if(!this.ndk)throw new Error("NDK instance not set");if(this._repostedEvents!==void 0)return this._repostedEvents;for(const i of this.repostedEventIds()){const r=filterForId(i),o=await this.ndk.fetchEvent(r,s);o&&n.push(e?e.from(o):o)}return n}repostedEventIds(){return this.tags.filter(e=>e[0]==="e"||e[0]==="a").map(e=>e[1])}};function filterForId(t){if(t.match(/:/)){const[e,s,n]=t.split(":");return{kinds:[Number.parseInt(e)],authors:[s],"#d":[n]}}return{ids:[t]}}var NDKSimpleGroupMemberList=class ke extends NDKEvent{relaySet;memberSet=new Set;static kind=39002;static kinds=[39002];constructor(e,s){super(e,s),this.kind??=39002,this.memberSet=new Set(this.members)}static from(e){return new ke(e.ndk,e)}get members(){return this.getMatchingTags("p").map(e=>e[1])}hasMember(e){return this.memberSet.has(e)}async publish(e,s,n){return e??=this.relaySet,super.publishReplaceable(e,s,n)}},NDKSimpleGroupMetadata=class _e extends NDKEvent{static kind=39e3;static kinds=[39e3];constructor(e,s){super(e,s),this.kind??=39e3}static from(e){return new _e(e.ndk,e)}get name(){return this.tagValue("name")}get picture(){return this.tagValue("picture")}get about(){return this.tagValue("about")}get scope(){if(this.getMatchingTags("public").length>0)return"public";if(this.getMatchingTags("public").length>0)return"private"}set scope(e){this.removeTag("public"),this.removeTag("private"),e==="public"?this.tags.push(["public",""]):e==="private"&&this.tags.push(["private",""])}get access(){if(this.getMatchingTags("open").length>0)return"open";if(this.getMatchingTags("closed").length>0)return"closed"}set access(e){this.removeTag("open"),this.removeTag("closed"),e==="open"?this.tags.push(["open",""]):e==="closed"&&this.tags.push(["closed",""])}};function strToPosition(t){const[e,s]=t.split(",").map(Number);return{x:e,y:s}}function strToDimension(t){const[e,s]=t.split("x").map(Number);return{width:e,height:s}}var NDKStorySticker=class Te{static Text="text";static Pubkey="pubkey";static Event="event";static Prompt="prompt";static Countdown="countdown";type;value;position;dimension;properties;constructor(e){if(Array.isArray(e)){const s=e;if(s[0]!=="sticker"||s.length<5)throw new Error("Invalid sticker tag");this.type=s[1],this.value=s[2],this.position=strToPosition(s[3]),this.dimension=strToDimension(s[4]);const n={};for(let i=5;i<s.length;i++){const[r,...o]=s[i].split(" ");n[r]=o.join(" ")}Object.keys(n).length>0&&(this.properties=n)}else this.type=e,this.value=void 0,this.position={x:0,y:0},this.dimension={width:0,height:0}}static fromTag(e){try{return new Te(e)}catch{return null}}get style(){return this.properties?.style}set style(e){e?this.properties={...this.properties,style:e}:delete this.properties?.style}get rotation(){return this.properties?.rot?Number.parseFloat(this.properties.rot):void 0}set rotation(e){e!==void 0?this.properties={...this.properties,rot:e.toString()}:delete this.properties?.rot}get isValid(){return this.hasValidDimensions()&&this.hasValidPosition()}hasValidDimensions=()=>typeof this.dimension.width=="number"&&typeof this.dimension.height=="number"&&!Number.isNaN(this.dimension.width)&&!Number.isNaN(this.dimension.height);hasValidPosition=()=>typeof this.position.x=="number"&&typeof this.position.y=="number"&&!Number.isNaN(this.position.x)&&!Number.isNaN(this.position.y);toTag(){if(!this.isValid){const n=[this.hasValidDimensions()?void 0:"dimensions is invalid",this.hasValidPosition()?void 0:"position is invalid"].filter(Boolean);throw new Error(`Invalid sticker: ${n.join(", ")}`)}let e;switch(this.type){case"event":e=this.value.tagId();break;case"pubkey":e=this.value.pubkey;break;default:e=this.value}const s=["sticker",this.type,e,coordinates(this.position),dimension(this.dimension)];if(this.properties)for(const[n,i]of Object.entries(this.properties))s.push(`${n} ${i}`);return s}},NDKStory=class Re extends NDKEvent{static kind=23;static kinds=[23];_imeta;_dimensions;constructor(e,s){if(super(e,s),this.kind??=23,s)for(const n of s.tags)switch(n[0]){case"imeta":this._imeta=mapImetaTag(n);break;case"dim":this.dimensions=strToDimension(n[1]);break}}static from(e){return new Re(e.ndk,e)}get isValid(){return!!this.imeta}get imeta(){return this._imeta}set imeta(e){this._imeta=e,this.tags=this.tags.filter(s=>s[0]!=="imeta"),e&&this.tags.push(imetaTagToTag(e))}get dimensions(){const e=this.tagValue("dim");if(e)return strToDimension(e)}set dimensions(e){this.removeTag("dim"),e&&this.tags.push(["dim",`${e.width}x${e.height}`])}get duration(){const e=this.tagValue("dur");if(e)return Number.parseInt(e)}set duration(e){this.removeTag("dur"),e!==void 0&&this.tags.push(["dur",e.toString()])}get stickers(){const e=[];for(const s of this.tags){if(s[0]!=="sticker"||s.length<5)continue;const n=NDKStorySticker.fromTag(s);n&&e.push(n)}return e}addSticker(e){let s;if(e instanceof NDKStorySticker)s=e;else{const n=["sticker",e.type,typeof e.value=="string"?e.value:"",coordinates(e.position),dimension(e.dimension)];if(e.properties)for(const[i,r]of Object.entries(e.properties))n.push(`${i} ${r}`);s=new NDKStorySticker(n),s.value=e.value}s.type==="pubkey"?this.tag(s.value):s.type==="event"&&this.tag(s.value),this.tags.push(s.toTag())}removeSticker(e){const s=this.stickers;if(e<0||e>=s.length)return;let n=0;for(let i=0;i<this.tags.length;i++)if(this.tags[i][0]==="sticker"){if(n===e){this.tags.splice(i,1);break}n++}}},coordinates=t=>`${t.x},${t.y}`,dimension=t=>`${t.width}x${t.height}`,NDKSubscriptionReceipt=class Se extends NDKEvent{debug;static kinds=[7003];constructor(e,s){super(e,s),this.kind??=7003,this.debug=e?.debug.extend("subscription-start")??createDebug2("ndk:subscription-start")}static from(e){return new Se(e.ndk,e.rawEvent())}get recipient(){const e=this.getMatchingTags("p")?.[0];return e?new NDKUser({pubkey:e[1]}):void 0}set recipient(e){this.removeTag("p"),e&&this.tags.push(["p",e.pubkey])}get subscriber(){const e=this.getMatchingTags("P")?.[0];return e?new NDKUser({pubkey:e[1]}):void 0}set subscriber(e){this.removeTag("P"),e&&this.tags.push(["P",e.pubkey])}set subscriptionStart(e){this.debug(`before setting subscription start: ${this.rawEvent}`),this.removeTag("e"),this.tag(e,"subscription",!0),this.debug(`after setting subscription start: ${this.rawEvent}`)}get tierName(){return this.getMatchingTags("tier")?.[0]?.[1]}get isValid(){const e=this.validPeriod;if(!e||e.start>e.end)return!1;const s=this.getMatchingTags("p"),n=this.getMatchingTags("P");return!(s.length!==1||n.length!==1)}get validPeriod(){const e=this.getMatchingTags("valid")?.[0];if(e)try{return{start:new Date(Number.parseInt(e[1])*1e3),end:new Date(Number.parseInt(e[2])*1e3)}}catch{return}}set validPeriod(e){this.removeTag("valid"),e&&this.tags.push(["valid",Math.floor(e.start.getTime()/1e3).toString(),Math.floor(e.end.getTime()/1e3).toString()])}get startPeriod(){return this.validPeriod?.start}get endPeriod(){return this.validPeriod?.end}isActive(e){e??=new Date;const s=this.validPeriod;return!(!s||e<s.start||e>s.end)}},possibleIntervalFrequencies=["daily","weekly","monthly","quarterly","yearly"];function newAmount(t,e,s){return["amount",t.toString(),e,s]}function parseTagToSubscriptionAmount(t){const e=Number.parseInt(t[1]);if(Number.isNaN(e)||e===void 0||e===null||e<=0)return;const s=t[2];if(s===void 0||s==="")return;const n=t[3];if(n!==void 0&&possibleIntervalFrequencies.includes(n))return{amount:e,currency:s,term:n}}var NDKSubscriptionTier=class Ae extends NDKArticle{static kind=37001;static kinds=[37001];constructor(e,s){const n=s?.kind??37001;super(e,s),this.kind=n}static from(e){return new Ae(e.ndk,e)}get perks(){return this.getMatchingTags("perk").map(e=>e[1]).filter(e=>e!==void 0)}addPerk(e){this.tags.push(["perk",e])}get amounts(){return this.getMatchingTags("amount").map(e=>parseTagToSubscriptionAmount(e)).filter(e=>e!==void 0)}addAmount(e,s,n){this.tags.push(newAmount(e,s,n))}set relayUrl(e){this.tags.push(["r",e])}get relayUrls(){return this.getMatchingTags("r").map(e=>e[1]).filter(e=>e!==void 0)}get verifierPubkey(){return this.tagValue("p")}set verifierPubkey(e){this.removeTag("p"),e&&this.tags.push(["p",e])}get isValid(){return this.title!==void 0&&this.amounts.length>0}},NDKSubscriptionStart=class Ne extends NDKEvent{debug;static kinds=[7001];constructor(e,s){super(e,s),this.kind??=7001,this.debug=e?.debug.extend("subscription-start")??createDebug2("ndk:subscription-start")}static from(e){return new Ne(e.ndk,e.rawEvent())}get recipient(){const e=this.getMatchingTags("p")?.[0];return e?new NDKUser({pubkey:e[1]}):void 0}set recipient(e){this.removeTag("p"),e&&this.tags.push(["p",e.pubkey])}get amount(){const e=this.getMatchingTags("amount")?.[0];if(e)return parseTagToSubscriptionAmount(e)}set amount(e){this.removeTag("amount"),e&&this.tags.push(newAmount(e.amount,e.currency,e.term))}get tierId(){const e=this.getMatchingTags("e")?.[0],s=this.getMatchingTags("a")?.[0];if(!(!e||!s))return e[1]??s[1]}set tier(e){this.removeTag("e"),this.removeTag("a"),this.removeTag("event"),e&&(this.tag(e),this.removeTag("p"),this.tags.push(["p",e.pubkey]),this.tags.push(["event",JSON.stringify(e.rawEvent())]))}async fetchTier(){const e=this.tagValue("event");if(e)try{const i=JSON.parse(e);return new NDKSubscriptionTier(this.ndk,i)}catch{this.debug("Failed to parse event tag")}const s=this.tierId;if(!s)return;const n=await this.ndk?.fetchEvent(s);if(n)return NDKSubscriptionTier.from(n)}get isValid(){return this.getMatchingTags("amount").length!==1?(this.debug("Invalid # of amount tag"),!1):this.amount?this.getMatchingTags("p").length!==1?(this.debug("Invalid # of p tag"),!1):this.recipient?!0:(this.debug("Invalid p tag"),!1):(this.debug("Invalid amount tag"),!1)}},NDKTask=class Ce extends NDKEvent{static kind=1934;static kinds=[1934];constructor(e,s){super(e,s),this.kind=1934}static from(e){return new Ce(e.ndk,e.rawEvent())}set title(e){this.removeTag("title"),e&&this.tags.push(["title",e])}get title(){return this.tagValue("title")}set project(e){this.removeTag("a"),this.tags.push(e.tagReference())}get projectSlug(){const e=this.getMatchingTags("a")[0];return e?e[1].split(/:/)?.[2]:void 0}},NDKThread=class xe extends NDKEvent{static kind=11;static kinds=[11];constructor(e,s){super(e,s),this.kind??=11}static from(e){return new xe(e.ndk,e)}get title(){return this.tagValue("title")}set title(e){this.removeTag("title"),e&&this.tags.push(["title",e])}},NDKVideo=class De extends NDKEvent{static kind=21;static kinds=[34235,34236,22,21];_imetas;static from(e){return new De(e.ndk,e.rawEvent())}get title(){return this.tagValue("title")}set title(e){this.removeTag("title"),e&&this.tags.push(["title",e])}get thumbnail(){let e;return this.imetas&&this.imetas.length>0&&(e=this.imetas[0].image?.[0]),e??this.tagValue("thumb")}get imetas(){return this._imetas?this._imetas:(this._imetas=this.tags.filter(e=>e[0]==="imeta").map(mapImetaTag),this._imetas)}set imetas(e){this._imetas=e,this.tags=this.tags.filter(s=>s[0]!=="imeta"),this.tags.push(...e.map(imetaTagToTag))}get url(){return this.imetas&&this.imetas.length>0?this.imetas[0].url:this.tagValue("url")}get published_at(){const e=this.tagValue("published_at");if(e)return Number.parseInt(e)}async generateTags(){if(super.generateTags(),!this.kind&&this.imetas?.[0]?.dim){const[e,s]=this.imetas[0].dim.split("x"),n=e&&s&&Number.parseInt(e)<Number.parseInt(s);this.duration&&this.duration<120&&n?this.kind=22:this.kind=21}return super.generateTags()}get duration(){const e=this.tagValue("duration");if(e)return Number.parseInt(e)}set duration(e){this.removeTag("duration"),e!==void 0&&this.tags.push(["duration",Math.floor(e).toString()])}},NDKWiki=class Fe extends NDKArticle{static kind=30818;static kinds=[30818];static from(e){return new Fe(e.ndk,e.rawEvent())}get isDefered(){return this.hasTag("a","defer")}get deferedId(){return this.tagValue("a","defer")}set defer(e){this.removeTag("a","defer"),this.tag(e,"defer")}},NDKWikiMergeRequest=class $e extends NDKEvent{static kinds=[818];static from(e){return new $e(e.ndk,e.rawEvent())}get targetId(){return this.tagValue("a")}set target(e){this.tags=this.tags.filter(s=>{if(s[0]==="a"||s[0]==="e"&&s[3]!=="source")return!0}),this.tag(e)}get sourceId(){return this.tagValue("e","source")}set source(e){this.removeTag("e","source"),this.tag(e,"source",!1,"e")}},registeredEventClasses=new Set;function wrapEvent(t){const e=new Map,n=[...[NDKImage,NDKVideo,NDKCashuMintList,NDKArticle,NDKHighlight,NDKDraft,NDKWiki,NDKWikiMergeRequest,NDKNutzap,NDKProject,NDKTask,NDKProjectTemplate,NDKSimpleGroupMemberList,NDKSimpleGroupMetadata,NDKSubscriptionTier,NDKSubscriptionStart,NDKSubscriptionReceipt,NDKList,NDKRelayList,NDKStory,NDKBlossomList,NDKFollowPack,NDKThread,NDKRepost,NDKClassified,NDKAppHandlerEvent,NDKDVMJobFeedback,NDKCashuMintAnnouncement,NDKFedimintMint,NDKMintRecommendation],...registeredEventClasses];for(const r of n)for(const o of r.kinds)e.set(o,r);const i=e.get(t.kind);return i?i.from(t):t}function checkMissingKind(t,e){(t.kind===void 0||t.kind===null)&&e("event-missing-kind",`Cannot sign event without 'kind'.

 Event data:
    content: ${t.content?`"${t.content.substring(0,50)}${t.content.length>50?"...":""}"`:"(empty)"}
    tags: ${t.tags.length} tag${t.tags.length!==1?"s":""}
    kind: ${t.kind} 

Set event.kind before signing.`,"Example: event.kind = 1; // for text note",!1)}function checkContentIsObject(t,e){if(typeof t.content=="object"){const s=JSON.stringify(t.content,null,2).substring(0,200);e("event-content-is-object",`Event content is an object. Content must be a string.

 Your content (${typeof t.content}):
${s}${JSON.stringify(t.content).length>200?"...":""}

 event.content = { ... }  // WRONG
 event.content = JSON.stringify({ ... })  // CORRECT`,"Use JSON.stringify() for structured data: event.content = JSON.stringify(data)",!1)}}function checkCreatedAtMilliseconds(t,e){if(t.created_at&&t.created_at>1e10){const s=Math.floor(t.created_at/1e3),n=new Date(t.created_at).toISOString();e("event-created-at-milliseconds",`Event created_at is in milliseconds, not seconds.

 Your value:
    created_at: ${t.created_at} 
    Interpreted as: ${n}
    Should be: ${s} 

Nostr timestamps MUST be in seconds since Unix epoch.`,"Use Math.floor(Date.now() / 1000) instead of Date.now()",!1)}}function checkInvalidPTags(t,e){t.getMatchingTags("p").forEach((n,i)=>{if(n[1]&&!/^[0-9a-f]{64}$/i.test(n[1])){const r=JSON.stringify(n);e("tag-invalid-p-tag",`p-tag[${i}] has invalid pubkey.

 Your tag:
   ${r}

 Invalid value: "${n[1]}"
    Length: ${n[1].length} (expected 64)
    Format: ${n[1].startsWith("npub")?"bech32 (npub)":"unknown"}

p-tags MUST contain 64-character hex pubkeys.`,n[1].startsWith("npub")?`Use ndkUser.pubkey instead of npub:
    event.tags.push(['p', ndkUser.pubkey])
    event.tags.push(['p', 'npub1...'])`:"p-tags must contain valid hex pubkeys (64 characters, 0-9a-f)",!1)}})}function checkInvalidETags(t,e){t.getMatchingTags("e").forEach((n,i)=>{if(n[1]&&!/^[0-9a-f]{64}$/i.test(n[1])){const r=JSON.stringify(n),o=n[1].startsWith("note")||n[1].startsWith("nevent");e("tag-invalid-e-tag",`e-tag[${i}] has invalid event ID.

 Your tag:
   ${r}

 Invalid value: "${n[1]}"
    Length: ${n[1].length} (expected 64)
    Format: ${o?"bech32 (note/nevent)":"unknown"}

e-tags MUST contain 64-character hex event IDs.`,o?`Use event.id instead of bech32:
    event.tags.push(['e', referencedEvent.id])
    event.tags.push(['e', 'note1...'])`:"e-tags must contain valid hex event IDs (64 characters, 0-9a-f)",!1)}})}function checkManualReplyMarkers(t,e,s){if(t.kind!==1||s.has(t))return;const n=t.tags.filter(i=>i[0]==="e"&&(i[3]==="reply"||i[3]==="root"));if(n.length>0){const i=n.map((r,o)=>`   ${o+1}. ${JSON.stringify(r)}`).join(`
`);e("event-manual-reply-markers",`Event has ${n.length} e-tag(s) with manual reply/root markers.

 Your tags with markers:
${i}

  Manual reply markers detected! This will cause incorrect threading.`,`Reply events MUST be created using .reply():

    CORRECT:
   const replyEvent = originalEvent.reply();
   replyEvent.content = 'good point!';
   await replyEvent.publish();

    WRONG:
   event.tags.push(['e', eventId, '', 'reply']);

NDK handles all reply threading automatically - never add reply/root markers manually.`)}}function checkHashtagsWithPrefix(t,e){t.getMatchingTags("t").forEach((n,i)=>{if(n[1]&&n[1].startsWith("#")){const r=JSON.stringify(n);e("tag-hashtag-with-prefix",`t-tag[${i}] contains hashtag with # prefix.

 Your tag:
   ${r}

 Invalid value: "${n[1]}"

Hashtag tags should NOT include the # symbol.`,`Remove the # prefix from hashtag tags:
    event.tags.push(['t', 'nostr'])
    event.tags.push(['t', '#nostr'])`,!1)}})}function checkReplaceableWithOldTimestamp(t,e){if(t.kind===void 0||t.kind===null||!t.created_at||!t.isReplaceable())return;const s=Math.floor(Date.now()/1e3),n=s-t.created_at;if(n>10){const r=Math.floor(n/60),o=r>0?`${r} minute${r!==1?"s":""}`:`${n} seconds`;e("event-replaceable-old-timestamp",`Publishing a replaceable event with an old created_at timestamp.

 Event details:
    kind: ${t.kind} (replaceable)
    created_at: ${t.created_at}
    age: ${o} old
    current time: ${s}

  This is wrong and will be rejected by relays.`,`For replaceable events, use publishReplaceable():

    CORRECT:
   await event.publishReplaceable();
   // Automatically updates created_at to now

    WRONG:
   await event.publish();
   // Uses old created_at`)}}function signing(t,e,s,n){checkMissingKind(t,e),checkContentIsObject(t,e),checkCreatedAtMilliseconds(t,e),checkInvalidPTags(t,e),checkInvalidETags(t,e),checkHashtagsWithPrefix(t,e),checkManualReplyMarkers(t,s,n)}function publishing(t,e){checkReplaceableWithOldTimestamp(t,e)}function isNip33Pattern(t){const e=Array.isArray(t)?t:[t];if(e.length!==1)return!1;const s=e[0];return s.kinds&&Array.isArray(s.kinds)&&s.kinds.length===1&&s.authors&&Array.isArray(s.authors)&&s.authors.length===1&&s["#d"]&&Array.isArray(s["#d"])&&s["#d"].length===1}function isReplaceableEventFilter(t){const e=Array.isArray(t)?t:[t];return e.length===0?!1:e.every(s=>!s.kinds||!Array.isArray(s.kinds)||s.kinds.length===0||!s.authors||!Array.isArray(s.authors)||s.authors.length===0?!1:s.kinds.every(i=>i===0||i===3||i>=1e4&&i<=19999))}function formatFilter(t){return JSON.stringify(t,null,2).split(`
`).map((s,n)=>n===0?s:`   ${s}`).join(`
`)}function fetchingEvents(t,e,s,n,i){if(i(),e?.cacheUsage==="ONLY_CACHE")return;const r=Array.isArray(t)?t:[t],o=r.map(formatFilter).join(`

   ---

   `);if(isNip33Pattern(t))r[0],s("fetch-events-usage",`For fetching a NIP-33 addressable event, use fetchEvent() with the naddr directly.

 Your filter:
   `+o+`

   BAD:  const decoded = nip19.decode(naddr);
           const events = await ndk.fetchEvents({
             kinds: [decoded.data.kind],
             authors: [decoded.data.pubkey],
             "#d": [decoded.data.identifier]
           });
           const event = Array.from(events)[0];

   GOOD: const event = await ndk.fetchEvent(naddr);
   GOOD: const event = await ndk.fetchEvent('naddr1...');

fetchEvent() handles naddr decoding automatically and returns the event directly.`);else{if(isReplaceableEventFilter(t))return;{if(!n())return;let a="";const c=r.some(h=>h.limit!==void 0),l=new Set(r.flatMap(h=>h.kinds||[])).size,u=new Set(r.flatMap(h=>h.authors||[])).size;if(c){const h=Math.max(...r.map(f=>f.limit||0));a+=`
    Limit: ${h} event${h!==1?"s":""}`}l>0&&(a+=`
    Kinds: ${l} type${l!==1?"s":""}`),u>0&&(a+=`
    Authors: ${u} author${u!==1?"s":""}`),s("fetch-events-usage",`fetchEvents() is a BLOCKING operation that waits for EOSE.
In most cases, you should use subscribe() instead.

 Your filter`+(r.length>1?"s":"")+`:
   `+o+(a?`

 Filter analysis:`+a:"")+`

   BAD:  const events = await ndk.fetchEvents(filter);
   GOOD: ndk.subscribe(filter, { onEvent: (e) => ... });

Only use fetchEvents() when you MUST block until data arrives.`,"For one-time queries, use fetchEvent() instead of fetchEvents() when expecting a single result.")}}}var GuardrailCheckId={NDK_NO_CACHE:"ndk-no-cache",FILTER_BECH32_IN_ARRAY:"filter-bech32-in-array",FILTER_INVALID_HEX:"filter-invalid-hex",FILTER_ONLY_LIMIT:"filter-only-limit",FILTER_EMPTY:"filter-empty",FILTER_SINCE_AFTER_UNTIL:"filter-since-after-until",FILTER_INVALID_A_TAG:"filter-invalid-a-tag",FILTER_HASHTAG_WITH_PREFIX:"filter-hashtag-with-prefix"};function checkCachePresence(t,e){e(GuardrailCheckId.NDK_NO_CACHE)&&setTimeout(()=>{if(!t.cacheAdapter){const i=`
 AI_GUARDRAILS WARNING: NDK initialized without a cache adapter. Apps perform significantly better with caching.

 ${typeof window<"u"?"Consider using @nostr-dev-kit/ndk-cache-dexie or @nostr-dev-kit/ndk-cache-sqlite-wasm":"Consider using @nostr-dev-kit/ndk-cache-redis or @nostr-dev-kit/ndk-cache-sqlite"}

 To disable this check:
   ndk.aiGuardrails.skip('${GuardrailCheckId.NDK_NO_CACHE}')
   or set: ndk.aiGuardrails = { skip: new Set(['${GuardrailCheckId.NDK_NO_CACHE}']) }`;console.warn(i)}},2500)}var AIGuardrails=class{enabled=!1;skipSet=new Set;extensions=new Map;_nextCallDisabled=null;_replyEvents=new WeakSet;_fetchEventsCount=0;_subscribeCount=0;constructor(t=!1){this.setMode(t)}register(t,e){this.extensions.has(t)&&console.warn(`AIGuardrails: Extension '${t}' already registered, overwriting`);const s={};for(const[n,i]of Object.entries(e))typeof i=="function"&&(s[n]=(...r)=>{this.enabled&&i(...r,this.shouldCheck.bind(this),this.error.bind(this),this.warn.bind(this))});this.extensions.set(t,s),this[t]=s}setMode(t){typeof t=="boolean"?(this.enabled=t,this.skipSet.clear()):t&&typeof t=="object"&&(this.enabled=!0,this.skipSet=t.skip||new Set)}isEnabled(){return this.enabled}shouldCheck(t){return!(!this.enabled||this.skipSet.has(t)||this._nextCallDisabled==="all"||this._nextCallDisabled&&this._nextCallDisabled.has(t))}skip(t){this.skipSet.add(t)}enable(t){this.skipSet.delete(t)}getSkipped(){return Array.from(this.skipSet)}captureAndClearNextCallDisabled(){const t=this._nextCallDisabled;return this._nextCallDisabled=null,t}incrementFetchEventsCount(){this._fetchEventsCount++}incrementSubscribeCount(){this._subscribeCount++}shouldWarnAboutFetchEventsRatio(){const t=this._fetchEventsCount+this._subscribeCount;return t<=6?!1:this._fetchEventsCount/t>.5}error(t,e,s,n=!0){if(!this.shouldCheck(t))return;const i=this.formatMessage(t,"ERROR",e,s,n);throw console.error(i),new Error(i)}warn(t,e,s){if(!this.shouldCheck(t))return;const n=this.formatMessage(t,"WARNING",e,s,!0);throw console.error(n),new Error(n)}formatMessage(t,e,s,n,i=!0){let r=`
 AI_GUARDRAILS ${e}: ${s}`;return n&&(r+=`

 ${n}`),i&&(r+=`

 To disable this check:
   ndk.guardrailOff('${t}').yourMethod()  // For one call`,r+=`
   ndk.aiGuardrails.skip('${t}')  // Permanently`,r+=`
   or set: ndk.aiGuardrails = { skip: new Set(['${t}']) }`),r}ndkInstantiated(t){this.enabled&&checkCachePresence(t,this.shouldCheck.bind(this))}ndk={fetchingEvents:(t,e)=>{this.enabled&&fetchingEvents(t,e,this.warn.bind(this),this.shouldWarnAboutFetchEventsRatio.bind(this),this.incrementFetchEventsCount.bind(this))}};event={signing:t=>{this.enabled&&signing(t,this.error.bind(this),this.warn.bind(this),this._replyEvents)},publishing:t=>{this.enabled&&publishing(t,this.warn.bind(this))},received:(t,e)=>{this.enabled},creatingReply:t=>{this.enabled&&this._replyEvents.add(t)}};subscription={created:(t,e)=>{this.enabled&&this.incrementSubscribeCount()}};relay={connected:t=>{this.enabled}}};function processFilters(t,e="validate",s,n){if(e==="ignore")return t;const i=[],r=t.map((o,a)=>(n?.aiGuardrails.isEnabled()&&runAIGuardrailsForFilter(o,a,n),processFilter(o,e,a,i,s)));if(e==="validate"&&i.length>0)throw new Error(`Invalid filter(s) detected:
${i.join(`
`)}`);return r}function processFilter(t,e,s,n,i){const r=e==="validate",o=r?t:{...t};if(t.ids){const a=[];t.ids.forEach((c,l)=>{c===void 0?r?n.push(`Filter[${s}].ids[${l}] is undefined`):i?.(`Fixed: Removed undefined value at ids[${l}]`):typeof c!="string"?r?n.push(`Filter[${s}].ids[${l}] is not a string (got ${typeof c})`):i?.(`Fixed: Removed non-string value at ids[${l}] (was ${typeof c})`):isValidHex64(c)?a.push(c):r?n.push(`Filter[${s}].ids[${l}] is not a valid 64-char hex string: "${c}"`):i?.(`Fixed: Removed invalid hex string at ids[${l}]`)}),r||(o.ids=a.length>0?a:void 0)}if(t.authors){const a=[];t.authors.forEach((c,l)=>{c===void 0?r?n.push(`Filter[${s}].authors[${l}] is undefined`):i?.(`Fixed: Removed undefined value at authors[${l}]`):typeof c!="string"?r?n.push(`Filter[${s}].authors[${l}] is not a string (got ${typeof c})`):i?.(`Fixed: Removed non-string value at authors[${l}] (was ${typeof c})`):isValidHex64(c)?a.push(c):r?n.push(`Filter[${s}].authors[${l}] is not a valid 64-char hex pubkey: "${c}"`):i?.(`Fixed: Removed invalid hex pubkey at authors[${l}]`)}),r||(o.authors=a.length>0?a:void 0)}if(t.kinds){const a=[];t.kinds.forEach((c,l)=>{c===void 0?r?n.push(`Filter[${s}].kinds[${l}] is undefined`):i?.(`Fixed: Removed undefined value at kinds[${l}]`):typeof c!="number"?r?n.push(`Filter[${s}].kinds[${l}] is not a number (got ${typeof c})`):i?.(`Fixed: Removed non-number value at kinds[${l}] (was ${typeof c})`):Number.isInteger(c)?c<0||c>65535?r?n.push(`Filter[${s}].kinds[${l}] is out of valid range (0-65535): ${c}`):i?.(`Fixed: Removed out-of-range kind at kinds[${l}]: ${c}`):a.push(c):r?n.push(`Filter[${s}].kinds[${l}] is not an integer: ${c}`):i?.(`Fixed: Removed non-integer value at kinds[${l}]: ${c}`)}),r||(o.kinds=a.length>0?a:void 0)}for(const a in t)if(a.startsWith("#")&&a.length===2){const c=t[a];if(Array.isArray(c)){const l=[];c.forEach((u,h)=>{u===void 0?r?n.push(`Filter[${s}].${a}[${h}] is undefined`):i?.(`Fixed: Removed undefined value at ${a}[${h}]`):typeof u!="string"?r?n.push(`Filter[${s}].${a}[${h}] is not a string (got ${typeof u})`):i?.(`Fixed: Removed non-string value at ${a}[${h}] (was ${typeof u})`):(a==="#e"||a==="#p")&&!isValidHex64(u)?r?n.push(`Filter[${s}].${a}[${h}] is not a valid 64-char hex string: "${u}"`):i?.(`Fixed: Removed invalid hex string at ${a}[${h}]`):l.push(u)}),r||(o[a]=l.length>0?l:void 0)}}return r||Object.keys(o).forEach(a=>{o[a]===void 0&&delete o[a]}),o}function runAIGuardrailsForFilter(t,e,s){const n=s.aiGuardrails,i=JSON.stringify(t,null,2);if(Object.keys(t).length===1&&t.limit!==void 0&&n.error(GuardrailCheckId.FILTER_ONLY_LIMIT,`Filter[${e}] contains only 'limit' without any filtering criteria.

 Your filter:
${i}

  This will fetch random events from relays without any criteria.`,`Add filtering criteria:
    { kinds: [1], limit: 10 }
    { authors: [pubkey], limit: 10 }
    { limit: 10 }`),Object.keys(t).length===0&&n.error(GuardrailCheckId.FILTER_EMPTY,`Filter[${e}] is empty.

 Your filter:
${i}

  This will request ALL events from relays, which is never what you want.`,"Add filtering criteria like 'kinds', 'authors', or tags.",!1),t.since!==void 0&&t.until!==void 0&&t.since>t.until){const o=new Date(t.since*1e3).toISOString(),a=new Date(t.until*1e3).toISOString();n.error(GuardrailCheckId.FILTER_SINCE_AFTER_UNTIL,`Filter[${e}] has 'since' AFTER 'until'.

 Your filter:
${i}

 since: ${t.since} (${o})
 until: ${t.until} (${a})

No events can match this time range!`,"'since' must be BEFORE 'until'. Both are Unix timestamps in seconds.",!1)}const r=/^n(addr|event|ote|pub|profile)1/;t.ids&&t.ids.forEach((o,a)=>{typeof o=="string"&&(r.test(o)?n.error(GuardrailCheckId.FILTER_BECH32_IN_ARRAY,`Filter[${e}].ids[${a}] contains bech32: "${o}". IDs must be hex, not bech32.`,'Use filterFromId() to decode bech32 first: import { filterFromId } from "@nostr-dev-kit/ndk"',!1):isValidHex64(o)||n.error(GuardrailCheckId.FILTER_INVALID_HEX,`Filter[${e}].ids[${a}] is not a valid 64-char hex string: "${o}"`,`Event IDs must be 64-character hexadecimal strings. Invalid IDs often come from corrupted data in user-generated lists. Always validate hex strings before using them in filters:

   const validIds = ids.filter(id => /^[0-9a-f]{64}$/i.test(id));`,!1))}),t.authors&&t.authors.forEach((o,a)=>{typeof o=="string"&&(r.test(o)?n.error(GuardrailCheckId.FILTER_BECH32_IN_ARRAY,`Filter[${e}].authors[${a}] contains bech32: "${o}". Authors must be hex pubkeys, not npub.`,"Use ndkUser.pubkey instead. Example: { authors: [ndkUser.pubkey] }",!1):isValidHex64(o)||n.error(GuardrailCheckId.FILTER_INVALID_HEX,`Filter[${e}].authors[${a}] is not a valid 64-char hex pubkey: "${o}"`,`Kind:3 follow lists can contain invalid entries like labels ("Follow List"), partial strings ("highlig"), or other corrupted data. You MUST validate all pubkeys before using them in filters.

   Example:
   const validPubkeys = pubkeys.filter(p => /^[0-9a-f]{64}$/i.test(p));
   ndk.subscribe({ authors: validPubkeys, kinds: [1] });`,!1))});for(const o in t)if(o.startsWith("#")&&o.length===2){const a=t[o];Array.isArray(a)&&a.forEach((c,l)=>{typeof c=="string"&&(o==="#e"||o==="#p")&&(r.test(c)?n.error(GuardrailCheckId.FILTER_BECH32_IN_ARRAY,`Filter[${e}].${o}[${l}] contains bech32: "${c}". Tag values must be decoded.`,"Use filterFromId() or nip19.decode() to get the hex value first.",!1):isValidHex64(c)||n.error(GuardrailCheckId.FILTER_INVALID_HEX,`Filter[${e}].${o}[${l}] is not a valid 64-char hex string: "${c}"`,`${o==="#e"?"Event IDs":"Public keys"} in tag filters must be 64-character hexadecimal strings. Kind:3 follow lists and other user-generated content can contain invalid data. Always filter before using:

   const validValues = values.filter(v => /^[0-9a-f]{64}$/i.test(v));`,!1))})}t["#a"]&&t["#a"]?.forEach((a,c)=>{if(typeof a=="string")if(!/^\d+:[0-9a-f]{64}:.*$/.test(a))n.error(GuardrailCheckId.FILTER_INVALID_A_TAG,`Filter[${e}].#a[${c}] has invalid format: "${a}". Must be "kind:pubkey:d-tag".`,'Example: "30023:fa984bd7dbb282f07e16e7ae87b26a2a7b9b90b7246a44771f0cf5ae58018f52:my-article"',!1);else{const l=Number.parseInt(a.split(":")[0],10);(l<3e4||l>39999)&&n.error(GuardrailCheckId.FILTER_INVALID_A_TAG,`Filter[${e}].#a[${c}] uses non-addressable kind ${l}: "${a}". #a filters are only for addressable events (kinds 30000-39999).`,`Addressable events include:
    30000-30039: Parameterized Replaceable Events (profiles, settings, etc.)
    30040-39999: Other addressable events

For regular events (kind ${l}), use:
    #e filter for specific event IDs
    kinds + authors filters for event queries`,!1)}}),t["#t"]&&t["#t"]?.forEach((a,c)=>{typeof a=="string"&&a.startsWith("#")&&n.error(GuardrailCheckId.FILTER_HASHTAG_WITH_PREFIX,`Filter[${e}].#t[${c}] contains hashtag with # prefix: "${a}". Hashtag values should NOT include the # symbol.`,`Remove the # prefix from hashtag filters:
    { "#t": ["nostr"] }
    { "#t": ["#nostr"] }`,!1)})}function queryFullyFilled(t){return!!(filterIncludesIds(t.filter)&&resultHasAllRequestedIds(t))}function filterIncludesIds(t){return!!t.ids}function resultHasAllRequestedIds(t){const e=t.filter.ids;return!!e&&e.length===t.eventFirstSeen.size}function filterFromId(t){let e;if(t.match(NIP33_A_REGEX)){const[s,n,i]=t.split(":"),r={authors:[n],kinds:[Number.parseInt(s)]};return i&&(r["#d"]=[i]),r}if(t.match(BECH32_REGEX))try{switch(e=nip19_exports$1.decode(t),e.type){case"nevent":{const s={ids:[e.data.id]};return e.data.author&&(s.authors=[e.data.author]),e.data.kind&&(s.kinds=[e.data.kind]),s}case"note":return{ids:[e.data]};case"naddr":{const s={authors:[e.data.pubkey],kinds:[e.data.kind]};return e.data.identifier&&(s["#d"]=[e.data.identifier]),s}}}catch(s){console.error("Error decoding",t,s)}return{ids:[t]}}function isNip33AValue(t){return t.match(NIP33_A_REGEX)!==null}var NIP33_A_REGEX=/^(\d+):([0-9A-Fa-f]+)(?::(.*))?$/,BECH32_REGEX=/^n(event|ote|profile|pub|addr)1[\d\w]+$/;function relaysFromBech32(t,e){try{const s=nip19_exports$1.decode(t);if(["naddr","nevent"].includes(s?.type)){const n=s.data;if(n?.relays)return n.relays.map(i=>new NDKRelay(i,e.relayAuthDefaultPolicy,e))}}catch{}return[]}var defaultOpts={closeOnEose:!1,cacheUsage:"CACHE_FIRST",dontSaveToCache:!1,groupable:!0,groupableDelay:100,groupableDelayType:"at-most",cacheUnconstrainFilter:["limit","since","until"],includeMuted:!1},NDKSubscription=class extends lib$1.EventEmitter{subId;filters;opts;pool;skipVerification=!1;skipValidation=!1;exclusiveRelay=!1;relayFilters;relaySet;ndk;debug;eventFirstSeen=new Map;eosesSeen=new Set;lastEventReceivedAt;mostRecentCacheEventTimestamp;internalId;closeOnEose;poolMonitor;skipOptimisticPublishEvent=!1;cacheUnconstrainFilter;constructor(t,e,s,n){super(),this.ndk=t,this.opts={...defaultOpts,...s||{}},this.pool=this.opts.pool||t.pool;const i=Array.isArray(e)?e:[e],r=t.filterValidationMode==="validate"?"validate":t.filterValidationMode==="fix"?"fix":"ignore";if(this.filters=processFilters(i,r,t.debug,t),this.filters.length===0)throw new Error("Subscription must have at least one filter");this.subId=n||this.opts.subId,this.internalId=Math.random().toString(36).substring(7),this.debug=t.debug.extend(`subscription[${this.opts.subId??this.internalId}]`),this.opts.relaySet?this.relaySet=this.opts.relaySet:this.opts.relayUrls&&(this.relaySet=NDKRelaySet.fromRelayUrls(this.opts.relayUrls,this.ndk)),this.skipVerification=this.opts.skipVerification||!1,this.skipValidation=this.opts.skipValidation||!1,this.closeOnEose=this.opts.closeOnEose||!1,this.skipOptimisticPublishEvent=this.opts.skipOptimisticPublishEvent||!1,this.cacheUnconstrainFilter=this.opts.cacheUnconstrainFilter,this.exclusiveRelay=this.opts.exclusiveRelay||!1,this.opts.onEvent&&this.on("event",this.opts.onEvent),this.opts.onEose&&this.on("eose",this.opts.onEose),this.opts.onClose&&this.on("close",this.opts.onClose)}relaysMissingEose(){return this.relayFilters?Array.from(this.relayFilters?.keys()).filter(e=>!this.eosesSeen.has(this.pool.getRelay(e,!1,!1))):[]}get filter(){return this.filters[0]}get groupableDelay(){if(this.isGroupable())return this.opts?.groupableDelay}get groupableDelayType(){return this.opts?.groupableDelayType||"at-most"}isGroupable(){return this.opts?.groupable||!1}shouldQueryCache(){return this.opts.addSinceFromCache?!0:this.opts?.cacheUsage==="ONLY_RELAY"?!1:(this.filters.some(e=>e.kinds?.some(s=>kindIsEphemeral(s))),!0)}shouldQueryRelays(){return this.opts?.cacheUsage!=="ONLY_CACHE"}shouldWaitForCache(){return this.opts.addSinceFromCache?!0:!!this.opts.closeOnEose&&!!this.ndk.cacheAdapter?.locking&&this.opts.cacheUsage!=="PARALLEL"}start(t=!0){let e;const s=i=>{for(const r of i)r.created_at&&(!this.mostRecentCacheEventTimestamp||r.created_at>this.mostRecentCacheEventTimestamp)&&(this.mostRecentCacheEventTimestamp=r.created_at),this.eventReceived(r,void 0,!0,!1);t||(e=i)},n=()=>{this.shouldQueryRelays()?(this.startWithRelays(),this.startPoolMonitor()):this.emit("eose",this)};return this.shouldQueryCache()?(e=this.startWithCache(),e instanceof Promise?this.shouldWaitForCache()?(e.then(i=>{if(s(i),queryFullyFilled(this)){this.emit("eose",this);return}n()}),null):(e.then(i=>{s(i),this.shouldQueryRelays()||this.emit("eose",this)}),this.shouldQueryRelays()&&n(),null):(s(e),queryFullyFilled(this)?this.emit("eose",this):n(),e)):(n(),null)}startPoolMonitor(){this.debug.extend("pool-monitor"),this.poolMonitor=t=>{if(this.relayFilters?.has(t.url))return;calculateRelaySetsFromFilters(this.ndk,this.filters,this.pool,this.opts.relayGoalPerAuthor).get(t.url)&&(this.relayFilters?.set(t.url,this.filters),t.subscribe(this,this.filters))},this.pool.on("relay:connect",this.poolMonitor)}onStopped;stop(){this.emit("close",this),this.poolMonitor&&this.pool.off("relay:connect",this.poolMonitor),this.onStopped?.()}hasAuthorsFilter(){return this.filters.some(t=>t.authors?.length)}startWithCache(){return this.ndk.cacheAdapter?.query?this.ndk.cacheAdapter.query(this):[]}startWithRelays(){let t=this.filters;if(this.opts.addSinceFromCache&&this.mostRecentCacheEventTimestamp){const e=this.mostRecentCacheEventTimestamp+1;t=t.map(s=>({...s,since:Math.max(s.since||0,e)}))}if(!this.relaySet||this.relaySet.relays.size===0)this.relayFilters=calculateRelaySetsFromFilters(this.ndk,t,this.pool,this.opts.relayGoalPerAuthor);else{this.relayFilters=new Map;for(const e of this.relaySet.relays)this.relayFilters.set(e.url,t)}for(const[e,s]of this.relayFilters)this.pool.getRelay(e,!0,!0,s).subscribe(this,s)}refreshRelayConnections(){if(this.relaySet&&this.relaySet.relays.size>0)return;const t=calculateRelaySetsFromFilters(this.ndk,this.filters,this.pool,this.opts.relayGoalPerAuthor);for(const[e,s]of t)this.relayFilters?.has(e)||(this.relayFilters?.set(e,s),this.pool.getRelay(e,!0,!0,s).subscribe(this,s))}eventReceived(t,e,s=!1,n=!1){const i=t.id,r=this.eventFirstSeen.has(i);let o;if(t instanceof NDKEvent&&(o=t),r){const a=Date.now()-(this.eventFirstSeen.get(i)||0);if(this.emit("event:dup",t,e,a,this,s,n),this.opts?.onEventDup&&this.opts.onEventDup(t,e,a,this,s,n),!s&&!n&&e&&this.ndk.cacheAdapter?.setEventDup&&!this.opts.dontSaveToCache&&(o??=t instanceof NDKEvent?t:new NDKEvent(this.ndk,t),this.ndk.cacheAdapter.setEventDup(o,e)),e){const c=verifiedSignatures.get(i);if(c&&typeof c=="string")if(t.sig===c)e.addValidatedEvent();else{const l=t instanceof NDKEvent?t:new NDKEvent(this.ndk,t);this.ndk.reportInvalidSignature(l,e)}}}else{if(o??=new NDKEvent(this.ndk,t),o.ndk=this.ndk,o.relay=e,!s&&!n){if(!this.skipValidation&&!o.isValid){this.debug("Event failed validation %s from relay %s",i,e?.url);return}if(e)if(e.shouldValidateEvent()&&!this.skipVerification)if(o.relay=e,this.ndk.asyncSigVerification)o.verifySignature(!0);else{if(!o.verifySignature(!0)){this.debug("Event failed signature validation",t),this.ndk.reportInvalidSignature(o,e);return}e.addValidatedEvent()}else e.addNonValidatedEvent();this.ndk.cacheAdapter&&!this.opts.dontSaveToCache&&this.ndk.cacheAdapter.setEvent(o,this.filters,e)}if(!this.opts.includeMuted&&this.ndk.muteFilter&&this.ndk.muteFilter(o)){this.debug("Event muted, skipping");return}(!n||this.skipOptimisticPublishEvent!==!0)&&(this.emitEvent(this.opts?.wrap??!1,o,e,s,n),this.eventFirstSeen.set(i,Date.now()))}this.lastEventReceivedAt=Date.now()}emitEvent(t,e,s,n,i){const r=t?wrapEvent(e):e;r instanceof Promise?r.then(o=>this.emitEvent(!1,o,s,n,i)):r&&this.emit("event",r,s,this,n,i)}closedReceived(t,e){this.emit("closed",t,e)}eoseTimeout;eosed=!1;eoseReceived(t){this.debug("EOSE received from %s",t.url),this.eosesSeen.add(t);let e=this.lastEventReceivedAt?Date.now()-this.lastEventReceivedAt:void 0;const s=this.eosesSeen.size===this.relayFilters?.size,n=queryFullyFilled(this),i=r=>{this.debug("Performing EOSE: %s %d",r,this.eosed),!this.eosed&&(this.eoseTimeout&&clearTimeout(this.eoseTimeout),this.emit("eose",this),this.eosed=!0,this.opts?.closeOnEose&&this.stop())};if(n||s)i("query filled or seen all");else if(this.relayFilters){let r=1e3;const o=new Set(this.pool.connectedRelays().map(l=>l.url)),a=Array.from(this.relayFilters.keys()).filter(l=>o.has(l));if(a.length===0){this.debug("No connected relays, waiting for all relays to connect",Array.from(this.relayFilters.keys()).join(", "));return}const c=this.eosesSeen.size/a.length;if(this.debug("Percentage of relays that have sent EOSE",{subId:this.subId,percentageOfRelaysThatHaveSentEose:c,seen:this.eosesSeen.size,total:a.length}),this.eosesSeen.size>=2&&c>=.5){if(r=r*(1-c),r===0){i("time to wait was 0");return}this.eoseTimeout&&clearTimeout(this.eoseTimeout);const l=()=>{e=this.lastEventReceivedAt?Date.now()-this.lastEventReceivedAt:void 0,e!==void 0&&e<20?this.eoseTimeout=setTimeout(l,r):i(`send eose timeout: ${r}`)};this.eoseTimeout=setTimeout(l,r)}}}},kindIsEphemeral=t=>t>=2e4&&t<3e4;async function follows(t,e,s=3){if(!this.ndk)throw new Error("NDK not set");const n=await this.ndk.fetchEvent({kinds:[s],authors:[this.pubkey]},t||{groupable:!1});if(n){const i=new Set;return n.tags.forEach(r=>{r[0]==="p"&&r[1]&&isValidPubkey(r[1])&&i.add(r[1])}),e&&this.ndk?.outboxTracker?.trackUsers(Array.from(i)),[...i].reduce((r,o)=>{const a=new NDKUser({pubkey:o});return a.ndk=this.ndk,r.add(a),r},new Set)}return new Set}var NIP05_REGEX=/^(?:([\w.+-]+)@)?([\w.-]+)$/;async function getNip05For(t,e,s=fetch,n={}){return await t.queuesNip05.add({id:e,func:async()=>{if(t.cacheAdapter?.loadNip05){const c=await t.cacheAdapter.loadNip05(e);if(c!=="missing"){if(c){const l=new NDKUser({pubkey:c.pubkey,relayUrls:c.relays,nip46Urls:c.nip46});return l.ndk=t,l}if(n.cache!=="no-cache")return null}}const i=e.match(NIP05_REGEX);if(!i)return null;const[r,o="_",a]=i;try{const c=await s(`https://${a}/.well-known/nostr.json?name=${o}`,n),{names:l,relays:u,nip46:h}=parseNIP05Result(await c.json()),f=l[o.toLowerCase()];let p=null;return f&&(p={pubkey:f,relays:u?.[f],nip46:h?.[f]}),t?.cacheAdapter?.saveNip05&&t.cacheAdapter.saveNip05(e,p),p}catch(c){return t?.cacheAdapter?.saveNip05&&t?.cacheAdapter.saveNip05(e,null),console.error("Failed to fetch NIP05 for",e,c),null}}})}function parseNIP05Result(t){const e={names:{}};for(const[s,n]of Object.entries(t.names))typeof s=="string"&&typeof n=="string"&&(e.names[s.toLowerCase()]=n);if(t.relays){e.relays={};for(const[s,n]of Object.entries(t.relays))typeof s=="string"&&Array.isArray(n)&&(e.relays[s]=n.filter(i=>typeof i=="string"))}if(t.nip46){e.nip46={};for(const[s,n]of Object.entries(t.nip46))typeof s=="string"&&Array.isArray(n)&&(e.nip46[s]=n.filter(i=>typeof i=="string"))}return e}function profileFromEvent(t){const e={};let s;try{s=JSON.parse(t.content)}catch(n){throw new Error(`Failed to parse profile event: ${n}`)}e.profileEvent=JSON.stringify(t.rawEvent());for(const n of Object.keys(s))switch(n){case"name":e.name=s.name;break;case"display_name":e.displayName=s.display_name;break;case"image":case"picture":e.picture=s.picture||s.image,e.image=e.picture;break;case"banner":e.banner=s.banner;break;case"bio":e.bio=s.bio;break;case"nip05":e.nip05=s.nip05;break;case"lud06":e.lud06=s.lud06;break;case"lud16":e.lud16=s.lud16;break;case"about":e.about=s.about;break;case"website":e.website=s.website;break;default:e[n]=s[n];break}return e.created_at=t.created_at,e}function serializeProfile(t){const e={};for(const[s,n]of Object.entries(t))switch(s){case"username":case"name":e.name=n;break;case"displayName":e.display_name=n;break;case"image":case"picture":e.picture=n;break;case"bio":case"about":e.about=n;break;default:e[s]=n;break}return JSON.stringify(e)}var NDKUser=class Ie{ndk;profile;profileEvent;_npub;_pubkey;relayUrls=[];nip46Urls=[];constructor(e){if(e.npub&&(this._npub=e.npub),e.hexpubkey&&(this._pubkey=e.hexpubkey),e.pubkey&&(this._pubkey=e.pubkey),e.relayUrls&&(this.relayUrls=e.relayUrls),e.nip46Urls&&(this.nip46Urls=e.nip46Urls),e.nprofile)try{const s=nip19_exports$1.decode(e.nprofile);s.type==="nprofile"&&(this._pubkey=s.data.pubkey,s.data.relays&&s.data.relays.length>0&&this.relayUrls.push(...s.data.relays))}catch(s){console.error("Failed to decode nprofile",s)}}get npub(){if(!this._npub){if(!this._pubkey)throw new Error("pubkey not set");this._npub=nip19_exports$1.npubEncode(this.pubkey)}return this._npub}get nprofile(){const e=this.profileEvent?.onRelays?.map(s=>s.url);return nip19_exports$1.nprofileEncode({pubkey:this.pubkey,relays:e})}set npub(e){this._npub=e}get pubkey(){if(!this._pubkey){if(!this._npub)throw new Error("npub not set");this._pubkey=nip19_exports$1.decode(this.npub).data}return this._pubkey}set pubkey(e){this._pubkey=e}filter(){return{"#p":[this.pubkey]}}async getZapInfo(e){if(!this.ndk)throw new Error("No NDK instance found");const s=async o=>{if(!e)return o;let a;const c=new Promise((l,u)=>{a=setTimeout(()=>u(new Error("Timeout")),e)});try{const l=await Promise.race([o,c]);return a&&clearTimeout(a),l}catch(l){if(l instanceof Error&&l.message==="Timeout")try{return await o}catch{return}return}},[n,i]=await Promise.all([s(this.fetchProfile()),s(this.ndk.fetchEvent({kinds:[10019],authors:[this.pubkey]}))]),r=new Map;if(i){const o=NDKCashuMintList.from(i);o.mints.length>0&&r.set("nip61",{mints:o.mints,relays:o.relays,p2pk:o.p2pk})}if(n){const{lud06:o,lud16:a}=n;r.set("nip57",{lud06:o,lud16:a})}return r}static async fromNip05(e,s,n=!1){if(!s)throw new Error("No NDK instance found");const i={};n&&(i.cache="no-cache");const r=await getNip05For(s,e,s?.httpFetch,i);if(r){const o=new Ie({pubkey:r.pubkey,relayUrls:r.relays,nip46Urls:r.nip46});return o.ndk=s,o}}async fetchProfile(e,s=!1){if(!this.ndk)throw new Error("NDK not set");let n=null;if(this.ndk.cacheAdapter&&(this.ndk.cacheAdapter.fetchProfile||this.ndk.cacheAdapter.fetchProfileSync)&&e?.cacheUsage!=="ONLY_RELAY"){let i=null;if(this.ndk.cacheAdapter.fetchProfileSync?i=this.ndk.cacheAdapter.fetchProfileSync(this.pubkey):this.ndk.cacheAdapter.fetchProfile&&(i=await this.ndk.cacheAdapter.fetchProfile(this.pubkey)),i)return this.profile=i,i}return e??={},e.cacheUsage??="ONLY_RELAY",e.closeOnEose??=!0,e.groupable??=!0,e.groupableDelay??=250,n||(n=await this.ndk.fetchEvent({kinds:[0],authors:[this.pubkey]},e)),n?(this.profile=profileFromEvent(n),s&&this.profile&&this.ndk.cacheAdapter&&this.ndk.cacheAdapter.saveProfile&&this.ndk.cacheAdapter.saveProfile(this.pubkey,this.profile),this.profile):null}follows=follows.bind(this);async followSet(e,s,n=3){const i=await this.follows(e,s,n);return new Set(Array.from(i).map(r=>r.pubkey))}tagReference(){return["p",this.pubkey]}referenceTags(e){const s=[["p",this.pubkey]];return e&&s[0].push("",e),s}async publish(){if(!this.ndk)throw new Error("No NDK instance found");if(!this.profile)throw new Error("No profile available");this.ndk.assertSigner(),await new NDKEvent(this.ndk,{kind:0,content:serializeProfile(this.profile)}).publish()}async follow(e,s,n=3){if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner(),s||(s=await this.follows(void 0,void 0,n));const i=typeof e=="string"?e:e.pubkey;if(Array.from(s).some(a=>typeof a=="string"?a===i:a.pubkey===i))return!1;s.add(e);const o=new NDKEvent(this.ndk,{kind:n});for(const a of s)typeof a=="string"?o.tags.push(["p",a]):o.tag(a);return await o.publish(),!0}async unfollow(e,s,n=3){if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner(),s||(s=await this.follows(void 0,void 0,n));const i=typeof e=="string"?e:e.pubkey,r=new Set;let o=!1;for(const c of s)(typeof c=="string"?c:c.pubkey)!==i?r.add(c):o=!0;if(!o)return!1;const a=new NDKEvent(this.ndk,{kind:n});for(const c of r)typeof c=="string"?a.tags.push(["p",c]):a.tag(c);return await a.publish()}async validateNip05(e){if(!this.ndk)throw new Error("No NDK instance found");const s=await getNip05For(this.ndk,e);return s===null?null:s.pubkey===this.pubkey}},signerRegistry=new Map;function registerSigner(t,e){signerRegistry.set(t,e)}var NDKPrivateKeySigner=class J{_user;_privateKey;_pubkey;constructor(e,s){if(typeof e=="string")if(e.startsWith("nsec1")){const{type:n,data:i}=nip19_exports$1.decode(e);if(n==="nsec")this._privateKey=i;else throw new Error("Invalid private key provided.")}else if(e.length===64)this._privateKey=hexToBytes(e);else throw new Error("Invalid private key provided.");else this._privateKey=e;this._pubkey=getPublicKey(this._privateKey),s&&(this._user=s.getUser({pubkey:this._pubkey})),this._user??=new NDKUser({pubkey:this._pubkey})}get privateKey(){if(!this._privateKey)throw new Error("Not ready");return bytesToHex(this._privateKey)}get pubkey(){if(!this._pubkey)throw new Error("Not ready");return this._pubkey}get nsec(){if(!this._privateKey)throw new Error("Not ready");return nip19_exports$1.nsecEncode(this._privateKey)}get npub(){if(!this._pubkey)throw new Error("Not ready");return nip19_exports$1.npubEncode(this._pubkey)}encryptToNcryptsec(e,s=16,n=2){if(!this._privateKey)throw new Error("Private key not available");return encrypt$1(this._privateKey,e,s,n)}static generate(){const e=generateSecretKey();return new J(e)}static fromNcryptsec(e,s,n){const i=decrypt$1(e,s);return new J(i,n)}async blockUntilReady(){return this._user}async user(){return this._user}get userSync(){return this._user}async sign(e){if(!this._privateKey)throw Error("Attempted to sign without a private key");return finalizeEvent(e,this._privateKey).sig}async encryptionEnabled(e){const s=[];return(!e||e==="nip04")&&s.push("nip04"),(!e||e==="nip44")&&s.push("nip44"),s}async encrypt(e,s,n){if(!this._privateKey||!this.privateKey)throw Error("Attempted to encrypt without a private key");const i=e.pubkey;if(n==="nip44"){const r=nip44_exports.v2.utils.getConversationKey(this._privateKey,i);return await nip44_exports.v2.encrypt(s,r)}return await nip04_exports.encrypt(this._privateKey,i,s)}async decrypt(e,s,n){if(!this._privateKey||!this.privateKey)throw Error("Attempted to decrypt without a private key");const i=e.pubkey;if(n==="nip44"){const r=nip44_exports.v2.utils.getConversationKey(this._privateKey,i);return await nip44_exports.v2.decrypt(s,r)}return await nip04_exports.decrypt(this._privateKey,i,s)}toPayload(){if(!this._privateKey)throw new Error("Private key not available");const e={type:"private-key",payload:this.privateKey};return JSON.stringify(e)}static async fromPayload(e,s){const n=JSON.parse(e);if(n.type!=="private-key")throw new Error(`Invalid payload type: expected 'private-key', got ${n.type}`);if(!n.payload||typeof n.payload!="string")throw new Error("Invalid payload content for private-key signer");return new J(n.payload,s)}};registerSigner("private-key",NDKPrivateKeySigner);function dedup(t,e){return t.created_at>e.created_at?t:e}async function getRelayListForUser(t,e){return(await getRelayListForUsers([t],e)).get(t)}async function getRelayListForUsers(t,e,s=!1,n=1e3,i){const r=e.outboxPool||e.pool,o=new Set;for(const f of r.relays.values())o.add(f);if(i)for(const f of i.values())for(const p of f){const v=r.getRelay(p,!0,!0);v&&o.add(v)}const a=new Map,c=new Map,l=new NDKRelaySet(o,e);if(e.cacheAdapter?.locking&&!s){const f=await e.fetchEvents({kinds:[3,10002],authors:Array.from(new Set(t))},{cacheUsage:"ONLY_CACHE",subId:"ndk-relay-list-fetch"});for(const p of f)p.kind===10002&&a.set(p.pubkey,NDKRelayList.from(p));for(const p of f)if(p.kind===3){if(a.has(p.pubkey))continue;const v=relayListFromKind3(e,p);v&&c.set(p.pubkey,v)}t=t.filter(p=>!a.has(p)&&!c.has(p))}if(t.length===0)return a;const u=new Map,h=new Map;return new Promise(f=>{let p=!1;(async()=>{const k={closeOnEose:!0,pool:r,groupable:!0,subId:"ndk-relay-list-fetch",addSinceFromCache:!0,relaySet:l};l&&(k.relaySet=l),e.subscribe({kinds:[3,10002],authors:t},k,{onEvent:C=>{if(C.kind===10002){const P=u.get(C.pubkey);if(P&&P.created_at>C.created_at)return;u.set(C.pubkey,C)}else if(C.kind===3){const P=h.get(C.pubkey);if(P&&P.created_at>C.created_at)return;h.set(C.pubkey,C)}},onEose:()=>{if(!p){p=!0,e.debug(`[getRelayListForUsers] EOSE - relayListEvents: ${u.size}, contactListEvents: ${h.size}`);for(const C of u.values())a.set(C.pubkey,NDKRelayList.from(C));for(const C of t){if(a.has(C))continue;const P=h.get(C);if(!P)continue;const M=relayListFromKind3(e,P);M&&a.set(C,M)}e.debug(`[getRelayListForUsers] Returning ${a.size} relay lists for ${t.length} pubkeys`),f(a)}}});const R=Array.from(o).some(C=>C.status<=2),D=Array.from(o).some(C=>C.status===4);let U=n;(R||D)&&(U=n+3e3),e.debug(`[getRelayListForUsers] Setting fallback timeout to ${U}ms (disconnected: ${R}, connecting: ${D})`,{pubkeys:t}),setTimeout(()=>{p||(p=!0,e.debug(`[getRelayListForUsers] Timeout reached, returning ${a.size} relay lists`),f(a))},U)})()})}var OutboxItem=class{type;relayUrlScores;readRelays;writeRelays;constructor(t){this.type=t,this.relayUrlScores=new Map,this.readRelays=new Set,this.writeRelays=new Set}},OutboxTracker=class extends lib$1.EventEmitter{data;ndk;debug;constructor(t){super(),this.ndk=t,this.debug=t.debug.extend("outbox-tracker"),this.data=new dist.LRUCache({maxSize:1e5,entryExpirationTimeInMS:2*60*1e3})}async trackUsers(t,e=!1){const s=[];for(let n=0;n<t.length;n+=400){const i=t.slice(n,n+400),r=i.map(a=>getKeyFromItem(a)).filter(a=>!this.data.has(a));if(r.length===0)continue;for(const a of r)this.data.set(a,new OutboxItem("user"));const o=new Map;for(const a of i)a instanceof NDKUser&&a.relayUrls.length>0&&o.set(a.pubkey,a.relayUrls);s.push(new Promise(a=>{getRelayListForUsers(r,this.ndk,e,1e3,o).then(c=>{this.debug(`Received relay lists for ${c.size} pubkeys out of ${r.length} requested`);for(const[l,u]of c){let h=this.data.get(l);if(h??=new OutboxItem("user"),u){if(h.readRelays=new Set(normalize(u.readRelayUrls)),h.writeRelays=new Set(normalize(u.writeRelayUrls)),this.ndk.relayConnectionFilter){for(const f of h.readRelays)this.ndk.relayConnectionFilter(f)||h.readRelays.delete(f);for(const f of h.writeRelays)this.ndk.relayConnectionFilter(f)||h.writeRelays.delete(f)}this.data.set(l,h),this.emit("user:relay-list-updated",l,h),this.debug(`Adding ${h.readRelays.size} read relays and ${h.writeRelays.size} write relays for ${l}`,u?.rawEvent())}}}).finally(a)}))}return Promise.all(s)}track(t,e,s=!0){const n=getKeyFromItem(t);e??=getTypeFromItem(t);let i=this.data.get(n);return i||(i=new OutboxItem(e),t instanceof NDKUser&&this.trackUsers([t])),i}};function getKeyFromItem(t){return t instanceof NDKUser?t.pubkey:t}function getTypeFromItem(t){return t instanceof NDKUser?"user":"kind"}function correctRelaySet(t,e){const s=e.connectedRelays();if(!Array.from(t.relays).some(i=>s.map(r=>r.url).includes(i.url)))for(const i of s)t.addRelay(i);if(s.length===0)for(const i of e.relays.values())t.addRelay(i);return t}var NDKSubscriptionManager=class{subscriptions;seenEvents=new dist.LRUCache({maxSize:1e4,entryExpirationTimeInMS:5*60*1e3});constructor(){this.subscriptions=new Map}add(t){this.subscriptions.set(t.internalId,t),t.onStopped,t.onStopped=()=>{this.subscriptions.delete(t.internalId)},t.on("close",()=>{this.subscriptions.delete(t.internalId)})}seenEvent(t,e){const s=this.seenEvents.get(t)||[];s.some(n=>n.url===e.url)||s.push(e),this.seenEvents.set(t,s)}dispatchEvent(t,e,s=!1){e&&this.seenEvent(t.id,e);const n=this.subscriptions.values(),i=[];for(const r of n)matchFilters(r.filters,t)&&i.push(r);for(const r of i){if(r.exclusiveRelay&&r.relaySet){let o=!1;if(s?o=!r.skipOptimisticPublishEvent:e?o=r.relaySet.relays.has(e):o=(this.seenEvents.get(t.id)||[]).some(c=>r.relaySet.relays.has(c)),!o){r.debug.extend("exclusive-relay")("Rejected event %s from %s (relay not in exclusive set)",t.id,e?.url||(s?"optimistic":"cache"));continue}}r.eventReceived(t,e,!1,s)}}},debug6=createDebug2("ndk:active-user");async function getUserRelayList(t){if(!this.autoConnectUserRelays)return;const e=await getRelayListForUser(t.pubkey,this);if(e){for(const s of e.relays){let n=this.pool.relays.get(s);n||(n=new NDKRelay(s,this.relayAuthDefaultPolicy,this),this.pool.addRelay(n))}return debug6("Connected to %d user relays",e.relays.length),e}}async function setActiveUser(t){if(!this.autoConnectUserRelays)return;const e=this.outboxPool||this.pool;e.connectedRelays.length>0?await getUserRelayList.call(this,t):e.once("connect",async()=>{await getUserRelayList.call(this,t)})}function getEntity(t){try{const e=nip19_exports$1.decode(t);return e.type==="npub"?npub(this,e.data):e.type==="nprofile"?nprofile(this,e.data):e}catch{return null}}function npub(t,e){return t.getUser({pubkey:e})}function nprofile(t,e){const s=t.getUser({pubkey:e.pubkey});return e.relays&&(s.relayUrls=e.relays),s}function isValidHint(t){if(!t||t==="")return!1;try{return new URL(t),!0}catch{return!1}}async function fetchEventFromTag(t,e,s,n={type:"timeout"}){const i=this.debug.extend("fetch-event-from-tag"),[r,o,a]=t;s={},i("fetching event from tag",t,s,n);const c=getRelaysForSync(this,e.pubkey);if(c&&c.size>0){i("fetching event from author relays %o",Array.from(c));const k=NDKRelaySet.fromRelayUrls(Array.from(c),this),R=await this.fetchEvent(o,s,k);if(R)return R}else i("no author relays found for %s",e.pubkey,e);const l=calculateRelaySetsFromFilters(this,[{ids:[o]}],this.pool);i("fetching event without relay hint",l);const u=await this.fetchEvent(o,s);if(u)return u;if(a&&a!==""){const k=await this.fetchEvent(o,s,this.pool.getRelay(a,!0,!0,[{ids:[o]}]));if(k)return k}let h;const f=isValidHint(a)?this.pool.getRelay(a,!1,!0,[{ids:[o]}]):void 0,p=new Promise(k=>{this.fetchEvent(o,s,f).then(k)});if(!isValidHint(a)||n.type==="none")return p;const v=new Promise(async k=>{const R=n.relaySet,D=n.timeout??1500,U=new Promise(C=>setTimeout(C,D));if(n.type==="timeout"&&await U,h)k(h);else{i("fallback fetch triggered");const C=await this.fetchEvent(o,s,R);k(C)}});switch(n.type){case"timeout":return Promise.race([p,v]);case"eose":return h=await p,h||v}}var Queue=class{queue=[];maxConcurrency;processing=new Set;promises=new Map;constructor(t,e){this.maxConcurrency=e}add(t){if(this.promises.has(t.id))return this.promises.get(t.id);const e=new Promise((s,n)=>{this.queue.push({...t,func:()=>t.func().then(i=>(s(i),i),i=>{throw n(i),i})}),this.process()});return this.promises.set(t.id,e),e.finally(()=>{this.promises.delete(t.id),this.processing.delete(t.id),this.process()}),e}process(){if(this.processing.size>=this.maxConcurrency||this.queue.length===0)return;const t=this.queue.shift();!t||this.processing.has(t.id)||(this.processing.add(t.id),t.func())}clear(){this.queue=[]}clearProcessing(){this.processing.clear()}clearAll(){this.clear(),this.clearProcessing()}length(){return this.queue.length}},DEFAULT_OUTBOX_RELAYS=["wss://purplepag.es/","wss://nos.lol/"],NDK=class extends lib$1.EventEmitter{_explicitRelayUrls;pool;outboxPool;_signer;_activeUser;cacheAdapter;debug;devWriteRelaySet;outboxTracker;muteFilter;relayConnectionFilter;clientName;clientNip89;queuesZapConfig;queuesNip05;asyncSigVerification=!1;initialValidationRatio=1;lowestValidationRatio=.1;validationRatioFn;filterValidationMode="validate";subManager;aiGuardrails;_signatureVerificationFunction;_signatureVerificationWorker;signatureVerificationTimeMs=0;publishingFailureHandled=!1;pools=[];relayAuthDefaultPolicy;httpFetch;netDebug;autoConnectUserRelays=!0;_wallet;walletConfig;constructor(t={}){super(),this.debug=t.debug||createDebug2("ndk"),this.netDebug=t.netDebug,this._explicitRelayUrls=t.explicitRelayUrls||[],this.subManager=new NDKSubscriptionManager,this.pool=new NDKPool(t.explicitRelayUrls||[],this),this.pool.name="Main",this.pool.on("relay:auth",async(e,s)=>{this.relayAuthDefaultPolicy&&await this.relayAuthDefaultPolicy(e,s)}),this.autoConnectUserRelays=t.autoConnectUserRelays??!0,this.clientName=t.clientName,this.clientNip89=t.clientNip89,this.relayAuthDefaultPolicy=t.relayAuthDefaultPolicy,t.enableOutboxModel!==!1&&(this.outboxPool=new NDKPool(t.outboxRelayUrls||DEFAULT_OUTBOX_RELAYS,this,{debug:this.debug.extend("outbox-pool"),name:"Outbox Pool"}),this.outboxTracker=new OutboxTracker(this),this.outboxTracker.on("user:relay-list-updated",(e,s)=>{this.debug(`Outbox relay list updated for ${e}`);for(const n of this.subManager.subscriptions.values())n.filters.some(r=>r.authors?.includes(e))&&typeof n.refreshRelayConnections=="function"&&(this.debug(`Refreshing relay connections for subscription ${n.internalId}`),n.refreshRelayConnections())})),this.signer=t.signer,this.cacheAdapter=t.cacheAdapter,this.muteFilter=t.muteFilter,this.relayConnectionFilter=t.relayConnectionFilter,t.devWriteRelayUrls&&(this.devWriteRelaySet=NDKRelaySet.fromRelayUrls(t.devWriteRelayUrls,this)),this.queuesZapConfig=new Queue("zaps",3),this.queuesNip05=new Queue("nip05",10),t.signatureVerificationWorker&&(this.signatureVerificationWorker=t.signatureVerificationWorker),t.signatureVerificationFunction&&(this.signatureVerificationFunction=t.signatureVerificationFunction),this.initialValidationRatio=t.initialValidationRatio||1,this.lowestValidationRatio=t.lowestValidationRatio||.1,this.validationRatioFn=t.validationRatioFn||this.defaultValidationRatioFn,this.filterValidationMode=t.filterValidationMode||"validate",this.aiGuardrails=new AIGuardrails(t.aiGuardrails||!1),this.aiGuardrails.ndkInstantiated(this);try{this.httpFetch=fetch}catch{}}set explicitRelayUrls(t){this._explicitRelayUrls=t.map(normalizeRelayUrl),this.pool.relayUrls=t}get explicitRelayUrls(){return this._explicitRelayUrls||[]}set signatureVerificationWorker(t){this._signatureVerificationWorker=t,t?(signatureVerificationInit(t),this.asyncSigVerification=!0):this.asyncSigVerification=!1}set signatureVerificationFunction(t){this._signatureVerificationFunction=t,this.asyncSigVerification=!!t}get signatureVerificationFunction(){return this._signatureVerificationFunction}addExplicitRelay(t,e,s=!0){let n;return typeof t=="string"?n=new NDKRelay(t,e,this):n=t,this.pool.addRelay(n,s),this.explicitRelayUrls?.push(n.url),n}toJSON(){return{relayCount:this.pool.relays.size}.toString()}get activeUser(){return this._activeUser}set activeUser(t){const e=this._activeUser?.pubkey!==t?.pubkey;this._activeUser=t,e&&this.emit("activeUser:change",t),t&&e&&setActiveUser.call(this,t)}get signer(){return this._signer}set signer(t){this._signer=t,t&&this.emit("signer:ready",t),t?.user().then(e=>{e.ndk=this,this.activeUser=e})}async connect(t){this._signer&&this.autoConnectUserRelays&&(this.debug("Attempting to connect to user relays specified by signer %o",await this._signer.relays?.(this)),this._signer.relays&&(await this._signer.relays(this)).forEach(n=>this.pool.addRelay(n)));const e=[this.pool.connect(t)];return this.outboxPool&&e.push(this.outboxPool.connect(t)),this.cacheAdapter?.initializeAsync&&e.push(this.cacheAdapter.initializeAsync(this)),Promise.allSettled(e).then(()=>{})}reportInvalidSignature(t,e){this.debug(`Invalid signature detected for event ${t.id}${e?` from relay ${e.url}`:""}`),this.emit("event:invalid-sig",t,e)}defaultValidationRatioFn(t,e,s){if(e<10)return this.initialValidationRatio;const n=Math.min(e/100,1),i=this.initialValidationRatio*(1-n)+this.lowestValidationRatio*n;return Math.max(i,this.lowestValidationRatio)}getUser(t){if(typeof t=="string")if(t.startsWith("npub1")){const{type:s,data:n}=nip19_exports$1.decode(t);if(s!=="npub")throw new Error(`Invalid npub: ${t}`);return this.getUser({pubkey:n})}else if(t.startsWith("nprofile1")){const{type:s,data:n}=nip19_exports$1.decode(t);if(s!=="nprofile")throw new Error(`Invalid nprofile: ${t}`);return this.getUser({pubkey:n.pubkey,relayUrls:n.relays})}else return this.getUser({pubkey:t});const e=new NDKUser(t);return e.ndk=this,e}async getUserFromNip05(t,e=!1){return NDKUser.fromNip05(t,this,e)}async fetchUser(t,e=!1){if(isValidNip05(t))return NDKUser.fromNip05(t,this,e);if(t.startsWith("npub1")){const{type:s,data:n}=nip19_exports$1.decode(t);if(s!=="npub")throw new Error(`Invalid npub: ${t}`);const i=new NDKUser({pubkey:n});return i.ndk=this,i}else if(t.startsWith("nprofile1")){const{type:s,data:n}=nip19_exports$1.decode(t);if(s!=="nprofile")throw new Error(`Invalid nprofile: ${t}`);const i=new NDKUser({pubkey:n.pubkey,relayUrls:n.relays});return i.ndk=this,i}else{const s=new NDKUser({pubkey:t});return s.ndk=this,s}}subscribe(t,e,s=!0,n=!0){let i=e?.relaySet,r=n;s instanceof NDKRelaySet?(console.warn("relaySet is deprecated, use opts.relaySet instead. This will be removed in version v2.14.0"),i=s,r=n):(typeof s=="boolean"||typeof s=="object")&&(r=s);let o;const a={relaySet:i,...e};r&&typeof r=="object"&&(r.onEvent&&(a.onEvent=r.onEvent),r.onEose&&(a.onEose=r.onEose),r.onClose&&(a.onClose=r.onClose),r.onEvents&&(o=r.onEvents));const c=new NDKSubscription(this,t,a);this.subManager.add(c),this.aiGuardrails?.subscription?.created(Array.isArray(t)?t:[t],a);const l=c.pool;if(c.relaySet)for(const u of c.relaySet.relays)l.useTemporaryRelay(u,void 0,c.filters);if(this.outboxPool&&c.hasAuthorsFilter()){const u=c.filters.filter(h=>h.authors&&h.authors?.length>0).flatMap(h=>h.authors);this.outboxTracker?.trackUsers(u)}return r&&setTimeout(async()=>{this.cacheAdapter?.initializeAsync&&!this.cacheAdapter.ready&&await this.cacheAdapter.initializeAsync(this);const u=c.start(!o);u&&u.length>0&&o&&o(u)},0),c}fetchEventFromTag=fetchEventFromTag.bind(this);fetchEventSync(t){if(!this.cacheAdapter)throw new Error("Cache adapter not set");let e;typeof t=="string"?e=[filterFromId(t)]:e=t;const s=new NDKSubscription(this,e),n=this.cacheAdapter.query(s);if(n instanceof Promise)throw new Error("Cache adapter is async");return n.map(i=>(i.ndk=this,i))}async fetchEvent(t,e,s){let n,i;if(s instanceof NDKRelay?i=new NDKRelaySet(new Set([s]),this):s instanceof NDKRelaySet&&(i=s),!s&&typeof t=="string"&&!isNip33AValue(t)){const r=relaysFromBech32(t,this);r.length>0&&(i=new NDKRelaySet(new Set(r),this),i=correctRelaySet(i,this.pool))}if(typeof t=="string"?n=[filterFromId(t)]:Array.isArray(t)?n=t:n=[t],typeof t!="string"&&this.aiGuardrails?.ndk?.fetchingEvents(n),n.length===0)throw new Error(`Invalid filter: ${JSON.stringify(t)}`);return new Promise((r,o)=>{let a=null;const c={...e||{},closeOnEose:!0};i&&(c.relaySet=i);const l=setTimeout(()=>{u.stop(),this.aiGuardrails._nextCallDisabled=null,r(a)},1e4),u=this.subscribe(n,c,{onEvent:h=>{h.ndk=this,h.isReplaceable()?(!a||a.created_at<h.created_at)&&(a=h):(clearTimeout(l),this.aiGuardrails._nextCallDisabled=null,r(h))},onEose:()=>{clearTimeout(l),this.aiGuardrails._nextCallDisabled=null,r(a)}})})}async fetchEvents(t,e,s){return this.aiGuardrails?.ndk?.fetchingEvents(t,e),new Promise(n=>{const i=new Map,r={...e||{},closeOnEose:!0};s&&(r.relaySet=s);const o=a=>{let c;a instanceof NDKEvent?c=a:c=new NDKEvent(void 0,a);const l=c.deduplicationKey(),u=i.get(l);u&&(c=dedup(u,c)),c.ndk=this,i.set(l,c)};this.subscribe(t,{...r,onEvent:o,onEose:()=>{this.aiGuardrails._nextCallDisabled=null,n(new Set(i.values()))}})})}assertSigner(){if(!this.signer)throw this.emit("signer:required"),new Error("Signer required")}getEntity=getEntity.bind(this);guardrailOff(t){return t?typeof t=="string"?this.aiGuardrails._nextCallDisabled=new Set([t]):this.aiGuardrails._nextCallDisabled=new Set(t):this.aiGuardrails._nextCallDisabled="all",this}set wallet(t){if(!t){this._wallet=void 0,this.walletConfig=void 0;return}this._wallet=t,this.walletConfig??={},this.walletConfig.lnPay=t?.lnPay?.bind(t),this.walletConfig.cashuPay=t?.cashuPay?.bind(t)}get wallet(){return this._wallet}},nip19_exports={};__reExport(nip19_exports,nip19_star);var nip49_exports={};__reExport(nip49_exports,nip49_star);function disconnect(t,e){return e??=createDebug2("ndk:relay:auth-policies:disconnect"),async s=>{e?.(`Relay ${s.url} requested authentication, disconnecting`),t.removeRelay(s.url)}}async function signAndAuth(t,e,s,n,i,r){try{await t.sign(s),i(t)}catch(o){n?.(`Failed to publish auth event to relay ${e.url}`,o),r(t)}}function signIn({ndk:t,signer:e,debug:s}={}){return s??=createDebug2("ndk:auth-policies:signIn"),async(n,i)=>{s?.(`Relay ${n.url} requested authentication, signing in`);const r=new NDKEvent(t);return r.kind=22242,r.tags=[["relay",n.url],["challenge",i]],e??=t?.signer,new Promise(async(o,a)=>{e?await signAndAuth(r,n,e,s,o,a):t?.once("signer:ready",async c=>{await signAndAuth(r,n,c,s,o,a)})})}}var NDKRelayAuthPolicies={disconnect,signIn};async function ndkSignerFromPayload(t,e){let s;try{s=JSON.parse(t)}catch(i){console.error("Failed to parse signer payload string",t,i);return}if(!s||typeof s.type!="string"){console.error("Failed to parse signer payload string",t,new Error("Missing type field"));return}const n=signerRegistry.get(s.type);if(!n)throw new Error(`Unknown signer type: ${s.type}`);try{return await n.fromPayload(t,e)}catch(i){const r=i instanceof Error?i.message:String(i);throw new Error(`Failed to deserialize signer type ${s.type}: ${r}`)}}var NDKNip07Signer=class Pe{_userPromise;encryptionQueue=[];encryptionProcessing=!1;debug;waitTimeout;_pubkey;ndk;_user;constructor(e=1e3,s){this.debug=createDebug2("ndk:nip07"),this.waitTimeout=e,this.ndk=s}get pubkey(){if(!this._pubkey)throw new Error("Not ready");return this._pubkey}async blockUntilReady(){await this.waitForExtension();const e=await window.nostr?.getPublicKey();if(!e)throw new Error("User rejected access");this._pubkey=e;let s;return this.ndk?s=this.ndk.getUser({pubkey:e}):s=new NDKUser({pubkey:e}),this._user=s,s}async user(){return this._userPromise||(this._userPromise=this.blockUntilReady()),this._userPromise}get userSync(){if(!this._user)throw new Error("User not ready");return this._user}async sign(e){await this.waitForExtension();const s=await window.nostr?.signEvent(e);if(!s)throw new Error("Failed to sign event");return s.sig}async relays(e){await this.waitForExtension();const s=await window.nostr?.getRelays?.()||{},n=[];for(const i of Object.keys(s))s[i].read&&s[i].write&&n.push(i);return n.map(i=>new NDKRelay(i,e?.relayAuthDefaultPolicy,e))}async encryptionEnabled(e){const s=[];return(!e||e==="nip04")&&window.nostr?.nip04&&s.push("nip04"),(!e||e==="nip44")&&window.nostr?.nip44&&s.push("nip44"),s}async encrypt(e,s,n="nip04"){if(!await this.encryptionEnabled(n))throw new Error(`${n}encryption is not available from your browser extension`);await this.waitForExtension();const i=e.pubkey;return this.queueEncryption(n,"encrypt",i,s)}async decrypt(e,s,n="nip04"){if(!await this.encryptionEnabled(n))throw new Error(`${n}encryption is not available from your browser extension`);await this.waitForExtension();const i=e.pubkey;return this.queueEncryption(n,"decrypt",i,s)}async queueEncryption(e,s,n,i){return new Promise((r,o)=>{this.encryptionQueue.push({scheme:e,method:s,counterpartyHexpubkey:n,value:i,resolve:r,reject:o}),this.encryptionProcessing||this.processEncryptionQueue()})}async processEncryptionQueue(e,s=0){if(!e&&this.encryptionQueue.length===0){this.encryptionProcessing=!1;return}this.encryptionProcessing=!0;const n=e||this.encryptionQueue.shift();if(!n){this.encryptionProcessing=!1;return}const{scheme:i,method:r,counterpartyHexpubkey:o,value:a,resolve:c,reject:l}=n;this.debug("Processing encryption queue item",{method:r,counterpartyHexpubkey:o,value:a});try{const u=await window.nostr?.[i]?.[r](o,a);if(!u)throw new Error("Failed to encrypt/decrypt");c(u)}catch(u){const h=u instanceof Error?u.message:String(u);if(h.includes("call already executing")&&s<5){this.debug("Retrying encryption queue item",{method:r,counterpartyHexpubkey:o,value:a,retries:s}),setTimeout(()=>{this.processEncryptionQueue(n,s+1)},50*s);return}l(u instanceof Error?u:new Error(h))}this.processEncryptionQueue()}waitForExtension(){return new Promise((e,s)=>{if(window.nostr){e();return}let n;const i=setInterval(()=>{window.nostr&&(clearTimeout(n),clearInterval(i),e())},100);n=setTimeout(()=>{clearInterval(i),s(new Error("NIP-07 extension not available"))},this.waitTimeout)})}toPayload(){return JSON.stringify({type:"nip07",payload:""})}static async fromPayload(e,s){const n=JSON.parse(e);if(n.type!=="nip07")throw new Error(`Invalid payload type: expected 'nip07', got ${n.type}`);return new Pe(void 0,s)}};registerSigner("nip07",NDKNip07Signer);var NDKNostrRpc=class extends lib$1.EventEmitter{ndk;signer;relaySet;debug;encryptionType="nip04";pool;constructor(t,e,s,n){if(super(),this.ndk=t,this.signer=e,n){this.pool=new NDKPool(n,t,{debug:s.extend("rpc-pool"),name:"Nostr RPC"}),this.relaySet=new NDKRelaySet(new Set,t,this.pool);for(const i of n){const r=this.pool.getRelay(i,!1,!1);r.authPolicy=NDKRelayAuthPolicies.signIn({ndk:t,signer:e,debug:s}),this.relaySet.addRelay(r),r.connect()}}this.debug=s.extend("rpc")}subscribe(t){return new Promise(e=>{const s=this.ndk.subscribe(t,{closeOnEose:!1,groupable:!1,cacheUsage:"ONLY_RELAY",pool:this.pool,relaySet:this.relaySet,onEvent:async n=>{try{const i=await this.parseEvent(n);i.method?this.emit("request",i):(this.emit(`response-${i.id}`,i),this.emit("response",i))}catch(i){this.debug("error parsing event",i,n.rawEvent())}},onEose:()=>{this.debug("eosed"),e(s)}})})}async parseEvent(t){this.encryptionType==="nip44"&&t.content.includes("?iv=")?this.encryptionType="nip04":this.encryptionType==="nip04"&&!t.content.includes("?iv=")&&(this.encryptionType="nip44");const e=this.ndk.getUser({pubkey:t.pubkey});e.ndk=this.ndk;let s;try{s=await this.signer.decrypt(e,t.content,this.encryptionType)}catch{const u=this.encryptionType==="nip04"?"nip44":"nip04";s=await this.signer.decrypt(e,t.content,u),this.encryptionType=u}const n=JSON.parse(s),{id:i,method:r,params:o,result:a,error:c}=n;return r?{id:i,pubkey:t.pubkey,method:r,params:o,event:t}:{id:i,result:a,error:c,event:t}}async sendResponse(t,e,s,n=24133,i){const r={id:t,result:s};i&&(r.error=i);const o=await this.signer.user(),a=this.ndk.getUser({pubkey:e}),c=new NDKEvent(this.ndk,{kind:n,content:JSON.stringify(r),tags:[["p",e]],pubkey:o.pubkey});c.content=await this.signer.encrypt(a,c.content,this.encryptionType),await c.sign(this.signer),await c.publish(this.relaySet)}async sendRequest(t,e,s=[],n=24133,i){const r=Math.random().toString(36).substring(7),o=await this.signer.user(),a=this.ndk.getUser({pubkey:t}),c={id:r,method:e,params:s},l=new Promise(()=>{const h=f=>{f.result==="auth_url"?(this.once(`response-${r}`,h),this.emit("authUrl",f.error)):i&&i(f)};this.once(`response-${r}`,h)}),u=new NDKEvent(this.ndk,{kind:n,content:JSON.stringify(c),tags:[["p",t]],pubkey:o.pubkey});return u.content=await this.signer.encrypt(a,u.content,this.encryptionType),await u.sign(this.signer),await u.publish(this.relaySet),l}};function nostrConnectGenerateSecret(){return Math.random().toString(36).substring(2,15)}function generateNostrConnectUri(t,e,s,n){const i={name:n?.name?encodeURIComponent(n.name):"",url:n?.url?encodeURIComponent(n.url):"",image:n?.image?encodeURIComponent(n.image):"",perms:n?.perms?encodeURIComponent(n.perms):""};let r=`nostrconnect://${t}?image=${i.image}&url=${i.url}&name=${i.name}&perms=${i.perms}&secret=${encodeURIComponent(e)}`;return s&&(r+=`&relay=${encodeURIComponent(s)}`),r}var NDKNip46Signer=class Z extends lib$1.EventEmitter{ndk;_user;bunkerPubkey;userPubkey;get pubkey(){if(!this.userPubkey)throw new Error("Not ready");return this.userPubkey}secret;localSigner;nip05;rpc;debug;relayUrls;subscription;nostrConnectUri;nostrConnectSecret;constructor(e,s,n,i,r){super(),this.ndk=e,this.debug=e.debug.extend("nip46:signer"),this.relayUrls=i,n?typeof n=="string"?this.localSigner=new NDKPrivateKeySigner(n):this.localSigner=n:this.localSigner=NDKPrivateKeySigner.generate(),s===!1||(s?s.startsWith("bunker://")?this.bunkerFlowInit(s):this.nip05Init(s):this.nostrconnectFlowInit(r)),this.rpc=new NDKNostrRpc(this.ndk,this.localSigner,this.debug,this.relayUrls)}static bunker(e,s,n){return new Z(e,s,n)}static nostrconnect(e,s,n,i){return new Z(e,void 0,n,[s],i)}nostrconnectFlowInit(e){this.nostrConnectSecret=nostrConnectGenerateSecret();const s=this.localSigner.pubkey;this.nostrConnectUri=generateNostrConnectUri(s,this.nostrConnectSecret,this.relayUrls?.[0],e)}bunkerFlowInit(e){const s=new URL(e),n=s.hostname||s.pathname.replace(/^\/\//,""),i=s.searchParams.get("pubkey"),r=s.searchParams.getAll("relay"),o=s.searchParams.get("secret");this.bunkerPubkey=n,this.userPubkey=i,this.relayUrls=r,this.secret=o}nip05Init(e){this.nip05=e}async startListening(){if(this.subscription)return;const e=await this.localSigner.user();if(!e)throw new Error("Local signer not ready");this.subscription=await this.rpc.subscribe({kinds:[24133],"#p":[e.pubkey]})}async user(){return this._user?this._user:this.blockUntilReady()}get userSync(){if(!this._user)throw new Error("Remote user not ready synchronously");return this._user}async blockUntilReadyNostrConnect(){return new Promise((e,s)=>{const n=i=>{i.result===this.nostrConnectSecret&&(this._user=i.event.author,this.userPubkey=i.event.pubkey,this.bunkerPubkey=i.event.pubkey,this.rpc.off("response",n),e(this._user))};this.startListening(),this.rpc.on("response",n)})}async blockUntilReady(){if(!this.bunkerPubkey&&!this.nostrConnectSecret&&!this.nip05)throw new Error("Bunker pubkey not set");if(this.nostrConnectSecret)return this.blockUntilReadyNostrConnect();if(this.nip05&&!this.userPubkey){const e=await NDKUser.fromNip05(this.nip05,this.ndk);e&&(this._user=e,this.userPubkey=e.pubkey,this.relayUrls=e.nip46Urls,this.rpc=new NDKNostrRpc(this.ndk,this.localSigner,this.debug,this.relayUrls))}if(!this.bunkerPubkey&&this.userPubkey)this.bunkerPubkey=this.userPubkey;else if(!this.bunkerPubkey)throw new Error("Bunker pubkey not set");return await this.startListening(),this.rpc.on("authUrl",(...e)=>{this.emit("authUrl",...e)}),new Promise((e,s)=>{const n=[this.userPubkey??""];if(this.secret&&n.push(this.secret),!this.bunkerPubkey)throw new Error("Bunker pubkey not set");this.rpc.sendRequest(this.bunkerPubkey,"connect",n,24133,i=>{i.result==="ack"?this.getPublicKey().then(r=>{this.userPubkey=r,this._user=this.ndk.getUser({pubkey:r}),e(this._user)}):s(i.error)})})}stop(){this.subscription?.stop(),this.subscription=void 0}async getPublicKey(){return this.userPubkey?this.userPubkey:new Promise((e,s)=>{if(!this.bunkerPubkey)throw new Error("Bunker pubkey not set");this.rpc.sendRequest(this.bunkerPubkey,"get_public_key",[],24133,n=>{e(n.result)})})}async encryptionEnabled(e){return e?[e]:Promise.resolve(["nip04","nip44"])}async encrypt(e,s,n="nip04"){return this.encryption(e,s,n,"encrypt")}async decrypt(e,s,n="nip04"){return this.encryption(e,s,n,"decrypt")}async encryption(e,s,n,i){return new Promise((o,a)=>{if(!this.bunkerPubkey)throw new Error("Bunker pubkey not set");this.rpc.sendRequest(this.bunkerPubkey,`${n}_${i}`,[e.pubkey,s],24133,c=>{c.error?a(c.error):o(c.result)})})}async sign(e){return new Promise((n,i)=>{if(!this.bunkerPubkey)throw new Error("Bunker pubkey not set");this.rpc.sendRequest(this.bunkerPubkey,"sign_event",[JSON.stringify(e)],24133,r=>{if(r.error)i(r.error);else{const o=JSON.parse(r.result);n(o.sig)}})})}async createAccount(e,s,n){await this.startListening();const i=[];return e&&i.push(e),s&&i.push(s),n&&i.push(n),new Promise((r,o)=>{if(!this.bunkerPubkey)throw new Error("Bunker pubkey not set");this.rpc.sendRequest(this.bunkerPubkey,"create_account",i,24133,a=>{if(a.error)o(a.error);else{const c=a.result;r(c)}})})}toPayload(){if(!this.bunkerPubkey||!this.userPubkey)throw new Error("NIP-46 signer is not fully initialized for serialization");const e={type:"nip46",payload:{bunkerPubkey:this.bunkerPubkey,userPubkey:this.userPubkey,relayUrls:this.relayUrls,secret:this.secret,localSignerPayload:this.localSigner.toPayload(),nip05:this.nip05||null}};return JSON.stringify(e)}static async fromPayload(e,s){if(!s)throw new Error("NDK instance is required to deserialize NIP-46 signer");const n=JSON.parse(e);if(n.type!=="nip46")throw new Error(`Invalid payload type: expected 'nip46', got ${n.type}`);const i=n.payload;if(!i||typeof i!="object"||!i.localSignerPayload)throw new Error("Invalid payload content for nip46 signer");const r=await ndkSignerFromPayload(i.localSignerPayload,s);if(!r)throw new Error("Failed to deserialize local signer for NIP-46");if(!(r instanceof NDKPrivateKeySigner))throw new Error("Local signer must be an instance of NDKPrivateKeySigner");let o;return o=new Z(s,!1,r,i.relayUrls),o.userPubkey=i.userPubkey,o.bunkerPubkey=i.bunkerPubkey,o.relayUrls=i.relayUrls,o.secret=i.secret,i.userPubkey&&(o._user=new NDKUser({pubkey:i.userPubkey}),o._user&&(o._user.ndk=s)),o}};registerSigner("nip46",NDKNip46Signer);createDebug2("ndk:zapper:ln");createDebug2("ndk:zapper");const RELAYS=["wss://relay.damus.io","wss://relay.nostr.band","wss://nos.lol","wss://relay.snort.social"];function createNDKStore(){const{subscribe:t,set:e}=writable(null);let s=null;return{subscribe:t,init:async()=>{if(s)return s;try{const i=new NDK({explicitRelayUrls:RELAYS,autoConnectUserRelays:!0,autoFetchUserMutelist:!0});return await i.connect(),s=i,e(i),console.log("NDK connected to relays"),i}catch(i){return console.error("Failed to initialize NDK:",i),null}},get:()=>s}}const ndkStore=createNDKStore();async function fetchChannels(t){const e={kinds:[40],limit:100},s=await t.fetchEvents(e);return Array.from(s).map(n=>({id:n.id,name:n.tags.find(i=>i[0]==="name")?.[1]||"Unnamed Channel",about:n.tags.find(i=>i[0]==="about")?.[1]||"",picture:n.tags.find(i=>i[0]==="picture")?.[1],creator:n.pubkey,created_at:n.created_at||0})).sort((n,i)=>i.created_at-n.created_at)}async function fetchChannelMessages(t,e,s=50){const n={kinds:[42],"#e":[e],limit:s},i=await t.fetchEvents(n);return Array.from(i).map(r=>({id:r.id,content:r.content,pubkey:r.pubkey,created_at:r.created_at||0,channel_id:e})).sort((r,o)=>r.created_at-o.created_at)}async function fetchDirectMessages(t,e,s){const n=[{kinds:[4],authors:[e],limit:100},{kinds:[4],"#p":[e],limit:100}];s&&(n[0]["#p"]=[s],n[1].authors=[s]);const i=await t.fetchEvents(n[0]),r=await t.fetchEvents(n[1]);return[...Array.from(i),...Array.from(r)].map(a=>({id:a.id,content:a.content,pubkey:a.pubkey,recipient:a.tags.find(c=>c[0]==="p")?.[1]||"",created_at:a.created_at||0})).sort((a,c)=>a.created_at-c.created_at)}export{NDK as N,fetchChannelMessages as a,fetchDirectMessages as b,createDebug2 as c,dist as d,nip19_star as e,fetchChannels as f,commonjsGlobal as g,getDefaultExportFromCjs as h,lib$1 as l,ndkStore as n};
//# sourceMappingURL=Dj2A1cQj.js.map
