{"version":3,"file":"6.DG3FtEJe.js","sources":["../../../../../../src/routes/dm/+page.ts","../../../../../../src/routes/dm/+page.svelte"],"sourcesContent":["import type { PageLoad } from './$types';\nimport { browser } from '$app/environment';\nimport { ndkStore, fetchDirectMessages } from '$lib/stores/ndk';\n\n// Allow prerendering\nexport const prerender = true;\n\nexport const load: PageLoad = async () => {\n  if (!browser) {\n    return { conversations: [] };\n  }\n\n  const stored = localStorage.getItem('fairfield_auth');\n  if (!stored) {\n    // Auth check handled in component\n    return { conversations: [] };\n  }\n\n  try {\n    const auth = JSON.parse(stored);\n    const ndk = ndkStore.get();\n\n    if (!ndk || !auth.npub) {\n      return { conversations: [] };\n    }\n\n    const messages = await fetchDirectMessages(ndk, auth.npub);\n\n    // Group by conversation partner\n    const conversationsMap = new Map<string, any>();\n\n    messages.forEach(msg => {\n      const partner = msg.pubkey === auth.npub ? msg.recipient : msg.pubkey;\n\n      if (!conversationsMap.has(partner)) {\n        conversationsMap.set(partner, {\n          pubkey: partner,\n          lastMessage: msg,\n          unread: 0\n        });\n      } else {\n        const conv = conversationsMap.get(partner);\n        if (msg.created_at > conv.lastMessage.created_at) {\n          conv.lastMessage = msg;\n        }\n      }\n    });\n\n    const conversations = Array.from(conversationsMap.values())\n      .sort((a, b) => b.lastMessage.created_at - a.lastMessage.created_at);\n\n    return { conversations };\n  } catch (error) {\n    console.error('Failed to load DMs:', error);\n    return { conversations: [] };\n  }\n};\n","<script lang=\"ts\">\n  import { onMount } from 'svelte';\n  import { goto } from '$app/navigation';\n  import { base } from '$app/paths';\n  import { authStore } from '$lib/stores/auth';\n\n  let conversations: any[] = [];\n  let loading = true;\n\n  onMount(async () => {\n    if (!$authStore.isAuthenticated) {\n      goto(`${base}/`);\n      return;\n    }\n\n    // Load DM conversations (placeholder)\n    conversations = [];\n    loading = false;\n  });\n\n  function formatPubkey(pubkey: string): string {\n    return pubkey.slice(0, 12) + '...' + pubkey.slice(-8);\n  }\n\n  function formatTime(timestamp: number): string {\n    const date = new Date(timestamp * 1000);\n    const now = new Date();\n    const diff = now.getTime() - date.getTime();\n    const hours = diff / (1000 * 60 * 60);\n\n    if (hours < 24) {\n      return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });\n    } else if (hours < 48) {\n      return 'Yesterday';\n    } else {\n      return date.toLocaleDateString();\n    }\n  }\n\n  function openConversation(pubkey: string) {\n    goto(`${base}/dm/${pubkey}`);\n  }\n</script>\n\n<svelte:head>\n  <title>Direct Messages - Fairfield Nostr</title>\n</svelte:head>\n\n<div class=\"container mx-auto p-4 max-w-2xl\">\n  <div class=\"mb-6\">\n    <h1 class=\"text-4xl font-bold gradient-text mb-2\">Direct Messages</h1>\n    <p class=\"text-base-content/70\">Private encrypted conversations</p>\n  </div>\n\n  {#if loading}\n    <div class=\"flex justify-center items-center min-h-[400px]\">\n      <div class=\"loading loading-spinner loading-lg text-primary\"></div>\n    </div>\n  {:else if conversations.length === 0}\n    <div class=\"card bg-base-200\">\n      <div class=\"card-body items-center text-center\">\n        <p class=\"text-base-content/70\">No conversations yet. Start chatting!</p>\n      </div>\n    </div>\n  {:else}\n    <div class=\"space-y-2\">\n      {#each conversations as conv (conv.pubkey)}\n        <button\n          class=\"card bg-base-200 hover:bg-base-300 transition-base cursor-pointer w-full text-left\"\n          on:click={() => openConversation(conv.pubkey)}\n        >\n          <div class=\"card-body p-4\">\n            <div class=\"flex items-center gap-3\">\n              <div class=\"avatar placeholder\">\n                <div class=\"bg-primary text-primary-content rounded-full w-12\">\n                  <span class=\"text-xl\">{conv.pubkey.charAt(0).toUpperCase()}</span>\n                </div>\n              </div>\n              <div class=\"flex-1 min-w-0\">\n                <div class=\"flex justify-between items-start mb-1\">\n                  <h3 class=\"font-semibold\">{formatPubkey(conv.pubkey)}</h3>\n                  <span class=\"text-xs text-base-content/60\">\n                    {formatTime(conv.lastMessage.created_at)}\n                  </span>\n                </div>\n                <p class=\"text-sm text-base-content/70 truncate\">\n                  {conv.lastMessage.content}\n                </p>\n              </div>\n              {#if conv.unread > 0}\n                <div class=\"badge badge-primary badge-sm\">{conv.unread}</div>\n              {/if}\n            </div>\n          </div>\n        </button>\n      {/each}\n    </div>\n  {/if}\n</div>\n"],"names":["prerender","load","stored","auth","ndk","ndkStore","messages","fetchDirectMessages","conversationsMap","msg","partner","conv","a","b","error","ctx","get_key","i","insert_hydration","target","div","anchor","div1","t_value","dirty","set_data","t","t0_value","formatPubkey","t4_value","formatTime","create_if_block_2","button","append_hydration","div5","div4","div0","span0","div3","div2","h3","span1","p","t0","t2","t2_value","t4","t6","t6_value","create_if_block","create_if_block_1","pubkey","timestamp","date","hours","conversations","loading","onMount","$authStore","goto","base","$$invalidate","openConversation"],"mappings":"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"}