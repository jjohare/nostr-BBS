---
# Deployment Checklist - Nostr-BBS Nostr Platform
# Generated: 2025-12-15
# Agent: qe-deployment-readiness

metadata:
  project: Nostr-BBS-nostr
  version: 0.1.0
  environment: production
  platform: google-cloud-platform
  assessment_date: 2025-12-15
  overall_risk: MEDIUM
  risk_score: 42
  confidence: 76.5
  decision: CONDITIONAL_GO

blocking_issues:
  count: 3
  items:
    - id: BLOCK-001
      severity: CRITICAL
      title: TypeScript Build Failure - Missing @types/ws
      location: services/nostr-relay/
      error: "TS7016: Could not find a declaration file for module 'ws'"
      impact: Deployment will fail at build stage
      fix: "npm install --save-dev @types/ws"
      estimated_time: 5m
      status: OPEN

    - id: BLOCK-002
      severity: CRITICAL
      title: Missing Vite Binary in Root Build
      location: package.json (root)
      error: "vite: command not found"
      impact: GitHub Pages deployment will fail
      fix: "npm install && npm run build"
      estimated_time: 10m
      status: OPEN

    - id: BLOCK-003
      severity: RESOLVED
      title: Placeholder URL in Embedding Workflow
      location: .github/workflows/generate-embeddings.yml:68
      error: "Previously: wss://nosflare-relay-PLACEHOLDER.run.app"
      impact: Embedding generation was failing
      fix: "Updated to use wss://nostr-relay-617806532906.us-central1.run.app"
      estimated_time: 2m
      status: RESOLVED

pre_deployment:
  phase: preparation
  required_actions:
    - name: Fix TypeScript Compilation
      command: "cd services/nostr-relay && npm install --save-dev @types/ws && npm run build"
      verify: "dist/server.js should exist"
      blocking: true

    - name: Install Root Dependencies
      command: "npm install"
      verify: "node_modules/vite should exist"
      blocking: true

    - name: Test Root Build
      command: "npm run build"
      verify: "build/ directory should contain static files"
      blocking: true

    - name: Update Workflow Placeholders
      file: .github/workflows/generate-embeddings.yml
      change: "Replace PLACEHOLDER with actual relay URL"
      blocking: true

    - name: Verify GitHub Secrets
      secrets:
        - GCP_PROJECT_ID
        - GCP_SA_KEY
        - GCP_REGION
      location: "GitHub Settings → Secrets and variables → Actions → Secrets"
      blocking: true
      manual: true

    - name: Verify GitHub Variables
      variables:
        - RELAY_URL
        - EMBEDDING_API_URL
        - ADMIN_PUBKEY
      location: "GitHub Settings → Secrets and variables → Actions → Variables"
      blocking: true
      manual: true

    - name: Update Environment Files
      files:
        - .env.example
      change: "Replace hardcoded project IDs with placeholders"
      blocking: false

deployment:
  phase: execution
  order: sequential
  services:
    - name: Embedding API
      type: cloud-run
      priority: 1
      steps:
        - name: Build Docker Image
          command: "docker build -t $REGION-docker.pkg.dev/$PROJECT/Nostr-BBS/embedding-api:latest ."
          working_dir: services/embedding-api

        - name: Push to Artifact Registry
          command: "docker push $REGION-docker.pkg.dev/$PROJECT/Nostr-BBS/embedding-api:latest"

        - name: Deploy to Cloud Run
          command: "gcloud run deploy embedding-api --image ..."
          verify_url: "https://embedding-api-*.run.app/health"
          expected_status: 200

        - name: Test Embedding Generation
          command: 'curl -X POST $URL/embed -H "Content-Type: application/json" -d ''{"text":"test"}'''
          verify_output: "embedding vector returned"

    - name: Nostr Relay
      type: cloud-run
      priority: 2
      steps:
        - name: Build Docker Image
          command: "docker build -t $REGION-docker.pkg.dev/$PROJECT/Nostr-BBS/nostr-relay:latest ."
          working_dir: services/nostr-relay

        - name: Push to Artifact Registry
          command: "docker push $REGION-docker.pkg.dev/$PROJECT/Nostr-BBS/nostr-relay:latest"

        - name: Deploy to Cloud Run
          command: "gcloud run deploy nostr-relay --image ..."
          verify_url: "wss://nostr-relay-*.run.app"
          expected: "WebSocket connection accepted"

        - name: Verify SQLite Mount
          command: "gcloud run services describe nostr-relay --format=json | jq '.spec.template.spec.volumes'"
          verify_output: "volume mounted at /data"

    - name: Frontend (GitHub Pages)
      type: static-site
      priority: 3
      steps:
        - name: Trigger GitHub Actions
          method: "Push to main branch or manual workflow dispatch"
          workflow: .github/workflows/deploy-pages.yml

        - name: Monitor Build
          url: "https://github.com/jjohare/Nostr-BBS/actions"
          expected_status: "Success"

        - name: Verify Deployment
          url: "https://jjohare.github.io/Nostr-BBS"
          expected_status: 200

    - name: Embedding Generation
      type: github-actions
      priority: 4
      steps:
        - name: Trigger Initial Run
          method: "Manual workflow dispatch"
          workflow: .github/workflows/generate-embeddings.yml

        - name: Verify GCS Bucket
          command: "gsutil ls gs://Nostr-BBS-vectors/"
          expected_output: "manifest.json, index.bin, embeddings.npz"

        - name: Test Search
          method: "Use frontend search feature"
          verify: "Results returned from embedding API"

post_deployment:
  phase: validation
  health_checks:
    - name: Embedding API Health
      url: "https://embedding-api-*.run.app/health"
      method: GET
      expected_status: 200
      timeout: 5s

    - name: Nostr Relay Connection
      protocol: websocket
      url: "wss://nostr-relay-*.run.app"
      expected: "Connection established"
      timeout: 10s

    - name: Frontend Accessibility
      url: "https://jjohare.github.io/Nostr-BBS"
      method: GET
      expected_status: 200
      timeout: 5s

  functional_tests:
    - name: Create Test Event
      description: "Create a test Nostr event via frontend"
      steps:
        - Login with test credentials
        - Create new channel message
        - Verify message appears in UI
      expected: "Message stored in relay and visible"

    - name: Semantic Search
      description: "Test embedding-based search"
      steps:
        - Navigate to search
        - Enter query: "test message"
        - Wait for results
      expected: "Results returned with similarity scores"

    - name: Direct Message
      description: "Test encrypted DM functionality"
      steps:
        - Open DM interface
        - Send encrypted message
        - Verify delivery
      expected: "Message encrypted, sent, and decrypted"

  performance_tests:
    - name: Relay Response Time
      metric: p95_latency
      target: <100ms
      method: "Send 100 events, measure response time"

    - name: Embedding API Latency
      metric: p95_latency
      target: <500ms
      method: "Generate 50 embeddings, measure time"

    - name: Search Query Performance
      metric: query_time
      target: <2s
      method: "Run 20 search queries, measure total time"

  security_validation:
    - name: CORS Headers
      test: "curl -H 'Origin: https://evil.com' $EMBEDDING_API_URL/health"
      expected: "CORS blocked for unauthorized origin"

    - name: Whitelist Enforcement
      test: "Send event with non-whitelisted pubkey"
      expected: "Event rejected by relay"

    - name: HTTPS/WSS Only
      test: "Attempt HTTP connection"
      expected: "Redirect to HTTPS or connection refused"

  monitoring_setup:
    - name: Cloud Run Metrics
      actions:
        - Enable request count metrics
        - Enable latency metrics
        - Enable error rate metrics
      dashboards:
        - Cloud Run service dashboard
        - Custom metrics dashboard

    - name: Log Alerts
      alerts:
        - name: High Error Rate
          condition: "error_rate > 5%"
          window: 5m
          action: "Send email notification"

        - name: Service Unavailable
          condition: "availability < 95%"
          window: 5m
          action: "Page on-call engineer"

        - name: Cold Start Spike
          condition: "cold_starts > 10/min"
          window: 5m
          action: "Send Slack notification"

rollback:
  trigger_conditions:
    - critical_bugs: "Core functionality broken"
    - security_vulnerabilities: "Data exposure or auth bypass"
    - database_corruption: "SQLite file corrupted"
    - error_rate_high: ">5% for >5 minutes"
    - service_unavailable: ">5 minutes downtime"

  procedure:
    steps:
      - name: Identify Problematic Service
        method: "Check logs, metrics, user reports"

      - name: Revert Cloud Run Deployment
        commands:
          - "gcloud run services update SERVICE --image=PREVIOUS_TAG --region=REGION"
        services:
          - embedding-api
          - nostr-relay

      - name: Revert Frontend Deployment
        method: "Revert commit and push to main"
        command: "git revert HEAD && git push origin main"

      - name: Restore Database
        condition: "If database corruption detected"
        command: "gsutil cp gs://PROJECT-nostr-data/backup-YYYYMMDD.db gs://PROJECT-nostr-data/nostr.db"

      - name: Notify Users
        channels:
          - GitHub Issues
          - Status page
          - Admin email
        message: "Service temporarily degraded, investigating"

      - name: Post-Mortem
        actions:
          - Document incident
          - Identify root cause
          - Implement fix
          - Test before redeploy

  estimated_time:
    cloud_run_services: 2-5m
    frontend_pages: 5-10m
    database_restore: 10-15m
    full_stack_rollback: 15m

recommendations:
  immediate:
    - id: REC-001
      priority: CRITICAL
      title: "Fix TypeScript Build"
      description: "Install @types/ws and verify compilation"
      effort: LOW
      impact: HIGH

    - id: REC-002
      priority: CRITICAL
      title: "Install Root Dependencies"
      description: "Ensure vite and all dependencies installed"
      effort: LOW
      impact: HIGH

    - id: REC-003
      priority: CRITICAL
      title: "Update Workflow Placeholders"
      description: "Replace PLACEHOLDER URLs with actual values"
      effort: LOW
      impact: HIGH

  short_term:
    - id: REC-004
      priority: HIGH
      title: "Remove/Update Nosflare Workflow"
      description: "Directory doesn't exist, delete workflow or create service"
      effort: LOW
      impact: MEDIUM

    - id: REC-005
      priority: HIGH
      title: "Add Integration Tests"
      description: "Test end-to-end relay → embedding flow"
      effort: MEDIUM
      impact: HIGH

    - id: REC-006
      priority: MEDIUM
      title: "Implement Rate Limiting"
      description: "Protect embedding API from abuse"
      effort: MEDIUM
      impact: MEDIUM

  long_term:
    - id: REC-007
      priority: MEDIUM
      title: "Enable Cloud Monitoring"
      description: "Set up alerting policies and dashboards"
      effort: MEDIUM
      impact: HIGH

    - id: REC-008
      priority: LOW
      title: "Optimize Costs"
      description: "Consider min-instances: 0 for relay"
      effort: LOW
      impact: MEDIUM

    - id: REC-009
      priority: MEDIUM
      title: "Enhance Security"
      description: "Implement API key auth, Cloud Armor, VPC"
      effort: HIGH
      impact: HIGH

sign_off:
  development_lead:
    name: ""
    date: ""
    signature: ""
    approval: false

  security_review:
    name: ""
    date: ""
    signature: ""
    approval: false

  operations:
    name: ""
    date: ""
    signature: ""
    approval: false

metadata_final:
  generated_by: qe-deployment-readiness
  agent_version: 2.4.0
  report_id: DEPLOY-20251215-001
  total_checks: 47
  passed_checks: 32
  failed_checks: 3
  warning_checks: 12
  blocked: true
  estimated_time_to_fix: 17m
  estimated_deployment_time: 45m
  estimated_validation_time: 30m
  total_estimated_time: 92m
